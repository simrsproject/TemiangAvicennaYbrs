
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Display Antrean Registrasi</title>

    <!-- Fonts -->
    <link href="@(ViewBag.UrlRoot)/Bootstrap/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="@(ViewBag.UrlRoot)/Bootstrap/Queue/Display/assets/css/appDisplay.css" rel="stylesheet">

    <script src="@(ViewBag.UrlRoot)/Bootstrap/plugins/jquery/jquery.min.js"></script>
    <script src="@(ViewBag.UrlRoot)/Bootstrap/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Styles -->

</head>
<body>
    <header>
        <div class="header-section-content row d-flex align-items-center py-3">
            <div class="col-8 header-left d-flex flex-row align-items-center px-2">
                <div class="logo-header-section-card px-2">
                    <img src="data:image/png;base64, @(Convert.ToBase64String((byte[])ViewData["Healthcare_HealthcareLogo"]))" alt="Logo RS" style="width: 3.5vw;" />
                </div>
                <div class="title-header-section-card align-items-center">
                    <div class="title-1" style="font: bold 1.2vw arial, verdana; text-shadow: 1px 1px #738678;">@ViewData["Healthcare_HealthcareName"]</div>
                    <div class="title-2" style="font: 550 0.8vw arial, verdana; text-shadow: 0.5px 1px #738678;">@ViewData["AppParam_QueueDisplaySloganHealthcare"]</div>
                </div>
            </div>
            <div class="col-4 header-right text-right pr-3">
                <div class="times" style="font: bolder 1.2vw arial, verdana;"><span id="hours"></span>:<span id="minutes">:</span>:<span id="seconds"></span>&nbsp;<span id="ampm"></span></div>
                <div class="hari" id="date" style="font: bold 0.8vw arial, verdana;"></div>
                <div class="vendor-name">Powered by @ViewBag.Brand.VendorName</div>
            </div>
        </div>
        <div class="header-section-title">
            ANTREAN PENDAFTARAN
        </div>
    </header>

    <main>
        <div class="container-fluid">
            <div class="main-top-box-section my-3">
                <div class="row main-top-box-content-section text-center">
                    <div class="col-6">
                        NOMOR ANTRIAN
                    </div>
                    <div class="col-1">
                    </div>
                    <div class="col-5">
                        LOKET
                    </div>
                </div>

                <div class="row main-top-box-number-section text-center">
                    <div class="col-6 main-top-box-content-number-section"><span id="mainLoket">A000</span></div>
                    <div class="col-1 main-top-box-content-number-section"><img src="~/Bootstrap/Queue/Display/assets/images/arrows.png" alt="arrow"></div>
                    <div class="col-5 main-top-box-content-number-section"><span id="mainLoketNumber">00</span></div>
                </div>
            </div>

            <div id="counter" class="row">
            </div>
        </div>
    </main>


    <footer>
        <div class="row">
            <div class="col-12 footer-section mt-3">
                <div class="footer-content-section text-dark">
                    <span>@ViewData["AppParam_QueueDisplayScrollingText"]</span>
                </div>
            </div>
        </div>
    </footer>


    <div class="audio">
        @{
            foreach (var af in (QueueingSoundCollection)ViewBag.audioColl)
            {
                <audio id="a_@(af.Name.Replace(" " ,"_"))" src="@(ViewBag.audioPathURL)/@(af.FilePath)"></audio>
            }
        }
    </div>

    <script src="@(ViewBag.UrlRoot)/Bootstrap/Queue/Display/assets/js/clock.js"></script>
    <script type="text/javascript">
        var BaseURL = '@ViewBag.UrlRoot';
        var Location = '@(ViewBag.qLocation)' != '' ? '@(ViewBag.qLocation)' : '01';

        $(document).ready(function () {
            $('.footer-content-section span').css('animation-duration', '@ViewData["AppParam_QueueDisplayScrollingDurationText"]');
            $('#mainLoket').html('@ViewData["lastFormatedNo"]');
            $('#mainLoketNumber').html('@ViewData["lastCounter"]');

            GenerateCounter();

            GetQueueing();

            setInterval(function () {
                GetQueueing();
            }, 4000);

            setInterval(function () {
                SayIt();
            }, 800);
        });

        function GenerateCounter() {
            let counter = '@(ViewBag.qCounter)' != '' ? '@(ViewBag.qCounter)' : 4;

            let latestQueuePerCounter = @(Html.Raw(Json.Encode(ViewBag.LatestQueuePerCounter)));

            let i = 0;
            while (i < counter) {
                let formattedNo = "A-000"
                let num = i + 1;

                let queueData = latestQueuePerCounter.find(q => q.CounterCode == num.toString());
                if (queueData) {
                    formattedNo = queueData.FormattedNo;
                }

                let str = $(`
                    <div class="col bottom-box-section-card">
                        <div class="bottom-box-content-section-card">
                            <div class="bottom-box-content-header-section-card">
                                LOKET ${num}
                            </div>
                            <div class="bottom-box-body-header-section-card">
                                <span id="C${num}">${formattedNo}</span>
                            </div>
                        </div>
                    </div>
                `);
                $('#counter').append(str);
                i++;
            }
        }

        var queData = [];
        var _fnGetDataIsRunning = false;
        function GetQueueing() {
            if (_fnGetDataIsRunning == true) return;

            _fnGetDataIsRunning = true;

            $.ajax({
                type: 'POST',
                url: "@(ViewBag.UrlRoot)/Queueing/GetQueueing",
                data: { qLocation: Location },
                success: function (data) {
                    //console.log(data);
                    if (data.status === 'OK') {
                        //console.log(data.data);
                        if (data.data != null) {

                            for (var i = 0; i < data.data.length; i++) {
                                queData.push(data.data[i]);
                                //console.log(data.data[i]);
                            }
                        }
                    } else {
                        //DisplayToast(ret.data, "error");
                    }

                    _fnGetDataIsRunning = false;
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    _fnGetDataIsRunning = false;
                    //DisplayToast(xhr.responseText, "error");
                },
                dataType: 'json'
            });
        }

        function SayIt() {
            if (SetMediaIsRunning) return;

            if (queData.length > 0) {
                var que = queData.shift();
                //console.log(que);
                UpdateDisplay(que);
                SetMedia(que, 0);
            }
        }

        function UpdateDisplay(que) {
            // main
            $('#mainLoket').html(que.FormattedNo);
            //$('#mainLoket').hide().text(que.FormattedNo).fadeIn('slow');
            BlinkSpan($('#mainLoket'), 0);
            $('#mainLoketNumber').html(que.CounterCode);
            BlinkSpan($('#mainLoketNumber'), 0);
            //$('#mainLoketNumber').hide().text(que.CounterCode).fadeIn('slow');
            //console.log('#C' + que.CounterCode);
            if ($('#C' + que.CounterCode).length) {
                $('#C' + que.CounterCode).html(que.FormattedNo);
                BlinkSpan($('#C' + que.CounterCode), 0);
                //$('#C' + que.CounterCode).hide().text(que.FormattedNo).fadeIn('slow');
            }
        }

        function BlinkSpan(objSpan, i) {
            //console.log(i);
            if (i < 10) {
                if ((i % 2) == 0) {
                    // change css
                    objSpan.addClass("text-warning");
                } else {
                    // remove css
                    objSpan.removeClass("text-warning");
                }

                setTimeout(function () {
                    i++;
                    BlinkSpan(objSpan, i);
                }, 1000);
            }
        }

        var SetMediaIsRunning = false;
        function SetMedia(que, iDelay) {
            //console.log(que.AudioInfo.length);

            SetMediaIsRunning = true;
            if (que.AudioInfo.length == 0) {
                SetMediaIsRunning = false;
                return;
            }

            setTimeout(function () {
                var jDelay = 0;
                var af = que.AudioInfo.shift();
                var m = document.getElementById('a_' + af.Name.replace(" ","_"));
                //console.log('a_' + af.Name);
                //console.log(m);
                if (m != null) {
                    m.pause();
                    m.currentTime = 0;
                    jDelay = m.duration * 1000;
                    m.play();
                }
                //return;
                SetMedia(que, jDelay);
            }, iDelay);
        }

    </script>
</body>
</html>
