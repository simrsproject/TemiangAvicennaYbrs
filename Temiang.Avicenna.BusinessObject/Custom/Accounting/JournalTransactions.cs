using System;
using System.ComponentModel;
using System.Collections.Generic;
using System.Text;
using System.Data;
using System.Linq;

using Temiang.Dal.Core;
using Temiang.Dal.Interfaces;
using Temiang.Dal.DynamicQuery;
using Newtonsoft.Json;
using Temiang.Avicenna.BusinessObject.Common;
using Temiang.Avicenna.BusinessObject.Reference;

namespace Temiang.Avicenna.BusinessObject
{
    public class JournalType
    {
        public static readonly string General;
        public static readonly string Income;
        public static readonly string Prescription;
        public static readonly string SpectaclePrescription;
        public static readonly string PrescriptionReturn;
        public static readonly string DownPayment;
        public static readonly string DownPaymentReturn;
        public static readonly string Payment;
        public static readonly string PaymentReturn;
        public static readonly string ARPayment;
        public static readonly string AR;
        public static readonly string ARCreating;
        public static readonly string CashTransaction;
        public static readonly string PurchaseOrderReceived;
        public static readonly string PurchaseOrderReturned;
        public static readonly string ConsignmentReceived;
        public static readonly string ConsignmentReturned;
        public static readonly string ConsignmentInvoicing;
        public static readonly string Distribution;
        public static readonly string DistributionConfirmed;
        public static readonly string InventoryIssue;
        public static readonly string AP;
        public static readonly string APPayment;
        public static readonly string PhysicianPayment;
        public static readonly string PhysicianFeeVerification;
        public static readonly string FixAsset;
        public static readonly string SalesToBranch;
        public static readonly string GuarantorDeposit;
        public static readonly string InventoryStockAdjustment;
        public static readonly string InventoryStockOpname;
        public static readonly string InventoryProduction;
        public static readonly string PatientReceivable;
        public static readonly string IncomeFromRegistrationTransfer;
        public static readonly string CashierCorrection;
        public static readonly string GrantReceive;
        public static readonly string Payroll;
        public static readonly string THR;
        public static readonly string ARCustomerPayment;
        public static readonly string ARCustomer;
        public static readonly string Sales;
        public static readonly string SalesReturn;
        public static readonly string AssetAuction;
        public static readonly string AssetDestruction;
        public static readonly string AssetMovement;
        public static readonly string ClosingvisitDownPayment;
        public static readonly string PhysicianFeePayable;

        /// <summary>
        /// constructor
        /// </summary>
        static JournalType()
        {
            JournalType.General = "01";
            JournalType.Income = "02";
            JournalType.Prescription = "03";
            JournalType.PrescriptionReturn = "04";
            JournalType.SpectaclePrescription = "05";
            JournalType.PaymentReturn = "07";
            JournalType.DownPaymentReturn = "08";
            JournalType.DownPayment = "09";
            JournalType.Payment = "10";
            JournalType.ARPayment = "11"; // pembayaran ar invoice
            JournalType.AR = "14"; // ar invoicing
            JournalType.ARCreating = "13"; // ar create di kasir
            JournalType.CashTransaction = "12";
            JournalType.PurchaseOrderReceived = "15";
            JournalType.PurchaseOrderReturned = "16";
            JournalType.ConsignmentReceived = "17";
            JournalType.ConsignmentReturned = "18";
            JournalType.ConsignmentInvoicing = "19";
            JournalType.Distribution = "20";
            JournalType.DistributionConfirmed = "21";
            JournalType.InventoryIssue = "22";
            JournalType.AP = "25";
            JournalType.APPayment = "26";
            JournalType.PhysicianPayment = "27";
            JournalType.PhysicianFeeVerification = "28";
            JournalType.FixAsset = "30";
            JournalType.SalesToBranch = "23";
            JournalType.GuarantorDeposit = "31";
            JournalType.InventoryStockAdjustment = "32";
            JournalType.InventoryStockOpname = "33";
            JournalType.InventoryProduction = "34";
            JournalType.PatientReceivable = "35";
            JournalType.IncomeFromRegistrationTransfer = "36";
            JournalType.CashierCorrection = "37";
            JournalType.GrantReceive = "24";
            JournalType.Payroll = "38";
            JournalType.THR = "39";
            JournalType.Sales = "40";
            JournalType.SalesReturn = "41";
            JournalType.ARCustomer = "42";
            JournalType.ARCustomerPayment = "43";
            JournalType.AssetAuction = "44";
            JournalType.AssetDestruction = "45";
            JournalType.AssetMovement = "46";
            JournalType.ClosingvisitDownPayment = "47";
            JournalType.PhysicianFeePayable = "48";
        }

        /// <summary>
        /// public constructor
        /// </summary>
        public JournalType()
        {
        }
    }

    public partial class JournalTransactions : esJournalTransactions
    {
        public class PackageJournal
        {
            public string TransactionNo { get; set; }
            public string SequenceNo { get; set; }
            public string ItemID { get; set; }
            public decimal PackageAmount { get; set; }
            public decimal PackageDetailAmount { get; set; }
        }


        /// <summary>
        /// Total Debit
        /// </summary>
        public decimal TotalDebit
        {
            get
            {
                decimal retVal = 0;
                retVal = this.GetColumn("TotalDebit") is System.DBNull ? 0 : (decimal)this.GetColumn("TotalDebit");
                return retVal;
            }
        }
        /// <summary>
        /// Total credit
        /// </summary>
        public decimal TotalCredit
        {
            get
            {
                decimal retVal = 0;
                retVal = this.GetColumn("TotalCredit") is System.DBNull ? 0 : (decimal)this.GetColumn("TotalCredit");
                return retVal;
            }
        }
        /// <summary>
        /// Total number of journal transaction for this number
        /// </summary>
        public int TotalTransaction
        {
            get
            {
                int retVal = 0;
                retVal = this.GetColumn("TotalTransaction") is System.DBNull ? 0 : (int)this.GetColumn("TotalTransaction");
                return retVal;
            }
        }
        /// <summary>
        /// Formatted transaction number for display only
        /// </summary>
        public string FormattedTransactionNumber
        {
            get
            {
                return string.Format("{0}-{1}", this.JournalCode, this.TransactionNumber);
            }
        }
        /// <summary>
        /// Additional properties
        /// </summary>
        /// <returns></returns>
        protected override List<esPropertyDescriptor> GetLocalBindingProperties()
        {
            List<esPropertyDescriptor> items = new List<esPropertyDescriptor>();

            items.Add(new esPropertyDescriptor(this, "TotalDebit", typeof(decimal)));
            items.Add(new esPropertyDescriptor(this, "TotalCredit", typeof(decimal)));
            items.Add(new esPropertyDescriptor(this, "TotalTransaction", typeof(int)));

            return items;
        }

        public static int TotalCount(string journalType, string journalCode, string transactionNumber, DateTime? transactionDate, DateTime? transactionDateTo,
            int status, string description, string registrationNo, string referenceNo, string rangeFilter, bool isShowVoid)
        {
            int retVal = 0;
            //JournalTransactions entity = new JournalTransactions();
            List<esComparison> prms = new List<esComparison>();
            //edit
            var jt1 = new JournalTransactionsQuery("jt1");

            // additional params
            var toDay = DateTime.Now.Date;
            var firstDayOfMonth = new DateTime(toDay.Year, toDay.Month, 1);
            var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
            var oneLastMonthDay = toDay.AddMonths(-1);
            var firstDayOfYear = new DateTime(toDay.Year, 1, 1);
            var lastDayOfYear = new DateTime(toDay.Year, 12, 31);
            var oneLastYearDay = toDay.AddYears(-1);
            // this month
            if (rangeFilter == "1")
            {
                prms.Add(jt1.TransactionDate.GreaterThanOrEqual(firstDayOfMonth));
                prms.Add(jt1.TransactionDate.LessThan(lastDayOfMonth.AddDays(1)));
            }
            // one last month
            if (rangeFilter == "2")
            {
                prms.Add(jt1.TransactionDate.GreaterThanOrEqual(oneLastMonthDay));
                prms.Add(jt1.TransactionDate.LessThan(toDay.AddDays(1)));
            }
            // this year
            if (rangeFilter == "3")
            {
                prms.Add(jt1.TransactionDate.GreaterThanOrEqual(firstDayOfYear));
                prms.Add(jt1.TransactionDate.LessThan(lastDayOfYear.AddDays(1)));
            }
            // one last year
            if (rangeFilter == "4")
            {
                prms.Add(jt1.TransactionDate.GreaterThanOrEqual(oneLastYearDay));
                prms.Add(jt1.TransactionDate.LessThan(toDay.AddDays(1)));
            }

            if (!string.IsNullOrEmpty(journalType))
            {
                string searchTextContain = string.Format("{0}%", journalType);
                prms.Add(jt1.JournalType.Like(searchTextContain));
                //prms.Add(entity.Query.JournalType.Like(journalType + "%"));
            }
            if (!string.IsNullOrEmpty(journalCode))
            {
                string searchTextContain = string.Format("{0}%", journalCode);
                prms.Add(jt1.JournalCode.Like(searchTextContain));
                //prms.Add(entity.Query.JournalCode.Like(journalCode + "%"));
            }
            if (!string.IsNullOrEmpty(transactionNumber))
            {
                string searchTextContain = string.Format("{0}%", transactionNumber);
                prms.Add(jt1.TransactionNumber.Like(searchTextContain));
                //prms.Add(entity.Query.TransactionNumber.Like(transactionNumber + "%"));
            }
            if (transactionDate.HasValue && transactionDateTo.HasValue)
            {
                prms.Add(jt1.TransactionDate.GreaterThanOrEqual(transactionDate.Value));
                prms.Add(jt1.TransactionDate.LessThan(transactionDateTo.Value.AddDays(1)));
            }
            if (!string.IsNullOrEmpty(description))
            {
                string searchTextContain = string.Format("%{0}%", description);
                prms.Add(jt1.Description.Like(searchTextContain));
                //prms.Add(entity.Query.Description.Like("%" + description + "%"));
            }
            //edit
            if (!string.IsNullOrEmpty(registrationNo))
            {
                //var jtd1 = new JournalTransactionDetailsQuery("jtd1");
                //jt1.InnerJoin(jtd1).On(jt1.JournalId == jtd1.JournalId);

                //jtd1.Select(jt1.JournalId, jtd1.RegistrationNo);
                //jtd1.GroupBy(jt1.JournalId, jtd1.RegistrationNo);

                //string searchTextContain = string.Format("%{0}%", registrationNo);
                //prms.Add(jtd1.RegistrationNo.Like(searchTextContain));
                ////prms.Add(h.Description.Like("%" + description + "%"));
                ///

                var jdColl = new JournalTransactionDetailsCollection();
                var jq = jdColl.Query;
                if (registrationNo.Length == 18) // full noreg, pakai =
                {
                    jq.Where(jq.RegistrationNo == registrationNo);
                }
                else
                {
                    if (registrationNo.ToUpper().Contains("REG/"))
                    {
                        jq.Where(jq.RegistrationNo.Like(registrationNo + "%"));
                    }
                    else
                    {
                        jq.Where(jq.RegistrationNo.Like("%" + registrationNo + "%"));
                    }
                }
                jq.Select(jq.JournalId);
                jq.es.Distinct = true;
                jdColl.Load(jq);
                if (jdColl.Count > 0)
                {
                    jt1.Where(jt1.JournalId.In(jdColl.Select(jd => jd.JournalId)));
                }
            }

            if (!string.IsNullOrEmpty(referenceNo))
            {
                string searchTextContain = string.Format("{0}%", referenceNo);
                prms.Add(jt1.RefferenceNumber.Like(referenceNo + "%"));
                //prms.Add(entity.Query.RefferenceNumber.Like(referenceNo + "%"));
            }

            bool showVoid = false;
            switch (status)
            {
                case 0:
                    prms.Add(jt1.IsPosted == false);
                    break;
                case 1:
                    prms.Add(jt1.IsPosted == true);
                    break;
                case 2:
                    showVoid = true;
                    break;
            }
            if (showVoid)
                prms.Add(jt1.IsVoid == true);
            else if (!isShowVoid)
                prms.Add(jt1.IsVoid == false);

            //jt1.es.CountAll = true;
            //jt1.es.CountAllAlias = "Count";
            jt1.Select("<COUNT(DISTINCT jt1.JournalId) AS Count>");
            jt1.es2.Connection.CommandTimeout = 600;
            //entity.Query.es.WithNoLock = true;
            if (prms.Count > 0)
                jt1.Where(prms.ToArray());

            //if (entity.Load(jtd1))
            //    retVal = (int)entity.GetColumn("Count");
            //var jtColl = new JournalTransactionsCollection();
            //if (jtColl.Load(jt1)) {
            //    return jtColl.Count;
            //}
            var dtb = jt1.LoadDataTable();
            retVal = (int)dtb.Rows[0][0];
            return retVal;
        }

        private static esOrderByItem[] safeOrderByItems(string sortString, JournalTransactionsQuery q)
        {
            List<esOrderByItem> list = new List<esOrderByItem>();
            string[] fieldsName = sortString.ToLowerInvariant().Split(char.Parse(","));
            foreach (string field in fieldsName)
            {
                string[] tmp = field.Split(char.Parse("^"));
                bool isDesc = false;
                if (tmp.Length > 1)
                    isDesc = tmp[1].Equals("descending");

                if (tmp[0].Equals("journalid"))
                    list.Add(isDesc ? q.JournalId.Descending : q.JournalId.Ascending);
                if (tmp[0].Equals("journaltype"))
                    list.Add(isDesc ? q.JournalType.Descending : q.JournalType.Ascending);
                if (tmp[0].Equals("journalcode"))
                    list.Add(isDesc ? q.JournalCode.Descending : q.JournalCode.Ascending);
                if (tmp[0].Equals("transactionnumber"))
                    list.Add(isDesc ? q.TransactionNumber.Descending : q.TransactionNumber.Ascending);
                if (tmp[0].Equals("transactiondate"))
                    list.Add(isDesc ? q.TransactionDate.Descending : q.TransactionDate.Ascending);

            }
            if (list.Count == 0) list.Add(q.JournalId.Ascending);
            return list.ToArray();
        }

        public static JournalTransactionsCollection GetAllWithPaging(int pageNumber, int pageSize, string journalType, string journalCode, string transactionNumber,
            DateTime? transactionDate, DateTime? transactionDateTo, int status, string description, string registrationNo, string sortString, string referenceNo,
            string rangeFilter, bool isShowVoid)
        {
            JournalTransactionsQuery h = new JournalTransactionsQuery("h");

            h.Select(
                h.JournalId, h.JournalCode, h.JournalType, h.TransactionNumber, h.TransactionDate, h.Description, h.IsPosted,
                h.DateCreated, h.LastUpdateDateTime, h.CreatedBy, h.LastUpdateByUserID, h.IsVoid, h.VoidDate, h.RefferenceNumber,
                h.JournalIdRefference, h.BudgetingCode,
                "<CAST(0 AS DECIMAL) TotalDebit>", "<CAST(0 AS DECIMAL) TotalCredit>", "<0 TotalTransaction>");
            // where
            List<esComparison> prms = new List<esComparison>();

            // additional params
            var toDay = DateTime.Now.Date;
            var firstDayOfMonth = new DateTime(toDay.Year, toDay.Month, 1);
            var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
            var oneLastMonthDay = toDay.AddMonths(-1);
            var firstDayOfYear = new DateTime(toDay.Year, 1, 1);
            var lastDayOfYear = new DateTime(toDay.Year, 12, 31);
            var oneLastYearDay = toDay.AddYears(-1);
            // this month
            if (rangeFilter == "1")
            {
                prms.Add(h.TransactionDate.GreaterThanOrEqual(firstDayOfMonth));
                prms.Add(h.TransactionDate.LessThan(lastDayOfMonth.AddDays(1)));
            }
            // one last month
            if (rangeFilter == "2")
            {
                prms.Add(h.TransactionDate.GreaterThanOrEqual(oneLastMonthDay));
                prms.Add(h.TransactionDate.LessThan(toDay.AddDays(1)));
            }
            // this year
            if (rangeFilter == "3")
            {
                prms.Add(h.TransactionDate.GreaterThanOrEqual(firstDayOfYear));
                prms.Add(h.TransactionDate.LessThan(lastDayOfYear.AddDays(1)));
            }
            // one last year
            if (rangeFilter == "4")
            {
                prms.Add(h.TransactionDate.GreaterThanOrEqual(oneLastYearDay));
                prms.Add(h.TransactionDate.LessThan(toDay.AddDays(1)));
            }

            if (!string.IsNullOrEmpty(journalType))
            {
                string searchTextContain = string.Format("{0}%", journalType);
                prms.Add(h.JournalType.Like(searchTextContain));
                //prms.Add(h.JournalType.Like(journalType + "%"));
            }
            if (!string.IsNullOrEmpty(journalCode))
            {
                string searchTextContain = string.Format("{0}%", journalCode);
                prms.Add(h.JournalCode.Like(searchTextContain));
                //prms.Add(h.JournalCode.Like(journalCode + "%"));
            }
            if (!string.IsNullOrEmpty(transactionNumber))
            {
                string searchTextContain = string.Format("{0}%", transactionNumber);
                prms.Add(h.TransactionNumber.Like(searchTextContain));
                //prms.Add(h.TransactionNumber.Like(transactionNumber + "%"));
            }
            if (transactionDate.HasValue && transactionDateTo.HasValue)
            {
                prms.Add(h.TransactionDate.GreaterThanOrEqual(transactionDate.Value));
                prms.Add(h.TransactionDate.LessThan(transactionDateTo.Value.AddDays(1)));
            }
            if (!string.IsNullOrEmpty(description))
            {
                string searchTextContain = string.Format("%{0}%", description);
                prms.Add(h.Description.Like(searchTextContain));
                //prms.Add(h.Description.Like("%" + description + "%"));
            }
            //edit
            if (!string.IsNullOrEmpty(registrationNo))
            {
                //JournalTransactionDetailsQuery jd = new JournalTransactionDetailsQuery("jd");
                //h.InnerJoin(jd).On(h.JournalId == jd.JournalId);

                //string searchTextContain = string.Format("%{0}%", registrationNo);
                //prms.Add(jd.RegistrationNo.Like(searchTextContain));
                ////prms.Add(h.Description.Like("%" + description + "%"));

                //h.Select(jd.RegistrationNo);

                //h.GroupBy(h.JournalId, h.JournalCode, h.JournalType, h.TransactionNumber, h.TransactionDate, h.Description, jd.RegistrationNo, h.IsPosted,
                //h.DateCreated, h.LastUpdateDateTime, h.CreatedBy, h.LastUpdateByUserID, h.IsVoid, h.VoidDate, h.RefferenceNumber,
                //h.JournalIdRefference, h.BudgetingCode);

                var jdColl = new JournalTransactionDetailsCollection();
                var jq = jdColl.Query;
                if (registrationNo.Length == 18) // full noreg, pakai =
                {
                    jq.Where(jq.RegistrationNo == registrationNo);
                }
                else {
                    if (registrationNo.ToUpper().Contains("REG/")) {
                        jq.Where(jq.RegistrationNo.Like(registrationNo + "%"));
                    }
                    else {
                        jq.Where(jq.RegistrationNo.Like("%" + registrationNo + "%"));
                    }
                }
                jq.Select(jq.JournalId);
                jq.es.Distinct = true;
                jdColl.Load(jq);
                if (jdColl.Count > 0) {
                    h.Where(h.JournalId.In(jdColl.Select(jd => jd.JournalId)));
                }
            }
            else
            {
                h.Select("<'' as RegistrationNo>");
                h.GroupBy(h.JournalId, h.JournalCode, h.JournalType, h.TransactionNumber, h.TransactionDate, h.Description, h.IsPosted,
                    h.DateCreated, h.LastUpdateDateTime, h.CreatedBy, h.LastUpdateByUserID, h.IsVoid, h.VoidDate, h.RefferenceNumber,
                    h.JournalIdRefference, h.BudgetingCode);

            }

            if (!string.IsNullOrEmpty(referenceNo))
            {
                string searchTextContain = string.Format("{0}%", referenceNo);
                prms.Add(h.RefferenceNumber.Like(searchTextContain));
                //prms.Add(h.RefferenceNumber.Like(referenceNo + "%"));
            }

            bool showVoid = false;

            switch (status)
            {
                case 0:
                    prms.Add(h.IsPosted == false);
                    break;
                case 1:
                    prms.Add(h.IsPosted == true);
                    break;
                case 2:
                    showVoid = true;
                    break;
            }
            if (showVoid)
                prms.Add(h.IsVoid == true);
            else if (!isShowVoid)
                prms.Add(h.IsVoid == false);

            if (prms.Count > 0)
                h.Where(prms.ToArray());
            // order by
            //h.OrderBy(h.JournalId.Descending);

            //edit

            h.OrderBy(safeOrderByItems(sortString, h));

            //h.es.WithNoLock = true;
            h.es.PageSize = pageSize;
            h.es.PageNumber = pageNumber + 1;
            h.es2.Connection.CommandTimeout = 600;

            JournalTransactionsCollection coll = new JournalTransactionsCollection();
            coll.Load(h);

            if (coll.Count > 0)
            {
                var jtdColl = new JournalTransactionDetailsCollection();
                jtdColl.Query.Where(jtdColl.Query.JournalId.In(coll.Select(x => x.JournalId)));
                jtdColl.Query.Select(
                    jtdColl.Query.JournalId,
                    jtdColl.Query.Debit.Sum(),
                    jtdColl.Query.Credit.Sum(),
                    jtdColl.Query.DetailId.Count()
                    );
                jtdColl.Query.GroupBy(jtdColl.Query.JournalId);
                jtdColl.LoadAll();

                foreach (var j in coll)
                {
                    var jtd = jtdColl.Where(x => x.JournalId == j.JournalId);
                    if (jtd.Any())
                    {
                        j.SetColumn("TotalDebit", jtd.Sum(x => x.Debit));
                        j.SetColumn("TotalCredit", jtd.Sum(x => x.Credit));
                        j.SetColumn("TotalTransaction", jtd.Sum(x => x.DetailId));
                    }
                }
            }

            return coll;
        }

        //public static JournalTransactionsCollection GetAllWithPaging(int pageNumber, int pageSize, string journalType, string journalCode, string transactionNumber,
        //    DateTime? transactionDate, DateTime? transactionDateTo, int status, string description, string registrationNo, string sortString, string referenceNo,
        //    string rangeFilter, bool isShowVoid)
        //{
        //    JournalTransactionsQuery h = new JournalTransactionsQuery("h");
        //    JournalTransactionDetailsQuery d = new JournalTransactionDetailsQuery("d");

        //    h.Select(
        //        h.JournalId, h.JournalCode, h.JournalType, h.TransactionNumber, h.TransactionDate, h.Description, d.RegistrationNo, h.IsPosted,
        //                h.DateCreated, h.LastUpdateDateTime, h.CreatedBy, h.LastUpdateByUserID, h.IsVoid, h.VoidDate, h.RefferenceNumber,
        //                h.JournalIdRefference, h.BudgetingCode,
        //        d.Debit.Sum().As("TotalDebit"), d.Credit.Sum().As("TotalCredit"), d.JournalId.Count().As("TotalTransaction"));
        //    h.LeftJoin(d).On(h.JournalId == d.JournalId);
        //    // where
        //    List<esComparison> prms = new List<esComparison>();

        //    // additional params
        //    if (!string.IsNullOrEmpty(journalType))
        //        prms.Add(h.JournalType.Like(journalType + "%"));
        //    if (!string.IsNullOrEmpty(journalCode))
        //        prms.Add(h.JournalCode.Like(journalCode + "%"));
        //    if (!string.IsNullOrEmpty(transactionNumber))
        //        prms.Add(h.TransactionNumber.Like(transactionNumber + "%"));
        //    if (transactionDate.HasValue && transactionDateTo.HasValue)
        //    {
        //        prms.Add(h.TransactionDate.Date().Between(transactionDate.Value, transactionDateTo.Value));
        //    }
        //    if (!string.IsNullOrEmpty(description))
        //        prms.Add(h.Description.Like("%" + description + "%"));
        //    if (!string.IsNullOrEmpty(registrationNo))
        //        prms.Add(d.RegistrationNo.Like("%" + registrationNo + "%"));
        //    if (!string.IsNullOrEmpty(referenceNo))
        //        prms.Add(h.RefferenceNumber.Like(referenceNo + "%"));

        //    bool showVoid = false;

        //    switch (status)
        //    {
        //        case 0:
        //            prms.Add(h.IsPosted == false);
        //            break;
        //        case 1:
        //            prms.Add(h.IsPosted == true);
        //            break;
        //        case 2:
        //            showVoid = true;
        //            break;
        //    }
        //    if (showVoid)
        //        prms.Add(h.IsVoid == true);
        //    else
        //        prms.Add(h.IsVoid == false);

        //    if (prms.Count > 0)
        //        h.Where(prms.ToArray());
        //    // group by
        //    h.GroupBy(h.JournalId, h.JournalCode, h.JournalType, h.TransactionNumber, h.TransactionDate, h.Description, d.RegistrationNo, h.IsPosted,
        //        h.DateCreated, h.LastUpdateDateTime, h.CreatedBy, h.LastUpdateByUserID, h.IsVoid, h.VoidDate, h.RefferenceNumber,
        //        h.JournalIdRefference, h.BudgetingCode);
        //    // order by
        //    //h.OrderBy(h.JournalId.Descending);
        //    h.OrderBy(safeOrderByItems(sortString, h));

        //    //h.es.WithNoLock = true;
        //    h.es.PageSize = pageSize;
        //    h.es.PageNumber = pageNumber + 1;
        //    h.es2.Connection.CommandTimeout = 600;

        //    JournalTransactionsCollection coll = new JournalTransactionsCollection();
        //    coll.Load(h);
        //    return coll;
        //}

        public static JournalTransactions Get(int journalId)
        {
            JournalTransactions entity = new JournalTransactions();
            entity.Query.Where(entity.Query.JournalId == journalId);
            if (entity.Query.Load())
                return entity;
            else
                return null;
        }

        public static bool AddNew(JournalTransactions entity)
        {
            bool retVal = false;
            using (esTransactionScope scope = new esTransactionScope())
            {
                try
                {
                    if (entity.TransactionNumber == "{auto}")
                    {
                        // generate a new transaction number
                        entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    }

                    entity.AddNew();
                    entity.Save();

                    // save changes to database
                    scope.Complete();

                    retVal = true;
                }
                catch (Exception ex)
                {
                    retVal = false;
                }
            }
            return retVal;
        }

        public static bool Delete(int accountId, int journalId)
        {
            bool retVal = false;
            JournalTransactions entity = Get(journalId);
            if (entity != null)
            {
                if (!entity.IsPosted.Value)
                {
                    int totalItems = JournalTransactionDetails.TotalCount(journalId);
                    if (totalItems == 0)
                    {
                        using (esTransactionScope scope = new esTransactionScope())
                        {
                            try
                            {
                                entity.MarkAsDeleted();
                                entity.Save();

                                scope.Complete();
                                retVal = true;
                            }
                            catch
                            {
                                // log exception
                            }
                        }

                    }
                }
            }
            return retVal;
        }

        public static bool MarkStatusAsPosting(int journalId, string editBy, out string transactionNumber)
        {
            bool retVal = false;
            JournalTransactions entity = Get(journalId);
            transactionNumber = string.Empty;
            if (entity != null)
            {
                transactionNumber = entity.FormattedTransactionNumber;
                if (!entity.IsPosted.Value)
                {
                    JournalTransactionDetailsCollection en = JournalTransactionDetails.GetAllForTransactions(journalId);
                    if (en.Count > 0)
                    {
                        decimal totalDebit = 0;
                        decimal totalCredit = 0;
                        foreach (JournalTransactionDetails e in en)
                        {
                            totalDebit += e.Debit.Value;
                            totalCredit += e.Credit.Value;
                        }
                        //if ((totalDebit > 0 && totalCredit > 0) && (totalDebit == totalCredit))
                        if (Math.Round(totalDebit, 2, MidpointRounding.AwayFromZero) == Math.Round(totalCredit, 2, MidpointRounding.AwayFromZero))
                        {
                            entity.IsPosted = true;
                            entity.LastUpdateByUserID = editBy;
                            entity.LastUpdateDateTime = DateTime.Now;
                            entity.Save();

                            retVal = true;
                        }
                    }
                }
            }
            return retVal;
        }

        public static bool RemovePostingStatus(int journalId, string editBy, out string transactionNumber)
        {
            bool retVal = false;
            JournalTransactions entity = Get(journalId);
            transactionNumber = string.Empty;
            if (entity != null)
            {
                transactionNumber = entity.FormattedTransactionNumber;
                if (entity.IsPosted.Value)
                {
                    entity.IsPosted = false;
                    entity.LastUpdateByUserID = editBy;
                    entity.LastUpdateDateTime = DateTime.Now;
                    entity.Save();

                    retVal = true;
                }
            }
            return retVal;
        }

        public static int CountUnPosted(int day, int month, int year, int journalGroupID)
        {
            esParameters prms = new esParameters();

            prms.Add("Day", day, esParameterDirection.Input, DbType.Int32, 0);
            prms.Add("Month", month, esParameterDirection.Input, DbType.Int32, 0);
            prms.Add("Year", year, esParameterDirection.Input, DbType.Int32, 0);
            prms.Add("GroupID", journalGroupID, esParameterDirection.Input, DbType.Int32, 0);

            esUtility util = new esUtility();
            return (int)util.ExecuteScalar(esQueryType.StoredProcedure, "sp_JournalTransactionsCountUnPosted", prms);
        }

        public static int ProcessClosing(int day, string month, string year, bool isFiscalYear, bool isFinal, string editedBy, int journalGroupID)
        {
            esParameters prms = new esParameters();

            prms.Add("Day", day, esParameterDirection.Input, DbType.Int32, 0);
            prms.Add("Month", month, esParameterDirection.Input, DbType.String, 2);
            prms.Add("Year", year, esParameterDirection.Input, DbType.String, 4);
            prms.Add("IsFiscalYear", isFiscalYear, esParameterDirection.Input, DbType.Boolean, 0);
            prms.Add("IsEnabled", isFinal, esParameterDirection.Input, DbType.Boolean, 0);
            prms.Add("EditedBy", editedBy, esParameterDirection.Input, DbType.String, 15);
            prms.Add("GroupID", journalGroupID, esParameterDirection.Input, DbType.String, 0);
            prms.Add("Return_Value", esParameterDirection.ReturnValue);

            JournalTransactions entity = new JournalTransactions();
            entity.es.Connection.CommandTimeout = 60 * 5; //5 mins 
            entity.ExecuteNonQuery(esQueryType.StoredProcedure, "sp_JournalTransactionsProcessClosing", prms);
            return (int)prms["Return_Value"].Value;
        }

        public static bool IsExistJournalByRef(string referenceNo)
        {
            var jt = new JournalTransactionsCollection();
            jt.Query.Where(jt.Query.RefferenceNumber == referenceNo,
                jt.Query.IsVoid == false);
            jt.LoadAll();
            return jt.Count > 0;
        }

        #region Automatic Journal

        private static bool IsAutoJournalEnabled()
        {
            /*<appSettings>
                <add key="EnableAutoJournal" value="true" />
              </appSettings> */
            return string.Compare(System.Configuration.ConfigurationSettings.AppSettings["EnableAutoJournal"], "true", true) == 0;
        }


        public static int? AddNewInpatentTransferJournalTemporary(Registration opReg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(opReg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.IncomeFromRegistrationTransfer;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, opReg.RegistrationDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = opReg.RegistrationDate;
                    entity.Description = string.Format("TRANSFER IPR REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", opReg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = opReg.RegistrationNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = unit.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                ////DEBIT:
                //if (true)
                //{
                //    decimal totalIncome = 0;
                //    decimal totalDisc = 0;

                //    foreach (var c in cost)
                //    {
                //        if (string.IsNullOrEmpty(c.ParentNo))
                //        {
                //            totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                //            //    totalDisc += (c.DiscountAmount.Value);
                //        }
                //    }

                //    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                //    JournalTransactionDetails d = new JournalTransactionDetails();
                //    d.AddNew();
                //    d.JournalId = entity.JournalId;
                //    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                //    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                //    d.Debit = totalIncome;
                //    d.Credit = 0;
                //    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", opReg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                //    d.DocumentNumber = opReg.RegistrationNo;
                //    d.Save();

                //    totalDebit += d.Debit.Value;
                //}

                var mcuUnitID = new AppParameter();
                mcuUnitID.LoadByPrimaryKey("ServiceUnitMcuId");

                //CREDIT
                foreach (var c in cost)
                {
                    var isTransaction = false;
                    var isCorrection = false;

                    var trn = new TransCharges();
                    isTransaction = trn.LoadByPrimaryKey(c.TransactionNo);

                    DataTable dtb;

                    var ccs = new CostCalculationCollection();
                    ccs.Query.Where(ccs.Query.TransactionNo == c.TransactionNo);
                    ccs.Query.Load();

                    var su = new ServiceUnit();

                    var jrq = new BusinessObject.JournalTransactionsQuery();
                    jrq.Where(jrq.RefferenceNumber == c.TransactionNo);

                    var jid = 0;
                    var jr = new BusinessObject.JournalTransactions();
                    if (jr.Load(jrq)) jid = jr.JournalId ?? 0;

                    if (isTransaction)
                    {
                        su.LoadByPrimaryKey(trn.ToServiceUnitID);

                        var tcic = new TransChargesItemCompCollection();
                        tcic.Query.Where(tcic.Query.TransactionNo == c.TransactionNo);
                        tcic.Query.Load();

                        isCorrection = trn.IsCorrection ?? false;
                        if (isCorrection)
                        {
                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsJournalCashBased) == "No")
                            {
                                JournalTransactions.AddNewIncomeCorrectionJournalTemporaryTransfer(trn, tcic, opReg, su, ccs, "SC", editedBy, jid, entity.JournalId.Value.ToString());
                            }

                        }
                        else
                        {
                            if (trn.IsOrder ?? false)
                            {
                                /* Automatic Journal Testing Start */
                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsJournalCashBased) == "No")
                                {
                                    JournalTransactions.AddNewIncomeJournalTemporaryTransfer(trn, tcic,
                                                                                                 opReg, su, ccs,
                                                                                                 "JO",
                                                                                                 editedBy, jid, entity.JournalId.Value.ToString());
                                }

                                /* Automatic Journal Testing End */
                            }
                            else //if (trn.PackageReferenceNo)
                            {
                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsJournalCashBased) == "No")
                                {
                                    JournalTransactions.AddNewIncomeJournalTemporaryTransfer(trn, tcic,
                                                                                                 opReg, su, ccs,
                                                                                                 "SU",
                                                                                                 editedBy, jid, entity.JournalId.Value.ToString());
                                }
                            }
                        }
                    }
                    else
                    {
                        var prc = new TransPrescription();
                        isTransaction = prc.LoadByPrimaryKey(c.TransactionNo);
                        if (isTransaction)
                        {
                            su.LoadByPrimaryKey(prc.ServiceUnitID);

                            isCorrection = prc.IsPrescriptionReturn ?? false;
                            if (isCorrection)
                            {
                                /* Automatic Journal Testing Start */
                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsUsingIntermBill) != "Yes")
                                {
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsPemisahanCOAUangRacikan) == "1")
                                    {
                                        JournalTransactions.AddNewPrescriptionReturnJournalWithSeparationPersonalizedRecipeMoneyTransfer(prc, opReg,
                                            su,
                                            ccs.ToArray(), "RS", editedBy, jid, entity.JournalId.Value.ToString());
                                    }
                                    else
                                    {
                                        JournalTransactions.AddNewPrescriptionReturnJournalTransfer(prc, opReg,
                                            su,
                                            ccs.ToArray(), "RS", editedBy, jid, entity.JournalId.Value.ToString());
                                    }
                                }
                                else
                                {
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsJournalCashBased) == "No")
                                    {
                                        JournalTransactions.AddNewPrescriptionReturnJournalTemporaryNettoTransfer(prc, opReg, su,
                                            ccs.ToArray(), "RS", editedBy, jid, entity.JournalId.Value.ToString());
                                    }
                                }
                                /* Automatic Journal Testing End */
                            }
                            else
                            {
                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsJournalCashBased) == "No")
                                {
                                    JournalTransactions.AddNewPrescriptionJournalTemporaryNettoTransfer(prc, opReg, su, ccs, "RS", editedBy, jid, entity.JournalId.Value.ToString());
                                }
                            }
                        }
                    }
                }

                //populate
                var dtls = new JournalTransactionDetailsCollection();
                dtls.Query.Where(dtls.Query.DocumentNumber.In(cost.Select(c => c.TransactionNo)), dtls.Query.DocumentNumberSequenceNo == entity.JournalId);
                if (dtls.Query.Load())
                {
                    foreach (var dtl in dtls)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = dtl.ChartOfAccountId;
                        d.SubLedgerId = dtl.SubLedgerId;
                        d.Debit = dtl.Debit;
                        d.Credit = dtl.Credit;
                        d.Description = dtl.Description;
                        d.DocumentNumber = dtl.DocumentNumber;
                        d.Save();

                        totalDebit += d.Debit ?? 0;
                        totalCredit += d.Credit ?? 0;
                    }

                    //delete detail reference
                    dtls.MarkAllAsDeleted();
                    dtls.Save();
                }

                //delete header reference
                var hds = new JournalTransactionsCollection();
                hds.Query.Where(hds.Query.RefferenceNumber.In(cost.Select(c => c.TransactionNo)));
                if (hds.Query.Load())
                {
                    hds.MarkAllAsDeleted();
                    hds.Save();
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }


        private static decimal Abs(decimal? v)
        {
            if (!v.HasValue)
                return 0;
            return Math.Abs(v.Value);
        }

        public static int? AddNewIncomeJournal2(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //entah kenapa sering buat error saat debugging sehingga dikomen dulu
                //if (entity.LoadByPrimaryKey(journalId))
                //{
                //    var journalDetails = new JournalTransactionDetailsCollection();
                //    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                //    journalDetails.LoadAll();
                //    journalDetails.MarkAllAsDeleted();
                //    journalDetails.Save();

                //    entity.LastUpdateDateTime = DateTime.Now;
                //    entity.LastUpdateByUserID = editedBy;
                //}
                //else
                //{
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.Income;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.TransactionDate;
                entity.Description = string.Format("TRANS REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.TransactionNo;
                //}
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = reg.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                            //    totalDisc += (c.DiscountAmount.Value);
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.TransactionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //CREDIT
                foreach (var c in cost)
                {
                    // Service Unit Item first
                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                    itemService.Query.Where(itemService.Query.ServiceUnitID == unit.ServiceUnitID, itemService.Query.ItemID == c.ItemID);
                    if (itemService.Query.Load())
                    {
                        TransChargesItem ci = new TransChargesItem();
                        ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo,
                                       ci.Query.SequenceNo == c.SequenceNo,
                                       ci.Query.ItemID == c.ItemID,
                                       ci.Query.IsPackage == false); /* kalau package maka yg dijurnal detailnya */
                        if (ci.Query.Load())
                        {
                            foreach (var q in tcic)
                            {
                                decimal discTemp = 0;
                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                    discTemp = q.DiscountAmount.Value;

                                if (q.TransactionNo == c.TransactionNo && q.SequenceNo == c.SequenceNo)
                                {
                                    int? coaId = 0;
                                    int? subLedgerId = 0;
                                    int? coaDiscId = 0;
                                    int? subLedgerDiscId = 0;

                                    ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                    itemComp.Query.Where(itemComp.Query.ServiceUnitID == unit.ServiceUnitID,
                                                         itemComp.Query.ItemID == c.ItemID,
                                                         itemComp.Query.TariffComponentID == q.TariffComponentID,
                                                         itemComp.Query.SRRegistrationType == regType,
                                                         itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);

                                    if (itemComp.Query.Load())
                                    {
                                        if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemComp.ChartOfAccountIdIncome.Value;
                                            subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                        }

                                        if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                        {
                                            coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                            subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                        }
                                    }

                                    if (isInpatient && AppParameter.GetParameterValue(AppParameter.ParameterItem.CoaUsingClass) == "1")
                                    {
                                        ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                        itemClass.Query.Where(itemClass.Query.ServiceUnitID == unit.ServiceUnitID, itemClass.Query.ItemID == c.ItemID,
                                            itemClass.Query.ClassID == tc.ClassID, itemClass.Query.TariffComponentID == q.TariffComponentID);
                                        if (itemClass.Query.Load())
                                        {
                                            if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                            }

                                            if (itemClass.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount.Value > 0)
                                            {
                                                if (itemClass.ChartOfAccountIdDiscount.HasValue && itemClass.ChartOfAccountIdDiscount > 0)
                                                {
                                                    coaDiscId = itemClass.ChartOfAccountIdDiscount.Value;
                                                    subLedgerDiscId = itemClass.SubledgerIdDiscount.HasValue ? itemClass.SubledgerIdDiscount : 0;
                                                }
                                            }
                                        }
                                    }

                                    //// if we cant find it use the ones in Service Unit
                                    //if (!coaId.HasValue || coaId == 0)
                                    //{
                                    //    coaId = unit.ChartOfAccountIdIncome;
                                    //    subLedgerId = unit.SubledgerIdIncome.HasValue ? unit.SubledgerIdIncome : 0;
                                    //}

                                    // we need Item Name in ledger report
                                    Item item = new Item();
                                    item.Query.Where(item.Query.ItemID == c.ItemID);
                                    item.Query.Load();

                                    //Logger.LogMessage(string.Format("Creating Income Journal for ServiceUnitItemService:{0}. (C)", c.ItemID));

                                    JournalTransactionDetails d = new JournalTransactionDetails();
                                    d.AddNew();
                                    d.JournalId = entity.JournalId;
                                    d.ChartOfAccountId = coaId;
                                    d.SubLedgerId = subLedgerId;
                                    d.Debit = 0;
                                    // d.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                    d.Credit = ((q.Price - discTemp) * ci.ChargeQuantity) + (q.CitoAmount ?? 0 * ci.ChargeQuantity);
                                    d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                    d.DocumentNumber = tc.TransactionNo;
                                    d.Save();

                                    totalCredit += d.Credit.Value;

                                    if (q.DiscountAmount.Value > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                    {
                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                        disc.AddNew();
                                        disc.JournalId = entity.JournalId;
                                        disc.ChartOfAccountId = coaDiscId;
                                        disc.SubLedgerId = subLedgerDiscId;
                                        disc.Debit = q.DiscountAmount.Value * ci.ChargeQuantity;
                                        disc.Credit = 0;
                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                        disc.DocumentNumber = tc.TransactionNo;
                                        disc.Save();

                                        totalDebit += disc.Debit.Value;
                                    }
                                }
                            }

                            //COST FOR CONSUMPTION
                            TransChargesItemConsumptionQuery consp = new TransChargesItemConsumptionQuery();
                            consp.SelectAll();
                            consp.Where(consp.TransactionNo == c.TransactionNo,
                                        consp.SequenceNo == c.SequenceNo);

                            DataTable tblconsp = consp.LoadDataTable();

                            if (tblconsp.Rows.Count > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                            {
                                foreach (DataRow r in tblconsp.Rows)
                                {
                                    // ItemProductMedic
                                    Item itemInv = new Item();
                                    itemInv.Query.Where(itemInv.Query.ItemID == r["DetailItemID"]);
                                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                    {
                                        var proacc = new ProductAccountGuarantorGroup();
                                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                        if (proacc.Load(proacc.Query))
                                        {
                                            var TypeReg = reg.SRRegistrationType;
                                            int coaIdCOGS = 0;
                                            int subledgerIdCOGS = 0;
                                            int coaIdInventory = 0;
                                            int subledgerIdInventory = 0;

                                            switch (TypeReg)
                                            {   // pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                                case "OPR":
                                                    coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                    subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                    coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                    subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                    break;

                                                case "MCU":
                                                    coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                    subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                    coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                    subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                    break;

                                                case "IPR":
                                                    coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                                    subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                                    coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                                    subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                                    break;

                                                case "EMR":
                                                    coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                                    subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                                    coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                                    subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                                    break;

                                            }

                                            if (itemInv.SRItemType == "11")
                                            {
                                                ItemProductMedic itemMedic = new ItemProductMedic();
                                                itemMedic.Query.Where(itemMedic.Query.ItemID == r["DetailItemID"]);
                                                if (itemMedic.Query.Load())
                                                {
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                    mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    // COGS FOR CONSUMPTION
                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = cogs;
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                        itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemMedicCogs.Save();

                                                        totalDebit += itemMedicCogs.Debit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = cogs;
                                                        itemMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                        itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemMedicInv.Save();

                                                        totalCredit += itemMedicInv.Credit.Value;
                                                    }

                                                }
                                            }
                                            else
                                            {
                                                ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                                itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == r["DetailItemID"]);
                                                if (itemNonMedic.Query.Load())
                                                {
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                    mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    // COGS FOR CONSUMPTION
                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                        itemNonMedicCogs.AddNew();
                                                        itemNonMedicCogs.JournalId = entity.JournalId;
                                                        itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemNonMedicCogs.Debit = cogs;
                                                        itemNonMedicCogs.Credit = 0;
                                                        itemNonMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                        itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemNonMedicCogs.Save();

                                                        totalDebit += itemNonMedicCogs.Debit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                        itemNonMedicInv.AddNew();
                                                        itemNonMedicInv.JournalId = entity.JournalId;
                                                        itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemNonMedicInv.Debit = 0;
                                                        itemNonMedicInv.Credit = cogs;
                                                        itemNonMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                        itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemNonMedicInv.Save();

                                                        totalCredit += itemNonMedicInv.Credit.Value;
                                                    }

                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    else
                    {
                        // ItemProductMedic
                        Item itemInv = new Item();
                        itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                        if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                        {
                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                            if (proacc.Load(proacc.Query))
                            {
                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {// pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "MCU":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                if (itemInv.SRItemType == "11")
                                {
                                    ItemProductMedic itemMedic = new ItemProductMedic();
                                    itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                    if (itemMedic.Query.Load())
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        itemMedicIncome.Debit = 0;
                                        itemMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        TransChargesItem ci = new TransChargesItem();
                                        ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                            mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    decimal? cogs = (decimal)row["Quantity"] *
                                                                    (decimal)row["CostPrice"];

                                                    //decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = cogs;
                                                    itemMedicCogs.Credit = 0;
                                                    itemMedicCogs.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}",
                                                                      tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                      c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                    itemMedicCogs.Save();

                                                    totalDebit += itemMedicCogs.Debit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv =
                                                        new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = 0;
                                                    itemMedicInv.Credit = cogs;
                                                    itemMedicInv.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}",
                                                                      tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                      c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                    itemMedicInv.Save();

                                                    totalCredit += itemMedicInv.Credit.Value;
                                                }
                                            }

                                            if (ci.DiscountAmount > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = ci.DiscountAmount.Value;
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.TransactionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                    itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == c.ItemID);
                                    if (itemNonMedic.Query.Load())
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                        itemNonMedicIncome.AddNew();
                                        itemNonMedicIncome.JournalId = entity.JournalId;
                                        itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                        itemNonMedicIncome.Debit = 0;
                                        itemNonMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                        itemNonMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                        itemNonMedicIncome.Save();

                                        totalCredit += itemNonMedicIncome.Credit.Value;

                                        TransChargesItem ci = new TransChargesItem();
                                        ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                        if (ci.Query.Load())
                                        {

                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                    itemNonMedicCogs.AddNew();
                                                    itemNonMedicCogs.JournalId = entity.JournalId;
                                                    itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemNonMedicCogs.Debit = cogs;
                                                    itemNonMedicCogs.Credit = 0;
                                                    itemNonMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                    itemNonMedicCogs.Save();

                                                    totalDebit += itemNonMedicCogs.Debit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                    itemNonMedicInv.AddNew();
                                                    itemNonMedicInv.JournalId = entity.JournalId;
                                                    itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemNonMedicInv.Debit = 0;
                                                    itemNonMedicInv.Credit = cogs;
                                                    itemNonMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                    itemNonMedicInv.Save();

                                                    totalCredit += itemNonMedicInv.Credit.Value;
                                                }
                                            }

                                            if (ci.DiscountAmount > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = ci.DiscountAmount.Value;
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.TransactionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewIncomeJournal(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Income;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.TransactionDate;
                    entity.Description = string.Format("TRANS REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.TransactionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = unit.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                            //    totalDisc += (c.DiscountAmount.Value);
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.TransactionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                var mcuUnitID = new AppParameter();
                mcuUnitID.LoadByPrimaryKey("ServiceUnitMcuId");

                //CREDIT
                foreach (var c in cost)
                {
                    DataTable dtb;

                    if (c.IsPackage == false)
                    {
                        var tci = new TransChargesItemQuery();
                        tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                        dtb = tci.LoadDataTable();
                    }
                    else
                    {
                        if (unit.ServiceUnitID == mcuUnitID.ParameterValue)
                        {
                            var tci = new TransChargesItemQuery();
                            tci.Where(tci.IsPackage == false, tci.TransactionNo == c.TransactionNo,
                                      tci.ParentNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                        else
                        {
                            var tci = new TransChargesItemQuery();
                            tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                    }

                    var guar = new Guarantor();
                    guar.LoadByPrimaryKey(reg.GuarantorID);

                    if (dtb.Rows.Count > 0)
                    {
                        foreach (DataRow baris in dtb.Rows)
                        {

                            // Service Unit Item first
                            ServiceUnitItemService itemService = new ServiceUnitItemService();
                            itemService.Query.Where(itemService.Query.ServiceUnitID == unit.ServiceUnitID, itemService.Query.ItemID == c.ItemID);
                            if (itemService.Query.Load())
                            {

                                //TransChargesItem ci = new TransChargesItem();
                                //ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo,
                                //               ci.Query.SequenceNo == c.SequenceNo,
                                //               ci.Query.ItemID == c.ItemID,
                                //               ci.IsPackage == false); /* kalau package maka yg dijurnal detailnya */
                                //if (ci.Query.Load())
                                //{


                                foreach (var q in tcic)
                                {
                                    decimal discTemp = 0;
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                        discTemp = q.DiscountAmount.Value;

                                    if (q.TransactionNo.Equals(baris["TransactionNo"]) && q.SequenceNo.Equals(baris["SequenceNo"]))
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;
                                        int? coaDiscId = 0;
                                        int? subLedgerDiscId = 0;

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == unit.ServiceUnitID,
                                                             itemComp.Query.ItemID == c.ItemID,
                                                             itemComp.Query.TariffComponentID == q.TariffComponentID); // <-- di GPI where nya harus berikut ini (Hermawan)
                                        //if (AppParameter.GetParameterValue(AppParameter.ParameterItem.HealthcareInitialAppsVersion) == "GPI")
                                        itemComp.Query.Where(itemComp.Query.SRRegistrationType == regType,
                                                     itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup); // <-- di GPI where nya harus berikut ini (Hermawan)

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                            }

                                            if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                            {
                                                coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                                subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                            }
                                        }

                                        if (isInpatient && AppParameter.GetParameterValue(AppParameter.ParameterItem.CoaUsingClass) == "1")
                                        {
                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == unit.ServiceUnitID, itemClass.Query.ItemID == c.ItemID,
                                                itemClass.Query.ClassID == tc.ClassID, itemClass.Query.TariffComponentID == q.TariffComponentID);
                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                                }

                                                if (itemClass.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount.Value > 0)
                                                {
                                                    if (itemClass.ChartOfAccountIdDiscount.HasValue && itemClass.ChartOfAccountIdDiscount > 0)
                                                    {
                                                        coaDiscId = itemClass.ChartOfAccountIdDiscount.Value;
                                                        subLedgerDiscId = itemClass.SubledgerIdDiscount.HasValue ? itemClass.SubledgerIdDiscount : 0;
                                                    }
                                                }
                                            }
                                        }

                                        //// if we cant find it use the ones in Service Unit
                                        //if (!coaId.HasValue || coaId == 0)
                                        //{
                                        //    coaId = unit.ChartOfAccountIdIncome;
                                        //    subLedgerId = unit.SubledgerIdIncome.HasValue ? unit.SubledgerIdIncome : 0;
                                        //}

                                        // we need Item Name in ledger report
                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == c.ItemID);
                                        item.Query.Load();

                                        //Logger.LogMessage(string.Format("Creating Income Journal for ServiceUnitItemService:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails d = new JournalTransactionDetails();
                                        d.AddNew();
                                        d.JournalId = entity.JournalId;
                                        d.ChartOfAccountId = coaId;
                                        d.SubLedgerId = subLedgerId;
                                        d.Debit = 0;
                                        // d.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                        d.Credit = ((q.Price - discTemp) * (decimal)baris["ChargeQuantity"]) + ((q.CitoAmount ?? 0) * (decimal)baris["ChargeQuantity"]);
                                        d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                        d.DocumentNumber = tc.TransactionNo;
                                        d.Save();

                                        totalCredit += d.Credit.Value;

                                        if (q.DiscountAmount.Value > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = q.DiscountAmount.Value * (decimal)baris["ChargeQuantity"];
                                            disc.Credit = 0;
                                            disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalDebit += disc.Debit.Value;
                                        }
                                    }
                                }

                                //COST FOR CONSUMPTION
                                TransChargesItemConsumptionQuery consp = new TransChargesItemConsumptionQuery();
                                consp.SelectAll();
                                consp.Where(consp.TransactionNo == baris["TransactionNo"],
                                            consp.SequenceNo == baris["SequenceNo"]);

                                DataTable tblconsp = consp.LoadDataTable();

                                if (tblconsp.Rows.Count > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                {
                                    foreach (DataRow r in tblconsp.Rows)
                                    {
                                        // ItemProductMedic
                                        Item itemInv = new Item();
                                        itemInv.Query.Where(itemInv.Query.ItemID == r["DetailItemID"]);
                                        if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                        {
                                            var proacc = new ProductAccountGuarantorGroup();
                                            proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                                proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                            if (proacc.Load(proacc.Query))
                                            {
                                                var TypeReg = reg.SRRegistrationType;
                                                int coaIdCOGS = 0;
                                                int subledgerIdCOGS = 0;
                                                int coaIdInventory = 0;
                                                int subledgerIdInventory = 0;

                                                switch (TypeReg)
                                                {   // pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                                    case "OPR":
                                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                        break;

                                                    case "MCU":
                                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                        break;

                                                    case "IPR":
                                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                                        break;

                                                    case "EMR":
                                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                                        break;

                                                }

                                                if (itemInv.SRItemType == "11")
                                                {
                                                    ItemProductMedic itemMedic = new ItemProductMedic();
                                                    itemMedic.Query.Where(itemMedic.Query.ItemID == r["DetailItemID"]);
                                                    if (itemMedic.Query.Load())
                                                    {
                                                        ItemMovementQuery mov = new ItemMovementQuery();
                                                        mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                   mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                        mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                        mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                        DataTable tbl = mov.LoadDataTable();

                                                        // COGS FOR CONSUMPTION
                                                        foreach (DataRow row in tbl.Rows)
                                                        {
                                                            decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                            JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                            itemMedicCogs.AddNew();
                                                            itemMedicCogs.JournalId = entity.JournalId;
                                                            itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                            itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                            itemMedicCogs.Debit = cogs;
                                                            itemMedicCogs.Credit = 0;
                                                            itemMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                            itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                            AddMoreInfo(itemMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                            itemMedicCogs.Save();

                                                            totalDebit += itemMedicCogs.Debit.Value;

                                                            //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                            JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                            itemMedicInv.AddNew();
                                                            itemMedicInv.JournalId = entity.JournalId;
                                                            itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                            itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                            itemMedicInv.Debit = 0;
                                                            itemMedicInv.Credit = cogs;
                                                            itemMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                            itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                            AddMoreInfo(itemMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                            itemMedicInv.Save();

                                                            totalCredit += itemMedicInv.Credit.Value;
                                                        }

                                                    }
                                                }
                                                else
                                                {
                                                    ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                                    itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == r["DetailItemID"]);
                                                    if (itemNonMedic.Query.Load())
                                                    {
                                                        ItemMovementQuery mov = new ItemMovementQuery();
                                                        mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                   mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                        mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                        mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                        DataTable tbl = mov.LoadDataTable();

                                                        // COGS FOR CONSUMPTION
                                                        foreach (DataRow row in tbl.Rows)
                                                        {
                                                            decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                            // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                            //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                            JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                            itemNonMedicCogs.AddNew();
                                                            itemNonMedicCogs.JournalId = entity.JournalId;
                                                            itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                            itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                            itemNonMedicCogs.Debit = cogs;
                                                            itemNonMedicCogs.Credit = 0;
                                                            itemNonMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                            itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                            AddMoreInfo(itemNonMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                            itemNonMedicCogs.Save();

                                                            totalDebit += itemNonMedicCogs.Debit.Value;

                                                            //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                            JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                            itemNonMedicInv.AddNew();
                                                            itemNonMedicInv.JournalId = entity.JournalId;
                                                            itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                            itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                            itemNonMedicInv.Debit = 0;
                                                            itemNonMedicInv.Credit = cogs;
                                                            itemNonMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                            itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                            AddMoreInfo(itemNonMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                            itemNonMedicInv.Save();

                                                            totalCredit += itemNonMedicInv.Credit.Value;
                                                        }

                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                // }
                            }

                            else
                            {
                                // ItemProductMedic
                                Item itemInv = new Item();
                                itemInv.Query.Where(itemInv.Query.ItemID == baris["ItemID"]);
                                if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                {
                                    var proacc = new ProductAccountGuarantorGroup();
                                    proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                        proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                    if (proacc.Load(proacc.Query))
                                    {
                                        var TypeReg = reg.SRRegistrationType;
                                        int coaIdIncome = 0;
                                        int subledgerIdIncome = 0;
                                        int coaIdCOGS = 0;
                                        int subledgerIdCOGS = 0;
                                        int coaIdInventory = 0;
                                        int subledgerIdInventory = 0;
                                        int coaIdDiscount = 0;
                                        int subledgerIdDiscount = 0;

                                        switch (TypeReg)
                                        {// pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                            case "OPR":
                                                coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                                subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                                coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                                subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                                break;

                                            case "MCU":
                                                coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                                subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                                coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                                subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                                break;

                                            case "IPR":
                                                coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                                subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                                coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                                subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                                coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                                subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                                coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                                subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                                break;
                                            case "EMR":
                                                coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                                subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                                coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                                subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                                coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                                subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                                coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                                subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                                break;
                                        }

                                        if (itemInv.SRItemType == "11")
                                        {
                                            ItemProductMedic itemMedic = new ItemProductMedic();
                                            itemMedic.Query.Where(itemMedic.Query.ItemID == baris["ItemID"]);
                                            if (itemMedic.Query.Load())
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                                itemMedicIncome.AddNew();
                                                itemMedicIncome.JournalId = entity.JournalId;
                                                itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemMedicIncome.Debit = 0;
                                                itemMedicIncome.Credit = (decimal)baris["Price"] * (decimal)baris["ChargeQuantity"]; // c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                                itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, baris["ItemID"], itemInv.ItemName);
                                                itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemMedicIncome.Save();

                                                totalCredit += itemMedicIncome.Credit.Value;

                                                //TransChargesItem ci = new TransChargesItem();
                                                //ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);

                                                //if (ci.Query.Load())
                                                //{
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {
                                                    // COGS
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                    mov.Where(mov.TransactionNo == baris["TransactionNo"],
                                                              mov.SequenceNo == baris["SequenceNo"], mov.ItemID == baris["ItemID"]);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] *
                                                                        (decimal)row["CostPrice"];

                                                        //decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicCogs =
                                                            new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = cogs;
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description =
                                                            string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}",
                                                                          tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                          baris["ItemID"], itemInv.ItemName);
                                                        itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemMedicCogs.Save();

                                                        totalDebit += itemMedicCogs.Debit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv =
                                                            new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = cogs;
                                                        itemMedicInv.Description =
                                                            string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}",
                                                                          tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                          baris["ItemID"], itemInv.ItemName);
                                                        itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemMedicInv.Save();

                                                        totalCredit += itemMedicInv.Credit.Value;
                                                    }
                                                }

                                                if ((decimal)baris["DiscountAmount"] > 0)
                                                {
                                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                                    disc.AddNew();
                                                    disc.JournalId = entity.JournalId;
                                                    disc.ChartOfAccountId = coaIdDiscount;
                                                    disc.SubLedgerId = subledgerIdDiscount;
                                                    disc.Debit = (decimal)baris["DiscountAmount"];
                                                    disc.Credit = 0;
                                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    disc.DocumentNumber = tc.TransactionNo;
                                                    disc.Save();

                                                    totalDebit += disc.Debit.Value;
                                                }
                                            }
                                            // }
                                        }
                                        else
                                        {
                                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == c.ItemID);
                                            if (itemNonMedic.Query.Load())
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                                itemNonMedicIncome.AddNew();
                                                itemNonMedicIncome.JournalId = entity.JournalId;
                                                itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemNonMedicIncome.Debit = 0;
                                                itemNonMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                                itemNonMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemNonMedicIncome.Save();

                                                totalCredit += itemNonMedicIncome.Credit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                                if (ci.Query.Load())
                                                {

                                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                    {
                                                        // COGS
                                                        ItemMovementQuery mov = new ItemMovementQuery();
                                                        mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                   mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                        mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                        mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                        DataTable tbl = mov.LoadDataTable();

                                                        foreach (DataRow row in tbl.Rows)
                                                        {
                                                            decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                            // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                            //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                            JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                            itemNonMedicCogs.AddNew();
                                                            itemNonMedicCogs.JournalId = entity.JournalId;
                                                            itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                            itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                            itemNonMedicCogs.Debit = cogs;
                                                            itemNonMedicCogs.Credit = 0;
                                                            itemNonMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                            itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                            itemNonMedicCogs.Save();

                                                            totalDebit += itemNonMedicCogs.Debit.Value;

                                                            //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                            JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                            itemNonMedicInv.AddNew();
                                                            itemNonMedicInv.JournalId = entity.JournalId;
                                                            itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                            itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                            itemNonMedicInv.Debit = 0;
                                                            itemNonMedicInv.Credit = cogs;
                                                            itemNonMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                            itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                            itemNonMedicInv.Save();

                                                            totalCredit += itemNonMedicInv.Credit.Value;
                                                        }
                                                    }

                                                    if (ci.DiscountAmount > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = ci.DiscountAmount.Value;
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewIncomeJournalTemporary(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Income;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.TransactionDate;
                    entity.Description = string.Format("TRANS REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.TransactionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = unit.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                            //    totalDisc += (c.DiscountAmount.Value);
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.TransactionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                var mcuUnitID = new AppParameter();
                mcuUnitID.LoadByPrimaryKey("ServiceUnitMcuId");

                //CREDIT
                foreach (var c in cost)
                {

                    // Service Unit Item first
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {

                        ServiceUnitItemService itemService = new ServiceUnitItemService();
                        itemService.Query.Where(itemService.Query.ServiceUnitID == unit.ServiceUnitID, itemService.Query.ItemID == c.ItemID);
                        if (itemService.Query.Load())
                        {
                            TransChargesItem ci = new TransChargesItem();
                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                            if (ci.Query.Load())
                            {
                                foreach (var q in tcic)
                                {
                                    decimal discTemp = 0;
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                        discTemp = q.DiscountAmount.Value;

                                    if (q.TransactionNo == c.TransactionNo && q.SequenceNo == c.SequenceNo)
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;
                                        int? coaDiscId = 0;
                                        int? subLedgerDiscId = 0;

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == unit.ServiceUnitID,
                                                             itemComp.Query.ItemID == c.ItemID,
                                                             itemComp.Query.TariffComponentID == q.TariffComponentID); // untuk Gpi harus pake ini

                                        //if (AppParameter.GetParameterValue(AppParameter.ParameterItem.HealthcareInitialAppsVersion) == "GPI")
                                        itemComp.Query.Where(itemComp.Query.SRRegistrationType == regType,
                                                 itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup); // untuk Gpi harus pake ini

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                            }

                                            if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                            {
                                                coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                                subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                            }
                                        }
                                        if (isInpatient && AppParameter.GetParameterValue(AppParameter.ParameterItem.CoaUsingClass) == "1")
                                        {
                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == unit.ServiceUnitID, itemClass.Query.ItemID == c.ItemID,
                                                itemClass.Query.ClassID == tc.ClassID, itemClass.Query.TariffComponentID == q.TariffComponentID);
                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                                }

                                                if (itemClass.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount.Value > 0)
                                                {
                                                    if (itemClass.ChartOfAccountIdDiscount.HasValue && itemClass.ChartOfAccountIdDiscount > 0)
                                                    {
                                                        coaDiscId = itemClass.ChartOfAccountIdDiscount.Value;
                                                        subLedgerDiscId = itemClass.SubledgerIdDiscount.HasValue ? itemClass.SubledgerIdDiscount : 0;
                                                    }
                                                }
                                            }
                                        }


                                        //// if we cant find it use the ones in Service Unit
                                        //if (!coaId.HasValue || coaId == 0)
                                        //{
                                        //    coaId = unit.ChartOfAccountIdIncome;
                                        //    subLedgerId = unit.SubledgerIdIncome.HasValue ? unit.SubledgerIdIncome : 0;
                                        //}
                                        // we need Item Name in ledger report
                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == c.ItemID);
                                        item.Query.Load();

                                        //Logger.LogMessage(string.Format("Creating Income Journal for ServiceUnitItemService:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails d = new JournalTransactionDetails();
                                        d.AddNew();
                                        d.JournalId = entity.JournalId;
                                        d.ChartOfAccountId = coaId;
                                        d.SubLedgerId = subLedgerId;
                                        // d.Debit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        d.Debit = 0;
                                        d.Credit = Abs((q.Price - discTemp) * ci.ChargeQuantity) + Abs(q.CitoAmount ?? 0 * ci.ChargeQuantity);
                                        d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, "");
                                        d.DocumentNumber = tc.TransactionNo;
                                        d.Save();

                                        //totalDebit += d.Debit.Value;
                                        totalCredit += d.Credit.Value; //ganti ini

                                        if (q.DiscountAmount.Value > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = Abs(ci.ChargeQuantity * q.DiscountAmount.Value);
                                            disc.Credit = 0;
                                            disc.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, "");
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalCredit += disc.Credit.Value;
                                        }

                                        //COST FOR CONSUMPTION
                                        TransChargesItemConsumptionQuery consp = new TransChargesItemConsumptionQuery();
                                        consp.SelectAll();
                                        consp.Where(consp.TransactionNo == c.TransactionNo,
                                                    consp.SequenceNo == c.SequenceNo);

                                        DataTable tblconsp = consp.LoadDataTable();

                                        if (tblconsp.Rows.Count > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                        {
                                            foreach (DataRow r in tblconsp.Rows)
                                            {
                                                // ItemProductMedic
                                                Item itemInv = new Item();
                                                itemInv.Query.Where(itemInv.Query.ItemID == r["DetailItemID"]);
                                                if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                                {
                                                    var proacc = new ProductAccountGuarantorGroup();
                                                    proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                                        proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                                    if (proacc.Load(proacc.Query))
                                                    {
                                                        var TypeReg = reg.SRRegistrationType;
                                                        int coaIdCOGS = 0;
                                                        int subledgerIdCOGS = 0;
                                                        int coaIdInventory = 0;
                                                        int subledgerIdInventory = 0;

                                                        switch (TypeReg)
                                                        {
                                                            case "OPR":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                                break;

                                                            case "MCU":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                                break;

                                                            case "IPR":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                                                break;

                                                            case "EMR":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                                                break;

                                                        }

                                                        if (itemInv.SRItemType == "11")
                                                        {
                                                            ItemProductMedic itemMedic = new ItemProductMedic();
                                                            itemMedic.Query.Where(itemMedic.Query.ItemID == r["DetailItemID"]);
                                                            if (itemMedic.Query.Load())
                                                            {
                                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                                mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                                DataTable tbl = mov.LoadDataTable();

                                                                // COGS FOR CONSUMPTION
                                                                foreach (DataRow row in tbl.Rows)
                                                                {
                                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                                    itemMedicCogs.AddNew();
                                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                                    itemMedicCogs.Debit = cogs;
                                                                    itemMedicCogs.Credit = 0;
                                                                    itemMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                    itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                                    AddMoreInfo(itemMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                    itemMedicCogs.Save();

                                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                                    itemMedicInv.AddNew();
                                                                    itemMedicInv.JournalId = entity.JournalId;
                                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                                    itemMedicInv.Debit = 0;
                                                                    itemMedicInv.Credit = cogs;
                                                                    itemMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                    itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                                    AddMoreInfo(itemMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                    itemMedicInv.Save();

                                                                    totalDebit += itemMedicInv.Debit.Value;
                                                                }

                                                            }
                                                        }
                                                        else
                                                        {
                                                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == r["DetailItemID"]);
                                                            if (itemNonMedic.Query.Load())
                                                            {
                                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                                mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                                DataTable tbl = mov.LoadDataTable();

                                                                // COGS FOR CONSUMPTION
                                                                foreach (DataRow row in tbl.Rows)
                                                                {
                                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                                    // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                                    JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                                    itemNonMedicCogs.AddNew();
                                                                    itemNonMedicCogs.JournalId = entity.JournalId;
                                                                    itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                                    itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                                    itemNonMedicCogs.Debit = cogs;
                                                                    itemNonMedicCogs.Credit = 0;
                                                                    itemNonMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                    itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                                    AddMoreInfo(itemNonMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                    itemNonMedicCogs.Save();

                                                                    totalCredit += itemNonMedicCogs.Credit.Value;

                                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                                    JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                                    itemNonMedicInv.AddNew();
                                                                    itemNonMedicInv.JournalId = entity.JournalId;
                                                                    itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                                    itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                                    itemNonMedicInv.Debit = 0;
                                                                    itemNonMedicInv.Credit = cogs;
                                                                    itemNonMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                    itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                                    AddMoreInfo(itemNonMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                    itemNonMedicInv.Save();

                                                                    totalDebit += itemNonMedicInv.Debit.Value;
                                                                }


                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {

                            // ItemProductMedic
                            Item itemInv = new Item();
                            itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                            if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                            {
                                var proacc = new ProductAccountGuarantorGroup();
                                proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                    proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                if (proacc.Load(proacc.Query))
                                {
                                    var TypeReg = reg.SRRegistrationType;
                                    int coaIdIncome = 0;
                                    int subledgerIdIncome = 0;
                                    int coaIdCOGS = 0;
                                    int subledgerIdCOGS = 0;
                                    int coaIdInventory = 0;
                                    int subledgerIdInventory = 0;
                                    int coaIdDiscount = 0;
                                    int subledgerIdDiscount = 0;

                                    switch (TypeReg)
                                    {
                                        case "OPR":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrual.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                            break;

                                        case "MCU":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                            subledgerIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                            break;

                                        case "IPR":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrualIP.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrualIP.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                            break;
                                        case "EMR":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrualIGD.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrualIGD.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                            break;
                                    }

                                    if (itemInv.SRItemType == "11")
                                    {
                                        ItemProductMedic itemMedic = new ItemProductMedic();
                                        itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                        if (itemMedic.Query.Load())
                                        {
                                            //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = 0;
                                            itemMedicIncome.Credit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                            itemMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                            itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;

                                            TransChargesItem ci = new TransChargesItem();
                                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                            if (ci.Query.Load())
                                            {
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {
                                                    // COGS
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                               mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                    mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //decimal? cogs = Abs(ci.StockQuantity * ci.CostPrice);

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = cogs;
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                                        itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemMedicCogs.Save();

                                                        totalCredit += itemMedicCogs.Credit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = cogs;
                                                        itemMedicInv.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                                        itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemMedicInv.Save();

                                                        totalDebit += itemMedicInv.Debit.Value;
                                                    }
                                                }


                                                if (ci.DiscountAmount > 0)
                                                {
                                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                                    disc.AddNew();
                                                    disc.JournalId = entity.JournalId;
                                                    disc.ChartOfAccountId = coaIdDiscount;
                                                    disc.SubLedgerId = subledgerIdDiscount;
                                                    disc.Debit = ci.DiscountAmount.Value;
                                                    disc.Credit = 0;
                                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    disc.DocumentNumber = tc.TransactionNo;
                                                    disc.Save();

                                                    totalCredit += disc.Credit.Value;
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                        itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == c.ItemID);
                                        if (itemNonMedic.Query.Load())
                                        {
                                            //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                            JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                            itemNonMedicIncome.AddNew();
                                            itemNonMedicIncome.JournalId = entity.JournalId;
                                            itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemNonMedicIncome.Debit = 0;
                                            itemNonMedicIncome.Credit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                            itemNonMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                            itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                            itemNonMedicIncome.Save();

                                            totalDebit += itemNonMedicIncome.Debit.Value;


                                            TransChargesItem ci = new TransChargesItem();
                                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                            if (ci.Query.Load())
                                            {
                                                // COGS
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                        itemNonMedicCogs.AddNew();
                                                        itemNonMedicCogs.JournalId = entity.JournalId;
                                                        itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemNonMedicCogs.Debit = cogs;
                                                        itemNonMedicCogs.Credit = 0;
                                                        itemNonMedicCogs.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                                        itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemNonMedicCogs.Save();

                                                        totalCredit += itemNonMedicCogs.Credit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                        itemNonMedicInv.AddNew();
                                                        itemNonMedicInv.JournalId = entity.JournalId;
                                                        itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemNonMedicInv.Debit = 0;
                                                        itemNonMedicInv.Credit = cogs;
                                                        itemNonMedicInv.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                                        itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemNonMedicInv.Save();

                                                        totalDebit += itemNonMedicInv.Debit.Value;

                                                    }
                                                }

                                                if (ci.DiscountAmount > 0)
                                                {
                                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                                    disc.AddNew();
                                                    disc.JournalId = entity.JournalId;
                                                    disc.ChartOfAccountId = coaIdDiscount;
                                                    disc.SubLedgerId = subledgerIdDiscount;
                                                    disc.Debit = ci.DiscountAmount.Value;
                                                    disc.Credit = 0;
                                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    disc.DocumentNumber = tc.TransactionNo;
                                                    disc.Save();

                                                    totalCredit += disc.Credit.Value;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedTransaction) == "Yes")
                    {
                        entity.IsPosted = true;
                    }
                    entity.EndEdit();
                    entity.Save();
                }


                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewIncomeJournalTemporaryTransfer(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId, string refId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Income;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.TransactionDate;
                    entity.Description = string.Format("TRANS REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.TransactionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = unit.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                            //    totalDisc += (c.DiscountAmount.Value);
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.TransactionNo;
                    d.DocumentNumberSequenceNo = refId;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                var mcuUnitID = new AppParameter();
                mcuUnitID.LoadByPrimaryKey("ServiceUnitMcuId");

                //CREDIT
                foreach (var c in cost)
                {
                    DataTable dtb;

                    if (c.IsPackage == false)
                    {
                        var tci = new TransChargesItemQuery("a");
                        var item = new ItemQuery("b");
                        tci.Select(tci, item.SRItemType, item.ItemName);
                        tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                        tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                        dtb = tci.LoadDataTable();
                    }
                    else
                    {
                        if (unit.ServiceUnitID == mcuUnitID.ParameterValue)
                        {
                            var tci = new TransChargesItemQuery("a");
                            var item = new ItemQuery("b");
                            tci.Select(tci, item.SRItemType, item.ItemName);
                            tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                            tci.Where(tci.IsPackage == false, tci.TransactionNo == c.TransactionNo, tci.ParentNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                        else
                        {
                            var tci = new TransChargesItemQuery("a");
                            var item = new ItemQuery("b");
                            tci.Select(tci, item.SRItemType, item.ItemName);
                            tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                            tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                    }

                    if (dtb.Rows.Count > 0)
                    {
                        var code = new string[2] { Reference.ItemType.Medical, Reference.ItemType.NonMedical };

                        var service = from row in dtb.AsEnumerable()
                                      where !code.Contains(row.Field<string>("SRItemType"))
                                      group row by new
                                      {
                                          ItemID = row.Field<string>("ItemID"),
                                          ItemName = row.Field<string>("ItemName")
                                      } into grp
                                      select new
                                      {
                                          grp.Key.ItemID,
                                          grp.Key.ItemName,
                                          Total = grp.Sum(g => ((g.Field<decimal>("ChargeQuantity") * g.Field<decimal>("Price")) - g.Field<decimal>("DiscountAmount")) + g.Field<decimal>("CitoAmount"))
                                      };

                        foreach (var item in service)
                        {
                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                            d.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                            d.Debit = 0;
                            d.Credit = item.Total;
                            d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                            d.DocumentNumber = tc.TransactionNo;
                            d.DocumentNumberSequenceNo = refId;
                            d.Save();

                            totalCredit += d.Credit ?? 0;
                        }

                        var product = from row in dtb.AsEnumerable()
                                      where code.Contains(row.Field<string>("SRItemType"))
                                      group row by new
                                      {
                                          TransactionNo = row.Field<string>("TransactionNo"),
                                          SequenceNo = row.Field<string>("SequenceNo"),
                                          SRItemType = row.Field<string>("SRItemType"),
                                          ItemID = row.Field<string>("ItemID"),
                                          ItemName = row.Field<string>("ItemName")
                                      } into grp
                                      select new
                                      {
                                          grp.Key.TransactionNo,
                                          grp.Key.SequenceNo,
                                          grp.Key.SRItemType,
                                          grp.Key.ItemID,
                                          grp.Key.ItemName,
                                          Total = grp.Sum(g => ((g.Field<decimal>("ChargeQuantity") * g.Field<decimal>("Price")) - g.Field<decimal>("DiscountAmount")) + g.Field<decimal>("CitoAmount"))
                                      };

                        foreach (var item in product)
                        {
                            var inv = new Item();
                            inv.LoadByPrimaryKey(item.ItemID);

                            if (string.IsNullOrEmpty(inv.ProductAccountID)) continue;

                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == inv.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                            if (proacc.Load(proacc.Query))
                            {
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (reg.SRRegistrationType)
                                {
                                    // pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;
                                    case "MCU":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;
                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;
                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;
                                        break;
                                }

                                if (item.SRItemType == Reference.ItemType.Medical)
                                {
                                    ItemProductMedic itemMedic = new ItemProductMedic();
                                    itemMedic.Query.Where(itemMedic.Query.ItemID == item.ItemID);
                                    if (itemMedic.Query.Load())
                                    {
                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        itemMedicIncome.Debit = 0;
                                        //itemMedicIncome.Credit = item.Total;
                                        itemMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                        itemMedicIncome.DocumentNumberSequenceNo = refId;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                        {
                                            // COGS
                                            ItemMovementQuery mov = new ItemMovementQuery();
                                            mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                            mov.Where(mov.TransactionNo == item.TransactionNo, mov.SequenceNo == item.SequenceNo, mov.ItemID == item.ItemID);
                                            mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                            DataTable tbl = mov.LoadDataTable();

                                            foreach (DataRow row in tbl.Rows)
                                            {
                                                decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                itemMedicCogs.AddNew();
                                                itemMedicCogs.JournalId = entity.JournalId;
                                                itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                itemMedicCogs.Debit = cogs;
                                                itemMedicCogs.Credit = 0;
                                                itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                itemMedicCogs.Save();

                                                totalDebit += itemMedicCogs.Debit.Value;

                                                JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                itemMedicInv.AddNew();
                                                itemMedicInv.JournalId = entity.JournalId;
                                                itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                itemMedicInv.Debit = 0;
                                                itemMedicInv.Credit = cogs;
                                                itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                itemMedicInv.DocumentNumberSequenceNo = refId;
                                                itemMedicInv.Save();

                                                totalCredit += itemMedicInv.Credit.Value;
                                            }
                                        }
                                    }
                                }
                                else if (item.SRItemType == Reference.ItemType.NonMedical)
                                {

                                    ItemProductNonMedic itemMedic = new ItemProductNonMedic();
                                    itemMedic.Query.Where(itemMedic.Query.ItemID == item.ItemID);
                                    if (itemMedic.Query.Load())
                                    {
                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        itemMedicIncome.Debit = 0;
                                        //itemMedicIncome.Credit = item.Total;
                                        itemMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                        itemMedicIncome.DocumentNumberSequenceNo = refId;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                        {
                                            // COGS
                                            ItemMovementQuery mov = new ItemMovementQuery();
                                            mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                            mov.Where(mov.TransactionNo == item.TransactionNo, mov.SequenceNo == item.SequenceNo, mov.ItemID == item.ItemID);
                                            mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                            DataTable tbl = mov.LoadDataTable();

                                            foreach (DataRow row in tbl.Rows)
                                            {
                                                decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                itemMedicCogs.AddNew();
                                                itemMedicCogs.JournalId = entity.JournalId;
                                                itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                itemMedicCogs.Debit = cogs;
                                                itemMedicCogs.Credit = 0;
                                                itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                itemMedicCogs.Save();

                                                totalDebit += itemMedicCogs.Debit.Value;

                                                JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                itemMedicInv.AddNew();
                                                itemMedicInv.JournalId = entity.JournalId;
                                                itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                itemMedicInv.Debit = 0;
                                                itemMedicInv.Credit = cogs;
                                                itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                itemMedicInv.DocumentNumberSequenceNo = refId;
                                                itemMedicInv.Save();

                                                totalCredit += itemMedicInv.Credit.Value;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedTransaction) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }


                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewIncomeCorrectionJournal(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, bool isVoid, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeCorrectionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Income;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.TransactionDate;
                    entity.Description = string.Format("CORRECTION REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, (isVoid ? "(VOID REG) " : "(" + tc.ReferenceNo + ")"));
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.TransactionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = reg.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    // decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += (Abs(c.PatientAmount) + Abs(c.GuarantorAmount));
                        }
                        //      totalDisc += Abs(c.DiscountAmount);
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, (isVoid ? "(VOID) " : ""));
                    d.DocumentNumber = tc.TransactionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                    //if (totalDisc > 0)
                    //{
                    //    //Logger.LogMessage(string.Format("Found DiscountAmount Total:{0}, Creating Disc Journal (D).", totalDisc));

                    //    JournalTransactionDetails disc = new JournalTransactionDetails();
                    //    disc.AddNew();
                    //    disc.JournalId = entity.JournalId;
                    //    disc.ChartOfAccountId = unit.ChartOfAccountIdDiscount;
                    //    disc.SubLedgerId = unit.SubledgerIdDiscount.HasValue ? unit.SubledgerIdDiscount : 0;
                    //    disc.Debit = 0;
                    //    disc.Credit = totalDisc;
                    //    disc.Description = string.Format("{4}REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, (isVoid ? "(VOID) " : ""));
                    //    disc.DocumentNumber = tc.TransactionNo;
                    //    disc.Save();

                    //    totalCredit += d.Credit.Value;
                    //}

                }

                //CREDIT
                foreach (var c in cost)
                {

                    // Service Unit Item first
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {

                        ServiceUnitItemService itemService = new ServiceUnitItemService();
                        itemService.Query.Where(itemService.Query.ServiceUnitID == unit.ServiceUnitID, itemService.Query.ItemID == c.ItemID);
                        if (itemService.Query.Load())
                        {
                            TransChargesItem ci = new TransChargesItem();
                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                            if (ci.Query.Load())
                            {
                                foreach (var q in tcic)
                                {
                                    decimal discTemp = 0;
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                        discTemp = q.DiscountAmount.Value;

                                    if (q.TransactionNo == c.TransactionNo && q.SequenceNo == c.SequenceNo)
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;
                                        int? coaDiscId = 0;
                                        int? subLedgerDiscId = 0;

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == unit.ServiceUnitID,
                                                             itemComp.Query.ItemID == c.ItemID,
                                                             itemComp.Query.TariffComponentID == q.TariffComponentID); // untuk Gpi harus pake ini

                                        //if (AppParameter.GetParameterValue(AppParameter.ParameterItem.HealthcareInitialAppsVersion) == "GPI")
                                        itemComp.Query.Where(itemComp.Query.SRRegistrationType == regType,
                                                 itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup); // untuk Gpi harus pake ini

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                            }

                                            if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                            {
                                                coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                                subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                            }
                                        }
                                        if (isInpatient && AppParameter.GetParameterValue(AppParameter.ParameterItem.CoaUsingClass) == "1")
                                        {
                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == unit.ServiceUnitID, itemClass.Query.ItemID == c.ItemID,
                                                itemClass.Query.ClassID == tc.ClassID, itemClass.Query.TariffComponentID == q.TariffComponentID);
                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                                }

                                                if (itemClass.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount.Value > 0)
                                                {
                                                    if (itemClass.ChartOfAccountIdDiscount.HasValue && itemClass.ChartOfAccountIdDiscount > 0)
                                                    {
                                                        coaDiscId = itemClass.ChartOfAccountIdDiscount.Value;
                                                        subLedgerDiscId = itemClass.SubledgerIdDiscount.HasValue ? itemClass.SubledgerIdDiscount : 0;
                                                    }
                                                }
                                            }
                                        }


                                        //// if we cant find it use the ones in Service Unit
                                        //if (!coaId.HasValue || coaId == 0)
                                        //{
                                        //    coaId = unit.ChartOfAccountIdIncome;
                                        //    subLedgerId = unit.SubledgerIdIncome.HasValue ? unit.SubledgerIdIncome : 0;
                                        //}
                                        // we need Item Name in ledger report
                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == c.ItemID);
                                        item.Query.Load();

                                        //Logger.LogMessage(string.Format("Creating Income Journal for ServiceUnitItemService:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails d = new JournalTransactionDetails();
                                        d.AddNew();
                                        d.JournalId = entity.JournalId;
                                        d.ChartOfAccountId = coaId;
                                        d.SubLedgerId = subLedgerId;
                                        // d.Debit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        d.Debit = Abs((q.Price - discTemp) * ci.ChargeQuantity) + Abs(q.CitoAmount ?? 0 * ci.ChargeQuantity);
                                        d.Credit = 0;
                                        d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, (isVoid ? "(VOID) " : ""));
                                        d.DocumentNumber = tc.TransactionNo;
                                        d.Save();

                                        totalDebit += d.Debit.Value;

                                        if (q.DiscountAmount.Value > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = 0;
                                            disc.Credit = Abs(ci.ChargeQuantity * q.DiscountAmount.Value);
                                            disc.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, (isVoid ? "(VOID) " : ""));
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalCredit += disc.Credit.Value;
                                        }

                                        //COST FOR CONSUMPTION
                                        TransChargesItemConsumptionQuery consp = new TransChargesItemConsumptionQuery();
                                        consp.SelectAll();
                                        consp.Where(consp.TransactionNo == c.TransactionNo,
                                                    consp.SequenceNo == c.SequenceNo);

                                        DataTable tblconsp = consp.LoadDataTable();

                                        if (tblconsp.Rows.Count > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                        {
                                            foreach (DataRow r in tblconsp.Rows)
                                            {
                                                // ItemProductMedic
                                                Item itemInv = new Item();
                                                itemInv.Query.Where(itemInv.Query.ItemID == r["DetailItemID"]);
                                                if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                                {
                                                    var proacc = new ProductAccountGuarantorGroup();
                                                    proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                                        proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                                    if (proacc.Load(proacc.Query))
                                                    {
                                                        var TypeReg = reg.SRRegistrationType;
                                                        int coaIdCOGS = 0;
                                                        int subledgerIdCOGS = 0;
                                                        int coaIdInventory = 0;
                                                        int subledgerIdInventory = 0;

                                                        switch (TypeReg)
                                                        {
                                                            case "OPR":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                                break;

                                                            case "MCU":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                                                break;

                                                            case "IPR":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                                                break;

                                                            case "EMR":
                                                                coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                                                subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                                                coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                                                subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                                                break;

                                                        }

                                                        if (itemInv.SRItemType == "11")
                                                        {
                                                            ItemProductMedic itemMedic = new ItemProductMedic();
                                                            itemMedic.Query.Where(itemMedic.Query.ItemID == r["DetailItemID"]);
                                                            if (itemMedic.Query.Load())
                                                            {
                                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                                mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                                DataTable tbl = mov.LoadDataTable();

                                                                // COGS FOR CONSUMPTION
                                                                foreach (DataRow row in tbl.Rows)
                                                                {
                                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                                    if (coaIdCOGS != 0 && subledgerIdCOGS != 0)
                                                                    {
                                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                                        itemMedicCogs.AddNew();
                                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                                        itemMedicCogs.Debit = 0;
                                                                        itemMedicCogs.Credit = cogs;
                                                                        itemMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                        itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                                        AddMoreInfo(itemMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                            null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                        itemMedicCogs.Save();

                                                                        totalCredit += itemMedicCogs.Credit.Value;
                                                                    }

                                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                                                    if (coaIdInventory != 0 && subledgerIdInventory != 0)
                                                                    {
                                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                                        itemMedicInv.AddNew();
                                                                        itemMedicInv.JournalId = entity.JournalId;
                                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                                        itemMedicInv.Debit = cogs;
                                                                        itemMedicInv.Credit = 0;
                                                                        itemMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                        itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                                        AddMoreInfo(itemMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                            null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                        itemMedicInv.Save();

                                                                        totalDebit += itemMedicInv.Debit.Value;
                                                                    }
                                                                }

                                                            }
                                                        }
                                                        else
                                                        {
                                                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == r["DetailItemID"]);
                                                            if (itemNonMedic.Query.Load())
                                                            {
                                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                                mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                                DataTable tbl = mov.LoadDataTable();

                                                                // COGS FOR CONSUMPTION
                                                                foreach (DataRow row in tbl.Rows)
                                                                {
                                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                                    // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                                    JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                                    itemNonMedicCogs.AddNew();
                                                                    itemNonMedicCogs.JournalId = entity.JournalId;
                                                                    itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                                    itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                                    itemNonMedicCogs.Debit = 0;
                                                                    itemNonMedicCogs.Credit = cogs;
                                                                    itemNonMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                    itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                                    AddMoreInfo(itemNonMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                    itemNonMedicCogs.Save();

                                                                    totalCredit += itemNonMedicCogs.Credit.Value;

                                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                                    JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                                    itemNonMedicInv.AddNew();
                                                                    itemNonMedicInv.JournalId = entity.JournalId;
                                                                    itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                                    itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                                    itemNonMedicInv.Debit = cogs;
                                                                    itemNonMedicInv.Credit = 0;
                                                                    itemNonMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, c.ItemID);
                                                                    itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                                    AddMoreInfo(itemNonMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, r["SequenceNo"].ToString());
                                                                    itemNonMedicInv.Save();

                                                                    totalDebit += itemNonMedicInv.Debit.Value;
                                                                }


                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {

                            // ItemProductMedic
                            Item itemInv = new Item();
                            itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                            if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                            {
                                var proacc = new ProductAccountGuarantorGroup();
                                proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                    proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                if (proacc.Load(proacc.Query))
                                {
                                    var TypeReg = reg.SRRegistrationType;
                                    int coaIdIncome = 0;
                                    int subledgerIdIncome = 0;
                                    int coaIdCOGS = 0;
                                    int subledgerIdCOGS = 0;
                                    int coaIdInventory = 0;
                                    int subledgerIdInventory = 0;
                                    int coaIdDiscount = 0;
                                    int subledgerIdDiscount = 0;

                                    switch (TypeReg)
                                    {
                                        case "OPR":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrual.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                            break;

                                        case "MCU":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrual.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                            break;

                                        case "IPR":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrualIP.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrualIP.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                            break;
                                        case "EMR":
                                            coaIdIncome = proacc.ChartOfAccountIdAcrualIGD.Value;
                                            subledgerIdIncome = proacc.SubledgerIdAcrualIGD.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                            break;
                                    }

                                    if (itemInv.SRItemType == "11")
                                    {
                                        ItemProductMedic itemMedic = new ItemProductMedic();
                                        itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                        if (itemMedic.Query.Load())
                                        {
                                            //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                            itemMedicIncome.Credit = 0;
                                            itemMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                            itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;

                                            TransChargesItem ci = new TransChargesItem();
                                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                            if (ci.Query.Load())
                                            {
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {
                                                    // COGS
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                               mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                    mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //decimal? cogs = Abs(ci.StockQuantity * ci.CostPrice);

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = 0;
                                                        itemMedicCogs.Credit = cogs;
                                                        itemMedicCogs.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                        itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemMedicCogs.Save();

                                                        totalCredit += itemMedicCogs.Credit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = cogs;
                                                        itemMedicInv.Credit = 0;
                                                        itemMedicInv.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                        itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemMedicInv.Save();

                                                        totalDebit += itemMedicInv.Debit.Value;
                                                    }
                                                }


                                                if (ci.DiscountAmount > 0)
                                                {
                                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                                    disc.AddNew();
                                                    disc.JournalId = entity.JournalId;
                                                    disc.ChartOfAccountId = coaIdDiscount;
                                                    disc.SubLedgerId = subledgerIdDiscount;
                                                    disc.Debit = 0;
                                                    disc.Credit = ci.DiscountAmount.Value;
                                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    disc.DocumentNumber = tc.TransactionNo;
                                                    disc.Save();

                                                    totalCredit += disc.Credit.Value;
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                        itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == c.ItemID);
                                        if (itemNonMedic.Query.Load())
                                        {
                                            //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                            JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                            itemNonMedicIncome.AddNew();
                                            itemNonMedicIncome.JournalId = entity.JournalId;
                                            itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemNonMedicIncome.Debit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                            itemNonMedicIncome.Credit = 0;
                                            itemNonMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                            itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                            itemNonMedicIncome.Save();

                                            totalDebit += itemNonMedicIncome.Debit.Value;


                                            TransChargesItem ci = new TransChargesItem();
                                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                            if (ci.Query.Load())
                                            {
                                                // COGS
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                        itemNonMedicCogs.AddNew();
                                                        itemNonMedicCogs.JournalId = entity.JournalId;
                                                        itemNonMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemNonMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemNonMedicCogs.Debit = 0;
                                                        itemNonMedicCogs.Credit = cogs;
                                                        itemNonMedicCogs.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                        itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                        itemNonMedicCogs.Save();

                                                        totalCredit += itemNonMedicCogs.Credit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                        itemNonMedicInv.AddNew();
                                                        itemNonMedicInv.JournalId = entity.JournalId;
                                                        itemNonMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemNonMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemNonMedicInv.Debit = cogs;
                                                        itemNonMedicInv.Credit = 0;
                                                        itemNonMedicInv.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                        itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                        itemNonMedicInv.Save();

                                                        totalDebit += itemNonMedicInv.Debit.Value;

                                                    }
                                                }

                                                if (ci.DiscountAmount > 0)
                                                {
                                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                                    disc.AddNew();
                                                    disc.JournalId = entity.JournalId;
                                                    disc.ChartOfAccountId = coaIdDiscount;
                                                    disc.SubLedgerId = subledgerIdDiscount;
                                                    disc.Debit = 0;
                                                    disc.Credit = ci.DiscountAmount.Value;
                                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    disc.DocumentNumber = tc.TransactionNo;
                                                    disc.Save();

                                                    totalCredit += disc.Credit.Value;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewIncomeCorrectionJournalTemporary(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Income;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.TransactionDate;
                    entity.Description = string.Format("CORRECTION REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.TransactionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = unit.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += Math.Abs(c.PatientAmount.Value + c.GuarantorAmount.Value);
                            //    totalDisc += (c.DiscountAmount.Value);
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.TransactionNo;
                    d.Save();

                    totalDebit += d.Credit.Value;
                }

                var mcuUnitID = new AppParameter();
                mcuUnitID.LoadByPrimaryKey("ServiceUnitMcuId");

                //CREDIT
                foreach (var c in cost)
                {
                    DataTable dtb;

                    if (c.IsPackage == false)
                    {
                        var tci = new TransChargesItemQuery("a");
                        var item = new ItemQuery("b");
                        tci.Select(tci, item.SRItemType, item.ItemName);
                        tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                        tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                        dtb = tci.LoadDataTable();
                    }
                    else
                    {
                        if (unit.ServiceUnitID == mcuUnitID.ParameterValue)
                        {
                            var tci = new TransChargesItemQuery("a");
                            var item = new ItemQuery("b");
                            tci.Select(tci, item.SRItemType, item.ItemName);
                            tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                            tci.Where(tci.IsPackage == false, tci.TransactionNo == c.TransactionNo, tci.ParentNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                        else
                        {
                            var tci = new TransChargesItemQuery("a");
                            var item = new ItemQuery("b");
                            tci.Select(tci, item.SRItemType, item.ItemName);
                            tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                            tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                    }

                    if (dtb.Rows.Count > 0)
                    {
                        var code = new string[2] { Reference.ItemType.Medical, Reference.ItemType.NonMedical };

                        var service = from row in dtb.AsEnumerable()
                                      where !code.Contains(row.Field<string>("SRItemType"))
                                      group row by new
                                      {
                                          ItemID = row.Field<string>("ItemID"),
                                          ItemName = row.Field<string>("ItemName")
                                      } into grp
                                      select new
                                      {
                                          grp.Key.ItemID,
                                          grp.Key.ItemName,
                                          Total = grp.Sum(g => ((Math.Abs(g.Field<decimal>("ChargeQuantity")) * g.Field<decimal>("Price")) - g.Field<decimal>("DiscountAmount")) + g.Field<decimal>("CitoAmount"))
                                      };

                        foreach (var item in service)
                        {
                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                            d.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                            d.Debit = Math.Abs(item.Total);
                            d.Credit = 0;
                            d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                            d.DocumentNumber = tc.TransactionNo;
                            d.Save();

                            totalCredit += d.Debit ?? 0;
                        }

                        var product = from row in dtb.AsEnumerable()
                                      where code.Contains(row.Field<string>("SRItemType"))
                                      group row by new
                                      {
                                          TransactionNo = row.Field<string>("TransactionNo"),
                                          SequenceNo = row.Field<string>("SequenceNo"),
                                          SRItemType = row.Field<string>("SRItemType"),
                                          ItemID = row.Field<string>("ItemID"),
                                          ItemName = row.Field<string>("ItemName")
                                      } into grp
                                      select new
                                      {
                                          grp.Key.TransactionNo,
                                          grp.Key.SequenceNo,
                                          grp.Key.SRItemType,
                                          grp.Key.ItemID,
                                          grp.Key.ItemName,
                                          Total = grp.Sum(g => ((Math.Abs(g.Field<decimal>("ChargeQuantity")) * g.Field<decimal>("Price")) - g.Field<decimal>("DiscountAmount")) + g.Field<decimal>("CitoAmount"))
                                      };

                        foreach (var item in product)
                        {
                            var inv = new Item();
                            inv.LoadByPrimaryKey(item.ItemID);

                            if (string.IsNullOrEmpty(inv.ProductAccountID)) continue;

                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == inv.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                            if (proacc.Load(proacc.Query))
                            {
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (reg.SRRegistrationType)
                                {
                                    // pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;
                                    case "MCU":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;
                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;
                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;
                                        break;
                                }

                                if (item.SRItemType == Reference.ItemType.Medical)
                                {
                                    ItemProductMedic itemMedic = new ItemProductMedic();
                                    itemMedic.Query.Where(itemMedic.Query.ItemID == item.ItemID);
                                    if (itemMedic.Query.Load())
                                    {
                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        itemMedicIncome.Debit = Math.Abs(item.Total);
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Debit.Value;

                                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                        {
                                            // COGS
                                            ItemMovementQuery mov = new ItemMovementQuery();
                                            mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                            mov.Where(mov.TransactionNo == item.TransactionNo, mov.SequenceNo == item.SequenceNo, mov.ItemID == item.ItemID);
                                            mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                            DataTable tbl = mov.LoadDataTable();

                                            foreach (DataRow row in tbl.Rows)
                                            {
                                                decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                itemMedicCogs.AddNew();
                                                itemMedicCogs.JournalId = entity.JournalId;
                                                itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                itemMedicCogs.Debit = 0;
                                                itemMedicCogs.Credit = Math.Abs(cogs ?? 0);
                                                itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                itemMedicCogs.Save();

                                                totalDebit += itemMedicCogs.Credit.Value;

                                                JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                itemMedicInv.AddNew();
                                                itemMedicInv.JournalId = entity.JournalId;
                                                itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                itemMedicInv.Debit = Math.Abs(cogs ?? 0);
                                                itemMedicInv.Credit = 0;
                                                itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                itemMedicInv.Save();

                                                totalCredit += itemMedicInv.Debit.Value;
                                            }
                                        }
                                    }
                                }
                                else if (item.SRItemType == Reference.ItemType.NonMedical)
                                {

                                }
                            }
                        }

                    }
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewIncomeCorrectionJournalTemporaryTransfer(TransCharges tc, TransChargesItemCompCollection tcic, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId, string refId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                //sering bikin error pas debug sehingga harus dikomen
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Income;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.TransactionDate;
                    entity.Description = string.Format("CORRECTION REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.TransactionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = unit.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        if (string.IsNullOrEmpty(c.ParentNo))
                        {
                            totalIncome += Math.Abs(c.PatientAmount.Value + c.GuarantorAmount.Value);
                            //    totalDisc += (c.DiscountAmount.Value);
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.TransactionNo;
                    d.DocumentNumberSequenceNo = refId;
                    d.Save();

                    totalDebit += d.Credit.Value;
                }

                var mcuUnitID = new AppParameter();
                mcuUnitID.LoadByPrimaryKey("ServiceUnitMcuId");

                //CREDIT
                foreach (var c in cost)
                {
                    DataTable dtb;

                    if (c.IsPackage == false)
                    {
                        var tci = new TransChargesItemQuery("a");
                        var item = new ItemQuery("b");
                        tci.Select(tci, item.SRItemType, item.ItemName);
                        tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                        tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                        dtb = tci.LoadDataTable();
                    }
                    else
                    {
                        if (unit.ServiceUnitID == mcuUnitID.ParameterValue)
                        {
                            var tci = new TransChargesItemQuery("a");
                            var item = new ItemQuery("b");
                            tci.Select(tci, item.SRItemType, item.ItemName);
                            tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                            tci.Where(tci.IsPackage == false, tci.TransactionNo == c.TransactionNo, tci.ParentNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                        else
                        {
                            var tci = new TransChargesItemQuery("a");
                            var item = new ItemQuery("b");
                            tci.Select(tci, item.SRItemType, item.ItemName);
                            tci.InnerJoin(item).On(tci.ItemID == item.ItemID);
                            tci.Where(tci.TransactionNo == c.TransactionNo, tci.SequenceNo == c.SequenceNo);
                            dtb = tci.LoadDataTable();
                        }
                    }

                    if (dtb.Rows.Count > 0)
                    {
                        var code = new string[2] { Reference.ItemType.Medical, Reference.ItemType.NonMedical };

                        var service = from row in dtb.AsEnumerable()
                                      where !code.Contains(row.Field<string>("SRItemType"))
                                      group row by new
                                      {
                                          ItemID = row.Field<string>("ItemID"),
                                          ItemName = row.Field<string>("ItemName")
                                      } into grp
                                      select new
                                      {
                                          grp.Key.ItemID,
                                          grp.Key.ItemName,
                                          Total = grp.Sum(g => ((Math.Abs(g.Field<decimal>("ChargeQuantity")) * g.Field<decimal>("Price")) - g.Field<decimal>("DiscountAmount")) + g.Field<decimal>("CitoAmount"))
                                      };

                        foreach (var item in service)
                        {
                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                            d.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                            d.Debit = Math.Abs(item.Total);
                            d.Credit = 0;
                            d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                            d.DocumentNumber = tc.TransactionNo;
                            d.DocumentNumberSequenceNo = refId;
                            d.Save();

                            totalCredit += d.Debit ?? 0;
                        }

                        var product = from row in dtb.AsEnumerable()
                                      where code.Contains(row.Field<string>("SRItemType"))
                                      group row by new
                                      {
                                          TransactionNo = row.Field<string>("TransactionNo"),
                                          SequenceNo = row.Field<string>("SequenceNo"),
                                          SRItemType = row.Field<string>("SRItemType"),
                                          ItemID = row.Field<string>("ItemID"),
                                          ItemName = row.Field<string>("ItemName")
                                      } into grp
                                      select new
                                      {
                                          grp.Key.TransactionNo,
                                          grp.Key.SequenceNo,
                                          grp.Key.SRItemType,
                                          grp.Key.ItemID,
                                          grp.Key.ItemName,
                                          Total = grp.Sum(g => ((Math.Abs(g.Field<decimal>("ChargeQuantity")) * g.Field<decimal>("Price")) - g.Field<decimal>("DiscountAmount")) + g.Field<decimal>("CitoAmount"))
                                      };

                        foreach (var item in product)
                        {
                            var inv = new Item();
                            inv.LoadByPrimaryKey(item.ItemID);

                            if (string.IsNullOrEmpty(inv.ProductAccountID)) continue;

                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == inv.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                            if (proacc.Load(proacc.Query))
                            {
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (reg.SRRegistrationType)
                                {
                                    // pd saat jual di unit harusnya coa COGS ambilnya dari COA COGS di unit sehingga biaya masuk sesuai unit, bukan dari product account
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;
                                    case "MCU":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;
                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;
                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;
                                        break;
                                }

                                if (item.SRItemType == Reference.ItemType.Medical)
                                {
                                    ItemProductMedic itemMedic = new ItemProductMedic();
                                    itemMedic.Query.Where(itemMedic.Query.ItemID == item.ItemID);
                                    if (itemMedic.Query.Load())
                                    {
                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        itemMedicIncome.Debit = Math.Abs(item.Total);
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                        itemMedicIncome.DocumentNumberSequenceNo = refId;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Debit.Value;

                                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                        {
                                            // COGS
                                            ItemMovementQuery mov = new ItemMovementQuery();
                                            mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                            mov.Where(mov.TransactionNo == item.TransactionNo, mov.SequenceNo == item.SequenceNo, mov.ItemID == item.ItemID);
                                            mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                            DataTable tbl = mov.LoadDataTable();

                                            foreach (DataRow row in tbl.Rows)
                                            {
                                                decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                itemMedicCogs.AddNew();
                                                itemMedicCogs.JournalId = entity.JournalId;
                                                itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                itemMedicCogs.Debit = 0;
                                                itemMedicCogs.Credit = Math.Abs(cogs ?? 0);
                                                itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                itemMedicCogs.Save();

                                                totalDebit += itemMedicCogs.Credit.Value;

                                                JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                itemMedicInv.AddNew();
                                                itemMedicInv.JournalId = entity.JournalId;
                                                itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                itemMedicInv.Debit = Math.Abs(cogs ?? 0);
                                                itemMedicInv.Credit = 0;
                                                itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item.ItemID, item.ItemName);
                                                itemMedicInv.DocumentNumber = tc.TransactionNo;
                                                itemMedicInv.DocumentNumberSequenceNo = refId;
                                                itemMedicInv.Save();

                                                totalCredit += itemMedicInv.Debit.Value;
                                            }
                                        }
                                    }
                                }
                                else if (item.SRItemType == Reference.ItemType.NonMedical)
                                {

                                }
                            }
                        }

                    }
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewIncomeCorrectionVerificationJournal(TransCharges tc, IEnumerable<TransChargesItemComp> tcic, IEnumerable<TransChargesItemCompHistory> compHist, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, IEnumerable<CostCalculationHistory> hist, string prefix, string editedBy, bool isVoid)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeCorrectionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                decimal totalIncome = 0;
                decimal totalDisc = 0;
                decimal totalIncomeHist = 0;
                decimal totalDiscHist = 0;
                decimal selisihTotalIncome = 0;
                decimal selisihtotalDisc = 0;

                foreach (var c in cost)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        totalIncome += (Abs(c.PatientAmount.Value)) + Abs((c.GuarantorAmount.Value));
                        totalDisc += Abs(c.DiscountAmount.Value);
                    }
                }

                foreach (var c in hist)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        totalIncomeHist += (Abs(c.PatientAmount.Value) + Abs(c.GuarantorAmount.Value));
                        totalDiscHist += Abs(c.DiscountAmount.Value);
                    }
                }

                selisihTotalIncome = totalIncome - totalIncomeHist;
                selisihtotalDisc = totalDisc - totalDiscHist;

                if (selisihtotalDisc == 0 && selisihTotalIncome == 0)
                    return -1;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.Income;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.TransactionDate;
                entity.Description = string.Format("CORRECTION {4}REG#:{0}. PAT#:{1}. UNIT:{2}-{3} . REC:{5}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, (isVoid ? "(VOID REG) " : ""), hist.Select(p => p.RecalculationProcessNo).Take(1).SingleOrDefault());
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.TransactionNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = reg.SRRegistrationType.ToLowerInvariant().Equals("ipr");

                //DEBIT:
                if (true)
                {
                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    if (selisihTotalIncome > 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = 0;
                        d.Credit = selisihTotalIncome;
                        d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, (isVoid ? "(VOID) " : ""));
                        d.DocumentNumber = tc.TransactionNo;
                        d.Save();

                        totalCredit += d.Credit.Value;
                    }
                    else if (selisihTotalIncome < 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = Abs(selisihTotalIncome);
                        d.Credit = 0;
                        d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, (isVoid ? "(VOID) " : ""));
                        d.DocumentNumber = tc.TransactionNo;
                        d.Save();

                        totalDebit += d.Debit.Value;
                    }
                }

                //CREDIT
                foreach (var c in cost)
                {
                    // Service Unit Item first
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        ServiceUnitItemService itemService = new ServiceUnitItemService();
                        itemService.Query.Where(itemService.Query.ServiceUnitID == unit.ServiceUnitID, itemService.Query.ItemID == c.ItemID);
                        if (itemService.Query.Load())
                        {
                            TransChargesItem ci = new TransChargesItem();
                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                            if (ci.Query.Load())
                            {
                                foreach (var q in tcic)
                                {
                                    decimal discTemp = 0;
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                        discTemp = q.DiscountAmount.Value;

                                    if (q.TransactionNo == c.TransactionNo && q.SequenceNo == c.SequenceNo)
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;
                                        int? coaDiscId = 0;
                                        int? subLedgerDiscId = 0;
                                        decimal selisihIncome = 0;
                                        decimal selisihDiskon = 0;

                                        var p = compHist.Where(h => h.TransactionNo == q.TransactionNo && h.SequenceNo == q.SequenceNo && h.TariffComponentID == q.TariffComponentID).SingleOrDefault();
                                        if (p != null)
                                        {
                                            decimal discTempP = 0;
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                                discTempP = p.DiscountAmount.Value;

                                            selisihIncome = Abs(((q.Price.Value - discTemp) * ci.ChargeQuantity.Value)) - Abs(((p.Price.Value - discTempP) * ci.ChargeQuantity.Value));
                                            selisihDiskon = Abs((q.DiscountAmount.Value * ci.ChargeQuantity.Value)) - Abs((p.DiscountAmount.Value * ci.ChargeQuantity.Value));
                                        }

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == unit.ServiceUnitID,
                                                             itemComp.Query.ItemID == c.ItemID,
                                                             itemComp.Query.TariffComponentID == q.TariffComponentID,
                                                             itemComp.Query.SRRegistrationType == regType,
                                                             itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                            }

                                            if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                            {
                                                coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                                subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                            }
                                        }
                                        if (isInpatient && AppParameter.GetParameterValue(AppParameter.ParameterItem.CoaUsingClass) == "1")
                                        {
                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == unit.ServiceUnitID, itemClass.Query.ItemID == c.ItemID,
                                                itemClass.Query.ClassID == tc.ClassID, itemClass.Query.TariffComponentID == q.TariffComponentID);
                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                                }

                                                if (itemClass.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount.Value > 0)
                                                {
                                                    if (itemClass.ChartOfAccountIdDiscount.HasValue && itemClass.ChartOfAccountIdDiscount > 0)
                                                    {
                                                        coaDiscId = itemClass.ChartOfAccountIdDiscount.Value;
                                                        subLedgerDiscId = itemClass.SubledgerIdDiscount.HasValue ? itemClass.SubledgerIdDiscount : 0;
                                                    }
                                                }
                                            }
                                        }

                                        //// if we cant find it use the ones in Service Unit
                                        //if (!coaId.HasValue || coaId == 0)
                                        //{
                                        //    coaId = unit.ChartOfAccountIdIncome;
                                        //    subLedgerId = unit.SubledgerIdIncome.HasValue ? unit.SubledgerIdIncome : 0;
                                        //}
                                        // we need Item Name in ledger report
                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == c.ItemID);
                                        item.Query.Load();

                                        //Logger.LogMessage(string.Format("Creating Income Journal for ServiceUnitItemService:{0}. (C)", c.ItemID));
                                        if (selisihIncome > 0)
                                        {
                                            JournalTransactionDetails d = new JournalTransactionDetails();
                                            d.AddNew();
                                            d.JournalId = entity.JournalId;
                                            d.ChartOfAccountId = coaId;
                                            d.SubLedgerId = subLedgerId;
                                            // d.Debit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                            d.Debit = selisihIncome;
                                            d.Credit = 0;
                                            d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, (isVoid ? "(VOID) " : ""));
                                            d.DocumentNumber = tc.TransactionNo;
                                            d.Save();

                                            totalDebit += d.Debit.Value;
                                        }
                                        else if (selisihIncome < 0)
                                        {
                                            JournalTransactionDetails d = new JournalTransactionDetails();
                                            d.AddNew();
                                            d.JournalId = entity.JournalId;
                                            d.ChartOfAccountId = coaId;
                                            d.SubLedgerId = subLedgerId;
                                            // d.Debit = Abs(c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                            d.Debit = 0;
                                            d.Credit = Abs(selisihIncome);
                                            d.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, (isVoid ? "(VOID) " : ""));
                                            d.DocumentNumber = tc.TransactionNo;
                                            d.Save();

                                            totalCredit += d.Credit.Value;
                                        }

                                        if (selisihDiskon > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = 0;
                                            disc.Credit = selisihDiskon;
                                            disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, (isVoid ? "(VOID) " : ""));
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalCredit += disc.Credit.Value;
                                        }
                                        else if (selisihDiskon < 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = Abs(selisihDiskon);
                                            disc.Credit = 0;
                                            disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName, (isVoid ? "(VOID) " : ""));
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalDebit += disc.Debit.Value;
                                        }
                                    }
                                }
                            }
                        }
                        //Medic & Non Medic
                        else
                        {

                            decimal selisihIncome = 0;
                            decimal selisihDiskon = 0;

                            var p = hist.Where(h => h.TransactionNo == c.TransactionNo && h.SequenceNo == c.SequenceNo).SingleOrDefault();
                            if (p != null)
                            {
                                selisihIncome = Abs(c.PatientAmount.Value) + Abs(c.GuarantorAmount.Value) + Abs(c.DiscountAmount.Value) - Abs(p.PatientAmount.Value) - Abs(p.GuarantorAmount.Value) - Abs(p.DiscountAmount.Value);
                                selisihDiskon = Abs(c.DiscountAmount.Value) - Abs(p.DiscountAmount.Value);
                            }

                            // ItemProductMedic
                            Item itemInv = new Item();
                            itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                            if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                            {
                                var proacc = new ProductAccountGuarantorGroup();
                                proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                    proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                if (proacc.Load(proacc.Query))
                                {
                                    var TypeReg = reg.SRRegistrationType;
                                    int coaIdIncome = 0;
                                    int subledgerIdIncome = 0;
                                    int coaIdCOGS = 0;
                                    int subledgerIdCOGS = 0;
                                    int coaIdInventory = 0;
                                    int subledgerIdInventory = 0;
                                    int coaIdDiscount = 0;
                                    int subledgerIdDiscount = 0;

                                    switch (TypeReg)
                                    {
                                        case "OPR":
                                            coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                            subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                            break;

                                        case "IPR":
                                            coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                            subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                            break;
                                        case "EMR":
                                            coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                            subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                            break;
                                    }

                                    if (itemInv.SRItemType == "11")
                                    {
                                        ItemProductMedic itemMedic = new ItemProductMedic();
                                        itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                        if (itemMedic.Query.Load())
                                        {

                                            if (selisihIncome > 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                                itemMedicIncome.AddNew();
                                                itemMedicIncome.JournalId = entity.JournalId;
                                                itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemMedicIncome.Debit = selisihIncome;
                                                itemMedicIncome.Credit = 0;
                                                itemMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemMedicIncome.Save();

                                                totalDebit += itemMedicIncome.Debit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // jurnal COGS tidak ada karena tidak mungkin cost price berbeda

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = selisihDiskon;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = selisihDiskon;
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                }
                                            }
                                            else if (selisihIncome < 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                                itemMedicIncome.AddNew();
                                                itemMedicIncome.JournalId = entity.JournalId;
                                                itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemMedicIncome.Debit = 0;
                                                itemMedicIncome.Credit = Abs(selisihIncome);
                                                itemMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemMedicIncome.Save();

                                                totalCredit += itemMedicIncome.Credit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // jurnal COGS tidak ada karena tidak mungkin cost price berbeda

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = selisihDiskon;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = Abs(selisihDiskon);
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                        itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == c.ItemID);
                                        if (itemNonMedic.Query.Load())
                                        {
                                            if (selisihIncome > 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                                itemNonMedicIncome.AddNew();
                                                itemNonMedicIncome.JournalId = entity.JournalId;
                                                itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemNonMedicIncome.Debit = selisihIncome;
                                                itemNonMedicIncome.Credit = 0;
                                                itemNonMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemNonMedicIncome.Save();

                                                totalDebit += itemNonMedicIncome.Debit.Value;


                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // COGS tidak ada karena cost price tidak mungkin berbeda

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = selisihDiskon;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = Abs(selisihDiskon);
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                }
                                            }
                                            else if (selisihIncome < 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductNonMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                                itemNonMedicIncome.AddNew();
                                                itemNonMedicIncome.JournalId = entity.JournalId;
                                                itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemNonMedicIncome.Debit = 0;
                                                itemNonMedicIncome.Credit = Abs(selisihIncome);
                                                itemNonMedicIncome.Description = string.Format("{4}REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, (isVoid ? "(VOID) " : ""));
                                                itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemNonMedicIncome.Save();

                                                totalDebit += itemNonMedicIncome.Debit.Value;


                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // COGS tidak ada karena cost price tidak mungkin berbeda

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = selisihDiskon;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = Abs(selisihDiskon);
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionVerificationJournal(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, IEnumerable<CostCalculationHistory> hist, string prefix, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                decimal totalIncome = 0;
                decimal totalDisc = 0;
                decimal totalIncomeHist = 0;
                decimal totalDiscHist = 0;
                decimal selisihTotalIncome = 0;
                decimal selisihtotalDisc = 0;

                foreach (var c in cost)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDisc += (c.DiscountAmount.Value);
                    }
                }

                foreach (var c in hist)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        totalIncomeHist += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDiscHist += (c.DiscountAmount.Value);
                    }
                }

                selisihTotalIncome = totalIncome - totalIncomeHist;
                selisihtotalDisc = totalDisc - totalDiscHist;

                if (selisihtotalDisc == 0 && selisihTotalIncome == 0)
                    return -1;
                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.Prescription;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.PrescriptionDate;
                entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3}. REC:{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, hist.Select(p => p.RecalculationProcessNo).Take(1).SingleOrDefault());
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.PrescriptionNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                if (true)
                {


                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    if (selisihTotalIncome > 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = selisihTotalIncome;
                        d.Credit = 0;
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                        d.DocumentNumber = tc.PrescriptionNo;
                        d.Save();

                        totalDebit += d.Debit.Value;
                    }
                    else if (selisihTotalIncome < 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = 0;
                        d.Credit = selisihTotalIncome;
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                        d.DocumentNumber = tc.PrescriptionNo;
                        d.Save();

                        totalCredit += d.Credit.Value;
                    }

                }


                foreach (var c in cost)
                {
                    decimal selisihIncome = 0;
                    decimal selisihDiskon = 0;

                    var p = hist.Where(h => h.TransactionNo == c.TransactionNo && h.SequenceNo == c.SequenceNo).SingleOrDefault();
                    if (p != null)
                    {
                        selisihIncome = c.PatientAmount.Value + c.GuarantorAmount.Value + c.DiscountAmount.Value - p.PatientAmount.Value - p.GuarantorAmount.Value - p.DiscountAmount.Value;
                        selisihDiskon = c.DiscountAmount.Value - p.DiscountAmount.Value;
                    }


                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        if (selisihIncome > 0)
                                        {
                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = 0;
                                            itemMedicIncome.Credit = selisihIncome;
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalCredit += itemMedicIncome.Credit.Value;
                                        }
                                        else if (selisihIncome < 0)
                                        {
                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = Abs(selisihIncome);
                                            itemMedicIncome.Credit = 0;
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;
                                        }

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                        if (ci.Query.Load())
                                        {
                                            // COGS tidak ada karena cost price tidak mungkin berbeda & di verification tidak mungkin ubah quantity

                                            //discount DEBIT
                                            if (selisihDiskon > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = selisihDiskon;
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                            else if (selisihDiskon < 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = Abs(selisihDiskon);
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnVerificationJournal(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, IEnumerable<CostCalculationHistory> hist, string prefix, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                decimal totalIncome = 0;
                decimal totalDisc = 0;
                decimal totalIncomeHist = 0;
                decimal totalDiscHist = 0;
                decimal selisihTotalIncome = 0;
                decimal selisihtotalDisc = 0;

                foreach (var c in cost)
                {
                    totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    totalDisc += -1 * (c.DiscountAmount.Value);
                }

                foreach (var c in hist)
                {
                    totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    totalDisc += -1 * (c.DiscountAmount.Value);
                }

                selisihTotalIncome = totalIncome - totalIncomeHist;
                selisihtotalDisc = totalDisc - totalDiscHist;

                if (selisihTotalIncome == 0 && selisihtotalDisc == 0)
                    return -1;
                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.PrescriptionDate;
                entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}. REC:{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, unit.ServiceUnitName, hist.Select(p => p.RecalculationProcessNo).Take(1).SingleOrDefault());
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.PrescriptionNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                if (true)
                {


                    if (selisihTotalIncome > 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = 0;
                        d.Credit = selisihTotalIncome;
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                        d.DocumentNumber = tc.PrescriptionNo;
                        d.Save();

                        totalCredit += d.Credit.Value;
                    }
                    else if (selisihTotalIncome < 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = Abs(selisihTotalIncome);
                        d.Credit = 0;
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                        d.DocumentNumber = tc.PrescriptionNo;
                        d.Save();

                        totalDebit += d.Debit.Value;
                    }

                }

                foreach (var c in cost)
                {
                    decimal selisihIncome = 0;
                    decimal selisihDiskon = 0;

                    var p = hist.Where(h => h.TransactionNo == c.TransactionNo && h.SequenceNo == c.SequenceNo).SingleOrDefault();
                    if (p != null)
                    {
                        selisihIncome = Abs(c.PatientAmount.Value) + Abs(c.GuarantorAmount.Value) + Abs(c.DiscountAmount.Value) - Abs(p.PatientAmount.Value) - Abs(p.GuarantorAmount.Value) - Abs(p.DiscountAmount.Value);
                        selisihDiskon = Abs(c.DiscountAmount.Value) - Abs(p.DiscountAmount.Value);
                    }

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        if (selisihIncome > 0)
                                        {
                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = selisihIncome;
                                            itemMedicIncome.Credit = 0;
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;
                                        }
                                        else if (selisihIncome < 0)
                                        {
                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = 0;
                                            itemMedicIncome.Credit = Abs(selisihIncome);
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalCredit += itemMedicIncome.Credit.Value;
                                        }

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                        if (ci.Query.Load())
                                        {
                                            // COGS tidak perlu

                                            if (selisihDiskon > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = selisihDiskon;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                            else if (selisihDiskon < 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = Abs(selisihDiskon);
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewIncomeVerificationJournal(TransCharges tc, IEnumerable<TransChargesItemComp> tcic, IEnumerable<TransChargesItemCompHistory> compHist, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, IEnumerable<CostCalculationHistory> hist, string prefix, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewIncomeJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(guar.GuarantorID);

                decimal totalIncome = 0;
                decimal totalDisc = 0;
                decimal totalIncomeHist = 0;
                decimal totalDiscHist = 0;
                decimal selisihTotalIncome = 0;
                decimal selisihtotalDisc = 0;

                foreach (var c in cost)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDisc += (c.DiscountAmount.Value);
                    }
                }

                foreach (var c in hist)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {
                        totalIncomeHist += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDiscHist += (c.DiscountAmount.Value);
                    }
                }

                selisihTotalIncome = totalIncome - totalIncomeHist;
                selisihtotalDisc = totalDisc - totalDiscHist;

                if (selisihTotalIncome == 0 && selisihtotalDisc == 0)
                    return -1;
                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.Income;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.TransactionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.TransactionDate;
                entity.Description = string.Format("TRANS REG#:{0}. PAT#:{1}. UNIT:{2}-{3} . REC:{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName, hist.Select(p => p.RecalculationProcessNo).Take(1).SingleOrDefault());
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.TransactionNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                bool isInpatient = reg.SRRegistrationType.ToLowerInvariant().Equals("ipr");



                //DEBIT:
                if (true)
                {
                    if (selisihTotalIncome > 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = selisihTotalIncome;
                        d.Credit = 0;
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                        d.DocumentNumber = tc.TransactionNo;
                        d.Save();

                        totalDebit += d.Debit.Value;
                    }
                    else if (selisihTotalIncome < 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                        d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                        d.Debit = 0;
                        d.Credit = Abs(selisihTotalIncome);
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                        d.DocumentNumber = tc.TransactionNo;
                        d.Save();

                        totalCredit += d.Credit.Value;
                    }

                }

                //CREDIT
                foreach (var c in cost)
                {
                    if (string.IsNullOrEmpty(c.ParentNo))
                    {

                        // Service Unit Item first
                        ServiceUnitItemService itemService = new ServiceUnitItemService();
                        itemService.Query.Where(itemService.Query.ServiceUnitID == unit.ServiceUnitID, itemService.Query.ItemID == c.ItemID);
                        if (itemService.Query.Load())
                        {

                            TransChargesItem ci = new TransChargesItem();
                            ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                            if (ci.Query.Load())
                            {
                                foreach (var q in tcic)
                                {
                                    decimal discTemp = 0;
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                        discTemp = q.DiscountAmount.Value;

                                    if (q.TransactionNo == c.TransactionNo && q.SequenceNo == c.SequenceNo)
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;
                                        int? coaDiscId = 0;
                                        int? subLedgerDiscId = 0;
                                        decimal selisihIncome = 0;
                                        decimal selisihDiskon = 0;

                                        var p = compHist.Where(h => h.TransactionNo == q.TransactionNo && h.SequenceNo == q.SequenceNo && h.TariffComponentID == q.TariffComponentID).SingleOrDefault();
                                        if (p != null)
                                        {
                                            decimal discTempP = 0;
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                                discTempP = p.DiscountAmount.Value;

                                            selisihIncome = ((q.Price.Value - discTemp) * ci.ChargeQuantity.Value) - ((p.Price.Value - discTempP) * ci.ChargeQuantity.Value);
                                            selisihDiskon = (q.DiscountAmount.Value * ci.ChargeQuantity.Value) - (p.DiscountAmount.Value * ci.ChargeQuantity.Value);
                                        }

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == unit.ServiceUnitID,
                                                             itemComp.Query.ItemID == c.ItemID,
                                                             itemComp.Query.TariffComponentID == q.TariffComponentID,
                                                             itemComp.Query.SRRegistrationType == regType,
                                                             itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                            }

                                            if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                            {
                                                coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                                subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                            }

                                        }
                                        if (isInpatient && AppParameter.GetParameterValue(AppParameter.ParameterItem.CoaUsingClass) == "1")
                                        {

                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == unit.ServiceUnitID, itemClass.Query.ItemID == c.ItemID,
                                                itemClass.Query.ClassID == tc.ClassID, itemClass.Query.TariffComponentID == q.TariffComponentID);
                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                                }


                                                if (itemClass.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount.Value > 0)
                                                {
                                                    if (itemClass.ChartOfAccountIdDiscount.HasValue && itemClass.ChartOfAccountIdDiscount > 0)
                                                    {
                                                        coaDiscId = itemClass.ChartOfAccountIdDiscount.Value;
                                                        subLedgerDiscId = itemClass.SubledgerIdDiscount.HasValue ? itemClass.SubledgerIdDiscount : 0;
                                                    }

                                                }
                                            }

                                        }

                                        //// if we cant find it use the ones in Service Unit
                                        //if (!coaId.HasValue || coaId == 0)
                                        //{
                                        //    coaId = unit.ChartOfAccountIdIncome;
                                        //    subLedgerId = unit.SubledgerIdIncome.HasValue ? unit.SubledgerIdIncome : 0;
                                        //}

                                        // we need Item Name in ledger report
                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == c.ItemID);
                                        item.Query.Load();

                                        //Logger.LogMessage(string.Format("Creating Income Journal for ServiceUnitItemService:{0}. (C)", c.ItemID));
                                        if (selisihIncome > 0)
                                        {
                                            JournalTransactionDetails d = new JournalTransactionDetails();
                                            d.AddNew();
                                            d.JournalId = entity.JournalId;
                                            d.ChartOfAccountId = coaId;
                                            d.SubLedgerId = subLedgerId;
                                            d.Debit = 0;
                                            // d.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                            d.Credit = selisihIncome;
                                            d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                            d.DocumentNumber = tc.TransactionNo;
                                            d.Save();

                                            totalCredit += d.Credit.Value;
                                        }
                                        else if (selisihIncome < 0)
                                        {
                                            JournalTransactionDetails d = new JournalTransactionDetails();
                                            d.AddNew();
                                            d.JournalId = entity.JournalId;
                                            d.ChartOfAccountId = coaId;
                                            d.SubLedgerId = subLedgerId;
                                            d.Debit = Abs(selisihIncome);
                                            // d.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                            d.Credit = 0;
                                            d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                            d.DocumentNumber = tc.TransactionNo;
                                            d.Save();

                                            totalDebit += d.Debit.Value;
                                        }

                                        if (selisihDiskon > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = selisihDiskon;
                                            disc.Credit = 0;
                                            disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalDebit += disc.Debit.Value;
                                        }
                                        else if (selisihDiskon < 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = new JournalTransactionDetails();
                                            disc.AddNew();
                                            disc.JournalId = entity.JournalId;
                                            disc.ChartOfAccountId = coaDiscId;
                                            disc.SubLedgerId = subLedgerDiscId;
                                            disc.Debit = 0;
                                            disc.Credit = Abs(selisihDiskon);
                                            disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, item.ItemName);
                                            disc.DocumentNumber = tc.TransactionNo;
                                            disc.Save();

                                            totalCredit += disc.Credit.Value;
                                        }
                                    }
                                }
                            }
                        }
                        // item medic & non medic
                        else
                        {
                            decimal selisihIncome = 0;
                            decimal selisihDiskon = 0;

                            var p = hist.Where(h => h.TransactionNo == c.TransactionNo && h.SequenceNo == c.SequenceNo).SingleOrDefault();
                            if (p != null)
                            {
                                selisihIncome = c.PatientAmount.Value + c.GuarantorAmount.Value + c.DiscountAmount.Value - p.PatientAmount.Value - p.GuarantorAmount.Value - p.DiscountAmount.Value;
                                selisihDiskon = c.DiscountAmount.Value - p.DiscountAmount.Value;
                            }


                            // ItemProductMedic
                            Item itemInv = new Item();
                            itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                            if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                            {
                                var proacc = new ProductAccountGuarantorGroup();
                                proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                    proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                if (proacc.Load(proacc.Query))
                                {
                                    var TypeReg = reg.SRRegistrationType;
                                    int coaIdIncome = 0;
                                    int subledgerIdIncome = 0;
                                    int coaIdCOGS = 0;
                                    int subledgerIdCOGS = 0;
                                    int coaIdInventory = 0;
                                    int subledgerIdInventory = 0;
                                    int coaIdDiscount = 0;
                                    int subledgerIdDiscount = 0;

                                    switch (TypeReg)
                                    {
                                        case "OPR":
                                            coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                            subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                            break;

                                        case "IPR":
                                            coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                            subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                            break;
                                        case "EMR":
                                            coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                            subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                            coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                            subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                            coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                            subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                            coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                            subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                            break;
                                    }

                                    if (itemInv.SRItemType == "11")
                                    {
                                        //Medic
                                        ItemProductMedic itemMedic = new ItemProductMedic();
                                        itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                        if (itemMedic.Query.Load())
                                        {
                                            if (selisihIncome > 0)
                                            {

                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                                itemMedicIncome.AddNew();
                                                itemMedicIncome.JournalId = entity.JournalId;
                                                itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemMedicIncome.Debit = 0;
                                                itemMedicIncome.Credit = selisihIncome;
                                                itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemMedicIncome.Save();

                                                totalCredit += itemMedicIncome.Credit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // COGS tidak ada karena tidak mungkin cost price berbeda

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = selisihDiskon;
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = Abs(selisihDiskon);
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                }
                                            }
                                            else if (selisihIncome < 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                                itemMedicIncome.AddNew();
                                                itemMedicIncome.JournalId = entity.JournalId;
                                                itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemMedicIncome.Debit = Abs(selisihIncome);
                                                itemMedicIncome.Credit = 0;
                                                itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                itemMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemMedicIncome.Save();

                                                totalDebit += itemMedicIncome.Debit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // COGS tidak ada karena tidak mungkin cost price berbeda

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = selisihDiskon;
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = Abs(selisihDiskon);
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //Non Medic
                                        ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                        itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == c.ItemID);
                                        if (itemNonMedic.Query.Load())
                                        {
                                            if (selisihIncome > 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                                itemNonMedicIncome.AddNew();
                                                itemNonMedicIncome.JournalId = entity.JournalId;
                                                itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemNonMedicIncome.Debit = 0;
                                                itemNonMedicIncome.Credit = selisihIncome;
                                                itemNonMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemNonMedicIncome.Save();

                                                totalCredit += itemNonMedicIncome.Credit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // COGS //cogs dihilangkan karena tidak mungkin cost price berbeda                                             

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = selisihDiskon;
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = Abs(selisihDiskon);
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                }
                                            }
                                            else if (selisihIncome < 0)
                                            {
                                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                                itemNonMedicIncome.AddNew();
                                                itemNonMedicIncome.JournalId = entity.JournalId;
                                                itemNonMedicIncome.ChartOfAccountId = coaIdIncome;
                                                itemNonMedicIncome.SubLedgerId = subledgerIdIncome;
                                                itemNonMedicIncome.Debit = selisihIncome;
                                                itemNonMedicIncome.Credit = 0;
                                                itemNonMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                itemNonMedicIncome.DocumentNumber = tc.TransactionNo;
                                                itemNonMedicIncome.Save();

                                                totalDebit += itemNonMedicIncome.Debit.Value;

                                                TransChargesItem ci = new TransChargesItem();
                                                ci.Query.Where(ci.Query.TransactionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);
                                                if (ci.Query.Load())
                                                {
                                                    // COGS //cogs dihilangkan karena tidak mungkin cost price berbeda                                             

                                                    if (selisihDiskon > 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = selisihDiskon;
                                                        disc.Credit = 0;
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalDebit += disc.Debit.Value;
                                                    }
                                                    else if (selisihDiskon < 0)
                                                    {
                                                        JournalTransactionDetails disc = new JournalTransactionDetails();
                                                        disc.AddNew();
                                                        disc.JournalId = entity.JournalId;
                                                        disc.ChartOfAccountId = coaIdDiscount;
                                                        disc.SubLedgerId = subledgerIdDiscount;
                                                        disc.Debit = 0;
                                                        disc.Credit = Abs(selisihDiskon);
                                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        disc.DocumentNumber = tc.TransactionNo;
                                                        disc.Save();

                                                        totalCredit += disc.Credit.Value;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionJournal(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Prescription;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDisc += (c.DiscountAmount.Value);
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                foreach (var c in cost)
                {
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {
                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        itemMedicIncome.Debit = 0;
                                        itemMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        if (ci.Query.Load())
                                        {
                                            if (!(ci.IsPendingDelivery ?? false))
                                            {
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                     mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                    mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                      mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        // COGS

                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));


                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = cogs;
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicCogs.Save();

                                                        totalDebit += itemMedicCogs.Debit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = cogs;
                                                        itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicInv.Save();

                                                        totalCredit += itemMedicInv.Credit.Value;
                                                    }
                                                }
                                            }


                                            //discount DEBIT
                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = ci.DiscountAmount.Value;
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionJournalTemporaryNetto(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Prescription;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                if (true)
                {
                    decimal totalIncome = 0;
                    //decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        //totalDisc += (c.DiscountAmount.Value);
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                        subledgerIdIncome = proacc.SubledgerIdAcrual.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdAcrualIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdAcrualIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdAcrualIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdAcrualIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    if (string.IsNullOrEmpty(locationId))
                                    {
                                        var tp = new TransPrescription();
                                        tp.LoadByPrimaryKey(c.TransactionNo);
                                        locationId = tp.LocationID;

                                        if (string.IsNullOrEmpty(locationId))
                                        {
                                            var sul = new ServiceUnitLocation();
                                            sul.Query.es.Top = 1;
                                            sul.Query.Where(sul.Query.ServiceUnitID == unit.ServiceUnitID, sul.Query.IsLocationMain == true);
                                            sul.Query.Load();
                                            locationId = sul.LocationID;
                                        }
                                    }
                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));
                                        ci.Query.Load();

                                        //JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        //itemMedicIncome.AddNew();
                                        //itemMedicIncome.JournalId = entity.JournalId;
                                        //itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                                        //itemMedicIncome.SubLedgerId = unit.SubledgerIdAcrual ?? 0;
                                        ////itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        //itemMedicIncome.Debit = 0;
                                        ////itemMedicIncome.Debit = Math.Abs(ci.ResultQty ?? 0) * ci.Price;
                                        //itemMedicIncome.Credit = Math.Abs(c.PatientAmount ?? 0) + Math.Abs(c.GuarantorAmount ?? 0) + Math.Abs(c.DiscountAmount ?? 0);
                                        //itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        //itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        //itemMedicIncome.Save();

                                        //totalCredit += itemMedicIncome.Credit.Value;

                                        AppParameter IsPpnSalesRJ = new AppParameter();
                                        if (!IsPpnSalesRJ.LoadByPrimaryKey("acc_IsPpnSalesRJ"))
                                            throw new Exception("App Parameter: acc_IsPpnSalesRJ: Parameter not found!!");
                                        AppParameter IsPpnSalesRI = new AppParameter();
                                        if (!IsPpnSalesRI.LoadByPrimaryKey("acc_IsPpnSalesRI"))
                                            throw new Exception("App Parameter: acc_IsPpnSalesRI: Parameter not found!!");

                                        var paramPpnPctg = new AppParameter();
                                        if (!paramPpnPctg.LoadByPrimaryKey("Ppn"))
                                        {
                                            throw new Exception("Appparameter Ppn is undefined");
                                        }
                                        decimal ppnVal = System.Convert.ToDecimal(paramPpnPctg.ParameterValue);

                                        var paramCoaPPN = new AppParameter();

                                        var ccVal = c.PatientAmount + c.GuarantorAmount + Math.Abs(c.DiscountAmount ?? 0);
                                        decimal ccValPPN = 0;
                                        if (reg.SRRegistrationType.Equals("IPR"))
                                        {
                                            paramCoaPPN.LoadByPrimaryKey("coa_PpnSalesRI");

                                            if (IsPpnSalesRI.ParameterValue.Equals("Yes"))
                                                ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                        }
                                        else
                                        {
                                            paramCoaPPN.LoadByPrimaryKey("coa_PpnSalesRJ");

                                            if (IsPpnSalesRJ.ParameterValue.Equals("Yes"))
                                                ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                        }
                                        ccVal = ccVal - ccValPPN;

                                        var coaPPN = new ChartOfAccounts();
                                        coaPPN.Query.Where(coaPPN.Query.ChartOfAccountCode == paramCoaPPN.ParameterValue);
                                        coaPPN.Query.Load();

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        itemMedicIncome.Debit = 0;
                                        itemMedicIncome.Credit = ccVal;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                        itemMedicIncome.DocumentNumber = c.TransactionNo;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        if (ccValPPN != 0)
                                        {
                                            JournalTransactionDetails ppnSales = new JournalTransactionDetails();
                                            ppnSales.JournalId = entity.JournalId;
                                            ppnSales.ChartOfAccountId = coaPPN.ChartOfAccountId;
                                            ppnSales.SubLedgerId = unit.SubledgerIdAcrual ?? 0;
                                            ppnSales.Debit = 0;
                                            ppnSales.Credit = ccValPPN;
                                            ppnSales.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}{5}", tc.RegistrationNo,
                                                pEnity.PatientName, c.ItemID, itemInv.ItemName, "", " Sales tax");
                                            ppnSales.DocumentNumber = c.TransactionNo;
                                            ppnSales.Save();

                                            totalCredit += ppnSales.Credit.Value;
                                        }


                                        //if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    if (coaIdCOGS != 0)// && subledgerIdCOGS != 0)
                                                    {
                                                        JournalTransactionDetails itemMedicCogs =
                                                            new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = Math.Abs(cogs ?? 0);
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description =
                                                            string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                          pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicCogs.Save();

                                                        totalDebit += itemMedicCogs.Debit.Value;
                                                    }

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                                    if (coaIdInventory != 0 && subledgerIdInventory != 0)
                                                    {

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = Math.Abs(cogs ?? 0);
                                                        itemMedicInv.Description =
                                                            string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                          pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicInv.Save();

                                                        totalCredit += itemMedicInv.Credit.Value;
                                                    }
                                                }
                                            }


                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = Math.Abs(ci.DiscountAmount.Value);
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionJournalTemporaryNettoTransfer(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId, string refId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Prescription;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                if (true)
                {
                    decimal totalIncome = 0;
                    //decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        //totalDisc += (c.DiscountAmount.Value);
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.DocumentNumberSequenceNo = refId;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                foreach (var c in cost)
                {
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {
                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    if (string.IsNullOrEmpty(locationId))
                                    {
                                        var tp = new TransPrescription();
                                        tp.LoadByPrimaryKey(c.TransactionNo);
                                        locationId = tp.LocationID;

                                        if (string.IsNullOrEmpty(locationId))
                                        {
                                            var sul = new ServiceUnitLocation();
                                            sul.Query.es.Top = 1;
                                            sul.Query.Where(sul.Query.ServiceUnitID == unit.ServiceUnitID, sul.Query.IsLocationMain == true);
                                            sul.Query.Load();
                                            locationId = sul.LocationID;
                                        }
                                    }

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));
                                        ci.Query.Load();

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        itemMedicIncome.Debit = 0;

                                        itemMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount;
                                        //itemMedicIncome.Credit = ci.ResultQty * ci.Price;

                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.DocumentNumberSequenceNo = refId;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        //if (ci.Query.Load())
                                        {
                                            if (!(ci.IsPendingDelivery ?? false))
                                            {
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                     mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                    mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                      mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        // COGS

                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));


                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = cogs;
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                        itemMedicCogs.Save();

                                                        totalDebit += itemMedicCogs.Debit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = cogs;
                                                        itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicInv.DocumentNumberSequenceNo = refId;
                                                        itemMedicInv.Save();

                                                        totalCredit += itemMedicInv.Credit.Value;
                                                    }
                                                }
                                            }


                                            //discount DEBIT
                                            //if ((ci.DiscountAmount ?? 0) > 0)
                                            //{
                                            //    JournalTransactionDetails disc = new JournalTransactionDetails();
                                            //    disc.AddNew();
                                            //    disc.JournalId = entity.JournalId;
                                            //    disc.ChartOfAccountId = coaIdDiscount;
                                            //    disc.SubLedgerId = subledgerIdDiscount;
                                            //    disc.Debit = ci.DiscountAmount.Value;
                                            //    disc.Credit = 0;
                                            //    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            //    disc.DocumentNumber = tc.PrescriptionNo;
                                            //    disc.Save();

                                            //    totalDebit += disc.Debit.Value;
                                            //}
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionJournalTemporary(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Prescription;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDisc += (c.DiscountAmount.Value);
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                foreach (var c in cost)
                {
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {
                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    if (string.IsNullOrEmpty(locationId))
                                    {
                                        var tp = new TransPrescription();
                                        tp.LoadByPrimaryKey(c.TransactionNo);
                                        locationId = tp.LocationID;

                                        if (string.IsNullOrEmpty(locationId))
                                        {
                                            var sul = new ServiceUnitLocation();
                                            sul.Query.es.Top = 1;
                                            sul.Query.Where(sul.Query.ServiceUnitID == unit.ServiceUnitID, sul.Query.IsLocationMain == true);
                                            sul.Query.Load();
                                            locationId = sul.LocationID;
                                        }
                                    }

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));
                                        ci.Query.Load();

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        itemMedicIncome.Debit = 0;

                                        itemMedicIncome.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;
                                        //itemMedicIncome.Credit = ci.ResultQty * ci.Price;

                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.Save();

                                        totalCredit += itemMedicIncome.Credit.Value;

                                        //if (ci.Query.Load())
                                        {
                                            if (!(ci.IsPendingDelivery ?? false))
                                            {
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                                {
                                                    ItemMovementQuery mov = new ItemMovementQuery();
                                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                     mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                    mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                      mov.CostPrice);
                                                    DataTable tbl = mov.LoadDataTable();

                                                    foreach (DataRow row in tbl.Rows)
                                                    {
                                                        // COGS

                                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));


                                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = cogs;
                                                        itemMedicCogs.Credit = 0;
                                                        itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicCogs.Save();

                                                        totalDebit += itemMedicCogs.Debit.Value;

                                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = 0;
                                                        itemMedicInv.Credit = cogs;
                                                        itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicInv.Save();

                                                        totalCredit += itemMedicInv.Credit.Value;
                                                    }
                                                }
                                            }


                                            //discount DEBIT
                                            if ((ci.DiscountAmount ?? 0) > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = ci.DiscountAmount.Value;
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionJournal(TransPrescription tc, Registration reg, ServiceUnit unit, TransPrescriptionItem tci, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.Prescription;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                //if (true)
                //{
                //    decimal totalIncome = 0;
                //    decimal totalDisc = 0;

                //    foreach (var c in cost)
                //    {
                //        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                //        totalDisc += (c.DiscountAmount.Value);
                //    }

                //    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                //    JournalTransactionDetails d = new JournalTransactionDetails();
                //    d.AddNew();
                //    d.JournalId = entity.JournalId;
                //    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                //    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                //    d.Debit = totalIncome;
                //    d.Credit = 0;
                //    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                //    d.DocumentNumber = tc.PrescriptionNo;
                //    d.Save();

                //    totalDebit += d.Debit.Value;
                //}

                //foreach (var c in cost)
                {
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == tci.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {
                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == tci.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        //JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        //itemMedicIncome.AddNew();
                                        //itemMedicIncome.JournalId = entity.JournalId;
                                        //itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        //itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        //itemMedicIncome.Debit = 0;
                                        //itemMedicIncome.Credit = tci.LineAmount;
                                        //itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, tci.ItemID, itemInv.ItemName);
                                        //itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        //itemMedicIncome.Save();

                                        //totalCredit += itemMedicIncome.Credit.Value;

                                        //TransPrescriptionItem ci = new TransPrescriptionItem();
                                        //ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        //if (ci.Query.Load())
                                        {

                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                 mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                mov.Where(mov.TransactionNo == tci.PrescriptionNo, mov.SequenceNo == tci.SequenceNo, mov.ItemID == tci.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                  mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    // COGS

                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));


                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = cogs;
                                                    itemMedicCogs.Credit = 0;
                                                    itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, tci.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalDebit += itemMedicCogs.Debit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = 0;
                                                    itemMedicInv.Credit = cogs;
                                                    itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, tci.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalCredit += itemMedicInv.Credit.Value;
                                                }
                                            }


                                            //discount DEBIT
                                            //if (tci.DiscountAmount.Value > 0)
                                            //{
                                            //    JournalTransactionDetails disc = new JournalTransactionDetails();
                                            //    disc.AddNew();
                                            //    disc.JournalId = entity.JournalId;
                                            //    disc.ChartOfAccountId = coaIdDiscount;
                                            //    disc.SubLedgerId = subledgerIdDiscount;
                                            //    disc.Debit = tci.DiscountAmount.Value;
                                            //    disc.Credit = 0;
                                            //    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, tci.ItemID, itemInv.ItemName);
                                            //    disc.DocumentNumber = tc.PrescriptionNo;
                                            //    disc.Save();

                                            //    totalDebit += disc.Debit.Value;
                                            //}
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionJournalWithSeparationPersonalizedRecipeMoney(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.Prescription;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.PrescriptionDate;
                entity.Description = string.Format("PRESC REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.PrescriptionNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                int coaRacikan = GetCachedAccountFromParam("COAPendapatanUangRacikan");

                if (true)
                {
                    decimal totalIncome = 0;
                    decimal totalDisc = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalDisc += (c.DiscountAmount.Value);
                    }

                    //Logger.LogMessage(string.Format("Creating Acrual Journal for ServiceUnit:{0} (D).", unit.ServiceUnitID));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = totalIncome;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;

                }


                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {


                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;


                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));



                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        if (ci.Query.Load())
                                        {

                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                 mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                                  mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    // COGS

                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));


                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = cogs;
                                                    itemMedicCogs.Credit = 0;
                                                    itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalDebit += itemMedicCogs.Debit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = 0;
                                                    itemMedicInv.Credit = cogs;
                                                    itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalCredit += itemMedicInv.Credit.Value;
                                                }
                                            }

                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = 0;
                                            itemMedicIncome.Credit = (ci.ResultQty * ci.Price);
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalCredit += itemMedicIncome.Credit.Value;

                                            JournalTransactionDetails PendapatanUangRacikan = new JournalTransactionDetails();
                                            PendapatanUangRacikan.AddNew();
                                            PendapatanUangRacikan.JournalId = entity.JournalId;
                                            PendapatanUangRacikan.ChartOfAccountId = coaRacikan;
                                            PendapatanUangRacikan.SubLedgerId = subledgerIdIncome; /* subledger masih pakai dari income */
                                            PendapatanUangRacikan.Debit = 0;
                                            PendapatanUangRacikan.Credit = ci.EmbalaceAmount + ci.RecipeAmount;
                                            PendapatanUangRacikan.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            PendapatanUangRacikan.DocumentNumber = tc.PrescriptionNo;
                                            PendapatanUangRacikan.Save();

                                            totalCredit += PendapatanUangRacikan.Credit.Value;

                                            //discount DEBIT
                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = ci.DiscountAmount.Value;
                                                disc.Credit = 0;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalDebit += disc.Debit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewIncomeJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournal(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.Save();

                                        totalDebit += itemMedicIncome.Debit.Value;

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));



                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }


                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = ci.DiscountAmount.Value;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalTemporaryNetto(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = Math.Abs(totalIncome);
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdAcrual.Value;
                                        subledgerIdIncome = proacc.SubledgerIdAcrual.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdAcrualIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdAcrualIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdAcrualIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdAcrualIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    if (string.IsNullOrEmpty(locationId))
                                    {
                                        var tp = new TransPrescription();
                                        tp.LoadByPrimaryKey(c.TransactionNo);
                                        locationId = tp.LocationID;

                                        if (string.IsNullOrEmpty(locationId))
                                        {
                                            var sul = new ServiceUnitLocation();
                                            sul.Query.es.Top = 1;
                                            sul.Query.Where(sul.Query.ServiceUnitID == unit.ServiceUnitID, sul.Query.IsLocationMain == true);
                                            sul.Query.Load();
                                            locationId = sul.LocationID;
                                        }
                                    }
                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));
                                        ci.Query.Load();

                                        //JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        //itemMedicIncome.AddNew();
                                        //itemMedicIncome.JournalId = entity.JournalId;
                                        //itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                                        //itemMedicIncome.SubLedgerId = unit.SubledgerIdAcrual ?? 0;
                                        ////itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        //itemMedicIncome.Debit = Math.Abs(c.PatientAmount ?? 0) + Math.Abs(c.GuarantorAmount ?? 0) + Math.Abs(c.DiscountAmount ?? 0);
                                        ////itemMedicIncome.Debit = Math.Abs(ci.ResultQty ?? 0) * ci.Price;
                                        //itemMedicIncome.Credit = 0;
                                        //itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        //itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        //itemMedicIncome.Save();

                                        //totalDebit += itemMedicIncome.Debit.Value;

                                        AppParameter IsPpnSalesRJ = new AppParameter();
                                        if (!IsPpnSalesRJ.LoadByPrimaryKey("acc_IsPpnSalesRJ"))
                                            throw new Exception("App Parameter: acc_IsPpnSalesRJ: Parameter not found!!");
                                        AppParameter IsPpnSalesRI = new AppParameter();
                                        if (!IsPpnSalesRI.LoadByPrimaryKey("acc_IsPpnSalesRI"))
                                            throw new Exception("App Parameter: acc_IsPpnSalesRI: Parameter not found!!");

                                        var paramCoaPPN = new AppParameter();
                                        //paramCoaPPN.LoadByPrimaryKey("coa_Ppn"); //bukan ambil coa ppn pembaialan

                                        var paramPpnPctg = new AppParameter();
                                        if (!paramPpnPctg.LoadByPrimaryKey("Ppn"))
                                        {
                                            throw new Exception("Appparameter Ppn is undefined");
                                        }
                                        decimal ppnVal = System.Convert.ToDecimal(paramPpnPctg.ParameterValue);

                                        var ccVal = c.PatientAmount + c.GuarantorAmount + Math.Abs(c.DiscountAmount ?? 0);
                                        decimal ccValPPN = 0;
                                        if (reg.SRRegistrationType.Equals("IPR"))
                                        {
                                            paramCoaPPN.LoadByPrimaryKey("coa_PpnSalesRI");

                                            if (IsPpnSalesRI.ParameterValue.Equals("Yes"))
                                                ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                        }
                                        else
                                        {
                                            paramCoaPPN.LoadByPrimaryKey("coa_PpnSalesRJ");

                                            if (IsPpnSalesRJ.ParameterValue.Equals("Yes"))
                                                ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                        }
                                        ccVal = ccVal - ccValPPN;

                                        var coaPPN = new ChartOfAccounts();
                                        coaPPN.Query.Where(coaPPN.Query.ChartOfAccountCode == paramCoaPPN.ParameterValue);
                                        coaPPN.Query.Load();

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        itemMedicIncome.Debit = Math.Abs(ccVal ?? 0);
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName, "");
                                        itemMedicIncome.DocumentNumber = c.TransactionNo;
                                        itemMedicIncome.Save();

                                        totalDebit += itemMedicIncome.Debit.Value;

                                        if (ccValPPN != 0)
                                        {
                                            JournalTransactionDetails ppnSales = new JournalTransactionDetails();
                                            ppnSales.JournalId = entity.JournalId;
                                            ppnSales.ChartOfAccountId = coaPPN.ChartOfAccountId;
                                            ppnSales.SubLedgerId = unit.SubledgerIdAcrual ?? 0;
                                            ppnSales.Debit = Math.Abs(ccValPPN);
                                            ppnSales.Credit = 0;
                                            ppnSales.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}{5}", tc.RegistrationNo,
                                                pEnity.PatientName, c.ItemID, itemInv.ItemName, "", " Sales tax");
                                            ppnSales.DocumentNumber = c.TransactionNo;
                                            ppnSales.Save();

                                            totalDebit += ppnSales.Debit.Value;
                                        }


                                        //if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                                    if (coaIdCOGS != 0)// && subledgerIdCOGS != 0)
                                                    {
                                                        JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                        itemMedicCogs.AddNew();
                                                        itemMedicCogs.JournalId = entity.JournalId;
                                                        itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                        itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                        itemMedicCogs.Debit = 0;
                                                        itemMedicCogs.Credit = Math.Abs(cogs ?? 0);
                                                        itemMedicCogs.Description =
                                                            string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                          pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicCogs.Save();

                                                        totalCredit += itemMedicCogs.Credit.Value;
                                                    }

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                                    if (coaIdInventory != 0 && subledgerIdInventory != 0)
                                                    {
                                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                        itemMedicInv.AddNew();
                                                        itemMedicInv.JournalId = entity.JournalId;
                                                        itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                        itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                        itemMedicInv.Debit = Math.Abs(cogs ?? 0);
                                                        itemMedicInv.Credit = 0;
                                                        itemMedicInv.Description =
                                                            string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                          pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                        itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                        itemMedicInv.Save();

                                                        totalDebit += itemMedicInv.Debit.Value;
                                                    }
                                                }
                                            }


                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = Math.Abs(ci.DiscountAmount.Value);
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalTemporaryNettoTransfer(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId, string refId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = Math.Abs(totalIncome);
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.DocumentNumberSequenceNo = refId;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    if (string.IsNullOrEmpty(locationId))
                                    {
                                        var tp = new TransPrescription();
                                        tp.LoadByPrimaryKey(c.TransactionNo);
                                        locationId = tp.LocationID;

                                        if (string.IsNullOrEmpty(locationId))
                                        {
                                            var sul = new ServiceUnitLocation();
                                            sul.Query.es.Top = 1;
                                            sul.Query.Where(sul.Query.ServiceUnitID == unit.ServiceUnitID, sul.Query.IsLocationMain == true);
                                            sul.Query.Load();
                                            locationId = sul.LocationID;
                                        }
                                    }
                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));
                                        ci.Query.Load();

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        //itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Debit = Math.Abs(c.PatientAmount ?? 0) + Math.Abs(c.GuarantorAmount ?? 0);// +Math.Abs(c.DiscountAmount ?? 0);
                                        //itemMedicIncome.Debit = Math.Abs(ci.ResultQty ?? 0) * ci.Price;
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.DocumentNumberSequenceNo = refId;
                                        itemMedicIncome.Save();

                                        totalDebit += itemMedicIncome.Debit.Value;




                                        //if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = Math.Abs(cogs ?? 0);
                                                    itemMedicCogs.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = Math.Abs(cogs ?? 0);
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.DocumentNumberSequenceNo = refId;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }


                                            //if (ci.DiscountAmount.Value > 0)
                                            //{
                                            //    JournalTransactionDetails disc = new JournalTransactionDetails();
                                            //    disc.AddNew();
                                            //    disc.JournalId = entity.JournalId;
                                            //    disc.ChartOfAccountId = coaIdDiscount;
                                            //    disc.SubLedgerId = subledgerIdDiscount;
                                            //    disc.Debit = 0;
                                            //    disc.Credit = Math.Abs(ci.DiscountAmount.Value);
                                            //    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            //    disc.DocumentNumber = tc.PrescriptionNo;
                                            //    disc.Save();

                                            //    totalCredit += disc.Credit.Value;
                                            //}
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalTemporary(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = Math.Abs(totalIncome);
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSOPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSOPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIPTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIPTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGDTemp.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGDTemp.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    if (string.IsNullOrEmpty(locationId))
                                    {
                                        var tp = new TransPrescription();
                                        tp.LoadByPrimaryKey(c.TransactionNo);
                                        locationId = tp.LocationID;

                                        if (string.IsNullOrEmpty(locationId))
                                        {
                                            var sul = new ServiceUnitLocation();
                                            sul.Query.es.Top = 1;
                                            sul.Query.Where(sul.Query.ServiceUnitID == unit.ServiceUnitID, sul.Query.IsLocationMain == true);
                                            sul.Query.Load();
                                            locationId = sul.LocationID;
                                        }
                                    }
                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo,
                                            ci.Query.Or(ci.Query.ItemID == c.ItemID, ci.Query.ItemInterventionID == c.ItemID));
                                        ci.Query.Load();

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                                        itemMedicIncome.SubLedgerId = unit.SubledgerIdIncome ?? 0;
                                        //itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Debit = Math.Abs(c.PatientAmount ?? 0) + Math.Abs(c.GuarantorAmount ?? 0) + Math.Abs(c.DiscountAmount ?? 0);
                                        //itemMedicIncome.Debit = Math.Abs(ci.ResultQty ?? 0) * ci.Price;
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.Save();

                                        totalDebit += itemMedicIncome.Debit.Value;




                                        //if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = Math.Abs(cogs ?? 0);
                                                    itemMedicCogs.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = Math.Abs(cogs ?? 0);
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }


                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = Math.Abs(ci.DiscountAmount.Value);
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournal(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        //itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Debit = (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.Save();

                                        totalDebit += itemMedicIncome.Debit.Value;

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }


                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = ci.DiscountAmount.Value;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalTransfer(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId, string refId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.DocumentNumberSequenceNo = refId;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        itemMedicIncome.AddNew();
                                        itemMedicIncome.JournalId = entity.JournalId;
                                        itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        //itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Debit = (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        itemMedicIncome.Credit = 0;
                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        itemMedicIncome.DocumentNumberSequenceNo = refId;
                                        itemMedicIncome.Save();

                                        totalDebit += itemMedicIncome.Debit.Value;

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);



                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO

                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo,
                                                          mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs =
                                                        new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description =
                                                        string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo,
                                                                      pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }


                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = ci.DiscountAmount.Value;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.DocumentNumberSequenceNo = refId;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalWithSeparationPersonalizedRecipeMoney(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                int coaRacikan = GetCachedAccountFromParam("COAPendapatanUangRacikan");

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }


                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;


                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();


                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }

                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = (ci.ResultQty * ci.Price);
                                            itemMedicIncome.Credit = 0;
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;

                                            JournalTransactionDetails PendapatanUangRacikan = new JournalTransactionDetails();
                                            PendapatanUangRacikan.AddNew();
                                            PendapatanUangRacikan.JournalId = entity.JournalId;
                                            PendapatanUangRacikan.ChartOfAccountId = coaRacikan;
                                            PendapatanUangRacikan.SubLedgerId = subledgerIdIncome;  /* subledger masih pakai dari income */
                                            PendapatanUangRacikan.Debit = 0;
                                            PendapatanUangRacikan.Credit = ci.EmbalaceAmount + ci.RecipeAmount;
                                            PendapatanUangRacikan.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            PendapatanUangRacikan.DocumentNumber = tc.PrescriptionNo;
                                            PendapatanUangRacikan.Save();

                                            totalCredit += PendapatanUangRacikan.Credit.Value;

                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = ci.DiscountAmount.Value;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalWithSeparationPersonalizedRecipeMoney(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                int coaRacikan = GetCachedAccountFromParam("COAPendapatanUangRacikan");

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }


                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;


                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();


                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }

                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = (ci.ResultQty * ci.Price);
                                            itemMedicIncome.Credit = 0;
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;

                                            JournalTransactionDetails PendapatanUangRacikan = new JournalTransactionDetails();
                                            PendapatanUangRacikan.AddNew();
                                            PendapatanUangRacikan.JournalId = entity.JournalId;
                                            PendapatanUangRacikan.ChartOfAccountId = coaRacikan;
                                            PendapatanUangRacikan.SubLedgerId = subledgerIdIncome;  /* subledger masih pakai dari income */
                                            PendapatanUangRacikan.Debit = 0;
                                            PendapatanUangRacikan.Credit = ci.EmbalaceAmount + ci.RecipeAmount;
                                            PendapatanUangRacikan.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            PendapatanUangRacikan.DocumentNumber = tc.PrescriptionNo;
                                            PendapatanUangRacikan.Save();

                                            totalCredit += PendapatanUangRacikan.Credit.Value;

                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = ci.DiscountAmount.Value;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPrescriptionReturnJournalWithSeparationPersonalizedRecipeMoneyTransfer(TransPrescription tc, Registration reg, ServiceUnit unit, IEnumerable<CostCalculation> cost, string prefix, string editedBy, int journalId, string refId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tc.PrescriptionDate;
                    entity.Description = string.Format("PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tc.PrescriptionNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                int coaRacikan = GetCachedAccountFromParam("COAPendapatanUangRacikan");

                if (true)
                {
                    decimal totalIncome = 0;

                    foreach (var c in cost)
                    {
                        //totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                        totalIncome += (c.PatientAmount.Value + c.GuarantorAmount.Value);
                    }


                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d.Debit = 0;
                    d.Credit = totalIncome;
                    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d.DocumentNumber = tc.PrescriptionNo;
                    d.DocumentNumberSequenceNo = refId;
                    d.Save();

                    totalCredit += d.Credit.Value;

                }

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;


                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                // COGS diambil dari itemmovement agar bisa digunakan metode FIFO
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();


                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.DocumentNumberSequenceNo = refId;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.DocumentNumberSequenceNo = refId;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }

                                            JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                            itemMedicIncome.AddNew();
                                            itemMedicIncome.JournalId = entity.JournalId;
                                            itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                            itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                            itemMedicIncome.Debit = (ci.ResultQty * ci.Price);
                                            itemMedicIncome.Credit = 0;
                                            itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                            itemMedicIncome.DocumentNumberSequenceNo = refId;
                                            itemMedicIncome.Save();

                                            totalDebit += itemMedicIncome.Debit.Value;

                                            JournalTransactionDetails PendapatanUangRacikan = new JournalTransactionDetails();
                                            PendapatanUangRacikan.AddNew();
                                            PendapatanUangRacikan.JournalId = entity.JournalId;
                                            PendapatanUangRacikan.ChartOfAccountId = coaRacikan;
                                            PendapatanUangRacikan.SubLedgerId = subledgerIdIncome;  /* subledger masih pakai dari income */
                                            PendapatanUangRacikan.Debit = 0;
                                            PendapatanUangRacikan.Credit = ci.EmbalaceAmount + ci.RecipeAmount;
                                            PendapatanUangRacikan.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            PendapatanUangRacikan.DocumentNumber = tc.PrescriptionNo;
                                            PendapatanUangRacikan.DocumentNumberSequenceNo = refId;
                                            PendapatanUangRacikan.Save();

                                            totalCredit += PendapatanUangRacikan.Credit.Value;

                                            if (ci.DiscountAmount.Value > 0)
                                            {
                                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                                disc.AddNew();
                                                disc.JournalId = entity.JournalId;
                                                disc.ChartOfAccountId = coaIdDiscount;
                                                disc.SubLedgerId = subledgerIdDiscount;
                                                disc.Debit = 0;
                                                disc.Credit = ci.DiscountAmount.Value;
                                                disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} [PT]", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                disc.DocumentNumber = tc.PrescriptionNo;
                                                disc.DocumentNumberSequenceNo = refId;
                                                disc.Save();

                                                totalCredit += disc.Credit.Value;
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewDirectPrescriptionReturnJournal(TransPrescription tc, Registration reg, ServiceUnit unit, CostCalculationCollection cost, string prefix, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPrescriptionReturnJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tc.TransactionNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = BusinessObject.JournalType.PrescriptionReturn;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tc.PrescriptionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = tc.PrescriptionDate;
                entity.Description = string.Format("DIRECT PRESC RETURN REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = tc.PrescriptionNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //if (true)
                //{
                //    decimal totalIncome = 0;

                //    foreach (var c in cost)
                //    {
                //        totalIncome += -1 * (c.PatientAmount.Value + c.GuarantorAmount.Value);
                //    }


                //    JournalTransactionDetails d = new JournalTransactionDetails();
                //    d.AddNew();
                //    d.JournalId = entity.JournalId;
                //    d.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                //    d.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                //    d.Debit = 0;
                //    d.Credit = totalIncome;
                //    d.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                //    d.DocumentNumber = tc.PrescriptionNo;
                //    d.Save();

                //    totalCredit += d.Credit.Value;

                //}

                //Jurnalnya pada saat direct prescription:
                //      Inventory (D)
                //          HPP (K)
                //Pada saat payment baru pendapatannya dikurangi:
                //      Pendapatan (D)
                //          Kas (K)

                var guar = new Guarantor();
                guar.LoadByPrimaryKey(reg.GuarantorID);

                foreach (var c in cost)
                {

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == c.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                        if (proacc.Load(proacc.Query))
                        {
                            if (itemInv.SRItemType == "11")
                            {

                                var TypeReg = reg.SRRegistrationType;
                                int coaIdIncome = 0;
                                int subledgerIdIncome = 0;
                                int coaIdCOGS = 0;
                                int subledgerIdCOGS = 0;
                                int coaIdInventory = 0;
                                int subledgerIdInventory = 0;
                                int coaIdDiscount = 0;
                                int subledgerIdDiscount = 0;

                                switch (TypeReg)
                                {
                                    case "OPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncome.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncome.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGS.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGS.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventory.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventory.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscount.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscount.Value;
                                        break;

                                    case "IPR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIP.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIP.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIP.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIP.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIP.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIP.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIP.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIP.Value;

                                        break;
                                    case "EMR":
                                        coaIdIncome = proacc.ChartOfAccountIdIncomeIGD.Value;
                                        subledgerIdIncome = proacc.SubledgerIdIncomeIGD.Value;
                                        coaIdCOGS = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        subledgerIdCOGS = proacc.SubledgerIdCOGSIGD.Value;
                                        coaIdInventory = proacc.ChartOfAccountIdInventoryIGD.Value;
                                        subledgerIdInventory = proacc.SubledgerIdInventoryIGD.Value;
                                        coaIdDiscount = proacc.ChartOfAccountIdDiscountIGD.Value;
                                        subledgerIdDiscount = proacc.SubledgerIdDiscountIGD.Value;

                                        break;
                                }

                                // ItemProductMedic
                                ItemProductMedic itemMedic = new ItemProductMedic();
                                itemMedic.Query.Where(itemMedic.Query.ItemID == c.ItemID);
                                if (itemMedic.Query.Load())
                                {

                                    string locationId = tc.LocationID;
                                    if (string.IsNullOrEmpty(locationId))
                                        locationId = unit.GetMainLocationId(unit.ServiceUnitID);

                                    Location loc = new Location();
                                    if (loc.LoadByPrimaryKey(locationId))
                                    {
                                        //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        //JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                        //itemMedicIncome.AddNew();
                                        //itemMedicIncome.JournalId = entity.JournalId;
                                        //itemMedicIncome.ChartOfAccountId = coaIdIncome;
                                        //itemMedicIncome.SubLedgerId = subledgerIdIncome;
                                        //itemMedicIncome.Debit = -1 * (c.PatientAmount + c.GuarantorAmount + c.DiscountAmount);
                                        //itemMedicIncome.Credit = 0;
                                        //itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                        //itemMedicIncome.DocumentNumber = tc.PrescriptionNo;
                                        //itemMedicIncome.Save();

                                        //totalDebit += itemMedicIncome.Debit.Value;

                                        TransPrescriptionItem ci = new TransPrescriptionItem();
                                        ci.Query.Where(ci.Query.PrescriptionNo == c.TransactionNo, ci.Query.SequenceNo == c.SequenceNo, ci.Query.ItemID == c.ItemID);


                                        if (ci.Query.Load())
                                        {
                                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                            {
                                                // COGS
                                                //COGS ambil dr Item Movement agar bisa digunakan metode FIFO
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == c.TransactionNo, mov.SequenceNo == c.SequenceNo, mov.ItemID == c.ItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    //decimal? cogs = (-1 * ci.ResultQty) * ci.CostPrice;
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = entity.JournalId;
                                                    itemMedicCogs.ChartOfAccountId = coaIdCOGS;
                                                    itemMedicCogs.SubLedgerId = subledgerIdCOGS;
                                                    itemMedicCogs.Debit = 0;
                                                    itemMedicCogs.Credit = cogs;
                                                    itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicCogs.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicCogs.Save();

                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = entity.JournalId;
                                                    itemMedicInv.ChartOfAccountId = coaIdInventory;
                                                    itemMedicInv.SubLedgerId = subledgerIdInventory;
                                                    itemMedicInv.Debit = cogs;
                                                    itemMedicInv.Credit = 0;
                                                    itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                                    itemMedicInv.DocumentNumber = tc.PrescriptionNo;
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                }
                                            }


                                            //if (ci.DiscountAmount.Value > 0)
                                            //{
                                            //    JournalTransactionDetails disc = new JournalTransactionDetails();
                                            //    disc.AddNew();
                                            //    disc.JournalId = entity.JournalId;
                                            //    disc.ChartOfAccountId = coaIdDiscount;
                                            //    disc.SubLedgerId = subledgerIdDiscount;
                                            //    disc.Debit = 0;
                                            //    disc.Credit = ci.DiscountAmount.Value;
                                            //    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, c.ItemID, itemInv.ItemName);
                                            //    disc.DocumentNumber = tc.PrescriptionNo;
                                            //    disc.Save();

                                            //    totalCredit += disc.Credit.Value;
                                            //}
                                        }

                                    }
                                }
                            }
                        }
                    }

                }
                ////Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));             


                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewPrescriptionReturnJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;
            }
        }

        public static int? AddNewPhysicianVerificationTaxAndAddAndDeduc(string journalType, ParamedicFeeVerification pf, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;
            try
            {
                decimal TotalAddOrDeduct = 0;
                var pfad = new ParamedicFeeAddDeducCollection();
                pfad.Query.Where(pfad.Query.VerificationNo == pf.VerificationNo);
                pfad.LoadAll();

                foreach (ParamedicFeeAddDeduc det in pfad)
                {
                    if (det.SRParamedicFeeAdjustType == "01")
                        TotalAddOrDeduct += det.Amount.Value;
                    else
                        TotalAddOrDeduct -= det.Amount.Value;

                }

                if (pf.TaxAmount == 0 && TotalAddOrDeduct == 0)
                    return 0;

                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    return 0;

                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PPV", pf.VerificationDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = pf.VerificationDate;
                entity.Description = string.Format("VERIF PHYSC NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = pf.VerificationNo;
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                decimal? total_hutang = TotalAddOrDeduct - pf.TaxAmount;

                int account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPayment");
                if (total_hutang < 0)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = account_physc_verif;
                    d.SubLedgerId = 0;
                    d.Debit = total_hutang;
                    d.Credit = 0;
                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    d.DocumentNumber = pf.VerificationNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }
                else
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = account_physc_verif;
                    d.SubLedgerId = 0;
                    d.Debit = 0;
                    d.Credit = total_hutang;
                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    d.DocumentNumber = pf.VerificationNo;
                    d.Save();

                    totalCredit += d.Credit.Value;
                }

                int account_physc_verif_cost = GetCachedAccountFromParam("coa_PhysicianPaymentVerification");
                if (TotalAddOrDeduct > 0)
                {
                    JournalTransactionDetails a = new JournalTransactionDetails();
                    a.AddNew();
                    a.JournalId = entity.JournalId;
                    a.ChartOfAccountId = account_physc_verif_cost;
                    a.SubLedgerId = 0;
                    a.Debit = TotalAddOrDeduct;
                    a.Credit = 0;
                    a.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    a.DocumentNumber = pf.VerificationNo;
                    a.Save();

                    totalDebit += a.Debit.Value;
                }
                else if (TotalAddOrDeduct < 0)
                {
                    JournalTransactionDetails a = new JournalTransactionDetails();
                    a.AddNew();
                    a.JournalId = entity.JournalId;
                    a.ChartOfAccountId = account_physc_verif_cost;
                    a.SubLedgerId = 0;
                    a.Debit = 0;
                    a.Credit = TotalAddOrDeduct;
                    a.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    a.DocumentNumber = pf.VerificationNo;
                    a.Save();

                    totalCredit += a.Credit.Value;
                }
                if (pf.TaxAmount > 0)
                {
                    int c_account_pph21 = GetCachedAccountFromParam("coa_PhycisianTax");

                    JournalTransactionDetails e = new JournalTransactionDetails();
                    e.AddNew();
                    e.JournalId = entity.JournalId;
                    e.ChartOfAccountId = c_account_pph21;
                    e.SubLedgerId = 0;
                    e.Debit = 0;
                    e.Credit = pf.TaxAmount;
                    e.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    e.DocumentNumber = pf.VerificationNo;
                    e.Save();

                    totalCredit += e.Credit.Value;
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;

            }
            catch
            {
                return -1;
            }

        }

        public static int? AddNewPhysicianVerificationJournal(string journalType, ParamedicFeeVerification pf, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    return 0;

                int d_account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPaymentVerification");
                int dSubLedgerId = 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PPV", pf.VerificationDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pf.VerificationDate;
                    entity.Description = string.Format("VERIF PHYSC NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pf.VerificationNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //Biaya yang masih harus dibayar
                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = d_account_physc_verif;
                d.SubLedgerId = dSubLedgerId;
                d.Debit = pf.VerificationAmount;
                d.Credit = 0;
                d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                d.DocumentNumber = pf.VerificationNo;
                d.Save();

                totalDebit += d.Debit.Value;

                //Hutang Honor Dokter
                int c_account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPayment");
                int cSubLedgerId = 0;

                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = c_account_physc_verif;
                c.SubLedgerId = cSubLedgerId;
                c.Debit = 0;
                c.Credit = pf.VerificationAmount - pf.TaxAmount;
                c.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                c.DocumentNumber = pf.VerificationNo;
                c.Save();

                totalCredit += c.Credit.Value;

                int c_account_pph21 = GetCachedAccountFromParam("coa_PhycisianTax");

                if (pf.TaxAmount > 0)
                {
                    JournalTransactionDetails e = new JournalTransactionDetails();
                    e.AddNew();
                    e.JournalId = entity.JournalId;
                    e.ChartOfAccountId = c_account_pph21;
                    e.SubLedgerId = 0;
                    e.Debit = 0;
                    e.Credit = pf.TaxAmount;
                    e.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    e.DocumentNumber = pf.VerificationNo;
                    e.Save();

                    totalCredit += e.Credit.Value;
                }



                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;

            }

            catch (Exception ex)
            {
                return -1;
            }
        }

        private static int? AddNewPhysicianVerificationJournalByDischargeDateUnapproval(string journalType, ParamedicFeeVerification pf, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Unapproval Verifikasi jasa medis by discharge date
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == pf.VerificationNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                var id = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "PPV", editedBy, DateTime.Now.Date, "Unapproval");

                if (id > 0)
                {
                    var tax = new ParamedicFeeTaxCalculationCollection();
                    tax.Query.Where(tax.Query.VerificationNo == pf.VerificationNo);
                    if (journalId == 0) tax.Query.Where(tax.Query.JournalID.IsNull());
                    else tax.Query.Where(tax.Query.JournalID == journalId);
                    tax.LoadAll();
                    foreach (var t in tax)
                    {
                        t.JournalID = id;
                    }
                    tax.Save();
                }

                return id;
            }
        }

        public static int? AddNewPhysicianVerificationJournalByDischargeDate(string journalType, ParamedicFeeVerification pf, string editedBy, int journalId)
        {
            if (journalId == 0)
            {
                if (!pf.IsApproved ?? false)
                {
                    return AddNewPhysicianVerificationJournalByDischargeDateUnapproval(journalType, pf, editedBy, 0);
                }
            }
            else
            {
                // jika ini ternyata reverse journal yang di rejournal maka lihat #1
            }

            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    // #1 ini reverse journal
                    if (entity.JournalIdRefference.HasValue)
                        return AddNewPhysicianVerificationJournalByDischargeDateUnapproval(journalType, pf, editedBy, journalId);

                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PPV", pf.ApprovedDate.Value); //pf.VerificationDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pf.ApprovedDate.Value;
                    entity.Description = string.Format("VERIF PHYSC NO#:{0}. PHYSC#:{1}", pf.VerificationNo, p.ParamedicName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pf.VerificationNo;

                    entity.Save();

                    ValidateClosingPeriode(entity);
                }

                var coaColl = new ChartOfAccountsCollection();

                // Cost For Unit
                var qfee = new ParamedicFeeTransChargesItemCompByDischargeDateQuery("a");
                var qdt = new TransChargesQuery("b");
                var reg = new RegistrationQuery("reg");
                var regMap = new vwRegistrationForMappingCOAQuery("regMap");
                var pat = new PatientQuery("pat");
                var i = new ItemQuery("i");
                var g = new GuarantorQuery("g");

                qfee.LeftJoin(qdt).On(qfee.TransactionNo == qdt.TransactionNo)
                    .LeftJoin(i).On(qfee.ItemID == i.ItemID)
                    .InnerJoin(reg).On(qfee.RegistrationNo == reg.RegistrationNo)
                    .LeftJoin(g).On(reg.GuarantorID == g.GuarantorID)
                    .InnerJoin(regMap).On(reg.RegistrationNo == regMap.RegistrationNo)
                    .InnerJoin(pat).On(reg.PatientID == pat.PatientID)
                    .Where(qfee.VerificationNo == pf.VerificationNo)
                    .Select(
                        qfee.TransactionNo, qfee.SequenceNo, qfee.ParamedicID, qfee.ItemID, qfee.FeeAmount, qfee.SumDeductionAmount,
                        "<ISNULL(b.ToServiceUnitID, reg.ServiceUnitID) ToServiceUnitID>", "<ISNULL(i.ItemName, g.GuarantorName) ItemName>",
                        qfee.TariffComponentID, regMap.SRRegistrationType,
                        qfee.RegistrationNo, "<RTRIM(pat.FirstName + ' ' + RTRIM(pat.MiddleName + ' ' + pat.LastName)) as PatientName>",
                        qfee.Notes, qfee.SRPhysicianFeeCategory,
                        "<ISNULL(ChartOfAccountIdCostParamedicFee,0) ChartOfAccountIdCostParamedicFee>",
                        "<ISNULL(SubledgerIdCostParamedicFee, 0) SubledgerIdCostParamedicFee>",
                        g.GuarantorID, g.GuarantorName, g.SRGuarantorIncomeGroup, qdt.ClassID, qdt.RoomID, qdt.BedID
                    );

                qfee.Where(qfee.VerificationNo == pf.VerificationNo);
                var dttbl = qfee.LoadDataTable();

                // fee by team
                var qfeeBt = new ParamedicFeeTransChargesItemCompByTeamQuery("a");
                //var qfee = new ParamedicFeeTransChargesItemCompByDischargeDateQuery("a");
                qdt = new TransChargesQuery("b");
                reg = new RegistrationQuery("reg");
                regMap = new vwRegistrationForMappingCOAQuery("regMap");
                pat = new PatientQuery("pat");
                i = new ItemQuery("i");
                g = new GuarantorQuery("g");

                qfeeBt.LeftJoin(qdt).On(qfeeBt.TransactionNo == qdt.TransactionNo)
                    .LeftJoin(i).On(qfeeBt.ItemID == i.ItemID)
                    .InnerJoin(reg).On(qfeeBt.RegistrationNo == reg.RegistrationNo)
                    .LeftJoin(g).On(reg.GuarantorID == g.GuarantorID)
                    .InnerJoin(regMap).On(reg.RegistrationNo == regMap.RegistrationNo)
                    .InnerJoin(pat).On(reg.PatientID == pat.PatientID)
                    .Where(qfeeBt.VerificationNo == pf.VerificationNo)
                    .Select(
                        qfeeBt.TransactionNo, qfeeBt.SequenceNo, qfeeBt.ParamedicID, qfeeBt.ItemID, qfeeBt.FeeAmount, "<CAST(0 as decimal(18,2)) SumDeductionAmount>",
                        "<ISNULL(b.ToServiceUnitID, reg.ServiceUnitID) ToServiceUnitID>", "<ISNULL(i.ItemName, g.GuarantorName) ItemName>",
                        qfeeBt.TariffComponentID, regMap.SRRegistrationType,
                        qfeeBt.RegistrationNo, "<RTRIM(pat.FirstName + ' ' + RTRIM(pat.MiddleName + ' ' + pat.LastName)) as PatientName>",
                        qfeeBt.Notes, "<'01' as SRPhysicianFeeCategory>",
                        "<ISNULL(ChartOfAccountIdCostParamedicFee,0) ChartOfAccountIdCostParamedicFee>",
                        "<ISNULL(SubledgerIdCostParamedicFee, 0) SubledgerIdCostParamedicFee>",
                        g.GuarantorID, g.GuarantorName, g.SRGuarantorIncomeGroup, qdt.ClassID, qdt.RoomID, qdt.BedID
                    );

                qfeeBt.Where(qfeeBt.VerificationNo == pf.VerificationNo);
                var dttbl2 = qfeeBt.LoadDataTable();

                dttbl.Merge(dttbl2);

                var suColl = new ServiceUnitCollection();
                suColl.LoadAll();

                var tax = new ParamedicFeeTaxCalculationCollection();
                tax.Query.Where(tax.Query.VerificationNo == pf.VerificationNo);
                if (journalId == 0) tax.Query.Where(tax.Query.JournalID.IsNull());
                else tax.Query.Where(tax.Query.JournalID == journalId);
                tax.LoadAll();

                foreach (var t in tax)
                {
                    t.JournalID = entity.JournalId;
                }
                tax.Save();
                journalId = entity.JournalId.Value;

                decimal tDebit = 0, tCredit = 0, taxSum = 0;
                decimal feeTotal = 0, taxTotalPPH21 = 0, taxTotalPPH22 = 0, taxTotalPPH23 = 0;

                int c_account_pph21 = GetCachedAccountFromParam("coa_PhycisianTax");
                int c_account_pph22 = GetCachedAccountFromParam("coa_Pph22");
                int c_account_pph23 = GetCachedAccountFromParam("coa_Pph23");


                //var grr = new Guarantor();
                //grr.LoadByPrimaryKey(reg.GuarantorID);

                foreach (System.Data.DataRow row in dttbl.Rows)
                {
                    // Cost Unit
                    var su = (from s in suColl where s.ServiceUnitID == row["ToServiceUnitID"].ToString() select s).FirstOrDefault();
                    //if (su.Count() > 0)
                    int dCOA = 0, dSL = 0;
                    if ((row["SRPhysicianFeeCategory"].ToString() == string.Empty) ||
                        row["SRPhysicianFeeCategory"].ToString().Equals("01") ||
                        System.Convert.ToInt32(string.IsNullOrEmpty(row["SRPhysicianFeeCategory"].ToString()) ? "0" : row["SRPhysicianFeeCategory"].ToString()) >= 4 ||
                        (row["SRPhysicianFeeCategory"].ToString().Equals("02") &&
                        !row["TariffComponentID"].ToString().Equals(string.Empty)))
                    {
                        var sui = new ServiceUnitItemServiceCompMappingCollection();
                        sui.Query.Where(sui.Query.ServiceUnitID == row["ToServiceUnitID"].ToString(),
                            sui.Query.ItemID == row["ItemID"].ToString(),
                            sui.Query.TariffComponentID == row["TariffComponentID"].ToString(),
                            sui.Query.SRRegistrationType == row["SRRegistrationType"].ToString(),
                            sui.Query.SRGuarantorIncomeGroup == row["SRGuarantorIncomeGroup"].ToString());
                        sui.LoadAll();
                        if (sui.Count() > 0)
                        {
                            dCOA = ValidateCOA(sui.First().ChartOfAccountIdCost ?? 0, coaColl, "ServiceUnitItemServiceCompMapping: Paramedic Fee Cost");
                            dSL = sui.First().SubledgerIdCost ?? 0;
                        }
                        else
                        {
                            throw new Exception("ServiceUnitItemServiceCompMapping: Paramedic Fee Cost: Missing chart of account setting");
                        }
                    }
                    else
                    {
                        var sPrefix = string.Empty;
                        var stditem = new AppStandardReferenceItem();
                        if (stditem.LoadByPrimaryKey("PhysicianFeeCategory", row["SRPhysicianFeeCategory"].ToString()))
                        {
                            sPrefix = "This setting is required for physician fee type of " + stditem.ItemName;
                        }
                        dCOA = ValidateCOA((int)row["ChartOfAccountIdCostParamedicFee"], coaColl,
                            string.Format("Guarantor ({0}): COA Cost Paramedic Fee",
                            row["GuarantorName"].ToString()), sPrefix);
                        dSL = su.SubledgerIdCostParamedicFee ?? 0;
                    }

                    var feeAmount = System.Convert.ToDecimal(row["FeeAmount"]) - System.Convert.ToDecimal((row["SumDeductionAmount"] is DBNull ? 0 : row["SumDeductionAmount"]));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dCOA;
                    d.SubLedgerId = dSL;
                    d.Debit = (feeAmount >= 0 ? feeAmount : 0);
                    d.Credit = (feeAmount < 0 ? (-feeAmount) : 0);
                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}. UNIT#:{2}. Item#:{3}. Reg#:{4}. Name#:{5}. {6}",
                        pf.VerificationNo, p.ParamedicName, su.ServiceUnitName,
                        row["ItemName"].ToString(), row["RegistrationNo"].ToString(),
                        row["PatientName"].ToString(), row["Notes"].ToString());
                    d.DocumentNumber = pf.VerificationNo;
                    AddMoreInfo(d, row["ClassID"].ToString(), row["RoomID"].ToString(), row["BedID"].ToString(), row["GuarantorID"].ToString(), string.Empty, row["ParamedicID"].ToString(), null,
                            row["ToServiceUnitID"].ToString(), row["ItemID"].ToString(), row["RegistrationNo"].ToString(),
                            row["SequenceNo"].ToString());
                    d.Save();

                    feeTotal += d.Debit.Value - d.Credit.Value;
                    tDebit += d.Debit.Value;
                    tCredit += d.Credit.Value;

                    // hutang pajak bertambah di kredit
                    var tx = tax.Where(x => x.TransactionNo == row["TransactionNo"].ToString() &&
                        x.SequenceNo == row["SequenceNo"].ToString() &&
                        x.TariffComponentID == row["TariffComponentID"].ToString())
                        .OrderByDescending(x => x.id);
                    // ambil 
                    foreach (var t in tx)
                    {
                        t.TaxAmount = Math.Round(t.TaxAmount ?? 0, 2);

                        taxSum += t.TaxAmount ?? 0; // sementara, ntar mau dihapus *teguhs

                        JournalTransactionDetails cpjk = new JournalTransactionDetails();
                        cpjk.AddNew();
                        cpjk.JournalId = entity.JournalId;
                        switch (t.SRPphType)
                        {
                            case "01": { cpjk.ChartOfAccountId = ValidateCOA(c_account_pph21, coaColl, "AppParameter: coa_PhycisianTax (for pph21)"); break; }
                            case "02": { cpjk.ChartOfAccountId = ValidateCOA(c_account_pph22, coaColl, "AppParameter: coa_Pph22"); break; }
                            case "03": { cpjk.ChartOfAccountId = ValidateCOA(c_account_pph23, coaColl, "AppParameter: coa_Pph23"); break; }
                        }
                        cpjk.SubLedgerId = 0;
                        cpjk.Debit = (t.TaxAmount < 0 ? (-t.TaxAmount) : 0);
                        cpjk.Credit = (t.TaxAmount >= 0 ? t.TaxAmount : 0);
                        cpjk.Description = string.Format("Tax for NO#:{0}. PHYSC#:{1}. UNIT#:{2}. Item#:{3}. Reg#:{4}. Name#:{5}. {6}",
                            pf.VerificationNo, p.ParamedicName, su.ServiceUnitName,
                            row["ItemName"].ToString(), row["RegistrationNo"].ToString(),
                            row["PatientName"].ToString(), row["Notes"].ToString());
                        cpjk.DocumentNumber = pf.VerificationNo;
                        AddMoreInfo(cpjk, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, t.ParamedicID, null,
                            row["ToServiceUnitID"].ToString(), row["ItemID"].ToString(), row["RegistrationNo"].ToString(),
                            row["SequenceNo"].ToString());
                        cpjk.Save();


                        switch (t.SRPphType)
                        {
                            case "01": { taxTotalPPH21 += cpjk.Credit.Value - cpjk.Debit.Value; break; }
                            case "02": { taxTotalPPH22 += cpjk.Credit.Value - cpjk.Debit.Value; break; }
                            case "03": { taxTotalPPH23 += cpjk.Credit.Value - cpjk.Debit.Value; break; }
                        }

                        tDebit += cpjk.Debit.Value;
                        tCredit += cpjk.Credit.Value;
                    }

                }
                // End of Cost For Unit
                // Additional / Deduction
                var pfad = new ParamedicFeeAddDeducCollection();
                pfad.Query.Where(pfad.Query.VerificationNo == pf.VerificationNo);
                pfad.LoadAll();

                int account_physc_verif_cost = GetCachedAccountFromParam("coa_PhysicianPaymentVerification");

                var appstdref = new AppStandardReferenceItemCollection();
                appstdref.Query.Where(appstdref.Query.StandardReferenceID == "ParamedicFeeAdjustType");
                appstdref.LoadAll();

                foreach (var ad in pfad)
                {
                    // jika ada coa di additional deduction ambil dari situ vrohh...
                    int? accountAddDec = account_physc_verif_cost;
                    int? slAddDec = 0;
                    if (ad.ChartOfAccountId.HasValue && ad.ChartOfAccountId != 0)
                    {
                        accountAddDec = ad.ChartOfAccountId;
                        slAddDec = ad.SubledgerId;
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(accountAddDec, coaColl,
                        (ad.ChartOfAccountId.HasValue && ad.ChartOfAccountId != 0) ? "Add/Dec Physician Fee" : "AppParameter: coa_PhysicianPaymentVerification (for additional / deduction)");
                    d.SubLedgerId = slAddDec;
                    d.Debit = (ad.SRParamedicFeeAdjustType == "01" ? ad.Amount.Value : 0);
                    d.Credit = (ad.SRParamedicFeeAdjustType == "02" ? ad.Amount.Value : 0);

                    var s = appstdref.Where(x => x.ItemID == ad.SRParamedicFeeAdjustType).Select(x => x.ItemName);

                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}. Item#:{2} {3}",
                        pf.VerificationNo, p.ParamedicName,
                        s.FirstOrDefault(), ad.Notes);
                    d.DocumentNumber = pf.VerificationNo;
                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, ad.ParamedicID, null,
                            string.Empty, string.Empty, string.Empty, string.Empty);
                    d.Save();

                    feeTotal += d.Debit.Value - d.Credit.Value;
                    tDebit += d.Debit.Value;
                    tCredit += d.Credit.Value;


                    // hutang pajak bertambah di kredit for add deduc
                    var tx = tax.Where(x => x.TransactionNo == ad.TransactionNo &&
                        x.TariffComponentID == x.TariffComponentID)
                        .OrderByDescending(x => x.id);
                    // ambil pajak terakhir, bisa jadi lebih dari satu jika nanti ada unapprove verifikasi, trus approve lagi
                    foreach (var t in tx)
                    {
                        t.TaxAmount = Math.Round(t.TaxAmount ?? 0, 2);
                        taxSum += t.TaxAmount ?? 0; // sementara, ntar mau dihapus *teguhs

                        JournalTransactionDetails cpjk = new JournalTransactionDetails();
                        cpjk.AddNew();
                        cpjk.JournalId = entity.JournalId;
                        switch (t.SRPphType)
                        {
                            case "01": { cpjk.ChartOfAccountId = ValidateCOA(c_account_pph21, coaColl, "AppParameter: coa_PhycisianTax (for pph21)"); break; }
                            case "02": { cpjk.ChartOfAccountId = ValidateCOA(c_account_pph22, coaColl, "AppParameter: coa_Pph22"); break; }
                            case "03": { cpjk.ChartOfAccountId = ValidateCOA(c_account_pph23, coaColl, "AppParameter: coa_Pph23"); break; }
                        }
                        cpjk.SubLedgerId = 0;
                        cpjk.Debit = (t.TaxAmount < 0 ? (-t.TaxAmount) : 0);
                        cpjk.Credit = (t.TaxAmount >= 0 ? t.TaxAmount : 0);
                        cpjk.Description = string.Format("Tax for NO#:{0}. PHYSC#:{1}. Item#:{2}",
                            pf.VerificationNo, p.ParamedicName,
                            s.FirstOrDefault());
                        cpjk.DocumentNumber = pf.VerificationNo;
                        AddMoreInfo(cpjk, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, t.ParamedicID, null,
                            string.Empty, string.Empty, string.Empty, string.Empty);
                        cpjk.Save();


                        switch (t.SRPphType)
                        {
                            case "01": { taxTotalPPH21 += cpjk.Credit.Value - cpjk.Debit.Value; break; }
                            case "02": { taxTotalPPH22 += cpjk.Credit.Value - cpjk.Debit.Value; break; }
                            case "03": { taxTotalPPH23 += cpjk.Credit.Value - cpjk.Debit.Value; break; }
                        }

                        tDebit += cpjk.Debit.Value;
                        tCredit += cpjk.Credit.Value;
                    }
                }
                // end of Additional and Deduction


                if (pf.TaxAmount != taxSum)
                {
                    pf.TaxAmount = taxSum; // selisih karena pembulatan money ke decimal ,2 *semetara, mau dihapus sama teguhs
                    pf.Save();
                }

                // deduction after tax
                var apstdDecColl = new AppStandardReferenceItemCollection();
                apstdDecColl.Query.Where(apstdDecColl.Query.StandardReferenceID == "ParamedicFeeDeduction");
                apstdDecColl.LoadAll();

                var decSettColl = new ParamedicFeeDeductionSettingCollection();
                decSettColl.LoadAll();

                var decATColl = new ParamedicFeeDeductionsCollection();
                decATColl.Query.Where(decATColl.Query.VerificationNo == pf.VerificationNo,
                    decATColl.Query.IsAfterTax == true);
                decATColl.LoadAll();

                var decType = decATColl.Select(d => d.DeductionID).Distinct();
                foreach (var dte in decType)
                {
                    var decSett = decSettColl.Where(d => d.DeductionID == dte).FirstOrDefault();
                    var apstdDec = apstdDecColl.Where(d => d.ItemID == decSett.SRParamedicFeeDeduction).FirstOrDefault();

                    var decAmount = decATColl.Where(d => d.DeductionID == dte).Sum(d => d.DeductionAmount);
                    JournalTransactionDetails cDte = new JournalTransactionDetails();
                    cDte.AddNew();
                    cDte.JournalId = entity.JournalId;
                    cDte.ChartOfAccountId = ValidateCOA(apstdDec.coaID ?? 0, coaColl, "Standard Reference: ParamedicFeeDeduction: " + apstdDec.ItemName);
                    cDte.SubLedgerId = apstdDec.subledgerID; //p.SubledgerIdAPParamedicFee ?? 0;
                    cDte.Debit = (decAmount < 0 ? (-decAmount) : 0);
                    cDte.Credit = (decAmount >= 0 ? (decAmount) : 0);
                    cDte.Description = string.Format("NO#:{0}. PHYSC#:{1}. Deduction {2}", pf.VerificationNo, p.ParamedicName, apstdDec.ItemName);
                    cDte.DocumentNumber = pf.VerificationNo;
                    AddMoreInfo(cDte, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, pf.ParamedicID, null,
                        string.Empty, string.Empty, string.Empty, string.Empty);
                    cDte.Save();

                    tDebit += cDte.Debit.Value;
                    tCredit += cDte.Credit.Value;
                }

                var totalDec = decATColl.Sum(d => d.DeductionAmount);

                // AP Paramedic Fee
                var apAmt = pf.VerificationAmount - pf.TaxAmount - totalDec;
                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = ValidateCOA(p.ChartOfAccountIdAPParamedicFee ?? 0, coaColl, "A/P Paramedic for " + p.ParamedicName);
                c.SubLedgerId = p.SubledgerIdAPParamedicFee ?? 0;
                c.Debit = (apAmt < 0 ? (-apAmt) : 0);
                c.Credit = (apAmt >= 0 ? (apAmt) : 0);
                c.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                c.DocumentNumber = pf.VerificationNo;
                AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, pf.ParamedicID, null,
                    string.Empty, string.Empty, string.Empty, string.Empty);
                c.Save();

                tDebit += c.Debit.Value;
                tCredit += c.Credit.Value;
                // End Of AP Paramedic Fee

                //// tax
                //int c_account_pph21 = GetCachedAccountFromParam("coa_PhycisianTax");
                //JournalTransactionDetails ct = new JournalTransactionDetails();
                //ct.AddNew();
                //ct.JournalId = entity.JournalId;
                //ct.ChartOfAccountId = c_account_pph21;
                //ct.SubLedgerId = 0;
                //ct.Debit = (pf.TaxAmount < 0 ? (-pf.TaxAmount) : 0);
                //ct.Credit = (pf.TaxAmount >= 0 ? (pf.TaxAmount) : 0);
                //ct.Description = string.Format("NO#:{0}. PHYSC#:{1}. Tax", pf.VerificationNo, p.ParamedicName);
                //ct.DocumentNumber = pf.VerificationNo;
                //ct.Save();

                //tDebit += ct.Debit.Value;
                //tCredit += ct.Credit.Value;
                //// end of tax

                if (/*(tCredit > 0 && tDebit > 0) && */(tDebit == tCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;

            }

            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewParamedicFeePayable(string journalType, DateTime date, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            var isClosingPeriod = PostingStatus.IsPeriodeClosed(date);
            if (isClosingPeriod)
            {
                throw new Exception("Financial statements for period: " +
                                   string.Format("{0:MMMM-yyyy}", date) +
                                   " have been closed. Please contact the authorities.");
            }

            //var jtdRevColl = new JournalTransactionDetailsCollection();
            var UnmapCoaMappings = new List<CoaMapping>();
            DataTable dttbl = null;
            ServiceUnitCollection suColl = null;
            ParamedicCollection parColl = null;
            ServiceUnitItemServiceCompMappingCollection suiColl = null;

            try
            {
                // jurnal ini tidak boleh double dalam satu tanggal
                var jt = new JournalTransactionsCollection();
                jt.Query.Where(jt.Query.TransactionDate == date,
                    jt.Query.JournalType == journalType,
                    jt.Query.IsVoid == false,
                    jt.Query.JournalIdRefference.IsNull());
                jt.LoadAll();
                if (jt.Count > 0)
                {
                    journalId = jt[0].JournalId ?? 0;
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    //journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    //journalDetails.LoadAll();
                    //journalDetails.MarkAllAsDeleted();
                    //journalDetails.Save();

                    journalDetails.DeleteByJournalId(entity.JournalId.Value);

                    entity.IsVoid = false;

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PFP", date);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = date;
                    entity.Description = string.Format("Physician fee payable {0}", date.ToShortDateString());
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = "PFP-" + date.ToString("yyyy/MM/dd");

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                // ambil semua jasa medis yang belum ada pembayaran sd tanggal @date 
                // dan pasien sudah pulang sebelum tgl @date

                var coaColl = new ChartOfAccountsCollection();

                // Cost For Unit
                var qfee = new ParamedicFeeTransChargesItemCompByDischargeDateQuery("a");
                var qfv = new ParamedicFeeVerificationQuery("fv");
                var qdt = new TransChargesQuery("b");
                var reg = new RegistrationQuery("reg");
                var regMap = new vwRegistrationForMappingCOAQuery("regMap");
                var pat = new PatientQuery("pat");
                var i = new ItemQuery("i");
                var g = new GuarantorQuery("g");

                qfee.LeftJoin(qfv).On(qfee.VerificationNo == qfv.VerificationNo && qfv.IsVoid == false &&
                    qfv.IsApproved == true)
                    .LeftJoin(qdt).On(qfee.TransactionNo == qdt.TransactionNo)
                    .LeftJoin(i).On(qfee.ItemID == i.ItemID)
                    .InnerJoin(reg).On(qfee.RegistrationNo == reg.RegistrationNo)
                    .LeftJoin(g).On(reg.GuarantorID == g.GuarantorID)
                    .InnerJoin(regMap).On(reg.RegistrationNo == regMap.RegistrationNo)
                    .InnerJoin(pat).On(reg.PatientID == pat.PatientID)
                    .Where(qfee.DischargeDateMergeTo <= date,
                        "<CAST(ISNULL(fv.VerificationDate, '" + date.AddMonths(1).ToString("yyyy-MM-dd") + "') AS DATE) > CAST('" + date.ToString("yyyy-MM-dd") + "' AS DATE)>",
                        qfee.FeeAmount != 0
                    )
                    .Select(
                        qfee.TransactionNo, qfee.SequenceNo, qfee.ParamedicID, qfee.ItemID, qfee.FeeAmount, qfee.SumDeductionAmount,
                        "<ISNULL(b.ToServiceUnitID, reg.ServiceUnitID) ToServiceUnitID>", "<ISNULL(i.ItemName, g.GuarantorName) ItemName>",
                        qfee.TariffComponentID, regMap.SRRegistrationType,
                        qfee.RegistrationNo, "<RTRIM(pat.FirstName + ' ' + RTRIM(pat.MiddleName + ' ' + pat.LastName)) as PatientName>",
                        qfee.Notes, qfee.SRPhysicianFeeCategory,
                        "<ISNULL(ChartOfAccountIdCostParamedicFee,0) ChartOfAccountIdCostParamedicFee>",
                        "<ISNULL(SubledgerIdCostParamedicFee, 0) SubledgerIdCostParamedicFee>",
                        g.GuarantorID, g.GuarantorName, g.SRGuarantorIncomeGroup, qdt.ClassID, qdt.RoomID, qdt.BedID
                    ).OrderBy(
                        qfee.DischargeDate.Ascending,
                        qfee.TransactionNo.Ascending,
                        qfee.SequenceNo.Ascending,
                        qfee.TariffComponentID.Ascending
                    );

                qfee.es2.Connection.CommandTimeout = 600;
                dttbl = qfee.LoadDataTable();

                suColl = new ServiceUnitCollection();
                suColl.LoadAll();
                parColl = new ParamedicCollection();
                parColl.LoadAll();

                suiColl = new ServiceUnitItemServiceCompMappingCollection();
                var suiq = new ServiceUnitItemServiceCompMappingQuery("sui");
                var tcq = new TariffComponentQuery("tc");
                suiq.InnerJoin(tcq).On(suiq.TariffComponentID == tcq.TariffComponentID)
                    .Where(tcq.IsTariffParamedic == true)
                    .Select(suiq);
                suiColl.Load(suiq);

                decimal tDebit = 0, tCredit = 0;

                foreach (System.Data.DataRow row in dttbl.Rows)
                {
                    var par = parColl.Where(p => p.ParamedicID == row["ParamedicID"].ToString()).FirstOrDefault();
                    if (par == null) continue;

                    // Cost Unit
                    var su = (from s in suColl where s.ServiceUnitID == row["ToServiceUnitID"].ToString() select s).FirstOrDefault();
                    //if (su.Count() > 0)
                    int dCOA = 0, dSL = 0;
                    if ((row["SRPhysicianFeeCategory"].ToString() == string.Empty) ||
                        row["SRPhysicianFeeCategory"].ToString().Equals("01") ||
                        System.Convert.ToInt32(string.IsNullOrEmpty(row["SRPhysicianFeeCategory"].ToString()) ? "0" : row["SRPhysicianFeeCategory"].ToString()) >= 4 ||
                        (row["SRPhysicianFeeCategory"].ToString().Equals("02") &&
                        !row["TariffComponentID"].ToString().Equals(string.Empty)))
                    {
                        var suis = suiColl.Where(s => s.ServiceUnitID == row["ToServiceUnitID"].ToString() &&
                            s.ItemID == row["ItemID"].ToString() &&
                            s.TariffComponentID == row["TariffComponentID"].ToString() &&
                            s.SRRegistrationType == row["SRRegistrationType"].ToString() &&
                            s.SRGuarantorIncomeGroup == row["SRGuarantorIncomeGroup"].ToString());
                        if (suis.Count() > 0)
                        {
                            dCOA = ValidateCOA(suis.First().ChartOfAccountIdCost ?? 0, coaColl, "ServiceUnitItemServiceCompMapping: Paramedic Fee Cost");
                            dSL = suis.First().SubledgerIdCost ?? 0;
                        }
                        //else
                        //{
                        //    throw new Exception("ServiceUnitItemServiceCompMapping: Paramedic Fee Cost: Missing chart of account setting");
                        //}

                        if (dCOA == 0)
                        {
                            if (!UnmapCoaMappings.Where(u =>
                                u.ServiceUnitID == row["ToServiceUnitID"].ToString() &&
                                u.ItemID == row["ItemID"].ToString() &&
                                u.TariffComponentID == row["TariffComponentID"].ToString()
                            ).Any())
                            {
                                var ucm = new CoaMapping()
                                {
                                    ServiceUnitID = row["ToServiceUnitID"].ToString(),
                                    ItemID = row["ItemID"].ToString(),
                                    TariffComponentID = row["TariffComponentID"].ToString()
                                };
                                UnmapCoaMappings.Add(ucm);
                            }
                        }
                    }
                    else
                    {
                        throw new Exception("Unsupported SRPhysicianFeeCategory in journal paramedic fee payable");
                    }

                    var feeAmount = System.Convert.ToDecimal(row["FeeAmount"]) - System.Convert.ToDecimal((row["SumDeductionAmount"] is DBNull ? 0 : row["SumDeductionAmount"]));

                    if (dCOA != 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = dCOA;
                        d.SubLedgerId = dSL;
                        d.Debit = (feeAmount >= 0 ? feeAmount : 0);
                        d.Credit = (feeAmount < 0 ? (-feeAmount) : 0);
                        d.Description = string.Format("Cost of PHYSC#:{0}. UNIT#:{1}. Item#:{2}. Reg#:{3}. Name#:{4}. {5}",
                            par.ParamedicName, su.ServiceUnitName,
                            row["ItemName"].ToString(), row["RegistrationNo"].ToString(),
                            row["PatientName"].ToString(), row["Notes"].ToString());
                        d.DocumentNumber = row["TransactionNo"].ToString();
                        AddMoreInfo(d, row["ClassID"].ToString(), row["RoomID"].ToString(), row["BedID"].ToString(), row["GuarantorID"].ToString(), string.Empty, row["ParamedicID"].ToString(), null,
                                row["ToServiceUnitID"].ToString(), row["ItemID"].ToString(), row["RegistrationNo"].ToString(),
                                row["SequenceNo"].ToString());
                        d.Save();

                        tDebit += d.Debit.Value;
                        tCredit += d.Credit.Value;
                    }

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(par.ChartOfAccountIdAPParamedicFee, coaColl,
                        string.Format("Paramedic {0}: Account Payable", par.ParamedicName));
                    c.SubLedgerId = par.SubledgerIdAPParamedicFee ?? 0;
                    c.Debit = (feeAmount < 0 ? (-feeAmount) : 0);
                    c.Credit = (feeAmount >= 0 ? feeAmount : 0);
                    c.Description = string.Format("Account Payable of PHYSC#:{0}. UNIT#:{1}. Item#:{2}. Reg#:{3}. Name#:{4}. {5}",
                        par.ParamedicName, su.ServiceUnitName,
                        row["ItemName"].ToString(), row["RegistrationNo"].ToString(),
                        row["PatientName"].ToString(), row["Notes"].ToString());
                    c.DocumentNumber = row["TransactionNo"].ToString();
                    AddMoreInfo(c, row["ClassID"].ToString(), row["RoomID"].ToString(), row["BedID"].ToString(), row["GuarantorID"].ToString(), string.Empty, row["ParamedicID"].ToString(), null,
                            row["ToServiceUnitID"].ToString(), row["ItemID"].ToString(), row["RegistrationNo"].ToString(),
                            row["SequenceNo"].ToString());
                    c.Save();

                    tDebit += c.Debit.Value;
                    tCredit += c.Credit.Value;
                }
                // End of Cost For Unit

                if (UnmapCoaMappings.Count > 0)
                {
                    throw new Exception("ServiceUnitItemServiceCompMapping: Paramedic Fee Cost: Missing chart of account setting");
                }

                if (/*(tCredit > 0 && tDebit > 0) && */(tDebit == tCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
                JournalErrorMessageSave(journalId, ex,
                    Newtonsoft.Json.JsonConvert.SerializeObject(UnmapCoaMappings), editedBy);
            }
            finally
            {
                UnmapCoaMappings = null;
                dttbl = null;
                suColl = null;
                parColl = null;
                suiColl = null;
            }
            return journalId;
        }

        public static int? AddNewParamedicFeePayableReversed(string journalType, DateTime date, DateTime refDate,
            string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference && qh2.IsVoid == false);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull(), qh.TransactionDate == refDate, qh.IsVoid == false);
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(
                qh.JournalType == journalType,
                qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                return AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "PFP", editedBy, date, "Reverse");
            }
        }

        public static int? AddNewPhysicianVerificationJournal2(string journalType, ParamedicFeeVerification pf, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    return 0;

                int d_account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPaymentVerification");
                int dSubLedgerId = 0;
                int c_account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPayment");
                int cSubLedgerId = 0;
                int c_account_physc_verif_ref = GetCachedAccountFromParam("coa_PhysicianPaymentRef");
                int cSubLedgerId_ref = 0;

                ParamedicFeeTransChargesItemCompSettledCollection eItems = new ParamedicFeeTransChargesItemCompSettledCollection();
                ParamedicFeeTransChargesItemCompSettledQuery eItemQuery = new ParamedicFeeTransChargesItemCompSettledQuery("e");
                //ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery);
                eItemQuery.Where(eItemQuery.VerificationNo == pf.VerificationNo);
                if (!eItems.Load(eItemQuery))
                    return 0;


                decimal totalDebit = 0;
                decimal totalCredit = 0;

                decimal totalPrice = 0; // non referal
                decimal totalPriceRef = 0; //referal

                foreach (var z in eItems)
                {
                    if (z.IsRefferal == false)
                        totalPrice += z.FeeAmount.Value;
                    else
                        totalPriceRef += z.FeeAmount.Value;
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PPV", pf.VerificationDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pf.VerificationDate;
                    entity.Description = string.Format("VERIF PHYSC NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pf.VerificationNo;
                }
                entity.Save();

                //Biaya Jasa Dokter
                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = d_account_physc_verif;
                d.SubLedgerId = dSubLedgerId;
                d.Debit = totalPrice + totalPriceRef;
                d.Credit = 0;
                d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                d.DocumentNumber = pf.VerificationNo;
                d.Save();

                totalDebit += d.Debit.Value;

                //Hutang Honor Dokter
                if (totalPrice > 0)
                {
                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = c_account_physc_verif;
                    c.SubLedgerId = cSubLedgerId;
                    c.Debit = 0;
                    c.Credit = totalPrice;
                    c.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    c.DocumentNumber = pf.VerificationNo;
                    c.Save();

                    totalCredit += c.Credit.Value;
                }

                if (totalPriceRef > 0)
                {
                    JournalTransactionDetails f = new JournalTransactionDetails();
                    f.AddNew();
                    f.JournalId = entity.JournalId;
                    f.ChartOfAccountId = c_account_physc_verif_ref;
                    f.SubLedgerId = cSubLedgerId_ref;
                    f.Debit = 0;
                    f.Credit = totalPriceRef;
                    f.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                    f.DocumentNumber = pf.VerificationNo;
                    f.Save();

                    totalCredit += f.Credit.Value;
                }


                //int c_account_pph21 = GetCachedAccountFromParam("coa_PhycisianTax");

                //Pajaknya manual
                //if(pf.TaxAmount > 0)
                //{
                //    JournalTransactionDetails e = new JournalTransactionDetails();
                //    e.AddNew();
                //    e.JournalId = entity.JournalId;
                //    e.ChartOfAccountId = c_account_pph21;
                //    e.SubLedgerId = 0;
                //    e.Debit = 0;
                //    e.Credit = pf.TaxAmount;
                //    e.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.VerificationNo, p.ParamedicName);
                //    e.DocumentNumber = pf.VerificationNo;
                //    e.Save();

                //    totalCredit += e.Credit.Value;
                //}

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;

            }

            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewDetailPhysicianJournal(int JournalId, ParamedicFeeTransChargesItemCompSettled pf, int dCoa, int cCoa, out decimal tCredit, out decimal tDebit)
        {
            var p = new Paramedic();
            if (!p.LoadByPrimaryKey(pf.ParamedicID))
            {
                tCredit = 0;
                tDebit = 0;
                return 0;
            }

            //  int d_account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPaymentVerification");
            int dSubLedgerId = 0;
            // int c_account_physc_verif = GetCachedAccountFromParam("coa_PhysicianPayment");
            int cSubLedgerId = 0;

            //Biaya Jasa Dokter
            JournalTransactionDetails d = new JournalTransactionDetails();
            d.AddNew();
            d.JournalId = JournalId;
            d.ChartOfAccountId = dCoa;
            d.SubLedgerId = dSubLedgerId;
            d.Debit = pf.FeeAmount;
            d.Credit = 0;
            d.Description = string.Format("PAYMENT NO#:{0}. TRANSACTION NO#:{1}. ITEMID:{2}. PARAMEDIC:{3}", pf.PaymentNo, pf.TransactionNo, pf.ItemID, p.ParamedicName);
            d.DocumentNumber = pf.TransactionNo;
            d.Save();

            tDebit = d.Debit.Value;


            JournalTransactionDetails c = new JournalTransactionDetails();
            c.AddNew();
            c.JournalId = JournalId;
            c.ChartOfAccountId = cCoa;
            c.SubLedgerId = cSubLedgerId;
            c.Debit = 0;
            c.Credit = pf.FeeAmount;
            c.Description = string.Format("PAYMENT NO#:{0}. TRANSACTION NO#:{1}. ITEMID:{2}. PARAMEDIC:{3}", pf.PaymentNo, pf.TransactionNo, pf.ItemID, p.ParamedicName);
            c.DocumentNumber = pf.TransactionNo;
            c.Save();

            tCredit = c.Credit.Value;


            return 0;
        }

        public static int? AddNewHeaderPhysicianVerificationJournal(string journalType, DateTime paymentDate, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {

                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PPV", DateTime.Now.Date);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = DateTime.Now.Date;
                entity.Description = string.Format("VERIF PHYSC PAYMENT DATE#:{0:dd-MM-yyyy}.", paymentDate.Date);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.Save();

                return entity.JournalId;

            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewPaymentCorrectionJournalVoidCashBased(TransPayment tp, string prefix,
            string editedBy, int journalId)
        {

            // void payment return,
            // balikin saja jurnal payment return aslinya.

            // 1. Cari payment return aslinya
            var tpRef = new TransPayment();
            if (tpRef.LoadByPrimaryKey(tp.PaymentNo))
            {
                var jhcoll = new JournalTransactionsCollection();
                var qh = new JournalTransactionsQuery("qh");
                var qd = new JournalTransactionDetailsQuery("qd");

                qh.es.Distinct = true;

                // 2. cari jurnal payment return aslinya,
                qh.InnerJoin(qd).On(qh.JournalId == qd.JournalId)
                    .Where(
                        qd.DocumentNumber == tpRef.PaymentNo,
                        /* 
                         * untuk membedakan reprocessing payment return dan void payment retur, 
                         * dilihat dari deskripsi ada kata2 void atau tidak. 
                         * tidak bisa pakai JournalIdRefference null atau tidak karena 
                         * JournalIdRefference untuk kasus ini tidak pernah null,
                         * karena payment return sendiri adalah reverse jurnal dari payment. 
                         * ah gitu lah, kepanjangan jelasinnya
                        */
                        //qh.JournalIdRefference.IsNull() // tidak bisa pakai patokan JournalIdRefference null atau tidak
                        "<qh.Description not like '%Void%'>"
                    ).Select(qh);
                jhcoll.Load(qh);

                if (jhcoll.Count == 0)
                {
                    return -1; // nothing to be reversed
                }
                else
                {
                    // get cash entry
                    CashTransactionCollection ctColl = new CashTransactionCollection();
                    ctColl.Query.Where(
                        ctColl.Query.JournalId == jhcoll[0].JournalId.Value,
                        ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                    ctColl.LoadAll();

                    if (ctColl.Count > 1)
                    {
                        throw new Exception("Multiple cash entry detected for current payment");
                    }
                    else if (ctColl.Count == 1)
                    {
                        if (ctColl.First().IsCleared ?? false == true)
                        {
                            throw new Exception("Cash entry for current payment is already cleared");
                        }
                    }

                    // 3. balikin jurnalnya
                    var ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, prefix,
                        editedBy, tp.VoidDate.Value);

                    // 4. batalkan cash entry atas payment return
                    if (ret > 0 && ctColl.Count == 1)
                    {
                        // undo cash entry
                        CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                        //requery
                        CashTransaction ct = new CashTransaction();
                        if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                        {
                            ct.Void(editedBy);
                        }
                    }

                    return ret;
                }
            }
            else
            {
                return -1;
            }
        }

        public static int? AddNewPaymentCorrectionJournalCashBased(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection ctpItems,
            string prefix, string RefNo, string editedBy, int journalId)
        {
            if (journalType != "07")
            {
                // jika journal void payment maka balikin saja jurnal paymentnya
                // payment receive - unapproved
                return AddNewPaymentCorrectionJournal(tp.PaymentNo, prefix, editedBy, journalId, tp.VoidDate.Value);
            }
            if (journalType == "07" && string.IsNullOrEmpty(tp.PaymentReferenceNo))
            {
                // jurnal type "07" tapi gak punya reference brarti ini payment untuk return resep
                // jurnalin saja sama kayak payment
                return AddNewPaymentCashBasedJournal(journalType, tp, reg, ctpItems, prefix, tp.PaymentNo, editedBy, journalId);
            }
            else
            {
                // payment return - case based
                // balikin saja jurnal payment aslinya.

                // 1. Cari payment aslinya
                var tpRef = new TransPayment();
                if (tpRef.LoadByPrimaryKey(tp.PaymentReferenceNo))
                {
                    var jhcoll = new JournalTransactionsCollection();
                    var qh = new JournalTransactionsQuery("qh");
                    var qd = new JournalTransactionDetailsQuery("qd");

                    qh.es.Distinct = true;

                    // 2. cari jurnal payment aslinya,
                    qh.InnerJoin(qd).On(qh.JournalId == qd.JournalId)
                        //.Where(qd.DocumentNumber == tpRef.PaymentNo, qh.JournalIdRefference.IsNull())
                        .Where(qh.RefferenceNumber == tpRef.PaymentNo, qh.JournalIdRefference.IsNull())
                        .Select(qh);
                    jhcoll.Load(qh);

                    if (jhcoll.Count == 0)
                    {
                        return -1; // nothing to be reversed
                    }
                    else
                    {
                        // 3. balikin jurnalnya
                        journalId = AddNewReverseJournal(
                            journalId, jhcoll[0].JournalId.Value, prefix, editedBy,
                            tp.PaymentDate.Value, "RETURN", tp.PaymentNo, true) ?? 0;

                        // retur uang harusnya jadi cash semua... 
                        // jurnal reversenya harus dijadikan cash keluar

                        var jn = new JournalTransactions();
                        if (jn.LoadByPrimaryKey(journalId))
                        {
                            jn.IsPosted = false;
                            jn.Save();

                            var jndColl = new JournalTransactionDetailsCollection();
                            jndColl.Query.Where(jndColl.Query.JournalId == journalId);
                            jndColl.LoadAll();

                            // find detail payment ref
                            var tpiColl = new TransPaymentItemCollection();
                            tpiColl.Query.Where(tpiColl.Query.PaymentNo == tpRef.PaymentNo);
                            tpiColl.LoadAll();

                            var jtdPays = from a in jndColl
                                          join t in tpiColl
                                          on new { dn = a.DocumentNumber, ds = a.DocumentNumberSequenceNo }
                                          equals new { dn = t.PaymentNo, ds = t.SequenceNo }
                                          select a;

                            int i = 0;

                            var bankColl = new BankCollection();
                            bankColl.LoadAll();

                            foreach (var jnd in jtdPays)
                            {
                                if (i == 0)
                                {
                                    // replace with current payment
                                    // update
                                    int? kAccount = 0;
                                    int? kSubledgerId = 0;
                                    string kAccountMsg = "Payment Method";
                                    PaymentMethod pm = new PaymentMethod();
                                    if (pm.LoadByPrimaryKey("PaymentType-001", "PaymentMethod-001"))
                                    {
                                        if (pm.ChartOfAccountID.HasValue)
                                        {
                                            kAccount = pm.ChartOfAccountID.Value;
                                            kSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                                            kAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                                        }
                                    }

                                    var amt = ctpItems.First().Amount;
                                    jnd.Debit = amt >= 0 ? amt : 0;
                                    jnd.Credit = amt < 0 ? -amt : 0;
                                    jnd.ChartOfAccountId = ValidateCOA(pm.ChartOfAccountID, kAccountMsg, "");
                                    jnd.SubLedgerId = kSubledgerId;
                                    jnd.DocumentNumber = ctpItems.First().PaymentNo;
                                    jnd.DocumentNumberSequenceNo = ctpItems.First().SequenceNo;
                                }
                                else
                                {
                                    var isBank = bankColl.Where(b => b.ChartOfAccountId == jnd.ChartOfAccountId).Any();
                                    // pembulatan jangan dihapus
                                    if (ctpItems.Where(x => Abs(x.RoundingAmount ?? 0) == Abs(jnd.Debit + jnd.Credit)).Any() && !isBank)
                                    {

                                    }
                                    else
                                    {
                                        bool isDelete = true;
                                        var tpi = tpiColl.Where(x => x.PaymentNo == jnd.DocumentNumber && x.SequenceNo == jnd.DocumentNumberSequenceNo).FirstOrDefault();
                                        if (tpi != null)
                                        {
                                            if (tpi.SRPaymentType == "PaymentType-005"/*discount*/)
                                            {
                                                isDelete = false;
                                            }
                                            if (!isBank)
                                            {
                                                isDelete = false;

                                                var coa = new ChartOfAccounts();
                                                if (coa.LoadByPrimaryKey(jnd.ChartOfAccountId ?? 0))
                                                {
                                                    if (coa.ChartOfAccountName.ToLower().Contains("piutang"))
                                                    {
                                                        isDelete = true;
                                                    }
                                                }
                                            }
                                        }

                                        if (isDelete)
                                            jnd.MarkAsDeleted();
                                    }
                                }
                                i++;
                            }

                            //// =================
                            //// Payment return kalau ada DP, DP-nya tidak dibalik. DP-nya selesai pada saat payment
                            //if (tpiColl.Where(x => x.IsFromDownPayment ?? false).Any()) { 
                            //    // WTF bingung
                            //}
                            //// =================

                            //if (tpiColl.Count > 1 || tpiColl.First().SRPaymentMethod != "PaymentMethod-001")
                            //{
                            //    // payment return lebih dari satu jenis bayar atau jenis bayarnya bukan cash
                            //    // harus direturn secara cash semua
                            //    int counter = 0;
                            //    foreach (var tpi in tpiColl)
                            //    {
                            //        if (counter == 0)
                            //        {
                            //            var jnd = jndColl.Where(x => x.Credit == (tpi.Amount - tpi.Balance))
                            //                .OrderBy(x => x.DetailId).FirstOrDefault();
                            //            if (jnd != null)
                            //            {
                            //                // update
                            //                int? kAccount = 0;
                            //                int? kSubledgerId = 0;
                            //                string kAccountMsg = "Payment Method";
                            //                PaymentMethod pm = new PaymentMethod();
                            //                if (pm.LoadByPrimaryKey("PaymentType-001", "PaymentMethod-001"))
                            //                {
                            //                    if (pm.ChartOfAccountID.HasValue)
                            //                    {
                            //                        kAccount = pm.ChartOfAccountID.Value;
                            //                        kSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                            //                        kAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                            //                    }
                            //                }

                            //                var amt = ctpItems.First().Amount;
                            //                jnd.Debit = amt >= 0 ? amt : 0;
                            //                jnd.Credit = amt < 0 ? -amt : 0;
                            //                jnd.ChartOfAccountId = ValidateCOA(pm.ChartOfAccountID, kAccountMsg, "");
                            //                jnd.SubLedgerId = kSubledgerId;
                            //            }
                            //            else
                            //            {
                            //                throw new Exception("Unknown payment (fail to reverse journal)");
                            //            }
                            //        }
                            //        else
                            //        {
                            //            // remove
                            //            var jnd = jndColl.Where(x => x.Credit == (tpi.Amount - tpi.Balance))
                            //                .OrderBy(x => x.DetailId).FirstOrDefault();
                            //            if (jnd != null)
                            //            {
                            //                jnd.MarkAsDeleted();
                            //            }
                            //            else
                            //            {
                            //                throw new Exception("Unknown payment (fail to reverse journal)");
                            //            }
                            //        }
                            //        counter++;
                            //    }
                            //}
                            jndColl.Save();

                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                            {
                                var totalDebit = jndColl.Sum(x => x.Debit);
                                var totalCredit = jndColl.Sum(x => x.Credit);
                                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                                {
                                    jn.BeginEdit();
                                    jn.IsPosted = true;
                                    jn.EndEdit();
                                    jn.Save();
                                }
                            }
                        }


                        // reset revenue flag in intermbill
                        var ibColl = new IntermBillCollection();
                        ibColl.Query.Where(ibColl.Query.JournalIncomePaymentNo == tp.PaymentReferenceNo);
                        ibColl.LoadAll();
                        foreach (var ib in ibColl)
                        {
                            ib.JournalIncomePaymentNo = string.Empty;
                        }
                        ibColl.Save();

                        // balikin cash entry
                        // insert cash transaction here
                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
                        {
                            //int? cashTransactionId;
                            //cashTransactionId = CashTransaction.AddNewAutomaticCashTransactionPaymentReturn(
                            //    tp, ctpItems, journalId, editedBy);
                            //if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (journalId > 0))
                            //{
                            //    CashTransaction.PostingUpdateBalance(cashTransactionId.Value, journalId);
                            //}

                            int? cashTransactionId;
                            CashTransaction.AddNewAutomaticCashTransactionPaymentReceiveFromJournal(
                                tp, ctpItems, jn, editedBy, out cashTransactionId);
                            if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (journalId > 0))
                            {
                                CashTransaction.PostingUpdateBalance(cashTransactionId.Value, journalId);
                            }

                        }

                        BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);

                        return journalId;
                    }
                }
                else
                {
                    return -1;
                }
            }
        }

        public static IEnumerable<ItemTariffComponent> GetItemTariffComponentCollection(DateTime transactionDate, string tariffType, string classID,
            string itemID)
        {
            var coll = new ItemTariffComponentCollection();
            coll.Query.Where(
                coll.Query.SRTariffType == tariffType,
                coll.Query.ItemID == itemID,
                coll.Query.ClassID == classID,
                coll.Query.StartingDate.Date() <= transactionDate
                );
            coll.Query.Where(coll.Query.Or(coll.Query.Price > 0, coll.Query.IsAllowVariable == true));
            coll.Query.OrderBy(
                coll.Query.TariffComponentID.Ascending,
                coll.Query.StartingDate.Descending
                );
            coll.LoadAll();

            var date = (coll.OrderByDescending(c => c.StartingDate).Select(c => c.StartingDate)).Distinct().Take(1).SingleOrDefault();
            return coll.Where(c => c.StartingDate == date);
        }


        public static int AddNewIncomeJournalCashBased_IsOrderTrue(int JournalId, TransChargesItem tci, out decimal tCredit, out decimal tDebit, Boolean JournalReturn)
        {
            decimal totalCredit = 0;
            decimal totalDebit = 0;
            string tserviceUnit = string.Empty;
            Boolean isReturn = false;

            TransCharges tc = new TransCharges();
            if (tc.LoadByPrimaryKey(tci.TransactionNo))
            {
                tserviceUnit = tc.ToServiceUnitID;
                isReturn = tc.IsCorrection.Value;
            }

            Registration reg = new Registration();
            reg.LoadByPrimaryKey(tc.RegistrationNo);

            var regType = reg.SRRegistrationType;

            if (regType != "EMR")
            {
                var merge = new MergeBilling();
                if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                {
                    var r = new Registration();
                    r.LoadByPrimaryKey(merge.FromRegistrationNo);
                    regType = r.SRRegistrationType;
                }
            }
            if (regType == "MCU")
                regType = "OPR";

            Patient pEnity = new Patient();
            pEnity.LoadByPrimaryKey(reg.PatientID);

            Guarantor g = new Guarantor();
            g.LoadByPrimaryKey(reg.GuarantorID);

            AppParameter DefaultTariffType = new AppParameter();
            DefaultTariffType.LoadByPrimaryKey("DefaultTariffType");

            AppParameter DefaultTariffClass = new AppParameter();
            DefaultTariffClass.LoadByPrimaryKey("DefaultTariffClass");

            var su = new ServiceUnit();
            su.LoadByPrimaryKey(tserviceUnit);

            Item item = new Item(); item.Query.Where(item.Query.ItemID == tci.ItemID);
            if (item.Query.Load())
            {
                ServiceUnitItemService itemService = new ServiceUnitItemService();
                itemService.Query.Where(itemService.Query.ServiceUnitID == tserviceUnit, itemService.Query.ItemID == tci.ItemID);

                if (!itemService.Query.Load())
                {
                    throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
                }
                else
                {

                    var tcic = GetItemTariffComponentCollection(tc.TransactionDate.Value, g.SRTariffType, tc.ClassID, tci.ItemID);
                    if (!tcic.Any())
                        tcic = GetItemTariffComponentCollection(tc.TransactionDate.Value, DefaultTariffType.ParameterValue,
                            DefaultTariffClass.ParameterValue, tci.ItemID);

                    var grr = new Guarantor();
                    grr.LoadByPrimaryKey(reg.GuarantorID);

                    foreach (var q in tcic)
                    {

                        int? coaId = 0;
                        int? subLedgerId = 0;
                        int? coaDiscId = 0;
                        int? subLedgerDiscId = 0;



                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == tc.ToServiceUnitID,
                                             itemComp.Query.ItemID == tci.ItemID,
                                             itemComp.Query.TariffComponentID == q.TariffComponentID,
                                             itemComp.Query.SRRegistrationType == regType,
                                             itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);

                        if (itemComp.Query.Load())
                        {
                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                            {
                                coaId = itemComp.ChartOfAccountIdIncome.Value;
                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                            }

                        }

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = JournalId;
                        d.ChartOfAccountId = coaId;
                        d.SubLedgerId = subLedgerId;

                        var cito = tci.CitoAmount / tci.ChargeQuantity / tci.Price * q.Price;

                        if (tci.ChargeQuantity > 0 && JournalReturn == true || tci.ChargeQuantity < 0 && JournalReturn == false)
                        {
                            d.Debit = (q.Price + cito) * tci.ChargeQuantity;
                            d.Credit = 0;
                        }
                        else if (tci.ChargeQuantity < 0 && JournalReturn == true || tci.ChargeQuantity > 0 && JournalReturn == false)
                        {
                            d.Debit = 0;
                            d.Credit = (q.Price + cito) * tci.ChargeQuantity;
                        }
                        d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, tci.ItemID, item.ItemName);
                        d.DocumentNumber = tc.TransactionNo;

                        AddMoreInfo(d, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, tc.ToServiceUnitID, tci.ItemID, tc.RegistrationNo, tci.SequenceNo);

                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                    }
                }
            }

            tDebit = totalDebit;
            tCredit = totalCredit;
            return 0;
        }

        public static void AddNewIncomeJournalCashBasedTest(CostCalculation cc, ref DataTable dtb, Boolean JournalReturn, out string ItemDescription)
        {
            ItemDescription = string.Empty;
            string tserviceUnit = string.Empty;
            string tlocation = string.Empty;
            Boolean isReturn = false;

            Registration reg = new Registration();
            reg.LoadByPrimaryKey(cc.RegistrationNo);

            var regType = reg.SRRegistrationType;

            if (regType != "EMR")
            {
                var merge = new MergeBilling();
                if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                {
                    var r = new Registration();
                    r.LoadByPrimaryKey(merge.FromRegistrationNo);
                    regType = r.SRRegistrationType;
                }
            }
            if (regType == "MCU")
                regType = "OPR";

            Patient pEnity = new Patient();
            pEnity.LoadByPrimaryKey(reg.PatientID);


            TransCharges tc = new TransCharges();
            if (tc.LoadByPrimaryKey(cc.TransactionNo))
            {
                tserviceUnit = tc.ToServiceUnitID;
                tlocation = tc.LocationID;
                isReturn = tc.IsCorrection.Value;
            }

            else
            {
                TransPrescription tp = new TransPrescription();
                if (tp.LoadByPrimaryKey(cc.TransactionNo))
                {
                    tserviceUnit = tp.ServiceUnitID;
                    tlocation = tp.LocationID;
                    isReturn = tp.IsPrescriptionReturn.Value;
                }

            }

            var su = new ServiceUnit();
            su.LoadByPrimaryKey(tserviceUnit);

            if (string.IsNullOrEmpty(tlocation))
                tlocation = su.GetMainLocationId(su.ServiceUnitID);

            ServiceUnitItemService itemService = new ServiceUnitItemService();
            itemService.Query.Where(itemService.Query.ServiceUnitID == tserviceUnit, itemService.Query.ItemID == cc.ItemID);
            if (itemService.Query.Load())
            {

                TransChargesItem ci = new TransChargesItem();
                ci.Query.Where(ci.Query.TransactionNo == cc.TransactionNo, ci.Query.SequenceNo == cc.SequenceNo, ci.Query.ItemID == cc.ItemID);
                if (ci.Query.Load())
                {

                    var tcic = new TransChargesItemCompCollection();
                    tcic.Query.Where(tcic.Query.TransactionNo == cc.TransactionNo, tcic.Query.SequenceNo == cc.SequenceNo);
                    tcic.LoadAll();

                    var grr = new Guarantor();
                    grr.LoadByPrimaryKey(reg.GuarantorID);

                    foreach (var q in tcic)
                    {
                        decimal discTemp = 0;
                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                            discTemp = q.DiscountAmount.Value;

                        if (q.TransactionNo == cc.TransactionNo && q.SequenceNo == cc.SequenceNo)
                        {
                            int? coaId = 0;
                            int? subLedgerId = 0;
                            int? coaDiscId = 0;
                            int? subLedgerDiscId = 0;


                            ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                            itemComp.Query.Where(itemComp.Query.ServiceUnitID == tc.ToServiceUnitID,
                                                 itemComp.Query.ItemID == cc.ItemID,
                                                 itemComp.Query.TariffComponentID == q.TariffComponentID,
                                                 itemComp.Query.SRRegistrationType == regType,
                                                 itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);

                            if (itemComp.Query.Load())
                            {
                                if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                {
                                    coaId = itemComp.ChartOfAccountIdIncome.Value;
                                    subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                }

                                if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                {
                                    coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                    subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                }

                            }

                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                            {
                                if (coaId == 0)
                                {
                                    ItemDescription = string.Format("Chart Of Account for Item: {0}, Tariff component: {1}, Registration Type: {2} on Service Unit: {3} has not been set. ", cc.ItemID, q.TariffComponentID, regType, tc.ToServiceUnitID);
                                    return;
                                }
                            }
                            else
                            {
                                if (coaId == 0 || coaDiscId == 0)
                                {
                                    ItemDescription = string.Format("Chart Of Account for Item: {0}, Tariff component: {1}, Registration Type: {2} on Service Unit: {3} has not been set. ", cc.ItemID, q.TariffComponentID, regType, tc.ToServiceUnitID);
                                    return;
                                }
                            }

                            Item item = new Item();
                            item.Query.Where(item.Query.ItemID == cc.ItemID);
                            item.Query.Load();

                            DataRow rowAdd = dtb.NewRow();
                            rowAdd["coaId"] = coaId;
                            rowAdd["subLedgerId"] = subLedgerId;

                            if (ci.ChargeQuantity > 0 && JournalReturn == true || ci.ChargeQuantity < 0 && JournalReturn == false)
                            {
                                rowAdd["Debit"] = Abs(q.Price * ci.ChargeQuantity) - discTemp;
                                rowAdd["Kredit"] = 0;

                            }
                            else if (ci.ChargeQuantity < 0 && JournalReturn == true || ci.ChargeQuantity > 0 && JournalReturn == false)
                            {
                                rowAdd["Debit"] = 0;
                                rowAdd["Kredit"] = Abs(q.Price * ci.ChargeQuantity) - discTemp;

                            }
                            dtb.Rows.Add(rowAdd);

                            if (q.DiscountAmount.Value > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                            {

                            }

                        }
                    }

                }
            }
            else
            {

                Item itemInv = new Item();
                itemInv.Query.Where(itemInv.Query.ItemID == cc.ItemID);
                if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                {
                    ServiceUnitProductAccountMapping proacc = new ServiceUnitProductAccountMapping();
                    if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, itemInv.ProductAccountID, reg.SRRegistrationType))
                    {
                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                        {
                            if (proacc.ChartOfAccountIdIncome == 0)
                            {
                                ItemDescription = string.Format("Chart Of Account for Item: {0}, Product Account: {1}, Registration Type: {2} on Service Unit: {3} has not been set. ", cc.ItemID, itemInv.ProductAccountID, reg.SRRegistrationType, tserviceUnit);
                                return;
                            }
                        }
                        else
                        {
                            if (proacc.ChartOfAccountIdIncome == 0 || proacc.ChartOfAccountIdDiscount == 0)
                            {
                                ItemDescription = string.Format("Chart Of Account for Item: {0}, Product Account: {1}, Registration Type: {2} on Service Unit: {3} has not been set. ", cc.ItemID, itemInv.ProductAccountID, reg.SRRegistrationType, tserviceUnit);
                                return;
                            }
                        }

                        decimal discTemp = 0;
                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                            discTemp = cc.DiscountAmount ?? 0;

                        if (itemInv.SRItemType == "11")
                        {
                            ItemProductMedic itemMedic = new ItemProductMedic();
                            itemMedic.Query.Where(itemMedic.Query.ItemID == cc.ItemID);
                            if (itemMedic.Query.Load())
                            {
                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                DataRow rowAdd = dtb.NewRow();
                                rowAdd["coaId"] = proacc.ChartOfAccountIdIncome;
                                rowAdd["subledgerId"] = proacc.SubledgerIdIncome.HasValue ? proacc.SubledgerIdIncome : 0;

                                if (isReturn == false && JournalReturn == false || isReturn == true && JournalReturn == true)
                                {
                                    rowAdd["Debit"] = 0;
                                    rowAdd["Kredit"] = Abs(cc.PatientAmount + cc.GuarantorAmount + discTemp);

                                }
                                else if (isReturn == true && JournalReturn == false || isReturn == false && JournalReturn == true)
                                {
                                    rowAdd["Debit"] = Abs(cc.PatientAmount + cc.GuarantorAmount + discTemp);
                                    rowAdd["Kredit"] = 0;
                                }
                                dtb.Rows.Add(rowAdd);



                                if (cc.DiscountAmount != 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                {
                                    // gak kepake di RSUI
                                }

                            }
                        }
                        else
                        {
                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == cc.ItemID);
                            if (itemNonMedic.Query.Load())
                            {
                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                DataRow rowAdd = dtb.NewRow();
                                rowAdd["coaId"] = proacc.ChartOfAccountIdIncome;
                                rowAdd["subledgerId"] = proacc.SubledgerIdIncome.HasValue ? proacc.SubledgerIdIncome : 0;
                                if (isReturn == false && JournalReturn == false || isReturn == true && JournalReturn == true)
                                {
                                    rowAdd["Debit"] = 0;
                                    rowAdd["Kredit"] = Abs(cc.PatientAmount + cc.GuarantorAmount + discTemp);

                                }
                                else if (isReturn == true && JournalReturn == false || isReturn == false && JournalReturn == true)
                                {
                                    rowAdd["Debit"] = Abs(cc.PatientAmount + cc.GuarantorAmount + discTemp);
                                    rowAdd["Kredit"] = 0;
                                }

                                dtb.Rows.Add(rowAdd);

                                if (cc.DiscountAmount != 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                {
                                    //gak kepake di RSUI
                                }
                            }

                        }
                    }
                }
            }
        }
        public static JournalTransactionDetailsCollection MergeIncomeJournalCashBased(JournalTransactionDetailsCollection jtdColl)
        {
            var newJtd = jtdColl.GroupBy(
                x => new
                {
                    x.JournalId,
                    x.ChartOfAccountId,
                    //x.Debit,
                    //x.Credit,
                    x.Description,
                    x.SubLedgerId,
                    x.DocumentNumber,
                    x.DocumentPageNo,
                    x.ClassID,
                    x.GuarantorID,
                    x.SupplierID,
                    x.ParamedicID,
                    x.DueDate,
                    x.ServiceUnitID,
                    x.ItemID,
                    x.DocumentNumberSequenceNo,
                    x.RegistrationNo,
                    x.IsRevenue
                }).Select(y => new JournalTransactionDetails()
                {
                    JournalId = y.Key.JournalId,
                    ChartOfAccountId = y.Key.ChartOfAccountId,
                    Description = y.Key.Description,
                    SubLedgerId = y.Key.SubLedgerId,
                    DocumentNumber = y.Key.DocumentNumber,
                    DocumentPageNo = y.Key.DocumentPageNo,
                    ClassID = y.Key.ClassID,
                    GuarantorID = y.Key.GuarantorID,
                    SupplierID = y.Key.SupplierID,
                    ParamedicID = y.Key.ParamedicID,
                    DueDate = y.Key.DueDate,
                    ServiceUnitID = y.Key.ServiceUnitID,
                    ItemID = y.Key.ItemID,
                    DocumentNumberSequenceNo = y.Key.DocumentNumberSequenceNo,
                    RegistrationNo = y.Key.RegistrationNo,
                    IsRevenue = y.Key.IsRevenue,
                    Debit = y.Sum(z => z.Debit),
                    Credit = y.Sum(z => z.Credit)
                });
            var NewJtdColl = new JournalTransactionDetailsCollection();
            foreach (var t in newJtd)
            {
                NewJtdColl.AttachEntity(t);
            }
            return NewJtdColl;
        }
        public static JournalTransactionDetailsCollection GetNewIncomeJournalCashBased(JournalTransactions jt, CostCalculation cc, Boolean JournalReturn, decimal chargeQty)
        {
            return GetNewIncomeJournalCashBased(jt, cc, JournalReturn, chargeQty, new ChartOfAccountsCollection());
        }
        public static JournalTransactionDetailsCollection GetNewIncomeJournalCashBased(JournalTransactions jt, CostCalculation cc, Boolean JournalReturn, decimal chargeQty, ChartOfAccountsCollection CoaColl)
        {
            return GetNewIncomeJournalCashBased(jt, cc, JournalReturn, chargeQty, CoaColl, false);
        }
        public static JournalTransactionDetailsCollection GetNewIncomeJournalCashBased(JournalTransactions jt, CostCalculation cc, Boolean JournalReturn, decimal chargeQty, ChartOfAccountsCollection CoaColl, bool ContinueWhenError)
        {
            return GetNewIncomeJournalCashBased(jt, cc, JournalReturn, chargeQty, CoaColl, ContinueWhenError, false, false);
        }

        public static JournalTransactionDetailsCollection GetNewIncomeJournalCashBased(JournalTransactions jt, CostCalculation cc, Boolean JournalReturn, decimal chargeQty, ChartOfAccountsCollection CoaColl,
            bool ContinueWhenError, bool IsRecursiveFromPackageJournal, bool IsProporsi)
        {
            Registration reg = new Registration();
            reg.LoadByPrimaryKey(cc.RegistrationNo);

            Guarantor guar = new Guarantor();
            guar.LoadByPrimaryKey(reg.GuarantorID);

            return GetNewIncomeJournalCashBased(jt, cc, JournalReturn, chargeQty, CoaColl,
            ContinueWhenError, IsRecursiveFromPackageJournal, IsProporsi, reg, guar);
        }

        public static JournalTransactionDetailsCollection GetNewIncomeJournalCashBasedByGurantor(JournalTransactions jt, CostCalculation cc, Boolean JournalReturn, decimal chargeQty, ChartOfAccountsCollection CoaColl,
            bool ContinueWhenError, bool IsRecursiveFromPackageJournal, bool IsProporsi, TransPayment tp)
        {
            Registration reg = new Registration();
            reg.LoadByPrimaryKey(cc.RegistrationNo);

            Guarantor guar = new Guarantor();
            guar.LoadByPrimaryKey(tp.GuarantorID);

            return GetNewIncomeJournalCashBased(jt, cc, JournalReturn, chargeQty, CoaColl,
            ContinueWhenError, IsRecursiveFromPackageJournal, IsProporsi, reg, guar);
        }

        public static JournalTransactionDetailsCollection GetNewIncomeJournalCashBased(JournalTransactions jt, CostCalculation cc, Boolean JournalReturn, decimal chargeQty, ChartOfAccountsCollection CoaColl,
            bool ContinueWhenError, bool IsRecursiveFromPackageJournal, bool IsProporsi, Registration reg, Guarantor guar)
        {
            // Guarantor Type BPJS Kapitasi hanya inventory yg dijournal (Handono 23111 Klinik MM)
            var isJournalJustInventoryItem = IsGuarantorTypeBpjsKapitasi(guar.SRGuarantorType);

            var jtdColl = new JournalTransactionDetailsCollection();

            string tserviceUnit = string.Empty;
            string tlocation = string.Empty;
            Boolean isReturn = false;

            /* RSUI minta ditambahkan info GuarantorID dan SRGuarantorType di jurnal pendapatan */
            var descAdd = string.Empty;
            //AppParameter appHI = new AppParameter();
            //appHI.LoadByPrimaryKey("HealthcareInitialAppsVersion");
            //if (appHI.ParameterValue.Equals("RSUI") || appHI.ParameterValue.Equals("RSPM"))
            //{
            //    descAdd = string.Format(" [{0}^{1}]", reg.GuarantorID, guar.SRGuarantorType);
            //}

            Patient pEnity = new Patient();
            pEnity.LoadByPrimaryKey(reg.PatientID);

            decimal packageDiff = 0;
            string packageName = string.Empty;

            TransCharges tc = new TransCharges();
            TransPrescription tp = new TransPrescription();
            if (tc.LoadByPrimaryKey(cc.TransactionNo))
            {
                tserviceUnit = tc.ToServiceUnitID;
                tlocation = tc.LocationID;

                //paket non mcu
                if (!(tc.IsPackage ?? false))
                {
                    TransChargesItem ci1 = new TransChargesItem();
                    ci1.Query.Where(ci1.Query.TransactionNo == cc.TransactionNo, ci1.Query.SequenceNo == cc.SequenceNo, ci1.Query.ItemID == cc.ItemID);
                    if (ci1.Query.Load())
                    {
                        if (!string.IsNullOrEmpty(ci1.ParentNo))
                        {
                            var ci2 = new TransChargesItem();
                            ci2.LoadByPrimaryKey(ci1.TransactionNo, ci1.ParentNo);

                            var ip = new ItemPackage();
                            ip.Query.Where(ip.Query.ItemID == ci2.ItemID, ip.Query.DetailItemID == ci1.ItemID);
                            if (ip.Query.Load())
                            {
                                tc.ToServiceUnitID = ip.ServiceUnitID;
                                tserviceUnit = tc.ToServiceUnitID;
                                tlocation = string.Empty;

                                var i = new Item();
                                i.LoadByPrimaryKey(ip.ItemID);
                                packageName = i.ItemName;
                            }
                        }
                    }
                }
                else
                {
                    TransChargesItem ci1 = new TransChargesItem();
                    ci1.Query.Where(ci1.Query.TransactionNo == cc.TransactionNo, ci1.Query.SequenceNo == cc.SequenceNo, ci1.Query.ItemID == cc.ItemID);
                    if (ci1.Query.Load())
                    {
                        if (!string.IsNullOrEmpty(ci1.ToServiceUnitID))
                        {
                            if (tserviceUnit != ci1.ToServiceUnitID)
                            {
                                tserviceUnit = ci1.ToServiceUnitID;
                                tlocation = string.Empty;
                            }
                        }
                    }
                }

                isReturn = tc.IsCorrection.Value;
            }
            else
            {
                if (tp.LoadByPrimaryKey(cc.TransactionNo))
                {
                    tserviceUnit = tp.ServiceUnitID;
                    tlocation = tp.LocationID;
                    isReturn = tp.IsPrescriptionReturn.Value;
                    // cek resep ada qty atau tidak, kalau tidak ada jangan di-jurnal
                    var tpi = new TransPrescriptionItem();
                    if (tpi.LoadByPrimaryKey(cc.TransactionNo, cc.SequenceNo))
                    {
                        if ((tpi.ResultQty ?? 0) == 0 && (tpi.LineAmount ?? 0) == 0)
                        {
                            return jtdColl;
                        }
                    }
                }
            }

            var su = new ServiceUnit();
            su.LoadByPrimaryKey(tserviceUnit);

            if (string.IsNullOrEmpty(tlocation))
                tlocation = su.GetMainLocationId(su.ServiceUnitID);

            var regType = reg.SRRegistrationType;
            if (regType == "MCU")
                regType = "OPR";

            AppParameter par = new AppParameter();
            par.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");

            Item item = new Item(); item.Query.Where(item.Query.ItemID == cc.ItemID);
            if (item.Query.Load())
            {
                AppStandardReferenceItem asr = new AppStandardReferenceItem();
                asr.Query.Where(asr.Query.StandardReferenceID == "ItemType", asr.Query.ItemID == item.SRItemType);
                if (asr.Query.Load())
                {

                }
                else
                {
                    throw new Exception("Item " + item.ItemID + " " + item.ItemName + " has no item type");
                }

                AppParameter IsPpnSalesRJ = new AppParameter();
                if (!IsPpnSalesRJ.LoadByPrimaryKey("acc_IsPpnSalesRJ"))
                    throw new Exception("App Parameter: acc_IsPpnSalesRJ: Parameter not found!!");
                AppParameter IsPpnSalesRI = new AppParameter();
                if (!IsPpnSalesRI.LoadByPrimaryKey("acc_IsPpnSalesRI"))
                    throw new Exception("App Parameter: acc_IsPpnSalesRI: Parameter not found!!");
                AppParameter IsPpnSalesRJNew = new AppParameter();
                if (!IsPpnSalesRJNew.LoadByPrimaryKey("acc_IsPpnSalesRJNew"))
                    throw new Exception("App Parameter: acc_IsPpnSalesRJNew: Parameter not found!!");
                AppParameter coaPpnSalesRJ = new AppParameter();

                var IsPackageRevenueOnMainPackage = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsPackageRevenueOnMainPackage);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.HealthcareInitialAppsVersion) == "YBRSGKP")
                {
                    // khusus YBRS dilihat berdasarkan tanggal berlaku proporsi diskon
                    IsPackageRevenueOnMainPackage &= (DateTime.ParseExact(
                        AppParameter.GetParameterValue(AppParameter.ParameterItem.DiscountProrataToRevenueDateStart),
                        "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture) <= jt.TransactionDate.Value);
                }

                var IsInventoryBySrRegServiceUnit = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsInventoryBySrRegServiceUnit);

                if (asr.ReferenceID.ToLower() == "service")
                {
                    TransChargesItem ci = new TransChargesItem();
                    ci.Query.Where(ci.Query.TransactionNo == cc.TransactionNo, ci.Query.SequenceNo == cc.SequenceNo, ci.Query.ItemID == cc.ItemID);
                    if (ci.Query.Load())
                    {

                        if (!isJournalJustInventoryItem)
                        {
                            // chargeQty tidak boleh direplace karena sudah dikurangin koreksian
                            //chargeQty = ci.ChargeQuantity.Value;
                            if (chargeQty == 0) chargeQty = ci.ChargeQuantity.Value;
                            if (chargeQty == 0) return jtdColl;

                            var tcic = new TransChargesItemCompCollection();
                            tcic.Query.Where(tcic.Query.TransactionNo == cc.TransactionNo,
                                tcic.Query.SequenceNo == cc.SequenceNo,
                                tcic.Query.Price != 0);
                            if (!tcic.LoadAll())
                            {
                                // kemungkinan belum realisasi / komponen tidak terisi / hilang ditelan bumi
                                // tarif 
                                var _defaultTariffType = Convert.ToString(AppParameter.GetParameterValue(AppParameter.ParameterItem.DefaultTariffType));
                                var _defaultTariffClass = Convert.ToString(AppParameter.GetParameterValue(AppParameter.ParameterItem.DefaultTariffClass));
                                ItemTariff tariff = (HelperMirror.GetItemTariffService(tc.ExecutionDate.Value, guar.SRTariffType, tc.ClassID, ci.ItemID) ??
                                                         HelperMirror.GetItemTariffService(tc.ExecutionDate.Value, guar.SRTariffType, _defaultTariffClass, ci.ItemID)) ??
                                                        (HelperMirror.GetItemTariffService(tc.ExecutionDate.Value, _defaultTariffType, tc.ClassID, ci.ItemID) ??
                                                         HelperMirror.GetItemTariffService(tc.ExecutionDate.Value, _defaultTariffType, _defaultTariffClass, ci.ItemID));
                                if (tariff != null)
                                {
                                    var itcColl = new ItemTariffComponentCollection();
                                    itcColl.Query.Where(itcColl.Query.SRTariffType == tariff.SRTariffType,
                                        itcColl.Query.ItemID == tariff.ItemID,
                                        itcColl.Query.ClassID == tariff.ClassID,
                                        itcColl.Query.StartingDate == tariff.StartingDate);
                                    if (itcColl.LoadAll())
                                    {
                                        // bikin tcic
                                        var ccAmount = (cc.PatientAmount.Value + cc.GuarantorAmount.Value) / (ci.ChargeQuantity ?? 1);
                                        var tAmount = itcColl.Sum(t => t.Price ?? 0);
                                        if (tAmount != 0)
                                        {
                                            foreach (var itc in itcColl)
                                            {
                                                var tcicn = tcic.AddNew();
                                                tcicn.TransactionNo = ci.TransactionNo;
                                                tcicn.SequenceNo = ci.SequenceNo;
                                                tcicn.TariffComponentID = itc.TariffComponentID;
                                                tcicn.Price = Math.Round(ccAmount * (itc.Price ?? 0) / tAmount, 2, MidpointRounding.ToEven);
                                                tcicn.CitoAmount = 0;
                                                tcicn.DiscountAmount = 0;
                                            }
                                            // hapus cito di tci supaya gak kena hitung dibawah saat bikin jurnal
                                            ci.CitoAmount = 0;
                                        }
                                    }
                                }
                            }

                            var isCompHasCito = tcic.Sum(x => x.CitoAmount ?? 0) != 0;
                            var i = 0;
                            foreach (var q in tcic)
                            {
                                decimal discTemp = 0;
                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                    discTemp = chargeQty * q.DiscountAmount.Value;

                                if (q.TransactionNo == cc.TransactionNo && q.SequenceNo == cc.SequenceNo)
                                {
                                    int? coaId = 0;
                                    int? subLedgerId = 0;
                                    int? coaDiscId = 0;
                                    int? subLedgerDiscId = 0;

                                    ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                    itemComp.Query.Where(itemComp.Query.ServiceUnitID == tserviceUnit, //tc.ToServiceUnitID,
                                                         itemComp.Query.ItemID == cc.ItemID,
                                                         itemComp.Query.TariffComponentID == q.TariffComponentID,
                                                         itemComp.Query.SRRegistrationType == regType,
                                                         itemComp.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);

                                    if (itemComp.Query.Load())
                                    {
                                        if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemComp.ChartOfAccountIdIncome.Value;
                                            subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                        }

                                        if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                        {
                                            coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                            subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                        }
                                    }

                                    if ((ci.IsPackage ?? false) && IsPackageRevenueOnMainPackage)
                                    {
                                        if (i == 0)
                                        { // walau komponen paket ada banyak tapi jurnal paket hanya dijurnal sekali
                                            var jtdpColl = new JournalTransactionDetailsCollection();
                                            var tcpColl = new TransChargesCollection();
                                            tcpColl.Query.Where(tcpColl.Query.PackageReferenceNo == ci.TransactionNo);
                                            if (tcpColl.LoadAll())
                                            {
                                                var tcipColl = new TransChargesItemCollection();
                                                tcipColl.Query.Where(tcipColl.Query.TransactionNo.In(tcpColl.Select(t => t.TransactionNo)));
                                                if (tcipColl.LoadAll())
                                                {
                                                    foreach (var tcip in tcipColl)
                                                    {
                                                        // create cc
                                                        var cCalc = new CostCalculation();
                                                        cCalc.RegistrationNo = cc.RegistrationNo;
                                                        cCalc.TransactionNo = tcip.TransactionNo;
                                                        cCalc.SequenceNo = tcip.SequenceNo;
                                                        cCalc.ItemID = tcip.ItemID;
                                                        cCalc.PatientAmount = tcip.ChargeQuantity * (tcip.Price - (tcip.DiscountAmount / (tcip.ChargeQuantity == 0 ? 1 : tcip.ChargeQuantity)));
                                                        cCalc.GuarantorAmount = 0;
                                                        cCalc.DiscountAmount = tcip.DiscountAmount;

                                                        jtdpColl.Combine(GetNewIncomeJournalCashBased(jt, cCalc, false, 0, CoaColl, true, true, IsProporsi));
                                                    }
                                                }
                                            }
                                            // selisih paket harusnya dijurnal disini
                                            var selisihPaket = jtdpColl.Where(j => j.IsRevenue).Sum(j => (j.Credit ?? 0) - (j.Debit ?? 0));
                                            selisihPaket = selisihPaket - ((cc.PatientAmount ?? 0) + (cc.GuarantorAmount ?? 0));
                                            if (selisihPaket < 0)
                                            {
                                                AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_CoaPackageDiff);
                                                var acc_CoaPkgDiff = GetCachedAccountFromParam("acc_CoaPackageDiff");

                                                JournalTransactionDetails dsl = jtdColl.AddNew();
                                                dsl.JournalId = jt.JournalId;
                                                ValidateCOA(acc_CoaPkgDiff, CoaColl, "AppParameter: acc_CoaPackageDiff", "(Selisih Paket Plus)", dsl, ContinueWhenError);
                                                //d.ChartOfAccountId = ValidateCOA(coaId.Value, CoaColl, string.Format("COA mapping of revenue: Service Unit {0} Item {1}", su.ServiceUnitName, item.ItemName), "(tab Setting Chart Of Account)");
                                                dsl.SubLedgerId = 0;
                                                dsl.TariffComponentID = q.TariffComponentID;
                                                dsl.SRRegistrationType = regType;
                                                dsl.Debit = selisihPaket > 0 ? selisihPaket : 0;
                                                dsl.Credit = selisihPaket < 0 ? selisihPaket * -1 : 0;

                                                dsl.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} {4} {5}",
                                                    tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID,
                                                    item.ItemName, string.IsNullOrEmpty(packageName) ? string.Empty : "Ref: " + packageName,
                                                    "package price difference");
                                                dsl.DocumentNumber = tc.TransactionNo;
                                                dsl.IsRevenue = true;
                                                dsl.SRBillingGroup = item.SRBillingGroup;
                                                AddMoreInfo(dsl, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, q.ParamedicID,
                                                    null, tserviceUnit, cc.ItemID, tc.RegistrationNo, q.SequenceNo);
                                            }
                                            else if (selisihPaket > 0)
                                            {
                                                AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_CoaPackageDiffMin);
                                                var acc_CoaPkgDiff = GetCachedAccountFromParam("acc_CoaPackageDiffMin");

                                                JournalTransactionDetails dsl = jtdColl.AddNew();
                                                dsl.JournalId = jt.JournalId;
                                                ValidateCOA(acc_CoaPkgDiff, CoaColl, "AppParameter: acc_CoaPackageDiffMin", "(Selisih Paket Minus)", dsl, ContinueWhenError);
                                                //d.ChartOfAccountId = ValidateCOA(coaId.Value, CoaColl, string.Format("COA mapping of revenue: Service Unit {0} Item {1}", su.ServiceUnitName, item.ItemName), "(tab Setting Chart Of Account)");
                                                dsl.SubLedgerId = 0;
                                                dsl.TariffComponentID = q.TariffComponentID;
                                                dsl.SRRegistrationType = regType;
                                                dsl.Debit = selisihPaket > 0 ? selisihPaket : 0;
                                                dsl.Credit = selisihPaket < 0 ? selisihPaket * -1 : 0;

                                                dsl.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} {4} {5}",
                                                    tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID,
                                                    item.ItemName, string.IsNullOrEmpty(packageName) ? string.Empty : "Ref: " + packageName,
                                                    "package price difference");
                                                dsl.DocumentNumber = tc.TransactionNo;
                                                dsl.IsRevenue = true;
                                                dsl.SRBillingGroup = item.SRBillingGroup;
                                                AddMoreInfo(dsl, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, q.ParamedicID,
                                                    null, tserviceUnit, cc.ItemID, tc.RegistrationNo, q.SequenceNo);
                                            }

                                            jtdColl.Combine(jtdpColl);
                                        }
                                    }
                                    else if ((ci.IsPackage ?? false) && !IsPackageRevenueOnMainPackage)
                                    {
                                        // do nothing, 
                                        // jika paket maka skip jurnal pendapatan karena pendapatannya akan diakui di row detail
                                    }
                                    else if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && !IsRecursiveFromPackageJournal)
                                    {
                                        // kalau detail paket dan revenue ada di transaksi paket utama, maka skip pendapatan detail paket
                                    }
                                    else
                                    {
                                        var ccHasValue = (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes" ? ((cc.DiscountAmount ?? 0) + (cc.DiscountAmount2 ?? 0)) : 0) != 0;
                                        ccHasValue |= ((cc.PatientAmount ?? 0) + (cc.GuarantorAmount ?? 0)) != 0;
                                        if (!ccHasValue)
                                        {
                                            // handle bug tci dan cc 0 tapi tcic tidak 0
                                        }
                                        else
                                        {
                                            JournalTransactionDetails d = jtdColl.AddNew();
                                            d.JournalId = jt.JournalId;
                                            ValidateCOA(coaId.Value, CoaColl, string.Format("COA mapping of revenue: Service Unit {0} Item {1}", su.ServiceUnitName, item.ItemName), "(tab Setting Chart Of Account)", d, ContinueWhenError);
                                            //d.ChartOfAccountId = ValidateCOA(coaId.Value, CoaColl, string.Format("COA mapping of revenue: Service Unit {0} Item {1}", su.ServiceUnitName, item.ItemName), "(tab Setting Chart Of Account)");
                                            d.SubLedgerId = subLedgerId;
                                            d.TariffComponentID = q.TariffComponentID;
                                            d.SRRegistrationType = regType;

                                            /*
                                             * Cito diambil dari TransChargesItemComp, kalau kosong baru ambil dari TransChargesItem
                                             * NOTE: Cito masih ada kemungkinan masalah jika komponen tarif lebih dari 
                                             * satu dan cito-nya tidak mecah ke tabel TransChargesItemComp
                                             */

                                            var transVal = chargeQty * (q.Price +
                                            (isCompHasCito ? q.CitoAmount : (ci.CitoAmount/*CitoAmount di TransChargesItem sudah dikali qty*// Abs(ci.ChargeQuantity) /*Abs(chargeQty)*/))) -
                                            discTemp;

                                            transVal = transVal * (JournalReturn ? -1 : 1);
                                            d.Debit = transVal < 0 ? transVal * -1 : 0;
                                            d.Credit = transVal > 0 ? transVal : 0;

                                            //    //* d.Credit = Abs(q.Price * chargeQty) + ci.CitoAmount - discTemp;
                                            //    /*
                                            //     * script diatas yang dikasi tanda //* saya remark karena untuk item tariff
                                            //     * cito yang memiliki 2 komponen, jurnalnya cito terhitung 2x sejumlah ci.CitoAmount
                                            //     * harusnya bisa langsung ambil nilai cito yang sudah dipecah per komponen q.CitoAmount
                                            //     * supaya tidak terhitung double lagi, tetapi sepertinya cito yang ada di komponen tidak selalu terisi
                                            //     * karena itu jika cito di komponen tidak terisi maka saya ambil dari cito yang ada di table
                                            //     * transchargesitem. ini berarti masih ada kemungkinan cito akan terhitung 2x jika komponennya ada 2 dan citonya tidak terpecah kedalam tabel komponen
                                            //     */
                                            //    d.Credit = Abs(q.Price * chargeQty) + (q.CitoAmount.HasValue ? (q.CitoAmount > 0 ? q.CitoAmount : ci.CitoAmount) : ci.CitoAmount) - discTemp;
                                            //}
                                            // end of modif teguh s 2016 06 02

                                            d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} {4}{5}",
                                                tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID,
                                                item.ItemName, string.IsNullOrEmpty(packageName) ? string.Empty : "Ref: " + packageName,
                                                descAdd);
                                            d.DocumentNumber = tc.TransactionNo;
                                            d.IsRevenue = true;
                                            d.IsProrataDiscToRevenue = IsProporsi;
                                            d.SRBillingGroup = item.SRBillingGroup;
                                            AddMoreInfo(d, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, q.ParamedicID,
                                                null, tserviceUnit, cc.ItemID, tc.RegistrationNo, q.SequenceNo);
                                        }
                                    }

                                    if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && !IsRecursiveFromPackageJournal)
                                    {
                                        // kalau detail paket dan revenue ada di transaksi paket utama, maka skip pendapatan detail paket, skip juga diskon pendapatan
                                    }
                                    else
                                    {
                                        if (q.DiscountAmount.Value > 0)
                                        {
                                            if ((tc.IsPackage ?? false) && IsPackageRevenueOnMainPackage)
                                            {
                                                // jika transaksi paket dan revenue ada di paket utama
                                            }
                                            else
                                            {
                                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                                {
                                                    JournalTransactionDetails disc = jtdColl.AddNew();
                                                    disc.JournalId = jt.JournalId;
                                                    ValidateCOA(coaDiscId.Value, CoaColl, string.Format("COA mapping of discount: Service Unit {0} Item {1}", su.ServiceUnitName, item.ItemName), "(tab Setting Chart Of Account)", disc, ContinueWhenError);
                                                    //disc.ChartOfAccountId = ValidateCOA(coaDiscId.Value, CoaColl, string.Format("COA mapping of discount: Service Unit {0} Item {1}", su.ServiceUnitName, item.ItemName), "(tab Setting Chart Of Account)");
                                                    disc.SubLedgerId = subLedgerDiscId;
                                                    disc.TariffComponentID = q.TariffComponentID;
                                                    disc.SRRegistrationType = regType;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    var discVal = q.DiscountAmount.Value * chargeQty;
                                                    discVal = discVal * (JournalReturn ? -1 : 1);
                                                    disc.Debit = discVal > 0 ? discVal : 0;
                                                    disc.Credit = discVal < 0 ? discVal * -1 : 0;
                                                    // end of modif teguh s 2016 06 02
                                                    disc.IsRevenue = true;
                                                    disc.SRBillingGroup = item.SRBillingGroup;
                                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} {4}{5}",
                                                        tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName,
                                                        string.IsNullOrEmpty(packageName) ? string.Empty : "Ref: " + packageName,
                                                        descAdd);
                                                    disc.DocumentNumber = tc.TransactionNo;

                                                    AddMoreInfo(disc, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, q.ParamedicID,
                                                    null, tserviceUnit, cc.ItemID, tc.RegistrationNo, q.SequenceNo);
                                                }
                                            }
                                        }
                                    }
                                }
                                i++;
                            }
                        }
                        if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && IsRecursiveFromPackageJournal)
                        {
                            // ignore 
                        }
                        else
                        {
                            //COST FOR CONSUMPTION
                            TransChargesItemConsumptionCollection consColl = new TransChargesItemConsumptionCollection();
                            consColl.Query.Where(
                                consColl.Query.TransactionNo == cc.TransactionNo,
                                consColl.Query.SequenceNo == cc.SequenceNo);

                            if (consColl.LoadAll() && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                            {
                                foreach (var cons in consColl)
                                {
                                    Item itemInv = new Item();
                                    itemInv.Query.Where(itemInv.Query.ItemID == cons.DetailItemID);
                                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                    {
                                        //
                                        int coaID = 0, scoaID = 0, cogsID = 0, scogsID = 0, icoaID = 0, sinvID = 0, discID = 0, sdiscID = 0;

                                        var sMappingSource = (par.ParameterValue == "Yes") ?
                                            "ServiceUnitProductAccountMapping" : ("ProductAccount " + item.ProductAccountID);
                                        ServiceUnitProductAccountMapping proacc = new ServiceUnitProductAccountMapping();
                                        if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, itemInv.ProductAccountID, reg.SRRegistrationType) && (par.ParameterValue == "Yes"))
                                        {
                                            coaID = proacc.ChartOfAccountIdIncome ?? 0;
                                            scoaID = proacc.SubledgerIdIncome ?? 0;
                                            cogsID = proacc.ChartOfAccountIdCOGS ?? 0;
                                            scogsID = proacc.SubledgerIdCOGS ?? 0;
                                            icoaID = proacc.ChartOfAccountIdInventory ?? 0;
                                            sinvID = proacc.SubledgerIdInventory ?? 0;
                                            discID = proacc.ChartOfAccountIdDiscount ?? 0;
                                            sdiscID = proacc.SubledgerIdDiscount ?? 0;
                                            //sMappingSource = "ServiceUnitProductAccountMapping";
                                            if (IsInventoryBySrRegServiceUnit && (reg.SRRegistrationType != su.SRRegistrationType))
                                            {
                                                proacc = new ServiceUnitProductAccountMapping();
                                                if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, itemInv.ProductAccountID,
                                                    string.IsNullOrEmpty(su.SRRegistrationType) ? "OPR" : su.SRRegistrationType))
                                                {
                                                    icoaID = proacc.ChartOfAccountIdInventory ?? 0;
                                                    sinvID = proacc.SubledgerIdInventory ?? 0;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            var pacc = new ProductAccountGuarantorGroup();
                                            var pac = new ProductAccount();
                                            pac.LoadByPrimaryKey(itemInv.ProductAccountID);
                                            pacc.Query.Where(pacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                                pacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                                            if (pacc.Load(pacc.Query))
                                            {
                                                coaID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdIncome ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdIncomeIP ?? 0 : pacc.ChartOfAccountIdIncomeIGD ?? 0);
                                                scoaID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdIncome ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdIncomeIP ?? 0 : pacc.SubledgerIdIncomeIGD ?? 0);
                                                cogsID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdCOGS ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdCOGSIP ?? 0 : pacc.ChartOfAccountIdCOGSIGD ?? 0);
                                                scogsID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdCOGS ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdCOGSIP ?? 0 : pacc.SubledgerIdCOGSIGD ?? 0);
                                                icoaID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdInventory ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdInventoryIP ?? 0 : pacc.ChartOfAccountIdInventoryIGD ?? 0);
                                                sinvID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdInventory ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdInventoryIP ?? 0 : pacc.SubledgerIdInventoryIGD ?? 0);
                                                discID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdDiscount ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdDiscountIP ?? 0 : pacc.ChartOfAccountIdDiscountIGD ?? 0);
                                                sdiscID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdDiscount ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdDiscountIP ?? 0 : pacc.SubledgerIdDiscountIGD ?? 0);
                                                sMappingSource = "ProductAccount " + pac.ProductAccountName;
                                                if (IsInventoryBySrRegServiceUnit && (reg.SRRegistrationType != su.SRRegistrationType))
                                                {
                                                    icoaID = su.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdInventory ?? 0 : (su.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdInventoryIP ?? 0 : pacc.ChartOfAccountIdInventoryIGD ?? 0);
                                                    sinvID = su.SRRegistrationType == "OPR" ? pacc.SubledgerIdInventory ?? 0 : (su.SRRegistrationType == "IPR" ? pacc.SubledgerIdInventoryIP ?? 0 : pacc.SubledgerIdInventoryIGD ?? 0);
                                                }
                                            }
                                        }

                                        if (itemInv.SRItemType == "11")
                                        {
                                            ItemProductMedic itemMedic = new ItemProductMedic();
                                            itemMedic.Query.Where(itemMedic.Query.ItemID == cons.DetailItemID);
                                            if (itemMedic.Query.Load())
                                            {
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == cons.TransactionNo, mov.SequenceNo == cons.SequenceNo, mov.ItemID == cons.DetailItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                // COGS FOR CONSUMPTION
                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    JournalTransactionDetails itemMedicCogs = jtdColl.AddNew();
                                                    itemMedicCogs.JournalId = jt.JournalId;
                                                    ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS", "", itemMedicCogs, ContinueWhenError);
                                                    //itemMedicCogs.ChartOfAccountId = ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS");
                                                    itemMedicCogs.SubLedgerId = scogsID;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    cogs = cogs * (JournalReturn ? -1 : 1);
                                                    itemMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                                    itemMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, cc.ItemID);
                                                    itemMedicCogs.DocumentNumber = tc.TransactionNo;
                                                    itemMedicCogs.IsRevenue = false;
                                                    AddMoreInfo(itemMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, cons.DetailItemID, tc.RegistrationNo, cc.SequenceNo);


                                                    JournalTransactionDetails itemMedicInv = jtdColl.AddNew();
                                                    itemMedicInv.JournalId = jt.JournalId;
                                                    ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory", "", itemMedicInv, ContinueWhenError);
                                                    //itemMedicInv.ChartOfAccountId = ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory"); ;
                                                    itemMedicInv.SubLedgerId = sinvID;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    itemMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                                    itemMedicInv.Credit = cogs > 0 ? cogs : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{5}",
                                                        tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID,
                                                        itemInv.ItemName, cc.ItemID, descAdd);
                                                    itemMedicInv.DocumentNumber = tc.TransactionNo;

                                                    //itemMedicInv.ClassID = tc.ClassID;
                                                    //itemMedicInv.GuarantorID = reg.GuarantorID;
                                                    //itemMedicInv.ParamedicID = string.Empty;
                                                    //itemMedicInv.ServiceUnitID = tc.ToServiceUnitID;
                                                    //itemMedicInv.ItemID = cc.ItemID;
                                                    itemMedicInv.IsRevenue = false;
                                                    AddMoreInfo(itemMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, cons.DetailItemID, tc.RegistrationNo, cc.SequenceNo);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == cons.DetailItemID);
                                            if (itemNonMedic.Query.Load())
                                            {
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == cons.TransactionNo, mov.SequenceNo == cons.SequenceNo, mov.ItemID == cons.DetailItemID);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                // COGS FOR CONSUMPTION
                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    JournalTransactionDetails itemNonMedicCogs = jtdColl.AddNew();
                                                    itemNonMedicCogs.AddNew();
                                                    itemNonMedicCogs.JournalId = jt.JournalId;
                                                    ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS", "", itemNonMedicCogs, ContinueWhenError);
                                                    //itemNonMedicCogs.ChartOfAccountId = ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS");
                                                    itemNonMedicCogs.SubLedgerId = scogsID;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    cogs = cogs * (JournalReturn ? -1 : 1);
                                                    itemNonMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                                    itemNonMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemNonMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{5}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, cc.ItemID, descAdd);
                                                    itemNonMedicCogs.DocumentNumber = tc.TransactionNo;
                                                    itemNonMedicCogs.IsRevenue = false;
                                                    AddMoreInfo(itemNonMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, cons.DetailItemID, tc.RegistrationNo, cc.SequenceNo);

                                                    JournalTransactionDetails itemNonMedicInv = jtdColl.AddNew();
                                                    itemNonMedicInv.AddNew();
                                                    itemNonMedicInv.JournalId = jt.JournalId;
                                                    ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory", "", itemNonMedicInv, ContinueWhenError);
                                                    //itemNonMedicInv.ChartOfAccountId = ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory"); ;
                                                    itemNonMedicInv.SubLedgerId = sinvID;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    itemNonMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                                    itemNonMedicInv.Credit = cogs > 0 ? cogs : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemNonMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{5}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, cc.ItemID, descAdd);
                                                    itemNonMedicInv.DocumentNumber = tc.TransactionNo;
                                                    itemNonMedicInv.IsRevenue = false;
                                                    AddMoreInfo(itemNonMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, cons.DetailItemID, tc.RegistrationNo, cc.SequenceNo);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // jika ada selisih jurnal revenue dan jumlah costcalculation kurang dari 1 rp itu karena pembulatan kriting di komponen tarif
                        // dibulatkan saja ke salah satu revenue
                        var jtdCC = jtdColl.Where(j => j.DocumentNumber == cc.TransactionNo && j.DocumentNumberSequenceNo == cc.SequenceNo && j.IsRevenue);
                        if (jtdCC.Count() > 0)
                        {
                            var tRev = jtdCC.Sum(j => (j.Credit ?? 0) - (j.Debit));
                            var sPembulatan = tRev - (cc.GuarantorAmount ?? 0) - (cc.PatientAmount ?? 0);
                            if (Abs(sPembulatan) > 0 && Abs(sPembulatan) < 1)
                            {
                                var jtdCcC = jtdCC.Where(j => j.Credit != 0).FirstOrDefault();
                                if (jtdCcC != null)
                                {
                                    jtdCcC.Credit -= sPembulatan;
                                }
                                else
                                {
                                    var jtdCcD = jtdCC.Where(j => j.Debit != 0).FirstOrDefault();
                                    if (jtdCcD != null)
                                    {
                                        jtdCcC.Debit += sPembulatan;
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    string sRoomID = "", sBedID = "", sClassID;
                    if (tp.ClassID == null)
                    {
                        sClassID = tc.ClassID;
                        sRoomID = tc.RoomID;
                        sBedID = tc.BedID;
                    }
                    else
                    {
                        sClassID = tp.ClassID;
                        sRoomID = (tp.FromRoomID ?? tp.FromServiceUnitID) ?? tp.ServiceUnitID;
                        sBedID = tp.FromBedID;
                    }

                    int coaID = 0, scoaID = 0, cogsID = 0, scogsID = 0, icoaID = 0, sinvID = 0, discID = 0, sdiscID = 0;
                    if (item.ProductAccountID != null)
                    {
                        var sMappingSource = (par.ParameterValue == "Yes") ?
                            "ServiceUnitProductAccountMapping" : ("ProductAccount " + item.ProductAccountID);
                        ServiceUnitProductAccountMapping proacc = new ServiceUnitProductAccountMapping();
                        if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, item.ProductAccountID, reg.SRRegistrationType) && (par.ParameterValue == "Yes"))
                        {
                            coaID = proacc.ChartOfAccountIdIncome ?? 0;
                            scoaID = proacc.SubledgerIdIncome ?? 0;
                            cogsID = proacc.ChartOfAccountIdCOGS ?? 0;
                            scogsID = proacc.SubledgerIdCOGS ?? 0;
                            icoaID = proacc.ChartOfAccountIdInventory ?? 0;
                            sinvID = proacc.SubledgerIdInventory ?? 0;
                            discID = proacc.ChartOfAccountIdDiscount ?? 0;
                            sdiscID = proacc.SubledgerIdDiscount ?? 0;
                            //sMappingSource = "ServiceUnitProductAccountMapping";
                            if (IsInventoryBySrRegServiceUnit && (reg.SRRegistrationType != su.SRRegistrationType))
                            {
                                proacc = new ServiceUnitProductAccountMapping();
                                if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, item.ProductAccountID,
                                    string.IsNullOrEmpty(su.SRRegistrationType) ? "OPR" : su.SRRegistrationType))
                                {
                                    icoaID = proacc.ChartOfAccountIdInventory ?? 0;
                                    sinvID = proacc.SubledgerIdInventory ?? 0;
                                }
                            }
                        }
                        else
                        {
                            var pacc = new ProductAccountGuarantorGroup();
                            var pac = new ProductAccount();
                            pac.LoadByPrimaryKey(item.ProductAccountID);
                            pacc.Query.Where(pacc.Query.ProductAccountID == item.ProductAccountID,
                                pacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                            if (pacc.Load(pacc.Query))
                            {
                                coaID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdIncome ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdIncomeIP ?? 0 : pacc.ChartOfAccountIdIncomeIGD ?? 0);
                                scoaID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdIncome ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdIncomeIP ?? 0 : pacc.SubledgerIdIncomeIGD ?? 0);
                                cogsID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdCOGS ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdCOGSIP ?? 0 : pacc.ChartOfAccountIdCOGSIGD ?? 0);
                                scogsID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdCOGS ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdCOGSIP ?? 0 : pacc.SubledgerIdCOGSIGD ?? 0);
                                icoaID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdInventory ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdInventoryIP ?? 0 : pacc.ChartOfAccountIdInventoryIGD ?? 0);
                                sinvID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdInventory ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdInventoryIP ?? 0 : pacc.SubledgerIdInventoryIGD ?? 0);
                                discID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdDiscount ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdDiscountIP ?? 0 : pacc.ChartOfAccountIdDiscountIGD ?? 0);
                                sdiscID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdDiscount ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdDiscountIP ?? 0 : pacc.SubledgerIdDiscountIGD ?? 0);
                                sMappingSource = "ProductAccount " + pac.ProductAccountName;
                                if (IsInventoryBySrRegServiceUnit && (reg.SRRegistrationType != su.SRRegistrationType))
                                {
                                    icoaID = su.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdInventory ?? 0 : (su.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdInventoryIP ?? 0 : pacc.ChartOfAccountIdInventoryIGD ?? 0);
                                    sinvID = su.SRRegistrationType == "OPR" ? pacc.SubledgerIdInventory ?? 0 : (su.SRRegistrationType == "IPR" ? pacc.SubledgerIdInventoryIP ?? 0 : pacc.SubledgerIdInventoryIGD ?? 0);
                                }
                            }
                        }

                        decimal discTemp = 0;
                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                            discTemp = cc.DiscountAmount ?? 0;

                        var app = new AppParameter();
                        app.LoadByPrimaryKey("ItemProductCostPriceType");

                        if (item.SRItemType == "11")
                        {
                            // JournalTransactionDetails: itemMedicIncome, ppnSales, disc, itemMedicCogs, itemMedicInv
                            ItemProductMedic itemMedic = new ItemProductMedic();
                            itemMedic.Query.Where(itemMedic.Query.ItemID == cc.ItemID);
                            if (itemMedic.Query.Load())
                            {
                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                var paramPpnPctg = new AppParameter();
                                if (!paramPpnPctg.LoadByPrimaryKey("Ppn"))
                                {
                                    throw new Exception("Appparameter Ppn is undefined");
                                }
                                decimal ppnVal = System.Convert.ToDecimal(paramPpnPctg.ParameterValue);

                                var ccVal = cc.PatientAmount + cc.GuarantorAmount + discTemp;
                                decimal ccValPPN = 0;
                                if (reg.SRRegistrationType.Equals("IPR"))
                                {
                                    if (IsPpnSalesRI.ParameterValue.Equals("Yes"))
                                        ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                }
                                else
                                {
                                    if (IsPpnSalesRJ.ParameterValue.Equals("Yes") && IsPpnSalesRJNew.ParameterValue.Equals("Yes"))
                                    {
                                        ProductAccount ppac = new ProductAccount();
                                        ppac.LoadByPrimaryKey(item.ProductAccountID);
                                        ppac.Query.Where(ppac.Query.ProductAccountID == item.ProductAccountID);
                                        if (!tc.LoadByPrimaryKey(cc.TransactionNo) && ppac.IsPpnOpr == true || ppac.IsPpnEmr == true)
                                            ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                    }

                                    if (IsPpnSalesRJ.ParameterValue.Equals("Yes") && IsPpnSalesRJNew.ParameterValue.Equals("No"))
                                        ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); // Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                }
                                ccVal = ccVal - ccValPPN;

                                if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && !IsRecursiveFromPackageJournal)
                                {
                                    // ignore
                                }
                                else
                                {
                                    if (!isJournalJustInventoryItem)
                                    {
                                        JournalTransactionDetails itemMedicIncome = jtdColl.AddNew();
                                        itemMedicIncome.JournalId = jt.JournalId;
                                        ValidateCOA(coaID, CoaColl, sMappingSource + ": Revenue", "", itemMedicIncome, ContinueWhenError);
                                        //itemMedicIncome.ChartOfAccountId = ValidateCOA(coaID, CoaColl, sMappingSource + ": Revenue");
                                        itemMedicIncome.SubLedgerId = scoaID;
                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        ccVal = ccVal * (JournalReturn ? -1 : 1);
                                        itemMedicIncome.Debit = ccVal < 0 ? ccVal * -1 : 0;
                                        itemMedicIncome.Credit = ccVal > 0 ? ccVal : 0;
                                        // end of modif teguh s 2016 06 02

                                        itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                        itemMedicIncome.DocumentNumber = cc.TransactionNo;
                                        itemMedicIncome.IsRevenue = true;
                                        itemMedicIncome.IsProrataDiscToRevenue = IsProporsi;
                                        itemMedicIncome.SRBillingGroup = item.SRBillingGroup;

                                        AddMoreInfo(itemMedicIncome, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                            string.Empty, string.Empty, null,
                                            su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);

                                        if (ccValPPN != 0)
                                        {
                                            JournalTransactionDetails ppnSales = jtdColl.AddNew();
                                            ppnSales.JournalId = jt.JournalId;
                                            ValidateCOA(
                                                GetCachedAccountFromParam(reg.SRRegistrationType.Equals("IPR") ? "coa_PpnSalesRI" : "coa_PpnSalesRJ"),
                                                CoaColl, string.Format("App Parameter: {0}", reg.SRRegistrationType.Equals("IPR") ? "coa_PpnSalesRI" : "coa_PpnSalesRJ"), "", ppnSales, ContinueWhenError);
                                            //ppnSales.ChartOfAccountId = ValidateCOA(
                                            //    GetCachedAccountFromParam(reg.SRRegistrationType.Equals("IPR") ? "coa_PpnSalesRI" : "coa_PpnSalesRJ"),
                                            //    CoaColl, string.Format("App Parameter: {0}", reg.SRRegistrationType.Equals("IPR") ? "coa_PpnSalesRI" : "coa_PpnSalesRJ"));
                                            ppnSales.SubLedgerId = scoaID;
                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            ccValPPN = ccValPPN * (JournalReturn ? -1 : 1);
                                            ppnSales.Debit = ccValPPN < 0 ? ccValPPN * -1 : 0;
                                            ppnSales.Credit = ccValPPN > 0 ? ccValPPN : 0;
                                            // end of modif teguh s 2016 06 02

                                            ppnSales.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}{5}", tc.RegistrationNo ?? tp.RegistrationNo,
                                                pEnity.PatientName, cc.ItemID, item.ItemName, descAdd, " Sales tax");
                                            ppnSales.DocumentNumber = cc.TransactionNo;
                                            ppnSales.IsRevenue = true;
                                            ppnSales.IsProrataDiscToRevenue = IsProporsi;
                                            ppnSales.SRBillingGroup = item.SRBillingGroup;
                                            AddMoreInfo(ppnSales, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                                string.Empty, string.Empty, null,
                                                su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        }

                                        if (cc.DiscountAmount != 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                        {
                                            JournalTransactionDetails disc = jtdColl.AddNew();
                                            disc.JournalId = jt.JournalId;
                                            ValidateCOA(discID, CoaColl, sMappingSource + ": Discount", "", disc, ContinueWhenError);
                                            //disc.ChartOfAccountId = ValidateCOA(discID, CoaColl, sMappingSource + ": Discount");
                                            disc.SubLedgerId = sdiscID;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            var discVal = cc.DiscountAmount.Value;
                                            discVal = discVal * (JournalReturn ? -1 : 1);
                                            disc.Debit = discVal > 0 ? discVal : 0;
                                            disc.Credit = discVal < 0 ? discVal * -1 : 0;
                                            // end of modif teguh s 2016 06 02

                                            disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                            disc.DocumentNumber = cc.TransactionNo;
                                            disc.IsRevenue = true;
                                            disc.SRBillingGroup = item.SRBillingGroup;
                                            AddMoreInfo(disc, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                                string.Empty, string.Empty, null,
                                                su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        }
                                    }
                                }

                                if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && IsRecursiveFromPackageJournal)
                                {
                                    // ignore 
                                }
                                else
                                {
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                    {
                                        /* karena Qty in & Qty Out tidak mungkin nilainya 0 secara bersamaan maka tidak masalah ditambah */
                                        DataTable tbl = new DataTable();
                                        ItemMovementQuery mov = new ItemMovementQuery();
                                        mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                   mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                        mov.Where(mov.TransactionNo == cc.TransactionNo, mov.SequenceNo == cc.SequenceNo,
                                                  mov.ItemID == cc.ItemID);
                                        mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                        tbl = mov.LoadDataTable();

                                        foreach (DataRow row in tbl.Rows)
                                        {

                                            decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];
                                            if ((decimal)row["Quantity"] == 0) continue;

                                            //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                            JournalTransactionDetails itemMedicCogs = jtdColl.AddNew();
                                            itemMedicCogs.JournalId = jt.JournalId;
                                            ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS", "", itemMedicCogs, ContinueWhenError);
                                            //itemMedicCogs.ChartOfAccountId = ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS");
                                            itemMedicCogs.SubLedgerId = scogsID;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            cogs = cogs * (JournalReturn ? -1 : 1);
                                            itemMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                            itemMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                            // end of modif teguh s 2016 06 02

                                            itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}",
                                                                                      tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                                      cc.ItemID, item.ItemName, descAdd);
                                            itemMedicCogs.DocumentNumber = cc.TransactionNo;
                                            itemMedicCogs.IsRevenue = false;
                                            AddMoreInfo(itemMedicCogs, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                                string.Empty, string.Empty, null,
                                                su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);

                                            JournalTransactionDetails itemMedicInv = jtdColl.AddNew();
                                            itemMedicInv.JournalId = jt.JournalId;
                                            ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory", "", itemMedicInv, ContinueWhenError);
                                            //itemMedicInv.ChartOfAccountId = ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory");
                                            itemMedicInv.SubLedgerId = sinvID;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            itemMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                            itemMedicInv.Credit = cogs > 0 ? cogs : 0;
                                            // end of modif teguh s 2016 06 02

                                            itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}",
                                                                                     tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                                     cc.ItemID, item.ItemName, descAdd);
                                            itemMedicInv.DocumentNumber = cc.TransactionNo;
                                            itemMedicInv.IsRevenue = false;
                                            AddMoreInfo(itemMedicInv, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                                string.Empty, string.Empty, null,
                                                su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            bool isExist = false;
                            ItemProductNonMedic inm = new ItemProductNonMedic();
                            inm.Query.Where(inm.Query.ItemID == cc.ItemID);
                            if (inm.Query.Load())
                            {
                                isExist = true;
                            }
                            else
                            {
                                ItemKitchen itemKitchen = new ItemKitchen();
                                itemKitchen.Query.Where(itemKitchen.Query.ItemID == cc.ItemID);
                                if (itemKitchen.Query.Load())
                                {
                                    isExist = true;
                                }
                            }

                            {
                                var ccVal = cc.PatientAmount + cc.GuarantorAmount + discTemp;
                                var ccValPPN = 0;
                                if (reg.SRRegistrationType.Equals("IPR"))
                                {
                                    if (IsPpnSalesRI.Equals("Yes"))
                                        Math.Round(ccVal.Value * (decimal)0.1, 2);
                                }
                                else
                                {
                                    if (IsPpnSalesRJ.Equals("Yes"))
                                        Math.Round(ccVal.Value * (decimal)0.1, 2);
                                }
                                ccVal = ccVal - ccValPPN;

                                if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && !IsRecursiveFromPackageJournal)
                                {
                                    // ignore
                                }
                                else
                                {
                                    JournalTransactionDetails itemNonMedicIncome = jtdColl.AddNew();
                                    itemNonMedicIncome.JournalId = jt.JournalId;
                                    ValidateCOA(coaID, CoaColl, sMappingSource + ": Revenue", "", itemNonMedicIncome, ContinueWhenError);
                                    //itemNonMedicIncome.ChartOfAccountId = ValidateCOA(coaID, CoaColl, sMappingSource + ": Revenue");
                                    itemNonMedicIncome.SubLedgerId = scoaID;

                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                    //var ccVal = cc.PatientAmount + cc.GuarantorAmount + discTemp;
                                    ccVal = ccVal * (JournalReturn ? -1 : 1);
                                    ccValPPN = ccValPPN * (JournalReturn ? -1 : 1);
                                    itemNonMedicIncome.Debit = ccVal < 0 ? ccVal * -1 : 0;
                                    itemNonMedicIncome.Credit = ccVal > 0 ? ccVal : 0;
                                    // end of modif teguh s 2016 06 02

                                    itemNonMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                    itemNonMedicIncome.DocumentNumber = cc.TransactionNo;
                                    itemNonMedicIncome.IsRevenue = true;
                                    itemNonMedicIncome.IsProrataDiscToRevenue = IsProporsi;
                                    itemNonMedicIncome.SRBillingGroup = item.SRBillingGroup;
                                    AddMoreInfo(itemNonMedicIncome, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                        string.Empty, string.Empty, null,
                                        su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);

                                    if (cc.DiscountAmount != 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                    {
                                        JournalTransactionDetails disc = jtdColl.AddNew();
                                        disc.JournalId = jt.JournalId;
                                        ValidateCOA(discID, CoaColl, sMappingSource + ": Discount", "", disc, ContinueWhenError);
                                        //disc.ChartOfAccountId = ValidateCOA(discID, CoaColl, sMappingSource + ": Discount");
                                        disc.SubLedgerId = sdiscID;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var discVal = cc.DiscountAmount.Value;
                                        discVal = discVal * (JournalReturn ? -1 : 1);
                                        disc.Debit = discVal > 0 ? discVal : 0;
                                        disc.Credit = discVal < 0 ? discVal * -1 : 0;
                                        // end of modif teguh s 2016 06 02

                                        disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                        disc.DocumentNumber = cc.TransactionNo;
                                        disc.IsRevenue = true;
                                        disc.SRBillingGroup = item.SRBillingGroup;
                                        AddMoreInfo(disc, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                            string.Empty, string.Empty, null,
                                            su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                    }
                                }

                                if (!string.IsNullOrEmpty(tc.PackageReferenceNo) && IsPackageRevenueOnMainPackage && IsRecursiveFromPackageJournal)
                                {
                                    // ignore
                                }
                                else
                                {
                                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                    {
                                        DataTable tbl = new DataTable();

                                        ItemMovementQuery mov = new ItemMovementQuery();
                                        mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                   mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                        mov.Where(mov.TransactionNo == cc.TransactionNo, mov.SequenceNo == cc.SequenceNo,
                                                  mov.ItemID == cc.ItemID);
                                        mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                        tbl = mov.LoadDataTable();

                                        foreach (DataRow row in tbl.Rows)
                                        {
                                            decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                            JournalTransactionDetails itemNonMedicCogs = jtdColl.AddNew();
                                            itemNonMedicCogs.JournalId = jt.JournalId;
                                            ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS", "", itemNonMedicCogs, ContinueWhenError);
                                            //itemNonMedicCogs.ChartOfAccountId = ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS");
                                            itemNonMedicCogs.SubLedgerId = scogsID;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            cogs = cogs * (JournalReturn ? -1 : 1);
                                            itemNonMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                            itemNonMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                            // end of modif teguh s 2016 06 02

                                            itemNonMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                            itemNonMedicCogs.DocumentNumber = cc.TransactionNo;
                                            itemNonMedicCogs.IsRevenue = false;
                                            AddMoreInfo(itemNonMedicCogs, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                                string.Empty, string.Empty, null,
                                                su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);

                                            JournalTransactionDetails itemNonMedicInv = jtdColl.AddNew();
                                            itemNonMedicInv.JournalId = jt.JournalId;
                                            ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory", "", itemNonMedicInv, ContinueWhenError);
                                            //itemNonMedicInv.ChartOfAccountId = ValidateCOA(icoaID, CoaColl, sMappingSource + ": Inventory");
                                            itemNonMedicInv.SubLedgerId = sinvID;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            itemNonMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                            itemNonMedicInv.Credit = cogs > 0 ? cogs : 0;
                                            // end of modif teguh s 2016 06 02

                                            itemNonMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                            itemNonMedicInv.DocumentNumber = cc.TransactionNo;
                                            itemNonMedicInv.IsRevenue = false;
                                            AddMoreInfo(itemNonMedicInv, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                                string.Empty, string.Empty, null,
                                                su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return jtdColl;
            //return MergeIncomeJournalCashBased(jtdColl);
        }

        public static JournalTransactionDetailsCollection GetNewIncomeAdjustProrataCashBased(JournalTransactions jt,
            string PaymentNo, decimal AdjAmount, string AdjNotePrefix, ChartOfAccountsCollection CoaColl)
        {
            var jtdCcpColl = new JournalTransactionDetailsCollection();

            string tserviceUnit = string.Empty;
            string tlocation = string.Empty;
            Boolean isReturn = false;

            var ccColl = new CostCalculationCollection();
            var ccq = new CostCalculationQuery("cc");
            var tpiibgq = new TransPaymentItemIntermBillGuarantorQuery("tpiibg");
            ccq.InnerJoin(tpiibgq).On(ccq.IntermBillNo == tpiibgq.IntermBillNo)
                .Where(tpiibgq.PaymentNo == PaymentNo)
                .Select(ccq);

            if (ccColl.Load(ccq))
            {
                var ccpColl = new CostcalculationProrataCollection();
                var ccSum = ccColl.Sum(cc => (cc.PatientAmount ?? 0) + (cc.GuarantorAmount ?? 0));
                foreach (var cc in ccColl)
                {
                    var ccp = ccpColl.AddNew();
                    ccp.PaymentNo = PaymentNo;
                    ccp.TransactionNo = cc.TransactionNo;
                    ccp.SequenceNo = cc.SequenceNo;
                    ccp.Amount = AdjAmount / ccSum * ((cc.PatientAmount ?? 0) + (cc.GuarantorAmount ?? 0));
                    ccp.Amount = Math.Round((ccp.Amount ?? 0), 2, MidpointRounding.AwayFromZero);
                }
                var sisa = AdjAmount - ccpColl.Sum(ccp => ccp.Amount);
                var ccpLast = ccpColl.Where(ccp => ccp.Amount != 0).LastOrDefault();
                if (sisa != 0 && ccpLast != null)
                {
                    ccpLast.Amount += sisa;
                }
                //ccpColl.Save(); <-- gak usah disimpan deh

                foreach (var cc in ccColl)
                {
                    var ccp = ccpColl.Where(c => c.TransactionNo == cc.TransactionNo && c.SequenceNo == cc.SequenceNo).First();
                    var jtdColl = GetNewIncomeJournalCashBased(jt, cc, false, 0, CoaColl, false, false, ccp != null);

                    // remove yang bukan ccp
                    foreach (var jtd in jtdColl)
                    {
                        if ((jtd.IsProrataDiscToRevenue ?? false))
                        {
                            jtd.Description = (string.IsNullOrEmpty(AdjNotePrefix) ? (AdjAmount > 0 ? "Disc adj" : "Overpayment adj") : AdjNotePrefix) +
                                " " + jtd.Description;
                        }
                        else
                        {
                            jtdColl.DetachEntity(jtd);
                        }
                    }

                    if (jtdColl.Count == 0) continue;

                    // update nilai jurnalnya secara proporsional
                    var debit = jtdColl.Sum(jtd => jtd.Debit.Value);
                    var credit = jtdColl.Sum(jtd => jtd.Credit.Value);
                    var total = credit - debit;
                    decimal tNewVal = 0;

                    if (total != 0)
                    {
                        foreach (var jtd in jtdColl)
                        {
                            var newVal = Math.Round((jtd.Credit.Value - jtd.Debit.Value) / total * (ccp.Amount ?? 0), 2, MidpointRounding.ToEven);
                            jtd.Debit = newVal > 0 ? newVal : 0;
                            jtd.Credit = newVal < 0 ? -newVal : 0;
                            tNewVal += newVal;
                        }
                    }
                    //else
                    //{
                    //    jtdCcpColl.Combine(jtdColl);
                    //}

                    // kalau ada selisih pembulatan
                    if ((ccp.Amount ?? 0) != tNewVal)
                    {
                        var nVal = (ccp.Amount ?? 0) - tNewVal;
                        var jtd = jtdColl.LastOrDefault();
                        if ((jtd.Debit ?? 0) > 0)
                        {
                            jtd.Debit += nVal;
                        }
                        else
                        {
                            jtd.Credit -= nVal;
                        }
                    }

                    jtdCcpColl.Combine(jtdColl);
                }
            }

            return jtdCcpColl;
        }
        //public static JournalTransactionDetailsCollection GetNewIncomeAdjustProrataDiscCashBased(JournalTransactions jt, CostcalculationProrata ccp, ChartOfAccountsCollection CoaColl)
        //{
        //    var jtdColl = new JournalTransactionDetailsCollection();

        //    string tserviceUnit = string.Empty;
        //    string tlocation = string.Empty;
        //    Boolean isReturn = false;

        //    var ccColl = new CostCalculationCollection();
        //    ccColl.Query.Where(ccColl.Query.TransactionNo == ccp.TransactionNo, ccColl.Query.SequenceNo == ccp.SequenceNo);

        //    var cc = new CostCalculation();
        //    if (ccColl.LoadAll()) {
        //        if (ccColl.Count == 1)
        //        {
        //            cc = ccColl.First();
        //        }
        //        else {
        //            // bugs, harus cari noreg yang bener yang mana

        //            cc = ccColl.First();
        //        }

        //        jtdColl = GetNewIncomeJournalCashBased(jt, cc, false, 0, CoaColl, false, false, ccp);

        //        // remove yang bukan ccp
        //        foreach (var jtd in jtdColl) {
        //            if ((jtd.IsProrataDiscToRevenue ?? false))
        //            {
        //                jtd.Description = "Disc adj " + jtd.Description;
        //            }
        //            else {
        //                jtdColl.DetachEntity(jtd);
        //            }
        //        }
        //        // update nilai jurnalnya secara proporsional
        //        var debit = jtdColl.Sum(jtd => jtd.Debit.Value);
        //        var credit = jtdColl.Sum(jtd => jtd.Credit.Value);
        //        var total = credit - debit;
        //        decimal tNewVal = 0;
        //        foreach (var jtd in jtdColl) {
        //            var newVal = Math.Round((jtd.Credit.Value - jtd.Debit.Value) / total * (ccp.Amount ?? 0), 2, MidpointRounding.ToEven);
        //            jtd.Debit = newVal > 0 ? newVal : 0;
        //            jtd.Credit = newVal < 0 ? -newVal : 0;
        //            tNewVal += newVal;
        //        }

        //        // kalau ada selisih pembulatan
        //        if ((ccp.Amount ?? 0) != tNewVal) {
        //            var nVal = (ccp.Amount ?? 0) - tNewVal;
        //            var jtd = jtdColl.Where(j => (j.Debit ?? 0) > 0).LastOrDefault();
        //            if (jtd != null)
        //            {
        //                jtd.Debit += nVal;
        //            }
        //            else {
        //                jtd = jtdColl.Where(j => (j.Credit ?? 0) > 0).LastOrDefault();
        //                if (jtd != null)
        //                {
        //                    jtd.Debit -= nVal;
        //                }
        //                else
        //                {
        //                    jtd = jtdColl.Last();
        //                    if (jtd == null) jtdColl.Last();
        //                    jtd.Debit += nVal;
        //                }
        //            }
        //        }
        //    }

        //    return jtdColl;
        //}

        public static int AddNewIncomeJournalCashBasedTemporary(int JournalId, CostCalculation cc, out decimal tCredit, out decimal tDebit, Boolean JournalReturn, decimal chargeQty)
        {
            return AddNewIncomeJournalCashBasedTemporary(JournalId, cc, out tCredit, out tDebit, JournalReturn, chargeQty, new ChartOfAccountsCollection());
        }

        public static int AddNewIncomeJournalCashBasedTemporary(int JournalId, CostCalculation cc, out decimal tCredit, out decimal tDebit, Boolean JournalReturn, decimal chargeQty, ChartOfAccountsCollection CoaColl)
        {
            decimal totalCredit = 0;
            decimal totalDebit = 0;
            string tserviceUnit = string.Empty;
            string tlocation = string.Empty;
            Boolean isReturn = false;

            Registration reg = new Registration();
            reg.LoadByPrimaryKey(cc.RegistrationNo);

            /* RSUI minta ditambahkan info GuarantorID dan SRGuarantorType di jurnal pendapatan */
            Guarantor guar = new Guarantor();
            guar.LoadByPrimaryKey(reg.GuarantorID);
            var descAdd = string.Empty;
            AppParameter appHI = new AppParameter();
            appHI.LoadByPrimaryKey("HealthcareInitialAppsVersion");
            if (appHI.ParameterValue.Equals("RSUI") || appHI.ParameterValue.Equals("RSPM"))
            {
                descAdd = string.Format(" [{0}^{1}]", reg.GuarantorID, guar.SRGuarantorType);
            }

            //var regType = reg.SRRegistrationType;

            //if (regType != "EMR")
            //{
            //    var merge = new MergeBilling();
            //    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
            //    {
            //        var r = new Registration();
            //        r.LoadByPrimaryKey(merge.FromRegistrationNo);
            //        regType = r.SRRegistrationType;
            //    }
            //}
            //if (regType == "MCU")
            //    regType = "OPR";

            Patient pEnity = new Patient();
            pEnity.LoadByPrimaryKey(reg.PatientID);

            decimal packageDiff = 0;
            string packageName = string.Empty;

            if (cc.TransactionNo == "SU180102-0060")
            {
                var x = cc.TransactionNo;
            }

            TransCharges tc = new TransCharges();
            TransPrescription tp = new TransPrescription();
            if (tc.LoadByPrimaryKey(cc.TransactionNo))
            {
                tserviceUnit = tc.ToServiceUnitID;
                tlocation = tc.LocationID;

                //paket non mcu
                if (!(tc.IsPackage ?? false))
                {
                    TransChargesItem ci1 = new TransChargesItem();
                    ci1.Query.Where(ci1.Query.TransactionNo == cc.TransactionNo, ci1.Query.SequenceNo == cc.SequenceNo, ci1.Query.ItemID == cc.ItemID);
                    if (ci1.Query.Load())
                    {
                        if (!string.IsNullOrEmpty(ci1.ParentNo))
                        {
                            var ci2 = new TransChargesItem();
                            ci2.LoadByPrimaryKey(ci1.TransactionNo, ci1.ParentNo);

                            var ip = new ItemPackage();
                            ip.Query.Where(ip.Query.ItemID == ci2.ItemID, ip.Query.DetailItemID == ci1.ItemID);
                            ip.Query.Load();

                            tc.ToServiceUnitID = ip.ServiceUnitID;
                            tserviceUnit = tc.ToServiceUnitID;
                            tlocation = string.Empty;

                            var i = new Item();
                            i.LoadByPrimaryKey(ip.ItemID);
                            packageName = i.ItemName;
                        }
                    }
                }

                isReturn = tc.IsCorrection.Value;
            }
            else
            {
                if (tp.LoadByPrimaryKey(cc.TransactionNo))
                {
                    tserviceUnit = tp.ServiceUnitID;
                    tlocation = tp.LocationID;
                    isReturn = tp.IsPrescriptionReturn.Value;
                    // cek resep ada qty atau tidak, kalau tidak ada jangan di-jurnal
                    var tpi = new TransPrescriptionItem();
                    if (tpi.LoadByPrimaryKey(cc.TransactionNo, cc.SequenceNo))
                    {
                        if ((tpi.ResultQty ?? 0) == 0 && (tpi.LineAmount ?? 0) == 0)
                        {
                            tDebit = totalDebit;
                            tCredit = totalCredit;
                            return 0;
                        }
                    }
                }
            }

            var su = new ServiceUnit();
            su.LoadByPrimaryKey(tserviceUnit);

            if (string.IsNullOrEmpty(tlocation))
                tlocation = su.GetMainLocationId(su.ServiceUnitID);

            var regType = reg.SRRegistrationType;
            if (regType == "MCU")
                regType = "OPR";

            AppParameter par = new AppParameter();
            par.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");

            Item item = new Item(); item.Query.Where(item.Query.ItemID == cc.ItemID);
            if (item.Query.Load())
            {
                AppStandardReferenceItem asr = new AppStandardReferenceItem();
                asr.Query.Where(asr.Query.StandardReferenceID == "ItemType", asr.Query.ItemID == item.SRItemType);
                if (asr.Query.Load())
                {

                }
                else
                {
                    throw new Exception("Item " + item.ItemID + " " + item.ItemName + " has no item type");
                }

                AppParameter IsPpnSalesRJ = new AppParameter();
                if (!IsPpnSalesRJ.LoadByPrimaryKey("acc_IsPpnSalesRJ"))
                    throw new Exception("App Parameter: acc_IsPpnSalesRJ: Parameter not found!!");
                AppParameter IsPpnSalesRI = new AppParameter();
                if (!IsPpnSalesRI.LoadByPrimaryKey("acc_IsPpnSalesRI"))
                    throw new Exception("App Parameter: acc_IsPpnSalesRI: Parameter not found!!");
                AppParameter coaPpnSalesRJ = new AppParameter();

                if (asr.ReferenceID.ToLower() == "service")
                {
                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                    itemService.Query.Where(itemService.Query.ServiceUnitID == tserviceUnit, itemService.Query.ItemID == cc.ItemID);
                    if (!itemService.Query.Load())
                    {
                        throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
                    }
                    TransChargesItem ci = new TransChargesItem();
                    ci.Query.Where(ci.Query.TransactionNo == cc.TransactionNo, ci.Query.SequenceNo == cc.SequenceNo, ci.Query.ItemID == cc.ItemID);
                    if (ci.Query.Load())
                    {
                        var tcic = new TransChargesItemCompCollection();
                        tcic.Query.Where(tcic.Query.TransactionNo == cc.TransactionNo, tcic.Query.SequenceNo == cc.SequenceNo);
                        tcic.LoadAll();

                        var grr = new Guarantor();
                        grr.LoadByPrimaryKey(reg.GuarantorID);

                        var isCompHasCito = tcic.Sum(x => x.CitoAmount ?? 0) != 0;
                        foreach (var q in tcic)
                        {
                            decimal discTemp = 0;
                            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "No")
                                discTemp = chargeQty * q.DiscountAmount.Value;

                            if (q.TransactionNo == cc.TransactionNo && q.SequenceNo == cc.SequenceNo)
                            {
                                int? coaId = 0;
                                int? subLedgerId = 0;
                                int? coaDiscId = 0;
                                int? subLedgerDiscId = 0;

                                ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                itemComp.Query.Where(itemComp.Query.ServiceUnitID == tc.ToServiceUnitID,
                                                     itemComp.Query.ItemID == cc.ItemID,
                                                     itemComp.Query.TariffComponentID == q.TariffComponentID,
                                                     itemComp.Query.SRRegistrationType == regType,
                                                     itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);

                                if (itemComp.Query.Load())
                                {
                                    if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                    {
                                        coaId = itemComp.ChartOfAccountIdIncome.Value;
                                        subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                    }

                                    if (itemComp.ChartOfAccountIdDiscount.HasValue && q.DiscountAmount > 0)
                                    {
                                        coaDiscId = itemComp.ChartOfAccountIdDiscount.Value;
                                        subLedgerDiscId = itemComp.SubledgerIdDiscount.HasValue ? itemComp.SubledgerIdDiscount : 0;
                                    }

                                }

                                JournalTransactionDetails d = new JournalTransactionDetails();
                                d.AddNew();
                                d.JournalId = JournalId;
                                d.ChartOfAccountId = ValidateCOA(coaId.Value, CoaColl, "Mapping COA of revenue", "(see tab Setting Chart Of Account)");
                                d.SubLedgerId = subLedgerId;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                /*
                                 * Cito diambil dari TransChargesItemComp, kalau kosong baru ambil dari TransChargesItem
                                 * NOTE: Cito masih ada kemungkinan masalah jika komponen tarif lebih dari 
                                 * satu dan cito-nya tidak mecah ke tabel TransChargesItemComp
                                 */
                                //var transVal = chargeQty * (q.Price +
                                //    (q.CitoAmount.HasValue ? (q.CitoAmount > 0 ? q.CitoAmount : (ci.CitoAmount/*CitoAmount di TransChargesItem sudah dikali qty*// Abs(chargeQty))) : ci.CitoAmount)) -
                                //    discTemp;

                                var transVal = chargeQty * (q.Price +
                                    (isCompHasCito ? q.CitoAmount : (ci.CitoAmount/*CitoAmount di TransChargesItem sudah dikali qty*// Abs(chargeQty)))) -
                                    discTemp;

                                transVal = transVal * (JournalReturn ? -1 : 1);
                                d.Debit = transVal < 0 ? transVal * -1 : 0;
                                d.Credit = transVal > 0 ? transVal : 0;
                                //if (chargeQty > 0 && JournalReturn == true || chargeQty < 0 && JournalReturn == false)
                                //{
                                //    d.Debit = Abs(q.Price * chargeQty) + ci.CitoAmount - Abs(discTemp);
                                //    d.Credit = 0;
                                //}
                                //else if (chargeQty < 0 && JournalReturn == true || chargeQty > 0 && JournalReturn == false)
                                //{
                                //    d.Debit = 0;
                                //    // d.Credit = c.PatientAmount + c.GuarantorAmount + c.DiscountAmount;

                                //    //* d.Credit = Abs(q.Price * chargeQty) + ci.CitoAmount - discTemp;
                                //    /*
                                //     * script diatas yang dikasi tanda //* saya remark karena untuk item tariff
                                //     * cito yang memiliki 2 komponen, jurnalnya cito terhitung 2x sejumlah ci.CitoAmount
                                //     * harusnya bisa langsung ambil nilai cito yang sudah dipecah per komponen q.CitoAmount
                                //     * supaya tidak terhitung double lagi, tetapi sepertinya cito yang ada di komponen tidak selalu terisi
                                //     * karena itu jika cito di komponen tidak terisi maka saya ambil dari cito yang ada di table
                                //     * transchargesitem. ini berarti masih ada kemungkinan cito akan terhitung 2x jika komponennya ada 2 dan citonya tidak terpecah kedalam tabel komponen
                                //     */
                                //    d.Credit = Abs(q.Price * chargeQty) + (q.CitoAmount.HasValue ? (q.CitoAmount > 0 ? q.CitoAmount : ci.CitoAmount) : ci.CitoAmount) - discTemp;
                                //}
                                // end of modif teguh s 2016 06 02

                                d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} {4}{5}",
                                    tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID,
                                    item.ItemName, string.IsNullOrEmpty(packageName) ? string.Empty : "Ref: " + packageName,
                                    descAdd);
                                d.DocumentNumber = tc.TransactionNo;

                                AddMoreInfo(d, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, q.ParamedicID,
                                    null, tc.ToServiceUnitID, cc.ItemID, tc.RegistrationNo, cc.SequenceNo);

                                d.Save();

                                totalDebit += d.Debit.Value;
                                totalCredit += d.Credit.Value;


                                if (q.DiscountAmount.Value > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                {
                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                    disc.AddNew();
                                    disc.JournalId = JournalId;
                                    disc.ChartOfAccountId = ValidateCOA(coaDiscId.Value, CoaColl, "Mapping COA of discount", "(see tab Setting Chart Of Account)");
                                    disc.SubLedgerId = subLedgerDiscId;

                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                    var discVal = q.DiscountAmount.Value * chargeQty;
                                    discVal = discVal * (JournalReturn ? -1 : 1);
                                    disc.Debit = discVal > 0 ? discVal : 0;
                                    disc.Credit = discVal < 0 ? discVal * -1 : 0;
                                    // end of modif teguh s 2016 06 02

                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3} {4}{5}",
                                        tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName,
                                        string.IsNullOrEmpty(packageName) ? string.Empty : "Ref: " + packageName,
                                        descAdd);
                                    disc.DocumentNumber = tc.TransactionNo;

                                    AddMoreInfo(disc, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, q.ParamedicID,
                                    null, tc.ToServiceUnitID, cc.ItemID, tc.RegistrationNo, cc.SequenceNo);

                                    disc.Save();

                                    totalDebit += disc.Debit.Value;
                                    totalCredit += disc.Credit.Value;
                                }

                            }
                        }
                        //COST FOR CONSUMPTION
                        TransChargesItemConsumptionQuery consp = new TransChargesItemConsumptionQuery();
                        consp.SelectAll();
                        consp.Where(consp.TransactionNo == cc.TransactionNo,
                                    consp.SequenceNo == cc.SequenceNo);

                        DataTable tblconsp = consp.LoadDataTable();

                        if (tblconsp.Rows.Count > 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                        {
                            foreach (DataRow r in tblconsp.Rows)
                            {
                                Item itemInv = new Item();
                                itemInv.Query.Where(itemInv.Query.ItemID == r["DetailItemID"]);
                                if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                                {
                                    ServiceUnitProductAccountMapping proacc = new ServiceUnitProductAccountMapping();
                                    if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, itemInv.ProductAccountID, reg.SRRegistrationType) && (par.ParameterValue == "Yes"))
                                    {

                                        if (itemInv.SRItemType == "11")
                                        {
                                            ItemProductMedic itemMedic = new ItemProductMedic();
                                            itemMedic.Query.Where(itemMedic.Query.ItemID == r["DetailItemID"]);
                                            if (itemMedic.Query.Load())
                                            {
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                // COGS FOR CONSUMPTION
                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                                    itemMedicCogs.AddNew();
                                                    itemMedicCogs.JournalId = JournalId;
                                                    itemMedicCogs.ChartOfAccountId = proacc.ChartOfAccountIdCOGS;
                                                    itemMedicCogs.SubLedgerId = proacc.SubledgerIdCOGS;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    cogs = cogs * (JournalReturn ? -1 : 1);
                                                    itemMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                                    itemMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, cc.ItemID);
                                                    itemMedicCogs.DocumentNumber = tc.TransactionNo;

                                                    AddMoreInfo(itemMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, cc.SequenceNo);
                                                    itemMedicCogs.Save();

                                                    totalDebit += itemMedicCogs.Debit.Value;
                                                    totalCredit += itemMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                                    itemMedicInv.AddNew();
                                                    itemMedicInv.JournalId = JournalId;
                                                    itemMedicInv.ChartOfAccountId = proacc.ChartOfAccountIdInventory;
                                                    itemMedicInv.SubLedgerId = proacc.SubledgerIdInventory;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    itemMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                                    itemMedicInv.Credit = cogs > 0 ? cogs : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{5}",
                                                        tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID,
                                                        itemInv.ItemName, cc.ItemID, descAdd);
                                                    itemMedicInv.DocumentNumber = tc.TransactionNo;

                                                    itemMedicInv.ClassID = tc.ClassID;
                                                    itemMedicInv.GuarantorID = reg.GuarantorID;
                                                    itemMedicInv.ParamedicID = string.Empty;
                                                    itemMedicInv.ServiceUnitID = tc.ToServiceUnitID;
                                                    itemMedicInv.ItemID = cc.ItemID;

                                                    AddMoreInfo(itemMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, cc.SequenceNo);
                                                    itemMedicInv.Save();

                                                    totalDebit += itemMedicInv.Debit.Value;
                                                    totalCredit += itemMedicInv.Credit.Value;
                                                }

                                            }
                                        }
                                        else
                                        {
                                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == r["DetailItemID"]);
                                            if (itemNonMedic.Query.Load())
                                            {
                                                ItemMovementQuery mov = new ItemMovementQuery();
                                                mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                                           mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                                mov.Where(mov.TransactionNo == r["TransactionNo"], mov.SequenceNo == r["SequenceNo"], mov.ItemID == r["DetailItemID"]);
                                                mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                                DataTable tbl = mov.LoadDataTable();

                                                // COGS FOR CONSUMPTION
                                                foreach (DataRow row in tbl.Rows)
                                                {
                                                    decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                                    // decimal? cogs = ci.StockQuantity * ci.CostPrice;

                                                    //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                                    itemNonMedicCogs.AddNew();
                                                    itemNonMedicCogs.JournalId = JournalId;
                                                    itemNonMedicCogs.ChartOfAccountId = proacc.ChartOfAccountIdCOGS;
                                                    itemNonMedicCogs.SubLedgerId = proacc.SubledgerIdCOGS;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    cogs = cogs * (JournalReturn ? -1 : 1);
                                                    itemNonMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                                    itemNonMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemNonMedicCogs.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{5}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, cc.ItemID, descAdd);
                                                    itemNonMedicCogs.DocumentNumber = tc.TransactionNo;

                                                    AddMoreInfo(itemNonMedicCogs, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, cc.SequenceNo);
                                                    itemNonMedicCogs.Save();

                                                    totalDebit += itemNonMedicCogs.Debit.Value;
                                                    totalCredit += itemNonMedicCogs.Credit.Value;

                                                    //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                                    JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                                    itemNonMedicInv.AddNew();
                                                    itemNonMedicInv.JournalId = JournalId;
                                                    itemNonMedicInv.ChartOfAccountId = proacc.ChartOfAccountIdInventory;
                                                    itemNonMedicInv.SubLedgerId = proacc.SubledgerIdInventory;

                                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                                    itemNonMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                                    itemNonMedicInv.Credit = cogs > 0 ? cogs : 0;
                                                    // end of modif teguh s 2016 06 02

                                                    itemNonMedicInv.Description = string.Format("CONSUMPTION ({4}) REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{5}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemInv.ItemID, itemInv.ItemName, cc.ItemID, descAdd);
                                                    itemNonMedicInv.DocumentNumber = tc.TransactionNo;

                                                    //itemNonMedicInv.ClassID = tc.ClassID;
                                                    //itemNonMedicInv.GuarantorID = reg.GuarantorID;
                                                    //itemNonMedicInv.ParamedicID = string.Empty;
                                                    //itemNonMedicInv.ServiceUnitID = tc.ToServiceUnitID;
                                                    //itemNonMedicInv.ItemID = cc.ItemID;

                                                    AddMoreInfo(itemNonMedicInv, tc.ClassID, tc.RoomID, tc.BedID, reg.GuarantorID, string.Empty, string.Empty,
                                                        null, tc.ToServiceUnitID, r["DetailItemID"].ToString(), tc.RegistrationNo, cc.SequenceNo);
                                                    itemNonMedicInv.Save();

                                                    totalDebit += itemNonMedicInv.Debit.Value;
                                                    totalCredit += itemNonMedicInv.Credit.Value;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    string sRoomID = "", sBedID = "", sClassID = "";
                    if (tp.ClassID == null)
                    {
                        sClassID = tc.ClassID;
                        sRoomID = tc.RoomID;
                        sBedID = tc.BedID;
                    }
                    else
                    {
                        sClassID = tp.ClassID;
                        sRoomID = (tp.FromRoomID ?? tp.FromServiceUnitID) ?? tp.ServiceUnitID;
                        sBedID = tp.FromBedID;
                    }

                    int coaID = 0, scoaID = 0, cogsID = 0, scogsID = 0, icoaID = 0, sinvID = 0, discID = 0, sdiscID = 0, cogsIDTemp = 0, scogsIDTemp = 0;
                    if (item.ProductAccountID != null)
                    {
                        var sMappingSource = string.Empty;
                        ServiceUnitProductAccountMapping proacc = new ServiceUnitProductAccountMapping();
                        if (proacc.LoadByPrimaryKey(tlocation, tserviceUnit, item.ProductAccountID, reg.SRRegistrationType) && (par.ParameterValue == "Yes"))
                        {
                            coaID = proacc.ChartOfAccountIdIncome ?? 0;
                            scoaID = proacc.SubledgerIdIncome ?? 0;

                            cogsID = proacc.ChartOfAccountIdCOGS ?? 0;
                            scogsID = proacc.SubledgerIdCOGS ?? 0;

                            icoaID = proacc.ChartOfAccountIdInventory ?? 0;
                            sinvID = proacc.SubledgerIdInventory ?? 0;
                            discID = proacc.ChartOfAccountIdDiscount ?? 0;
                            sdiscID = proacc.SubledgerIdDiscount ?? 0;
                            sMappingSource = "ServiceUnitProductAccountMapping";
                        }
                        else
                        {
                            var pacc = new ProductAccountGuarantorGroup();
                            pacc.Query.Where(pacc.Query.ProductAccountID == item.ProductAccountID,
                                pacc.Query.SRGuarantorIncomeGroup == guar.SRGuarantorIncomeGroup);
                            if (pacc.Load(pacc.Query))
                            {
                                coaID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdIncome ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdIncomeIP ?? 0 : pacc.ChartOfAccountIdIncomeIGD ?? 0);
                                scoaID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdIncome ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdIncomeIP ?? 0 : pacc.SubledgerIdIncomeIGD ?? 0);

                                cogsID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdCOGS ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdCOGSIP ?? 0 : pacc.ChartOfAccountIdCOGSIGD ?? 0);
                                scogsID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdCOGS ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdCOGSIP ?? 0 : pacc.SubledgerIdCOGSIGD ?? 0);

                                cogsIDTemp = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdCOGSOPTemp ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdCOGSIPTemp ?? 0 : pacc.ChartOfAccountIdCOGSIGDTemp ?? 0);
                                scogsIDTemp = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdCOGSOPTemp ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdCOGSIPTemp ?? 0 : pacc.SubledgerIdCOGSIGDTemp ?? 0);

                                icoaID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdInventory ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdInventoryIP ?? 0 : pacc.ChartOfAccountIdInventoryIGD ?? 0);
                                sinvID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdInventory ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdInventoryIP ?? 0 : pacc.SubledgerIdInventoryIGD ?? 0);
                                discID = reg.SRRegistrationType == "OPR" ? pacc.ChartOfAccountIdDiscount ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.ChartOfAccountIdDiscountIP ?? 0 : pacc.ChartOfAccountIdDiscountIGD ?? 0);
                                sdiscID = reg.SRRegistrationType == "OPR" ? pacc.SubledgerIdDiscount ?? 0 : (reg.SRRegistrationType == "IPR" ? pacc.SubledgerIdDiscountIP ?? 0 : pacc.SubledgerIdDiscountIGD ?? 0);
                                sMappingSource = "ProductAccount";
                            }
                        }

                        decimal discTemp = 0;
                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                            discTemp = cc.DiscountAmount ?? 0;

                        var app = new AppParameter();
                        app.LoadByPrimaryKey("ItemProductCostPriceType");

                        if (item.SRItemType == "11")
                        {
                            ItemProductMedic itemMedic = new ItemProductMedic();
                            itemMedic.Query.Where(itemMedic.Query.ItemID == cc.ItemID);
                            if (itemMedic.Query.Load())
                            {
                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));
                                var paramPpnPctg = new AppParameter();
                                if (!paramPpnPctg.LoadByPrimaryKey("Ppn"))
                                {
                                    throw new Exception("Appparameter Ppn is undefined");
                                }
                                decimal ppnVal = System.Convert.ToDecimal(paramPpnPctg.ParameterValue);

                                var ccVal = cc.PatientAmount + cc.GuarantorAmount + discTemp;
                                decimal ccValPPN = 0;
                                if (reg.SRRegistrationType.Equals("IPR"))
                                {
                                    if (IsPpnSalesRI.ParameterValue.Equals("Yes"))
                                        ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); //Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                }
                                else
                                {
                                    if (IsPpnSalesRJ.ParameterValue.Equals("Yes"))
                                        ccValPPN = Math.Round(ccVal.Value - ccVal.Value * 100 / (100 + ppnVal), 2); //Math.Round(ccVal.Value / (decimal)1.1 * 10 / 100, 2);
                                }
                                ccVal = ccVal - ccValPPN;

                                JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                                itemMedicIncome.AddNew();
                                itemMedicIncome.JournalId = JournalId;
                                itemMedicIncome.ChartOfAccountId = ValidateCOA(coaID, CoaColl, sMappingSource + ": Revenue");
                                itemMedicIncome.SubLedgerId = scoaID;
                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                ccVal = ccVal * (JournalReturn ? -1 : 1);
                                itemMedicIncome.Debit = ccVal < 0 ? ccVal * -1 : 0;
                                itemMedicIncome.Credit = ccVal > 0 ? ccVal : 0;
                                // end of modif teguh s 2016 06 02

                                itemMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                itemMedicIncome.DocumentNumber = cc.TransactionNo;

                                AddMoreInfo(itemMedicIncome, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                    string.Empty, string.Empty, null,
                                    su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                itemMedicIncome.Save();

                                totalCredit += itemMedicIncome.Credit.Value;
                                totalDebit += itemMedicIncome.Debit.Value;

                                if (ccValPPN != 0)
                                {
                                    JournalTransactionDetails ppnSales = new JournalTransactionDetails();
                                    ppnSales.AddNew();
                                    ppnSales.JournalId = JournalId;
                                    ppnSales.ChartOfAccountId = ValidateCOA(
                                        GetCachedAccountFromParam(reg.SRRegistrationType.Equals("IPR") ? "coa_PpnSalesRI" : "coa_PpnSalesRJ"),
                                        CoaColl, string.Format("App Parameter: {0}", reg.SRRegistrationType.Equals("IPR") ? "coa_PpnSalesRI" : "coa_PpnSalesRJ"));
                                    ppnSales.SubLedgerId = scoaID;
                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                    ccValPPN = ccValPPN * (JournalReturn ? -1 : 1);
                                    ppnSales.Debit = ccValPPN < 0 ? ccValPPN * -1 : 0;
                                    ppnSales.Credit = ccValPPN > 0 ? ccValPPN : 0;
                                    // end of modif teguh s 2016 06 02

                                    ppnSales.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}{5}", tc.RegistrationNo ?? tp.RegistrationNo,
                                        pEnity.PatientName, cc.ItemID, item.ItemName, descAdd, " Sales tax");
                                    ppnSales.DocumentNumber = cc.TransactionNo;

                                    AddMoreInfo(ppnSales, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                        string.Empty, string.Empty, null,
                                        su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                    ppnSales.Save();

                                    totalCredit += ppnSales.Credit.Value;
                                    totalDebit += ppnSales.Debit.Value;
                                }

                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                {
                                    /* karena Qty in & Qty Out tidak mungkin nilainya 0 secara bersamaan maka tidak masalah ditambah */
                                    DataTable tbl = new DataTable();
                                    ItemMovementQuery mov = new ItemMovementQuery();
                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                               mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                    mov.Where(mov.TransactionNo == cc.TransactionNo, mov.SequenceNo == cc.SequenceNo,
                                              mov.ItemID == cc.ItemID);
                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                    tbl = mov.LoadDataTable();
                                    //if (app.ParameterValue == "FIFO")
                                    //{
                                    //    ItemMovementQuery mov = new ItemMovementQuery();
                                    //    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                    //               mov.CostPrice, "< SUM(QuantityOut  QuantityIn) As Quantity >");
                                    //    mov.Where(mov.TransactionNo == cc.TransactionNo, mov.SequenceNo == cc.SequenceNo,
                                    //              mov.ItemID == cc.ItemID);
                                    //    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                    //    tbl = mov.LoadDataTable();
                                    //}
                                    //else
                                    //{
                                    //    var tpi = new TransPrescriptionItemQuery();
                                    //    tpi.Select(tpi.PrescriptionNo.As("TransactionNo"), tpi.SequenceNo,
                                    //        "<CASE WHEN ItemInterventionID != '' THEN ItemInterventionID ELSE ItemID END AS ItemID>",
                                    //        tpi.CostPrice, tpi.ResultQty.Sum().As("Quantity"));
                                    //    tpi.Where(tpi.PrescriptionNo == cc.TransactionNo, tpi.SequenceNo == cc.SequenceNo);
                                    //    tpi.GroupBy(tpi.PrescriptionNo, tpi.SequenceNo, tpi.ItemID, tpi.ItemInterventionID, tpi.CostPrice);
                                    //    tbl = tpi.LoadDataTable();
                                    //    if (tbl.Rows.Count == 0)
                                    //    {
                                    //        var tci = new TransChargesItemQuery();
                                    //        tci.Select(tci.TransactionNo, tci.SequenceNo, tci.ItemID,
                                    //            tci.CostPrice, tci.ChargeQuantity.Sum().As("Quantity"));
                                    //        tci.Where(tci.TransactionNo == cc.TransactionNo, tci.SequenceNo == cc.SequenceNo,
                                    //                  tci.ItemID == cc.ItemID);
                                    //        tci.GroupBy(tci.TransactionNo, tci.SequenceNo, tci.ItemID, tci.CostPrice);
                                    //        tbl = tci.LoadDataTable();
                                    //    }
                                    //}

                                    foreach (DataRow row in tbl.Rows)
                                    {

                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];
                                        if ((decimal)row["Quantity"] == 0) continue;

                                        //Logger.LogMessage(string.Format("Creating COGS Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicCogs = new JournalTransactionDetails();
                                        itemMedicCogs.AddNew();
                                        itemMedicCogs.JournalId = JournalId;
                                        itemMedicCogs.ChartOfAccountId = ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS");
                                        itemMedicCogs.SubLedgerId = scogsID;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        cogs = cogs * (JournalReturn ? -1 : 1);
                                        itemMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                        itemMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                        // end of modif teguh s 2016 06 02

                                        itemMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}",
                                                                                  tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                                  cc.ItemID, item.ItemName, descAdd);
                                        itemMedicCogs.DocumentNumber = cc.TransactionNo;

                                        AddMoreInfo(itemMedicCogs, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                            string.Empty, string.Empty, null,
                                            su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        itemMedicCogs.Save();

                                        totalDebit += itemMedicCogs.Debit.Value;
                                        totalCredit += itemMedicCogs.Credit.Value;

                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                        itemMedicInv.AddNew();
                                        itemMedicInv.JournalId = JournalId;
                                        itemMedicInv.ChartOfAccountId = ValidateCOA(cogsIDTemp, CoaColl, sMappingSource + ": Inventory");
                                        itemMedicInv.SubLedgerId = scogsIDTemp;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        itemMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                        itemMedicInv.Credit = cogs > 0 ? cogs : 0;
                                        // end of modif teguh s 2016 06 02

                                        itemMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}",
                                                                                 tc.RegistrationNo ?? tp.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName,
                                                                                 cc.ItemID, item.ItemName, descAdd);
                                        itemMedicInv.DocumentNumber = cc.TransactionNo;

                                        AddMoreInfo(itemMedicInv, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                            string.Empty, string.Empty, null,
                                            su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        itemMedicInv.Save();

                                        totalDebit += itemMedicInv.Debit.Value;
                                        totalCredit += itemMedicInv.Credit.Value;
                                    }
                                }


                                if (cc.DiscountAmount != 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                {
                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                    disc.AddNew();
                                    disc.JournalId = JournalId;
                                    disc.ChartOfAccountId = ValidateCOA(discID, CoaColl, sMappingSource + ": Discount");
                                    disc.SubLedgerId = sdiscID;

                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                    var discVal = cc.DiscountAmount.Value;
                                    discVal = discVal * (JournalReturn ? -1 : 1);
                                    disc.Debit = discVal > 0 ? discVal : 0;
                                    disc.Credit = discVal < 0 ? discVal * -1 : 0;
                                    // end of modif teguh s 2016 06 02

                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                    disc.DocumentNumber = cc.TransactionNo;

                                    AddMoreInfo(disc, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                        string.Empty, string.Empty, null,
                                        su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                    disc.Save();

                                    totalDebit += disc.Debit.Value;
                                    totalCredit += disc.Credit.Value;
                                }
                                // }
                            }
                        }
                        else
                        {
                            ItemProductNonMedic itemNonMedic = new ItemProductNonMedic();
                            itemNonMedic.Query.Where(itemNonMedic.Query.ItemID == cc.ItemID);
                            if (itemNonMedic.Query.Load())
                            {
                                //Logger.LogMessage(string.Format("Creating Income Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                var ccVal = cc.PatientAmount + cc.GuarantorAmount + discTemp;
                                var ccValPPN = 0;
                                if (reg.SRRegistrationType.Equals("IPR"))
                                {
                                    if (IsPpnSalesRI.Equals("Yes"))
                                        Math.Round(ccVal.Value * (decimal)0.1, 2);
                                }
                                else
                                {
                                    if (IsPpnSalesRJ.Equals("Yes"))
                                        Math.Round(ccVal.Value * (decimal)0.1, 2);
                                }
                                ccVal = ccVal - ccValPPN;

                                JournalTransactionDetails itemNonMedicIncome = new JournalTransactionDetails();
                                itemNonMedicIncome.AddNew();
                                itemNonMedicIncome.JournalId = JournalId;
                                itemNonMedicIncome.ChartOfAccountId = ValidateCOA(coaID, CoaColl, sMappingSource + ": Revenue");
                                itemNonMedicIncome.SubLedgerId = scoaID;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                //var ccVal = cc.PatientAmount + cc.GuarantorAmount + discTemp;
                                ccVal = ccVal * (JournalReturn ? -1 : 1);
                                ccValPPN = ccValPPN * (JournalReturn ? -1 : 1);
                                itemNonMedicIncome.Debit = ccVal < 0 ? ccVal * -1 : 0;
                                itemNonMedicIncome.Credit = ccVal > 0 ? ccVal : 0;
                                // end of modif teguh s 2016 06 02

                                itemNonMedicIncome.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                itemNonMedicIncome.DocumentNumber = cc.TransactionNo;

                                AddMoreInfo(itemNonMedicIncome, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                    string.Empty, string.Empty, null,
                                    su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);

                                itemNonMedicIncome.Save();

                                totalDebit += itemNonMedicIncome.Debit.Value;
                                totalCredit += itemNonMedicIncome.Credit.Value;

                                //TransChargesItem ci = new TransChargesItem();
                                //ci.Query.Where(ci.Query.TransactionNo == TransactionNo, ci.Query.SequenceNo == SequenceNo, ci.Query.ItemID == ItemID);

                                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalHPP) == "Yes")
                                {
                                    DataTable tbl = new DataTable();
                                    //if (app.ParameterValue == "FIFO")
                                    //{
                                    //    ItemMovementQuery mov = new ItemMovementQuery();
                                    //    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                    //               mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                    //    mov.Where(mov.TransactionNo == cc.TransactionNo, mov.SequenceNo == cc.SequenceNo,
                                    //              mov.ItemID == cc.ItemID);
                                    //    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                    //    tbl = mov.LoadDataTable();
                                    //}
                                    //else
                                    //{
                                    //    var tpi = new TransPrescriptionItemQuery();
                                    //    tpi.Select(tpi.PrescriptionNo.As("TransactionNo"), tpi.SequenceNo, tpi.ItemID,
                                    //        tpi.CostPrice, tpi.ResultQty.Sum().As("Quantity"));
                                    //    tpi.Where(tpi.PrescriptionNo == cc.TransactionNo, tpi.SequenceNo == cc.SequenceNo,
                                    //              tpi.ItemID == cc.ItemID);
                                    //    tpi.GroupBy(tpi.PrescriptionNo, tpi.SequenceNo, tpi.ItemID, tpi.CostPrice);
                                    //    tbl = tpi.LoadDataTable();
                                    //}

                                    ItemMovementQuery mov = new ItemMovementQuery();
                                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                               mov.CostPrice, "< SUM(QuantityOut - QuantityIn) As Quantity >");
                                    mov.Where(mov.TransactionNo == cc.TransactionNo, mov.SequenceNo == cc.SequenceNo,
                                              mov.ItemID == cc.ItemID);
                                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                                    tbl = mov.LoadDataTable();


                                    foreach (DataRow row in tbl.Rows)
                                    {
                                        decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                        JournalTransactionDetails itemNonMedicCogs = new JournalTransactionDetails();
                                        itemNonMedicCogs.AddNew();
                                        itemNonMedicCogs.JournalId = JournalId;
                                        itemNonMedicCogs.ChartOfAccountId = ValidateCOA(cogsID, CoaColl, sMappingSource + ": COGS");
                                        itemNonMedicCogs.SubLedgerId = scogsID;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        cogs = cogs * (JournalReturn ? -1 : 1);
                                        itemNonMedicCogs.Debit = cogs > 0 ? cogs : 0;
                                        itemNonMedicCogs.Credit = cogs < 0 ? cogs * -1 : 0;
                                        // end of modif teguh s 2016 06 02

                                        itemNonMedicCogs.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                        itemNonMedicCogs.DocumentNumber = cc.TransactionNo;

                                        AddMoreInfo(itemNonMedicCogs, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                            string.Empty, string.Empty, null,
                                            su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        itemNonMedicCogs.Save();

                                        totalDebit += itemNonMedicCogs.Debit.Value;

                                        //Logger.LogMessage(string.Format("Creating INVENTORY Journal for ItemProductMedic:{0}. (C)", c.ItemID));

                                        JournalTransactionDetails itemNonMedicInv = new JournalTransactionDetails();
                                        itemNonMedicInv.AddNew();
                                        itemNonMedicInv.JournalId = JournalId;
                                        itemNonMedicInv.ChartOfAccountId = ValidateCOA(cogsIDTemp, CoaColl, sMappingSource + ": Inventory");
                                        itemNonMedicInv.SubLedgerId = sinvID;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        itemNonMedicInv.Debit = cogs < 0 ? cogs * -1 : 0;
                                        itemNonMedicInv.Credit = cogs > 0 ? cogs : 0;
                                        // end of modif teguh s 2016 06 02

                                        itemNonMedicInv.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                        itemNonMedicInv.DocumentNumber = cc.TransactionNo;

                                        AddMoreInfo(itemNonMedicInv, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                            string.Empty, string.Empty, null,
                                            su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                        itemNonMedicInv.Save();

                                        totalDebit += itemNonMedicInv.Debit.Value;
                                        totalCredit += itemNonMedicInv.Credit.Value;
                                    }

                                }

                                if (cc.DiscountAmount != 0 && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalSalesDiscount) == "Yes")
                                {
                                    JournalTransactionDetails disc = new JournalTransactionDetails();
                                    disc.AddNew();
                                    disc.JournalId = JournalId;
                                    disc.ChartOfAccountId = ValidateCOA(discID, CoaColl, sMappingSource + ": Discount");
                                    disc.SubLedgerId = sdiscID;

                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                    var discVal = cc.DiscountAmount.Value;
                                    discVal = discVal * (JournalReturn ? -1 : 1);
                                    disc.Debit = discVal > 0 ? discVal : 0;
                                    disc.Credit = discVal < 0 ? discVal * -1 : 0;
                                    // end of modif teguh s 2016 06 02

                                    disc.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}{4}", tc.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, cc.ItemID, item.ItemName, descAdd);
                                    disc.DocumentNumber = cc.TransactionNo;

                                    AddMoreInfo(disc, sClassID, sRoomID, sBedID, reg.GuarantorID,
                                        string.Empty, string.Empty, null,
                                        su.ServiceUnitID, cc.ItemID, reg.RegistrationNo, cc.SequenceNo);
                                    disc.Save();

                                    totalDebit += disc.Debit.Value;
                                    totalCredit += disc.Credit.Value;
                                }
                            }

                        }
                    }

                }
            }
            tDebit = totalDebit;
            tCredit = totalCredit;
            return 0;
        }

        public static int? AddNewPaymentJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            //payment return - no case based - unapproval
            //down payment receive
            try
            {
                var transactionDate = tp.PaymentDate;
                if (journalType == "07")
                    transactionDate = tp.VoidDate;

                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));
                bool newJournal = journalId == 0;

                var regType = reg.SRRegistrationType;

                string guarID = string.IsNullOrEmpty(tp.GuarantorID) ? (reg.GuarantorID ?? string.Empty) : tp.GuarantorID;
                var grn = new Guarantor();
                grn.LoadByPrimaryKey(guarID);

                if (regType != "EMR")
                {
                    if (!string.IsNullOrEmpty(reg.RegistrationNo))
                    {
                        var merge = new MergeBilling();
                        if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                        {
                            var r = new Registration();
                            r.LoadByPrimaryKey(merge.FromRegistrationNo);
                            regType = r.SRRegistrationType;
                        }
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID ?? (tp.PatientID ?? string.Empty));

                var keterangan = (journalType == "07") ? "PAYMENT RETURN VOID" : "PAYMENT";

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    //entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, transactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    //entity.TransactionDate = tp.PaymentDate;
                    entity.TransactionDate = transactionDate.Value.Date;
                    entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;
                }
                entity.Save();
                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                keterangan = (journalType == "07") ? "(VOID) RETURN" : "";

                var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

                foreach (var p in tpItems)
                {
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;
                    bool isCardPayment = false;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    string dAccountMsg = string.Empty;
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                            continue;
                    }

                    if (pm.ChartOfAccountID.HasValue)
                    {
                        dAccount = pm.ChartOfAccountID.Value;
                        dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        dAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                    }

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        //transfer
                        if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            bool skipBank = false;
                            if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaCashierPaymentTransferFromPaymentMethod))
                            {
                                // 
                                try
                                {
                                    ValidateCOA(pm.ChartOfAccountID, coaColl);
                                    skipBank = true;
                                }
                                catch (Exception ex)
                                {

                                }
                            }
                            if (!skipBank)
                            {
                                Bank bank = new Bank();
                                if (bank.LoadByPrimaryKey(p.BankID))
                                {
                                    if (bank.ChartOfAccountId.HasValue)
                                        dAccount = bank.ChartOfAccountId.Value;
                                    if (bank.SubledgerId.HasValue)
                                        dSubledgerId = bank.SubledgerId.Value;
                                }
                            }
                        }
                    }
                    if (p.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        if (p.Amount.Value != 0)
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = p.Amount;
                            d.Credit = 0;
                            d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo,
                                pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.DocumentNumberSequenceNo = p.SequenceNo;
                            d.Save();

                            totalDebit += d.Debit.Value;

                            if (p.Balance.Value == 0)
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                c.ChartOfAccountId = cAccount_off;
                                c.SubLedgerId = 0;
                                c.Debit = 0;
                                c.Credit = p.Amount;
                                c.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;
                                c.Save();

                                totalCredit += c.Credit.Value;
                            }
                            else
                            {
                                if ((journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 &&
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    if ((reg.AdministrationAmount ?? 0) > p.Amount)
                                    {
                                        JournalTransactionDetails c = new JournalTransactionDetails();
                                        c.AddNew();
                                        c.JournalId = entity.JournalId;
                                        c.ChartOfAccountId = cAccount_off;
                                        c.SubLedgerId = 0;
                                        c.Debit = (reg.AdministrationAmount ?? 0) + (p.RoundingAmount ?? 0) - p.Amount;
                                        c.Credit = 0;
                                        c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                            pEnity.PatientName, keterangan);
                                        c.DocumentNumber = tp.PaymentNo;
                                        c.DocumentNumberSequenceNo = p.SequenceNo;
                                        c.Save();

                                        totalDebit += c.Debit.Value;
                                    }
                                    else
                                    {
                                        JournalTransactionDetails c = new JournalTransactionDetails();
                                        c.AddNew();
                                        c.JournalId = entity.JournalId;
                                        c.ChartOfAccountId = cAccount_off;
                                        c.SubLedgerId = 0;
                                        c.Debit = 0;
                                        c.Credit = p.Amount - (reg.AdministrationAmount ?? 0) - (p.RoundingAmount ?? 0);
                                        c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                            pEnity.PatientName, keterangan);
                                        c.DocumentNumber = tp.PaymentNo;
                                        c.DocumentNumberSequenceNo = p.SequenceNo;
                                        c.Save();

                                        totalCredit += c.Credit.Value;
                                    }

                                    if ((p.RoundingAmount ?? 0) > 0)
                                    {
                                        int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                                        JournalTransactionDetails k = new JournalTransactionDetails();
                                        k.AddNew();
                                        k.JournalId = entity.JournalId;
                                        k.ChartOfAccountId = roundAmt;
                                        k.SubLedgerId = 0;
                                        k.Debit = 0;
                                        k.Credit = (p.RoundingAmount ?? 0);
                                        k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.",
                                            reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                        k.DocumentNumber = tp.PaymentNo;
                                        k.DocumentNumberSequenceNo = p.SequenceNo;
                                        k.Save();

                                        totalCredit += k.Credit.Value;
                                    }
                                }
                                else
                                {
                                    JournalTransactionDetails c = new JournalTransactionDetails();
                                    c.AddNew();
                                    c.JournalId = entity.JournalId;
                                    c.ChartOfAccountId = cAccount_off;
                                    c.SubLedgerId = 0;
                                    c.Debit = 0;
                                    c.Credit = p.Amount - (p.RoundingAmount ?? 0);
                                    c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                        pEnity.PatientName, keterangan);
                                    c.DocumentNumber = tp.PaymentNo;
                                    c.DocumentNumberSequenceNo = p.SequenceNo;
                                    c.Save();

                                    totalCredit += c.Credit.Value;
                                }

                                if (reg.AdministrationAmount > 0 &&
                                    (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 &&
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    var itemAdm = String.Empty;
                                    var CompID = String.Empty;
                                    AppParameter app = new AppParameter();
                                    if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                        itemAdm = app.ParameterValue;

                                    //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                                    AppParameter app2 = new AppParameter();
                                    if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                        CompID = app2.ParameterValue;

                                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                                    itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                        itemService.Query.ItemID == itemAdm);
                                    if (itemService.Query.Load())
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;

                                        var grr = new Guarantor();
                                        grr.LoadByPrimaryKey(reg.GuarantorID);

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                             itemComp.Query.ItemID == itemAdm,
                                                             itemComp.Query.TariffComponentID == CompID,
                                                             itemComp.Query.SRRegistrationType == regType,
                                                             itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue &&
                                                itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue
                                                    ? itemComp.SubledgerIdIncome
                                                    : 0;
                                            }
                                        }

                                        // kalau Rawat Inap
                                        if (reg.SRRegistrationType == "IPR")
                                        {

                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID,
                                                itemClass.Query.ItemID == itemAdm,
                                                itemClass.Query.ClassID == reg.ClassID,
                                                itemClass.Query.TariffComponentID == CompID);

                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue &&
                                                    itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue
                                                        ? itemClass.SubledgerIdIncome
                                                        : 0;
                                                }
                                            }
                                        }

                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == itemAdm);
                                        item.Query.Load();

                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = coaId;
                                        j.SubLedgerId = subLedgerId;
                                        j.Debit = 0;
                                        j.Credit = (reg.AdministrationAmount ?? 0);
                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}",
                                            reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;
                                        j.DocumentNumberSequenceNo = p.SequenceNo;
                                        j.Save();

                                        totalCredit += j.Credit.Value;
                                    }
                                }

                                // if there is CC fee
                                if (p.CardFeeAmount > 0)
                                {
                                    // debit
                                    JournalTransactionDetails dFee = new JournalTransactionDetails();
                                    dFee.AddNew();
                                    dFee.JournalId = entity.JournalId;
                                    dFee.ChartOfAccountId = dAccount_off;
                                    dFee.SubLedgerId = 0;
                                    dFee.Debit = p.CardFeeAmount;
                                    dFee.Credit = 0;
                                    dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                        pEnity.PatientName, keterangan);
                                    dFee.DocumentNumber = tp.PaymentNo;
                                    dFee.DocumentNumberSequenceNo = p.SequenceNo;
                                    dFee.Save();

                                    totalDebit += dFee.Debit.Value;

                                    // credit
                                    JournalTransactionDetails cFee = new JournalTransactionDetails();
                                    cFee.AddNew();
                                    cFee.JournalId = entity.JournalId;
                                    cFee.ChartOfAccountId = GetCachedAccountFromParam("coa_PaymentCardFeeAmt");
                                    cFee.SubLedgerId = 0;
                                    cFee.Debit = 0;
                                    cFee.Credit = p.CardFeeAmount;
                                    cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                        pEnity.PatientName, keterangan);
                                    cFee.DocumentNumber = tp.PaymentNo;
                                    cFee.DocumentNumberSequenceNo = p.SequenceNo;
                                    cFee.Save();

                                    totalCredit += cFee.Credit.Value;
                                }
                            }
                        }

                        if (p.Balance.Value != 0) //payment return
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = p.Balance;
                            d.Credit = 0;
                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.DocumentNumberSequenceNo = p.SequenceNo;
                            d.Save();

                            totalDebit += d.Debit.Value;

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            c.ChartOfAccountId = cAccount_off;
                            c.SubLedgerId = 0;
                            c.Debit = 0;
                            c.Credit = p.Balance;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;
                            c.Save();

                            totalCredit += c.Credit.Value;
                        }
                    }
                    else
                    {
                        var cAccountMsg = string.Empty;
                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                        {
                            cAccountMsg = "AppParameter: coa_DownPayment";
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");
                        }

                        // piutang instansi || piutang personal
                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(reg.GuarantorID))
                            {
                                if (guarantorEntity.ChartOfAccountId.HasValue)
                                {
                                    dAccount = guarantorEntity.ChartOfAccountId.Value;
                                    dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                                }
                            }
                        }

                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                isCardPayment = true;
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                        dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);
                                    }
                                }
                            }
                        }

                        //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                        d.SubLedgerId = dSubledgerId;
                        d.Debit = (p.Amount > 0) ? p.Amount : 0;
                        d.Credit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                        d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        d.DocumentNumber = tp.PaymentNo;
                        d.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;

                        if ((journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                        {
                            if ((reg.AdministrationAmount ?? 0) > p.Amount)
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = (reg.AdministrationAmount ?? 0) + (p.RoundingAmount ?? 0) - p.Amount;
                                c.Credit = 0;
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;
                                c.Save();

                                totalDebit += c.Debit.Value;
                            }
                            else
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = 0;
                                c.Credit = p.Amount - (reg.AdministrationAmount ?? 0) - (p.RoundingAmount ?? 0);
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;
                                c.Save();

                                totalCredit += c.Credit.Value;
                            }
                        }
                        else
                        {
                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cAccountMsg); ;
                            c.SubLedgerId = 0;
                            c.Debit = 0;
                            c.Credit = p.Amount - (p.RoundingAmount ?? 0);
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;
                            c.Save();

                            totalCredit += c.Credit.Value;
                        }

                        if ((p.RoundingAmount ?? 0) > 0)
                        {
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entity.JournalId;
                            k.ChartOfAccountId = roundAmt;
                            k.SubLedgerId = 0;
                            k.Debit = 0;
                            k.Credit = (p.RoundingAmount ?? 0);
                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.DocumentNumberSequenceNo = p.SequenceNo;
                            k.Save();

                            totalCredit += k.Credit.Value;
                        }


                        // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                        if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                        {
                            var itemAdm = String.Empty;
                            var CompID = String.Empty;
                            AppParameter app = new AppParameter();
                            if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                itemAdm = app.ParameterValue;

                            //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                            AppParameter app2 = new AppParameter();
                            if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                CompID = app2.ParameterValue;

                            ServiceUnitItemService itemService = new ServiceUnitItemService();
                            itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                    itemService.Query.ItemID == itemAdm);
                            if (itemService.Query.Load())
                            {
                                int? coaId = 0;
                                int? subLedgerId = 0;

                                var grr = new Guarantor();
                                grr.LoadByPrimaryKey(reg.GuarantorID);

                                ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                     itemComp.Query.ItemID == itemAdm,
                                                     itemComp.Query.TariffComponentID == CompID,
                                                     itemComp.Query.SRRegistrationType == regType,
                                                     itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                if (itemComp.Query.Load())
                                {
                                    if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                    {
                                        coaId = itemComp.ChartOfAccountIdIncome;
                                        subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                    }
                                }

                                // kalau Rawat Inap
                                if (reg.SRRegistrationType == "IPR")
                                {

                                    ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                    itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                        itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

                                    if (itemClass.Query.Load())
                                    {
                                        if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemClass.ChartOfAccountIdIncome.Value;
                                            subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                        }
                                    }
                                }

                                Item item = new Item();
                                item.Query.Where(item.Query.ItemID == itemAdm);
                                item.Query.Load();

                                JournalTransactionDetails j = new JournalTransactionDetails();
                                j.AddNew();
                                j.JournalId = entity.JournalId;
                                j.ChartOfAccountId = coaId;
                                j.SubLedgerId = subLedgerId;
                                j.Debit = 0;
                                j.Credit = (reg.AdministrationAmount ?? 0);
                                j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                j.DocumentNumber = tp.PaymentNo;
                                j.DocumentNumberSequenceNo = p.SequenceNo;
                                j.Save();

                                totalCredit += j.Credit.Value;
                            }
                        }

                        // if there is CC fee
                        if (p.CardFeeAmount > 0)
                        {
                            // debit
                            JournalTransactionDetails dFee = new JournalTransactionDetails();
                            dFee.AddNew();
                            dFee.JournalId = entity.JournalId;
                            dFee.ChartOfAccountId = dAccount;
                            dFee.SubLedgerId = 0;
                            dFee.Debit = Abs(p.CardFeeAmount);
                            dFee.Credit = 0;
                            dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            dFee.DocumentNumber = tp.PaymentNo;
                            dFee.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(dFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                            dFee.Save();

                            totalDebit += dFee.Debit.Value;

                            // credit
                            JournalTransactionDetails cFee = new JournalTransactionDetails();
                            cFee.AddNew();
                            cFee.JournalId = entity.JournalId;
                            cFee.ChartOfAccountId = GetCachedAccountFromParam("coa_PaymentCardFeeAmt");
                            cFee.SubLedgerId = 0;
                            cFee.Debit = 0;
                            cFee.Credit = Abs(p.CardFeeAmount);
                            cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            cFee.DocumentNumber = tp.PaymentNo;
                            cFee.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(cFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                            cFee.Save();

                            totalCredit += cFee.Credit.Value;
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    //// insert cash transaction here
                    DownPaymentAddCashEntry(tp, tpItems, entity, editedBy);
                    //if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
                    //{
                    //    int? cashTransactionId;
                    //    CashTransaction.AddNewAutomaticCashTransactionDownPaymentFromJournal(
                    //        tp, tpItems, entity, editedBy, out cashTransactionId);
                    //    // otomatis posting
                    //    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    //    {
                    //        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    //    }
                    //}
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);


                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? DownPaymentAddCashEntry(TransPayment tp, TransPaymentItemCollection tpItems,
            JournalTransactions entity, string editedBy)
        {
            // insert cash transaction here
            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
            {
                // prevent duplicate cash entry transaction when reprocessing journal is fired
                var ceColl = new CashTransactionCollection();
                ceColl.Query.Where(ceColl.Query.DocumentNumber == tp.PaymentNo && ceColl.Query.IsVoid == false);
                if (ceColl.LoadAll())
                {
                    var ce = ceColl.First();

                    if (ce.IsCleared ?? false)
                    {
                        throw new Exception("Cash transaction already cleared");
                    }

                    CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                    ce = new CashTransaction();
                    if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                    {
                        ce.Void(editedBy);
                    }

                    ceColl.Save();
                }


                int? cashTransactionId;
                CashTransaction.AddNewAutomaticCashTransactionDownPaymentFromJournal(
                    tp, tpItems, entity, editedBy, out cashTransactionId);
                // otomatis posting
                if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                {
                    CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                }

                return cashTransactionId;
            }
            return 0;
        }
        public static int? AddNewPaymentJournalTemporary(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = (journalType == "07") ? "PAYMENT RETURN VOID" : "PAYMENT";

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                keterangan = (journalType == "07") ? "(VOID) RETURN" : "";

                var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

                foreach (var p in tpItems)
                {
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                            continue;
                    }

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        if (pm.ChartOfAccountID.HasValue)
                        {
                            dAccount = pm.ChartOfAccountID.Value;
                            dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        }

                        //transfer
                        if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            Bank bank = new Bank();
                            if (bank.LoadByPrimaryKey(p.BankID))
                            {
                                if (bank.ChartOfAccountId.HasValue)
                                    dAccount = bank.ChartOfAccountId.Value;
                                if (bank.SubledgerId.HasValue)
                                    dSubledgerId = bank.SubledgerId.Value;
                            }
                        }
                    }
                    if (p.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        if (p.Amount.Value != 0)
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = p.Amount;
                            d.Credit = 0;
                            d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo,
                                pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.DocumentNumberSequenceNo = p.SequenceNo;
                            d.Save();

                            totalDebit += d.Debit.Value;

                            if (p.Balance.Value == 0)
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                c.ChartOfAccountId = cAccount_off;
                                c.SubLedgerId = 0;
                                c.Debit = 0;
                                c.Credit = p.Amount;
                                c.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;
                                c.Save();

                                totalCredit += c.Credit.Value;
                            }
                            else
                            {
                                if ((journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 &&
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    if ((reg.AdministrationAmount ?? 0) > p.Amount)
                                    {
                                        JournalTransactionDetails c = new JournalTransactionDetails();
                                        c.AddNew();
                                        c.JournalId = entity.JournalId;
                                        c.ChartOfAccountId = cAccount_off;
                                        c.SubLedgerId = 0;
                                        c.Debit = (reg.AdministrationAmount ?? 0) + (p.RoundingAmount ?? 0) - p.Amount;
                                        c.Credit = 0;
                                        c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                            pEnity.PatientName, keterangan);
                                        c.DocumentNumber = tp.PaymentNo;
                                        c.DocumentNumberSequenceNo = p.SequenceNo;
                                        c.Save();

                                        totalDebit += c.Debit.Value;
                                    }
                                    else
                                    {
                                        JournalTransactionDetails c = new JournalTransactionDetails();
                                        c.AddNew();
                                        c.JournalId = entity.JournalId;
                                        c.ChartOfAccountId = cAccount_off;
                                        c.SubLedgerId = 0;
                                        c.Debit = 0;
                                        c.Credit = p.Amount - (reg.AdministrationAmount ?? 0) - (p.RoundingAmount ?? 0);
                                        c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                            pEnity.PatientName, keterangan);
                                        c.DocumentNumber = tp.PaymentNo;
                                        c.DocumentNumberSequenceNo = p.SequenceNo;
                                        c.Save();

                                        totalCredit += c.Credit.Value;
                                    }

                                    if ((p.RoundingAmount ?? 0) > 0)
                                    {
                                        int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                                        JournalTransactionDetails k = new JournalTransactionDetails();
                                        k.AddNew();
                                        k.JournalId = entity.JournalId;
                                        k.ChartOfAccountId = roundAmt;
                                        k.SubLedgerId = 0;
                                        k.Debit = 0;
                                        k.Credit = (p.RoundingAmount ?? 0);
                                        k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.",
                                            reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                        k.DocumentNumber = tp.PaymentNo;
                                        k.DocumentNumberSequenceNo = p.SequenceNo;
                                        k.Save();

                                        totalCredit += k.Credit.Value;
                                    }
                                }
                                else
                                {
                                    JournalTransactionDetails c = new JournalTransactionDetails();
                                    c.AddNew();
                                    c.JournalId = entity.JournalId;
                                    c.ChartOfAccountId = cAccount_off;
                                    c.SubLedgerId = 0;
                                    c.Debit = 0;
                                    c.Credit = p.Amount - (p.RoundingAmount ?? 0);
                                    c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                        pEnity.PatientName, keterangan);
                                    c.DocumentNumber = tp.PaymentNo;
                                    c.DocumentNumberSequenceNo = p.SequenceNo;
                                    c.Save();

                                    totalCredit += c.Credit.Value;
                                }

                                if (reg.AdministrationAmount > 0 &&
                                    (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 &&
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    var itemAdm = String.Empty;
                                    var CompID = String.Empty;
                                    AppParameter app = new AppParameter();
                                    if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                        itemAdm = app.ParameterValue;

                                    //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                                    AppParameter app2 = new AppParameter();
                                    if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                        CompID = app2.ParameterValue;

                                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                                    itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                        itemService.Query.ItemID == itemAdm);
                                    if (itemService.Query.Load())
                                    {
                                        int? coaId = 0;
                                        int? subLedgerId = 0;

                                        var grr = new Guarantor();
                                        grr.LoadByPrimaryKey(reg.GuarantorID);

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                             itemComp.Query.ItemID == itemAdm,
                                                             itemComp.Query.TariffComponentID == CompID,
                                                             itemComp.Query.SRRegistrationType == regType,
                                                             itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);

                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue &&
                                                itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue
                                                    ? itemComp.SubledgerIdIncome
                                                    : 0;
                                            }
                                        }

                                        // kalau Rawat Inap
                                        if (reg.SRRegistrationType == "IPR")
                                        {

                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID,
                                                itemClass.Query.ItemID == itemAdm,
                                                itemClass.Query.ClassID == reg.ClassID,
                                                itemClass.Query.TariffComponentID == CompID);

                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue &&
                                                    itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue
                                                        ? itemClass.SubledgerIdIncome
                                                        : 0;
                                                }
                                            }
                                        }

                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == itemAdm);
                                        item.Query.Load();

                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = coaId;
                                        j.SubLedgerId = subLedgerId;
                                        j.Debit = 0;
                                        j.Credit = (reg.AdministrationAmount ?? 0);
                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}",
                                            reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;
                                        j.DocumentNumberSequenceNo = p.SequenceNo;
                                        j.Save();

                                        totalCredit += j.Credit.Value;
                                    }
                                }

                                // if there is CC fee
                                if (p.CardFeeAmount > 0)
                                {
                                    // debit
                                    JournalTransactionDetails dFee = new JournalTransactionDetails();
                                    dFee.AddNew();
                                    dFee.JournalId = entity.JournalId;
                                    dFee.ChartOfAccountId = dAccount_off;
                                    dFee.SubLedgerId = 0;
                                    dFee.Debit = p.CardFeeAmount;
                                    dFee.Credit = 0;
                                    dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                        pEnity.PatientName, keterangan);
                                    dFee.DocumentNumber = tp.PaymentNo;
                                    dFee.DocumentNumberSequenceNo = p.SequenceNo;
                                    dFee.Save();

                                    totalDebit += dFee.Debit.Value;

                                    // credit
                                    JournalTransactionDetails cFee = new JournalTransactionDetails();
                                    cFee.AddNew();
                                    cFee.JournalId = entity.JournalId;
                                    cFee.ChartOfAccountId = GetCachedAccountFromParam("coa_PaymentCardFeeAmt");
                                    cFee.SubLedgerId = 0;
                                    cFee.Debit = 0;
                                    cFee.Credit = p.CardFeeAmount;
                                    cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo,
                                        pEnity.PatientName, keterangan);
                                    cFee.DocumentNumber = tp.PaymentNo;
                                    cFee.DocumentNumberSequenceNo = p.SequenceNo;
                                    cFee.Save();

                                    totalCredit += cFee.Credit.Value;
                                }
                            }
                        }

                        if (p.Balance.Value != 0) //payment return
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = p.Balance;
                            d.Credit = 0;
                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.DocumentNumberSequenceNo = p.SequenceNo;
                            d.Save();

                            totalDebit += d.Debit.Value;

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            c.ChartOfAccountId = cAccount_off;
                            c.SubLedgerId = 0;
                            c.Debit = 0;
                            c.Credit = p.Balance;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;
                            c.Save();

                            totalCredit += c.Credit.Value;
                        }
                    }
                    else
                    {
                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                        {
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");
                        }

                        // piutang instansi || piutang personal
                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(reg.GuarantorID))
                            {
                                if (guarantorEntity.ChartOfAccountId.HasValue)
                                {
                                    dAccount = guarantorEntity.ChartOfAccountId.Value;
                                    dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                                }
                            }
                        }

                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                    }

                                }
                            }
                        }

                        //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = dAccount;
                        d.SubLedgerId = dSubledgerId;
                        d.Debit = p.Amount;
                        d.Credit = 0;
                        d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        d.DocumentNumber = tp.PaymentNo;
                        d.DocumentNumberSequenceNo = p.SequenceNo;
                        d.Save();

                        totalDebit += d.Debit.Value;

                        if ((journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                        {
                            if ((reg.AdministrationAmount ?? 0) > p.Amount)
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = (reg.AdministrationAmount ?? 0) + (p.RoundingAmount ?? 0) - p.Amount;
                                c.Credit = 0;
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;
                                c.Save();

                                totalDebit += c.Debit.Value;
                            }
                            else
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = 0;
                                c.Credit = p.Amount - (reg.AdministrationAmount ?? 0) - (p.RoundingAmount ?? 0);
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;
                                c.Save();

                                totalCredit += c.Credit.Value;
                            }
                        }
                        else
                        {
                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            c.ChartOfAccountId = cAccount;
                            c.SubLedgerId = 0;
                            c.Debit = 0;
                            c.Credit = p.Amount - (p.RoundingAmount ?? 0);
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;
                            c.Save();

                            totalCredit += c.Credit.Value;
                        }

                        if ((p.RoundingAmount ?? 0) > 0)
                        {
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entity.JournalId;
                            k.ChartOfAccountId = roundAmt;
                            k.SubLedgerId = 0;
                            k.Debit = 0;
                            k.Credit = (p.RoundingAmount ?? 0);
                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.DocumentNumberSequenceNo = p.SequenceNo;
                            k.Save();

                            totalCredit += k.Credit.Value;
                        }


                        // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                        if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                        {
                            var itemAdm = String.Empty;
                            var CompID = String.Empty;
                            AppParameter app = new AppParameter();
                            if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                itemAdm = app.ParameterValue;

                            //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                            AppParameter app2 = new AppParameter();
                            if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                CompID = app2.ParameterValue;

                            ServiceUnitItemService itemService = new ServiceUnitItemService();
                            itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                    itemService.Query.ItemID == itemAdm);
                            if (itemService.Query.Load())
                            {
                                int? coaId = 0;
                                int? subLedgerId = 0;

                                var grr = new Guarantor();
                                grr.LoadByPrimaryKey(reg.GuarantorID);

                                ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                     itemComp.Query.ItemID == itemAdm,
                                                     itemComp.Query.TariffComponentID == CompID,
                                                     itemComp.Query.SRRegistrationType == regType,
                                                     itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                if (itemComp.Query.Load())
                                {
                                    if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                    {
                                        coaId = itemComp.ChartOfAccountIdIncome;
                                        subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                    }
                                }

                                // kalau Rawat Inap
                                if (reg.SRRegistrationType == "IPR")
                                {

                                    ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                    itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                        itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

                                    if (itemClass.Query.Load())
                                    {
                                        if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemClass.ChartOfAccountIdIncome.Value;
                                            subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                        }
                                    }
                                }

                                Item item = new Item();
                                item.Query.Where(item.Query.ItemID == itemAdm);
                                item.Query.Load();

                                JournalTransactionDetails j = new JournalTransactionDetails();
                                j.AddNew();
                                j.JournalId = entity.JournalId;
                                j.ChartOfAccountId = coaId;
                                j.SubLedgerId = subLedgerId;
                                j.Debit = 0;
                                j.Credit = (reg.AdministrationAmount ?? 0);
                                j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                j.DocumentNumber = tp.PaymentNo;
                                j.DocumentNumberSequenceNo = p.SequenceNo;
                                j.Save();

                                totalCredit += j.Credit.Value;
                            }
                        }

                        // if there is CC fee
                        if (p.CardFeeAmount > 0)
                        {
                            // debit
                            JournalTransactionDetails dFee = new JournalTransactionDetails();
                            dFee.AddNew();
                            dFee.JournalId = entity.JournalId;
                            dFee.ChartOfAccountId = dAccount;
                            dFee.SubLedgerId = 0;
                            dFee.Debit = p.CardFeeAmount;
                            dFee.Credit = 0;
                            dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            dFee.DocumentNumber = tp.PaymentNo;
                            dFee.DocumentNumberSequenceNo = p.SequenceNo;
                            dFee.Save();

                            totalDebit += dFee.Debit.Value;

                            // credit
                            JournalTransactionDetails cFee = new JournalTransactionDetails();
                            cFee.AddNew();
                            cFee.JournalId = entity.JournalId;
                            cFee.ChartOfAccountId = GetCachedAccountFromParam("coa_PaymentCardFeeAmt");
                            cFee.SubLedgerId = 0;
                            cFee.Debit = 0;
                            cFee.Credit = p.CardFeeAmount;
                            cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            cFee.DocumentNumber = tp.PaymentNo;
                            cFee.DocumentNumberSequenceNo = p.SequenceNo;
                            cFee.Save();

                            totalCredit += cFee.Credit.Value;
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }


                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewPaymentReturnJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("PAYMENT RETURN REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                foreach (var p in tpItems)
                {
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                            continue;
                    }

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;
                    int cSubledgerId = 0;

                    // direct prescription return cm bisa untuk pasien pribadi dgn type payment: cash (002)
                    if (pt.SRPaymentTypeID.Equals("PaymentType-002"))
                    {
                        if (pm.ChartOfAccountID.HasValue)
                        {
                            dAccount = pm.ChartOfAccountID.Value;
                            dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        }
                    }

                    cAccount = GetCachedAccountFromParam("coa_DirectPrescReturn");
                    //parameter diisi coa pendapatan farmasi
                    //subledger pendapatan diambil dari subledger unit farmasi
                    string unt = string.Empty;
                    AppParameter app = new AppParameter();
                    if (app.LoadByPrimaryKey("ServiceUnitPharmacyID"))
                        unt = app.ParameterValue;

                    ServiceUnit su = new ServiceUnit();
                    if (su.LoadByPrimaryKey(unt))
                        cSubledgerId = Convert.ToInt16(su.SubledgerIdCost);


                    // Payment Credit Card || Payment Debit Card 
                    //if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                    //{
                    //    EDCMachine edcMachineEntity = new EDCMachine();
                    //    if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                    //    {
                    //        // Setting Account Code Per EDC Machine
                    //        if (edcMachineEntity.ChartOfAccountID.HasValue)
                    //        {
                    //            dAccount = edcMachineEntity.ChartOfAccountID.Value;
                    //            dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                    //        }

                    //    }
                    //}

                    //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = cAccount;
                    d.SubLedgerId = cSubledgerId;
                    d.Debit = Abs(p.Amount);
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    d.DocumentNumber = tp.PaymentNo;
                    d.Save();

                    totalDebit += d.Debit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = dAccount;
                    c.SubLedgerId = 0;
                    c.Debit = 0;
                    c.Credit = Abs(p.Amount);
                    c.Description = string.Format("REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    c.DocumentNumber = tp.PaymentNo;
                    c.Save();

                    totalCredit += c.Credit.Value;

                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewDownPaymentReturnJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));
                string guarID = string.IsNullOrEmpty(tp.GuarantorID) ? (reg.GuarantorID ?? string.Empty) : tp.GuarantorID;
                var grn = new Guarantor();
                grn.LoadByPrimaryKey(guarID);

                var regType = reg.SRRegistrationType;

                //if (regType != "EMR")
                //{
                //    var merge = new MergeBilling();
                //    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                //    {
                //        var r = new Registration();
                //        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                //        regType = r.SRRegistrationType;
                //    }
                //}

                if (regType != "EMR")
                {
                    if (!string.IsNullOrEmpty(reg.RegistrationNo))
                    {
                        var merge = new MergeBilling();
                        if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                        {
                            var r = new Registration();
                            r.LoadByPrimaryKey(merge.FromRegistrationNo);
                            regType = r.SRRegistrationType;
                        }
                    }
                }

                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID ?? tp.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("DOWN PAYMENT RETURN REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                foreach (var p in tpItems)
                {
                    /*
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    pt.LoadByPrimaryKey(payType);

                    PaymentMethod pm = new PaymentMethod();
                    pm.LoadByPrimaryKey(payType, payMethode);

                    int cAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int cSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int dAccount = 0;

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                    {
                        if (pm.ChartOfAccountID.HasValue)
                        {
                            cAccount = pm.ChartOfAccountID.Value;
                            cSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        }
                    }
                    */

                    int dAccount = GetCachedAccountFromParam("coa_DownPayment");
                    int cAccount = GetCachedAccountFromParam("coa_DownPaymentReturn");

                    if (p.SRPaymentMethod == AppParameter.GetParameterValue(AppParameter.ParameterItem.PaymentMethodTransfer).ToString())
                    {
                        var bank = new Bank();
                        if (bank.LoadByPrimaryKey(p.BankID))
                            cAccount = bank.ChartOfAccountId ?? cAccount;
                    }

                    //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = 0;
                    d.Debit = Abs(p.Amount);
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    d.DocumentNumber = tp.PaymentNo;
                    d.DocumentNumberSequenceNo = p.SequenceNo;

                    //edit
                    AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                    null, string.Empty, string.Empty, tp.RegistrationNo);

                    d.Save();

                    totalDebit += d.Debit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = 0;
                    c.Debit = 0;
                    c.Credit = Abs(p.Amount);
                    c.Description = string.Format("REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    c.DocumentNumber = tp.PaymentNo;
                    c.DocumentNumberSequenceNo = p.SequenceNo;

                    //edit
                    AddMoreInfo(c, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                    null, string.Empty, string.Empty, tp.RegistrationNo);

                    c.Save();

                    totalCredit += c.Credit.Value;

                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    DownPaymentReturnAddCashEntry(tp, tpItems, entity, editedBy);
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? DownPaymentReturnAddCashEntry(TransPayment tp, TransPaymentItemCollection tpItems,
            JournalTransactions entity, string editedBy)
        {
            // prevent duplicate cash entry transaction when reprocessing journal is fired
            var ceColl = new CashTransactionCollection();
            ceColl.Query.Where(ceColl.Query.DocumentNumber == tp.PaymentNo && ceColl.Query.IsVoid != true);
            if (ceColl.LoadAll())
            {
                var ce = ceColl.First();

                if (ce.IsCleared ?? false)
                {
                    throw new Exception("Cash transaction already cleared");
                }

                CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                ce = new CashTransaction();
                if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                {
                    ce.Void(editedBy);
                }
            }

            // insert cash transaction here
            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
            {
                int? cashTransactionId;
                CashTransaction.AddNewAutomaticCashTransactionDownPaymentFromJournal(
                    tp, tpItems, entity, editedBy, out cashTransactionId);
                // otomatis posting
                if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                {
                    CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                }

                return cashTransactionId;
            }
            return 0;
        }

        public static int? AddNewDownPaymentReturnCorrectionJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            return AddNewPaymentCorrectionJournal(tp.PaymentNo, prefix, editedBy, journalId, tp.VoidDate.Value);

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = DateTime.Now.Date;
                    entity.Description = string.Format("DOWN PAYMENT RETURN REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                foreach (var p in tpItems)
                {


                    int cAccount = GetCachedAccountFromParam("coa_DownPayment");
                    int dAccount = GetCachedAccountFromParam("coa_DownPaymentReturn");

                    //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = 0;
                    d.Debit = Abs(p.Amount);
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    d.DocumentNumber = tp.PaymentNo;
                    d.Save();

                    totalDebit += d.Debit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = 0;
                    c.Debit = 0;
                    c.Credit = Abs(p.Amount);
                    c.Description = string.Format("REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    c.DocumentNumber = tp.PaymentNo;
                    c.Save();

                    totalCredit += c.Credit.Value;

                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewPaymentCashBasedVoidJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                /* ubah status jurnal menjadi void */
                var a = new JournalTransactionsCollection();
                a.Query.Where(a.Query.RefferenceNumber == tp.PaymentNo);
                a.LoadAll();
                if (a.Count > 0)
                {
                    foreach (var row in a)
                    {
                        row.IsPosted = false;
                        row.IsVoid = true;
                    }
                    a.Save();
                }


                var b = new IntermBillCollection();
                b.Query.Where(b.Query.JournalIncomePaymentNo == tp.PaymentNo);
                b.LoadAll();
                /* apabila count > 0 berarti nopayment ini berisi journal pendapatan */
                if (b.Count > 0)
                {
                    foreach (var row in b)
                    {
                        row.JournalIncomePaymentNo = string.Empty;

                    }
                    b.Save();

                }

                var c = new TransPaymentItemOrderCollection();
                c.Query.Where(c.Query.JournalIncomePaymentNo == tp.PaymentNo);
                c.LoadAll();
                if (c.Count > 0)
                {
                    foreach (var row in c)
                    {
                        row.JournalIncomePaymentNo = String.Empty;
                    }

                    c.Save();
                }

                /* apakah return 0?? */
                return 0;
            }
            catch
            {
                return -1;
            }

        }

        public static int? AddNewCashierCorrectionJournal(string journalType, TransPaymentCorrection tpc, TransPaymentItemCorrectionCollection tpcItems, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                bool newJournal = journalId == 0;
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);
                    entity.Save();
                }
                else
                {
                    var bank = new Bank();
                    foreach (var cor in tpcItems)
                    {
                        EDCMachine edcMachineCorrection = new EDCMachine();
                        if (edcMachineCorrection.LoadByPrimaryKey(cor.EDCMachineID))
                        {
                            if ((edcMachineCorrection.ChartOfAccountID ?? 0) > 0)
                            {
                                var bankColl = new BankCollection();
                                bankColl.Query.Where(bankColl.Query.ChartOfAccountId == edcMachineCorrection.ChartOfAccountID.Value);
                                if (bankColl.LoadAll())
                                {
                                    bank = bankColl.First();
                                }
                            }
                        }
                    }

                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("CI." + bank.JournalCode, tpc.PaymentCorrectionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tpc.PaymentCorrectionDate.Value;
                    entity.Description = string.Format("Back Office Correction");
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tpc.PaymentCorrectionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                decimal totalCredit = 0, totalDebit = 0;

                foreach (var ic in tpcItems)
                {
                    var tpi = new TransPaymentItem();
                    if (tpi.LoadByPrimaryKey(ic.PaymentNo, ic.SequenceNo))
                    {

                        var tp = new TransPayment();
                        tp.LoadByPrimaryKey(tpi.PaymentNo);

                        var reg = new Registration();
                        reg.LoadByPrimaryKey(tp.RegistrationNo);

                        var pat = new Patient();
                        pat.LoadByPrimaryKey(reg.PatientID);

                        // Payment Credit Card || Payment Debit Card 
                        if (tpi.SRPaymentMethod.Equals("PaymentMethod-002") || tpi.SRPaymentMethod.Equals("PaymentMethod-003"))
                        {
                            int? dAccount = 0, dSubledgerId = 0;
                            string dAccountMsg;

                            decimal feeDiff = 0;
                            EDCMachine edcMachineCorrection = new EDCMachine();
                            if (edcMachineCorrection.LoadByPrimaryKey(ic.EDCMachineID))
                            {
                                // Setting Account Code Per EDC Machine
                                if (edcMachineCorrection.ChartOfAccountID.HasValue)
                                {
                                    dAccount = edcMachineCorrection.ChartOfAccountID.Value;
                                    dSubledgerId = (edcMachineCorrection.SubledgerID.HasValue ? edcMachineCorrection.SubledgerID.Value : 0);
                                    dAccountMsg = string.Format("EDC Machine: {0}", edcMachineCorrection.EDCMachineName);

                                    JournalTransactionDetails d = new JournalTransactionDetails();
                                    d.AddNew();
                                    d.JournalId = entity.JournalId;
                                    d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                                    d.SubLedgerId = dSubledgerId;

                                    d.Debit = (tpi.Amount > 0) ? tpi.Amount : 0;
                                    d.Credit = (tpi.Amount < 0) ? (tpi.Amount * -1) : 0;

                                    d.Description = string.Format("Back Office Correction REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pat.PatientName);

                                    d.DocumentNumber = ic.PaymentNo;
                                    d.DocumentNumberSequenceNo = ic.SequenceNo;

                                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                                                null, string.Empty, string.Empty, reg.RegistrationNo);

                                    d.Save();

                                    totalDebit += d.Debit.Value;
                                    totalCredit += d.Credit.Value;

                                    if ((ic.CardFeeAmount ?? 0) > 0)
                                    {
                                        // debit
                                        JournalTransactionDetails dFee = new JournalTransactionDetails();
                                        dFee.AddNew();
                                        dFee.JournalId = entity.JournalId;
                                        dFee.ChartOfAccountId = dAccount;
                                        dFee.SubLedgerId = 0;
                                        dFee.Debit = (ic.CardFeeAmount > 0) ? ic.CardFeeAmount : 0;
                                        dFee.Credit = (ic.CardFeeAmount < 0) ? (ic.CardFeeAmount * -1) : 0;
                                        dFee.Description = string.Format("Card Fee Correction REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pat.PatientName);
                                        dFee.DocumentNumber = ic.PaymentNo;
                                        dFee.DocumentNumberSequenceNo = ic.SequenceNo;

                                        AddMoreInfo(dFee, string.Empty, string.Empty, string.Empty, string.Empty,
                                                null, string.Empty, string.Empty, reg.RegistrationNo);
                                        dFee.Save();

                                        totalDebit += dFee.Debit.Value;
                                        totalCredit += dFee.Credit.Value;
                                        feeDiff += ic.CardFeeAmount ?? 0;
                                    }
                                }
                            }

                            // 
                            EDCMachine edcMachineEntity = new EDCMachine();
                            if (edcMachineEntity.LoadByPrimaryKey(tpi.EDCMachineID))
                            {
                                // Setting Account Code Per EDC Machine
                                if (edcMachineEntity.ChartOfAccountID.HasValue)
                                {
                                    dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                    dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                    dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);

                                    JournalTransactionDetails d = new JournalTransactionDetails();
                                    d.AddNew();
                                    d.JournalId = entity.JournalId;
                                    d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                                    d.SubLedgerId = dSubledgerId;

                                    d.Credit = (tpi.Amount > 0) ? tpi.Amount : 0;
                                    d.Debit = (tpi.Amount < 0) ? (tpi.Amount * -1) : 0;

                                    d.Description = string.Format("Back Office Correction REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pat.PatientName);

                                    d.DocumentNumber = tpi.PaymentNo;
                                    d.DocumentNumberSequenceNo = tpi.SequenceNo;

                                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                                                null, string.Empty, string.Empty, reg.RegistrationNo);

                                    d.Save();

                                    totalDebit += d.Debit.Value;
                                    totalCredit += d.Credit.Value;

                                    if ((tpi.CardFeeAmount ?? 0) > 0)
                                    {
                                        // debit
                                        JournalTransactionDetails dFee = new JournalTransactionDetails();
                                        dFee.AddNew();
                                        dFee.JournalId = entity.JournalId;
                                        dFee.ChartOfAccountId = dAccount;
                                        dFee.SubLedgerId = 0;
                                        dFee.Debit = (ic.CardFeeAmount < 0) ? (ic.CardFeeAmount * -1) : 0;
                                        dFee.Credit = (ic.CardFeeAmount > 0) ? ic.CardFeeAmount : 0;
                                        dFee.Description = string.Format("Card Fee Correction REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pat.PatientName);
                                        dFee.DocumentNumber = tpi.PaymentNo;
                                        dFee.DocumentNumberSequenceNo = tpi.SequenceNo;

                                        AddMoreInfo(dFee, string.Empty, string.Empty, string.Empty, string.Empty,
                                                null, string.Empty, string.Empty, reg.RegistrationNo);
                                        dFee.Save();

                                        totalDebit += dFee.Debit.Value;
                                        totalCredit += dFee.Credit.Value;
                                        feeDiff -= (tpi.CardFeeAmount ?? 0);
                                    }
                                }
                            }

                            // kalau ada selisih fee
                            // credit
                            if (feeDiff != 0)
                            {
                                JournalTransactionDetails cFee = new JournalTransactionDetails();
                                cFee.AddNew();
                                cFee.JournalId = entity.JournalId;
                                cFee.ChartOfAccountId = ValidateCOA(GetCachedAccountFromParam("coa_PaymentCardFeeAmt"), coaColl, "AppParameter:coa_PaymentCardFeeAmt");
                                cFee.SubLedgerId = 0;
                                cFee.Debit = (feeDiff < 0) ? (feeDiff * -1) : 0;
                                cFee.Credit = (feeDiff > 0) ? feeDiff : 0;
                                cFee.Description = string.Format("Card Fee Correction REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pat.PatientName);
                                cFee.DocumentNumber = tpi.PaymentNo;
                                cFee.DocumentNumberSequenceNo = tpi.SequenceNo;

                                AddMoreInfo(cFee, string.Empty, string.Empty, string.Empty, string.Empty,
                                            null, string.Empty, string.Empty, tp.RegistrationNo);

                                cFee.Save();

                                totalDebit += cFee.Debit.Value;
                                totalCredit += cFee.Credit.Value;
                            }
                        }
                    }
                }
                // end jurnal balik

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    // insert cash transaction here
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
                    {
                        int? cashTransactionId;
                        CashTransaction.AddNewAutomaticCashTransactionPaymentReceiveCashierCorrectionFromJournal(
                            tpc, tpcItems, entity, editedBy, out cashTransactionId);
                        // otomatis posting
                        if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                        {
                            CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewCashierCorrectionJournalUnApproval(string journalType, TransPaymentCorrection tpc, TransPaymentItemCorrectionCollection tpcItems, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Cashier Correction
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qd = new JournalTransactionDetailsQuery("qd");

            qh.es.Distinct = true;

            qh.InnerJoin(qd).On(qh.JournalId == qd.JournalId)
                .Where(qh.RefferenceNumber == tpc.PaymentCorrectionNo, qh.JournalIdRefference.IsNull(), qh.IsVoid == false)
                .Select(qh)
                .OrderBy(qh.JournalId.Descending);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    ctColl.Query.JournalId == jhcoll[0].JournalId.Value,
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current transaction");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                string prefix = jhcoll[0].JournalCode.Substring(0, jhcoll[0].JournalCode.Length - 4);

                var ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, prefix, editedBy);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                // ---------------------

                // void auto cash entry
                return ret;
            }
        }

        public static int? AddNewPaymentCashBasedJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string RefNo, string editedBy, int journalId)
        {
            return AddNewPaymentCashBasedJournalV2(journalType, tp, reg, tpItems, prefix, RefNo, editedBy, journalId);

            //payment received
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                bool newJournal = journalId == 0;
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                //var CoaColl = new ChartOfAccountsCollection();
                var regType = reg.SRRegistrationType;

                string guarID = string.IsNullOrEmpty(tp.GuarantorID) ? reg.GuarantorID : tp.GuarantorID;
                var grn = new Guarantor();
                grn.LoadByPrimaryKey(guarID);

                var sSelfGuarantorID = "SELF";
                var self = new AppParameter();
                self.LoadByPrimaryKey("SelfGuarantorID");
                sSelfGuarantorID = self.ParameterValue;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = (journalType == "07") ? "PAYMENT RETURN" : "PAYMENT";

                //Journal Header
                JournalTransactions entity = new JournalTransactions();

                // cegah double jurnal
                if (journalId == 0)
                {
                    entity.Query.Where(entity.Query.RefferenceNumber == RefNo, entity.Query.JournalIdRefference.IsNull());
                    entity.Query.es.Top = 1;
                    if (entity.Load(entity.Query))
                    {
                        journalId = entity.JournalId.Value;
                    }
                }

                entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                    entity.IsVoid = false;

                    // delete prev message
                    JournalErrorMessageDelete(entity);
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    if (journalType == BusinessObject.JournalType.ARCreating)
                    {
                        if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                        {
                            entity.Description = string.Format("{0} SUP#:{1}", entity.Description, grn.GuarantorName);
                        }
                    }
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;
                }
                entity.Save();
                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal TotalPaymentCurrent = 0;
                decimal RoundingCurrent = 0;
                decimal TotalBalance = 0;
                decimal adminGuarantor = 0;

                DataTable dtbl = new DataTable();
                dtbl.Columns.Add("coaId", typeof(int));
                dtbl.Columns.Add("subledgerId", typeof(int));
                dtbl.Columns.Add("balance", Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", Type.GetType("System.Decimal"));

                keterangan = (journalType == "07") ? "RETURN" : "";

                var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

                var stdDR = new AppStandardReferenceItemCollection();
                stdDR.Query.Where(stdDR.Query.StandardReferenceID == "DiscountReason");
                stdDR.LoadAll();

                foreach (var p in tpItems)
                {
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;
                    bool isCardPayment = false;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    string dAccountMsg = string.Empty;
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                            continue;
                    }

                    if (pm.ChartOfAccountID.HasValue)
                    {
                        dAccount = pm.ChartOfAccountID.Value;
                        dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        dAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                    }

                    // if appstdref of discount reason has coa
                    string DiscountReason = string.Empty;
                    if (!string.IsNullOrEmpty(p.SRDiscountReason) && p.SRPaymentType == "PaymentType-005")
                    {
                        var sDiscReason = stdDR.Where(std => std.ItemID == p.SRDiscountReason);
                        if (sDiscReason.Count() > 0)
                        {
                            var dsc = sDiscReason.First();
                            DiscountReason = dsc.ItemName;
                            dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
                            if ((dsc.coaID ?? 0) != 0)
                            {
                                dAccount = dsc.coaID.Value;
                                dSubledgerId = dsc.subledgerID ?? 0;
                            }
                        }
                    }

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        //transfer
                        if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            bool skipBank = false;
                            if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaCashierPaymentTransferFromPaymentMethod))
                            {
                                // 
                                try
                                {
                                    ValidateCOA(pm.ChartOfAccountID, coaColl);
                                    skipBank = true;
                                }
                                catch (Exception ex)
                                {

                                }
                            }
                            if (!skipBank)
                            {
                                Bank bank = new Bank();
                                if (bank.LoadByPrimaryKey(p.BankID))
                                {
                                    if (bank.ChartOfAccountId.HasValue)
                                        dAccount = bank.ChartOfAccountId.Value;
                                    if (bank.SubledgerId.HasValue)
                                        dSubledgerId = bank.SubledgerId.Value;
                                    dAccountMsg = string.Format("Bank: {0}", bank.BankName);
                                }
                            }
                        }
                    }

                    if (p.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        //if (p.Amount.Value != 0)
                        //{
                        //    int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                        //    // int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");




                        //    JournalTransactionDetails d = new JournalTransactionDetails();
                        //    d.AddNew();
                        //    d.JournalId = entity.JournalId;
                        //    d.ChartOfAccountId = dAccount_off;
                        //    d.SubLedgerId = 0;
                        //    d.Debit = Abs(p.Amount + p.Balance ?? 0);
                        //    d.Credit = 0;
                        //    d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan, 
                        //        (DiscountReason.Length > 0 ? " ":"") + DiscountReason);
                        //    d.DocumentNumber = tp.PaymentNo;
                        //    d.Save();

                        //    totalDebit += d.Debit.Value;
                        //}

                        // start uang muka
                        // perlu dicari ini uang muka dari payment registrasi yang mana supaya 
                        // pas tarik ledger bisa direkon, harus pecah per noreg
                        int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                        var dpdt = new TransPaymentItemQuery("a");
                        var dphd = new TransPaymentQuery("b");

                        dpdt.InnerJoin(dphd).On(dpdt.PaymentNo == dphd.PaymentNo)
                            .Where(dphd.PaymentReferenceNo == p.PaymentNo,
                                dphd.IsApproved == true,
                                dphd.IsVoid == false,
                                dphd.TransactionCode == "018")
                            .OrderBy(dphd.RegistrationNo.Descending, dphd.PaymentNo.Ascending)
                            .Select(dphd.RegistrationNo, dphd.PaymentNo, dpdt.Amount, dpdt.Balance);
                        DataTable dtpay = dpdt.LoadDataTable();
                        decimal sumAmount = 0;
                        for (int i = 0; i < dtpay.Rows.Count; i++)
                        {
                            sumAmount += (decimal)(dtpay.Rows[i]["Amount"] ?? 0) + (decimal)(dtpay.Rows[i]["Balance"] ?? 0);
                            if (dtpay.Rows[i]["RegistrationNo"].ToString() !=
                                ((i + 1 == dtpay.Rows.Count) ? "" : dtpay.Rows[i + 1]["RegistrationNo"].ToString()))
                            {
                                // this is the last row or last current reg, do save
                                JournalTransactionDetails d = new JournalTransactionDetails();
                                d.AddNew();
                                d.JournalId = entity.JournalId;
                                d.ChartOfAccountId = ValidateCOA(dAccount_off, coaColl, "App Parameter: coa_DownPayment");
                                d.SubLedgerId = 0;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                d.Debit = (sumAmount > 0) ? sumAmount : 0;
                                d.Credit = (sumAmount < 0) ? (sumAmount * -1) : 0;
                                // end of modif teguh s 2016 06 02

                                d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", dtpay.Rows[i]["RegistrationNo"].ToString(), pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                                    (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                                d.DocumentNumber = tp.PaymentNo;
                                d.DocumentNumberSequenceNo = p.SequenceNo;

                                AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                                d.Save();

                                totalDebit += d.Debit.Value;
                                totalCredit += d.Credit.Value;
                                TotalPaymentCurrent += sumAmount;
                                sumAmount = 0;
                            }
                        }
                        // end uang muka

                        if (p.Balance.Value != 0) //payment return
                        {
                            //int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");
                            int cAccountPayable_off = GetCachedAccountFromParam("coa_DownPaymentReturnPayable");

                            ////-------------- ini dulunya kenapa diremark?
                            //JournalTransactionDetails d = new JournalTransactionDetails();
                            //d.AddNew();
                            //d.JournalId = entity.JournalId;
                            //d.ChartOfAccountId = dAccount_off;
                            //d.SubLedgerId = 0;
                            //d.Debit = Abs(p.Balance);
                            //d.Credit = 0;
                            //d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            //d.DocumentNumber = tp.PaymentNo;
                            //d.Save();

                            //totalDebit += d.Debit.Value;
                            ////-------------------------------------

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            if (p.IsBackOfficeReturn ?? false)
                                c.ChartOfAccountId = ValidateCOA(cAccountPayable_off, coaColl, "App Parameter: coa_DownPaymentReturnPayable");
                            else
                                c.ChartOfAccountId = ValidateCOA(cAccount_off, coaColl, "App Parameter: coa_DownPaymentReturn");
                            c.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            c.Debit = (p.Balance < 0) ? (p.Balance * -1) : 0;
                            c.Credit = (p.Balance > 0) ? p.Balance : 0;
                            // end of modif teguh s 2016 06 02

                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(c, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                            c.Save();

                            totalDebit += c.Debit.Value;
                            totalCredit += c.Credit.Value;
                            TotalBalance += p.Balance.Value;
                        }
                    }
                    else
                    {
                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                        {
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");
                        }

                        // piutang instansi || piutang personal
                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
                            {
                                var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);
                                //var coaInv = IsSplitIprOpr ? guarantorEntity.ChartOfAccountId : ();
                                //if (guarantorEntity.ChartOfAccountId.HasValue)
                                //{
                                var PrmUsingInvoicing = new AppParameter();
                                if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
                                {
                                    throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
                                }
                                if (PrmUsingInvoicing.ParameterValue == "Yes")
                                {
                                    AppParameter app = new AppParameter();
                                    app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                                    if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                                    {
                                        /* 
                                         * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                                         * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                                         * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                                         * kalau bingung tanya teguh s
                                         */
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
                                    }
                                    else
                                    {
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdTemporaryIPR ?? 0) : (guarantorEntity.ChartOfAccountIdTemporary ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubledgerIdTemporaryIPR ?? 0) : (guarantorEntity.SubledgerIdTemporary ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Invoice)", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                    }
                                }
                                else
                                {
                                    dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                    dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                    dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process){1}", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                }
                                //}
                            }
                        }

                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                isCardPayment = true;
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                        dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);
                                    }
                                }
                            }
                        }

                        //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                        d.SubLedgerId = dSubledgerId;

                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                        d.Debit = (p.Amount > 0) ? p.Amount : 0;
                        d.Credit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                        // end of modif teguh s 2016 06 02

                        d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                            (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                        if (journalType == BusinessObject.JournalType.ARCreating)
                        {
                            if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                            {
                                d.Description = string.Format("{0} SUP#:{1}", d.Description, grn.GuarantorName);
                            }
                        }
                        d.DocumentNumber = tp.PaymentNo;
                        d.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                        TotalPaymentCurrent += p.Amount.Value;

                    }

                    if ((p.RoundingAmount ?? 0) != 0)
                    {
                        // no rounding for card payment, (payment bugs escape)
                        //if (!isCardPayment)
                        //{
                        int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                        JournalTransactionDetails k = new JournalTransactionDetails();
                        k.AddNew();
                        k.JournalId = entity.JournalId;
                        k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
                        k.SubLedgerId = 0;

                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                        k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                        k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                        // end of modif teguh s 2016 06 02

                        k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        k.DocumentNumber = tp.PaymentNo;
                        k.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        k.Save();

                        totalDebit += k.Debit.Value;
                        totalCredit += k.Credit.Value;

                        RoundingCurrent += (p.RoundingAmount ?? 0);
                        //}
                    }
                    // ADM pindah kebawah

                    // if there is CC fee
                    if (p.CardFeeAmount > 0)
                    {
                        // debit
                        JournalTransactionDetails dFee = new JournalTransactionDetails();
                        dFee.AddNew();
                        dFee.JournalId = entity.JournalId;
                        dFee.ChartOfAccountId = dAccount;
                        dFee.SubLedgerId = 0;
                        dFee.Debit = Abs(p.CardFeeAmount);
                        dFee.Credit = 0;
                        dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        dFee.DocumentNumber = tp.PaymentNo;
                        dFee.DocumentNumberSequenceNo = p.SequenceNo;

                        dFee.GuarantorID = grn.GuarantorID;
                        dFee.Save();

                        totalDebit += dFee.Debit.Value;

                        // credit
                        JournalTransactionDetails cFee = new JournalTransactionDetails();
                        cFee.AddNew();
                        cFee.JournalId = entity.JournalId;
                        cFee.ChartOfAccountId = ValidateCOA(GetCachedAccountFromParam("coa_PaymentCardFeeAmt"), coaColl, "AppParameter:coa_PaymentCardFeeAmt");
                        cFee.SubLedgerId = 0;
                        cFee.Debit = 0;
                        cFee.Credit = Abs(p.CardFeeAmount);
                        cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        cFee.DocumentNumber = tp.PaymentNo;
                        cFee.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(cFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        cFee.Save();

                        totalCredit += cFee.Credit.Value;
                    }
                }

                /* start hitung jurnal pendapatan */
                DataTable dtb;
                decimal TotalCostCalc = tpItems.Select(x => (x.RoundingAmount ?? 0)).Sum(); // --> lupa dulu buat apa| totalCredit - ((totalDebit < 0) ? totalDebit : 0);
                decimal Selisih = 0;
                decimal tCredit = 0;
                decimal tDebit = 0;

                List<PackageJournal> pkg = new List<PackageJournal>();

                var a = new TransPaymentItemIntermBillQuery();
                a.Where(a.PaymentNo == RefNo);
                dtb = a.LoadDataTable();
                if (dtb.Rows.Count == 0)
                {
                    var b = new TransPaymentItemIntermBillGuarantorQuery();
                    b.Where(b.PaymentNo == RefNo);
                    dtb = new DataTable();
                    dtb = b.LoadDataTable();
                }

                string[] paket = null;
                bool acc_IsJournalPackageB4Approve =
                    AppParameter.GetParameterValue(
                        AppParameter.ParameterItem.acc_IsJournalPackageB4Approve) == "Yes";
                /*BELUM SELESAI*/

                var cc = new TransPaymentItemOrderCollection();
                cc.Query.Where(cc.Query.PaymentNo == RefNo);
                if (newJournal) cc.Query.Where(cc.Query.JournalIncomePaymentNo == string.Empty);
                else
                    //cc.Query.Where(cc.Query.PaymentNo == RefNo);
                    cc.Query.Where(
                        cc.Query.Or(
                            cc.Query.JournalIncomePaymentNo == string.Empty,
                            cc.Query.JournalIncomePaymentNo == RefNo
                        )
                    );
                if (cc.LoadAll())
                {
                    //paket non mcu
                    paket = new string[cc.Count];
                    foreach (var row in cc)
                    {
                        var details = new TransChargesItemCollection();
                        details.Query.Where(details.Query.TransactionNo == row.TransactionNo, details.Query.ParentNo == row.SequenceNo, details.Query.IsExtraItem == false);
                        if (details.Query.Load())
                        {
                            paket.SetValue(row.PaymentNo + ";" + row.TransactionNo + ";" + row.SequenceNo, paket.Length - paket.Count(p => string.IsNullOrEmpty(p)));
                            foreach (var detail in details)
                            {
                                var entity2 = cc.AddNew();
                                entity2.TransactionNo = detail.TransactionNo;
                                entity2.SequenceNo = detail.SequenceNo;
                                entity2.PaymentNo = row.PaymentNo;
                                entity2.ItemID = detail.ItemID;
                                entity2.Qty = detail.ChargeQuantity;
                                entity2.Price = detail.Price - (detail.DiscountAmount / detail.ChargeQuantity);
                            }
                        }
                    }

                    // paket mcu
                    foreach (var row in cc)
                    {
                        var tc2 = new TransChargesCollection();
                        tc2.Query.Where(tc2.Query.PackageReferenceNo == row.TransactionNo, tc2.Query.IsVoid == false);
                        if (tc2.Query.Load())
                        {
                            paket.SetValue(row.PaymentNo + ";" + row.TransactionNo + ";" + row.SequenceNo, paket.Length - paket.Count(p => string.IsNullOrEmpty(p)));
                            //pkgAmount += (row.Price ?? 0) * (row.Qty ?? 0);
                            var dPkg = new PackageJournal();
                            dPkg.TransactionNo = row.TransactionNo;
                            dPkg.SequenceNo = row.SequenceNo;
                            dPkg.ItemID = row.ItemID;
                            dPkg.PackageAmount = (row.Price ?? 0) * (row.Qty ?? 0);
                            dPkg.PackageDetailAmount = 0;

                            foreach (var t2 in tc2)
                            {
                                var tci2 = new TransChargesItemCollection();
                                tci2.Query.Where(tci2.Query.TransactionNo == t2.TransactionNo, tci2.Query.IsVoid == false);
                                if (tci2.Query.Load())
                                {
                                    // diskon paket pasien pribadi goes here

                                    foreach (var ti2 in tci2)
                                    {
                                        if (ti2.ChargeQuantity != 0)
                                        {
                                            if (ti2.IsApprove ?? false)
                                            {
                                                var entity2 = cc.AddNew();
                                                entity2.TransactionNo = ti2.TransactionNo;
                                                entity2.SequenceNo = ti2.SequenceNo;
                                                entity2.PaymentNo = row.PaymentNo;
                                                entity2.ItemID = ti2.ItemID;
                                                entity2.Qty = ti2.ChargeQuantity;
                                                entity2.Price = ti2.Price - (ti2.DiscountAmount / ti2.ChargeQuantity);

                                                //pkgDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                                dPkg.PackageDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                            }
                                            else
                                            {
                                                if (acc_IsJournalPackageB4Approve)
                                                {
                                                    var entity2 = cc.AddNew();
                                                    entity2.TransactionNo = ti2.TransactionNo;
                                                    entity2.SequenceNo = ti2.SequenceNo;
                                                    entity2.PaymentNo = row.PaymentNo;
                                                    entity2.ItemID = ti2.ItemID;
                                                    entity2.Qty = ti2.ChargeQuantity;
                                                    entity2.Price = ti2.Price - (ti2.DiscountAmount / ti2.ChargeQuantity);

                                                    //pkgDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                                    dPkg.PackageDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            pkg.Add(dPkg);
                        }
                    }

                    //foreach (var p in paket.Where(n => !string.IsNullOrEmpty(n)))
                    //{
                    //    var entity2 = cc.FindByPrimaryKey(p.Split(';')[0], p.Split(';')[1], p.Split(';')[2]);
                    //    if (entity2 != null) entity2.MarkAsDeleted();
                    //}
                }

                foreach (var row in cc)
                {
                    var prs = new TransPrescriptionItem();
                    if (prs.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                        TotalCostCalc += prs.LineAmount.Value;
                    else
                        TotalCostCalc += row.Qty.Value * row.Price.Value;

                    var tpio = new TransPaymentItemOrder();
                    if (tpio.LoadByPrimaryKey(row.PaymentNo, row.TransactionNo, row.SequenceNo))
                    {
                        if (string.IsNullOrEmpty(tpio.JournalIncomePaymentNo))
                        {
                            tpio.JournalIncomePaymentNo = row.PaymentNo;
                            tpio.Save();
                        }
                    }

                    var TransC = new TransCharges();
                    if (TransC.LoadByPrimaryKey(row.TransactionNo))
                    {
                        var transCI = new TransChargesItem();
                        if (transCI.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                        {
                            var cCalc = new CostCalculation();
                            if (cCalc.LoadByPrimaryKey(TransC.RegistrationNo, row.TransactionNo, row.SequenceNo))
                            {
                                /* start journal*/
                                var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                                /* end journal */
                            }
                            else
                            {
                                ////if (paket != null)
                                //if(paket != null)
                                //{
                                //    if(paket.Where(p => p != null).Select(p => 
                                //        p.Split(new string[]{";"},StringSplitOptions.RemoveEmptyEntries)[1])
                                //        .Contains((TransC.PackageReferenceNo ?? string.Empty) == string.Empty ? "xxx":TransC.PackageReferenceNo))
                                //    {
                                cCalc = new CostCalculation();
                                cCalc.RegistrationNo = TransC.RegistrationNo;
                                cCalc.TransactionNo = row.TransactionNo;
                                cCalc.SequenceNo = row.SequenceNo;
                                cCalc.ItemID = row.ItemID;
                                cCalc.PatientAmount = transCI.ChargeQuantity * (transCI.Price - (transCI.DiscountAmount / (transCI.ChargeQuantity == 0 ? 1 : transCI.ChargeQuantity)));
                                cCalc.GuarantorAmount = 0;
                                cCalc.DiscountAmount = transCI.DiscountAmount;

                                /* start journal*/
                                var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                                /* end journal */
                                //    }
                                //}
                                //else {
                                //    decimal td = 0;
                                //    decimal tc = 0;

                                //    int? hehe = AddNewIncomeJournalCashBased_IsOrderTrue(entity.JournalId ?? 0, transCI, out tc, out td, false);
                                //    totalDebit += td;
                                //    totalCredit += tc;
                                //}
                            }
                        }
                    }
                    //precription
                    else
                    {
                        var transPresc = new TransPrescription();
                        transPresc.LoadByPrimaryKey(row.TransactionNo);

                        var cCalc = new CostCalculation();
                        if (cCalc.LoadByPrimaryKey(transPresc.RegistrationNo, row.TransactionNo, row.SequenceNo))
                        {
                            /* start journal*/
                            var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, 0, coaColl);
                            jtdColl.Save();
                            totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                            totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            /* end journal */
                        }
                    }
                }

                decimal TIntermbill = 0, TPayment = 0;
                if (dtb.Rows.Count > 0)
                {
                    foreach (DataRow row in dtb.Rows)
                    {
                        var q = new IntermBillCollection();
                        //q.Query.Where(
                        //    q.Query.IntermBillNo == row["intermBillNo"],
                        //    q.Query.Or(
                        //        q.Query.JournalIncomePaymentNo == string.Empty,
                        //        q.Query.JournalIncomePaymentNo == RefNo
                        //        )
                        //    );
                        ////q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"], q.Query.JournalIncomePaymentNo == RefNo);
                        ////q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"]);
                        //q.LoadAll();

                        var ibq = new IntermBillQuery("ibq");
                        var tp2 = new TransPaymentQuery("tp2");
                        ibq.LeftJoin(tp2).On(ibq.JournalIncomePaymentNo == tp2.PaymentNo && tp2.IsVoid == false);
                        ibq.Where(
                            ibq.IntermBillNo == row["intermBillNo"],
                            ibq.Or(
                                "<ISNULL(tp2.PaymentNo,'') = '' OR >",
                                ibq.JournalIncomePaymentNo == RefNo
                                )
                            );
                        ibq.Select(ibq);
                        ibq.es.Distinct = true;
                        q.Load(ibq);


                        foreach (var x in q)
                        {
                            //if (string.IsNullOrEmpty(x.JournalIncomePaymentNo))
                            //{
                            x.JournalIncomePaymentNo = RefNo;
                            q.Save();
                            //}

                            var cost = new CostCalculationQuery("a");
                            var charges = new TransChargesQuery("k");
                            var chargesItem = new TransChargesItemQuery("l");

                            cost.Select(
                                cost.RegistrationNo,
                                chargesItem.TransactionNo,
                                chargesItem.SequenceNo,
                                chargesItem.ReferenceNo,
                                chargesItem.ReferenceSequenceNo,
                                chargesItem.ItemID,
                                chargesItem.ChargeQuantity,
                                cost.PatientAmount,
                                cost.GuarantorAmount,
                                cost.DiscountAmount,
                                @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                                );
                            cost.InnerJoin(charges).On(cost.TransactionNo == charges.TransactionNo);
                            cost.InnerJoin(chargesItem).On(
                                cost.TransactionNo == chargesItem.TransactionNo &&
                                cost.SequenceNo == chargesItem.SequenceNo
                                );
                            cost.Where(
                                cost.IntermBillNo == x.IntermBillNo,
                                cost.Or(
                                    cost.ParentNo == string.Empty,
                                    cost.ParentNo.IsNull()
                                    )
                                );
                            cost.OrderBy(
                                cost.RegistrationNo.Ascending,
                                charges.TransactionNo.Ascending,
                                chargesItem.SequenceNo.Ascending
                                );

                            DataTable table = cost.LoadDataTable();

                            //paket mcu
                            var cc1 = new CostCalculationCollection();
                            cc1.Query.Where(cc1.Query.IntermBillNo == x.IntermBillNo);
                            if (cc1.Query.Load())
                            {
                                var tc1 = new TransChargesCollection();
                                tc1.Query.Where(tc1.Query.PackageReferenceNo.In(cc1.Select(c1 => c1.TransactionNo)));
                                if (tc1.Query.Load())
                                {
                                    cost = new CostCalculationQuery("a");
                                    charges = new TransChargesQuery("k");
                                    chargesItem = new TransChargesItemQuery("l");

                                    cost.Select(
                                        cost.RegistrationNo,
                                        chargesItem.TransactionNo,
                                        chargesItem.SequenceNo,
                                        chargesItem.ReferenceNo,
                                        chargesItem.ReferenceSequenceNo,
                                        chargesItem.ItemID,
                                        chargesItem.ChargeQuantity,
                                        cost.PatientAmount,
                                        cost.GuarantorAmount,
                                        cost.DiscountAmount,
                                        @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                                        );
                                    cost.InnerJoin(charges).On(cost.TransactionNo == charges.TransactionNo);
                                    cost.InnerJoin(chargesItem).On(
                                        cost.TransactionNo == chargesItem.TransactionNo &&
                                        cost.SequenceNo == chargesItem.SequenceNo
                                        );
                                    cost.Where(
                                        cost.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                                        cost.Or(
                                            cost.ParentNo == string.Empty,
                                            cost.ParentNo.IsNull()
                                            )
                                        );
                                    cost.OrderBy(
                                        cost.RegistrationNo.Ascending,
                                        charges.TransactionNo.Ascending,
                                        chargesItem.SequenceNo.Ascending
                                        );

                                    table.Merge(cost.LoadDataTable());

                                    // kalau ada yang udah approve tapi gak ada di cost calculation
                                    charges = new TransChargesQuery("k");
                                    chargesItem = new TransChargesItemQuery("l");
                                    cost = new CostCalculationQuery("a");

                                    charges.Select(
                                            charges.RegistrationNo,
                                            chargesItem.TransactionNo,
                                            chargesItem.SequenceNo,
                                            chargesItem.ReferenceNo,
                                            chargesItem.ReferenceSequenceNo,
                                            chargesItem.ItemID,
                                            chargesItem.ChargeQuantity,
                                            "<CAST(l.Price * l.[ChargeQuantity] AS MONEY) PatientAmount>",
                                            "<CAST(0 AS MONEY) [GuarantorAmount]>",
                                            "<l.DiscountAmount [DiscountAmount]>",
                                            @"<CAST(0 AS BIT) AS 'IsDeleted'>")
                                        .InnerJoin(chargesItem).On(charges.TransactionNo == chargesItem.TransactionNo)
                                        .LeftJoin(cost).On(chargesItem.TransactionNo == cost.TransactionNo &&
                                            chargesItem.SequenceNo == cost.SequenceNo)
                                        .Where(
                                        charges.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                                        charges.Or(
                                            chargesItem.ParentNo == string.Empty,
                                            chargesItem.ParentNo.IsNull()
                                            ),
                                            chargesItem.IsApprove == true,
                                        cost.TransactionNo.IsNull()
                                        )
                                        .OrderBy(
                                        charges.RegistrationNo.Ascending,
                                        charges.TransactionNo.Ascending,
                                        chargesItem.SequenceNo.Ascending
                                        );

                                    table.Merge(charges.LoadDataTable());

                                    // unapproved detail package
                                    if (acc_IsJournalPackageB4Approve)
                                    {
                                        charges = new TransChargesQuery("k");
                                        chargesItem = new TransChargesItemQuery("l");
                                        cost = new CostCalculationQuery("a");

                                        charges.Select(
                                                charges.RegistrationNo,
                                                chargesItem.TransactionNo,
                                                chargesItem.SequenceNo,
                                                chargesItem.ReferenceNo,
                                                chargesItem.ReferenceSequenceNo,
                                                chargesItem.ItemID,
                                                chargesItem.ChargeQuantity,
                                                "<CAST(l.Price * l.[ChargeQuantity] AS MONEY) PatientAmount>",
                                                "<CAST(0 AS MONEY) [GuarantorAmount]>",
                                                "<l.DiscountAmount [DiscountAmount]>",
                                                @"<CAST(0 AS BIT) AS 'IsDeleted'>")
                                            .InnerJoin(chargesItem).On(charges.TransactionNo == chargesItem.TransactionNo)
                                            .LeftJoin(cost).On(chargesItem.TransactionNo == cost.TransactionNo &&
                                                chargesItem.SequenceNo == cost.SequenceNo)
                                            .Where(
                                            charges.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                                            charges.Or(
                                                chargesItem.ParentNo == string.Empty,
                                                chargesItem.ParentNo.IsNull()
                                                ),
                                            cost.TransactionNo.IsNull()
                                            )
                                            .OrderBy(
                                            charges.RegistrationNo.Ascending,
                                            charges.TransactionNo.Ascending,
                                            chargesItem.SequenceNo.Ascending
                                            );

                                        table.Merge(charges.LoadDataTable());
                                    }

                                    foreach (var rr in table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct()
                                         .Contains(r.Field<string>("TransactionNo"))).ToList())
                                    {
                                        var dPkg = new PackageJournal();
                                        dPkg.TransactionNo = rr.Field<string>("TransactionNo");
                                        dPkg.SequenceNo = rr.Field<string>("SequenceNo");
                                        dPkg.ItemID = rr.Field<string>("ItemID");
                                        dPkg.PackageAmount = rr.Field<decimal>("PatientAmount") + rr.Field<decimal>("GuarantorAmount");
                                        dPkg.PackageDetailAmount = 0;

                                        dPkg.PackageDetailAmount = table.Rows.Cast<DataRow>()
                                        .Where(r => (
                                            tc1.Where(t1 => !string.IsNullOrEmpty(t1.PackageReferenceNo) && !(t1.IsPackage ?? false))//t1.TransactionNo == dPkg.TransactionNo)
                                            .Select(t1 => t1.TransactionNo)
                                        ).Contains(r.Field<string>("TransactionNo"))).ToList()
                                        .Sum(r => r.Field<decimal>("PatientAmount") + r.Field<decimal>("GuarantorAmount"));

                                        pkg.Add(dPkg);
                                    }

                                    //pkgAmount += table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct()
                                    //    .Contains(r.Field<string>("TransactionNo"))).ToList()
                                    //    .Sum(r => r.Field<decimal>("PatientAmount") + r.Field<decimal>("GuarantorAmount"));

                                    //pkgDetailAmount += table.Rows.Cast<DataRow>()
                                    //    .Where(r => (
                                    //        tc1.Where(t1 => !string.IsNullOrEmpty(t1.PackageReferenceNo)).Select(t1 => t1.TransactionNo)
                                    //    ).Contains(r.Field<string>("TransactionNo"))).ToList()
                                    //    .Sum(r => r.Field<decimal>("PatientAmount") + r.Field<decimal>("GuarantorAmount"));

                                    table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct()
                                        .Contains(r.Field<string>("TransactionNo"))).ToList()
                                        .ForEach(r => r.Delete());
                                    table.AcceptChanges();
                                }
                            }

                            DataTable temp = table.Copy(), temp2 = table.Copy(); ;

                            var view = temp.DefaultView;
                            view.RowFilter = "ReferenceNo <> '' AND ReferenceSequenceNo <> ''";
                            temp = view.ToTable();
                            view.Dispose();

                            DataView view2 = temp2.DefaultView;
                            view2.RowFilter = "ReferenceNo = '' AND ReferenceSequenceNo = ''";
                            temp2 = view2.ToTable();
                            view2.Dispose();

                            foreach (DataRow r in table.Rows)
                            {
                                if (string.IsNullOrEmpty(r["ReferenceNo"].ToString()) && string.IsNullOrEmpty(r["ReferenceSequenceNo"].ToString()))
                                {
                                    foreach (DataRow tmp in temp.Rows.Cast<DataRow>().Where(tmp => r["TransactionNo"].ToString() == tmp["ReferenceNo"].ToString() &&
                                                                                                   r["SequenceNo"].ToString() == tmp["ReferenceSequenceNo"].ToString()))
                                    {
                                        r["ChargeQuantity"] = (decimal)r["ChargeQuantity"] + (decimal)tmp["ChargeQuantity"];
                                        r["PatientAmount"] = (decimal)r["PatientAmount"] + (decimal)tmp["PatientAmount"];
                                        r["GuarantorAmount"] = (decimal)r["GuarantorAmount"] + (decimal)tmp["GuarantorAmount"];
                                        r["DiscountAmount"] = (decimal)r["DiscountAmount"] + (decimal)tmp["DiscountAmount"];
                                    }
                                }
                                else
                                {
                                    foreach (DataRow tmp in temp2.Rows.Cast<DataRow>().Where(tmp => r["ReferenceNo"].ToString() == tmp["TransactionNo"].ToString() &&
                                                                                                    r["ReferenceSequenceNo"].ToString() == tmp["SequenceNo"].ToString()))
                                    {
                                        r["IsDeleted"] = true;
                                    }
                                }
                            }

                            table.AcceptChanges();

                            foreach (DataRow r in table.Rows.Cast<DataRow>().Where(r => ((decimal)r["ChargeQuantity"] == 0) || ((bool)r["IsDeleted"])))
                            {
                                r.Delete();
                            }

                            table.AcceptChanges();


                            var cost2 = new CostCalculationQuery("m");
                            var TransPresc = new TransPrescriptionQuery("n");
                            var TransPrescItem = new TransPrescriptionItemQuery("o");

                            cost2.Select(
                                cost2.RegistrationNo,
                               cost2.TransactionNo,
                                TransPrescItem.SequenceNo,
                                TransPrescItem.ReferenceNo,
                                TransPrescItem.ReferenceSequenceNo,
                                cost2.ItemID,
                                TransPrescItem.PrescriptionQty.As("ChargeQuantity"),
                                cost2.PatientAmount,
                                cost2.GuarantorAmount,
                                cost2.DiscountAmount,
                                @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                                );
                            cost2.InnerJoin(TransPresc).On(cost2.TransactionNo == TransPresc.PrescriptionNo);
                            cost2.InnerJoin(TransPrescItem).On(
                                cost2.TransactionNo == TransPrescItem.PrescriptionNo &&
                                cost2.SequenceNo == TransPrescItem.SequenceNo
                                );
                            cost2.Where(
                                cost2.IntermBillNo == x.IntermBillNo

                                );
                            cost2.OrderBy(
                                cost2.RegistrationNo.Ascending,
                                TransPresc.PrescriptionNo.Ascending,
                                TransPrescItem.SequenceNo.Ascending
                                );

                            DataTable table2 = cost2.LoadDataTable();

                            table.Merge(table2);

                            foreach (DataRow r in table.Rows)
                            {
                                TotalCostCalc += (Convert.ToDecimal(r["PatientAmount"]) + Convert.ToDecimal(r["GuarantorAmount"]));

                                /* start journal */
                                var c = new CostCalculation();
                                c.RegistrationNo = r["RegistrationNo"].ToString();
                                c.TransactionNo = r["TransactionNo"].ToString();
                                c.SequenceNo = r["SequenceNo"].ToString();
                                c.ItemID = r["ItemID"].ToString();
                                c.PatientAmount = Convert.ToDecimal(r["PatientAmount"]);
                                c.GuarantorAmount = Convert.ToDecimal(r["GuarantorAmount"]);
                                c.DiscountAmount = Convert.ToDecimal(r["DiscountAmount"]);

                                var jtdColl = GetNewIncomeJournalCashBased(entity, c, false, Convert.ToDecimal(r["ChargeQuantity"]), coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            }

                            //var coll = new CostCalculationCollection();
                            //coll.Query.Where(coll.Query.IntermBillNo == x.IntermBillNo);
                            //coll.LoadAll();

                            //foreach (var r in coll)
                            //{
                            //    TotalCostCalc += r.PatientAmount.Value + r.GuarantorAmount.Value;

                            //    /* start journal */
                            //    decimal td = 0;
                            //    decimal tc = 0;

                            //    int? hehe = AddNewIncomeJournalCashBased(entity.JournalId ?? 0, r, out tc, out td, false);
                            //    totalDebit += td;
                            //    totalCredit += tc;
                            //}
                        }

                        // ambil total trnsaksi dari intermbill
                        var ibT = new IntermBill();
                        if (ibT.LoadByPrimaryKey(row["intermBillNo"].ToString()))
                        {
                            TIntermbill += ibT.PatientAmount.Value + ibT.GuarantorAmount.Value +
                                ibT.AdministrationAmount.Value + ibT.GuarantorAdministrationAmount.Value -
                                ibT.DiscAdmPatient.Value - ibT.DiscAdmGuarantor.Value;
                        }

                    }
                    List<string> ibs = new List<string>();
                    foreach (DataRow row in dtb.Rows)
                    {
                        ibs.Add(row["intermBillNo"].ToString());
                    }
                    // end of ambil total trnsaksi dari intermbill
                    // ambil total payment intermbil yang bersangkutan
                    var tpiTColl = new TransPaymentItemCollection();
                    var tpiT = new TransPaymentItemQuery("tpi");
                    var tpT = new TransPaymentQuery("tp");
                    var tpibgTColl = new TransPaymentItemIntermBillGuarantorCollection();
                    var tpibTColl = new TransPaymentItemIntermBillCollection();
                    tpibgTColl.Query.Where(tpibgTColl.Query.IntermBillNo.In(ibs));
                    tpibTColl.Query.Where(tpibTColl.Query.IntermBillNo.In(ibs));
                    tpibgTColl.LoadAll();
                    tpibTColl.LoadAll();
                    var PaymentNos = ((from s in tpibgTColl select s.PaymentNo)
                        .Union(from s in tpibTColl select s.PaymentNo)).Distinct();
                    if (PaymentNos.Count() > 0)
                    {
                        tpiT.InnerJoin(tpT).On(tpT.PaymentNo == tpiT.PaymentNo)
                            .Where(
                                tpT.IsApproved == true,
                                tpT.PaymentNo.In(PaymentNos),
                                tpT.PaymentNo <= tp.PaymentNo)
                            .Select(tpiT);
                        tpiTColl.Load(tpiT);
                        TPayment += tpiTColl.Sum(x => x.Amount.Value - x.RoundingAmount.Value);
                    }
                    // end of ambil total payment intermbil yang bersangkutan
                }

                // ADM
                foreach (var p in tpItems)
                {
                    string[] intermBillNo = new string[0];

                    var a1 = new TransPaymentItemIntermBillCollection();
                    a1.Query.Where(a1.Query.PaymentNo == RefNo);
                    if (a1.Query.Load())
                    {
                        intermBillNo = new string[a1.Count];
                        for (int i = 0; i < a1.Count; i++)
                        {
                            intermBillNo.SetValue(a1[i].IntermBillNo, i);
                        }
                    }
                    else
                    {
                        var b1 = new TransPaymentItemIntermBillGuarantorCollection();
                        b1.Query.Where(b1.Query.PaymentNo == RefNo);
                        if (b1.Query.Load())
                        {
                            intermBillNo = new string[b1.Count];
                            for (int i = 0; i < b1.Count; i++)
                            {
                                intermBillNo.SetValue(b1[i].IntermBillNo, i);
                            }
                        }
                    }

                    foreach (string ib1 in intermBillNo)
                    {
                        var ib = new IntermBill();
                        ib.LoadByPrimaryKey(ib1);
                        if (string.IsNullOrEmpty(ib.JournalIncomePaymentNo) || ib.JournalIncomePaymentNo == RefNo)
                        {
                            // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                            //if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                            {
                                if (((ib.AdministrationAmount - ib.DiscAdmPatient) + (ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor)) != 0
                                    // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                                    //if (reg.AdministrationAmount > 0 
                                    && (journalType.Equals(BusinessObject.JournalType.ARCreating) || journalType.Equals(BusinessObject.JournalType.Payment)) &&
                                    //tp.RemainingAmount <= 0 && 
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    var itemAdm = String.Empty;
                                    var CompID = String.Empty;
                                    AppParameter app = new AppParameter();
                                    if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                        itemAdm = app.ParameterValue;
                                    Item item = new Item();
                                    item.Query.Where(item.Query.ItemID == itemAdm);
                                    if (!item.Query.Load())
                                    {
                                        throw new Exception("App Parameter: coa_ItemIdBillingTotalAdmFee: " + itemAdm + " is not a valid service");
                                    }


                                    //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                                    AppParameter app2 = new AppParameter();
                                    if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                        CompID = app2.ParameterValue;
                                    TariffComponent ic = new TariffComponent();
                                    ic.Query.Where(ic.Query.TariffComponentID == CompID);
                                    if (!ic.Query.Load())
                                    {
                                        throw new Exception("App Parameter: coa_CompIDForBillingAdm: " + CompID + " is not a valid tarif component");
                                    }

                                    var su = new ServiceUnit();
                                    if (su.LoadByPrimaryKey(reg.ServiceUnitID))
                                    { }

                                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                                    itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                            itemService.Query.ItemID == itemAdm);
                                    if (!itemService.Query.Load())
                                    {
                                        throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
                                    }
                                    int? coaId = 0;
                                    int? subLedgerId = 0;

                                    var grr = new Guarantor();
                                    grr.LoadByPrimaryKey(reg.GuarantorID);

                                    ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                    itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                         itemComp.Query.ItemID == itemAdm,
                                                         itemComp.Query.TariffComponentID == CompID,
                                                         itemComp.Query.SRRegistrationType == regType,
                                                         itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                    if (itemComp.Query.Load())
                                    {
                                        if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemComp.ChartOfAccountIdIncome;
                                            subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                        }
                                    }

                                    // kalau Rawat Inap
                                    if (reg.SRRegistrationType == "IPR")
                                    {
                                        ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                        itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                            itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

                                        if (itemClass.Query.Load())
                                        {
                                            if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                            }
                                        }
                                    }

                                    //adm pasien
                                    if ((ib.AdministrationAmount - ib.DiscAdmPatient) != 0)
                                    {
                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                        j.SubLedgerId = subLedgerId;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var admIB = (ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0);
                                        j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                        j.Credit = (admIB > 0) ? admIB : 0;
                                        // end of modif teguh s 2016 06 02

                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, su.ServiceUnitID, item.ItemID, tp.RegistrationNo);
                                        j.Save();

                                        totalDebit += j.Debit.Value;
                                        totalCredit += j.Credit.Value;
                                        // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                        TotalCostCalc += j.Credit.Value - j.Debit.Value;
                                    }

                                    //adm guarantor
                                    if ((ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor) != 0)
                                    {
                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                        j.SubLedgerId = subLedgerId;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var admIB = (ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0);
                                        j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                        j.Credit = (admIB > 0) ? admIB : 0;
                                        // end of modif teguh s 2016 06 02

                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, string.Empty, item.ItemID, tp.RegistrationNo);
                                        j.Save();

                                        totalDebit += j.Debit.Value;
                                        totalCredit += j.Credit.Value;
                                        adminGuarantor = Abs((ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0));
                                        // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                        TotalCostCalc += j.Credit.Value - j.Debit.Value;
                                    }
                                }
                            }
                        }
                    }
                }
                // End of ADM

                // item tambahan tpio
                var tpacColl = new TransPaymentAdditionalChargesCollection();
                tpacColl.Query.Where(tpacColl.Query.PaymentNo == tp.PaymentNo);
                if (tpacColl.LoadAll())
                {
                    var stdAddCharges = new AppStandardReferenceItemCollection();
                    stdAddCharges.LoadByStandardReferenceID("CafeAdditionalCharges");
                    foreach (var tpac in tpacColl)
                    {
                        var addCharge = stdAddCharges.Where(ad => ad.ItemID == tpac.SRCafeAdditionalCharges).FirstOrDefault();
                        if (addCharge == null)
                        {
                            throw new Exception(string.Format("StandardRef: CafeAdditionalCharges: item {0} not found in data master", tpac.SRCafeAdditionalCharges));
                        }
                        var jTpac = new JournalTransactionDetails();
                        jTpac.AddNew();
                        jTpac.JournalId = entity.JournalId;
                        jTpac.ChartOfAccountId = ValidateCOA(addCharge.coaID, coaColl, "StandardRef: CafeAdditionalCharges: {0}", addCharge.ItemName);
                        jTpac.SubLedgerId = 0;
                        jTpac.Debit = 0;
                        jTpac.Credit = tpac.ChargeAmount;
                        jTpac.Description = string.Format("REG#:{0}. PATIENT:{1}. {2}",
                            reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, addCharge.ItemName);
                        jTpac.DocumentNumber = tp.PaymentNo;

                        AddMoreInfo(jTpac, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, tp.RegistrationNo);
                        jTpac.Save();

                        totalDebit += jTpac.Debit.Value;
                        totalCredit += jTpac.Credit.Value;

                        TotalCostCalc += jTpac.Credit.Value;
                    }
                }

                //TotalCostCalc += pkg.Sum(x => x.PackageAmount) - pkg.Sum(x => x.PackageDetailAmount);// pkgAmount - pkgDetailAmount;

                var SelisihPaket = pkg.Sum(x => x.PackageAmount) - pkg.Sum(x => x.PackageDetailAmount);

                TotalPaymentCurrent = TotalPaymentCurrent - TotalBalance;

                Selisih = (TotalCostCalc + SelisihPaket) - TotalPaymentCurrent;

                int coa_contemporary = GetCachedAccountFromParam("coa_ContemporaryPayment");
                int sl_contemporary = 0;
                var slregColl = new SubLedgersCollection();
                slregColl.Query.Where(slregColl.Query.SubLedgerName == reg.GuarantorID,
                    slregColl.Query.GroupId == AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdGuarantor));
                if (slregColl.LoadAll())
                {
                    sl_contemporary = slregColl.First().SubLedgerId ?? 0;
                }

                int coa_overPayment = grn.ChartOfAccountIdOverPayment ?? 0;
                int coa_overPaymentmin = grn.ChartOfAccountIdOverPaymentMin ?? 0;

                // temporary hanya bisa dijurnal jika ada intermbill
                if (TIntermbill > 0)
                {
                    if (Selisih > 0) /* coa contemporary di debit */
                    {

                        //if (coa_overPaymentmin == 0)
                        //{
                        /* jurnal temporary */
                        JournalTransactionDetails x = new JournalTransactionDetails();
                        x.AddNew();
                        x.JournalId = entity.JournalId;
                        x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                        x.SubLedgerId = sl_contemporary;
                        x.Debit = Selisih;
                        x.Credit = 0;
                        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        x.DocumentNumber = tp.PaymentNo;

                        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, tp.RegistrationNo);
                        x.Save();

                        totalDebit += x.Debit.Value;
                        //}
                        //else
                        //{
                        //    // kalau coa coa_overPayment ada isinya berarti kelebihan pembayaran dijurnal ke coa tersebut
                        //    TIntermbill = TIntermbill == 0 ? TotalCostCalc : TIntermbill;
                        //    TPayment = TPayment == 0 ? TotalPaymentCurrent : TPayment;
                        //    Selisih = TPayment - TIntermbill;
                        //    if (Selisih < 0)
                        //    {
                        //        // kelebihan pembayaran

                        //        // ambil subledger
                        //        var slColl = new SubLedgersCollection();
                        //        slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
                        //        if (slColl.LoadAll())
                        //        {

                        //        }

                        //        JournalTransactionDetails xo = new JournalTransactionDetails();
                        //        xo.AddNew();
                        //        xo.JournalId = entity.JournalId;
                        //        xo.ChartOfAccountId = ValidateCOA(coa_overPaymentmin, coaColl, string.Format(
                        //            "Master Guarantor: {0}: COA: COA Exccess Payment / Discount (A/R)", grn.GuarantorName));
                        //        xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
                        //        xo.Debit = 0;
                        //        xo.Credit = Selisih;
                        //        xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        //        xo.DocumentNumber = tp.PaymentNo;

                        //        AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                        //            null, string.Empty, string.Empty, tp.RegistrationNo);
                        //        xo.Save();

                        //        totalCredit += xo.Credit.Value;
                        //    }
                        //}
                    }
                    else if (Selisih < 0) /* coa contemporary di credit */
                    {
                        // cek dulu overpayment realnya berapa, kalau 0 berarti cukup jurnal temporary saja
                        var RealSelisih = Selisih;

                        if (coa_overPayment == 0)
                        {
                            /* jurnal temporary */
                            JournalTransactionDetails x = new JournalTransactionDetails();
                            x.AddNew();
                            x.JournalId = entity.JournalId;

                            // diremark karena salah coa kasus rssmcb, coa temporary kok ambil dari discount reason, 
                            //var dscr = tpItems.Where(t => !string.IsNullOrEmpty(t.SRDiscountReason)).SingleOrDefault();
                            //string srDiscountReason = dscr == null ? string.Empty : dscr.SRDiscountReason;
                            //if (!string.IsNullOrEmpty(srDiscountReason))
                            //{
                            //    var sDiscReason = stdDR.Where(std => std.ItemID == srDiscountReason);
                            //    if (sDiscReason.Count() > 0)
                            //    {
                            //        var dsc = sDiscReason.First();
                            //        //DiscountReason = dsc.ItemName;
                            //        //dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
                            //        //if ((dsc.coaID ?? 0) != 0)
                            //        //{
                            //        //    dAccount = dsc.coaID.Value;
                            //        //    dSubledgerId = dsc.subledgerID ?? 0;
                            //        //}
                            //        x.ChartOfAccountId = dsc.coaID.Value;
                            //    }
                            //}
                            //else
                            x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");

                            x.SubLedgerId = sl_contemporary;
                            x.Debit = 0;
                            x.Credit = Abs(Selisih);// +adminGuarantor;
                            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            x.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            x.Save();

                            totalCredit += x.Credit.Value;
                        }
                        else
                        {
                            // kalau coa coa_overPayment ada isinya berarti kelebihan pembayaran dijurnal ke coa tersebut
                            TIntermbill = TIntermbill == 0 ? TotalCostCalc : TIntermbill;
                            TPayment = TPayment == 0 ? TotalPaymentCurrent : TPayment;
                            Selisih = TPayment - TIntermbill;
                            if (Selisih > 0)
                            {
                                // kelebihan pembayaran

                                // ambil subledger
                                var slColl = new SubLedgersCollection();
                                slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
                                if (slColl.LoadAll())
                                {

                                }

                                JournalTransactionDetails xo = new JournalTransactionDetails();
                                xo.AddNew();
                                xo.JournalId = entity.JournalId;
                                xo.ChartOfAccountId = ValidateCOA(coa_overPayment, coaColl, string.Format(
                                    "Master Guarantor: {0}: COA: COA Exccess Payment / Discount (A/R)", grn.GuarantorName));
                                xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
                                xo.Debit = 0;
                                xo.Credit = Selisih;
                                xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                xo.DocumentNumber = tp.PaymentNo;

                                AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                                xo.Save();

                                totalCredit += xo.Credit.Value;
                            }

                            //if (TotalPembayaran < TPayment)
                            if ((TotalPaymentCurrent - RoundingCurrent) <= TPayment && TotalPaymentCurrent - Selisih > 0)
                            {
                                /* jurnal temporary */
                                JournalTransactionDetails x = new JournalTransactionDetails();
                                x.AddNew();
                                x.JournalId = entity.JournalId;
                                x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment"); //coa_contemporary;
                                x.SubLedgerId = sl_contemporary;
                                x.Debit = 0;
                                x.Credit = (RealSelisih < 0 && TotalBalance == 0) ? ((RealSelisih * -1) - (Selisih > 0 ? Selisih : 0)) : ((TotalPaymentCurrent - TotalBalance - Selisih) < 0 ? (TotalPaymentCurrent - Selisih /*RSPSC: PM180904-00144*/) : (TotalPaymentCurrent - TotalBalance - Selisih));// +adminGuarantor;
                                                                                                                                                                                                                                                                                                           //x.Credit = TIntermbill - TPayment;

                                // bingung kuadrat
                                x.Credit = totalDebit - totalCredit;// -x.Credit;

                                var yaGituDeh = totalDebit - totalCredit;
                                x.Debit = (yaGituDeh < 0) ? (yaGituDeh * -1) : 0;
                                x.Credit = (yaGituDeh > 0) ? yaGituDeh : 0;

                                //x.Debit = 0;
                                //x.Credit = totalDebit - totalCredit;

                                x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                x.DocumentNumber = tp.PaymentNo;

                                AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                                x.Save();

                                totalDebit += x.Debit.Value;
                                totalCredit += x.Credit.Value;
                            }
                        }
                    }
                }
                else if (TotalCostCalc == 0 && TIntermbill == 0)
                {
                    // untuk payment 2 guarantor, payment guarantor ke-2 tidak ada link
                    // ke intermbill yang dibayar. bikin jurnalnya gimana ya??

                    if (TotalPaymentCurrent >= 0)
                    {
                        /* jurnal temporary */
                        foreach (var p in tpItems)
                        {
                            JournalTransactionDetails x = new JournalTransactionDetails();
                            x.AddNew();
                            x.JournalId = entity.JournalId;
                            x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "AppParameter: coa_ContemporaryPayment"); //coa_contemporary;
                            x.SubLedgerId = sl_contemporary;
                            x.Debit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                            x.Credit = (p.Amount > 0) ? p.Amount : 0;
                            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            x.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            x.Save();

                            totalDebit += x.Debit.Value;
                            totalCredit += x.Credit.Value;
                        }
                    }
                }

                //if (Selisih > 0) /*coa contemporary di debit */
                //{
                //    /* jurnal temporary */
                //    JournalTransactionDetails x = new JournalTransactionDetails();
                //    x.AddNew();
                //    x.JournalId = entity.JournalId;
                //    x.ChartOfAccountId = coa_contemporary;
                //    x.SubLedgerId = 0;
                //    x.Debit = Selisih;
                //    x.Credit = 0;
                //    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                //    x.DocumentNumber = tp.PaymentNo;
                //    x.Save();

                //    totalDebit += x.Debit.Value;

                //}
                //else if (Selisih < 0) /* coa contemporary di credit */
                //{
                //    /* jurnal temporary */
                //    JournalTransactionDetails x = new JournalTransactionDetails();
                //    x.AddNew();
                //    x.JournalId = entity.JournalId;
                //    x.ChartOfAccountId = coa_contemporary;
                //    x.SubLedgerId = 0;
                //    x.Debit = 0;
                //    x.Credit = Abs(Selisih);// +adminGuarantor;
                //    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                //    x.DocumentNumber = tp.PaymentNo;
                //    x.Save();

                //    totalCredit += x.Credit.Value;
                //}

                if (totalCredit != totalDebit && pkg.Sum(x => x.PackageAmount) != pkg.Sum(x => x.PackageDetailAmount))
                {
                    string errMsg = "Different package price:";
                    var items = new ItemCollection();
                    items.Query.Where(items.Query.ItemID.In(pkg.Select(p => p.ItemID)));
                    items.LoadAll();

                    foreach (var x in pkg.Where(p => p.PackageAmount != p.PackageDetailAmount))
                    {
                        errMsg += string.Format("TransNo: {0} {3}, Package Price: {1:n2}, Detail Package Price: {2:n2}",
                            x.TransactionNo, x.PackageAmount, x.PackageDetailAmount,
                            items.Where(z => z.ItemID == x.ItemID).Select(z => z.ItemName).FirstOrDefault());
                    }
                    throw new Exception(errMsg);
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if (/*(totalCredit > 0 && totalDebit > 0) &&*/ (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    // insert cash transaction here
                    var cashID = AutoCashEntryOnPaymentReceive(tp, tpItems, entity, editedBy);
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }
        private static bool IsGuarantorTypeBpjsKapitasi(string guarantorType)
        {
            var gtKapitasi = AppParameter.GetParameterValue(AppParameter.ParameterItem.GuarantorTypeBpjsKapitasi);
            if (string.IsNullOrWhiteSpace(gtKapitasi)) return false;

            return guarantorType.Equals(gtKapitasi);
        }
        public static int? AddNewPaymentCashBasedJournalV2(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string RefNo, string editedBy, int journalId)
        {
            //payment received
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                bool newJournal = journalId == 0;
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                //var CoaColl = new ChartOfAccountsCollection();
                var regType = reg.SRRegistrationType;

                string guarID = string.IsNullOrEmpty(tp.GuarantorID) ? reg.GuarantorID : tp.GuarantorID;
                var grn = new Guarantor();
                grn.LoadByPrimaryKey(guarID);

                // Guarantor Type BPJS Kapitasi hanya inventory yg dijournal (Handono 23111 Klinik MM)
                var isJournalJustInventoryItem = IsGuarantorTypeBpjsKapitasi(grn.SRGuarantorType);

                var sSelfGuarantorID = "SELF";
                var self = new AppParameter();
                self.LoadByPrimaryKey("SelfGuarantorID");
                sSelfGuarantorID = self.ParameterValue;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = (journalType == "07") ? "PAYMENT RETURN" : "PAYMENT";

                //Journal Header
                JournalTransactions entity = new JournalTransactions();

                // cegah double jurnal
                if (journalId == 0)
                {
                    entity.Query.Where(entity.Query.RefferenceNumber == RefNo, entity.Query.JournalIdRefference.IsNull());
                    entity.Query.es.Top = 1;
                    if (entity.Load(entity.Query))
                    {
                        journalId = entity.JournalId.Value;
                    }
                }

                entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                    entity.IsVoid = false;

                    // delete prev message
                    JournalErrorMessageDelete(entity);
                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    if (journalType == BusinessObject.JournalType.ARCreating)
                    {
                        if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                        {
                            entity.Description = string.Format("{0} SUP#:{1}", entity.Description, grn.GuarantorName);
                        }
                    }
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                bool IsProrataToRevenue = (grn.IsDiscountProrataToRevenue ?? false);
                IsProrataToRevenue &= (DateTime.ParseExact(
                    AppParameter.GetParameterValue(AppParameter.ParameterItem.DiscountProrataToRevenueDateStart),
                    "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture) <= entity.TransactionDate.Value);

                var coaColl = new ChartOfAccountsCollection();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal PayCurrent = 0;
                decimal PayCurrentRound = 0;
                decimal PayCurrentBalance = 0;
                decimal adminGuarantor = 0;

                DataTable dtbl = new DataTable();
                dtbl.Columns.Add("coaId", typeof(int));
                dtbl.Columns.Add("subledgerId", typeof(int));
                dtbl.Columns.Add("balance", Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", Type.GetType("System.Decimal"));

                keterangan = (journalType == "07") ? "RETURN" : "";

                var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

                var stdDR = new AppStandardReferenceItemCollection();
                stdDR.Query.Where(stdDR.Query.StandardReferenceID == "DiscountReason");
                stdDR.LoadAll();

                if (!isJournalJustInventoryItem)
                {
                    foreach (var p in tpItems)
                    {
                        string payMethode = p.SRPaymentMethod;
                        string payType = p.SRPaymentType;
                        bool isCardPayment = false;

                        PaymentType pt = new PaymentType();
                        if (!pt.LoadByPrimaryKey(payType))
                            continue;

                        int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                        string dAccountMsg = string.Empty;
                        int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                        int cAccount = 0;

                        PaymentMethod pm = new PaymentMethod();
                        if (!pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                                continue;
                        }

                        if (pm.ChartOfAccountID.HasValue)
                        {
                            dAccount = pm.ChartOfAccountID.Value;
                            dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                            dAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                        }

                        // if appstdref of discount reason has coa
                        string DiscountReason = string.Empty;
                        if (!string.IsNullOrEmpty(p.SRDiscountReason) && p.SRPaymentType == "PaymentType-005")
                        {
                            var sDiscReason = stdDR.Where(std => std.ItemID == p.SRDiscountReason);
                            if (sDiscReason.Count() > 0)
                            {
                                var dsc = sDiscReason.First();
                                DiscountReason = dsc.ItemName;
                                dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
                                if ((dsc.coaID ?? 0) != 0)
                                {
                                    dAccount = dsc.coaID.Value;
                                    dSubledgerId = dsc.subledgerID ?? 0;
                                }
                            }
                        }

                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                        {
                            //transfer
                            if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
                            {
                                bool skipBank = false;
                                if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaCashierPaymentTransferFromPaymentMethod))
                                {
                                    // 
                                    try
                                    {
                                        ValidateCOA(pm.ChartOfAccountID, coaColl);
                                        skipBank = true;
                                    }
                                    catch (Exception ex)
                                    {

                                    }
                                }
                                if (!skipBank)
                                {
                                    Bank bank = new Bank();
                                    if (bank.LoadByPrimaryKey(p.BankID))
                                    {
                                        if (bank.ChartOfAccountId.HasValue)
                                            dAccount = bank.ChartOfAccountId.Value;
                                        if (bank.SubledgerId.HasValue)
                                            dSubledgerId = bank.SubledgerId.Value;
                                        dAccountMsg = string.Format("Bank: {0}", bank.BankName);
                                    }
                                }
                            }
                        }

                        if (p.IsFromDownPayment.Value)
                        {
                            // amount that we receive from the payment
                            //if (p.Amount.Value != 0)
                            //{
                            //    int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //    // int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");




                            //    JournalTransactionDetails d = new JournalTransactionDetails();
                            //    d.AddNew();
                            //    d.JournalId = entity.JournalId;
                            //    d.ChartOfAccountId = dAccount_off;
                            //    d.SubLedgerId = 0;
                            //    d.Debit = Abs(p.Amount + p.Balance ?? 0);
                            //    d.Credit = 0;
                            //    d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan, 
                            //        (DiscountReason.Length > 0 ? " ":"") + DiscountReason);
                            //    d.DocumentNumber = tp.PaymentNo;
                            //    d.Save();

                            //    totalDebit += d.Debit.Value;
                            //}

                            // start uang muka
                            // perlu dicari ini uang muka dari payment registrasi yang mana supaya 
                            // pas tarik ledger bisa direkon, harus pecah per noreg
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            var dpdt = new TransPaymentItemQuery("a");
                            var dphd = new TransPaymentQuery("b");

                            dpdt.InnerJoin(dphd).On(dpdt.PaymentNo == dphd.PaymentNo)
                                .Where(dphd.PaymentReferenceNo == p.PaymentNo,
                                    dphd.IsApproved == true,
                                    dphd.IsVoid == false,
                                    dphd.TransactionCode == "018")
                                .OrderBy(dphd.RegistrationNo.Descending, dphd.PaymentNo.Ascending)
                                .Select(dphd.RegistrationNo, dphd.PaymentNo, dpdt.Amount, dpdt.Balance);
                            DataTable dtpay = dpdt.LoadDataTable();
                            decimal sumAmount = 0;
                            for (int i = 0; i < dtpay.Rows.Count; i++)
                            {
                                sumAmount += (decimal)(dtpay.Rows[i]["Amount"] ?? 0) + (decimal)(dtpay.Rows[i]["Balance"] ?? 0);
                                if (dtpay.Rows[i]["RegistrationNo"].ToString() !=
                                    ((i + 1 == dtpay.Rows.Count) ? "" : dtpay.Rows[i + 1]["RegistrationNo"].ToString()))
                                {
                                    // this is the last row or last current reg, do save
                                    JournalTransactionDetails d = new JournalTransactionDetails();
                                    d.AddNew();
                                    d.JournalId = entity.JournalId;
                                    d.ChartOfAccountId = ValidateCOA(dAccount_off, coaColl, "App Parameter: coa_DownPayment");
                                    d.SubLedgerId = 0;

                                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                    d.Debit = (sumAmount > 0) ? sumAmount : 0;
                                    d.Credit = (sumAmount < 0) ? (sumAmount * -1) : 0;
                                    // end of modif teguh s 2016 06 02

                                    d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", dtpay.Rows[i]["RegistrationNo"].ToString(), pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                                        (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                                    d.DocumentNumber = tp.PaymentNo;
                                    d.DocumentNumberSequenceNo = p.SequenceNo;

                                    AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                                    d.Save();

                                    totalDebit += d.Debit.Value;
                                    totalCredit += d.Credit.Value;
                                    PayCurrent += sumAmount;
                                    sumAmount = 0;
                                }
                            }
                            // end uang muka

                            if (p.Balance.Value != 0) //payment return
                            {
                                //int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                                //Modif By Hermawan
                                //int cAccount_off = dAccount;
                                //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                                int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");
                                int cAccountPayable_off = GetCachedAccountFromParam("coa_DownPaymentReturnPayable");

                                ////-------------- ini dulunya kenapa diremark?
                                //JournalTransactionDetails d = new JournalTransactionDetails();
                                //d.AddNew();
                                //d.JournalId = entity.JournalId;
                                //d.ChartOfAccountId = dAccount_off;
                                //d.SubLedgerId = 0;
                                //d.Debit = Abs(p.Balance);
                                //d.Credit = 0;
                                //d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                //d.DocumentNumber = tp.PaymentNo;
                                //d.Save();

                                //totalDebit += d.Debit.Value;
                                ////-------------------------------------

                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entity.JournalId;
                                if (p.IsBackOfficeReturn ?? false)
                                    c.ChartOfAccountId = ValidateCOA(cAccountPayable_off, coaColl, "App Parameter: coa_DownPaymentReturnPayable");
                                else
                                    c.ChartOfAccountId = ValidateCOA(cAccount_off, coaColl, "App Parameter: coa_DownPaymentReturn");
                                c.SubLedgerId = 0;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                c.Debit = (p.Balance < 0) ? (p.Balance * -1) : 0;
                                c.Credit = (p.Balance > 0) ? p.Balance : 0;
                                // end of modif teguh s 2016 06 02

                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.DocumentNumberSequenceNo = p.SequenceNo;

                                AddMoreInfo(c, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                                c.Save();

                                totalDebit += c.Debit.Value;
                                totalCredit += c.Credit.Value;
                                PayCurrentBalance += p.Balance.Value;
                            }
                        }
                        else
                        {
                            cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                            if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                            {
                                cAccount = GetCachedAccountFromParam("coa_DownPayment");
                            }

                            // piutang instansi || piutang personal
                            if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
                            {
                                Guarantor guarantorEntity = new Guarantor();
                                if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
                                {
                                    var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);
                                    //var coaInv = IsSplitIprOpr ? guarantorEntity.ChartOfAccountId : ();
                                    //if (guarantorEntity.ChartOfAccountId.HasValue)
                                    //{
                                    var PrmUsingInvoicing = new AppParameter();
                                    if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
                                    {
                                        throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
                                    }
                                    if (PrmUsingInvoicing.ParameterValue == "Yes")
                                    {
                                        AppParameter app = new AppParameter();
                                        app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                                        if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                                        {
                                            /* 
                                             * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                                             * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                                             * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                                             * kalau bingung tanya teguh s
                                             */
                                            dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                            dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                            dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
                                        }
                                        else
                                        {
                                            dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdTemporaryIPR ?? 0) : (guarantorEntity.ChartOfAccountIdTemporary ?? 0);
                                            dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubledgerIdTemporaryIPR ?? 0) : (guarantorEntity.SubledgerIdTemporary ?? 0);
                                            dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Invoice)", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                        }
                                    }
                                    else
                                    {
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process){1}", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                    }
                                    //}
                                }
                            }

                            if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                            {
                                // Payment Credit Card || Payment Debit Card 
                                if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                                {
                                    isCardPayment = true;
                                    EDCMachine edcMachineEntity = new EDCMachine();
                                    if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                                    {
                                        // Setting Account Code Per EDC Machine
                                        if (edcMachineEntity.ChartOfAccountID.HasValue)
                                        {
                                            dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                            dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                            dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);
                                        }
                                    }
                                }
                            }

                            if (IsProrataToRevenue && pt.SRPaymentTypeID.Equals("PaymentType-005"))
                            {
                                var jtdColl = GetNewIncomeAdjustProrataCashBased(entity, tp.PaymentNo, p.Amount ?? 0, "", coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            }
                            else
                            {
                                //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                                JournalTransactionDetails d = new JournalTransactionDetails();
                                d.AddNew();
                                d.JournalId = entity.JournalId;
                                d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                                d.SubLedgerId = dSubledgerId;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                d.Debit = (p.Amount > 0) ? p.Amount : 0;
                                d.Credit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                                // end of modif teguh s 2016 06 02

                                d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                                    (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                                if (journalType == BusinessObject.JournalType.ARCreating)
                                {
                                    if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                                    {
                                        d.Description = string.Format("{0} SUP#:{1}", d.Description, grn.GuarantorName);
                                    }
                                }
                                d.DocumentNumber = tp.PaymentNo;
                                d.DocumentNumberSequenceNo = p.SequenceNo;

                                AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                            null, string.Empty, string.Empty, tp.RegistrationNo);

                                d.Save();

                                totalDebit += d.Debit.Value;
                                totalCredit += d.Credit.Value;
                            }

                            PayCurrent += p.Amount.Value;

                        }

                        if ((p.RoundingAmount ?? 0) != 0)
                        {
                            // no rounding for card payment, (payment bugs escape)
                            //if (!isCardPayment)
                            //{
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entity.JournalId;
                            k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
                            k.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                            k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                            // end of modif teguh s 2016 06 02

                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                            k.Save();

                            totalDebit += k.Debit.Value;
                            totalCredit += k.Credit.Value;

                            PayCurrentRound += (p.RoundingAmount ?? 0);
                            //}
                        }
                        // ADM pindah kebawah

                        // if there is CC fee
                        if (p.CardFeeAmount > 0)
                        {
                            // debit
                            JournalTransactionDetails dFee = new JournalTransactionDetails();
                            dFee.AddNew();
                            dFee.JournalId = entity.JournalId;
                            dFee.ChartOfAccountId = dAccount;
                            dFee.SubLedgerId = 0;
                            dFee.Debit = Abs(p.CardFeeAmount);
                            dFee.Credit = 0;
                            dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            dFee.DocumentNumber = tp.PaymentNo;
                            dFee.DocumentNumberSequenceNo = p.SequenceNo;

                            dFee.GuarantorID = grn.GuarantorID;
                            dFee.Save();

                            totalDebit += dFee.Debit.Value;

                            // credit
                            JournalTransactionDetails cFee = new JournalTransactionDetails();
                            cFee.AddNew();
                            cFee.JournalId = entity.JournalId;
                            cFee.ChartOfAccountId = ValidateCOA(GetCachedAccountFromParam("coa_PaymentCardFeeAmt"), coaColl, "AppParameter:coa_PaymentCardFeeAmt");
                            cFee.SubLedgerId = 0;
                            cFee.Debit = 0;
                            cFee.Credit = Abs(p.CardFeeAmount);
                            cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            cFee.DocumentNumber = tp.PaymentNo;
                            cFee.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(cFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                            cFee.Save();

                            totalCredit += cFee.Credit.Value;
                        }
                    }
                }
                /* start hitung jurnal pendapatan */
                DataTable dtb;
                decimal transCurrent = 0, transCurrentIB = 0;//, paidTrans = 0;
                                                             //decimal tCredit = 0;
                                                             //decimal tDebit = 0;

                List<PackageJournal> pkg = new List<PackageJournal>();

                var a = new TransPaymentItemIntermBillQuery();
                a.Where(a.PaymentNo == RefNo);
                dtb = a.LoadDataTable();
                if (dtb.Rows.Count == 0)
                {
                    var b = new TransPaymentItemIntermBillGuarantorQuery();
                    b.Where(b.PaymentNo == RefNo);
                    dtb = new DataTable();
                    dtb = b.LoadDataTable();
                }

                string[] paket = null;
                bool acc_IsJournalPackageB4Approve =
                    AppParameter.GetParameterValue(
                        AppParameter.ParameterItem.acc_IsJournalPackageB4Approve) == "Yes";
                /*BELUM SELESAI*/

                var cc = new TransPaymentItemOrderCollection();
                cc.Query.Where(cc.Query.PaymentNo == RefNo);
                if (newJournal) cc.Query.Where(cc.Query.JournalIncomePaymentNo == string.Empty);
                else
                    //cc.Query.Where(cc.Query.PaymentNo == RefNo);
                    cc.Query.Where(
                        cc.Query.Or(
                            cc.Query.JournalIncomePaymentNo == string.Empty,
                            cc.Query.JournalIncomePaymentNo == RefNo
                        )
                    );
                if (cc.LoadAll())
                {
                    //paket non mcu
                    paket = new string[cc.Count];
                    foreach (var row in cc)
                    {
                        var details = new TransChargesItemCollection();
                        details.Query.Where(details.Query.TransactionNo == row.TransactionNo, details.Query.ParentNo == row.SequenceNo, details.Query.IsExtraItem == false);
                        if (details.Query.Load())
                        {
                            paket.SetValue(row.PaymentNo + ";" + row.TransactionNo + ";" + row.SequenceNo, paket.Length - paket.Count(p => string.IsNullOrEmpty(p)));
                            foreach (var detail in details)
                            {
                                var entity2 = cc.AddNew();
                                entity2.TransactionNo = detail.TransactionNo;
                                entity2.SequenceNo = detail.SequenceNo;
                                entity2.PaymentNo = row.PaymentNo;
                                entity2.ItemID = detail.ItemID;
                                entity2.Qty = detail.ChargeQuantity;
                                entity2.Price = detail.Price - (detail.DiscountAmount / detail.ChargeQuantity);
                            }
                        }
                    }

                    // paket mcu
                    foreach (var row in cc)
                    {
                        var tc2 = new TransChargesCollection();
                        tc2.Query.Where(tc2.Query.PackageReferenceNo == row.TransactionNo, tc2.Query.IsVoid == false);
                        if (tc2.Query.Load())
                        {
                            paket.SetValue(row.PaymentNo + ";" + row.TransactionNo + ";" + row.SequenceNo, paket.Length - paket.Count(p => string.IsNullOrEmpty(p)));
                            //pkgAmount += (row.Price ?? 0) * (row.Qty ?? 0);
                            var dPkg = new PackageJournal();
                            dPkg.TransactionNo = row.TransactionNo;
                            dPkg.SequenceNo = row.SequenceNo;
                            dPkg.ItemID = row.ItemID;
                            dPkg.PackageAmount = (row.Price ?? 0) * (row.Qty ?? 0);
                            dPkg.PackageDetailAmount = 0;

                            foreach (var t2 in tc2)
                            {
                                var tci2 = new TransChargesItemCollection();
                                tci2.Query.Where(tci2.Query.TransactionNo == t2.TransactionNo, tci2.Query.IsVoid == false);
                                if (tci2.Query.Load())
                                {
                                    // diskon paket pasien pribadi goes here

                                    foreach (var ti2 in tci2)
                                    {
                                        if (ti2.ChargeQuantity != 0)
                                        {
                                            if (ti2.IsApprove ?? false)
                                            {
                                                var entity2 = cc.AddNew();
                                                entity2.TransactionNo = ti2.TransactionNo;
                                                entity2.SequenceNo = ti2.SequenceNo;
                                                entity2.PaymentNo = row.PaymentNo;
                                                entity2.ItemID = ti2.ItemID;
                                                entity2.Qty = ti2.ChargeQuantity;
                                                entity2.Price = ti2.Price - (ti2.DiscountAmount / ti2.ChargeQuantity);

                                                //pkgDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                                dPkg.PackageDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                            }
                                            else
                                            {
                                                if (acc_IsJournalPackageB4Approve)
                                                {
                                                    var entity2 = cc.AddNew();
                                                    entity2.TransactionNo = ti2.TransactionNo;
                                                    entity2.SequenceNo = ti2.SequenceNo;
                                                    entity2.PaymentNo = row.PaymentNo;
                                                    entity2.ItemID = ti2.ItemID;
                                                    entity2.Qty = ti2.ChargeQuantity;
                                                    entity2.Price = ti2.Price - (ti2.DiscountAmount / ti2.ChargeQuantity);

                                                    //pkgDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                                    dPkg.PackageDetailAmount += (entity2.Price ?? 0) * (entity2.Qty ?? 0);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            pkg.Add(dPkg);
                        }
                    }

                    //foreach (var p in paket.Where(n => !string.IsNullOrEmpty(n)))
                    //{
                    //    var entity2 = cc.FindByPrimaryKey(p.Split(';')[0], p.Split(';')[1], p.Split(';')[2]);
                    //    if (entity2 != null) entity2.MarkAsDeleted();
                    //}
                }

                foreach (var row in cc)
                {
                    var prs = new TransPrescriptionItem();
                    if (prs.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                        transCurrent += prs.LineAmount.Value;
                    else
                        transCurrent += row.Qty.Value * row.Price.Value;

                    var tpio = new TransPaymentItemOrder();
                    if (tpio.LoadByPrimaryKey(row.PaymentNo, row.TransactionNo, row.SequenceNo))
                    {
                        if (string.IsNullOrEmpty(tpio.JournalIncomePaymentNo))
                        {
                            tpio.JournalIncomePaymentNo = row.PaymentNo;
                            tpio.Save();
                        }
                    }

                    var TransC = new TransCharges();
                    if (TransC.LoadByPrimaryKey(row.TransactionNo))
                    {
                        var transCI = new TransChargesItem();
                        if (transCI.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                        {
                            var cCalc = new CostCalculation();
                            if (cCalc.LoadByPrimaryKey(TransC.RegistrationNo, row.TransactionNo, row.SequenceNo))
                            {
                                /* start journal*/
                                var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                                /* end journal */
                            }
                            else
                            {
                                ////if (paket != null)
                                //if(paket != null)
                                //{
                                //    if(paket.Where(p => p != null).Select(p => 
                                //        p.Split(new string[]{";"},StringSplitOptions.RemoveEmptyEntries)[1])
                                //        .Contains((TransC.PackageReferenceNo ?? string.Empty) == string.Empty ? "xxx":TransC.PackageReferenceNo))
                                //    {
                                cCalc = new CostCalculation();
                                cCalc.RegistrationNo = TransC.RegistrationNo;
                                cCalc.TransactionNo = row.TransactionNo;
                                cCalc.SequenceNo = row.SequenceNo;
                                cCalc.ItemID = row.ItemID;
                                cCalc.PatientAmount = transCI.ChargeQuantity * (transCI.Price - (transCI.DiscountAmount / (transCI.ChargeQuantity == 0 ? 1 : transCI.ChargeQuantity)));
                                cCalc.GuarantorAmount = 0;
                                cCalc.DiscountAmount = transCI.DiscountAmount;

                                /* start journal*/
                                var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                                /* end journal */
                                //    }
                                //}
                                //else {
                                //    decimal td = 0;
                                //    decimal tc = 0;

                                //    int? hehe = AddNewIncomeJournalCashBased_IsOrderTrue(entity.JournalId ?? 0, transCI, out tc, out td, false);
                                //    totalDebit += td;
                                //    totalCredit += tc;
                                //}
                            }
                        }
                    }
                    //precription
                    else
                    {
                        var transPresc = new TransPrescription();
                        transPresc.LoadByPrimaryKey(row.TransactionNo);

                        var cCalc = new CostCalculation();
                        if (cCalc.LoadByPrimaryKey(transPresc.RegistrationNo, row.TransactionNo, row.SequenceNo))
                        {
                            /* start journal*/
                            var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, 0, coaColl);
                            jtdColl.Save();
                            totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                            totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            /* end journal */
                        }
                    }
                }

                //decimal TIntermbill = 0, TPayment = 0;
                if (dtb.Rows.Count > 0)
                {
                    foreach (DataRow row in dtb.Rows)
                    {
                        var q = new IntermBillCollection();
                        //q.Query.Where(
                        //    q.Query.IntermBillNo == row["intermBillNo"],
                        //    q.Query.Or(
                        //        q.Query.JournalIncomePaymentNo == string.Empty,
                        //        q.Query.JournalIncomePaymentNo == RefNo
                        //        )
                        //    );
                        ////q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"], q.Query.JournalIncomePaymentNo == RefNo);
                        ////q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"]);
                        //q.LoadAll();

                        var ibq = new IntermBillQuery("ibq");
                        var tp2 = new TransPaymentQuery("tp2");
                        ibq.LeftJoin(tp2).On(ibq.JournalIncomePaymentNo == tp2.PaymentNo && tp2.IsVoid == false);
                        ibq.Where(
                            ibq.IntermBillNo == row["intermBillNo"],
                            ibq.Or(
                                "<ISNULL(tp2.PaymentNo,'') = '' OR >",
                                ibq.JournalIncomePaymentNo == RefNo
                                )
                            );
                        ibq.Select(ibq);
                        ibq.es.Distinct = true;
                        q.Load(ibq);


                        foreach (var x in q)
                        {
                            //if (string.IsNullOrEmpty(x.JournalIncomePaymentNo))
                            //{
                            x.JournalIncomePaymentNo = RefNo;
                            q.Save();
                            //}

                            var cost = new CostCalculationQuery("a");
                            var charges = new TransChargesQuery("k");
                            var chargesItem = new TransChargesItemQuery("l");

                            cost.Select(
                                cost.RegistrationNo,
                                chargesItem.TransactionNo,
                                chargesItem.SequenceNo,
                                chargesItem.ReferenceNo,
                                chargesItem.ReferenceSequenceNo,
                                chargesItem.ItemID,
                                chargesItem.ChargeQuantity,
                                cost.PatientAmount,
                                cost.GuarantorAmount,
                                cost.DiscountAmount,
                                @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                                );
                            cost.InnerJoin(charges).On(cost.TransactionNo == charges.TransactionNo);
                            cost.InnerJoin(chargesItem).On(
                                cost.TransactionNo == chargesItem.TransactionNo &&
                                cost.SequenceNo == chargesItem.SequenceNo
                                );
                            cost.Where(
                                cost.IntermBillNo == x.IntermBillNo,
                                cost.Or(
                                    cost.ParentNo == string.Empty,
                                    cost.ParentNo.IsNull()
                                    )
                                );
                            cost.OrderBy(
                                cost.RegistrationNo.Ascending,
                                charges.TransactionNo.Ascending,
                                chargesItem.SequenceNo.Ascending
                                );

                            DataTable table = cost.LoadDataTable();

                            //paket mcu
                            var cc1 = new CostCalculationCollection();
                            cc1.Query.Where(cc1.Query.IntermBillNo == x.IntermBillNo);
                            if (cc1.Query.Load())
                            {
                                var tc1 = new TransChargesCollection();
                                tc1.Query.Where(tc1.Query.PackageReferenceNo.In(cc1.Select(c1 => c1.TransactionNo)));
                                if (tc1.Query.Load())
                                {
                                    cost = new CostCalculationQuery("a");
                                    charges = new TransChargesQuery("k");
                                    chargesItem = new TransChargesItemQuery("l");

                                    cost.Select(
                                        cost.RegistrationNo,
                                        chargesItem.TransactionNo,
                                        chargesItem.SequenceNo,
                                        chargesItem.ReferenceNo,
                                        chargesItem.ReferenceSequenceNo,
                                        chargesItem.ItemID,
                                        chargesItem.ChargeQuantity,
                                        cost.PatientAmount,
                                        cost.GuarantorAmount,
                                        cost.DiscountAmount,
                                        @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                                        );
                                    cost.InnerJoin(charges).On(cost.TransactionNo == charges.TransactionNo);
                                    cost.InnerJoin(chargesItem).On(
                                        cost.TransactionNo == chargesItem.TransactionNo &&
                                        cost.SequenceNo == chargesItem.SequenceNo
                                        );
                                    cost.Where(
                                        cost.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                                        cost.Or(
                                            cost.ParentNo == string.Empty,
                                            cost.ParentNo.IsNull()
                                            )
                                        );
                                    cost.OrderBy(
                                        cost.RegistrationNo.Ascending,
                                        charges.TransactionNo.Ascending,
                                        chargesItem.SequenceNo.Ascending
                                        );

                                    table.Merge(cost.LoadDataTable());

                                    // kalau ada yang udah approve tapi gak ada di cost calculation
                                    charges = new TransChargesQuery("k");
                                    chargesItem = new TransChargesItemQuery("l");
                                    cost = new CostCalculationQuery("a");

                                    charges.Select(
                                            charges.RegistrationNo,
                                            chargesItem.TransactionNo,
                                            chargesItem.SequenceNo,
                                            chargesItem.ReferenceNo,
                                            chargesItem.ReferenceSequenceNo,
                                            chargesItem.ItemID,
                                            chargesItem.ChargeQuantity,
                                            "<CAST(l.Price * l.[ChargeQuantity] AS MONEY) PatientAmount>",
                                            "<CAST(0 AS MONEY) [GuarantorAmount]>",
                                            "<l.DiscountAmount [DiscountAmount]>",
                                            @"<CAST(0 AS BIT) AS 'IsDeleted'>")
                                        .InnerJoin(chargesItem).On(charges.TransactionNo == chargesItem.TransactionNo)
                                        .LeftJoin(cost).On(chargesItem.TransactionNo == cost.TransactionNo &&
                                            chargesItem.SequenceNo == cost.SequenceNo)
                                        .Where(
                                        charges.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                                        charges.Or(
                                            chargesItem.ParentNo == string.Empty,
                                            chargesItem.ParentNo.IsNull()
                                            ),
                                            chargesItem.IsApprove == true,
                                        cost.TransactionNo.IsNull()
                                        )
                                        .OrderBy(
                                        charges.RegistrationNo.Ascending,
                                        charges.TransactionNo.Ascending,
                                        chargesItem.SequenceNo.Ascending
                                        );

                                    table.Merge(charges.LoadDataTable());

                                    // unapproved detail package
                                    if (acc_IsJournalPackageB4Approve)
                                    {
                                        charges = new TransChargesQuery("k");
                                        chargesItem = new TransChargesItemQuery("l");
                                        cost = new CostCalculationQuery("a");

                                        charges.Select(
                                                charges.RegistrationNo,
                                                chargesItem.TransactionNo,
                                                chargesItem.SequenceNo,
                                                chargesItem.ReferenceNo,
                                                chargesItem.ReferenceSequenceNo,
                                                chargesItem.ItemID,
                                                chargesItem.ChargeQuantity,
                                                "<CAST(l.Price * l.[ChargeQuantity] AS MONEY) PatientAmount>",
                                                "<CAST(0 AS MONEY) [GuarantorAmount]>",
                                                "<l.DiscountAmount [DiscountAmount]>",
                                                @"<CAST(0 AS BIT) AS 'IsDeleted'>")
                                            .InnerJoin(chargesItem).On(charges.TransactionNo == chargesItem.TransactionNo)
                                            .LeftJoin(cost).On(chargesItem.TransactionNo == cost.TransactionNo &&
                                                chargesItem.SequenceNo == cost.SequenceNo)
                                            .Where(
                                            charges.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                                            charges.Or(
                                                chargesItem.ParentNo == string.Empty,
                                                chargesItem.ParentNo.IsNull()
                                                ),
                                            chargesItem.IsApprove == false,
                                            cost.TransactionNo.IsNull()
                                            )
                                            .OrderBy(
                                            charges.RegistrationNo.Ascending,
                                            charges.TransactionNo.Ascending,
                                            chargesItem.SequenceNo.Ascending
                                            );

                                        table.Merge(charges.LoadDataTable());
                                    }

                                    foreach (var rr in table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct()
                                         .Contains(r.Field<string>("TransactionNo"))).ToList())
                                    {
                                        var dPkg = new PackageJournal();
                                        dPkg.TransactionNo = rr.Field<string>("TransactionNo");
                                        dPkg.SequenceNo = rr.Field<string>("SequenceNo");
                                        dPkg.ItemID = rr.Field<string>("ItemID");
                                        dPkg.PackageAmount = rr.Field<decimal>("PatientAmount") + rr.Field<decimal>("GuarantorAmount");
                                        dPkg.PackageDetailAmount = 0;

                                        dPkg.PackageDetailAmount = table.Rows.Cast<DataRow>()
                                        .Where(r => (
                                            tc1.Where(t1 => !string.IsNullOrEmpty(t1.PackageReferenceNo) && !(t1.IsPackage ?? false))//t1.TransactionNo == dPkg.TransactionNo)
                                            .Select(t1 => t1.TransactionNo)
                                        ).Contains(r.Field<string>("TransactionNo"))).ToList()
                                        .Sum(r => r.Field<decimal>("PatientAmount") + r.Field<decimal>("GuarantorAmount"));

                                        pkg.Add(dPkg);
                                    }

                                    //pkgAmount += table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct()
                                    //    .Contains(r.Field<string>("TransactionNo"))).ToList()
                                    //    .Sum(r => r.Field<decimal>("PatientAmount") + r.Field<decimal>("GuarantorAmount"));

                                    //pkgDetailAmount += table.Rows.Cast<DataRow>()
                                    //    .Where(r => (
                                    //        tc1.Where(t1 => !string.IsNullOrEmpty(t1.PackageReferenceNo)).Select(t1 => t1.TransactionNo)
                                    //    ).Contains(r.Field<string>("TransactionNo"))).ToList()
                                    //    .Sum(r => r.Field<decimal>("PatientAmount") + r.Field<decimal>("GuarantorAmount"));

                                    //table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct()
                                    //    .Contains(r.Field<string>("TransactionNo"))).ToList()
                                    //    .ForEach(r => r.Delete());
                                    //table.AcceptChanges();
                                }
                            }

                            DataTable temp = table.Copy(), temp2 = table.Copy(); ;

                            var view = temp.DefaultView;
                            view.RowFilter = "ReferenceNo <> '' AND ReferenceSequenceNo <> ''";
                            temp = view.ToTable();
                            view.Dispose();

                            DataView view2 = temp2.DefaultView;
                            view2.RowFilter = "ReferenceNo = '' AND ReferenceSequenceNo = ''";
                            temp2 = view2.ToTable();
                            view2.Dispose();

                            foreach (DataRow r in table.Rows)
                            {
                                if (string.IsNullOrEmpty(r["ReferenceNo"].ToString()) && string.IsNullOrEmpty(r["ReferenceSequenceNo"].ToString()))
                                {
                                    foreach (DataRow tmp in temp.Rows.Cast<DataRow>().Where(tmp => r["TransactionNo"].ToString() == tmp["ReferenceNo"].ToString() &&
                                                                                                   r["SequenceNo"].ToString() == tmp["ReferenceSequenceNo"].ToString()))
                                    {
                                        r["ChargeQuantity"] = (decimal)r["ChargeQuantity"] + (decimal)tmp["ChargeQuantity"];
                                        r["PatientAmount"] = (decimal)r["PatientAmount"] + (decimal)tmp["PatientAmount"];
                                        r["GuarantorAmount"] = (decimal)r["GuarantorAmount"] + (decimal)tmp["GuarantorAmount"];
                                        r["DiscountAmount"] = (decimal)r["DiscountAmount"] + (decimal)tmp["DiscountAmount"];
                                    }
                                }
                                else
                                {
                                    foreach (DataRow tmp in temp2.Rows.Cast<DataRow>().Where(tmp => r["ReferenceNo"].ToString() == tmp["TransactionNo"].ToString() &&
                                                                                                    r["ReferenceSequenceNo"].ToString() == tmp["SequenceNo"].ToString()))
                                    {
                                        r["IsDeleted"] = true;
                                    }
                                }
                            }

                            table.AcceptChanges();

                            foreach (DataRow r in table.Rows.Cast<DataRow>().Where(r => ((decimal)r["ChargeQuantity"] == 0) || ((bool)r["IsDeleted"])))
                            {
                                r.Delete();
                            }

                            table.AcceptChanges();


                            var cost2 = new CostCalculationQuery("m");
                            var TransPresc = new TransPrescriptionQuery("n");
                            var TransPrescItem = new TransPrescriptionItemQuery("o");

                            cost2.Select(
                                cost2.RegistrationNo,
                               cost2.TransactionNo,
                                TransPrescItem.SequenceNo,
                                TransPrescItem.ReferenceNo,
                                TransPrescItem.ReferenceSequenceNo,
                                cost2.ItemID,
                                TransPrescItem.PrescriptionQty.As("ChargeQuantity"),
                                cost2.PatientAmount,
                                cost2.GuarantorAmount,
                                cost2.DiscountAmount,
                                @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                                );
                            cost2.InnerJoin(TransPresc).On(cost2.TransactionNo == TransPresc.PrescriptionNo);
                            cost2.InnerJoin(TransPrescItem).On(
                                cost2.TransactionNo == TransPrescItem.PrescriptionNo &&
                                cost2.SequenceNo == TransPrescItem.SequenceNo
                                );
                            cost2.Where(
                                cost2.IntermBillNo == x.IntermBillNo

                                );
                            cost2.OrderBy(
                                cost2.RegistrationNo.Ascending,
                                TransPresc.PrescriptionNo.Ascending,
                                TransPrescItem.SequenceNo.Ascending
                                );

                            DataTable table2 = cost2.LoadDataTable();

                            table.Merge(table2);

                            foreach (DataRow r in table.Rows)
                            {
                                transCurrent += (Convert.ToDecimal(r["PatientAmount"]) + Convert.ToDecimal(r["GuarantorAmount"]));

                                /* start journal */
                                var c = new CostCalculation();
                                c.RegistrationNo = r["RegistrationNo"].ToString();
                                c.TransactionNo = r["TransactionNo"].ToString();
                                c.SequenceNo = r["SequenceNo"].ToString();
                                c.ItemID = r["ItemID"].ToString();
                                c.PatientAmount = Convert.ToDecimal(r["PatientAmount"]);
                                c.GuarantorAmount = Convert.ToDecimal(r["GuarantorAmount"]);
                                c.DiscountAmount = Convert.ToDecimal(r["DiscountAmount"]);

                                var jtdColl = GetNewIncomeJournalCashBased(entity, c, false, Convert.ToDecimal(r["ChargeQuantity"]), coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            }

                            //var coll = new CostCalculationCollection();
                            //coll.Query.Where(coll.Query.IntermBillNo == x.IntermBillNo);
                            //coll.LoadAll();

                            //foreach (var r in coll)
                            //{
                            //    TotalCostCalc += r.PatientAmount.Value + r.GuarantorAmount.Value;

                            //    /* start journal */
                            //    decimal td = 0;
                            //    decimal tc = 0;

                            //    int? hehe = AddNewIncomeJournalCashBased(entity.JournalId ?? 0, r, out tc, out td, false);
                            //    totalDebit += td;
                            //    totalCredit += tc;
                            //}
                        }

                        // ambil total trnsaksi dari intermbill
                        var ibT = new IntermBill();
                        if (ibT.LoadByPrimaryKey(row["intermBillNo"].ToString()))
                        {
                            transCurrentIB += ibT.PatientAmount.Value + ibT.GuarantorAmount.Value +
                                ibT.AdministrationAmount.Value + ibT.GuarantorAdministrationAmount.Value -
                                ibT.DiscAdmPatient.Value - ibT.DiscAdmGuarantor.Value;
                        }

                    }
                    //List<string> ibs = new List<string>();
                    //foreach (DataRow row in dtb.Rows)
                    //{
                    //    ibs.Add(row["intermBillNo"].ToString());
                    //}
                    // end of ambil total trnsaksi dari intermbill
                    //// ambil payment intermbil yang bersangkutan
                    //var tpiTColl = new TransPaymentItemCollection();
                    //var tpiT = new TransPaymentItemQuery("tpi");
                    //var tpT = new TransPaymentQuery("tp");
                    //var tpibgTColl = new TransPaymentItemIntermBillGuarantorCollection();
                    //var tpibTColl = new TransPaymentItemIntermBillCollection();
                    //tpibgTColl.Query.Where(tpibgTColl.Query.IntermBillNo.In(ibs));
                    //tpibTColl.Query.Where(tpibTColl.Query.IntermBillNo.In(ibs));
                    //tpibgTColl.LoadAll();
                    //tpibTColl.LoadAll();
                    //var PaymentNos = ((from s in tpibgTColl select s.PaymentNo)
                    //    .Union(from s in tpibTColl select s.PaymentNo)).Distinct();
                    //if (PaymentNos.Count() > 0)
                    //{
                    //    tpiT.InnerJoin(tpT).On(tpT.PaymentNo == tpiT.PaymentNo)
                    //        .Where(
                    //            tpT.IsApproved == true,
                    //            tpT.PaymentNo.In(PaymentNos),
                    //            tpT.PaymentNo < tp.PaymentNo)
                    //        .Select(tpiT);
                    //    tpiTColl.Load(tpiT);
                    //    paidTrans += tpiTColl.Sum(x => x.Amount.Value - x.RoundingAmount.Value);
                    //}
                    //// end of ambil total payment intermbil yang bersangkutan
                }

                #region Administration
                if (!isJournalJustInventoryItem)
                {
                    foreach (var p in tpItems)
                    {
                        string[] intermBillNo = new string[0];

                        var a1 = new TransPaymentItemIntermBillCollection();
                        a1.Query.Where(a1.Query.PaymentNo == RefNo);
                        if (a1.Query.Load())
                        {
                            intermBillNo = new string[a1.Count];
                            for (int i = 0; i < a1.Count; i++)
                            {
                                intermBillNo.SetValue(a1[i].IntermBillNo, i);
                            }
                        }
                        else
                        {
                            var b1 = new TransPaymentItemIntermBillGuarantorCollection();
                            b1.Query.Where(b1.Query.PaymentNo == RefNo);
                            if (b1.Query.Load())
                            {
                                intermBillNo = new string[b1.Count];
                                for (int i = 0; i < b1.Count; i++)
                                {
                                    intermBillNo.SetValue(b1[i].IntermBillNo, i);
                                }
                            }
                        }

                        foreach (string ib1 in intermBillNo)
                        {
                            var ib = new IntermBill();
                            ib.LoadByPrimaryKey(ib1);
                            if (string.IsNullOrEmpty(ib.JournalIncomePaymentNo) || ib.JournalIncomePaymentNo == RefNo)
                            {
                                // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                                //if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                                {
                                    if (((ib.AdministrationAmount - ib.DiscAdmPatient) + (ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor)) != 0
                                        // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                                        //if (reg.AdministrationAmount > 0 
                                        && (journalType.Equals(BusinessObject.JournalType.ARCreating) || journalType.Equals(BusinessObject.JournalType.Payment)) &&
                                        //tp.RemainingAmount <= 0 && 
                                        p.SequenceNo == lastRow.SequenceNo)
                                    {
                                        var itemAdm = String.Empty;
                                        var CompID = String.Empty;
                                        AppParameter app = new AppParameter();
                                        if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                            itemAdm = app.ParameterValue;
                                        Item item = new Item();
                                        item.Query.Where(item.Query.ItemID == itemAdm);
                                        if (!item.Query.Load())
                                        {
                                            throw new Exception("App Parameter: coa_ItemIdBillingTotalAdmFee: " + itemAdm + " is not a valid service");
                                        }


                                        //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                                        AppParameter app2 = new AppParameter();
                                        if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                            CompID = app2.ParameterValue;
                                        TariffComponent ic = new TariffComponent();
                                        ic.Query.Where(ic.Query.TariffComponentID == CompID);
                                        if (!ic.Query.Load())
                                        {
                                            throw new Exception("App Parameter: coa_CompIDForBillingAdm: " + CompID + " is not a valid tarif component");
                                        }

                                        var su = new ServiceUnit();
                                        if (su.LoadByPrimaryKey(reg.ServiceUnitID))
                                        { }

                                        ServiceUnitItemService itemService = new ServiceUnitItemService();
                                        itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                                itemService.Query.ItemID == itemAdm);
                                        if (!itemService.Query.Load())
                                        {
                                            throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
                                        }
                                        int? coaId = 0;
                                        int? subLedgerId = 0;

                                        var grr = new Guarantor();
                                        grr.LoadByPrimaryKey(reg.GuarantorID);

                                        ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                        itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                             itemComp.Query.ItemID == itemAdm,
                                                             itemComp.Query.TariffComponentID == CompID,
                                                             itemComp.Query.SRRegistrationType == regType,
                                                             itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                        if (itemComp.Query.Load())
                                        {
                                            if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemComp.ChartOfAccountIdIncome;
                                                subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                            }
                                        }

                                        // kalau Rawat Inap
                                        if (reg.SRRegistrationType == "IPR")
                                        {
                                            ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                            itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                                itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

                                            if (itemClass.Query.Load())
                                            {
                                                if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                                {
                                                    coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                    subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                                }
                                            }
                                        }

                                        //adm pasien
                                        if ((ib.AdministrationAmount - ib.DiscAdmPatient) != 0)
                                        {
                                            JournalTransactionDetails j = new JournalTransactionDetails();
                                            j.AddNew();
                                            j.JournalId = entity.JournalId;
                                            j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                            j.SubLedgerId = subLedgerId;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            var admIB = (ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0);
                                            j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                            j.Credit = (admIB > 0) ? admIB : 0;
                                            // end of modif teguh s 2016 06 02

                                            j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                            j.DocumentNumber = tp.PaymentNo;

                                            AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                                null, su.ServiceUnitID, item.ItemID, tp.RegistrationNo);
                                            j.Save();

                                            totalDebit += j.Debit.Value;
                                            totalCredit += j.Credit.Value;
                                            // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                            transCurrent += j.Credit.Value - j.Debit.Value;
                                        }

                                        //adm guarantor
                                        if ((ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor) != 0)
                                        {
                                            JournalTransactionDetails j = new JournalTransactionDetails();
                                            j.AddNew();
                                            j.JournalId = entity.JournalId;
                                            j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                            j.SubLedgerId = subLedgerId;

                                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                            var admIB = (ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0);
                                            j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                            j.Credit = (admIB > 0) ? admIB : 0;
                                            // end of modif teguh s 2016 06 02

                                            j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                            j.DocumentNumber = tp.PaymentNo;

                                            AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                                null, string.Empty, item.ItemID, tp.RegistrationNo);
                                            j.Save();

                                            totalDebit += j.Debit.Value;
                                            totalCredit += j.Credit.Value;
                                            adminGuarantor = Abs((ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0));
                                            // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                            transCurrent += j.Credit.Value - j.Debit.Value;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                #endregion End of Administration

                if (!isJournalJustInventoryItem)
                {
                    // item tambahan tpio
                    var tpacColl = new TransPaymentAdditionalChargesCollection();
                    tpacColl.Query.Where(tpacColl.Query.PaymentNo == tp.PaymentNo);
                    if (tpacColl.LoadAll())
                    {
                        var stdAddCharges = new AppStandardReferenceItemCollection();
                        stdAddCharges.LoadByStandardReferenceID("CafeAdditionalCharges");
                        foreach (var tpac in tpacColl)
                        {
                            var addCharge = stdAddCharges.Where(ad => ad.ItemID == tpac.SRCafeAdditionalCharges).FirstOrDefault();
                            if (addCharge == null)
                            {
                                throw new Exception(string.Format("StandardRef: CafeAdditionalCharges: item {0} not found in data master", tpac.SRCafeAdditionalCharges));
                            }
                            var jTpac = new JournalTransactionDetails();
                            jTpac.AddNew();
                            jTpac.JournalId = entity.JournalId;
                            jTpac.ChartOfAccountId = ValidateCOA(addCharge.coaID, coaColl, "StandardRef: CafeAdditionalCharges: {0}", addCharge.ItemName);
                            jTpac.SubLedgerId = 0;
                            jTpac.Debit = 0;
                            jTpac.Credit = tpac.ChargeAmount;
                            jTpac.Description = string.Format("REG#:{0}. PATIENT:{1}. {2}",
                                reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, addCharge.ItemName);
                            jTpac.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(jTpac, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            jTpac.Save();

                            totalDebit += jTpac.Debit.Value;
                            totalCredit += jTpac.Credit.Value;

                            transCurrent += jTpac.Credit.Value;
                        }
                    }

                }

                if (!isJournalJustInventoryItem)
                {
                    var SelisihPaket = pkg.Sum(x => x.PackageAmount) - pkg.Sum(x => x.PackageDetailAmount);

                    int coa_contemporary = GetCachedAccountFromParam("coa_ContemporaryPayment");
                    int sl_contemporary = 0;
                    var slregColl = new SubLedgersCollection();
                    slregColl.Query.Where(slregColl.Query.SubLedgerName == reg.GuarantorID,
                        slregColl.Query.GroupId == AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdGuarantor));
                    if (slregColl.LoadAll())
                    {
                        sl_contemporary = slregColl.First().SubLedgerId ?? 0;
                    }

                    int coa_overPayment = grn.ChartOfAccountIdOverPayment ?? 0;
                    int coa_overPaymentmin = grn.ChartOfAccountIdOverPaymentMin ?? 0;

                    bool isVoid = false;
                    isVoid |= (tp.IsVoid ?? false);
                    if (!isVoid)
                    {
                        //cek apakah paymentnya direturn
                        var tpRetColl = new TransPaymentCollection();
                        tpRetColl.Query.Where(tpRetColl.Query.PaymentReferenceNo == tp.PaymentNo && tpRetColl.Query.TransactionCode == "017");
                        if (tpRetColl.LoadAll())
                        {
                            isVoid = true;
                        }
                    }

                    if (isVoid)
                    {
                        // kalau payment void, seimbangkan saja jurnalnya
                        var dBal = totalCredit - totalDebit;

                        JournalTransactionDetails x = new JournalTransactionDetails();
                        x.AddNew();
                        x.JournalId = entity.JournalId;
                        x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                        x.SubLedgerId = sl_contemporary;
                        x.Debit = (dBal > 0) ? dBal : 0;
                        x.Credit = (dBal < 0) ? (dBal * -1) : 0;
                        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        x.DocumentNumber = tp.PaymentNo;

                        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, tp.RegistrationNo);
                        x.Save();

                        totalDebit += x.Debit.Value;
                        totalCredit += x.Credit.Value;
                    }
                    else
                    {
                        if (dtb.Rows.Count > 0)
                        {
                            decimal currRevenueWithAdm = 0;
                            decimal prevRevenueWithAdm = 0;
                            decimal paidTrans = 0;

                            List<string> ibs = new List<string>();
                            foreach (DataRow row in dtb.Rows)
                            {
                                ibs.Add(row["intermBillNo"].ToString());
                            }

                            var ibColl = new IntermBillCollection();
                            ibColl.Query.Where(ibColl.Query.IntermBillNo.In(ibs));
                            ibColl.LoadAll();

                            currRevenueWithAdm = ibColl.Where(ib => ib.JournalIncomePaymentNo == tp.PaymentNo)
                                .Sum(ib => (ib.PatientAmount ?? 0) + (ib.GuarantorAmount ?? 0) + (ib.AdministrationAmount ?? 0) + (ib.GuarantorAdministrationAmount ?? 0));
                            prevRevenueWithAdm = ibColl.Where(ib => ib.JournalIncomePaymentNo != tp.PaymentNo && !string.IsNullOrEmpty(ib.JournalIncomePaymentNo))
                                .Sum(ib => (ib.PatientAmount ?? 0) + (ib.GuarantorAmount ?? 0) + (ib.AdministrationAmount ?? 0) + (ib.GuarantorAdministrationAmount ?? 0));

                            if (ibColl.Where(ib => ib.JournalIncomePaymentNo != tp.PaymentNo).Any())
                            {
                                // ambil payment intermbil yang bersangkutan
                                var tpiTColl = new TransPaymentItemCollection();
                                var tpiT = new TransPaymentItemQuery("tpi");
                                var tpT = new TransPaymentQuery("tp");
                                var tpibgTColl = new TransPaymentItemIntermBillGuarantorCollection();
                                var tpibTColl = new TransPaymentItemIntermBillCollection();
                                tpibgTColl.Query.Where(
                                    tpibgTColl.Query.IntermBillNo.In(ibs) &&
                                    //tpibgTColl.Query.IsPaymentProceed == true && 
                                    tpibgTColl.Query.IsPaymentReturned == false);
                                tpibTColl.Query.Where(
                                    tpibTColl.Query.IntermBillNo.In(ibs) &&
                                    //tpibTColl.Query.IsPaymentProceed == true && 
                                    tpibTColl.Query.IsPaymentReturned == false);
                                tpibgTColl.LoadAll();
                                tpibTColl.LoadAll();
                                var PaymentNos = ((from s in tpibgTColl select s.PaymentNo)
                                    .Union(from s in tpibTColl select s.PaymentNo)).Distinct();
                                if (PaymentNos.Count() > 0)
                                {
                                    tpiT.InnerJoin(tpT).On(tpT.PaymentNo == tpiT.PaymentNo)
                                        .Where(
                                            tpT.IsApproved == true,
                                            tpT.PaymentNo.In(PaymentNos),
                                            tpT.PaymentNo != tp.PaymentNo)
                                        .Select(tpiT);
                                    tpiTColl.Load(tpiT);
                                    paidTrans += tpiTColl.Sum(x => x.Amount.Value - x.RoundingAmount.Value);
                                }
                                // end of ambil total payment intermbil yang bersangkutan
                            }

                            decimal tmpVal = 0;
                            var maxTmpVal = (Abs(paidTrans) >= Abs(transCurrentIB)) ? 0 : (transCurrentIB - (paidTrans > 0 ? transCurrent : 0) - paidTrans);

                            var PayCurrentWithRound = PayCurrent - PayCurrentBalance - PayCurrentRound;
                            var overPay = PayCurrentWithRound + paidTrans - transCurrentIB;

                            //var firstJ = paidTrans == 0;
                            if (currRevenueWithAdm != 0)
                            {
                                tmpVal = transCurrentIB - paidTrans - PayCurrentWithRound;
                                var currTmpVal = tmpVal;
                                if ((paidTrans > 0) && Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal; // harusnya ini untuk kondisi payment kedua dst, payment pertama currTmpVal = tmpVal
                                                                                                             //if (tmpVal < 0)// lebih bayar
                                                                                                             //{
                                                                                                             //    // lebih bayar gak usah jurnal temporary, jurnalnya ke overpayment
                                                                                                             //}
                                                                                                             //else
                                                                                                             //{
                                                                                                             // jurnal temporary
                                if (currTmpVal > 0 /*over payment (currTmpVal minus) dijurnal di overpayment*/ && prevRevenueWithAdm == 0)
                                {
                                    JournalTransactionDetails x = new JournalTransactionDetails();
                                    x.AddNew();
                                    x.JournalId = entity.JournalId;
                                    x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                                    x.SubLedgerId = sl_contemporary;
                                    x.Debit = (currTmpVal > 0) ? currTmpVal : 0;
                                    x.Credit = (currTmpVal < 0) ? (currTmpVal * -1) : 0;
                                    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                    x.DocumentNumber = tp.PaymentNo;

                                    AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);
                                    x.Save();

                                    totalDebit += x.Debit.Value;
                                    totalCredit += x.Credit.Value;
                                }

                                if (paidTrans != 0)
                                {
                                    tmpVal = PayCurrentWithRound;
                                    currTmpVal = tmpVal - currRevenueWithAdm;
                                    //if (Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal;// <-- 2024-10-02 BT: bingung ini dulu untuk apa, jadi gak sesuai kalau ada pembayaran kedua tapi mix ambil ib pertama juga(kondisi ib pertama dibuat split manual [coverage] dan sisi pasiennya sudah bayar)
                                    //if (Abs(tmpVal) < 0) currTmpVal = maxTmpVal;// lebih bayar
                                    // jurnal temporary
                                    if (currTmpVal != 0)
                                    {
                                        JournalTransactionDetails x = new JournalTransactionDetails();
                                        x.AddNew();
                                        x.JournalId = entity.JournalId;
                                        x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                                        x.SubLedgerId = sl_contemporary;
                                        x.Debit = (currTmpVal < 0) ? (currTmpVal * -1) : 0;
                                        x.Credit = (currTmpVal > 0) ? currTmpVal : 0;
                                        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                        x.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, string.Empty, string.Empty, tp.RegistrationNo);
                                        x.Save();

                                        totalDebit += x.Debit.Value;
                                        totalCredit += x.Credit.Value;
                                    }
                                }
                                //}
                            }
                            else
                            {
                                // pembayaran kedua / split bayar kedua
                                tmpVal = PayCurrentWithRound;
                                var currTmpVal = tmpVal;
                                if (Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal;
                                //if (Abs(tmpVal) < 0) currTmpVal = maxTmpVal;// lebih bayar
                                // jurnal temporary
                                if (currTmpVal != 0)
                                {
                                    JournalTransactionDetails x = new JournalTransactionDetails();
                                    x.AddNew();
                                    x.JournalId = entity.JournalId;
                                    x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                                    x.SubLedgerId = sl_contemporary;
                                    x.Debit = (currTmpVal < 0) ? (currTmpVal * -1) : 0;
                                    x.Credit = (currTmpVal > 0) ? currTmpVal : 0;
                                    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                    x.DocumentNumber = tp.PaymentNo;

                                    AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);
                                    x.Save();

                                    totalDebit += x.Debit.Value;
                                    totalCredit += x.Credit.Value;
                                }
                            }

                            if (overPay > 0)
                            {
                                if (IsProrataToRevenue && AppParameter.IsYes(AppParameter.ParameterItem.IsOverpaymentProrataToRevenue))
                                {
                                    var jtdColl = GetNewIncomeAdjustProrataCashBased(entity, tp.PaymentNo, -overPay, "", coaColl);
                                    jtdColl.Save();
                                    totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                    totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                                }
                                else
                                {
                                    // ambil subledger
                                    var slColl = new SubLedgersCollection();
                                    slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
                                    if (slColl.LoadAll())
                                    {

                                    }

                                    JournalTransactionDetails xo = new JournalTransactionDetails();
                                    xo.AddNew();
                                    xo.JournalId = entity.JournalId;
                                    xo.ChartOfAccountId = ValidateCOA(coa_overPayment, coaColl, string.Format(
                                        "Master Guarantor: {0}: COA: COA Exccess Payment / Discount (A/R)", grn.GuarantorName));
                                    xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
                                    xo.Debit = (overPay < 0) ? (overPay * -1) : 0;
                                    xo.Credit = (overPay > 0) ? overPay : 0;
                                    xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                    xo.DocumentNumber = tp.PaymentNo;

                                    AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);
                                    xo.Save();

                                    totalDebit += xo.Debit.Value;
                                    totalCredit += xo.Credit.Value;
                                }

                            }
                        }

                        // COB
                        if (cc.Count == 0 && dtb.Rows.Count == 0)
                        {
                            var currTmpVal = tpItems.Sum(tpi => (tpi.Amount ?? 0) - (tpi.Balance ?? 0) - (tpi.RoundingAmount ?? 0));

                            if (currTmpVal != 0)
                            {
                                JournalTransactionDetails x = new JournalTransactionDetails();
                                x.AddNew();
                                x.JournalId = entity.JournalId;
                                x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                                x.SubLedgerId = sl_contemporary;
                                x.Debit = (currTmpVal < 0) ? (currTmpVal * -1) : 0;
                                x.Credit = (currTmpVal > 0) ? currTmpVal : 0;
                                x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                x.DocumentNumber = tp.PaymentNo;

                                AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                                x.Save();

                                totalDebit += x.Debit.Value;
                                totalCredit += x.Credit.Value;
                            }
                        }

                        if (totalCredit != totalDebit &&
                            AppParameter.IsNo(AppParameter.ParameterItem.acc_IsPackageRevenueOnMainPackage) &&
                            pkg.Sum(x => x.PackageAmount) != pkg.Sum(x => x.PackageDetailAmount))
                        {
                            string errMsg = "Different package price:";
                            var items = new ItemCollection();
                            items.Query.Where(items.Query.ItemID.In(pkg.Select(p => p.ItemID)));
                            items.LoadAll();

                            foreach (var x in pkg.Where(p => p.PackageAmount != p.PackageDetailAmount))
                            {
                                errMsg += string.Format("TransNo: {0} {3}, Package Price: {1:n2}, Detail Package Price: {2:n2}",
                                    x.TransactionNo, x.PackageAmount, x.PackageDetailAmount,
                                    items.Where(z => z.ItemID == x.ItemID).Select(z => z.ItemName).FirstOrDefault());
                            }
                            throw new Exception(errMsg);
                        }
                    }
                }
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if (/*(totalCredit > 0 && totalDebit > 0) &&*/ (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    // insert cash transaction here
                    var cashID = AutoCashEntryOnPaymentReceive(tp, tpItems, entity, editedBy);
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int AutoCashEntryOnPaymentReceive(TransPayment tp, TransPaymentItemCollection tpItems, JournalTransactions jt, string editedBy)
        {
            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
            {
                // prevent duplicate cash entry transaction when reprocessing journal is fired
                var ceColl = new CashTransactionCollection();
                ceColl.Query.Where(ceColl.Query.DocumentNumber == tp.PaymentNo && ceColl.Query.IsVoid != true);
                if (ceColl.LoadAll())
                {
                    var ce = ceColl.First();

                    if (ce.IsCleared ?? false)
                    {
                        throw new Exception("Cash transaction already cleared");
                    }

                    CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                    ce = new CashTransaction();
                    if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                    {
                        ce.Void(editedBy);
                    }

                    ceColl.Save();
                }


                int? cashTransactionId;
                CashTransaction.AddNewAutomaticCashTransactionPaymentReceiveFromJournal(
                    tp, tpItems, jt, editedBy, out cashTransactionId);
                // otomatis posting
                if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (jt.JournalId.HasValue && jt.JournalId.Value > 0))
                {
                    CashTransaction.PostingUpdateBalance(cashTransactionId.Value, jt.JournalId.Value);
                }
                return cashTransactionId ?? 0;
            }

            return 0;
        }

        public static int? AddNewPaymentCashBasedJournalTemporary(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string RefNo, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            //payment receive

            if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsJournalAccualNoTemporary))
            {
                return AddNewPatientPaymentReceiveAccrualProporsi_NoTemp(journalType, tp, reg, tpItems, prefix, RefNo, editedBy, journalId);
                //return AddNewPatientPaymentReceiveAccrual_NoTemp(journalType, tp, reg, tpItems, prefix, RefNo, editedBy, journalId);
            }

            try
            {
                bool newJournal = journalId == 0;
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                //var CoaColl = new ChartOfAccountsCollection();
                var regType = reg.SRRegistrationType;

                var grn = new Guarantor();
                grn.LoadByPrimaryKey(tp.GuarantorID);

                var sSelfGuarantorID = "SELF";
                var self = new AppParameter();
                self.LoadByPrimaryKey("SelfGuarantorID");
                sSelfGuarantorID = self.ParameterValue;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = (journalType == "07") ? "PAYMENT RETURN" : "PAYMENT";

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    if (journalType == BusinessObject.JournalType.ARCreating)
                    {
                        if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                        {
                            entity.Description = string.Format("{0} SUP#:{1}", entity.Description, grn.GuarantorName);
                        }
                    }
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal TotalPembayaran = 0;
                decimal TotalBalance = 0;
                decimal adminGuarantor = 0;

                DataTable dtbl = new DataTable();
                dtbl.Columns.Add("coaId", typeof(int));
                dtbl.Columns.Add("subledgerId", typeof(int));
                dtbl.Columns.Add("balance", Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", Type.GetType("System.Decimal"));

                keterangan = (journalType == "07") ? "RETURN" : "";

                var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

                var stdDR = new AppStandardReferenceItemCollection();
                stdDR.Query.Where(stdDR.Query.StandardReferenceID == "DiscountReason");
                stdDR.LoadAll();

                foreach (var p in tpItems)
                {
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;
                    bool isCardPayment = false;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    string dAccountMsg = string.Empty;
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                            continue;
                    }

                    if (pm.ChartOfAccountID.HasValue)
                    {
                        dAccount = pm.ChartOfAccountID.Value;
                        dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        dAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                    }

                    // if appstdref of discount reason has coa
                    string DiscountReason = string.Empty;
                    if (!string.IsNullOrEmpty(p.SRDiscountReason))
                    {
                        var sDiscReason = stdDR.Where(std => std.ItemID == p.SRDiscountReason);
                        if (sDiscReason.Count() > 0)
                        {
                            var dsc = sDiscReason.First();
                            DiscountReason = dsc.ItemName;
                            dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
                            if ((dsc.coaID ?? 0) != 0)
                            {
                                dAccount = dsc.coaID.Value;
                                dSubledgerId = dsc.subledgerID ?? 0;
                            }
                        }
                    }

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        //transfer
                        if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            Bank bank = new Bank();
                            if (bank.LoadByPrimaryKey(p.BankID))
                            {
                                if (bank.ChartOfAccountId.HasValue)
                                    dAccount = bank.ChartOfAccountId.Value;
                                if (bank.SubledgerId.HasValue)
                                    dSubledgerId = bank.SubledgerId.Value;
                                dAccountMsg = string.Format("Bank: {0}", bank.BankName);
                            }
                        }
                    }
                    if (p.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        //if (p.Amount.Value != 0)
                        //{
                        //    int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                        //    // int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");




                        //    JournalTransactionDetails d = new JournalTransactionDetails();
                        //    d.AddNew();
                        //    d.JournalId = entity.JournalId;
                        //    d.ChartOfAccountId = dAccount_off;
                        //    d.SubLedgerId = 0;
                        //    d.Debit = Abs(p.Amount + p.Balance ?? 0);
                        //    d.Credit = 0;
                        //    d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan, 
                        //        (DiscountReason.Length > 0 ? " ":"") + DiscountReason);
                        //    d.DocumentNumber = tp.PaymentNo;
                        //    d.Save();

                        //    totalDebit += d.Debit.Value;
                        //}

                        // start uang muka
                        // perlu dicari ini uang muka dari payment registrasi yang mana supaya 
                        // pas tarik ledger bisa direkon, harus pecah per noreg
                        int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                        var dpdt = new TransPaymentItemQuery("a");
                        var dphd = new TransPaymentQuery("b");

                        dpdt.InnerJoin(dphd).On(dpdt.PaymentNo == dphd.PaymentNo)
                            .Where(dphd.PaymentReferenceNo == p.PaymentNo,
                                dphd.IsApproved == true,
                                dphd.IsVoid == false)
                            .OrderBy(dphd.RegistrationNo.Descending, dphd.PaymentNo.Ascending)
                            .Select(dphd.RegistrationNo, dphd.PaymentNo, dpdt.Amount, dpdt.Balance);
                        DataTable dtpay = dpdt.LoadDataTable();
                        decimal sumAmount = 0;
                        for (int i = 0; i < dtpay.Rows.Count; i++)
                        {
                            sumAmount += (decimal)(dtpay.Rows[i]["Amount"] ?? 0) + (decimal)(dtpay.Rows[i]["Balance"] ?? 0);
                            if (dtpay.Rows[i]["RegistrationNo"].ToString() !=
                                ((i + 1 == dtpay.Rows.Count) ? "" : dtpay.Rows[i + 1]["RegistrationNo"].ToString()))
                            {
                                // this is the last row or last current reg, do save
                                JournalTransactionDetails d = new JournalTransactionDetails();
                                d.AddNew();
                                d.JournalId = entity.JournalId;
                                d.ChartOfAccountId = ValidateCOA(dAccount_off, coaColl, "App Parameter: coa_DownPayment");
                                d.SubLedgerId = 0;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                d.Debit = (sumAmount > 0) ? sumAmount : 0;
                                d.Credit = (sumAmount < 0) ? (sumAmount * -1) : 0;
                                // end of modif teguh s 2016 06 02

                                d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", dtpay.Rows[i]["RegistrationNo"].ToString(), pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                                    (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                                d.DocumentNumber = tp.PaymentNo;
                                d.DocumentNumberSequenceNo = p.SequenceNo;

                                AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                                d.Save();

                                totalDebit += d.Debit.Value;
                                totalCredit += d.Credit.Value;
                                TotalPembayaran += sumAmount;
                                sumAmount = 0;
                            }
                        }
                        // end uang muka

                        if (p.Balance.Value != 0) //payment return
                        {
                            //int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");

                            ////-------------- ini dulunya kenapa diremark?
                            //JournalTransactionDetails d = new JournalTransactionDetails();
                            //d.AddNew();
                            //d.JournalId = entity.JournalId;
                            //d.ChartOfAccountId = dAccount_off;
                            //d.SubLedgerId = 0;
                            //d.Debit = Abs(p.Balance);
                            //d.Credit = 0;
                            //d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            //d.DocumentNumber = tp.PaymentNo;
                            //d.Save();

                            //totalDebit += d.Debit.Value;
                            ////-------------------------------------

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            c.ChartOfAccountId = ValidateCOA(cAccount_off, coaColl, "App Parameter: coa_DownPaymentReturn");
                            c.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            c.Debit = (p.Balance < 0) ? (p.Balance * -1) : 0;
                            c.Credit = (p.Balance > 0) ? p.Balance : 0;
                            // end of modif teguh s 2016 06 02

                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(c, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                            c.Save();

                            totalCredit += c.Credit.Value;
                            TotalBalance += p.Balance.Value;
                            if (TotalPembayaran != (p.Balance + p.Amount)) TotalPembayaran -= c.Credit.Value;
                        }
                    }
                    else
                    {
                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                        {
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");
                        }

                        // piutang instansi || piutang personal
                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
                            {
                                var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);
                                //var coaInv = IsSplitIprOpr ? guarantorEntity.ChartOfAccountId : ();
                                //if (guarantorEntity.ChartOfAccountId.HasValue)
                                //{
                                var PrmUsingInvoicing = new AppParameter();
                                if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
                                {
                                    throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
                                }
                                if (PrmUsingInvoicing.ParameterValue == "Yes")
                                {
                                    AppParameter app = new AppParameter();
                                    app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                                    if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                                    {
                                        /* 
                                         * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                                         * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                                         * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                                         * kalau bingung tanya teguh s
                                         */
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
                                    }
                                    else
                                    {
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdTemporaryIPR ?? 0) : (guarantorEntity.ChartOfAccountIdTemporary ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubledgerIdTemporaryIPR ?? 0) : (guarantorEntity.SubledgerIdTemporary ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Invoice)", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                    }
                                }
                                else
                                {
                                    dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                    dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                    dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process){1}", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                }


                                //if (guarantorEntity.ChartOfAccountId.HasValue)
                                //{
                                //    var PrmUsingInvoicing = new AppParameter();
                                //    if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
                                //    {
                                //        throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
                                //    }
                                //    if (PrmUsingInvoicing.ParameterValue == "Yes")
                                //    {
                                //        AppParameter app = new AppParameter();
                                //        app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                                //        if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                                //        {
                                //            /* 
                                //             * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                                //             * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                                //             * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                                //             * kalau bingung tanya teguh s
                                //             */
                                //            dAccount = guarantorEntity.ChartOfAccountId.Value;
                                //            if (pt.SRPaymentTypeID.Equals("PaymentType-003"))
                                //                dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                                //            else
                                //                dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                                //            dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
                                //        }
                                //        else
                                //        {
                                //            dAccount = guarantorEntity.ChartOfAccountIdTemporary.Value;
                                //            if (pt.SRPaymentTypeID.Equals("PaymentType-003"))
                                //                dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                                //            else
                                //                dSubledgerId = guarantorEntity.SubledgerIdTemporary.HasValue ? guarantorEntity.SubledgerIdTemporary.Value : 0;
                                //            dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Invoice)", guarantorEntity.GuarantorName);
                                //        }
                                //    }
                                //    else
                                //    {
                                //        dAccount = guarantorEntity.ChartOfAccountId.Value;
                                //        if (pt.SRPaymentTypeID.Equals("PaymentType-003"))
                                //            dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                                //        else
                                //            dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                                //        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
                                //    }
                                //}
                            }
                        }

                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                isCardPayment = true;
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                        dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);
                                    }
                                }
                            }
                        }

                        //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                        d.SubLedgerId = dSubledgerId;

                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                        d.Debit = (p.Amount > 0) ? p.Amount : 0;
                        d.Credit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                        // end of modif teguh s 2016 06 02

                        d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                            (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                        if (journalType == BusinessObject.JournalType.ARCreating)
                        {
                            if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                            {
                                d.Description = string.Format("{0} SUP#:{1}", d.Description, grn.GuarantorName);
                            }
                        }
                        d.DocumentNumber = tp.PaymentNo;
                        d.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                        TotalPembayaran += p.Amount.Value;

                    }

                    if ((p.RoundingAmount ?? 0) > 0)
                    {
                        int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                        JournalTransactionDetails k = new JournalTransactionDetails();
                        k.AddNew();
                        k.JournalId = entity.JournalId;
                        k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
                        k.SubLedgerId = 0;

                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                        k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                        k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                        // end of modif teguh s 2016 06 02

                        k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        k.DocumentNumber = tp.PaymentNo;
                        k.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        k.Save();

                        totalCredit += k.Credit.Value;

                    }
                    else if ((p.RoundingAmount ?? 0) < 0)
                    {
                        int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                        JournalTransactionDetails k = new JournalTransactionDetails();
                        k.AddNew();
                        k.JournalId = entity.JournalId;
                        k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
                        k.SubLedgerId = 0;

                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                        k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                        k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                        // end of modif teguh s 2016 06 02

                        k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        k.DocumentNumber = tp.PaymentNo;
                        k.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        k.Save();

                        totalDebit += k.Debit.Value;

                        TotalPembayaran += k.Debit.Value;
                    }

                    // ADM pindah kebawah

                    // if there is CC fee
                    if (p.CardFeeAmount > 0)
                    {
                        // debit
                        JournalTransactionDetails dFee = new JournalTransactionDetails();
                        dFee.AddNew();
                        dFee.JournalId = entity.JournalId;
                        dFee.ChartOfAccountId = dAccount;
                        dFee.SubLedgerId = 0;
                        dFee.Debit = Abs(p.CardFeeAmount);
                        dFee.Credit = 0;
                        dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        dFee.DocumentNumber = tp.PaymentNo;
                        dFee.DocumentNumberSequenceNo = p.SequenceNo;

                        dFee.GuarantorID = grn.GuarantorID;
                        dFee.Save();

                        totalDebit += dFee.Debit.Value;

                        // credit
                        JournalTransactionDetails cFee = new JournalTransactionDetails();
                        cFee.AddNew();
                        cFee.JournalId = entity.JournalId;
                        cFee.ChartOfAccountId = ValidateCOA(GetCachedAccountFromParam("coa_PaymentCardFeeAmt"), coaColl, "AppParameter:coa_PaymentCardFeeAmt");
                        cFee.SubLedgerId = 0;
                        cFee.Debit = 0;
                        cFee.Credit = Abs(p.CardFeeAmount);
                        cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        cFee.DocumentNumber = tp.PaymentNo;
                        cFee.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(cFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        cFee.Save();

                        totalCredit += cFee.Credit.Value;
                    }
                }


                /* start hitung jurnal pendapatan */
                DataTable dtb;
                decimal TotalIntermBill = totalCredit - ((totalDebit < 0) ? totalDebit : 0);
                decimal Selisih = 0;
                decimal tCredit = 0;
                decimal tDebit = 0;

                var a = new TransPaymentItemIntermBillQuery();
                a.Where(a.PaymentNo == RefNo);
                dtb = a.LoadDataTable();
                if (dtb.Rows.Count == 0)
                {
                    var b = new TransPaymentItemIntermBillGuarantorQuery();
                    b.Where(b.PaymentNo == RefNo);
                    dtb = new DataTable();
                    dtb = b.LoadDataTable();

                    //JournalTransactionDetails d1 = new JournalTransactionDetails();
                    //d1.AddNew();
                    //d1.JournalId = entity.JournalId;

                    //var unit = new ServiceUnit();
                    //unit.LoadByPrimaryKey(reg.ServiceUnitID);

                    //d1.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    //d1.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    //d1.Debit = t1;
                    //d1.Credit = 0;
                    //d1.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    //d1.DocumentNumber = string.Empty;
                    //d1.Save();
                }

                string[] paket = null;

                var cc = new TransPaymentItemOrderCollection();
                cc.Query.Where(cc.Query.PaymentNo == RefNo);
                if (newJournal) cc.Query.Where(cc.Query.JournalIncomePaymentNo == string.Empty);
                else
                    //cc.Query.Where(cc.Query.PaymentNo == RefNo);
                    cc.Query.Where(
                        cc.Query.Or(
                            cc.Query.JournalIncomePaymentNo == string.Empty,
                            cc.Query.JournalIncomePaymentNo == RefNo
                        )
                    );
                if (cc.LoadAll())
                {
                    var cc2 = string.Empty;
                    foreach (var cc1 in cc)
                    {
                        cc2 += "'" + cc1.TransactionNo + cc1.SequenceNo + "',";
                    }
                    cc2 = cc2.Remove(cc2.Length - 1, 1);

                    var cost1 = new CostCalculationQuery();
                    cost1.Where(string.Format("<TransactionNo + SequenceNo IN ({0})>", cc2));

                    var cost = new CostCalculationCollection();
                    cost.Load(cost1);

                    JournalTransactionDetails d1 = new JournalTransactionDetails();
                    d1.AddNew();
                    d1.JournalId = entity.JournalId;

                    var unit = new ServiceUnit();
                    unit.LoadByPrimaryKey(reg.ServiceUnitID);

                    d1.ChartOfAccountId = unit.ChartOfAccountIdAcrual;
                    d1.SubLedgerId = unit.SubledgerIdAcrual.HasValue ? unit.SubledgerIdAcrual : 0;
                    d1.Debit = 0;
                    d1.Credit = cost.Select(c => c.PatientAmount + c.GuarantorAmount).Sum();
                    d1.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit.ServiceUnitID, unit.ServiceUnitName);
                    d1.DocumentNumber = string.Empty;
                    d1.Save();

                    totalCredit += d1.Credit ?? 0;

                    ////paket non mcu
                    //paket = new string[cc.Count];
                    //foreach (var row in cc)
                    //{
                    //    var details = new TransChargesItemCollection();
                    //    details.Query.Where(details.Query.TransactionNo == row.TransactionNo, details.Query.ParentNo == row.SequenceNo, details.Query.IsExtraItem == false);
                    //    if (details.Query.Load())
                    //    {
                    //        paket.SetValue(row.PaymentNo + ";" + row.TransactionNo + ";" + row.SequenceNo, paket.Length - paket.Count(p => string.IsNullOrEmpty(p)));
                    //        foreach (var detail in details)
                    //        {
                    //            var entity2 = cc.AddNew();
                    //            entity2.TransactionNo = detail.TransactionNo;
                    //            entity2.SequenceNo = detail.SequenceNo;
                    //            entity2.PaymentNo = row.PaymentNo;
                    //            entity2.ItemID = detail.ItemID;
                    //            entity2.Qty = detail.ChargeQuantity;
                    //            entity2.Price = detail.Price - (detail.DiscountAmount / detail.ChargeQuantity);
                    //        }
                    //    }
                    //}

                    //// paket mcu
                    //foreach (var row in cc)
                    //{
                    //    var tc2 = new TransChargesCollection();
                    //    tc2.Query.Where(tc2.Query.PackageReferenceNo == row.TransactionNo, tc2.Query.IsVoid == false);
                    //    if (tc2.Query.Load())
                    //    {
                    //        paket.SetValue(row.PaymentNo + ";" + row.TransactionNo + ";" + row.SequenceNo, paket.Length - paket.Count(p => string.IsNullOrEmpty(p)));

                    //        foreach (var t2 in tc2)
                    //        {
                    //            var tci2 = new TransChargesItemCollection();
                    //            tci2.Query.Where(tci2.Query.TransactionNo == t2.TransactionNo, tci2.Query.IsVoid == false);
                    //            if (tci2.Query.Load())
                    //            {
                    //                foreach (var ti2 in tci2)
                    //                {
                    //                    if (ti2.ChargeQuantity != 0)
                    //                    {
                    //                        var entity2 = cc.AddNew();
                    //                        entity2.TransactionNo = ti2.TransactionNo;
                    //                        entity2.SequenceNo = ti2.SequenceNo;
                    //                        entity2.PaymentNo = row.PaymentNo;
                    //                        entity2.ItemID = ti2.ItemID;
                    //                        entity2.Qty = ti2.ChargeQuantity;
                    //                        entity2.Price = ti2.Price - (ti2.DiscountAmount / ti2.ChargeQuantity);
                    //                    }
                    //                }
                    //            }
                    //        }
                    //    }
                    //}

                    //foreach (var p in paket.Where(n => !string.IsNullOrEmpty(n)))
                    //{
                    //    var entity2 = cc.FindByPrimaryKey(p.Split(';')[0], p.Split(';')[1], p.Split(';')[2]);
                    //    if (entity2 != null) entity2.MarkAsDeleted();
                    //}
                }

                //foreach (var row in cc)
                //{
                //    var cost = new CostCalculation();
                //    cost.Query.Where(cost.Query.TransactionNo == row.TransactionNo, cost.Query.SequenceNo == row.SequenceNo);
                //    cost.Query.Load();

                //    JournalTransactionDetails d = new JournalTransactionDetails();
                //    d.AddNew();
                //    d.JournalId = entity.JournalId;

                //    var unit = new ServiceUnit();
                //    unit.LoadByPrimaryKey(reg.ServiceUnitID);

                //    d.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                //    d.SubLedgerId = 0;
                //    var sum = cost.PatientAmount + cost.GuarantorAmount;
                //    d.Debit = (sum ?? 0) >= 0 ? sum : 0;
                //    d.Credit = (sum ?? 0) < 0 ? Math.Abs(sum ?? 0) : 0;

                //    var item1 = new Item();
                //    item1.LoadByPrimaryKey(row.ItemID);

                //    d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item1.ItemID, item1.ItemName);
                //    d.DocumentNumber = row.TransactionNo;
                //    d.Save();

                //    if ((sum ?? 0) >= 0)
                //        totalDebit += d.Debit ?? 0;
                //    else if ((sum ?? 0) < 0)
                //        totalCredit += d.Credit ?? 0;

                //    var prs = new TransPrescriptionItem();
                //    if (prs.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                //        TotalIntermBill += prs.LineAmount.Value;
                //    else
                //        TotalIntermBill += row.Qty.Value * row.Price.Value;

                //    var tpio = new TransPaymentItemOrder();
                //    if (tpio.LoadByPrimaryKey(row.PaymentNo, row.TransactionNo, row.SequenceNo))
                //    {
                //        if (string.IsNullOrEmpty(tpio.JournalIncomePaymentNo))
                //        {
                //            tpio.JournalIncomePaymentNo = row.PaymentNo;
                //            tpio.Save();
                //        }
                //    }

                //    var TransC = new TransCharges();
                //    if (TransC.LoadByPrimaryKey(row.TransactionNo))
                //    {
                //        var transCI = new TransChargesItem();
                //        if (transCI.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                //        {
                //            // belum mempunyai transchargeItemComp & costcalculation jadi ambil ke item tariff
                //            if (TransC.IsOrder == true && transCI.IsOrderRealization == false)
                //            {
                //                decimal td = 0;
                //                decimal tc = 0;

                //                //int? hehe = AddNewIncomeJournalCashBased_IsOrderTrue(entity.JournalId ?? 0, transCI, out tc, out td, false);
                //                totalDebit += td;
                //                totalCredit += tc;

                //            }
                //            else
                //            {
                //                var cCalc = new CostCalculation();
                //                if (cCalc.LoadByPrimaryKey(TransC.RegistrationNo, row.TransactionNo, row.SequenceNo))
                //                {
                //                    /* start journal*/

                //                    decimal td = 0;
                //                    decimal tc = 0;

                //                    //int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, cCalc, out tc, out td, false, transCI.ChargeQuantity ?? 0, new ChartOfAccountsCollection());
                //                    totalDebit += td;
                //                    totalCredit += tc;
                //                    /* end journal */
                //                }
                //                else
                //                {
                //                    if (paket != null)
                //                    {
                //                        cCalc = new CostCalculation();
                //                        cCalc.RegistrationNo = TransC.RegistrationNo;
                //                        cCalc.TransactionNo = row.TransactionNo;
                //                        cCalc.SequenceNo = row.SequenceNo;
                //                        cCalc.ItemID = row.ItemID;
                //                        cCalc.PatientAmount = transCI.ChargeQuantity * (transCI.Price - (transCI.DiscountAmount / transCI.ChargeQuantity));
                //                        cCalc.GuarantorAmount = 0;
                //                        cCalc.DiscountAmount = transCI.DiscountAmount;

                //                        /* start journal*/

                //                        decimal td = 0;
                //                        decimal tc = 0;

                //                        //int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, cCalc, out tc, out td, false, transCI.ChargeQuantity ?? 0, new ChartOfAccountsCollection());
                //                        totalDebit += td;
                //                        totalCredit += tc;
                //                        /* end journal */
                //                    }
                //                }
                //            }
                //        }
                //    }
                //    //precription
                //    else
                //    {
                //        var transPresc = new TransPrescription();
                //        transPresc.LoadByPrimaryKey(row.TransactionNo);

                //        var cCalc = new CostCalculation();
                //        if (cCalc.LoadByPrimaryKey(transPresc.RegistrationNo, row.TransactionNo, row.SequenceNo))
                //        {
                //            /* start journal*/

                //            decimal td = 0;
                //            decimal tc = 0;

                //            //int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, cCalc, out tc, out td, false, 0);
                //            // qty di set nol sementara untuk resep saja
                //            totalDebit += td;
                //            totalCredit += tc;
                //            /* end journal */
                //        }
                //    }
                //}

                //decimal TIntermbill = 0, TPayment = 0;
                //if (dtb.Rows.Count > 0)
                //{
                //    foreach (DataRow row in dtb.Rows)
                //    {
                //        var ccc = new CostCalculationCollection();
                //        if (tp.IsToGuarantor ?? false) ccc.Query.Where(ccc.Query.Or(ccc.Query.GuarantorAmount > 0, ccc.Query.GuarantorAmount < 0));
                //        else ccc.Query.Where(ccc.Query.Or(ccc.Query.PatientAmount > 0, ccc.Query.PatientAmount < 0));
                //        ccc.Query.Where(ccc.Query.IntermBillNo == row["IntermBillNo"].ToString());
                //        if (ccc.Query.Load())
                //        {
                //            JournalTransactionDetails d1 = new JournalTransactionDetails();
                //            d1.AddNew();
                //            d1.JournalId = entity.JournalId;

                //            var unit1 = new ServiceUnit();
                //            unit1.LoadByPrimaryKey(reg.ServiceUnitID);

                //            d1.ChartOfAccountId = unit1.ChartOfAccountIdAcrual;
                //            d1.SubLedgerId = unit1.SubledgerIdAcrual.HasValue ? unit1.SubledgerIdAcrual : 0;
                //            d1.Debit = 0;
                //            d1.Credit = ccc.Select(c => c.PatientAmount + c.GuarantorAmount).Sum();
                //            d1.Description = string.Format("REG#:{0}. PAT#:{1}. UNIT:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, unit1.ServiceUnitID, unit1.ServiceUnitName);
                //            d1.DocumentNumber = string.Empty;
                //            d1.Save();

                //            totalCredit += d1.Credit ?? 0;
                //            TotalIntermBill += d1.Credit ?? 0;

                //            foreach (var rcc in ccc)
                //            {
                //                var cost = new CostCalculation();
                //                cost.Query.Where(cost.Query.TransactionNo == rcc.TransactionNo, cost.Query.SequenceNo == rcc.SequenceNo);
                //                cost.Query.Load();

                //                JournalTransactionDetails d = new JournalTransactionDetails();
                //                d.AddNew();
                //                d.JournalId = entity.JournalId;

                //                var unit = new ServiceUnit();
                //                unit.LoadByPrimaryKey(reg.ServiceUnitID);

                //                d.ChartOfAccountId = unit.ChartOfAccountIdIncome;
                //                d.SubLedgerId = 0;
                //                var sum = cost.PatientAmount + cost.GuarantorAmount;
                //                d.Debit = (sum ?? 0) >= 0 ? sum : 0;
                //                d.Credit = (sum ?? 0) < 0 ? Math.Abs(sum ?? 0) : 0;

                //                var item1 = new Item();
                //                item1.LoadByPrimaryKey(rcc.ItemID);

                //                d.Description = string.Format("REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, item1.ItemID, item1.ItemName);
                //                d.DocumentNumber = rcc.TransactionNo;
                //                d.Save();

                //                if ((sum ?? 0) >= 0)
                //                    totalDebit += d.Debit ?? 0;
                //                else if ((sum ?? 0) < 0)
                //                    totalCredit += d.Credit ?? 0;

                //                //var prs = new TransPrescriptionItem();
                //                //if (prs.LoadByPrimaryKey(rcc.TransactionNo, rcc.SequenceNo))
                //                //TotalIntermBill += (Math.Abs(cost.GuarantorAmount ?? 0) + Math.Abs(cost.PatientAmount ?? 0));
                //                //else
                //                //    TotalIntermBill += row.Qty.Value * row.Price.Value;

                //                //var tpio = new TransPaymentItemOrder();
                //                //if (tpio.LoadByPrimaryKey(row.PaymentNo, rcc.TransactionNo, rcc.SequenceNo))
                //                //{
                //                //    if (string.IsNullOrEmpty(tpio.JournalIncomePaymentNo))
                //                //    {
                //                //        tpio.JournalIncomePaymentNo = row.PaymentNo;
                //                //        tpio.Save();
                //                //    }
                //                //}

                //                var TransC = new TransCharges();
                //                if (TransC.LoadByPrimaryKey(rcc.TransactionNo))
                //                {
                //                    var transCI = new TransChargesItem();
                //                    if (transCI.LoadByPrimaryKey(rcc.TransactionNo, rcc.SequenceNo))
                //                    {
                //                        // belum mempunyai transchargeItemComp & costcalculation jadi ambil ke item tariff
                //                        if (TransC.IsOrder == true && transCI.IsOrderRealization == false)
                //                        {
                //                            decimal td = 0;
                //                            decimal tc = 0;

                //                            //int? hehe = AddNewIncomeJournalCashBased_IsOrderTrue(entity.JournalId ?? 0, transCI, out tc, out td, false);
                //                            totalDebit += td;
                //                            totalCredit += tc;

                //                        }
                //                        else
                //                        {
                //                            var cCalc = new CostCalculation();
                //                            if (cCalc.LoadByPrimaryKey(TransC.RegistrationNo, rcc.TransactionNo, rcc.SequenceNo))
                //                            {
                //                                /* start journal*/

                //                                decimal td = 0;
                //                                decimal tc = 0;

                //                                //int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, cCalc, out tc, out td, false, transCI.ChargeQuantity ?? 0, new ChartOfAccountsCollection());
                //                                totalDebit += td;
                //                                totalCredit += tc;
                //                                /* end journal */
                //                            }
                //                            else
                //                            {
                //                                if (paket != null)
                //                                {
                //                                    cCalc = new CostCalculation();
                //                                    cCalc.RegistrationNo = TransC.RegistrationNo;
                //                                    cCalc.TransactionNo = rcc.TransactionNo;
                //                                    cCalc.SequenceNo = rcc.SequenceNo;
                //                                    cCalc.ItemID = rcc.ItemID;
                //                                    cCalc.PatientAmount = transCI.ChargeQuantity * (transCI.Price - (transCI.DiscountAmount / transCI.ChargeQuantity));
                //                                    cCalc.GuarantorAmount = 0;
                //                                    cCalc.DiscountAmount = transCI.DiscountAmount;

                //                                    /* start journal*/

                //                                    decimal td = 0;
                //                                    decimal tc = 0;

                //                                    //int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, cCalc, out tc, out td, false, transCI.ChargeQuantity ?? 0, new ChartOfAccountsCollection());
                //                                    totalDebit += td;
                //                                    totalCredit += tc;
                //                                    /* end journal */
                //                                }
                //                            }
                //                        }
                //                    }
                //                }
                //                //precription
                //                else
                //                {
                //                    var transPresc = new TransPrescription();
                //                    transPresc.LoadByPrimaryKey(rcc.TransactionNo);

                //                    var cCalc = new CostCalculation();
                //                    if (cCalc.LoadByPrimaryKey(transPresc.RegistrationNo, rcc.TransactionNo, rcc.SequenceNo))
                //                    {
                //                        /* start journal*/

                //                        decimal td = 0;
                //                        decimal tc = 0;

                //                        //int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, cCalc, out tc, out td, false, 0);
                //                        // qty di set nol sementara untuk resep saja
                //                        totalDebit += td;
                //                        totalCredit += tc;
                //                        /* end journal */
                //                    }
                //                }
                //            }
                //        }
                //    }
                //    #region original
                //    //            var q = new IntermBillCollection();
                //    //    //q.Query.Where(
                //    //    //    q.Query.IntermBillNo == row["intermBillNo"],
                //    //    //    q.Query.Or(
                //    //    //        q.Query.JournalIncomePaymentNo == string.Empty,
                //    //    //        q.Query.JournalIncomePaymentNo == RefNo
                //    //    //        )
                //    //    //    );
                //    //    ////q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"], q.Query.JournalIncomePaymentNo == RefNo);
                //    //    ////q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"]);
                //    //    //q.LoadAll();

                //    //    var ibq = new IntermBillQuery("ibq");
                //    //    var tp2 = new TransPaymentQuery("tp2");
                //    //    ibq.LeftJoin(tp2).On(ibq.JournalIncomePaymentNo == tp2.PaymentNo && tp2.IsVoid == false);
                //    //    ibq.Where(
                //    //        ibq.IntermBillNo == row["intermBillNo"],
                //    //        ibq.Or(
                //    //            "<ISNULL(tp2.PaymentNo,'') = '' OR >",
                //    //            ibq.JournalIncomePaymentNo == RefNo
                //    //            )
                //    //        );
                //    //    ibq.Select(ibq);
                //    //    ibq.es.Distinct = true;
                //    //    q.Load(ibq);


                //    //    foreach (var x in q)
                //    //    {
                //    //        //if (string.IsNullOrEmpty(x.JournalIncomePaymentNo))
                //    //        //{
                //    //        x.JournalIncomePaymentNo = RefNo;
                //    //        q.Save();
                //    //        //}

                //    //        var cost = new CostCalculationQuery("a");
                //    //        var charges = new TransChargesQuery("k");
                //    //        var chargesItem = new TransChargesItemQuery("l");

                //    //        cost.Select(
                //    //            cost.RegistrationNo,
                //    //            chargesItem.TransactionNo,
                //    //            chargesItem.SequenceNo,
                //    //            chargesItem.ReferenceNo,
                //    //            chargesItem.ReferenceSequenceNo,
                //    //            chargesItem.ItemID,
                //    //            chargesItem.ChargeQuantity,
                //    //            cost.PatientAmount,
                //    //            cost.GuarantorAmount,
                //    //            cost.DiscountAmount,
                //    //            @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                //    //            );
                //    //        cost.InnerJoin(charges).On(cost.TransactionNo == charges.TransactionNo);
                //    //        cost.InnerJoin(chargesItem).On(
                //    //            cost.TransactionNo == chargesItem.TransactionNo &&
                //    //            cost.SequenceNo == chargesItem.SequenceNo
                //    //            );
                //    //        cost.Where(
                //    //            cost.IntermBillNo == x.IntermBillNo,
                //    //            cost.Or(
                //    //                cost.ParentNo == string.Empty,
                //    //                cost.ParentNo.IsNull()
                //    //                )
                //    //            );
                //    //        cost.OrderBy(
                //    //            cost.RegistrationNo.Ascending,
                //    //            charges.TransactionNo.Ascending,
                //    //            chargesItem.SequenceNo.Ascending
                //    //            );

                //    //        DataTable table = cost.LoadDataTable();

                //    //        //paket mcu
                //    //        var cc1 = new CostCalculationCollection();
                //    //        cc1.Query.Where(cc1.Query.IntermBillNo == x.IntermBillNo);
                //    //        if (cc1.Query.Load())
                //    //        {
                //    //            var tc1 = new TransChargesCollection();
                //    //            tc1.Query.Where(tc1.Query.PackageReferenceNo.In(cc1.Select(c1 => c1.TransactionNo)));
                //    //            if (tc1.Query.Load())
                //    //            {
                //    //                cost = new CostCalculationQuery("a");
                //    //                charges = new TransChargesQuery("k");
                //    //                chargesItem = new TransChargesItemQuery("l");

                //    //                cost.Select(
                //    //                    cost.RegistrationNo,
                //    //                    chargesItem.TransactionNo,
                //    //                    chargesItem.SequenceNo,
                //    //                    chargesItem.ReferenceNo,
                //    //                    chargesItem.ReferenceSequenceNo,
                //    //                    chargesItem.ItemID,
                //    //                    chargesItem.ChargeQuantity,
                //    //                    cost.PatientAmount,
                //    //                    cost.GuarantorAmount,
                //    //                    cost.DiscountAmount,
                //    //                    @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                //    //                    );
                //    //                cost.InnerJoin(charges).On(cost.TransactionNo == charges.TransactionNo);
                //    //                cost.InnerJoin(chargesItem).On(
                //    //                    cost.TransactionNo == chargesItem.TransactionNo &&
                //    //                    cost.SequenceNo == chargesItem.SequenceNo
                //    //                    );
                //    //                cost.Where(
                //    //                    cost.TransactionNo.In(tc1.Select(t1 => t1.TransactionNo)),
                //    //                    cost.Or(
                //    //                        cost.ParentNo == string.Empty,
                //    //                        cost.ParentNo.IsNull()
                //    //                        )
                //    //                    );
                //    //                cost.OrderBy(
                //    //                    cost.RegistrationNo.Ascending,
                //    //                    charges.TransactionNo.Ascending,
                //    //                    chargesItem.SequenceNo.Ascending
                //    //                    );

                //    //                table.Merge(cost.LoadDataTable());

                //    //                table.Rows.Cast<DataRow>().Where(r => tc1.Select(t1 => t1.PackageReferenceNo).Distinct().Contains(r.Field<string>("TransactionNo"))).ToList().ForEach(r => r.Delete());
                //    //                table.AcceptChanges();
                //    //            }
                //    //        }

                //    //        DataTable temp = table.Copy(), temp2 = table.Copy(); ;

                //    //        var view = temp.DefaultView;
                //    //        view.RowFilter = "ReferenceNo <> '' AND ReferenceSequenceNo <> ''";
                //    //        temp = view.ToTable();
                //    //        view.Dispose();

                //    //        DataView view2 = temp2.DefaultView;
                //    //        view2.RowFilter = "ReferenceNo = '' AND ReferenceSequenceNo = ''";
                //    //        temp2 = view2.ToTable();
                //    //        view2.Dispose();

                //    //        foreach (DataRow r in table.Rows)
                //    //        {
                //    //            if (string.IsNullOrEmpty(r["ReferenceNo"].ToString()) && string.IsNullOrEmpty(r["ReferenceSequenceNo"].ToString()))
                //    //            {
                //    //                foreach (DataRow tmp in temp.Rows.Cast<DataRow>().Where(tmp => r["TransactionNo"].ToString() == tmp["ReferenceNo"].ToString() &&
                //    //                                                                               r["SequenceNo"].ToString() == tmp["ReferenceSequenceNo"].ToString()))
                //    //                {
                //    //                    r["ChargeQuantity"] = (decimal)r["ChargeQuantity"] + (decimal)tmp["ChargeQuantity"];
                //    //                    r["PatientAmount"] = (decimal)r["PatientAmount"] + (decimal)tmp["PatientAmount"];
                //    //                    r["GuarantorAmount"] = (decimal)r["GuarantorAmount"] + (decimal)tmp["GuarantorAmount"];
                //    //                    r["DiscountAmount"] = (decimal)r["DiscountAmount"] + (decimal)tmp["DiscountAmount"];
                //    //                }
                //    //            }
                //    //            else
                //    //            {
                //    //                foreach (DataRow tmp in temp2.Rows.Cast<DataRow>().Where(tmp => r["ReferenceNo"].ToString() == tmp["TransactionNo"].ToString() &&
                //    //                                                                                r["ReferenceSequenceNo"].ToString() == tmp["SequenceNo"].ToString()))
                //    //                {
                //    //                    r["IsDeleted"] = true;
                //    //                }
                //    //            }
                //    //        }

                //    //        table.AcceptChanges();

                //    //        foreach (DataRow r in table.Rows.Cast<DataRow>().Where(r => ((decimal)r["ChargeQuantity"] == 0) || ((bool)r["IsDeleted"])))
                //    //        {
                //    //            r.Delete();
                //    //        }

                //    //        table.AcceptChanges();


                //    //        var cost2 = new CostCalculationQuery("m");
                //    //        var TransPresc = new TransPrescriptionQuery("n");
                //    //        var TransPrescItem = new TransPrescriptionItemQuery("o");

                //    //        cost2.Select(
                //    //            cost2.RegistrationNo,
                //    //           cost2.TransactionNo,
                //    //            TransPrescItem.SequenceNo,
                //    //            TransPrescItem.ReferenceNo,
                //    //            TransPrescItem.ReferenceSequenceNo,
                //    //            TransPrescItem.ItemID,
                //    //            TransPrescItem.PrescriptionQty.As("ChargeQuantity"),
                //    //            cost2.PatientAmount,
                //    //            cost2.GuarantorAmount,
                //    //            cost2.DiscountAmount,
                //    //            @"<CAST(0 AS BIT) AS 'IsDeleted'>"
                //    //            );
                //    //        cost2.InnerJoin(TransPresc).On(cost2.TransactionNo == TransPresc.PrescriptionNo);
                //    //        cost2.InnerJoin(TransPrescItem).On(
                //    //            cost2.TransactionNo == TransPrescItem.PrescriptionNo &&
                //    //            cost2.SequenceNo == TransPrescItem.SequenceNo
                //    //            );
                //    //        cost2.Where(
                //    //            cost2.IntermBillNo == x.IntermBillNo

                //    //            );
                //    //        cost2.OrderBy(
                //    //            cost2.RegistrationNo.Ascending,
                //    //            TransPresc.PrescriptionNo.Ascending,
                //    //            TransPrescItem.SequenceNo.Ascending
                //    //            );

                //    //        DataTable table2 = cost2.LoadDataTable();

                //    //        table.Merge(table2);

                //    //        foreach (DataRow r in table.Rows)
                //    //        {
                //    //            TotalIntermBill += (Convert.ToDecimal(r["PatientAmount"]) + Convert.ToDecimal(r["GuarantorAmount"]));

                //    //            /* start journal */
                //    //            decimal td = 0;
                //    //            decimal tc = 0;

                //    //            var c = new CostCalculation();
                //    //            c.RegistrationNo = r["RegistrationNo"].ToString();
                //    //            c.TransactionNo = r["TransactionNo"].ToString();
                //    //            c.SequenceNo = r["SequenceNo"].ToString();
                //    //            c.ItemID = r["ItemID"].ToString();
                //    //            c.PatientAmount = Convert.ToDecimal(r["PatientAmount"]);
                //    //            c.GuarantorAmount = Convert.ToDecimal(r["GuarantorAmount"]);
                //    //            c.DiscountAmount = Convert.ToDecimal(r["DiscountAmount"]);

                //    //            int? hehe = AddNewIncomeJournalCashBasedTemporary(entity.JournalId ?? 0, c, out tc, out td, false, Convert.ToDecimal(r["ChargeQuantity"]), new ChartOfAccountsCollection());
                //    //            totalDebit += td;
                //    //            totalCredit += tc;
                //    //        }

                //    //        //var coll = new CostCalculationCollection();
                //    //        //coll.Query.Where(coll.Query.IntermBillNo == x.IntermBillNo);
                //    //        //coll.LoadAll();

                //    //        //foreach (var r in coll)
                //    //        //{
                //    //        //    TotalIntermBill += r.PatientAmount.Value + r.GuarantorAmount.Value;

                //    //        //    /* start journal */
                //    //        //    decimal td = 0;
                //    //        //    decimal tc = 0;

                //    //        //    int? hehe = AddNewIncomeJournalCashBased(entity.JournalId ?? 0, r, out tc, out td, false);
                //    //        //    totalDebit += td;
                //    //        //    totalCredit += tc;
                //    //        //}
                //    //    }

                //    //    // ambil total trnsaksi dari intermbill
                //    //    var ibT = new IntermBill();
                //    //    if (ibT.LoadByPrimaryKey(row["intermBillNo"].ToString()))
                //    //    {
                //    //        TIntermbill += ibT.PatientAmount.Value + ibT.GuarantorAmount.Value +
                //    //            ibT.AdministrationAmount.Value + ibT.GuarantorAdministrationAmount.Value -
                //    //            ibT.DiscAdmPatient.Value - ibT.DiscAdmGuarantor.Value;
                //    //    }

                //    //}
                //    //List<string> ibs = new List<string>();
                //    //foreach (DataRow row in dtb.Rows)
                //    //{
                //    //    ibs.Add(row["intermBillNo"].ToString());
                //    //}
                //    //// end of ambil total trnsaksi dari intermbill
                //    //// ambil total payment intermbil yang bersangkutan
                //    //var tpiTColl = new TransPaymentItemCollection();
                //    //var tpiT = new TransPaymentItemQuery("tpi");
                //    //var tpT = new TransPaymentQuery("tp");
                //    //var tpibgTColl = new TransPaymentItemIntermBillGuarantorCollection();
                //    //var tpibTColl = new TransPaymentItemIntermBillCollection();
                //    //tpibgTColl.Query.Where(tpibgTColl.Query.IntermBillNo.In(ibs));
                //    //tpibTColl.Query.Where(tpibTColl.Query.IntermBillNo.In(ibs));
                //    //tpibgTColl.LoadAll();
                //    //tpibTColl.LoadAll();
                //    //var PaymentNos = ((from s in tpibgTColl select s.PaymentNo)
                //    //    .Union(from s in tpibTColl select s.PaymentNo)).Distinct();
                //    //if (PaymentNos.Count() > 0)
                //    //{
                //    //    tpiT.InnerJoin(tpT).On(tpT.PaymentNo == tpiT.PaymentNo)
                //    //        .Where(
                //    //            tpT.IsApproved == true,
                //    //            tpT.PaymentNo.In(PaymentNos),
                //    //            tpT.PaymentNo <= tp.PaymentNo)
                //    //        .Select(tpiT);
                //    //    tpiTColl.Load(tpiT);
                //    //    TPayment += tpiTColl.Sum(x => x.Amount.Value + x.RoundingAmount.Value);
                //    //}
                //    //// end of ambil total payment intermbil yang bersangkutan
                //    #endregion
                //}

                // ADM
                foreach (var p in tpItems)
                {
                    string[] intermBillNo = new string[0];

                    var a1 = new TransPaymentItemIntermBillCollection();
                    a1.Query.Where(a1.Query.PaymentNo == RefNo);
                    if (a1.Query.Load())
                    {
                        intermBillNo = new string[a1.Count];
                        for (int i = 0; i < a1.Count; i++)
                        {
                            intermBillNo.SetValue(a1[i].IntermBillNo, i);
                        }
                    }
                    else
                    {
                        var b1 = new TransPaymentItemIntermBillGuarantorCollection();
                        b1.Query.Where(b1.Query.PaymentNo == RefNo);
                        if (b1.Query.Load())
                        {
                            intermBillNo = new string[b1.Count];
                            for (int i = 0; i < b1.Count; i++)
                            {
                                intermBillNo.SetValue(b1[i].IntermBillNo, i);
                            }
                        }
                    }

                    foreach (string ib1 in intermBillNo)
                    {
                        var ib = new IntermBill();
                        ib.LoadByPrimaryKey(ib1);
                        if (string.IsNullOrEmpty(ib.JournalIncomePaymentNo) || ib.JournalIncomePaymentNo == RefNo)
                        {
                            // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                            //if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                            {
                                if (((ib.AdministrationAmount - ib.DiscAdmPatient) + (ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor)) > 0
                                    // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                                    //if (reg.AdministrationAmount > 0 
                                    && (journalType.Equals(BusinessObject.JournalType.ARCreating) || journalType.Equals(BusinessObject.JournalType.Payment)) &&
                                    //tp.RemainingAmount <= 0 && 
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    var itemAdm = String.Empty;
                                    var CompID = String.Empty;
                                    AppParameter app = new AppParameter();
                                    if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                        itemAdm = app.ParameterValue;
                                    Item item = new Item();
                                    item.Query.Where(item.Query.ItemID == itemAdm);
                                    if (!item.Query.Load())
                                    {
                                        throw new Exception("App Parameter: coa_ItemIdBillingTotalAdmFee: " + itemAdm + " is not a valid service");
                                    }


                                    //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                                    AppParameter app2 = new AppParameter();
                                    if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                        CompID = app2.ParameterValue;
                                    TariffComponent ic = new TariffComponent();
                                    ic.Query.Where(ic.Query.TariffComponentID == CompID);
                                    if (!ic.Query.Load())
                                    {
                                        throw new Exception("App Parameter: coa_CompIDForBillingAdm: " + CompID + " is not a valid tarif component");
                                    }

                                    var su = new ServiceUnit();
                                    if (su.LoadByPrimaryKey(reg.ServiceUnitID))
                                    { }

                                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                                    itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                            itemService.Query.ItemID == itemAdm);
                                    if (!itemService.Query.Load())
                                    {
                                        throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
                                    }
                                    int? coaId = 0;
                                    int? subLedgerId = 0;

                                    var grr = new Guarantor();
                                    grr.LoadByPrimaryKey(reg.GuarantorID);

                                    ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                    itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                         itemComp.Query.ItemID == itemAdm,
                                                         itemComp.Query.TariffComponentID == CompID,
                                                         itemComp.Query.SRRegistrationType == regType,
                                                         itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                    if (itemComp.Query.Load())
                                    {
                                        if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemComp.ChartOfAccountIdIncome;
                                            subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                        }
                                    }

                                    // kalau Rawat Inap
                                    if (reg.SRRegistrationType == "IPR")
                                    {
                                        ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                        itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                            itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

                                        if (itemClass.Query.Load())
                                        {
                                            if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                            }
                                        }
                                    }

                                    //adm pasien
                                    if (journalType.Equals(BusinessObject.JournalType.Payment) && (ib.AdministrationAmount - ib.DiscAdmPatient) > 0)
                                    {
                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                        j.SubLedgerId = subLedgerId;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var admIB = (ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0);
                                        j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                        j.Credit = (admIB > 0) ? admIB : 0;
                                        // end of modif teguh s 2016 06 02

                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, su.ServiceUnitID, item.ItemID, tp.RegistrationNo);
                                        j.Save();

                                        totalCredit += j.Credit.Value;
                                        // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                        TotalIntermBill += j.Credit.Value;
                                    }

                                    //adm guarantor
                                    if (journalType.Equals(BusinessObject.JournalType.ARCreating) && (ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor) > 0)
                                    {
                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                        j.SubLedgerId = subLedgerId;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var admIB = (ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0);
                                        j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                        j.Credit = (admIB > 0) ? admIB : 0;
                                        // end of modif teguh s 2016 06 02

                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, string.Empty, item.ItemID, tp.RegistrationNo);
                                        j.Save();

                                        totalCredit += j.Credit.Value;
                                        adminGuarantor = Abs((ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0));
                                        // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                        TotalIntermBill += j.Credit.Value;
                                    }
                                }
                            }
                        }
                    }
                }
                // End of ADM

                Selisih = totalCredit - totalDebit;
                int coa_contemporary = GetCachedAccountFromParam("coa_ContemporaryPayment");
                int coa_overPayment = grn.ChartOfAccountIdOverPayment ?? 0;

                // temporary hanya bisa dijurnal jika ada intermbill
                //if (TIntermbill > 0)
                {
                    if (Selisih > 0) /* coa contemporary di debit */
                    {
                        /* jurnal temporary */
                        JournalTransactionDetails x = new JournalTransactionDetails();
                        x.AddNew();
                        x.JournalId = entity.JournalId;
                        x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                        x.SubLedgerId = 0;
                        x.Debit = Selisih;
                        x.Credit = 0;
                        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        x.DocumentNumber = tp.PaymentNo;

                        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, tp.RegistrationNo);
                        x.Save();

                        totalDebit += x.Debit.Value;

                    }
                    else if (Selisih < 0) /* coa contemporary di credit */
                    {
                        // cek dulu overpayment realnya berapa, kalau 0 berarti cukup jurnal temporary saja
                        var RealSelisih = Selisih;

                        if (coa_overPayment == 0)
                        {
                            /* jurnal temporary */
                            JournalTransactionDetails x = new JournalTransactionDetails();
                            x.AddNew();
                            x.JournalId = entity.JournalId;

                            var dscr = tpItems.Where(t => !string.IsNullOrEmpty(t.SRDiscountReason)).SingleOrDefault();
                            string srDiscountReason = dscr == null ? string.Empty : dscr.SRDiscountReason;
                            if (!string.IsNullOrEmpty(srDiscountReason))
                            {
                                var sDiscReason = stdDR.Where(std => std.ItemID == srDiscountReason);
                                if (sDiscReason.Count() > 0)
                                {
                                    var dsc = sDiscReason.First();
                                    //DiscountReason = dsc.ItemName;
                                    //dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
                                    //if ((dsc.coaID ?? 0) != 0)
                                    //{
                                    //    dAccount = dsc.coaID.Value;
                                    //    dSubledgerId = dsc.subledgerID ?? 0;
                                    //}
                                    x.ChartOfAccountId = dsc.coaID.Value;
                                }
                            }
                            else
                                x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");


                            x.SubLedgerId = 0;
                            x.Debit = 0;
                            x.Credit = Abs(Selisih);// +adminGuarantor;
                            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            x.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            x.Save();

                            totalCredit += x.Credit.Value;
                        }
                        else
                        {
                            var sss = totalDebit - totalCredit;

                            var slColl = new SubLedgersCollection();
                            slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
                            if (slColl.LoadAll())
                            {

                            }

                            JournalTransactionDetails xo = new JournalTransactionDetails();
                            xo.AddNew();
                            xo.JournalId = entity.JournalId;
                            xo.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                            xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
                            xo.Debit = sss < 0 ? Abs(sss) : 0;
                            xo.Credit = sss > 0 ? sss : 0;
                            xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            xo.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            xo.Save();

                            totalCredit += xo.Credit.Value;
                        }
                        //else
                        //{
                        //    // kalau coa coa_overPayment ada isinya berarti kelebihan pembayaran dijurnal ke coa tersebut
                        //    TIntermbill = TIntermbill == 0 ? TotalIntermBill : TIntermbill;
                        //    TPayment = TPayment == 0 ? TotalPembayaran : TPayment;
                        //    Selisih = TPayment - TIntermbill;
                        //    if (Selisih > 0)
                        //    {
                        //        // kelebihan pembayaran

                        //        // ambil subledger
                        //        var slColl = new SubLedgersCollection();
                        //        slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
                        //        if (slColl.LoadAll())
                        //        {

                        //        }

                        //        JournalTransactionDetails xo = new JournalTransactionDetails();
                        //        xo.AddNew();
                        //        xo.JournalId = entity.JournalId;
                        //        xo.ChartOfAccountId = ValidateCOA(coa_overPayment, coaColl, string.Format(
                        //            "Master Guarantor: {0}: COA: COA Exccess Payment / Discount (A/R)", grn.GuarantorName));
                        //        xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
                        //        xo.Debit = 0;
                        //        xo.Credit = Selisih;
                        //        xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        //        xo.DocumentNumber = tp.PaymentNo;

                        //        AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                        //            null, string.Empty, string.Empty, tp.RegistrationNo);
                        //        xo.Save();

                        //        totalCredit += xo.Credit.Value;
                        //    }

                        //    //if (TotalPembayaran < TPayment)
                        //    if (TotalPembayaran < TPayment && TotalPembayaran - TotalBalance - Selisih > 0)
                        //    {
                        //        /* jurnal temporary */
                        //        JournalTransactionDetails x = new JournalTransactionDetails();
                        //        x.AddNew();
                        //        x.JournalId = entity.JournalId;
                        //        x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment"); //coa_contemporary;
                        //        x.SubLedgerId = 0;
                        //        x.Debit = 0;
                        //        x.Credit = RealSelisih < 0 ? (RealSelisih * -1) : (TotalPembayaran - TotalBalance - Selisih);// +adminGuarantor;
                        //        //x.Credit = TIntermbill - TPayment;


                        //        //x.Debit = 0;
                        //        //x.Credit = totalDebit - totalCredit;

                        //        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        //        x.DocumentNumber = tp.PaymentNo;

                        //        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                        //            null, string.Empty, string.Empty, tp.RegistrationNo);
                        //        x.Save();

                        //        totalCredit += x.Credit.Value;
                        //    }
                        //}
                    }
                }
                //else if (TotalIntermBill == 0 && TIntermbill == 0)
                //{
                //    // untuk payment 2 guarantor, payment guarantor ke-2 tidak ada link
                //    // ke intermbill yang dibayar. bikin jurnalnya gimana ya??

                //    if (TotalPembayaran >= 0)
                //    {
                //        /* jurnal temporary */
                //        foreach (var p in tpItems)
                //        {
                //            JournalTransactionDetails x = new JournalTransactionDetails();
                //            x.AddNew();
                //            x.JournalId = entity.JournalId;
                //            x.ChartOfAccountId = ValidateCOA(coa_contemporary, coaColl, "AppParameter: coa_ContemporaryPayment"); //coa_contemporary;
                //            x.SubLedgerId = 0;
                //            x.Debit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                //            x.Credit = (p.Amount > 0) ? p.Amount : 0;
                //            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                //            x.DocumentNumber = tp.PaymentNo;

                //            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                //                null, string.Empty, string.Empty, tp.RegistrationNo);
                //            x.Save();

                //            totalDebit += x.Debit.Value;
                //            totalCredit += x.Credit.Value;
                //        }
                //    }
                //}

                //if (Selisih > 0) /*coa contemporary di debit */
                //{
                //    /* jurnal temporary */
                //    JournalTransactionDetails x = new JournalTransactionDetails();
                //    x.AddNew();
                //    x.JournalId = entity.JournalId;
                //    x.ChartOfAccountId = coa_contemporary;
                //    x.SubLedgerId = 0;
                //    x.Debit = Selisih;
                //    x.Credit = 0;
                //    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                //    x.DocumentNumber = tp.PaymentNo;
                //    x.Save();

                //    totalDebit += x.Debit.Value;

                //}
                //else if (Selisih < 0) /* coa contemporary di credit */
                //{
                //    /* jurnal temporary */
                //    JournalTransactionDetails x = new JournalTransactionDetails();
                //    x.AddNew();
                //    x.JournalId = entity.JournalId;
                //    x.ChartOfAccountId = coa_contemporary;
                //    x.SubLedgerId = 0;
                //    x.Debit = 0;
                //    x.Credit = Abs(Selisih);// +adminGuarantor;
                //    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                //    x.DocumentNumber = tp.PaymentNo;
                //    x.Save();

                //    totalCredit += x.Credit.Value;
                //}

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    // insert cash transaction here
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnPaymentPatient) == "Yes")
                    {
                        int? cashTransactionId;
                        CashTransaction.AddNewAutomaticCashTransactionPaymentReceiveFromJournal(
                            tp, tpItems, entity, editedBy, out cashTransactionId);
                        // otomatis posting
                        if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                        {
                            CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }


        public static int? AddNewPaymentCorrectionJournal(string PaymentNo, string prefix, string editedBy, int journalId, DateTime CorrectionDate)
        {
            //Function ini digunakan untuk transaksi Void Payment/Down Payment & Payment Return
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            //var qd = new JournalTransactionDetailsQuery("qd");

            //qh.es.Distinct = true;

            qh//.InnerJoin(qd).On(qh.JournalId == qd.JournalId)
                .Where(
                    //qd.DocumentNumber == PaymentNo, 
                    qh.RefferenceNumber == PaymentNo, // <-- diganti kesini karena ada jurnal payment yang DocumentNumbernya gak ada nomor PM, mungkin karena paymentnya 0
                    qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    ctColl.Query.JournalId == jhcoll[0].JournalId.Value,
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current payment");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                var ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, prefix, editedBy, CorrectionDate);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                // ---------------------

                // void auto cash entry
                return ret;
            }
        }

        public static int? AddNewPaymentCorrectionJournalTemporary(string PaymentNo, string prefix, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Payment/Down Payment & Payment Return
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qd = new JournalTransactionDetailsQuery("qd");

            qh.es.Distinct = true;

            qh.InnerJoin(qd).On(qh.JournalId == qd.JournalId)
                .Where(qd.DocumentNumber == PaymentNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    ctColl.Query.JournalId == jhcoll[0].JournalId.Value,
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current payment");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                var ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, prefix, editedBy);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                // ---------------------

                // void auto cash entry
                return ret;
            }
        }


        public static int? AddNewPaymentCorrectionJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection ctpItems, string prefix, string editedBy, int journalId)
        {
            if (journalType != "07")
            {
                // jika journal void payment maka balikin saja jurnal paymentnya
                // down payment - unapproved
                return AddNewPaymentCorrectionJournal(tp.PaymentNo, prefix, editedBy, journalId, tp.VoidDate.Value);
            }

            //Function ini digunakan untuk transaksi Void Payment/Down Payment & Payment Return
            if (!IsAutoJournalEnabled())
                return 0;

            // payment return - bukan cash based
            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = String.Empty;
                keterangan = journalType == "07" ? "PAYMENT RETURN" : "PAYMENT VOID";

                //Journal Header
                JournalTransactions entityjt = new JournalTransactions();
                if (entityjt.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entityjt.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entityjt.LastUpdateDateTime = DateTime.Now;
                    //entityjt.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entityjt.AddNew();
                    entityjt.JournalType = journalType;
                    //entityjt.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.VoidDate.Value);//DateTime.Now.Date);
                    entityjt.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, DateTime.Now.Date);
                    entityjt.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entityjt.JournalCode);
                    //entityjt.TransactionDate = tp.VoidDate.Value; // DateTime.Now.Date;
                    entityjt.TransactionDate = DateTime.Now.Date;
                    entityjt.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    entityjt.IsPosted = false;
                    entityjt.DateCreated = entityjt.LastUpdateDateTime = DateTime.Now;
                    entityjt.CreatedBy = entityjt.CreatedBy = entityjt.LastUpdateByUserID = editedBy;
                    entityjt.RefferenceNumber = tp.PaymentNo;
                }
                entityjt.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //ganti keterangan lg untuk description detail
                keterangan = (journalType == "07") ? "RETURN" : "(VOID)";
                var lastRow = ctpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();
                foreach (var py in ctpItems)
                {
                    string payMethode = py.SRPaymentMethod;
                    string payType = py.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.PaymentTypeName.Equals("PaymentType-001"))
                            continue;
                    }

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        if (pm.ChartOfAccountID.HasValue)
                        {
                            dAccount = pm.ChartOfAccountID.Value;
                            dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        }

                        //transfer
                        if (py.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            Bank bank = new Bank();
                            if (bank.LoadByPrimaryKey(py.BankID))
                            {
                                if (bank.ChartOfAccountId.HasValue)
                                    dAccount = bank.ChartOfAccountId.Value;
                                if (bank.SubledgerId.HasValue)
                                    dSubledgerId = bank.SubledgerId.Value;
                            }
                        }
                    }

                    if (py.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        if (py.Amount.Value != 0)
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entityjt.JournalId;
                            c.ChartOfAccountId = cAccount_off;
                            c.SubLedgerId = 0;
                            c.Debit = Abs(py.Amount);
                            c.Credit = 0;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.Save();

                            totalDebit += c.Debit.Value;

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entityjt.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = 0;
                            d.Credit = Abs(py.Amount);
                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.Save();

                            totalCredit += d.Credit.Value;
                        }

                        if (py.Balance.Value != 0)
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entityjt.JournalId;
                            c.ChartOfAccountId = cAccount_off;
                            c.SubLedgerId = 0;
                            c.Debit = py.Balance;
                            c.Credit = 0;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.Save();

                            totalDebit += c.Debit.Value;

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entityjt.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = 0;
                            d.Credit = py.Balance;
                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.Save();

                            totalCredit += c.Credit.Value;
                        }
                    }
                    else
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(py.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                    }

                                }
                            }
                        }

                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");

                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003")) // piutang instansi & Personal
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
                            {
                                if (guarantorEntity.ChartOfAccountId.HasValue)
                                {
                                    dAccount = guarantorEntity.ChartOfAccountId.Value;
                                    dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                                }
                            }
                        }

                        //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entityjt.JournalId;
                        d.ChartOfAccountId = dAccount;
                        d.SubLedgerId = dSubledgerId;
                        d.Debit = 0;
                        d.Credit = Abs(py.Amount);
                        d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        d.DocumentNumber = tp.PaymentNo;
                        d.Save();

                        totalCredit += d.Credit.Value;

                        if (journalType.Equals(BusinessObject.JournalType.Payment) && tp.RemainingAmount <= 0 && py.SequenceNo == lastRow.SequenceNo)
                        {
                            if ((reg.AdministrationAmount ?? 0) > py.Amount)
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entityjt.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = 0;
                                c.Credit = (reg.AdministrationAmount ?? 0) + (py.RoundingAmount ?? 0) - py.Amount;
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.Save();

                                totalCredit += c.Credit.Value;
                            }
                            else
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entityjt.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = py.Amount - (reg.AdministrationAmount ?? 0) - (py.RoundingAmount ?? 0);
                                c.Credit = 0;
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.Save();

                                totalDebit += c.Debit.Value;
                            }
                        }
                        else
                        {
                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entityjt.JournalId;
                            c.ChartOfAccountId = cAccount;
                            c.SubLedgerId = 0;
                            c.Debit = py.Amount - (py.RoundingAmount ?? 0);
                            c.Credit = 0;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.Save();

                            totalDebit += c.Debit.Value;
                        }

                        // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                        if (reg.AdministrationAmount > 0 && journalType.Equals(BusinessObject.JournalType.Payment) && tp.RemainingAmount <= 0 && py.SequenceNo == lastRow.SequenceNo)
                        {
                            var itemAdm = String.Empty;
                            var compID = string.Empty;
                            AppParameter app = new AppParameter();
                            if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                itemAdm = app.ParameterValue;

                            //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                            AppParameter app2 = new AppParameter();
                            if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                compID = app2.ParameterValue;

                            ServiceUnitItemService itemService = new ServiceUnitItemService();
                            itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                    itemService.Query.ItemID == itemAdm);
                            if (itemService.Query.Load())
                            {
                                int? coaId = 0;
                                int? subLedgerId = 0;

                                var grr = new Guarantor();
                                grr.LoadByPrimaryKey(reg.GuarantorID);

                                ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                     itemComp.Query.ItemID == itemAdm,
                                                     itemComp.Query.TariffComponentID == compID,
                                                     itemComp.Query.SRRegistrationType == regType,
                                                     itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                if (itemComp.Query.Load())
                                {
                                    if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                    {
                                        coaId = itemComp.ChartOfAccountIdIncome;
                                        subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                    }
                                }

                                // kalau Rawat Inap
                                if (reg.SRRegistrationType == "IPR")
                                {

                                    ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                    itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                        itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == compID);

                                    if (itemClass.Query.Load())
                                    {
                                        if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemClass.ChartOfAccountIdIncome.Value;
                                            subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                        }
                                    }
                                }

                                Item item = new Item();
                                item.Query.Where(item.Query.ItemID == itemAdm);
                                item.Query.Load();

                                JournalTransactionDetails j = new JournalTransactionDetails();
                                j.AddNew();
                                j.JournalId = entityjt.JournalId;
                                j.ChartOfAccountId = coaId;
                                j.SubLedgerId = subLedgerId;
                                j.Debit = (reg.AdministrationAmount ?? 0);
                                j.Credit = 0;
                                j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                j.DocumentNumber = tp.PaymentNo;
                                j.Save();

                                totalDebit += j.Debit.Value;
                            }
                        }

                        if ((py.RoundingAmount ?? 0) > 0)
                        {
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entityjt.JournalId;
                            k.ChartOfAccountId = roundAmt;
                            k.SubLedgerId = 0;
                            k.Debit = (py.RoundingAmount ?? 0);
                            k.Credit = 0;
                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.Save();

                            totalDebit += k.Debit.Value;
                        }

                        // if there is CC fee
                        if (py.CardFeeAmount > 0)
                        {
                            // debit
                            JournalTransactionDetails cFee = new JournalTransactionDetails();
                            cFee.AddNew();
                            cFee.JournalId = entityjt.JournalId;
                            cFee.ChartOfAccountId = GetCachedAccountFromParam("coa_PaymentCardFeeAmt");
                            cFee.SubLedgerId = 0;
                            cFee.Debit = py.CardFeeAmount;
                            cFee.Credit = 0;
                            cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            cFee.DocumentNumber = tp.PaymentNo;
                            cFee.Save();

                            totalDebit += cFee.Debit.Value;

                            // credit
                            JournalTransactionDetails dFee = new JournalTransactionDetails();
                            dFee.AddNew();
                            dFee.JournalId = entityjt.JournalId;
                            dFee.ChartOfAccountId = dAccount;
                            dFee.SubLedgerId = 0;
                            dFee.Debit = 0;
                            dFee.Credit = py.CardFeeAmount;
                            dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            dFee.DocumentNumber = tp.PaymentNo;
                            dFee.Save();

                            totalCredit += dFee.Credit.Value;
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entityjt.BeginEdit();
                        entityjt.IsPosted = true;
                        entityjt.EndEdit();
                        entityjt.Save();
                    }
                }


                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entityjt.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewPaymentCorrectionJournalTemporary(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection ctpItems, string prefix, string editedBy, int journalId)
        {
            if (journalType != "07")
            {
                // jika journal void payment maka balikin saja jurnal paymentnya
                return AddNewPaymentCorrectionJournal(tp.PaymentNo, prefix, editedBy, journalId, tp.VoidDate.Value);
            }

            //Function ini digunakan untuk transaksi Void Payment/Down Payment & Payment Return
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                var regType = reg.SRRegistrationType;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = String.Empty;
                keterangan = journalType == "07" ? "PAYMENT RETURN" : "PAYMENT VOID";

                //Journal Header
                JournalTransactions entityjt = new JournalTransactions();
                if (entityjt.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entityjt.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entityjt.LastUpdateDateTime = DateTime.Now;
                    //entityjt.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entityjt.AddNew();
                    entityjt.JournalType = journalType;
                    entityjt.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.VoidDate.Value);//DateTime.Now.Date);
                    entityjt.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entityjt.JournalCode);
                    entityjt.TransactionDate = tp.VoidDate.Value; // DateTime.Now.Date;
                    entityjt.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    entityjt.IsPosted = false;
                    entityjt.DateCreated = entityjt.LastUpdateDateTime = DateTime.Now;
                    entityjt.CreatedBy = entityjt.CreatedBy = entityjt.LastUpdateByUserID = editedBy;
                    entityjt.RefferenceNumber = tp.PaymentNo;
                }
                entityjt.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //ganti keterangan lg untuk description detail
                keterangan = (journalType == "07") ? "RETURN" : "(VOID)";
                var lastRow = ctpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();
                foreach (var py in ctpItems)
                {
                    string payMethode = py.SRPaymentMethod;
                    string payType = py.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.PaymentTypeName.Equals("PaymentType-001"))
                            continue;
                    }

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        if (pm.ChartOfAccountID.HasValue)
                        {
                            dAccount = pm.ChartOfAccountID.Value;
                            dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        }

                        //transfer
                        if (py.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            Bank bank = new Bank();
                            if (bank.LoadByPrimaryKey(py.BankID))
                            {
                                if (bank.ChartOfAccountId.HasValue)
                                    dAccount = bank.ChartOfAccountId.Value;
                                if (bank.SubledgerId.HasValue)
                                    dSubledgerId = bank.SubledgerId.Value;
                            }
                        }
                    }

                    if (py.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        if (py.Amount.Value != 0)
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entityjt.JournalId;
                            c.ChartOfAccountId = cAccount_off;
                            c.SubLedgerId = 0;
                            c.Debit = Abs(py.Amount);
                            c.Credit = 0;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.Save();

                            totalDebit += c.Debit.Value;

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entityjt.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = 0;
                            d.Credit = Abs(py.Amount);
                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.Save();

                            totalCredit += d.Credit.Value;
                        }

                        if (py.Balance.Value != 0)
                        {
                            int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entityjt.JournalId;
                            c.ChartOfAccountId = cAccount_off;
                            c.SubLedgerId = 0;
                            c.Debit = py.Balance;
                            c.Credit = 0;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.Save();

                            totalDebit += c.Debit.Value;

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entityjt.JournalId;
                            d.ChartOfAccountId = dAccount_off;
                            d.SubLedgerId = 0;
                            d.Debit = 0;
                            d.Credit = py.Balance;
                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            d.DocumentNumber = tp.PaymentNo;
                            d.Save();

                            totalCredit += c.Credit.Value;
                        }
                    }
                    else
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(py.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                    }

                                }
                            }
                        }

                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");

                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003")) // piutang instansi & Personal
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
                            {
                                if (guarantorEntity.ChartOfAccountId.HasValue)
                                {
                                    dAccount = guarantorEntity.ChartOfAccountId.Value;
                                    dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                                }
                            }
                        }

                        //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entityjt.JournalId;
                        d.ChartOfAccountId = dAccount;
                        d.SubLedgerId = dSubledgerId;
                        d.Debit = 0;
                        d.Credit = Abs(py.Amount);
                        d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        d.DocumentNumber = tp.PaymentNo;
                        d.Save();

                        totalCredit += d.Credit.Value;

                        if (journalType.Equals(BusinessObject.JournalType.Payment) && tp.RemainingAmount <= 0 && py.SequenceNo == lastRow.SequenceNo)
                        {
                            if ((reg.AdministrationAmount ?? 0) > py.Amount)
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entityjt.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = 0;
                                c.Credit = (reg.AdministrationAmount ?? 0) + (py.RoundingAmount ?? 0) - py.Amount;
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.Save();

                                totalCredit += c.Credit.Value;
                            }
                            else
                            {
                                JournalTransactionDetails c = new JournalTransactionDetails();
                                c.AddNew();
                                c.JournalId = entityjt.JournalId;
                                c.ChartOfAccountId = cAccount;
                                c.SubLedgerId = 0;
                                c.Debit = py.Amount - (reg.AdministrationAmount ?? 0) - (py.RoundingAmount ?? 0);
                                c.Credit = 0;
                                c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                c.DocumentNumber = tp.PaymentNo;
                                c.Save();

                                totalDebit += c.Debit.Value;
                            }
                        }
                        else
                        {
                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entityjt.JournalId;
                            c.ChartOfAccountId = cAccount;
                            c.SubLedgerId = 0;
                            c.Debit = py.Amount - (py.RoundingAmount ?? 0);
                            c.Credit = 0;
                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.Save();

                            totalDebit += c.Debit.Value;
                        }

                        // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                        if (reg.AdministrationAmount > 0 && journalType.Equals(BusinessObject.JournalType.Payment) && tp.RemainingAmount <= 0 && py.SequenceNo == lastRow.SequenceNo)
                        {
                            var itemAdm = String.Empty;
                            var compID = string.Empty;
                            AppParameter app = new AppParameter();
                            if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                itemAdm = app.ParameterValue;

                            //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                            AppParameter app2 = new AppParameter();
                            if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                compID = app2.ParameterValue;

                            ServiceUnitItemService itemService = new ServiceUnitItemService();
                            itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                    itemService.Query.ItemID == itemAdm);
                            if (itemService.Query.Load())
                            {
                                int? coaId = 0;
                                int? subLedgerId = 0;

                                var grr = new Guarantor();
                                grr.LoadByPrimaryKey(reg.GuarantorID);

                                ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                     itemComp.Query.ItemID == itemAdm,
                                                     itemComp.Query.TariffComponentID == compID,
                                                     itemComp.Query.SRRegistrationType == regType,
                                                     itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                if (itemComp.Query.Load())
                                {
                                    if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                    {
                                        coaId = itemComp.ChartOfAccountIdIncome;
                                        subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                    }
                                }

                                // kalau Rawat Inap
                                if (reg.SRRegistrationType == "IPR")
                                {

                                    ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                    itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                        itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == compID);

                                    if (itemClass.Query.Load())
                                    {
                                        if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemClass.ChartOfAccountIdIncome.Value;
                                            subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                        }
                                    }
                                }

                                Item item = new Item();
                                item.Query.Where(item.Query.ItemID == itemAdm);
                                item.Query.Load();

                                JournalTransactionDetails j = new JournalTransactionDetails();
                                j.AddNew();
                                j.JournalId = entityjt.JournalId;
                                j.ChartOfAccountId = coaId;
                                j.SubLedgerId = subLedgerId;
                                j.Debit = (reg.AdministrationAmount ?? 0);
                                j.Credit = 0;
                                j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                j.DocumentNumber = tp.PaymentNo;
                                j.Save();

                                totalDebit += j.Debit.Value;
                            }
                        }

                        if ((py.RoundingAmount ?? 0) > 0)
                        {
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entityjt.JournalId;
                            k.ChartOfAccountId = roundAmt;
                            k.SubLedgerId = 0;
                            k.Debit = (py.RoundingAmount ?? 0);
                            k.Credit = 0;
                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.Save();

                            totalDebit += k.Debit.Value;
                        }

                        // if there is CC fee
                        if (py.CardFeeAmount > 0)
                        {
                            // debit
                            JournalTransactionDetails cFee = new JournalTransactionDetails();
                            cFee.AddNew();
                            cFee.JournalId = entityjt.JournalId;
                            cFee.ChartOfAccountId = GetCachedAccountFromParam("coa_PaymentCardFeeAmt");
                            cFee.SubLedgerId = 0;
                            cFee.Debit = py.CardFeeAmount;
                            cFee.Credit = 0;
                            cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            cFee.DocumentNumber = tp.PaymentNo;
                            cFee.Save();

                            totalDebit += cFee.Debit.Value;

                            // credit
                            JournalTransactionDetails dFee = new JournalTransactionDetails();
                            dFee.AddNew();
                            dFee.JournalId = entityjt.JournalId;
                            dFee.ChartOfAccountId = dAccount;
                            dFee.SubLedgerId = 0;
                            dFee.Debit = 0;
                            dFee.Credit = py.CardFeeAmount;
                            dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            dFee.DocumentNumber = tp.PaymentNo;
                            dFee.Save();

                            totalCredit += dFee.Credit.Value;
                        }
                    }

                }
                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entityjt.BeginEdit();
                        entityjt.IsPosted = true;
                        entityjt.EndEdit();
                        entityjt.Save();
                    }
                }


                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entityjt.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewPaymentReturnCorrectionJournal(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection ctpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            // payment receive - unapproval
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entityjt = new JournalTransactions();
                if (entityjt.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entityjt.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entityjt.LastUpdateDateTime = DateTime.Now;
                    //entityjt.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entityjt.AddNew();
                    entityjt.JournalType = journalType;
                    entityjt.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, DateTime.Now.Date);
                    entityjt.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entityjt.JournalCode);
                    entityjt.TransactionDate = DateTime.Now.Date;
                    entityjt.Description = string.Format("PAYMENT RETURN VOID REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    entityjt.IsPosted = false;
                    entityjt.DateCreated = entityjt.LastUpdateDateTime = DateTime.Now;
                    entityjt.CreatedBy = entityjt.CreatedBy = entityjt.LastUpdateByUserID = editedBy;
                    entityjt.RefferenceNumber = tp.PaymentNo;
                }
                entityjt.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                foreach (var py in ctpItems)
                {
                    string payMethode = py.SRPaymentMethod;
                    string payType = py.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.PaymentTypeName.Equals("PaymentType-001"))
                            continue;
                    }

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;
                    int cSubledgerId = 0;

                    if (pm.ChartOfAccountID.HasValue)
                    {
                        dAccount = pm.ChartOfAccountID.Value;
                        dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                    }

                    //parameter diisi coa pendapatan farmasi
                    //subledger pendapatan diambil dari subledger unit farmasi
                    cAccount = GetCachedAccountFromParam("coa_DirectPrescReturn");
                    string unt = string.Empty;
                    AppParameter app = new AppParameter();
                    if (app.LoadByPrimaryKey("ServiceUnitPharmacyID"))
                        unt = app.ParameterValue;

                    ServiceUnit su = new ServiceUnit();
                    if (su.LoadByPrimaryKey(unt))
                        cSubledgerId = Convert.ToInt16(su.SubledgerIdCost);

                    //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entityjt.JournalId;
                    c.ChartOfAccountId = dAccount;
                    c.SubLedgerId = 0;
                    c.Debit = Abs(py.Amount);
                    c.Credit = 0;
                    c.Description = string.Format("(VOID) REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    c.DocumentNumber = tp.PaymentNo;
                    c.Save();

                    totalDebit += c.Debit.Value;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entityjt.JournalId;
                    d.ChartOfAccountId = cAccount;
                    d.SubLedgerId = cSubledgerId;
                    d.Debit = 0;
                    d.Credit = Abs(py.Amount);
                    d.Description = string.Format("(VOID) REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    d.DocumentNumber = tp.PaymentNo;
                    d.Save();

                    totalCredit += d.Credit.Value;


                }
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entityjt.BeginEdit();
                        entityjt.IsPosted = true;
                        entityjt.EndEdit();
                        entityjt.Save();
                    }
                }

                return entityjt.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewPaymentReturnCorrectionJournalTemporary(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection ctpItems, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                //Journal Header
                JournalTransactions entityjt = new JournalTransactions();
                if (entityjt.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entityjt.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entityjt.LastUpdateDateTime = DateTime.Now;
                    //entityjt.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entityjt.AddNew();
                    entityjt.JournalType = journalType;
                    entityjt.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, DateTime.Now.Date);
                    entityjt.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entityjt.JournalCode);
                    entityjt.TransactionDate = DateTime.Now.Date;
                    entityjt.Description = string.Format("PAYMENT RETURN VOID REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    entityjt.IsPosted = false;
                    entityjt.DateCreated = entityjt.LastUpdateDateTime = DateTime.Now;
                    entityjt.CreatedBy = entityjt.CreatedBy = entityjt.LastUpdateByUserID = editedBy;
                    entityjt.RefferenceNumber = tp.PaymentNo;
                }
                entityjt.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                foreach (var py in ctpItems)
                {
                    string payMethode = py.SRPaymentMethod;
                    string payType = py.SRPaymentType;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.PaymentTypeName.Equals("PaymentType-001"))
                            continue;
                    }

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;
                    int cSubledgerId = 0;

                    if (pm.ChartOfAccountID.HasValue)
                    {
                        dAccount = pm.ChartOfAccountID.Value;
                        dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                    }

                    //parameter diisi coa pendapatan farmasi
                    //subledger pendapatan diambil dari subledger unit farmasi
                    cAccount = GetCachedAccountFromParam("coa_DirectPrescReturn");
                    string unt = string.Empty;
                    AppParameter app = new AppParameter();
                    if (app.LoadByPrimaryKey("ServiceUnitPharmacyID"))
                        unt = app.ParameterValue;

                    ServiceUnit su = new ServiceUnit();
                    if (su.LoadByPrimaryKey(unt))
                        cSubledgerId = Convert.ToInt16(su.SubledgerIdCost);

                    //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entityjt.JournalId;
                    c.ChartOfAccountId = dAccount;
                    c.SubLedgerId = 0;
                    c.Debit = Abs(py.Amount);
                    c.Credit = 0;
                    c.Description = string.Format("(VOID) REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    c.DocumentNumber = tp.PaymentNo;
                    c.Save();

                    totalDebit += c.Debit.Value;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entityjt.JournalId;
                    d.ChartOfAccountId = cAccount;
                    d.SubLedgerId = cSubledgerId;
                    d.Debit = 0;
                    d.Credit = Abs(py.Amount);
                    d.Description = string.Format("(VOID) REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName);
                    d.DocumentNumber = tp.PaymentNo;
                    d.Save();

                    totalCredit += d.Credit.Value;


                }
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entityjt.BeginEdit();
                        entityjt.IsPosted = true;
                        entityjt.EndEdit();
                        entityjt.Save();
                    }
                }

                return entityjt.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewGuarantorDeposit(GuarantorDeposit gd, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.GuarantorDeposit;

            //Logger.EnterMethod("AddNewGuarantorDepositJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for InvoiceNo={0}", ti.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                string payMethode = gd.SRPaymentMethod;
                string payType = gd.SRPaymentType;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                Bank bankEntity = null;  // used to create auto CM txn


                Guarantor g = new Guarantor();
                if (!g.LoadByPrimaryKey(gd.GuarantorID))
                    return 0;

                //InvoicesItemCollection tiItems = new InvoicesItemCollection();
                //tiItems.Query.Where(tiItems.Query.InvoiceNo == gd.TransactionNo);
                //if (!tiItems.Query.Load())
                //    return 0;


                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DP", gd.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = gd.TransactionDate;
                    entity.Description = string.Format("GUARANTOR DEPOSIT#:{0}. GUAR#:{1}.", gd.TransactionNo, g.GuarantorName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = gd.TransactionNo;
                }
                entity.Save();

                Guarantor guarantorEntity = new Guarantor();
                if (guarantorEntity.LoadByPrimaryKey(gd.GuarantorID))
                {
                    if (guarantorEntity.ChartOfAccountId.HasValue)
                    {
                        cAccount = guarantorEntity.ChartOfAccountIdDeposit.Value;
                        cSubledgerId = (guarantorEntity.SubledgerIdDeposit.HasValue ? guarantorEntity.SubledgerIdDeposit.Value : 0);
                    }
                }


                // Hermawan
                if (gd.SRPaymentType.Equals("PaymentType-002"))
                {

                    // Payment Cash 
                    if (gd.SRPaymentMethod.Equals("PaymentMethod-001"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-002"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;

                            //var bankColl = new BankCollection();
                            //bankColl.Query.Where(bankColl.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankColl.LoadAll();
                            //if (bankColl.Count == 0)
                            //    return 2;

                            //bankEntity = new Bank();
                            //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankEntity.Query.Load();
                        }
                    }

                    // Payment Credit Card || Payment Debit Card 
                    if (gd.SRPaymentMethod.Equals("PaymentMethod-002") || gd.SRPaymentMethod.Equals("PaymentMethod-003"))
                    {
                        EDCMachine edcMachineEntity = new EDCMachine();
                        if (edcMachineEntity.LoadByPrimaryKey(gd.EDCMachineID))
                        {
                            // Setting Account Code Per EDC Machine
                            if (edcMachineEntity.ChartOfAccountID.HasValue)
                            {
                                dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                dSubLedgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);

                                // di-unmark karena GPI payment kartu langsung masuk ke akun bank
                                bankEntity = new Bank();
                                bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == edcMachineEntity.ChartOfAccountID);
                                bankEntity.Query.Load();
                            }
                        }
                    }

                    // Payment Transfer 
                    if (gd.SRPaymentMethod.Equals("PaymentMethod-004"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;
                        }
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(gd.BankID))
                        {
                            if (bankEntity.ChartOfAccountId.HasValue)
                                dAccount = bankEntity.ChartOfAccountId.Value;
                            if (bankEntity.SubledgerId.HasValue)
                                dSubLedgerId = bankEntity.SubledgerId.Value;
                        }
                    }

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = gd.Amount;
                    d.Credit = 0;
                    d.Description = string.Format("GUARANTOR DEPOSIT#:{0}. GUAR#:{1}", gd.TransactionNo, g.GuarantorName);
                    d.DocumentNumber = gd.TransactionNo;
                    d.Save();
                    totalDebit = d.Debit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = 0;
                    c.Credit = gd.Amount;
                    c.Description = string.Format("GUARANTOR DEPOSIT#:{0}. GUAR#:{1}", gd.TransactionNo, g.GuarantorName);
                    c.DocumentNumber = gd.TransactionNo;
                    c.Save();

                    totalCredit = c.Credit.Value;
                }

                if (totalDebit > 0 && bankEntity != null)
                {

                    decimal rate = 0;
                    CurrencyRate currencyRateEntity = new CurrencyRate();

                    if (currencyRateEntity.LoadByPrimaryKey(bankEntity.CurrencyCode))
                    {
                        rate = currencyRateEntity.CurrencyRate.Value;
                    }

                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, dAccount, gd.TransactionDate.Value,
                                                                   "DP", "GUARANTOR DEPOSIT",
                                                                   gd.SRPaymentType, gd.SRPaymentMethod, "D",
                                                                   bankEntity.CurrencyCode, rate, string.Empty, gd.TransactionNo,
                                                                   entity.Description, entity.JournalId.Value,
                                                                   editedBy,
                                                                   cAccount,
                                                                   0,  // Account Payable Amount. Should be in original currency
                                                                   0,//Diskon
                                                                   0,
                                                                   0,
                                                                   0,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }

                    //jurnal auto approved
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    //entity.BeginEdit();
                    //entity.IsPosted = true;
                    //entity.EndEdit();
                    //entity.Save();
                }

                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewClosingVisitDownPaymentJournal(string journalType, ClosingVisiteDownPayment hd, ClosingVisiteDownPaymentItemCollection dts, string prefix, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(hd.PatientID);

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, hd.ClosingDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = hd.ClosingDate;
                    entity.Description = string.Format("CLOSING VISIT DOWN PAYMENT PAT#:{0}.", pEnity.MedicalNo + " - " + pEnity.PatientName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = hd.ClosingNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                foreach (var p in dts)
                {
                    int dAccount = GetCachedAccountFromParam("coa_DownPayment");
                    int cAccount = GetCachedAccountFromParam("coa_ClosingVisitDownPayment");

                    int cSl = 0;
                    var param = new AppParameter();
                    if (param.LoadByPrimaryKey("SubLedgerCodeClosingVisitDownPayment"))
                    {
                        if (!string.IsNullOrEmpty(param.ParameterValue))
                        {
                            var param2 = new AppParameter();
                            param2.LoadByPrimaryKey("SubLedgerGroupIdServiceUnit");
                            var subledgerQ = new SubLedgersQuery();
                            subledgerQ.Where(subledgerQ.GroupId == param2.ParameterValue.ToInt(), subledgerQ.SubLedgerName == param.ParameterValue);
                            var subledger = new SubLedgers();
                            if (subledger.Load(subledgerQ) && subledger != null)
                            {
                                cSl = subledger.SubLedgerId ?? 0;
                            }
                        }
                    }

                    //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = 0;
                    d.Debit = Abs(p.Amount);
                    d.Credit = 0;
                    d.Description = string.Format("PATIENT:{0}.", pEnity.MedicalNo + " - " + pEnity.PatientName);
                    d.DocumentNumber = p.PaymentNo;
                    d.DocumentNumberSequenceNo = string.Empty;

                    d.Save();

                    totalDebit += d.Debit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSl;
                    c.Debit = 0;
                    c.Credit = Abs(p.Amount);
                    c.Description = string.Format("PATIENT:{0}.", pEnity.MedicalNo + " - " + pEnity.PatientName);
                    c.DocumentNumber = p.PaymentNo;
                    c.DocumentNumberSequenceNo = string.Empty;

                    c.Save();

                    totalCredit += c.Credit.Value;

                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        private class dcList
        {
            private List<dc> dcl;
            public dcList()
            {
                dcl = new List<dc>();
            }
            public List<dc> GetList
            {
                get
                {
                    return dcl;
                }
            }
            //public void Add(dc dc) {
            //    var dcs = dcl.Where(x => x.DiscReason.ItemID == dc.DiscReason.ItemID);
            //    if (dcs.Any())
            //    {
            //        var dcf = dcs.First();
            //        dcf.debit += dc.debit;
            //        dcf.credit += dc.credit;
            //    }
            //    else {
            //        dcl.Add(dc);
            //    }
            //}
            public void Add(dc dc)
            {
                var dcs = dcl.Where(x => x.id == dc.id);
                if (dcs.Any())
                {
                    var dcf = dcs.First();
                    dcf.debit += dc.debit;
                    dcf.credit += dc.credit;
                }
                else
                {
                    dcl.Add(dc);
                }
            }
        }
        private class dc
        {
            //public AppStandardReferenceItem DiscReason;
            public string id;
            public string name;
            public decimal debit;
            public decimal credit;
            public int? COAID;
            public int? SLID;
            public dc()
            {
                //DiscReason = null;
                id = string.Empty;
                name = string.Empty;
                debit = 0;
                credit = 0;
                COAID = 0;
                SLID = 0;
            }
        }

        /// <summary>
        /// Jurnal Payment AR, Debet: Kas/Bank satu gepok, Credit: Piutang Guarantor per nomor invoice
        /// </summary>
        /// <param name="ti"></param>
        /// <param name="editedBy"></param>
        /// <param name="journalId"></param>
        /// <returns></returns>
        public static int? AddNewARPaymentJournal2(Invoices ti, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ARPayment;

            //Logger.EnterMethod("AddNewARPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for InvoiceNo={0}", ti.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                string payMethode = ti.SRPaymentMethod;
                string payType = ti.SRPaymentType;

                int cAccountOpr = 0;
                int cSubledgerIdOpr = 0;
                int cAccountIpr = 0;
                int cSubledgerIdIpr = 0;
                string cMsg = "";

                int dAccount = 0;
                int dSubLedgerId = 0;

                Bank bankEntity = null;  // used to create auto CM txn


                Guarantor g = new Guarantor();
                if (!g.LoadByPrimaryKey(ti.GuarantorID))
                    return 0;

                InvoicesItemCollection iiItems = new InvoicesItemCollection();
                iiItems.Query.Where(iiItems.Query.InvoiceNo == ti.InvoiceNo);
                if (!iiItems.Query.Load())
                    return 0;

                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalARPaymentDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        ti.PaymentDate.Value.Date : ti.PaymentApprovedDate.Value.Date;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);
                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AR", jDate);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = jDate;
                    entity.Description = string.Format("INV PAYMENT#:{0} FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName, ti.InvoiceReferenceNo);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = ti.InvoiceNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                var coaColl = new ChartOfAccountsCollection();

                var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);

                Guarantor guarantorEntity = new Guarantor();
                if (guarantorEntity.LoadByPrimaryKey(ti.GuarantorID))
                {
                    var PrmUsingInvoicing = new AppParameter();
                    if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
                    {
                        throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
                    }
                    if (PrmUsingInvoicing.ParameterValue == "Yes")
                    {
                        AppParameter app = new AppParameter();
                        app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                        if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                        {
                            /* 
                             * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                             * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                             * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                             * kalau bingung tanya teguh s
                             */
                            cMsg = "Guarantor " + guarantorEntity.GuarantorName + ": COA (A/R Invoice)";

                            cAccountOpr = guarantorEntity.ChartOfAccountIdTemporary ?? 0;
                            cSubledgerIdOpr = (guarantorEntity.SubledgerIdTemporary ?? 0);
                            cAccountIpr = guarantorEntity.ChartOfAccountIdTemporaryIPR ?? 0;
                            cSubledgerIdIpr = (guarantorEntity.SubledgerIdTemporaryIPR ?? 0);
                        }
                        else
                        {
                            cMsg = "Guarantor " + guarantorEntity.GuarantorName + ": COA (A/R Process)";

                            cAccountOpr = guarantorEntity.ChartOfAccountId ?? 0;
                            cSubledgerIdOpr = (guarantorEntity.SubLedgerId ?? 0);
                            cAccountIpr = guarantorEntity.ChartOfAccountIdIPR ?? 0;
                            cSubledgerIdIpr = (guarantorEntity.SubLedgerIdIPR ?? 0);

                        }
                    }
                    else
                    {
                        cMsg = "Guarantor " + guarantorEntity.GuarantorName + ": COA (A/R Process)";

                        cAccountOpr = guarantorEntity.ChartOfAccountId ?? 0;
                        cSubledgerIdOpr = (guarantorEntity.SubLedgerId ?? 0);
                        cAccountIpr = guarantorEntity.ChartOfAccountIdIPR ?? 0;
                        cSubledgerIdIpr = (guarantorEntity.SubLedgerIdIPR ?? 0);

                    }
                }

                string dMsg = "";
                var pType = new PaymentType();
                pType.LoadByPrimaryKey(ti.SRPaymentType);

                // BT
                PaymentType pt = new PaymentType();
                if (pt.LoadByPrimaryKey(payType))
                {
                    dMsg = string.Format("Payment type {0}", pType.PaymentTypeName);
                    if (pt.ChartOfAccountID.HasValue)
                        dAccount = pt.ChartOfAccountID.Value;
                    if (pt.SubledgerID.HasValue)
                        dSubLedgerId = pt.SubledgerID.Value;
                }

                PaymentMethod pmAll = new PaymentMethod();
                if (pmAll.LoadByPrimaryKey(payType, payMethode))
                {
                    dMsg = string.Format("Payment type {0}: payment method {1}", pType.PaymentTypeName, pmAll.PaymentMethodName);

                    if (pmAll.ChartOfAccountID.HasValue)
                        dAccount = pmAll.ChartOfAccountID.Value;

                    if (pmAll.SubledgerID.HasValue)
                        dSubLedgerId = pmAll.SubledgerID.Value;
                }

                var srDRColl = new AppStandardReferenceItemCollection();
                srDRColl.Query.Where(srDRColl.Query.StandardReferenceID == "DiscountReason");
                srDRColl.LoadAll();

                if (ti.SRPaymentType == "PaymentType-005"/*disc*/)
                {
                    var srDRs = srDRColl.Where(x => x.ItemID.Equals(ti.SRDiscountReason));
                    if (srDRs.Any())
                    {
                        var srDR = srDRs.First();
                        dMsg = string.Format("Discount reason {0}", srDR.ItemName);
                        if (srDR.coaID.HasValue)
                            dAccount = srDR.coaID.Value;
                        if (srDR.subledgerID.HasValue)
                            dSubLedgerId = srDR.subledgerID.Value;
                    }
                }

                // Payment Credit Card || Payment Debit Card 
                if (ti.SRPaymentMethod.Equals("PaymentMethod-002") || ti.SRPaymentMethod.Equals("PaymentMethod-003"))
                {
                    EDCMachine edcMachineEntity = new EDCMachine();
                    if (edcMachineEntity.LoadByPrimaryKey(ti.EDCMachineID))
                    {
                        // Setting Account Code Per EDC Machine
                        if (edcMachineEntity.ChartOfAccountID.HasValue)
                        {
                            dAccount = edcMachineEntity.ChartOfAccountID.Value;
                            dSubLedgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);

                            // di-unmark karena GPI payment kartu langsung masuk ke akun bank
                            bankEntity = new Bank();
                            bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == edcMachineEntity.ChartOfAccountID);
                            bankEntity.Query.Load();
                        }
                    }
                }

                // Payment Transfer 
                if (ti.SRPaymentMethod.Equals("PaymentMethod-004"))
                {
                    bankEntity = new Bank();
                    if (bankEntity.LoadByPrimaryKey(ti.BankID))
                    {
                        if (bankEntity.ChartOfAccountId.HasValue)
                            dAccount = bankEntity.ChartOfAccountId.Value;
                        if (bankEntity.SubledgerId.HasValue)
                            dSubLedgerId = bankEntity.SubledgerId.Value;
                    }
                }
                // -- end if BT

                /*
                 * coa_ReceiveableDiscount ini settingan lama
                 * kalau coa overpayment di guarantor ada isinya maka pakai coa guarantor
                 */
                int coa_discount = GetCachedAccountFromParam("coa_ReceiveableDiscount");
                int sl_discount = 0;
                if ((g.ChartOfAccountIdOverPayment ?? 0) != 0)
                {
                    coa_discount = g.ChartOfAccountIdOverPayment ?? 0;
                    sl_discount = g.SubledgerIdOverPayment ?? 0;
                }
                int coa_discountmin = GetCachedAccountFromParam("coa_ReceiveableDiscount");
                int sl_discountmin = 0;
                if ((g.ChartOfAccountIdOverPaymentMin ?? 0) != 0)
                {
                    coa_discountmin = g.ChartOfAccountIdOverPaymentMin ?? 0;
                    sl_discountmin = g.SubledgerIdOverPaymentMin ?? 0;
                }

                int coa_biaya = GetCachedAccountFromParam("coa_BankCost");

                decimal payAmtOpr = 0;
                decimal payAmtIpr = 0;
                decimal payAmt = 0;
                decimal OtherAmt = 0;
                decimal Bank_Cost = 0;
                decimal VerifyAmt = 0;
                decimal payRounding = 0;

                var grps = iiItems.Select(x => x.InvoiceReferenceNo).Distinct().ToArray();

                #region Debit
                foreach (var p in iiItems)
                {
                    var IsIpr = (p.RegistrationNo ?? "").ToUpper().Contains("REG/IP");

                    payAmtOpr += (IsSplitIprOpr && IsIpr) ? 0 : (p.PaymentAmount ?? 0);
                    payAmtIpr += (IsSplitIprOpr && IsIpr) ? (p.PaymentAmount ?? 0) : 0;
                    OtherAmt += (p.OtherAmount ?? 0);
                    Bank_Cost += (p.BankCost ?? 0);
                    VerifyAmt += (((p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0)) <= (p.VerifyAmount ?? 0)) ?
                        ((p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0)) : (p.VerifyAmount ?? 0);
                }
                payRounding += (ti.RoundingAmount ?? 0);
                payAmt = payAmtOpr + payAmtIpr + payRounding;

                // payment
                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                d.SubLedgerId = dSubLedgerId;
                d.Debit = (payAmt > 0) ? payAmt : 0;
                d.Credit = (payAmt < 0) ? (payAmt * -1) : 0;
                d.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName,
                    ti.InvoiceReferenceNo); // cuma ditampilkan 1 invoice ref biar tidak kepanjangan // string.Join(",",grps)
                d.DocumentNumber = ti.InvoiceNo;
                AddMoreInfo(d, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                    string.Empty, string.Empty, string.Empty);
                d.Save();
                totalDebit += d.Debit.Value;
                totalCredit += d.Credit.Value;

                //diskon
                if ((OtherAmt) != 0)
                {
                    // journal berdasarkan discount reason

                    var discAmount = OtherAmt;

                    // cek excess per transaksi
                    var dcList = new dcList();
                    foreach (var p in iiItems)
                    {
                        if ((p.OtherAmount ?? 0) == 0) continue;
                        if (!string.IsNullOrEmpty(p.SRDiscountReason))
                        {
                            // cek discount reason
                            var srDRs = srDRColl.Where(x => x.ItemID.Equals(p.SRDiscountReason));
                            if (srDRs.Any())
                            {
                                var dr = srDRs.First();
                                if ((dr.coaID ?? 0) > 0)
                                {
                                    var dc = new dc();
                                    dc.id = dr.ItemID;
                                    dc.name = dr.ItemName;
                                    dc.COAID = dr.coaID;
                                    dc.SLID = dr.subledgerID;
                                    dc.debit = ((p.OtherAmount ?? 0) > 0) ? (p.OtherAmount ?? 0) : 0;
                                    dc.credit = ((p.OtherAmount ?? 0) < 0) ? ((p.OtherAmount ?? 0) * -1) : 0;
                                    dcList.Add(dc);
                                }
                            }
                        }
                    }

                    foreach (var dc in dcList.GetList)
                    {
                        // do journal excess payment berdasarkan discount reason (-)
                        JournalTransactionDetails cExDr = new JournalTransactionDetails();
                        cExDr.AddNew();
                        cExDr.JournalId = entity.JournalId;
                        cExDr.ChartOfAccountId = ValidateCOA(dc.COAID, coaColl, "Standard Reference: Discount Reason: " + dc.name);
                        cExDr.SubLedgerId = dc.SLID;
                        cExDr.Debit = ((dc.debit - dc.credit) > 0) ? (dc.debit - dc.credit) : 0;
                        cExDr.Credit = ((dc.debit - dc.credit) < 0) ? ((dc.debit - dc.credit) * -1) : 0;
                        cExDr.Description = string.Format("INV PAYMENT DISCOUNT#:{0}. FOR INV#:{2}. GUAR#:{1}.",
                            ti.InvoiceNo, g.GuarantorName, ti.InvoiceReferenceNo, // cuma ditampilkan 1 invoice ref biar tidak kepanjangan //string.Join(",",grps),
                            ((dc.debit - dc.credit) < 0) ? "EXCESS" : "DISCOUNT");
                        cExDr.DocumentNumber = ti.InvoiceNo;
                        AddMoreInfo(cExDr, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        cExDr.Save();
                        totalDebit += cExDr.Debit.Value;
                        totalCredit += cExDr.Credit.Value;

                        discAmount -= (dc.debit - dc.credit);
                    }

                    if (discAmount != 0)
                    {
                        JournalTransactionDetails e = new JournalTransactionDetails();
                        e.AddNew();
                        e.JournalId = entity.JournalId;
                        e.ChartOfAccountId = ValidateCOA(coa_discountmin, coaColl, "AppParameter: coa_ReceiveableDiscount");
                        e.SubLedgerId = sl_discountmin;// 0;
                        e.Debit = (discAmount > 0) ? discAmount : 0;
                        e.Credit = (discAmount < 0) ? (discAmount * -1) : 0;
                        e.Description = string.Format("INV PAYMENT DISCOUNT#:{0}. FOR INV#:{2}. GUAR#:{1}.",
                            ti.InvoiceNo, g.GuarantorName, ti.InvoiceReferenceNo, // cuma ditampilkan 1 invoice ref biar tidak kepanjangan //string.Join(",", grps),
                            (OtherAmt < 0) ? "EXCESS" : "DISCOUNT");
                        e.DocumentNumber = ti.InvoiceNo;
                        AddMoreInfo(e, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        e.Save();
                        totalDebit += e.Debit.Value;
                        totalCredit += e.Credit.Value;
                    }
                }

                // Subledger Bank Cost (Fajri 2023/09/01)
                var slBankCost = 0;
                var slColl = new SubLedgersCollection();
                slColl.Query.Where(slColl.Query.SubLedgerName == AppParameter.GetParameterValue(AppParameter.ParameterItem.ServiceUnitIDForPaymentReceivedARBankCostSubledger), slColl.Query.GroupId == AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdServiceUnit));
                if (slColl.LoadAll())
                {
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsUsingBankCostSubledgerForPaymentReceivedAR) == "Yes")
                        slBankCost = slColl.First().SubLedgerId ?? 0;
                }

                //biaya bank
                if (Bank_Cost != 0)
                {
                    JournalTransactionDetails f = new JournalTransactionDetails();
                    f.AddNew();
                    f.JournalId = entity.JournalId;
                    f.ChartOfAccountId = ValidateCOA(coa_biaya, coaColl, "AppParameter: coa_BankCost");
                    f.SubLedgerId = slBankCost;
                    f.Debit = (Bank_Cost > 0) ? Bank_Cost : 0;
                    f.Credit = (Bank_Cost < 0) ? (Bank_Cost * -1) : 0;
                    f.Description = string.Format("INV PAYMENT BANK COST#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName,
                        ti.InvoiceReferenceNo); // cuma ditampilkan 1 invoice ref biar tidak kepanjangan //string.Join(",", grps));
                    f.DocumentNumber = ti.InvoiceNo;
                    AddMoreInfo(f, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                        string.Empty, string.Empty, string.Empty);
                    f.Save();
                    totalDebit += f.Debit.Value;
                    totalCredit += f.Credit.Value;
                }
                #endregion

                #region Credit
                foreach (string grp in grps)
                {

                    decimal payAmtC = 0;
                    decimal payAmtCc = 0;
                    decimal OtherAmtC = 0;
                    decimal Bank_CostC = 0;
                    decimal VerifyAmtCOpr = 0;
                    decimal VerifyAmtCIpr = 0;

                    var tiItems = iiItems.Where(x => x.InvoiceReferenceNo == grp);
                    foreach (var p in tiItems)
                    {
                        var IsIpr = (p.RegistrationNo ?? "").ToUpper().Contains("REG/IP");

                        payAmtC += (p.PaymentAmount ?? 0);
                        OtherAmtC += (p.OtherAmount ?? 0);
                        Bank_CostC += (p.BankCost ?? 0);
                        VerifyAmtCOpr += (IsSplitIprOpr && IsIpr) ? 0 : ((((p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0)) <= (p.VerifyAmount ?? 0)) ?
                            ((p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0)) : (p.VerifyAmount ?? 0));
                        VerifyAmtCIpr += (IsSplitIprOpr && IsIpr) ? ((((p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0)) <= (p.VerifyAmount ?? 0)) ?
                            ((p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0)) : (p.VerifyAmount ?? 0)) : 0;
                    }
                    payAmtCc += (ti.RoundingAmount ?? 0);
                    // credit
                    //JournalTransactionDetails c = new JournalTransactionDetails();
                    //c.AddNew();
                    //c.JournalId = entity.JournalId;
                    //c.ChartOfAccountId = cAccount;
                    //c.SubLedgerId = cSubledgerId;
                    //c.Debit = ((payAmt + OtherAmt + Bank_Cost) < 0) ? ((payAmt + OtherAmt + Bank_Cost) * -1) : 0;
                    //c.Credit = ((payAmt + OtherAmt + Bank_Cost) > 0) ? (payAmt + OtherAmt + Bank_Cost) : 0;
                    //c.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName, ti.InvoiceReferenceNo);
                    //c.DocumentNumber = ti.InvoiceNo;
                    //c.Save();
                    //totalCredit += c.Credit.Value;

                    // credit
                    if (VerifyAmtCOpr != 0)
                    {
                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = ValidateCOA(cAccountOpr, coaColl, cMsg + (IsSplitIprOpr ? " - OPR" : ""));
                        c.SubLedgerId = cSubledgerIdOpr;
                        c.Debit = (VerifyAmtCOpr < 0) ? (VerifyAmtCOpr * -1) : 0;
                        c.Credit = (VerifyAmtCOpr > 0) ? (VerifyAmtCOpr) : 0;
                        c.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName, grp);
                        c.DocumentNumber = grp;//ti.InvoiceNo;
                        AddMoreInfo(c, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        c.Save();
                        totalDebit += c.Debit.Value;
                        totalCredit += c.Credit.Value;
                    }
                    if (VerifyAmtCIpr != 0)
                    {
                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = ValidateCOA(cAccountIpr, coaColl, cMsg + (IsSplitIprOpr ? " - OPR" : ""));
                        c.SubLedgerId = cSubledgerIdIpr;
                        c.Debit = (VerifyAmtCIpr < 0) ? (VerifyAmtCIpr * -1) : 0;
                        c.Credit = (VerifyAmtCIpr > 0) ? (VerifyAmtCIpr) : 0;
                        c.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName, grp);
                        c.DocumentNumber = grp;//ti.InvoiceNo;
                        AddMoreInfo(c, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        c.Save();
                        totalDebit += c.Debit.Value;
                        totalCredit += c.Credit.Value;
                    }

                    if ((payAmtC + OtherAmtC + Bank_CostC + payAmtCc) > (VerifyAmtCOpr + VerifyAmtCIpr))
                    {
                        // exccess
                        var exccess = (payAmtC + OtherAmtC + Bank_CostC + payAmtCc) - (VerifyAmtCOpr + VerifyAmtCIpr);

                        ////////////////////
                        // journal berdasarkan discount reason

                        // cek excess per transaksi
                        var dcList = new dcList();
                        foreach (var p in tiItems)
                        {
                            if (!string.IsNullOrEmpty(p.SRDiscountReason))
                            {
                                // cek discount reason
                                var srDRs = srDRColl.Where(x => x.ItemID.Equals(p.SRDiscountReason));
                                if (srDRs.Any())
                                {
                                    var dr = srDRs.First();
                                    if ((dr.coaID ?? 0) > 0)
                                    {
                                        var exccessPerItem = (p.PaymentAmount + p.OtherAmount + p.BankCost) - p.VerifyAmount;
                                        if (exccessPerItem > 0)
                                        {

                                            var dc = new dc();
                                            dc.id = dr.ItemID;
                                            dc.name = dr.ItemName;
                                            dc.COAID = dr.coaID;
                                            dc.SLID = dr.subledgerID;
                                            dc.debit = ((exccessPerItem ?? 0) < 0) ? ((exccessPerItem ?? 0) * -1) : 0;
                                            dc.credit = ((exccessPerItem ?? 0) > 0) ? (exccessPerItem ?? 0) : 0;
                                            dcList.Add(dc);
                                        }
                                    }
                                }
                            }
                        }

                        foreach (var dc in dcList.GetList)
                        {
                            // do journal excess payment
                            JournalTransactionDetails cExDr = new JournalTransactionDetails();
                            cExDr.AddNew();
                            cExDr.JournalId = entity.JournalId;
                            cExDr.ChartOfAccountId = ValidateCOA(dc.COAID, coaColl, "Standard Reference: Discount Reason: " + dc.name);
                            cExDr.SubLedgerId = dc.SLID;
                            cExDr.Debit = ((dc.debit - dc.credit) > 0) ? (dc.debit - dc.credit) : 0;
                            cExDr.Credit = ((dc.debit - dc.credit) < 0) ? ((dc.debit - dc.credit) * -1) : 0;
                            cExDr.Description = string.Format("INV PAYMENT DISCOUNT#:{0}. FOR INV#:{2}. GUAR#:{1}.",
                                ti.InvoiceNo, g.GuarantorName, grp,
                                ((dc.debit - dc.credit) < 0) ? "EXCESS" : "DISCOUNT");
                            cExDr.DocumentNumber = grp;//ti.InvoiceNo;
                            AddMoreInfo(cExDr, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            cExDr.Save();
                            totalDebit += cExDr.Debit.Value;
                            totalCredit += cExDr.Credit.Value;

                            exccess += (dc.debit - dc.credit);
                        }
                        /////////////////////

                        if (exccess != 0)
                        {
                            JournalTransactionDetails c2 = new JournalTransactionDetails();
                            c2.AddNew();
                            c2.JournalId = entity.JournalId;
                            c2.ChartOfAccountId = ValidateCOA(coa_discount, coaColl, "AppParameter: coa_ReceiveableDiscount");//g.ChartOfAccountIdOverPayment ?? 0;
                            c2.SubLedgerId = sl_discount;//g.SubledgerIdOverPayment ?? 0;
                            c2.Debit = (exccess < 0) ? (exccess * -1) : 0;
                            c2.Credit = (exccess > 0) ? (exccess) : 0;
                            c2.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName, grp);
                            c2.DocumentNumber = grp; //ti.InvoiceNo;
                            AddMoreInfo(c2, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            c2.Save();
                            totalDebit += c2.Debit.Value;
                            totalCredit += c2.Credit.Value;
                        }

                    }
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsUsingRoundingPaymentAR) == "Yes" && ti.RoundingAmount < 0)
                    {
                        if ((payAmtC + OtherAmtC + Bank_CostC + payAmtCc) < (VerifyAmtCOpr + VerifyAmtCIpr))
                        {
                            // exccess
                            var exccess = (VerifyAmtCOpr + VerifyAmtCIpr + payAmtCc) - (payAmtC + OtherAmtC + Bank_CostC);

                            ////////////////////
                            // journal berdasarkan discount reason

                            // cek excess per transaksi
                            var dcList = new dcList();
                            foreach (var p in tiItems)
                            {
                                if (!string.IsNullOrEmpty(p.SRDiscountReason))
                                {
                                    // cek discount reason
                                    var srDRs = srDRColl.Where(x => x.ItemID.Equals(p.SRDiscountReason));
                                    if (srDRs.Any())
                                    {
                                        var dr = srDRs.First();
                                        if ((dr.coaID ?? 0) > 0)
                                        {
                                            var exccessPerItem = (p.PaymentAmount + p.OtherAmount + p.BankCost) - p.VerifyAmount;
                                            if (exccessPerItem > 0)
                                            {

                                                var dc = new dc();
                                                dc.id = dr.ItemID;
                                                dc.name = dr.ItemName;
                                                dc.COAID = dr.coaID;
                                                dc.SLID = dr.subledgerID;
                                                dc.debit = ((exccessPerItem ?? 0) < 0) ? ((exccessPerItem ?? 0) * -1) : 0;
                                                dc.credit = ((exccessPerItem ?? 0) > 0) ? (exccessPerItem ?? 0) : 0;
                                                dcList.Add(dc);
                                            }
                                        }
                                    }
                                }
                            }

                            foreach (var dc in dcList.GetList)
                            {
                                // do journal excess payment
                                JournalTransactionDetails cExDr = new JournalTransactionDetails();
                                cExDr.AddNew();
                                cExDr.JournalId = entity.JournalId;
                                cExDr.ChartOfAccountId = ValidateCOA(dc.COAID, coaColl, "Standard Reference: Discount Reason: " + dc.name);
                                cExDr.SubLedgerId = dc.SLID;
                                cExDr.Debit = ((dc.debit - dc.credit) > 0) ? (dc.debit - dc.credit) : 0;
                                cExDr.Credit = ((dc.debit - dc.credit) < 0) ? ((dc.debit - dc.credit) * -1) : 0;
                                cExDr.Description = string.Format("INV PAYMENT DISCOUNT#:{0}. FOR INV#:{2}. GUAR#:{1}.",
                                    ti.InvoiceNo, g.GuarantorName, grp,
                                    ((dc.debit - dc.credit) < 0) ? "EXCESS" : "DISCOUNT");
                                cExDr.DocumentNumber = grp;//ti.InvoiceNo;
                                AddMoreInfo(cExDr, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                                    string.Empty, string.Empty, string.Empty);
                                cExDr.Save();
                                totalDebit += cExDr.Debit.Value;
                                totalCredit += cExDr.Credit.Value;

                                exccess += (dc.debit - dc.credit);
                            }
                            /////////////////////

                            if (exccess < 0)
                            {
                                JournalTransactionDetails c2 = new JournalTransactionDetails();
                                c2.AddNew();
                                c2.JournalId = entity.JournalId;
                                c2.ChartOfAccountId = ValidateCOA(coa_discountmin, coaColl, "AppParameter: coa_ReceiveableDiscount");//g.ChartOfAccountIdOverPayment ?? 0;
                                c2.SubLedgerId = sl_discount;//g.SubledgerIdOverPayment ?? 0;
                                c2.Debit = (exccess < 0) ? (exccess * -1) : 0;
                                c2.Credit = (exccess > 0) ? (exccess) : 0;
                                c2.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName, grp);
                                c2.DocumentNumber = grp; //ti.InvoiceNo;
                                AddMoreInfo(c2, string.Empty, ti.GuarantorID, string.Empty, string.Empty, null,
                                    string.Empty, string.Empty, string.Empty);
                                c2.Save();
                                totalDebit += c2.Debit.Value;
                                totalCredit += c2.Credit.Value;
                            }
                        }
                    }
                }
                #endregion

                if (totalDebit > 0 && bankEntity != null)
                {
                    // prevent duplicate cash entry transaction when reprocessing journal is fired
                    var ceColl = new CashTransactionCollection();
                    ceColl.Query.Where(ceColl.Query.DocumentNumber == ti.InvoiceNo && ceColl.Query.IsVoid != true);
                    if (ceColl.LoadAll())
                    {
                        var ce = ceColl.First();

                        if (ce.IsCleared ?? false)
                        {
                            throw new Exception("Cash transaction already cleared");
                        }

                        CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                        ce = new CashTransaction();
                        if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                        {
                            ce.Void(editedBy);
                        }
                    }


                    decimal rate = 0;
                    CurrencyRate currencyRateEntity = new CurrencyRate();

                    if (currencyRateEntity.LoadByPrimaryKey(bankEntity.CurrencyCode))
                    {
                        rate = currencyRateEntity.CurrencyRate.Value;
                    }

                    var cAcc = cAccountOpr;
                    if ((payAmtIpr != 0) && (cAccountIpr != 0))
                        cAcc = cAccountIpr;

                    int? cashTransactionId;
                    //CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, dAccount, ti.PaymentDate.Value,
                    //                                               "AR", "CUSTPAYMNT",
                    //                                               ti.SRPaymentType, ti.SRPaymentMethod, "D",
                    //                                               bankEntity.CurrencyCode, rate, string.Empty, ti.InvoiceNo,
                    //                                               entity.Description, entity.JournalId.Value,
                    //                                               editedBy,
                    //                                               cAcc,
                    //                                               payAmt,  // Account Payable Amount. Should be in original currency
                    //                                               OtherAmt,//Diskon
                    //                                               coa_discount,
                    //                                               Bank_Cost,
                    //                                               coa_biaya,
                    //                                               dSubLedgerId, out cashTransactionId);
                    CashTransaction.AddNewAutomaticCashTransactionFromJournal(entity, "AR", "CUSTPAYMNT", ti.SRPaymentType, ti.SRPaymentMethod,
                        ti.PaymentDate.Value, editedBy, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                //jurnal auto approved
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewARPaymentJournal2Unapproval(Invoices ti, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Invoice Payment Guarantor
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == ti.InvoiceNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry by journalid
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                if (journalId == 0)
                {
                    ctColl.Query.Where(ctColl.Query.DocumentNumber == jhcoll[0].RefferenceNumber);
                }
                else
                {
                    ctColl.Query.Where(ctColl.Query.JournalId == jhcoll[0].JournalId.Value);
                }

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current payment");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                int? ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "AR", editedBy);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                return ret;
            }
        }

        public static int? AddNewARPaymentJournal(Invoices ti, string editedBy, int journalId)
        {
            return AddNewARPaymentJournal2(ti, editedBy, journalId);

            // gak dipakai lagi
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ARPayment;

            //Logger.EnterMethod("AddNewARPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for InvoiceNo={0}", ti.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal payAmt = 0;
                decimal OtherAmt = 0;
                decimal Bank_Cost = 0;

                string payMethode = ti.SRPaymentMethod;
                string payType = ti.SRPaymentType;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                Bank bankEntity = null;  // used to create auto CM txn


                Guarantor g = new Guarantor();
                if (!g.LoadByPrimaryKey(ti.GuarantorID))
                    return 0;

                InvoicesItemCollection tiItems = new InvoicesItemCollection();
                tiItems.Query.Where(tiItems.Query.InvoiceNo == ti.InvoiceNo);
                if (!tiItems.Query.Load())
                    return 0;


                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AR", ti.InvoiceDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = ti.PaymentDate;
                    entity.Description = string.Format("PAYMENT INV#:{0}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = ti.InvoiceNo;
                }
                entity.Save();

                Guarantor guarantorEntity = new Guarantor();
                if (guarantorEntity.LoadByPrimaryKey(ti.GuarantorID))
                {
                    if (guarantorEntity.ChartOfAccountId.HasValue)
                    {
                        cAccount = guarantorEntity.ChartOfAccountId.Value;
                        cSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                    }
                }


                // Hermawan
                if (ti.SRPaymentType.Equals("PaymentType-002") || ti.SRPaymentType.Equals("PaymentType-008"))
                {
                    // BT
                    PaymentMethod pmAll = new PaymentMethod();
                    if (pmAll.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pmAll.ChartOfAccountID.HasValue)
                            dAccount = pmAll.ChartOfAccountID.Value;

                        if (pmAll.SubledgerID.HasValue)
                            dSubLedgerId = pmAll.SubledgerID.Value;
                    }
                    // -- end if BT

                    // Biaya Plafon RS
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-005"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-008"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;

                            //var bankColl = new BankCollection();
                            //bankColl.Query.Where(bankColl.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankColl.LoadAll();
                            //if (bankColl.Count == 0)
                            //    return 2;

                            //bankEntity = new Bank();
                            //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankEntity.Query.Load();
                        }
                    }

                    // Payment Cash 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-001"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-002"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;

                            //var bankColl = new BankCollection();
                            //bankColl.Query.Where(bankColl.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankColl.LoadAll();
                            //if (bankColl.Count == 0)
                            //    return 2;

                            //bankEntity = new Bank();
                            //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankEntity.Query.Load();
                        }
                    }

                    // Payment Credit Card || Payment Debit Card 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-002") || ti.SRPaymentMethod.Equals("PaymentMethod-003"))
                    {
                        EDCMachine edcMachineEntity = new EDCMachine();
                        if (edcMachineEntity.LoadByPrimaryKey(ti.EDCMachineID))
                        {
                            // Setting Account Code Per EDC Machine
                            if (edcMachineEntity.ChartOfAccountID.HasValue)
                            {
                                dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                dSubLedgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);

                                //bankEntity = new Bank();
                                //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == edcMachineEntity.ChartOfAccountID);
                                //bankEntity.Query.Load();
                            }
                        }
                    }

                    // Payment Transfer 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-004"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;
                        }
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(ti.BankID))
                        {
                            if (bankEntity.ChartOfAccountId.HasValue)
                                dAccount = bankEntity.ChartOfAccountId.Value;
                            if (bankEntity.SubledgerId.HasValue)
                                dSubLedgerId = bankEntity.SubledgerId.Value;
                        }
                    }
                    //Cash AR
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-006"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;

                            //bankEntity = new Bank();
                            //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankEntity.Query.Load();


                        }
                    }
                }

                int coa_discount = GetCachedAccountFromParam("coa_ReceiveableDiscount");
                int coa_biaya = GetCachedAccountFromParam("coa_BankCost");

                foreach (var p in tiItems)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = p.PaymentAmount;
                    d.Credit = 0;
                    d.Description = string.Format("INV#:{0}. GUAR#:{1}. PAY#:{2}.", ti.InvoiceNo, g.GuarantorName, p.PaymentNo);
                    d.DocumentNumber = ti.InvoiceNo;
                    d.Save();
                    totalDebit += d.Debit.Value;
                    payAmt += (p.PaymentAmount ?? 0);


                    //diskon
                    if ((p.OtherAmount ?? 0) > 0)
                    {
                        JournalTransactionDetails e = new JournalTransactionDetails();
                        e.AddNew();
                        e.JournalId = entity.JournalId;
                        e.ChartOfAccountId = coa_discount;
                        e.SubLedgerId = 0;
                        e.Debit = (p.OtherAmount ?? 0);
                        e.Credit = 0;
                        e.Description = string.Format("INV#:{0}. GUAR#:{1}. PAY#:{2}.", ti.InvoiceNo, g.GuarantorName, p.PaymentNo);
                        e.DocumentNumber = ti.InvoiceNo;
                        e.Save();
                        totalDebit += e.Debit.Value;
                        OtherAmt += e.Debit.Value;
                        payAmt += e.Debit.Value;
                    }


                    //biaya bank
                    if ((p.BankCost ?? 0) > 0)
                    {
                        JournalTransactionDetails f = new JournalTransactionDetails();
                        f.AddNew();
                        f.JournalId = entity.JournalId;
                        f.ChartOfAccountId = coa_biaya;
                        f.SubLedgerId = 0;
                        f.Debit = (p.BankCost ?? 0);
                        f.Credit = 0;
                        f.Description = string.Format("INV#:{0}. GUAR#:{1}. PAY#:{2}.", ti.InvoiceNo, g.GuarantorName, p.PaymentNo);
                        f.DocumentNumber = ti.InvoiceNo;
                        f.Save();
                        totalDebit += f.Debit.Value;
                        Bank_Cost += f.Debit.Value;
                        payAmt += f.Debit.Value;
                    }


                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = 0;
                    c.Credit = p.PaymentAmount + (p.OtherAmount ?? 0) + (p.BankCost ?? 0); // p.Amount;
                    c.Description = string.Format("REG#:{0}. PATIENT:{1}.", p.RegistrationNo, p.PatientName);
                    c.DocumentNumber = ti.InvoiceNo;
                    c.Save();

                    totalCredit += c.Credit.Value;

                }

                if (totalDebit > 0 && bankEntity != null)
                {

                    decimal rate = 0;
                    CurrencyRate currencyRateEntity = new CurrencyRate();

                    if (currencyRateEntity.LoadByPrimaryKey(bankEntity.CurrencyCode))
                    {
                        rate = currencyRateEntity.CurrencyRate.Value;
                    }

                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, dAccount, ti.PaymentDate.Value,
                                                                   "AR", "CUSTPAYMNT",
                                                                   ti.SRPaymentType, ti.SRPaymentMethod, "D",
                                                                   bankEntity.CurrencyCode, rate, string.Empty, ti.InvoiceNo,
                                                                   entity.Description, entity.JournalId.Value,
                                                                   editedBy,
                                                                   cAccount,
                                                                   payAmt,  // Account Payable Amount. Should be in original currency
                                                                   OtherAmt,//Diskon
                                                                   coa_discount,
                                                                   Bank_Cost,
                                                                   coa_biaya,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }

                    //jurnal auto approved
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    //entity.BeginEdit();
                    //entity.IsPosted = true;
                    //entity.EndEdit();
                    //entity.Save();
                }

                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewARAddPaymentJournal(Invoices ti, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ARPayment;

            //Logger.EnterMethod("AddNewARPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for InvoiceNo={0}", ti.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal payAmt = 0;

                string payMethode = ti.SRPaymentMethod;
                string payType = ti.SRPaymentType;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                Bank bankEntity = null;  // used to create auto CM txn


                Guarantor g = new Guarantor();
                if (!g.LoadByPrimaryKey(ti.GuarantorID))
                    return 0;

                InvoiceAdjusmentCollection tiItems = new InvoiceAdjusmentCollection();
                tiItems.Query.Where(tiItems.Query.InvoicePaymentNo == ti.InvoiceNo);
                if (!tiItems.Query.Load())
                    return 0;


                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AR", ti.InvoiceDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = ti.PaymentDate;
                entity.Description = string.Format("ADD PAYMENT INV#:{0}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = ti.InvoiceNo;
                entity.Save();

                Guarantor guarantorEntity = new Guarantor();
                if (guarantorEntity.LoadByPrimaryKey(ti.GuarantorID))
                {
                    if (guarantorEntity.ChartOfAccountId.HasValue)
                    {
                        cAccount = guarantorEntity.ChartOfAccountId.Value;
                        cSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                    }
                }


                // Hermawan
                if (ti.SRPaymentType.Equals("PaymentType-002"))
                {
                    // Payment Cash 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-001"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-002"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;

                            var bankColl = new BankCollection();
                            bankColl.Query.Where(bankColl.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            bankColl.LoadAll();
                            if (bankColl.Count == 0)
                                return 2;

                            bankEntity = new Bank();
                            bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            bankEntity.Query.Load();
                        }
                    }

                    // Payment Credit Card || Payment Debit Card 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-002") || ti.SRPaymentMethod.Equals("PaymentMethod-003"))
                    {
                        EDCMachine edcMachineEntity = new EDCMachine();
                        if (edcMachineEntity.LoadByPrimaryKey(ti.EDCMachineID))
                        {
                            // Setting Account Code Per EDC Machine
                            if (edcMachineEntity.ChartOfAccountID.HasValue)
                            {
                                dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                dSubLedgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);

                                // di-unmark karena GPI payment kartu langsung masuk ke akun bank
                                bankEntity = new Bank();
                                bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == edcMachineEntity.ChartOfAccountID);
                                bankEntity.Query.Load();
                            }
                        }
                    }

                    // Payment Transfer 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-004"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;
                        }
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(ti.BankID))
                        {
                            if (bankEntity.ChartOfAccountId.HasValue)
                                dAccount = bankEntity.ChartOfAccountId.Value;
                            if (bankEntity.SubledgerId.HasValue)
                                dSubLedgerId = bankEntity.SubledgerId.Value;
                        }
                    }
                    //Cash AR
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-006"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;

                            bankEntity = new Bank();
                            bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            bankEntity.Query.Load();


                        }
                    }
                }

                foreach (var p in tiItems)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = p.PaymentAmount;
                    d.Credit = 0;
                    d.Description = string.Format("ADD INV#:{0}. GUAR#:{1}. PAY#:{2}.", ti.InvoiceNo, g.GuarantorName, p.TransactionNo);
                    d.DocumentNumber = ti.InvoiceNo;
                    d.Save();
                    totalDebit += d.Debit.Value;
                    payAmt += (p.PaymentAmount ?? 0);


                    //diskon
                    if ((p.OtherCost ?? 0) > 0)
                    {
                        JournalTransactionDetails e = new JournalTransactionDetails();
                        e.AddNew();
                        e.JournalId = entity.JournalId;
                        e.ChartOfAccountId = GetCachedAccountFromParam("coa_ReceiveableDiscount");
                        e.SubLedgerId = 0;
                        e.Debit = (p.OtherCost ?? 0);
                        e.Credit = 0;
                        e.Description = string.Format("ADD INV#:{0}. GUAR#:{1}. PAY#:{2}.", ti.InvoiceNo, g.GuarantorName, p.TransactionNo);
                        e.DocumentNumber = ti.InvoiceNo;
                        e.Save();
                        totalDebit += e.Debit.Value;
                        payAmt += e.Debit.Value;
                    }


                    //biaya bank
                    if ((p.BankCost ?? 0) > 0)
                    {
                        JournalTransactionDetails f = new JournalTransactionDetails();
                        f.AddNew();
                        f.JournalId = entity.JournalId;
                        f.ChartOfAccountId = GetCachedAccountFromParam("coa_BankCost");
                        f.SubLedgerId = 0;
                        f.Debit = (p.BankCost ?? 0);
                        f.Credit = 0;
                        f.Description = string.Format("ADD INV#:{0}. GUAR#:{1}. PAY#:{2}.", ti.InvoiceNo, g.GuarantorName, p.TransactionNo);
                        f.DocumentNumber = ti.InvoiceNo;
                        f.Save();
                        totalDebit += f.Debit.Value;
                        payAmt += f.Debit.Value;
                    }


                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = 0;
                    c.Credit = p.PaymentAmount + (p.OtherCost ?? 0) + (p.BankCost ?? 0); // p.Amount;
                    c.Description = string.Format("GUAR#:{0}. DESC:{1}.", g.GuarantorName, p.Note);
                    c.DocumentNumber = ti.InvoiceNo;
                    c.Save();

                    totalCredit += c.Credit.Value;

                }

                if (totalDebit > 0 && bankEntity != null)
                {

                    decimal rate = 0;
                    CurrencyRate currencyRateEntity = new CurrencyRate();

                    if (currencyRateEntity.LoadByPrimaryKey(bankEntity.CurrencyCode))
                    {
                        rate = currencyRateEntity.CurrencyRate.Value;
                    }

                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, dAccount, ti.PaymentDate.Value,
                                                                   "AR", "CUSTPAYMNT",
                                                                   ti.SRPaymentType, ti.SRPaymentMethod, "D",
                                                                   bankEntity.CurrencyCode, rate, string.Empty, ti.InvoiceNo,
                                                                   entity.Description, entity.JournalId.Value,
                                                                   editedBy,
                                                                   cAccount,
                                                                   payAmt,  // Account Payable Amount. Should be in original currency
                                                                   0, 0, 0, 0,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }

                    //jurnal auto approved
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(entity.JournalId ?? 0, editedBy);

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    //entity.BeginEdit();
                    //entity.IsPosted = true;
                    //entity.EndEdit();
                    //entity.Save();
                }

                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewARJournal(InvoiceAdjusment ti, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.General;


            try
            {
                int dAccount = 0;
                int dSubledgerId = 0;
                int cAccount = 0;
                int cSubledgerId = 0;
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                Guarantor g = new Guarantor();
                if (!g.LoadByPrimaryKey(ti.SupplierGuarantor))
                    return 0;

                AppStandardReferenceItem a = new AppStandardReferenceItem();
                if (!a.LoadByPrimaryKey("AddARReason", ti.Reason))
                    return 0;

                cAccount = a.coaID.HasValue ? a.coaID.Value : 0;
                cSubledgerId = a.subledgerID.HasValue ? a.coaID.Value : 0;


                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AR", ti.TransactionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = ti.TransactionDate;
                entity.Description = string.Format("ADD A/R#:{0}. GUAR#:{1}.", ti.TransactionNo, g.GuarantorName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = ti.TransactionNo;
                entity.Save();

                Guarantor guarantorEntity = new Guarantor();
                if (guarantorEntity.LoadByPrimaryKey(ti.SupplierGuarantor))
                {
                    if (guarantorEntity.ChartOfAccountId.HasValue)
                    {
                        dAccount = guarantorEntity.ChartOfAccountId.Value;
                        dSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                    }
                }

                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = dAccount;
                d.SubLedgerId = dSubledgerId;
                d.Debit = ti.Amount;
                d.Credit = 0;
                d.Description = string.Format("ADD A/R#:{0}. GUAR#:{1}", ti.TransactionNo, g.GuarantorName);
                d.DocumentNumber = ti.TransactionNo;
                d.Save();

                totalDebit += d.Debit.Value;

                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = cAccount;
                c.SubLedgerId = cSubledgerId;
                c.Debit = 0;
                c.Credit = ti.Amount;
                c.Description = string.Format("ADD A/R#:{0}. GUAR#:{1}", ti.TransactionNo, g.GuarantorName);
                c.DocumentNumber = ti.TransactionNo;
                c.Save();

                totalCredit += c.Credit.Value;

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewAPJournal(InvoiceAdjusment e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;
            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AP;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;


                int dAccount = 0;
                int dSubLedgerId = 0;
                int cAccount = 0;
                int cSubledgerId = 0;

                Supplier sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierGuarantor))
                    return 0;

                AppStandardReferenceItem app = new AppStandardReferenceItem();
                if (!app.LoadByPrimaryKey("AddAPReason", e.Reason))
                    return 0;
                dAccount = app.coaID.HasValue ? app.coaID.Value : 0;
                dSubLedgerId = app.subledgerID.HasValue ? app.subledgerID.Value : 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AP", e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("ADD A/P#:{0}. SUP:{1}.", e.TransactionNo, sup.SupplierName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                cAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                cSubledgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                var coaColl = new ChartOfAccountsCollection();

                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, "Master Supplier: Chart Of Account AP");
                c.SubLedgerId = cSubledgerId;
                c.Debit = 0;
                c.Credit = e.Amount;
                c.Description = string.Format("ADD A/P#:{0}. SUP:{1}", e.TransactionNo, sup.SupplierName);
                c.DocumentNumber = e.TransactionNo;
                c.Save();

                totalCredit += c.Credit.Value;

                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, string.Format("AppStandardReference: AddAPReason: {0}", e.Reason));
                d.SubLedgerId = dSubLedgerId;
                d.Debit = e.Amount;
                d.Credit = 0;
                d.Description = string.Format("ADD A/P#:{0}. SUP:{1}", e.TransactionNo, sup.SupplierName);
                d.DocumentNumber = e.TransactionNo;
                d.Save();

                totalDebit += d.Debit.Value;

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }


                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewWriteOffAPJournal(InvoiceSupplier e, InvoiceSupplierItemCollection eItems, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.APPayment;

            try
            {
                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                Supplier sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    throw new Exception("Invalid Supplier");

                dAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                dSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    //// #1 ini reverse journal
                    //if (entity.JournalIdRefference.HasValue)
                    //    return AddNewWriteOffAPJournalUnapproval(journalType, pf, editedBy, journalId);

                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);
                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AP", e.InvoiceDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.InvoiceDate;
                    entity.Description = string.Format("WRITE OFF HUTANG#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.InvoiceNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId ?? 0;

                var coaColl = new ChartOfAccountsCollection();

                AppStandardReferenceItem app = new AppStandardReferenceItem();
                if (!app.LoadByPrimaryKey("APWriteOffReason", e.Reason))
                    throw new Exception("Invalid AP Write Off Reason");
                cAccount = app.coaID.HasValue ? app.coaID.Value : 0;
                cSubledgerId = app.subledgerID.HasValue ? app.subledgerID.Value : 0;

                foreach (var p in eItems)
                {
                    var it = new ItemTransaction();
                    it.LoadByPrimaryKey(p.TransactionNo);
                    decimal? hutang = (p.PaymentAmount) * (it.CurrencyRate ?? 1);

                    var a = new JournalTransactionDetails();
                    a.AddNew();
                    a.JournalId = entity.JournalId;
                    a.ChartOfAccountId = ValidateCOA(dAccount, coaColl, "Supplier: Chart Of Account AP");
                    a.SubLedgerId = dSubLedgerId;
                    a.Debit = hutang;
                    a.Credit = 0;
                    a.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    a.DocumentNumber = e.InvoiceNo;
                    a.Save();
                    totalDebit += a.Debit.Value;

                    var b = new JournalTransactionDetails();
                    b.AddNew();
                    b.JournalId = entity.JournalId;
                    b.ChartOfAccountId = ValidateCOA(cAccount, coaColl, string.Format("StandardRef: APWriteOffReason: {0}", app.ItemName));
                    b.SubLedgerId = cSubledgerId;
                    b.Debit = 0;
                    b.Credit = hutang;
                    b.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    b.DocumentNumber = e.InvoiceNo;
                    b.Save();
                    totalCredit += b.Credit.Value;
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }
                return journalId;

            }

            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? WriteOffARJournal(Invoices ti, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.General;


            try
            {
                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                Guarantor g = new Guarantor();
                if (!g.LoadByPrimaryKey(ti.GuarantorID))
                    return 0;

                InvoicesItemCollection tiItems = new InvoicesItemCollection();
                tiItems.Query.Where(tiItems.Query.InvoiceNo == ti.InvoiceNo);
                if (!tiItems.Query.Load())
                    return 0;

                AppStandardReferenceItem app = new AppStandardReferenceItem();
                if (!app.LoadByPrimaryKey("ARWriteOffReason", ti.Reason))
                    return 0;

                dAccount = app.coaID.HasValue ? app.coaID.Value : 0;
                dSubLedgerId = app.subledgerID.HasValue ? app.subledgerID.Value : 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AR", ti.InvoiceDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = ti.PaymentDate;
                entity.Description = string.Format("WRITE OFF PIUTANG#:{0}. GUAR#:{1}.", ti.InvoiceNo, g.GuarantorName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = ti.InvoiceNo;
                entity.Save();

                Guarantor guarantorEntity = new Guarantor();
                if (guarantorEntity.LoadByPrimaryKey(ti.GuarantorID))
                {
                    if (guarantorEntity.ChartOfAccountId.HasValue)
                    {
                        cAccount = guarantorEntity.ChartOfAccountId.Value;
                        cSubledgerId = (guarantorEntity.SubLedgerId.HasValue ? guarantorEntity.SubLedgerId.Value : 0);
                    }
                }

                foreach (var p in tiItems)
                {
                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = 0;
                    c.Credit = p.PaymentAmount; // p.Amount;
                    c.Description = string.Format("REG#:{0}. PATIENT:{1}.", p.RegistrationNo, p.PatientName);
                    c.DocumentNumber = ti.InvoiceNo;
                    c.Save();

                    totalCredit += c.Credit.Value;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = p.PaymentAmount;
                    d.Credit = 0;
                    d.Description = string.Format("REG#:{0}. PATIENT:{1}.", p.RegistrationNo, p.PatientName);
                    d.DocumentNumber = ti.InvoiceNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }


                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewPhysicianPaymentJournal(string journalType, ParamedicFeePaymentHd pf, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    return 0;

                Bank bankAccount = null;
                bankAccount = new Bank();
                if (!bankAccount.LoadByPrimaryKey(pf.BankID))
                    return 0;

                if (!bankAccount.ChartOfAccountId.HasValue)
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PP", pf.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pf.PaymentDate;
                    entity.Description = string.Format("PAYMENT PHYSC NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pf.PaymentNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int d_account_physc = GetCachedAccountFromParam("coa_PhysicianPayment");
                int dSubLedgerId = 0;

                //Hutang Honor Dokter
                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = d_account_physc;
                d.SubLedgerId = 0;
                d.Debit = pf.PaymentAmount;
                d.Credit = 0;
                d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                d.DocumentNumber = pf.PaymentNo;
                d.Save();

                totalDebit += d.Debit.Value;

                //Bank
                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = bankAccount.ChartOfAccountId;
                c.SubLedgerId = bankAccount.SubledgerId;
                c.Debit = 0;
                c.Credit = pf.PaymentAmount;
                c.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                c.DocumentNumber = pf.PaymentNo;
                c.Save();

                totalCredit += c.Credit.Value;


                if (pf.PaymentAmount > 0 && bankAccount != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankAccount.BankID, bankAccount.ChartOfAccountId, pf.PaymentDate.Value.Date,
                                                                   "PF", "OTHER",
                                                                   "PaymentType-007", pf.PaymentMethodID, "K",
                                                                   bankAccount.CurrencyCode, 1, pf.BankAccountNo, pf.PaymentNo,
                                                                   entity.Description, entity.JournalId.Value,
                                                                   editedBy,
                                                                   d_account_physc,
                                                                   pf.PaymentAmount.Value,  // Account Payable Amount. Should be in original 
                                                                   0, 0, 0, 0,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }

                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewPhysicianPaymentJournalByDischargeDateByPaymentGroup(string journalType, ParamedicFeePaymentGroup pfG, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PP", pfG.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pfG.PaymentDate;
                    entity.Description = string.Format("PAYMENT PHYSC NO#:{0}.", pfG.PaymentGroupNo);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pfG.PaymentGroupNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                decimal totalDebit = 0, totalCredit = 0;
                decimal totalPay = 0;
                var jColl = new JournalTransactionDetailsCollection();

                var pColl = new ParamedicCollection();
                pColl.LoadAll();


                var feePayColl = new ParamedicFeeTransPaymentCollection();

                var pay = new ParamedicFeeTransPaymentQuery("pay");
                var fee = new ParamedicFeeTransChargesItemCompByDischargeDateQuery("fee");
                var verif = new ParamedicFeeVerificationQuery("verif");
                pay.InnerJoin(fee).On(pay.TransactionNo == fee.TransactionNo && pay.SequenceNo == fee.SequenceNo && pay.TariffComponentID == fee.TariffComponentID)
                    .InnerJoin(verif).On(fee.VerificationNo == verif.VerificationNo)
                    .Select(pay, fee.ParamedicID.As("refTo_ParamedicID"))
                    .Where(fee.VerificationNo.IsNotNull(), verif.IsApproved == true);
                pay.Where(pay.PaymentGroupNo == pfG.PaymentGroupNo);
                var isByFeeTransPay = feePayColl.Load(pay);

                // fee by team
                var feeBtColl = new ParamedicFeeTransChargesItemCompByTeamCollection();

                var feeBt = new ParamedicFeeTransChargesItemCompByTeamQuery("feeBt");
                verif = new ParamedicFeeVerificationQuery("verif");
                feeBt.InnerJoin(verif).On(feeBt.VerificationNo == verif.VerificationNo)
                    .Select(feeBt)
                    .Where(feeBt.VerificationNo.IsNotNull(), verif.IsApproved == true);
                feeBt.Where(feeBt.PaymentGroupNo == pfG.PaymentGroupNo);
                feeBtColl.Load(feeBt);

                //if (AppParameter.IsYes(AppParameter.GetParameterValue(AppParameter.ParameterItem.IsFeeCalculateProporsionalOnPayment)))
                if ((pfG.IsDetail ?? 0) == 2)
                {
                    var parIDs = feePayColl.Select(x => x.ParamedicID).Union(
                            feeBtColl.Select(x => x.ParamedicID)
                        ).Distinct();

                    //Hutang Honor Dokter
                    foreach (var p in parIDs)
                    {
                        var par = pColl.Where(x => x.ParamedicID == p).FirstOrDefault();
                        if (par != null)
                        {
                            decimal apAmt = 0;
                            apAmt += feePayColl.Where(x => x.ParamedicID == par.ParamedicID)
                                .Sum(x => (x.Amount ?? 0) /* - pajak*/);

                            apAmt += feeBtColl.Where(x => x.ParamedicID == par.ParamedicID)
                                .Sum(x => (x.FeeAmount ?? 0) /* - pajak*/);

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = ValidateCOA(par.ChartOfAccountIdAPParamedicFee, coaColl, string.Format("Physician: {0}: COA A/P", par.ParamedicName));
                            d.SubLedgerId = par.SubledgerIdAPParamedicFee;
                            d.Debit = apAmt >= 0 ? apAmt : 0;
                            d.Credit = (apAmt < 0 ? (-apAmt) : 0);
                            d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pfG.PaymentGroupNo, par.ParamedicName);
                            d.DocumentNumber = pfG.PaymentGroupNo;
                            AddMoreInfo(d, string.Empty, string.Empty, string.Empty, par.ParamedicID,
                                null, string.Empty, string.Empty, string.Empty);
                            d.Save();

                            jColl.AttachEntity(d);

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else
                        {
                            throw new Exception(string.Format("Missing master paramedic with id {0}", p));
                        }
                    }
                    totalPay = feePayColl.Sum(x => (x.Amount).Value /* - pajak*/);
                    totalPay += feeBtColl.Sum(x => (x.FeeAmount ?? 0));

                    // add dec
                    var addecColl = new ParamedicFeeAddDeducCollection();

                    addecColl.Query.Where(addecColl.Query.PaymentGroupNo == pfG.PaymentGroupNo);
                    if (addecColl.LoadAll())
                    {
                        parIDs = addecColl.Select(x => x.ParamedicID).Distinct();

                        //Hutang Honor Dokter
                        foreach (var p in parIDs)
                        {
                            var par = pColl.Where(x => x.ParamedicID == p).FirstOrDefault();
                            if (par != null)
                            {
                                var apAmt = addecColl.Where(x => x.ParamedicID == par.ParamedicID)
                                    .Sum(x => ((x.SRParamedicFeeAdjustType == "01" ? 1 : -1) * x.Amount) /* - pajak*/);

                                JournalTransactionDetails d = new JournalTransactionDetails();
                                d.AddNew();
                                d.JournalId = entity.JournalId;
                                d.ChartOfAccountId = ValidateCOA(par.ChartOfAccountIdAPParamedicFee, coaColl, string.Format("Physician: {0}: COA A/P", par.ParamedicName));
                                d.SubLedgerId = par.SubledgerIdAPParamedicFee;
                                d.Debit = apAmt >= 0 ? apAmt : 0;
                                d.Credit = (apAmt < 0 ? (-apAmt) : 0);
                                d.Description = string.Format("NO#:{0}. PHYSC#:{1}. Additional/Deduction", pfG.PaymentGroupNo, par.ParamedicName);
                                d.DocumentNumber = pfG.PaymentGroupNo;
                                AddMoreInfo(d, string.Empty, string.Empty, string.Empty, par.ParamedicID,
                                    null, string.Empty, string.Empty, string.Empty);
                                d.Save();

                                jColl.AttachEntity(d);

                                totalDebit += d.Debit.Value;
                                totalCredit += d.Credit.Value;
                            }
                            else
                            {
                                throw new Exception(string.Format("Missing master paramedic with id {0}", p));
                            }
                        }
                        totalPay += addecColl.Sum(x => ((x.SRParamedicFeeAdjustType == "01" ? 1 : -1) * (x.Amount ?? 0)) /* - pajak*/);
                    }

                    int dGuaranteeFee = GetCachedAccountFromParam("coa_GuaranteeFee");
                    var pgDetail = new ParamedicFeePaymentGroupDetailCollection();
                    pgDetail.Query.Where(pgDetail.Query.PaymentGroupNo == pfG.PaymentGroupNo);
                    if (pgDetail.LoadAll())
                    {
                        parIDs = pgDetail.Select(x => x.ParamedicID).Distinct();

                        //Hutang Honor Dokter
                        foreach (var p in parIDs)
                        {
                            var par = pColl.Where(x => x.ParamedicID == p).FirstOrDefault();
                            if (par != null)
                            {
                                var apAmt = pgDetail.Where(x => x.ParamedicID == par.ParamedicID)
                                    .Sum(x => x.AmountGuarantee);

                                if (apAmt != 0)
                                {
                                    JournalTransactionDetails d = new JournalTransactionDetails();
                                    d.AddNew();
                                    d.JournalId = entity.JournalId;
                                    d.ChartOfAccountId = ValidateCOA(dGuaranteeFee, coaColl, "AppParameter: coa_GuaranteeFee");
                                    d.SubLedgerId = par.SubledgerIdAPParamedicFee;
                                    d.Debit = apAmt >= 0 ? apAmt : 0;
                                    d.Credit = (apAmt < 0 ? (-apAmt) : 0);
                                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}. Guarantee Fee", pfG.PaymentGroupNo, par.ParamedicName);
                                    d.DocumentNumber = pfG.PaymentGroupNo;
                                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, par.ParamedicID,
                                        null, string.Empty, string.Empty, string.Empty);
                                    d.Save();

                                    jColl.AttachEntity(d);

                                    totalDebit += d.Debit.Value;
                                    totalCredit += d.Credit.Value;
                                }
                            }
                            else
                            {
                                throw new Exception(string.Format("Missing master paramedic with id {0}", p));
                            }
                        }
                        totalPay += pgDetail.Sum(x => (x.AmountGuarantee ?? 0));
                    }
                }
                else if ((pfG.IsDetail ?? 0) == 1)
                {
                    var feeColl = new ParamedicFeeTransChargesItemCompByDischargeDateCollection();

                    feeColl.Query.Where(feeColl.Query.PaymentGroupNo == pfG.PaymentGroupNo);
                    feeColl.LoadAll();

                    var parIDs = feeColl.Select(x => x.ParamedicID).Distinct();

                    //Hutang Honor Dokter
                    foreach (var p in parIDs)
                    {
                        var par = pColl.Where(x => x.ParamedicID == p).FirstOrDefault();
                        if (par != null)
                        {
                            var apAmt = feeColl.Where(x => x.ParamedicID == par.ParamedicID)
                                .Sum(x => (x.FeeAmountToBePaid ?? x.FeeAmount) /* - pajak*/);

                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = ValidateCOA(par.ChartOfAccountIdAPParamedicFee, coaColl, string.Format("Physician: {0}: COA A/P", par.ParamedicName));
                            d.SubLedgerId = par.SubledgerIdAPParamedicFee;
                            d.Debit = apAmt >= 0 ? apAmt : 0;
                            d.Credit = (apAmt < 0 ? (-apAmt) : 0);
                            d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pfG.PaymentGroupNo, par.ParamedicName);
                            d.DocumentNumber = pfG.PaymentGroupNo;
                            AddMoreInfo(d, string.Empty, string.Empty, string.Empty, par.ParamedicID,
                                null, string.Empty, string.Empty, string.Empty);
                            d.Save();

                            jColl.AttachEntity(d);

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else
                        {
                            throw new Exception(string.Format("Missing master paramedic with id {0}", p));
                        }
                    }

                    totalPay = feeColl.Sum(x => (x.FeeAmountToBePaid ?? x.FeeAmount).Value /* - pajak*/);
                }
                else
                {
                    var pfVerifColl = new ParamedicFeeVerificationCollection();
                    var pfVerifQ = new ParamedicFeeVerificationQuery("a");
                    var pfPayDt = new ParamedicFeePaymentDtQuery("b");
                    var pfPayHd = new ParamedicFeePaymentHdQuery("c");

                    pfVerifQ.InnerJoin(pfPayDt).On(pfVerifQ.VerificationNo == pfPayDt.VerificationNo)
                        .InnerJoin(pfPayHd).On(pfPayDt.PaymentNo == pfPayHd.PaymentNo)
                        .Where(pfPayHd.PaymentGroupNo == pfG.PaymentGroupNo);
                    pfVerifColl.Load(pfVerifQ);

                    var pxColl = new ParamedicCollection();
                    var px = new ParamedicQuery("a");
                    var pfHD = new ParamedicFeePaymentHdQuery("b");
                    px.InnerJoin(pfHD).On(pfHD.ParamedicID == px.ParamedicID)
                        .Where(pfHD.PaymentGroupNo == pfG.PaymentGroupNo);
                    px.es.Distinct = true;
                    pxColl.Load(px);

                    //Hutang Honor Dokter
                    foreach (var p in pxColl)
                    {
                        var apAmt = pfVerifColl.Where(x => x.ParamedicID == p.ParamedicID)
                            .Sum(x => (x.VerificationAmount ?? 0) - (x.TaxAmount ?? 0));

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(p.ChartOfAccountIdAPParamedicFee, coaColl, string.Format("Physician: {0}: COA A/P", p.ParamedicName));
                        d.SubLedgerId = p.SubledgerIdAPParamedicFee;
                        d.Debit = apAmt >= 0 ? apAmt : 0;
                        d.Credit = (apAmt < 0 ? (-apAmt) : 0);
                        d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pfG.PaymentGroupNo, p.ParamedicName);
                        d.DocumentNumber = pfG.PaymentGroupNo;
                        AddMoreInfo(d, string.Empty, string.Empty, string.Empty, p.ParamedicID,
                            null, string.Empty, string.Empty, string.Empty);
                        d.Save();

                        jColl.AttachEntity(d);

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                    }

                    totalPay = pfVerifColl.Sum(x => (x.VerificationAmount ?? 0) - (x.TaxAmount ?? 0));
                }

                int creditCOA = 0;
                int creditSL = 0;
                Bank bankAccount = null;
                //Bank
                if (!string.IsNullOrEmpty(pfG.BankID))
                {
                    bankAccount = new Bank();
                    if (!bankAccount.LoadByPrimaryKey(pfG.BankID))
                    {
                        throw new Exception("Invalid Bank Account");
                    }
                    creditCOA = bankAccount.ChartOfAccountId.Value;
                    creditSL = bankAccount.SubledgerId.Value;
                    ValidateCOA(bankAccount.ChartOfAccountId, coaColl, string.Format("Cash & Bank: {0}", bankAccount.BankName));
                }
                else
                {
                    var pm = new PaymentMethod();
                    pm.Query.Where(pm.Query.SRPaymentMethodID == pfG.PaymentMethodID,
                        pm.Query.SRPaymentTypeID == "PaymentType-007");
                    if (pm.Load(pm.Query))
                    {
                        creditCOA = pm.ChartOfAccountID.Value;
                        creditSL = pm.SubledgerID.Value;
                        ValidateCOA(creditCOA, coaColl, string.Format("Payment Method: {0}", pm.PaymentMethodName));
                    }
                    else
                    {
                        throw new Exception("Invalid payment method");
                    }
                }

                totalPay = totalPay - pfG.TaxOnPaymentAmount.Value;

                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = creditCOA;
                c.SubLedgerId = creditSL;
                c.Debit = totalPay < 0 ? -totalPay : 0;
                c.Credit = totalPay >= 0 ? totalPay : 0;
                c.Description = string.Format("NO#:{0}.", pfG.PaymentGroupNo);
                c.DocumentNumber = pfG.PaymentGroupNo;
                AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                c.Save();

                totalDebit += c.Debit.Value;
                totalCredit += c.Credit.Value;

                if (pfG.TaxOnPaymentAmount.Value != 0)
                {
                    var taxFee = new ParamedicFeeTaxCalculationCollection();
                    var taxFeeBt = new ParamedicFeeTaxCalculationCollection();
                    var taxAddDec = new ParamedicFeeTaxCalculationCollection();
                    var taxq = new ParamedicFeeTaxCalculationQuery("taxq");
                    if (isByFeeTransPay)
                    {
                        taxq.Where(taxq.PaymentGroupNo == pfG.PaymentGroupNo);
                        //if (journalId == 0) taxq.Where(tax.Query.JournalID.IsNull());
                        //else taxq.Where(taxq.JournalID == journalId);
                        taxFee.Load(taxq);
                    }
                    else
                    {
                        var feeq = new ParamedicFeeTransChargesItemCompByDischargeDateQuery("feeq");
                        taxq.InnerJoin(feeq).On(taxq.TransactionNo == feeq.TransactionNo &&
                            taxq.SequenceNo == feeq.SequenceNo && taxq.TariffComponentID == feeq.TariffComponentID)
                            .Where(feeq.PaymentGroupNo == pfG.PaymentGroupNo);
                        //if (journalId == 0) taxq.Where(tax.Query.JournalID.IsNull());
                        //else taxq.Where(taxq.JournalID == journalId);
                        taxFee.Load(taxq);

                        var feeBtq = new ParamedicFeeTransChargesItemCompByTeamQuery("feeBtq");
                        taxq = new ParamedicFeeTaxCalculationQuery("taxq");
                        taxq.InnerJoin(feeBtq).On(taxq.TransactionNo == feeBtq.TransactionNo &&
                            taxq.SequenceNo == feeBtq.SequenceNo && taxq.TariffComponentID == feeBtq.TariffComponentID &&
                            taxq.ParamedicID == feeBtq.ParamedicID)
                            .Where(feeBtq.PaymentGroupNo == pfG.PaymentGroupNo);
                        //if (journalId == 0) taxq.Where(tax.Query.JournalID.IsNull());
                        //else taxq.Where(taxq.JournalID == journalId);
                        taxFeeBt.Load(taxq);

                        var feeAD = new ParamedicFeeAddDeducQuery("feeAD");
                        taxq = new ParamedicFeeTaxCalculationQuery("taxq");
                        taxq.InnerJoin(feeAD).On(taxq.TransactionNo == feeAD.TransactionNo &&
                            /*taxq.SequenceNo == feeAD.SequenceNo &&*/ taxq.TariffComponentID == feeAD.TariffComponentID)
                            .Where(feeAD.PaymentGroupNo == pfG.PaymentGroupNo);
                        taxAddDec.Load(taxq);
                    }

                    var stdPphColl = new AppStandardReferenceItemCollection();
                    stdPphColl.LoadByStandardReferenceID("PphType");

                    var jTaxColl = (taxFee.Union(taxFeeBt).Union(taxAddDec)).GroupBy(j => new { j.ParamedicID, j.SRPphType })
                        .Select(s => new
                        {
                            ParamedicID = s.Key.ParamedicID,
                            SRPphType = s.Key.SRPphType,
                            TaxAmount = s.Sum(t => t.TaxAmount.Value)
                        });

                    foreach (var jTax in jTaxColl)
                    {
                        var par = pColl.Where(p => p.ParamedicID == jTax.ParamedicID).First();
                        var coaTax = 0;
                        var stdCoaTax = stdPphColl.Where(w => w.ItemID == jTax.SRPphType).First();
                        if ((stdCoaTax.coaID ?? 0) != 0)
                        {
                            coaTax = ValidateCOA(stdCoaTax.coaID, coaColl, string.Format("AppStandardReference: PphType {0}: Invalid Chart Of Account", stdCoaTax.ItemID));
                        }
                        else
                        {
                            coaTax = GetCachedAccountFromParam(stdCoaTax.ReferenceID);
                            coaTax = ValidateCOA(coaTax, coaColl, string.Format("AppParameter: {0}: Invalid Chart Of Account", stdCoaTax.ReferenceID));
                        }
                        JournalTransactionDetails cTax = new JournalTransactionDetails();
                        cTax.AddNew();
                        cTax.JournalId = entity.JournalId;
                        cTax.ChartOfAccountId = coaTax;
                        cTax.SubLedgerId = 0;
                        cTax.Debit = jTax.TaxAmount < 0 ? -jTax.TaxAmount : 0;
                        cTax.Credit = jTax.TaxAmount >= 0 ? jTax.TaxAmount : 0;
                        cTax.Description = string.Format("NO#:{0}. PHYSC#:{1}. Tax", pfG.PaymentGroupNo, par.ParamedicName);
                        cTax.DocumentNumber = pfG.PaymentGroupNo;
                        AddMoreInfo(cTax, string.Empty, string.Empty, string.Empty, jTax.ParamedicID,
                                null, string.Empty, string.Empty, string.Empty);
                        cTax.Save();

                        jColl.AttachEntity(cTax);

                        totalDebit += cTax.Debit.Value;
                        totalCredit += cTax.Credit.Value;
                    }
                }

                if (bankAccount != null)
                {
                    // prevent duplicate cash entry transaction when reprocessing journal is fired
                    var ceColl = new CashTransactionCollection();
                    ceColl.Query.Where(ceColl.Query.DocumentNumber == pfG.PaymentGroupNo && ceColl.Query.IsVoid != true);
                    if (ceColl.LoadAll())
                    {
                        var ce = ceColl.First();

                        if (ce.IsCleared ?? false)
                        {
                            throw new Exception("Cash transaction already cleared");
                        }

                        CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                        ce = new CashTransaction();
                        if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                        {
                            ce.Void(editedBy);
                        }
                    }

                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransactionForParamedicFeePaymentGroup(bankAccount, pfG.PaymentDate.Value.Date,
                                                                    "PFG", "OTHER", "PaymentType-007", pfG.PaymentMethodID, "K",
                                                                    1, string.Empty, pfG.PaymentGroupNo,
                                                                    entity.Description, entity.JournalId.Value,
                                                                    editedBy, jColl, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                return entity.JournalId;
            }

            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewPhysicianPaymentJournalByDischargeDateByPaymentGroupUnapproval(string journalType, ParamedicFeePaymentGroup pfG, string editedBy, int journalId)
        {
            //throw new Exception("Not Yet Implemented");

            //Function ini digunakan untuk transaksi Void Payment Jasmed
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == pfG.PaymentGroupNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    //ctColl.Query.JournalId == jhcoll[0].JournalId.Value,
                    ctColl.Query.DocumentNumber == jhcoll[0].RefferenceNumber,
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current payment");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                int? ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "PP", editedBy);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                return ret;
            }
        }

        public static int? AddNewPhysicianPaymentJournalByDischargeDate(
            string journalType, ParamedicFeePaymentHd pf, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PP", pf.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pf.PaymentDate;
                    entity.Description = string.Format("PAYMENT PHYSC NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, "Unknown");
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pf.PaymentNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    throw new Exception(string.Format("Paramedic with id {0} not found", pf.ParamedicID));

                Bank bankAccount = null;
                bankAccount = new Bank();
                if (!bankAccount.LoadByPrimaryKey(pf.BankID))
                    throw new Exception(string.Format("Bank with id {0} not found", pf.BankID));

                entity.Description = string.Format("PAYMENT PHYSC NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                entity.Save();

                var coaColl = new ChartOfAccountsCollection();

                decimal totalDebit = 0, totalCredit = 0;

                var pfVerifColl = new ParamedicFeeVerificationCollection();
                var pfVerifQ = new ParamedicFeeVerificationQuery("a");
                var pfPayDt = new ParamedicFeePaymentDtQuery("b");
                pfVerifQ.InnerJoin(pfPayDt).On(pfVerifQ.VerificationNo == pfPayDt.VerificationNo)
                    .Where(pfPayDt.PaymentNo == pf.PaymentNo);
                pfVerifColl.Load(pfVerifQ);

                //Hutang Honor Dokter
                foreach (var pfdt in pfVerifColl)
                {
                    var apAmt = pfdt.VerificationAmount - pfdt.TaxAmount;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(p.ChartOfAccountIdAPParamedicFee, coaColl, string.Format("Physician: {0}: COA A/P", p.ParamedicName));
                    d.SubLedgerId = p.SubledgerIdAPParamedicFee;
                    d.Debit = apAmt >= 0 ? apAmt : 0;
                    d.Credit = (apAmt < 0 ? (-apAmt) : 0);
                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                    d.DocumentNumber = pf.PaymentNo;
                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, pfdt.ParamedicID,
                        null, string.Empty, string.Empty, string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }

                //Bank
                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = ValidateCOA(bankAccount.ChartOfAccountId, coaColl, string.Format("Cash & Bank: {0}", bankAccount.BankName));
                c.SubLedgerId = bankAccount.SubledgerId;
                c.Debit = pf.PaymentAmount < 0 ? -pf.PaymentAmount : 0;
                c.Credit = pf.PaymentAmount >= 0 ? pf.PaymentAmount : 0;
                c.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                c.DocumentNumber = pf.PaymentNo;
                AddMoreInfo(c, string.Empty, string.Empty, string.Empty, pf.ParamedicID,
                        null, string.Empty, string.Empty, string.Empty);
                c.Save();

                totalDebit += c.Debit.Value;
                totalCredit += c.Credit.Value;


                if (pf.PaymentAmount > 0 && bankAccount != null)
                {
                    // prevent duplicate cash entry transaction when reprocessing journal is fired
                    var ceColl = new CashTransactionCollection();
                    ceColl.Query.Where(ceColl.Query.DocumentNumber == pf.PaymentNo && ceColl.Query.IsVoid != true);
                    ceColl.LoadAll();
                    if (ceColl.Count == 0)
                    {
                        // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                        int? cashTransactionId;
                        CashTransaction.AddNewAutomaticCashTransaction(bankAccount.BankID, bankAccount.ChartOfAccountId, pf.PaymentDate.Value.Date,
                                                                       "PF", "OTHER",
                                                                       "PaymentType-007", pf.PaymentMethodID, "K",
                                                                       bankAccount.CurrencyCode, 1, pf.BankAccountNo, pf.PaymentNo,
                                                                       entity.Description, entity.JournalId.Value,
                                                                       editedBy,
                                                                       p.ChartOfAccountIdAPParamedicFee ?? 0,
                                                                       pf.PaymentAmount.Value,  // Account Payable Amount. Should be in original currency
                                                                       0, 0, 0, 0,
                                                                       p.SubledgerIdAPParamedicFee ?? 0, out cashTransactionId);

                        // otomatis posting
                        if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                        {
                            CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                        }
                    }

                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewPhysicianPaymentJournalByDischargeDateUnapproval(string journalType, ParamedicFeePaymentHd pf, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Unapproval Payment jasa medis by discharge date

            throw new Exception("Belum bisa dipakai karena harus batalin cash entry!!!");

            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == pf.PaymentNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                var id = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "PP", editedBy, DateTime.Now.Date, "Unapproval");

                return id;
            }
        }

        public static int? AddNewPhysicianPaymentJournal2(string journalType, ParamedicFeePaymentHd pf, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var p = new Paramedic();
                if (!p.LoadByPrimaryKey(pf.ParamedicID))
                    return 0;

                Bank bankAccount = null;
                bankAccount = new Bank();
                if (!bankAccount.LoadByPrimaryKey(pf.BankID))
                    return 0;

                if (!bankAccount.ChartOfAccountId.HasValue)
                    return 0;

                ParamedicFeeTransChargesItemCompSettledCollection eItems = new ParamedicFeeTransChargesItemCompSettledCollection();
                ParamedicFeeTransChargesItemCompSettledQuery eItemQuery = new ParamedicFeeTransChargesItemCompSettledQuery("e");
                ParamedicFeePaymentDtQuery dt = new ParamedicFeePaymentDtQuery("g");
                ParamedicFeePaymentHdQuery hd = new ParamedicFeePaymentHdQuery("h");
                //ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery);
                eItemQuery.InnerJoin(dt).On(eItemQuery.VerificationNo == dt.VerificationNo);
                eItemQuery.InnerJoin(hd).On(hd.PaymentNo == dt.PaymentNo);
                eItemQuery.Where(hd.PaymentNo == pf.PaymentNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                decimal totalPrice = 0; // non referal
                decimal totalPriceRef = 0; //referal

                foreach (var z in eItems)
                {
                    if (z.IsRefferal == false)
                        totalPrice += z.FeeAmount.Value;
                    else
                        totalPriceRef += z.FeeAmount.Value;
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PP", pf.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = pf.PaymentDate;
                    entity.Description = string.Format("PAYMENT PHYSC NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = pf.PaymentNo;
                }
                entity.Save();

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int d_account_physc = GetCachedAccountFromParam("coa_PhysicianPayment");
                int dSubLedgerId = 0;
                int d_account_physc_ref = GetCachedAccountFromParam("coa_PhysicianPaymentRef");
                int dSubLedgerId_ref = 0;

                //Hutang Honor Dokter
                if (totalPrice > 0)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = d_account_physc;
                    d.SubLedgerId = 0;
                    d.Debit = totalPrice;
                    d.Credit = 0;
                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                    d.DocumentNumber = pf.PaymentNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }

                if (totalPriceRef > 0)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = d_account_physc_ref;
                    d.SubLedgerId = 0;
                    d.Debit = totalPriceRef;
                    d.Credit = 0;
                    d.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                    d.DocumentNumber = pf.PaymentNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                }


                //Bank
                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = bankAccount.ChartOfAccountId;
                c.SubLedgerId = bankAccount.SubledgerId;
                c.Debit = 0;
                c.Credit = pf.PaymentAmount;
                c.Description = string.Format("NO#:{0}. PHYSC#:{1}.", pf.PaymentNo, p.ParamedicName);
                c.DocumentNumber = pf.PaymentNo;
                c.Save();

                totalCredit += c.Credit.Value;


                if (pf.PaymentAmount > 0 && bankAccount != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankAccount.BankID, bankAccount.ChartOfAccountId, pf.PaymentDate.Value.Date,
                                                                   "PF", "OTHER",
                                                                   "PaymentType-007", pf.PaymentMethodID, "K",
                                                                   bankAccount.CurrencyCode, 1, pf.BankAccountNo, pf.PaymentNo,
                                                                   entity.Description, entity.JournalId.Value,
                                                                   editedBy,
                                                                   d_account_physc,
                                                                   pf.PaymentAmount.Value,  // Account Payable Amount. Should be in original currency
                                                                   0, 0, 0, 0,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId.HasValue && entity.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId.Value);
                    }

                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewGrantReceivedJournal(ItemTransaction e, string editedBy, int journalId)
        {
            string journalType = Temiang.Avicenna.BusinessObject.JournalType.GrantReceive;
            return AddNewPurchaseOrderOrGrantReceivedJournal(e, editedBy, journalId, journalType, "GR");
        }

        public static int? AddNewPurchaseOrderReceivedJournal(ItemTransaction e, string editedBy, int journalId)
        {
            string journalType = Temiang.Avicenna.BusinessObject.JournalType.PurchaseOrderReceived;
            return AddNewPurchaseOrderOrGrantReceivedJournal(e, editedBy, journalId, journalType, "PO");
        }
        private static int? AddNewPurchaseOrderOrGrantReceivedJournal(ItemTransaction e, string editedBy, int journalId, string journalType,
            string journalCodePrefix)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            if (e.SRPurchaseOrderType == "CS" && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalCashPOReceived) == "No")
                return 0;

            ServiceUnit toServiceUnit = new ServiceUnit();
            var svcID = (!(e.IsInventoryItem ?? false) || (e.IsNonMasterOrder ?? false)) ?
                (string.IsNullOrEmpty(e.ServiceUnitCostID) ? e.ToServiceUnitID : e.ServiceUnitCostID) : e.ToServiceUnitID;
            if (!toServiceUnit.LoadByPrimaryKey(svcID))
                return 0;

            var nopr = string.Empty;
            var po = new ItemTransaction();
            if (po.LoadByPrimaryKey(e.ReferenceNo))
                nopr = po.ReferenceNo;

            try
            {

                //
                // Requirement:
                //
                // INVENTORY (D)
                // VAT IN (D)
                // PURCHASE DISCOUNT (C)
                // ACCOUNT PAYABLE (C)
                // VAT PPH 22/23 (C)

                // -- ASSET JOURNAL --
                //
                // ASSET (D)
                // VAT IN (D)
                // PURCHASE DISCOUNT (C)
                // ACCOUNT PAYABLE (C)
                // VAT PPH 22/23 (C)

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int dInventoryCoaId = 0;
                int dInventorySubLedgerId = 0;

                bool IsPpnJournaled = false;
                if (e.SRItemType == "11")
                {
                    IsPpnJournaled = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsPpnPurchasing);
                }
                else
                {
                    IsPpnJournaled = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsPpnPurchasingNonMedical);
                }

                bool IsAssetsJournaled = false; //AppParameter.IsYes(AppParameter.ParameterItem.acc_IsJournalAssets) && (e.IsAssets ?? false);

                int dVatInCoaId = GetCachedAccountFromParam("coa_Ppn");
                /* mungkin gak untuk rsui ditambahkan parameter coa_PpnBahanMedis, 
                 * digunakannya untuk Item Group tertentu 
                 * int dVatInCoaIdBahanMedis = GetCachedAccountFromParam("coa_PpnBahanMedis");*/
                int dVatInCoaIdNonMedic = GetCachedAccountFromParam("coa_PpnNonMedic");

                int dVatPPh22CoaId = GetCachedAccountFromParam("coa_Pph22");
                int dVatPPh23CoaId = GetCachedAccountFromParam("coa_Pph23");
                int cAccountPayableCoaId = 0;
                int cAccountPayableSubLedgerId = 0;
                int cAccountPayableCoaIdNM = 0;
                int cAccountPayableSubLedgerIdNM = 0;
                int cAccountCash = GetCachedAccountFromParam("coa_PurchaseCash");

                var IsApNMSeparated = false;
                var PrmApNMSeparated = new AppParameter();
                if (PrmApNMSeparated.LoadByPrimaryKey("IsCoaAPNonMedicSeparated"))
                {
                    IsApNMSeparated = (PrmApNMSeparated.ParameterValue == "Yes");
                }

                //Discount mengurangi persediaan sesuai product account-nya, jd ambil COA dr persediaan saja, kalo pakai appparameter jd hanya bisa utk 1 product account saja
                int cDiscountCoaId = GetCachedAccountFromParam("coa_PurchaseDiscount");

                var eItems = new ItemTransactionItemCollection();
                var eItemQuery = new ItemTransactionItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"),
                    itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var supplierName = string.Empty;
                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
                    return 0;

                string suPayableMsg = string.Empty;

                supplierName = sup.SupplierName;
                if (Temiang.Avicenna.BusinessObject.JournalType.GrantReceive == journalType)
                {
                    if (sup.ChartOfAccountIdGrantReceive.HasValue)
                    {
                        cAccountPayableCoaId = sup.ChartOfAccountIdGrantReceive ?? 0;
                        cAccountPayableSubLedgerId = sup.SubledgerIdGrantReceive ?? 0;
                        cAccountPayableCoaIdNM = sup.ChartOfAccountIdGrantReceiveNmed ?? 0;
                        cAccountPayableSubLedgerIdNM = sup.SubledgerIdGrantReceiveNmed ?? 0;
                    }
                    suPayableMsg = "Chart Of Account Grant Receive";

                    suPayableMsg = string.Format("Supplier {0}: {1}", supplierName, suPayableMsg);
                }
                else
                {
                    if (sup.ChartOfAccountIdAP.HasValue)
                    {
                        var PrmApUsingInvoicing = new AppParameter();
                        if (!PrmApUsingInvoicing.LoadByPrimaryKey("acc_IsJournalApUsingInvoicing"))
                        {
                            throw new Exception("Parameter acc_IsJournalApUsingInvoicing not yet configured!");
                        }

                        if (PrmApUsingInvoicing.ParameterValue == "Yes")
                        {
                            cAccountPayableCoaId = sup.ChartOfAccountIdAPTemporary.HasValue ? sup.ChartOfAccountIdAPTemporary.Value : 0;
                            cAccountPayableSubLedgerId = sup.SubledgerIdAPTemporary.HasValue ? sup.SubledgerIdAPTemporary.Value : 0;

                            cAccountPayableCoaIdNM = sup.ChartOfAccountIdAPTemporaryNonMedic.HasValue ? sup.ChartOfAccountIdAPTemporaryNonMedic.Value : 0;
                            cAccountPayableSubLedgerIdNM = sup.SubledgerIdAPTemporaryNonMedic.HasValue ? sup.SubledgerIdAPTemporaryNonMedic.Value : 0;


                            suPayableMsg = "A/P Temporary";
                        }
                        else
                        {
                            cAccountPayableCoaId = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                            cAccountPayableSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                            cAccountPayableCoaIdNM = sup.ChartOfAccountIdAPNonMedic.HasValue ? sup.ChartOfAccountIdAPNonMedic.Value : 0;
                            cAccountPayableSubLedgerIdNM = sup.SubledgerIdAPNonMedic.HasValue ? sup.SubledgerIdAPNonMedic.Value : 0;

                            suPayableMsg = "Chart Of Account A/P";
                        }
                        suPayableMsg = string.Format("Supplier {0}: {1}", supplierName, suPayableMsg);
                    }
                }


                // code ini diremark karena kalau belum disetting sama sekali gak jadi jurnal
                // jadi biarin saja error kyk jurnal yang lainnya supaya jadi dulu header jurnalnya.
                //if (cAccountPayableCoaId == 0)
                //    return 0;

                //Journal Header
                DateTime jDate = (new DateTime()).NowAtSqlServer();
                jDate = AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_JournalPORDate).Equals("0") ?
                    e.TransactionDate.Value.Date : e.ApprovedDate.Value.Date;

                var journalCode = JournalCodes.GetOrCreateAutoJournalCode(journalCodePrefix, jDate);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);
                var invNo = e.InvoiceNo ?? "-";

                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //header.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = jDate;
                    header.Description = string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = e.TransactionNo;

                    header.Save();
                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                var coaColl = new ChartOfAccountsCollection();

                decimal payableAmount = 0;
                bool isMedic = e.SRItemType == "11";
                //decimal discountAmount = 0;
                decimal discTotal = 0;

                string paMsg = string.Empty;

                //-------------------------------------------------------------------------------
                // INVENTORY (D) OR EXPENSE for Non Inventory Item
                //-------------------------------------------------------------------------------
                foreach (var p in eItems)
                {
                    decimal amount;
                    //var dAmt = (p.Quantity.Value * p.PriceInCurrency.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.PriceInCurrency.Value));

                    var itemId = p.ItemID;
                    var itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    itemInv.Query.Load();

                    var iMed = new ItemProductMedic();
                    var iNonMed = new ItemProductNonMedic();
                    var iKitc = new ItemKitchen();
                    var isInventory = true;
                    var isAsset = itemInv.IsAsset ?? (e.IsAssets ?? false);

                    IsAssetsJournaled = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsJournalAssets) && isAsset;

                    switch (itemInv.SRItemType)
                    {
                        case "11":
                            {
                                iMed.LoadByPrimaryKey(p.ItemID);
                                isInventory = iMed.IsInventoryItem ?? false;
                                break;
                            }
                        case "21":
                            {
                                iNonMed.LoadByPrimaryKey(p.ItemID);
                                isInventory = iNonMed.IsInventoryItem ?? false;
                                break;
                            }
                        case "81":
                            {
                                iKitc.LoadByPrimaryKey(p.ItemID);
                                isInventory = iKitc.IsInventoryItem ?? false;
                                break;
                            }
                    }

                    decimal PriceInCurrency = p.PriceInCurrency.Value;
                    if (IsAssetsJournaled)
                    {
                        // cek amount netto (price-diskon+ppn)
                        // amount di sini per 1 qty, bukan gelondongan
                        //amount = (p.Quantity.Value * (p.PriceInCurrency.Value - p.DiscountInCurrency.Value)) + (e.TaxPercentage.Value / 100 * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.Discount.Value)));
                        amount = (p.PriceInCurrency.Value - p.DiscountInCurrency.Value) * (1 + (e.TaxPercentage.Value / 100));

                        // jika amount >= nominal perhitungan penyusutan --> jurnal asset, else jurnal persediaan / biaya
                        IsAssetsJournaled = (amount >= Convert.ToDecimal(AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_JournalAssetsAmount)));

                        // jika asset, harga netto sudah dikurangin diskon
                        if (IsAssetsJournaled)
                            PriceInCurrency -= p.DiscountInCurrency.Value;
                    }

                    if (itemInv.SRItemType == "11")
                    {
                        if (!IsPpnJournaled)
                            amount = (p.Quantity.Value * PriceInCurrency) + (e.TaxPercentage.Value / 100 * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.Discount.Value)));
                        else
                            amount = (p.Quantity.Value * PriceInCurrency);
                    }
                    else
                    {
                        if (!IsPpnJournaled)
                            amount = (p.Quantity.Value * PriceInCurrency) + (e.TaxPercentage.Value / 100 * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.Discount.Value)));
                        else
                            amount = (p.Quantity.Value * PriceInCurrency);
                    }

                    if ((e.IsNonMasterOrder ?? false ? e.ProductAccountID : itemInv.ProductAccountID) == null)
                        throw new Exception(string.Format("Item {0}: invalid product account", (e.IsNonMasterOrder ?? false ? p.ItemName : itemInv.ItemName)));


                    if (!IsAssetsJournaled)
                    {
                        var pac = new ProductAccount();
                        if (pac.LoadByPrimaryKey((e.IsNonMasterOrder ?? false ? e.ProductAccountID : itemInv.ProductAccountID)))
                        {
                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == pac.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                            if (proacc.Load(proacc.Query))
                            {

                                //TODO: Find COA purchase discount from Product Account
                                dInventoryCoaId = toServiceUnit.SRRegistrationType == "IPR" ? (proacc.ChartOfAccountIdInventoryIP ?? 0) : (proacc.ChartOfAccountIdInventory ?? 0);
                                dInventorySubLedgerId = toServiceUnit.SRRegistrationType == "IPR" ? (proacc.SubledgerIdInventoryIP ?? 0) : (proacc.SubledgerIdInventory ?? 0);
                            }
                            paMsg = string.Format("Product Account: {0} : Inventory / Asset", pac.ProductAccountName);
                        }

                        bool isCost = true;

                        if (!e.IsNonMasterOrder ?? false)
                        {
                            //if (isInventory || (e.IsAssets ?? false))
                            if (isInventory)
                            {
                                isCost = false;
                                //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                                AppParameter app = new AppParameter();
                                app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                                if (app.ParameterValue == "Yes")
                                {
                                    //Matrix COA Unit 
                                    ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                                    supam.Query.Where(supam.Query.LocationId == e.ToLocationID, supam.Query.ServiceUnitId == /*e.ToServiceUnitID*/ toServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
                                    if (supam.Query.Load())
                                    {
                                        dInventoryCoaId = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                        dInventorySubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                                    }
                                    else
                                    {
                                        dInventoryCoaId = 0;
                                        dInventorySubLedgerId = 0;
                                    }
                                    paMsg = string.Format("Service Unit Product Account Mapping: Service unit {0}, product account {1}", toServiceUnit.ServiceUnitName, pac.ProductAccountName);
                                }
                            }
                            else
                            {
                                isCost = true;
                            }
                        }

                        if (isCost)
                        {
                            //deby, masih perlu ditest
                            //ini u/ PO dari banyak RO
                            if (nopr == string.Empty)
                            {
                                var itipo = new ItemTransactionItem();
                                if (itipo.LoadByPrimaryKey(p.ReferenceNo, p.ReferenceSequenceNo) && !string.IsNullOrEmpty(itipo.ReferenceNo))
                                {
                                    var itpr = new ItemTransaction();
                                    if (itpr.LoadByPrimaryKey(itipo.ReferenceNo))
                                    {
                                        toServiceUnit = new ServiceUnit();
                                        toServiceUnit.LoadByPrimaryKey(!string.IsNullOrEmpty(itpr.ServiceUnitCostID) ? itpr.ServiceUnitCostID : itpr.FromServiceUnitID);
                                    }
                                }
                            }

                            // non inventory / non master langsung jadi biaya
                            if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                            {
                                dInventoryCoaId = toServiceUnit.ChartOfAccountIdCost.HasValue ? toServiceUnit.ChartOfAccountIdCost.Value : 0;
                                dInventorySubLedgerId = toServiceUnit.SubledgerIdCost.HasValue ? toServiceUnit.SubledgerIdCost.Value : 0;
                                paMsg = string.Format("Service unit {0}: COA Cost Medic", toServiceUnit.ServiceUnitName);
                            }
                            else
                            {
                                dInventoryCoaId = toServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? toServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                                dInventorySubLedgerId = toServiceUnit.SubledgerIdCostNonMedic.HasValue ? toServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                                paMsg = string.Format("Service unit {0}: COA Cost Non Medic", toServiceUnit.ServiceUnitName);
                            }

                            AppParameter ap2 = new AppParameter();
                            ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                            if (ap2.ParameterValue == "Yes")
                            {
                                var pacc = e.IsNonMasterOrder ?? false ? e.ProductAccountID : p.ProductAccountId;
                                //Matrix COA Unit 
                                ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();

                                //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, 
                                //    supam.Query.ServiceUnitId == e.ToServiceUnitID, 
                                //    supam.Query.ProductAccountId == p.ProductAccountId, 
                                //    supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                                //supam.Query.Where(supam.Query.ServiceUnitId == e.ToServiceUnitID,
                                //    supam.Query.ProductAccountId == pacc,
                                //    supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType))
                                //    .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                                supam.Query.Where(supam.Query.ServiceUnitId == toServiceUnit.ServiceUnitID,
                                    supam.Query.ProductAccountId == pacc,
                                    supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : (toServiceUnit.SRRegistrationType == "MCU" ? "OPR" : toServiceUnit.SRRegistrationType)))
                                    .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                                supam.Query.es.Top = 1;

                                paMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                            toServiceUnit.ServiceUnitName, pac.ProductAccountName);
                                if (supam.Query.Load())
                                {
                                    dInventoryCoaId = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dInventorySubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                                else
                                {
                                    dInventoryCoaId = 0;
                                    dInventorySubLedgerId = 0;
                                }
                            }
                        }
                    }
                    else
                    {
                        // settingan tetap pake product account di master item (asset/inventory)
                        var pac = new ProductAccount();
                        if (pac.LoadByPrimaryKey((e.IsNonMasterOrder ?? false ? e.ProductAccountID : itemInv.ProductAccountID)))
                        {
                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == pac.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                            if (proacc.Load(proacc.Query))
                            {
                                dInventoryCoaId = toServiceUnit.SRRegistrationType == "IPR" ? (proacc.ChartOfAccountIdInventoryIP ?? 0) : (proacc.ChartOfAccountIdInventory ?? 0);
                                dInventorySubLedgerId = toServiceUnit.SRRegistrationType == "IPR" ? (proacc.SubledgerIdInventoryIP ?? 0) : (proacc.SubledgerIdInventory ?? 0);
                            }
                            paMsg = string.Format("Product Account: {0} : Inventory / Asset", pac.ProductAccountName);
                        }
                    }


                    //if (dInventoryCoaId == 0)
                    //    return 0;

                    var d = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(dInventoryCoaId, coaColl, paMsg), //dInventoryCoaId,
                        SubLedgerId = dInventorySubLedgerId,
                        Debit = decimal.Round((decimal)amount, 2),
                        Credit = 0,
                        Description = string.Format("RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                        DocumentNumber = e.TransactionNo
                    };
                    d.AddNew();
                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, p.ItemID, string.Empty, p.SequenceNo);
                    d.Save();

                    payableAmount += decimal.Round((decimal)amount, 2);
                    totalDebit += d.Debit.Value;


                    //-------------------------------------------------------------------------------
                    // PURCHASE DISCOUNT (C)
                    //-------------------------------------------------------------------------------
                    // hanya u/ jurnal inventory
                    //decimal discountAmount = decimal.Round((decimal)(p.Discount1Percentage.HasValue ? (p.PriceInCurrency.Value * p.Quantity * (p.Discount1Percentage / 100)) : 0), 2);
                    //discountAmount += decimal.Round((decimal)(p.Discount2Percentage.HasValue ? (((p.PriceInCurrency.Value * p.Quantity) - discountAmount) * (p.Discount2Percentage / 100)) : 0), 2);
                    if (!IsAssetsJournaled)
                    {
                        var discountAmount = (decimal)(p.DiscountInCurrency.Value * p.Quantity.Value);
                        if (discountAmount > 0)
                        {
                            var discount = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = ValidateCOA(dInventoryCoaId, coaColl, paMsg),
                                SubLedgerId = dInventorySubLedgerId,
                                Debit = 0,
                                Credit = decimal.Round(discountAmount, 2),
                                Description = string.Format("DISC. RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                                DocumentNumber = e.TransactionNo
                            };
                            AddMoreInfo(discount, string.Empty, string.Empty, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                                toServiceUnit.ServiceUnitID, p.ItemID, string.Empty, p.SequenceNo);
                            discount.AddNew();
                            discount.Save();
                            totalCredit += discount.Credit.Value;

                            discTotal += discountAmount;
                        }
                    }
                }

                //-------------------------------------------------------------------------------
                // VAT IN (D)
                //-------------------------------------------------------------------------------
                decimal taxAmount = 0;

                if (IsPpnJournaled)
                {
                    taxAmount = decimal.Round((decimal)e.TaxAmount.Value, 2);

                    if (e.SRItemType == "11")
                    {
                        if (taxAmount != 0)
                        {
                            bool coaPpnFromSU = false;
                            // PPN khusus obat alkes dibedain antara ppn rawat inap dan rawat jalan
                            var suPPN = new ServiceUnit();
                            if (suPPN.LoadByPrimaryKey(e.ToServiceUnitID))
                            {
                                if ((suPPN.ChartOfAccountIdPpnIn ?? 0) != 0)
                                {
                                    dVatInCoaId = suPPN.ChartOfAccountIdPpnIn.Value;
                                    coaPpnFromSU = true;
                                }
                            }

                            var tax = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = ValidateCOA(dVatInCoaId, coaColl, coaPpnFromSU ? string.Format("Service Unit: {0}: Chart Of Account Ppn In", suPPN.ServiceUnitName) : "App Parameter: coa_Ppn"),
                                SubLedgerId = 0,
                                Debit = taxAmount,
                                Credit = 0,
                                Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                                DocumentNumber = e.TransactionNo
                            };
                            AddMoreInfo(tax, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                                toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                            tax.AddNew();
                            tax.Save();
                            totalDebit += tax.Debit.Value;
                        }
                    }
                    else
                    {
                        if (taxAmount != 0)
                        {
                            bool coaPpnFromSU = false;
                            // PPN khusus obat alkes dibedain antara ppn rawat inap dan rawat jalan
                            var suPPN = new ServiceUnit();
                            if (suPPN.LoadByPrimaryKey(e.ToServiceUnitID))
                            {
                                if ((suPPN.ChartOfAccountIdPpnIn ?? 0) != 0)
                                {
                                    dVatInCoaIdNonMedic = suPPN.ChartOfAccountIdPpnIn.Value;
                                    coaPpnFromSU = true;
                                }
                            }

                            var tax = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = ValidateCOA(dVatInCoaIdNonMedic, coaColl, coaPpnFromSU ? string.Format("Service Unit: {0}: Chart Of Account Ppn In", suPPN.ServiceUnitName) : "App Parameter: coa_PpnNonMedic"),
                                SubLedgerId = 0,
                                Debit = taxAmount,
                                Credit = 0,
                                Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                                DocumentNumber = e.TransactionNo
                            };
                            AddMoreInfo(tax, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                                toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                            tax.AddNew();
                            tax.Save();
                            totalDebit += tax.Debit.Value;
                        }
                    }
                }

                var discGolobal = decimal.Round((decimal)e.DiscountAmount.Value, 2);

                if (discGolobal > 0)
                {
                    var glob = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(cDiscountCoaId, coaColl, "App Parameter: coa_PurchaseDiscount (Global Discount)"),
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = decimal.Round((decimal)discGolobal, 2),
                        Description = string.Format("DISC. GLOBAL RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(glob, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    glob.AddNew();
                    glob.Save();
                    totalCredit += glob.Credit.Value;
                }



                //-------------------------------------------------------------------------------
                // VAT PPh article 22/23
                //-------------------------------------------------------------------------------
                var pph22Amt = e.Pph22.HasValue ? e.Pph22.Value * e.CurrencyRate.Value : 0;
                if (pph22Amt > 0)
                {
                    var vatPPh22 = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(dVatPPh22CoaId, coaColl, "App Parameter: coa_Pph22"),
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = decimal.Round((decimal)pph22Amt, 2),
                        Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT PPh22 ", e.TransactionNo, supplierName),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(vatPPh22, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    vatPPh22.AddNew();
                    vatPPh22.Save();
                    totalCredit += vatPPh22.Credit.Value;
                }

                var pph23Amt = e.Pph23.HasValue ? e.Pph23.Value * e.CurrencyRate.Value : 0;
                if (pph23Amt > 0)
                {
                    var vatPPh23 = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(dVatPPh23CoaId, coaColl, "App Parameter: coa_Pph23"),
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = decimal.Round((decimal)pph23Amt),
                        Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT PPh23", e.TransactionNo, supplierName),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(vatPPh23, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    vatPPh23.AddNew();
                    vatPPh23.Save();
                    totalCredit += vatPPh23.Credit.Value;
                }

                // pph by stdref
                var pph = e.PphAmount.HasValue ? e.PphAmount.Value * e.CurrencyRate.Value : 0;
                if (pph > 0)
                {
                    var stdRef = new AppStandardReferenceItem();
                    stdRef.Query.Where(stdRef.Query.StandardReferenceID == "Pph",
                        stdRef.Query.ItemID == e.SRPph);
                    stdRef.Load(stdRef.Query);

                    var vatPPh = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(stdRef.coaID, coaColl, "Standard Reference: Pph: " + stdRef.ItemName),
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = decimal.Round((decimal)pph, 2),
                        Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT {2} ", e.TransactionNo, supplierName, stdRef.ItemName),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(vatPPh, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    vatPPh.AddNew();
                    vatPPh.Save();
                    totalCredit += vatPPh.Credit.Value;
                }


                var cMaterai = GetCachedAccountFromParam("coa_StampAmountPOR");
                if (true)
                {
                    //-------------------------------------------------------------------------------
                    // ACCOUNT PAYABLE (C)
                    //-------------------------------------------------------------------------------
                    var netPayableAmount = (payableAmount + (dVatInCoaId > 0 ? taxAmount : 0) +
                        (cMaterai > 0 ? decimal.Round((decimal)e.StampAmount, 2) : 0)) -
                        (discTotal + pph22Amt + pph23Amt + pph + discGolobal) +
                        decimal.Round((decimal)e.DownPaymentAmount, 2)/*shipping amount*/;
                    netPayableAmount = decimal.Round((decimal)netPayableAmount, 2);

                    decimal hdPayableAmount = (e.ChargesAmount ?? 0) + (e.TaxAmount ?? 0) - (e.Pph22 ?? 0) - (e.Pph23 ?? 0) - (e.PphAmount ?? 0) +
                        (e.StampAmount ?? 0) + (e.DownPaymentAmount ?? 0);

                    var payable = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                            ValidateCOA(cAccountPayableCoaIdNM, coaColl, suPayableMsg + "Non Medical") :
                            ValidateCOA(cAccountPayableCoaId, coaColl, suPayableMsg),
                        SubLedgerId = (IsApNMSeparated && !isMedic) ? cAccountPayableSubLedgerIdNM : cAccountPayableSubLedgerId,
                        Debit = 0,
                        Credit = hdPayableAmount,
                        Description =
                            string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(payable, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    payable.AddNew();
                    payable.Save();
                    totalCredit += payable.Credit.Value;

                    if (hdPayableAmount != netPayableAmount)
                    {
                        // rounding 
                        var rndAmount = netPayableAmount - hdPayableAmount;
                        var coaRnd = GetCachedAccountFromParam("coa_RoundingAP");
                        var rnd = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(coaRnd, coaColl, "AppParameter: coa_RoundingAP"),
                            SubLedgerId = 0,
                            Debit = rndAmount < 0 ? rndAmount * -1 : 0,
                            Credit = rndAmount >= 0 ? rndAmount : 0,
                            Description =
                                string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}. Rounding.", e.TransactionNo, supplierName, invNo),
                            DocumentNumber = e.TransactionNo
                        };
                        AddMoreInfo(rnd, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                            toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                        rnd.AddNew();
                        rnd.Save();
                        totalDebit += rnd.Debit.Value;
                        totalCredit += rnd.Credit.Value;
                    }
                }
                else
                {
                    //-------------------------------------------------------------------------------
                    // ACCOUNT PAYABLE (C)
                    //-------------------------------------------------------------------------------
                    var netPayableAmount = (payableAmount + (dVatInCoaId > 0 ? taxAmount : 0) +
                        (cMaterai > 0 ? decimal.Round((decimal)e.StampAmount, 2) : 0)) -
                        (discTotal + pph22Amt + pph23Amt + pph + discGolobal) +
                        decimal.Round((decimal)e.DownPaymentAmount, 2)/*shipping amount*/;

                    //untuk tipe PO Credit
                    //if (e.SRPurchaseOrderType == "CR")
                    //{
                    var payable = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                            ValidateCOA(cAccountPayableCoaIdNM, coaColl, suPayableMsg + "Non Medical") :
                            ValidateCOA(cAccountPayableCoaId, coaColl, suPayableMsg),
                        SubLedgerId = (IsApNMSeparated && !isMedic) ? cAccountPayableSubLedgerIdNM : cAccountPayableSubLedgerId,
                        Debit = 0,
                        Credit = decimal.Round((decimal)netPayableAmount, 2),
                        Description =
                            string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(payable, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    payable.AddNew();
                    payable.Save();
                    totalCredit += payable.Credit.Value;
                    //}
                    //else //untuk tipe PO Cash
                    //{
                    //    var app = new AppParameter();
                    //    app.LoadByPrimaryKey("HealthcareInitialAppsVersion");

                    //    var payable = new JournalTransactionDetails
                    //    {
                    //        JournalId = header.JournalId,
                    //        //ChartOfAccountId = app.ParameterValue == "RSUI" ? cAccountPayableCoaId : cAccountCash,
                    //        //SubLedgerId = app.ParameterValue == "RSUI" ? cAccountPayableSubLedgerId : 0,
                    //        ChartOfAccountId = ValidateCOA(cAccountPayableCoaId, coaColl, suPayableMsg),
                    //        SubLedgerId = cAccountPayableSubLedgerId,

                    //        Debit = 0,
                    //        Credit = decimal.Round((decimal)netPayableAmount, 2),
                    //        Description =
                    //            string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                    //        DocumentNumber = e.TransactionNo
                    //    };
                    //    AddMoreInfo(payable, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                    //        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    //    payable.AddNew();
                    //    payable.Save();
                    //    totalCredit += payable.Credit.Value;
                    //}
                }

                //Biaya Materai
                if (e.StampAmount > 0 && cMaterai > 0)
                {
                    var materai = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(cMaterai, coaColl, "App Parameter: coa_StampAmountPOR"),
                        SubLedgerId = 0,
                        Debit = decimal.Round((decimal)e.StampAmount, 2),
                        Credit = 0,
                        Description =
                            string.Format("STAMP AMOUNT #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(materai, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    materai.AddNew();
                    materai.Save();
                    totalDebit += materai.Debit.Value;
                    totalCredit += materai.Credit.Value;
                }

                //Biaya KIRIM
                var dShip = GetCachedAccountFromParam("coa_ShippingPOR");
                var ShipAmt = decimal.Round((decimal)e.DownPaymentAmount, 2);
                if (ShipAmt != 0)
                {
                    var ship = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(dShip, coaColl, "App Parameter: coa_ShippingPOR"),
                        SubLedgerId = 0,
                        Debit = ShipAmt >= 0 ? ShipAmt : 0,
                        Credit = ShipAmt < 0 ? (ShipAmt * -1) : 0,
                        Description =
                            string.Format("STAMP AMOUNT #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(ship, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        toServiceUnit.ServiceUnitID, string.Empty, string.Empty);
                    ship.AddNew();
                    ship.Save();
                    totalDebit += ship.Debit.Value;
                    totalCredit += ship.Credit.Value;
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPOReceived) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewPurchaseOrderReceivedJournalVer2_(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            if (e.SRPurchaseOrderType == "CS" && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalCashPOReceived) == "No")
                return 0;


            string journalType = Temiang.Avicenna.BusinessObject.JournalType.PurchaseOrderReceived;

            ServiceUnit toServiceUnit = new ServiceUnit();
            if (!toServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID))
                return 0;

            try
            {
                //
                // Requirement:
                //
                // INVENTORY (D)
                // VAT IN (D)
                // PURCHASE DISCOUNT (C)
                // ACCOUNT PAYABLE (C)
                // VAT PPH 22/23 (C)

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int dInventoryCoaId = 0;
                int dInventorySubLedgerId = 0;
                int cAccountPayableCoaId = 0; //GetCachedAccountFromParam("coa_ApInProcess"); 
                int cAccountPayableSubLedgerId = 0;
                int cAccountCash = GetCachedAccountFromParam("coa_PurchaseCash");

                //Discount mengurangi persediaan sesuai product account-nya, jd ambil COA dr persediaan saja, kalo pakai appparameter jd hanya bisa utk 1 product account saja
                int cDiscountCoaId = GetCachedAccountFromParam("coa_PurchaseDiscount");

                var eItems = new ItemTransactionItemCollection();
                var eItemQuery = new ItemTransactionItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var supplierName = string.Empty;
                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
                    return 0;

                supplierName = sup.SupplierName;
                if (sup.ChartOfAccountIdAP.HasValue)
                {
                    //hutang diakui saat tukar faktur sehingga saat POR ditampung terlebih dahulu di account sementara
                    cAccountPayableCoaId = sup.ChartOfAccountIdAPTemporary.HasValue ? sup.ChartOfAccountIdAPTemporary.Value : 0;
                    cAccountPayableSubLedgerId = sup.SubledgerIdAPTemporary.HasValue ? sup.SubledgerIdAPTemporary.Value : 0;

                }

                if (cAccountPayableCoaId == 0)
                    return 0;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("PO", e.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);
                var invNo = e.InvoiceNo ?? "-";

                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //header.LastUpdateByUserID = editedBy;
                }
                else
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = e.TransactionDate;
                    header.Description = string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = e.TransactionNo;
                }
                header.Save();

                decimal payableAmount = 0;
                //decimal discountAmount = 0;
                decimal discTotal = 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                if (e.IsNonMasterOrder == true)
                {
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == e.ProductAccountID,
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(e.ProductAccountID))
                        //{
                        dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                        dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                    }
                }

                //-------------------------------------------------------------------------------
                // INVENTORY (D)
                //-------------------------------------------------------------------------------
                foreach (var p in eItems)
                {
                    decimal amount;
                    amount = (p.Quantity.Value * p.PriceInCurrency.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.PriceInCurrency.Value));


                    if (!e.IsNonMasterOrder ?? false)
                    {
                        var itemId = p.ItemID;
                        var itemInv = new Item();
                        itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                        if (itemInv.Query.Load())
                        {
                            var proacc = new ProductAccountGuarantorGroup();
                            proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                            if (proacc.Load(proacc.Query))
                            {
                                //var proacc = new ProductAccount();
                                //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                                //{
                                //TODO: Find COA purchase discount from Product Account
                                dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                                dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                            }
                        }


                        //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                        AppParameter app = new AppParameter();
                        app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                        if (app.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            supam.Query.Where(supam.Query.LocationId == e.ToLocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
                            if (supam.Query.Load())
                            {
                                dInventoryCoaId = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                dInventorySubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                            }
                        }
                    }


                    if (dInventoryCoaId == 0)
                        return 0;

                    var d = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = dInventoryCoaId,
                        SubLedgerId = dInventorySubLedgerId,
                        Debit = decimal.Round((decimal)amount, 2),
                        Credit = 0,
                        Description = string.Format("RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                        DocumentNumber = e.TransactionNo
                    };
                    d.AddNew();
                    d.Save();

                    payableAmount += amount;
                    totalDebit += d.Debit.Value;

                    //-------------------------------------------------------------------------------
                    // PURCHASE DISCOUNT (C)
                    //-------------------------------------------------------------------------------
                    //decimal discountAmount = decimal.Round((decimal)(p.Discount1Percentage.HasValue ? (p.PriceInCurrency.Value * p.Quantity * (p.Discount1Percentage / 100)) : 0), 2);
                    //discountAmount += decimal.Round((decimal)(p.Discount2Percentage.HasValue ? (((p.PriceInCurrency.Value * p.Quantity) - discountAmount) * (p.Discount2Percentage / 100)) : 0), 2);

                    var discountAmount = (decimal)(p.DiscountInCurrency.Value * p.Quantity.Value);
                    if (discountAmount > 0)
                    {
                        var discount = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = dInventoryCoaId,
                            SubLedgerId = 0,
                            Debit = 0,
                            Credit = decimal.Round(discountAmount, 2),
                            Description = string.Format("DISC. RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                            DocumentNumber = e.TransactionNo
                        };

                        discount.AddNew();
                        discount.Save();
                        totalCredit += discount.Credit.Value;

                        discTotal += discountAmount;
                    }
                }


                //-------------------------------------------------------------------------------
                // ACCOUNT PAYABLE (C)
                //-------------------------------------------------------------------------------
                //blun tau apakah materai hrs dijurnal di POR
                // var cMaterai = GetCachedAccountFromParam("coa_StampAmountPOR");
                // var netPayableAmount = (payableAmount  + (cMaterai > 0 ? decimal.Round((decimal)e.StampAmount, 2) : 0)) - (discTotal);
                var netPayableAmount = payableAmount - discTotal;

                //untuk tipe PO Credit
                if (e.SRPurchaseOrderType == "CR")
                {

                    var payable = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = cAccountPayableCoaId,
                        SubLedgerId = cAccountPayableSubLedgerId,
                        Debit = 0,
                        Credit = decimal.Round((decimal)netPayableAmount, 2),
                        Description =
                            string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                        DocumentNumber = e.TransactionNo
                    };

                    payable.AddNew();
                    payable.Save();
                    totalCredit += payable.Credit.Value;
                }
                else //untuk tipe PO Cash
                {
                    var payable = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = cAccountCash,
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = decimal.Round((decimal)netPayableAmount, 2),
                        Description =
                            string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                        DocumentNumber = e.TransactionNo
                    };

                    payable.AddNew();
                    payable.Save();
                    totalCredit += payable.Credit.Value;

                }

                //Biaya Materai apakah dijournal saat POR?
                //if (e.StampAmount > 0 && cMaterai > 0)
                //{
                //    var materai = new JournalTransactionDetails
                //    {
                //        JournalId = header.JournalId,
                //        ChartOfAccountId = cMaterai,
                //        SubLedgerId = 0,
                //        Debit = decimal.Round((decimal)e.StampAmount, 2),
                //        Credit = 0,
                //        Description =
                //            string.Format("STAMP AMOUNT #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                //        DocumentNumber = e.TransactionNo
                //    };

                //    materai.AddNew();
                //    materai.Save();
                //}

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPOReceived) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        //public static int? AddNewPurchaseOrderReceivedJournalNonVat(ItemTransaction e, string editedBy, int journalId)
        //{
        //    if (!IsAutoJournalEnabled())
        //        return 0;

        //    if (e.SRPurchaseOrderType == "CS" && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalCashPOReceived) == "No")
        //        return 0;


        //    string journalType = Temiang.Avicenna.BusinessObject.JournalType.PurchaseOrderReceived;

        //    ServiceUnit toServiceUnit = new ServiceUnit();
        //    if (!toServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID))
        //        return 0;

        //    try
        //    {
        //        //
        //        // Requirement:
        //        //
        //        // INVENTORY (D)
        //        // VAT IN (D)
        //        // PURCHASE DISCOUNT (C)
        //        // ACCOUNT PAYABLE (C)
        //        // VAT PPH 22/23 (C)

        //        decimal totalDebit = 0;
        //        decimal totalCredit = 0;

        //        int dInventoryCoaId = 0;
        //        int dInventorySubLedgerId = 0;
        //        int dVatInCoaId = 0;
        //        int dVatPPh22CoaId = GetCachedAccountFromParam("coa_Pph22");
        //        int dVatPPh23CoaId = GetCachedAccountFromParam("coa_Pph23");
        //        int cAccountPayableCoaId = 0; //GetCachedAccountFromParam("coa_ApInProcess"); 
        //        int cAccountPayableSubLedgerId = 0;
        //        int cAccountCash = GetCachedAccountFromParam("coa_PurchaseCash");

        //        //Discount mengurangi persediaan sesuai product account-nya, jd ambil COA dr persediaan saja, kalo pakai appparameter jd hanya bisa utk 1 product account saja
        //        int cDiscountCoaId = GetCachedAccountFromParam("coa_PurchaseDiscount");

        //        var eItems = new ItemTransactionItemCollection();
        //        var eItemQuery = new ItemTransactionItemQuery("e");
        //        var itemQuery = new ItemQuery("i");

        //        eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
        //        eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
        //        eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
        //        if (!eItems.Load(eItemQuery))
        //            return 0;

        //        var supplierName = string.Empty;
        //        var sup = new Supplier();
        //        if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
        //            return 0;

        //        supplierName = sup.SupplierName;
        //        if (sup.ChartOfAccountIdAP.HasValue)
        //        {
        //            cAccountPayableCoaId = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
        //            cAccountPayableSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;
        //        }

        //        if (cAccountPayableCoaId == 0)
        //            return 0;

        //        //Journal Header
        //        var journalCode = JournalCodes.GetOrCreateAutoJournalCode("PO", e.TransactionDate.Value);
        //        var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);
        //        var invNo = e.InvoiceNo ?? "-";

        //        var header = new JournalTransactions();
        //        if (header.LoadByPrimaryKey(journalId))
        //        {
        //            var journalDetails = new JournalTransactionDetailsCollection();
        //            journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
        //            journalDetails.LoadAll();
        //            journalDetails.MarkAllAsDeleted();
        //            journalDetails.Save();

        //            // rejournal tidak usah update last update
        //            header.LastUpdateDateTime = DateTime.Now;
        //            //header.LastUpdateByUserID = editedBy;
        //        }
        //        else
        //        {
        //            header.AddNew();
        //            header.JournalType = journalType;
        //            header.JournalCode = journalCode;
        //            header.TransactionNumber = journalNumber;
        //            header.TransactionDate = e.TransactionDate;
        //            header.Description = string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo);
        //            header.IsPosted = false;
        //            header.DateCreated = DateTime.Now;
        //            header.LastUpdateDateTime = DateTime.Now;
        //            header.CreatedBy = editedBy;
        //            header.LastUpdateByUserID = editedBy;
        //            header.RefferenceNumber = e.TransactionNo;
        //        }
        //        header.Save();

        //        decimal payableAmount = 0;
        //        //decimal discountAmount = 0;
        //        decimal discTotal = 0;

        //        var stdGG = new AppStandardReferenceItemCollection();
        //        stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
        //            .OrderBy(stdGG.Query.ItemID.Ascending);
        //        stdGG.Query.es.Top = 1;
        //        stdGG.LoadAll();

        //        if (e.IsNonMasterOrder == true)
        //        {
        //            var proacc = new ProductAccountGuarantorGroup();
        //            proacc.Query.Where(proacc.Query.ProductAccountID == e.ProductAccountID,
        //                proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
        //            if (proacc.Load(proacc.Query))
        //            {
        //                //ProductAccount proacc = new ProductAccount();
        //                //if (proacc.LoadByPrimaryKey(e.ProductAccountID))
        //                //{
        //                dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
        //                dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
        //            }
        //        }

        //        //-------------------------------------------------------------------------------
        //        // INVENTORY (D)
        //        //-------------------------------------------------------------------------------
        //        int i = 0;
        //        foreach (var p in eItems)
        //        {
        //            decimal amount;
        //            //var dAmt = (p.Quantity.Value * p.PriceInCurrency.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.PriceInCurrency.Value));
        //            if (dVatInCoaId == 0)
        //            {
        //                if (i == 0)
        //                {
        //                    amount = ((((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value)) +
        //                        ((e.TaxPercentage.Value / 100) * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value)))) +
        //                        (p.Quantity.Value * p.DiscountInCurrency.Value)) - ((e.TaxPercentage.Value / 100) * e.DiscountAmount.Value);
        //                    i++;
        //                }
        //                else
        //                    amount = (((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value)) +
        //                        ((e.TaxPercentage.Value / 100) * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value)))) +
        //                        (p.Quantity.Value * p.DiscountInCurrency.Value);
        //            }
        //            else
        //                amount = (p.Quantity.Value * p.PriceInCurrency.Value);

        //            if (!e.IsNonMasterOrder ?? false)
        //            {
        //                var itemId = p.ItemID;
        //                var itemInv = new Item();
        //                itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
        //                if (itemInv.Query.Load())
        //                {
        //                    var proacc = new ProductAccountGuarantorGroup();
        //                    proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
        //                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
        //                    if (proacc.Load(proacc.Query))
        //                    {
        //                        //var proacc = new ProductAccount();
        //                        //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
        //                        //{
        //                        //TODO: Find COA purchase discount from Product Account
        //                        dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
        //                        dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
        //                    }
        //                }


        //                //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
        //                AppParameter app = new AppParameter();
        //                app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
        //                if (app.ParameterValue == "Yes")
        //                {
        //                    //Matrix COA Unit 
        //                    ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
        //                    supam.Query.Where(supam.Query.LocationId == e.ToLocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
        //                    if (supam.Query.Load())
        //                    {
        //                        dInventoryCoaId = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
        //                        dInventorySubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

        //                    }
        //                }
        //            }


        //            if (dInventoryCoaId == 0)
        //                return 0;

        //            var d = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = dInventoryCoaId,
        //                SubLedgerId = dInventorySubLedgerId,
        //                Debit = decimal.Round((decimal)amount, 2),
        //                Credit = 0,
        //                Description = string.Format("RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
        //                DocumentNumber = e.TransactionNo
        //            };
        //            d.AddNew();
        //            d.Save();

        //            payableAmount += amount;
        //            totalDebit += d.Debit.Value;

        //            //-------------------------------------------------------------------------------
        //            // PURCHASE DISCOUNT (C)
        //            //-------------------------------------------------------------------------------
        //            //decimal discountAmount = decimal.Round((decimal)(p.Discount1Percentage.HasValue ? (p.PriceInCurrency.Value * p.Quantity * (p.Discount1Percentage / 100)) : 0), 2);
        //            //discountAmount += decimal.Round((decimal)(p.Discount2Percentage.HasValue ? (((p.PriceInCurrency.Value * p.Quantity) - discountAmount) * (p.Discount2Percentage / 100)) : 0), 2);

        //            var discountAmount = (decimal)(p.DiscountInCurrency.Value * p.Quantity.Value);
        //            if (discountAmount > 0)
        //            {
        //                var discount = new JournalTransactionDetails
        //                {
        //                    JournalId = header.JournalId,
        //                    ChartOfAccountId = dInventoryCoaId,
        //                    SubLedgerId = 0,
        //                    Debit = 0,
        //                    //Credit = (dVatInCoaId == 0) ? decimal.Round(((e.TaxPercentage.Value / 100) * discountAmount) + discountAmount, 2) : decimal.Round(discountAmount, 2),
        //                    Credit = decimal.Round(discountAmount, 2),
        //                    Description = string.Format("DISC. RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
        //                    DocumentNumber = e.TransactionNo
        //                };

        //                discount.AddNew();
        //                discount.Save();
        //                totalCredit += discount.Credit.Value;

        //                //discTotal += (dVatInCoaId == 0) ? ((e.TaxPercentage.Value / 100) * discountAmount) + discountAmount : discountAmount;
        //                discTotal += discountAmount;
        //            }
        //        }

        //        //-------------------------------------------------------------------------------
        //        // VAT IN (D)
        //        //-------------------------------------------------------------------------------
        //        var taxAmount = decimal.Round((decimal)e.TaxAmount.Value, 2);

        //        if (dVatInCoaId > 0)
        //        {
        //            var tax = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = dVatInCoaId,
        //                SubLedgerId = 0,
        //                Debit = taxAmount,
        //                Credit = 0,
        //                Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
        //                DocumentNumber = e.TransactionNo
        //            };
        //            tax.AddNew();
        //            tax.Save();
        //            totalDebit += tax.Debit.Value;
        //        }

        //        var discGolobal = decimal.Round((decimal)e.DiscountAmount.Value, 2);

        //        if (discGolobal > 0)
        //        {
        //            var glob = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = cDiscountCoaId,
        //                SubLedgerId = 0,
        //                Debit = 0,
        //                Credit = decimal.Round((decimal)discGolobal, 2),
        //                Description = string.Format("DISC. GLOBAL RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
        //                DocumentNumber = e.TransactionNo
        //            };

        //            glob.AddNew();
        //            glob.Save();
        //            totalCredit += glob.Credit.Value;
        //        }



        //        //-------------------------------------------------------------------------------
        //        // VAT PPh article 22/23
        //        //-------------------------------------------------------------------------------
        //        var pph22Amt = e.Pph22.HasValue ? e.Pph22.Value * e.CurrencyRate.Value : 0;
        //        if (pph22Amt > 0)
        //        {
        //            var vatPPh22 = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = dVatPPh22CoaId,
        //                SubLedgerId = 0,
        //                Debit = 0,
        //                Credit = decimal.Round((decimal)pph22Amt, 2),
        //                Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT PPh22 ", e.TransactionNo, supplierName),
        //                DocumentNumber = e.TransactionNo
        //            };

        //            vatPPh22.AddNew();
        //            vatPPh22.Save();
        //            totalCredit += vatPPh22.Credit.Value;
        //        }

        //        var pph23Amt = e.Pph23.HasValue ? e.Pph23.Value * e.CurrencyRate.Value : 0;
        //        if (pph23Amt > 0)
        //        {
        //            var vatPPh23 = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = dVatPPh23CoaId,
        //                SubLedgerId = 0,
        //                Debit = 0,
        //                Credit = decimal.Round((decimal)pph23Amt),
        //                Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT PPh23", e.TransactionNo, supplierName),
        //                DocumentNumber = e.TransactionNo
        //            };

        //            vatPPh23.AddNew();
        //            vatPPh23.Save();
        //            totalCredit += vatPPh23.Credit.Value;
        //        }


        //        //-------------------------------------------------------------------------------
        //        // ACCOUNT PAYABLE (C)
        //        //-------------------------------------------------------------------------------
        //        var cMaterai = GetCachedAccountFromParam("coa_StampAmountPOR");
        //        //var netPayableAmount = (payableAmount + (dVatInCoaId > 0 ? taxAmount : 0) + (cMaterai > 0 ? decimal.Round((decimal)e.StampAmount, 2) : 0)) - (discTotal + pph22Amt + pph23Amt + discGolobal);
        //        var netPayableAmount = e.ChargesAmount;

        //        //untuk tipe PO Credit
        //        if (e.SRPurchaseOrderType == "CR")
        //        {

        //            var payable = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = cAccountPayableCoaId,
        //                SubLedgerId = cAccountPayableSubLedgerId,
        //                Debit = 0,
        //                Credit = decimal.Round((decimal)netPayableAmount, 2),
        //                Description =
        //                    string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
        //                DocumentNumber = e.TransactionNo
        //            };

        //            payable.AddNew();
        //            payable.Save();
        //            totalCredit += payable.Credit.Value;
        //        }
        //        else //untuk tipe PO Cash
        //        {
        //            var payable = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = cAccountCash,
        //                SubLedgerId = 0,
        //                Debit = 0,
        //                Credit = decimal.Round((decimal)netPayableAmount, 2),
        //                Description =
        //                    string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
        //                DocumentNumber = e.TransactionNo
        //            };

        //            payable.AddNew();
        //            payable.Save();
        //            totalCredit += payable.Credit.Value;

        //        }

        //        //Biaya Materai
        //        if (e.StampAmount > 0 && cMaterai > 0)
        //        {
        //            var materai = new JournalTransactionDetails
        //            {
        //                JournalId = header.JournalId,
        //                ChartOfAccountId = cMaterai,
        //                SubLedgerId = 0,
        //                Debit = decimal.Round((decimal)e.StampAmount, 2),
        //                Credit = 0,
        //                Description =
        //                    string.Format("STAMP AMOUNT #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
        //                DocumentNumber = e.TransactionNo
        //            };

        //            materai.AddNew();
        //            materai.Save();
        //        }

        //        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPOReceived) == "Yes")
        //        {
        //            if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
        //            {
        //                header.BeginEdit();
        //                header.IsPosted = true;
        //                header.EndEdit();
        //                header.Save();
        //            }
        //        }

        //        return header.JournalId;
        //    }
        //    catch (Exception ex)
        //    {
        //        return -1;
        //    }
        //}

        public static int? AddNewConsignmentReceivedJournal(ItemTransaction e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ConsignmentReceived;
            try
            {
                //
                // Requirement:
                //
                // INVENTORY (D)
                // VAT IN (D)
                // ACCOUNT PAYABLE (C)

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int dInventoryCoaId = 0;
                int dInventorySubLedgerId = 0;
                int dVatInCoaId = GetCachedAccountFromParam("coa_Ppn");
                int cAccountPayableCoaId = 0;
                int cAccountPayableSubLedgerId = 0;

                var eItems = new ItemTransactionItemCollection();
                var eItemQuery = new ItemTransactionItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var supplierName = string.Empty;
                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
                    return 0;

                supplierName = sup.SupplierName;
                if (sup.ChartOfAccountIdAP.HasValue)
                {
                    cAccountPayableCoaId = sup.ChartOfAccountIdAPInProcess.HasValue ? sup.ChartOfAccountIdAPInProcess.Value : 0;
                    cAccountPayableSubLedgerId = sup.SubledgerIdAPInProcess.HasValue ? sup.SubledgerIdAPInProcess.Value : 0;
                }

                if (cAccountPayableCoaId == 0)
                    return 0;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("CGR", e.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);
                var invNo = e.InvoiceNo ?? "-";

                var header = new JournalTransactions
                {
                    JournalType = journalType,
                    JournalCode = journalCode,
                    TransactionNumber = journalNumber,
                    TransactionDate = e.TransactionDate,
                    Description = string.Format("CONSIGNMENT RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                    IsPosted = false,
                    DateCreated = DateTime.Now,
                    LastUpdateDateTime = DateTime.Now,
                    CreatedBy = editedBy,
                    LastUpdateByUserID = editedBy,
                    RefferenceNumber = e.TransactionNo
                };
                header.AddNew();
                header.Save();

                decimal payableAmount = 0;
                //decimal discountAmount = 0;
                decimal discTotal = 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                if (e.IsNonMasterOrder == true)
                {
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == e.ProductAccountID,
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(e.ProductAccountID))
                        //{
                        dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                        dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                    }
                }

                //-------------------------------------------------------------------------------
                // INVENTORY (D)
                //-------------------------------------------------------------------------------
                foreach (var p in eItems)
                {
                    //var dAmt = (p.Quantity.Value * p.PriceInCurrency.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.PriceInCurrency.Value));
                    var amount = (p.Quantity.Value * p.PriceInCurrency.Value);


                    var itemId = p.ItemID;
                    var itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //var proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                            //{
                            //TODO: Find COA purchase discount from Product Account
                            dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                        }
                    }

                    if (dInventoryCoaId == 0)
                        return 0;

                    var d = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = dInventoryCoaId,
                        SubLedgerId = dInventorySubLedgerId,
                        Debit = decimal.Round((decimal)amount, 2),
                        Credit = 0,
                        Description = string.Format("CONSIGNMENT RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                        DocumentNumber = e.TransactionNo
                    };
                    d.AddNew();
                    d.Save();
                    totalDebit += d.Debit.Value;
                    payableAmount += amount;

                }

                //-------------------------------------------------------------------------------
                // VAT IN (D)
                //-------------------------------------------------------------------------------
                var taxAmount = decimal.Round((decimal)e.TaxAmount.Value, 2);

                if (taxAmount > 0)
                {
                    var tax = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = dVatInCoaId,
                        SubLedgerId = 0,
                        Debit = taxAmount,
                        Credit = 0,
                        Description = string.Format("CONSIGNMENT RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                        DocumentNumber = e.TransactionNo
                    };
                    tax.AddNew();
                    tax.Save();
                    totalDebit += tax.Debit.Value;
                }

                //-------------------------------------------------------------------------------
                // ACCOUNT PAYABLE (C)
                //-------------------------------------------------------------------------------
                var netPayableAmount = (payableAmount + taxAmount);

                var payable = new JournalTransactionDetails
                {
                    JournalId = header.JournalId,
                    ChartOfAccountId = cAccountPayableCoaId,
                    SubLedgerId = cAccountPayableSubLedgerId,
                    Debit = 0,
                    Credit = decimal.Round((decimal)netPayableAmount, 2),
                    Description =
                        string.Format("CONSIGNMENT RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                    DocumentNumber = e.TransactionNo
                };
                payable.AddNew();
                payable.Save();
                totalCredit += payable.Credit.Value;

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedConsReceived) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewConsignmentReturnedJournal(ItemTransaction e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ConsignmentReceived;
            try
            {
                //
                // Requirement:
                //
                // INVENTORY (D)
                // VAT IN (D)
                // ACCOUNT PAYABLE (C)
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int dInventoryCoaId = 0;
                int dInventorySubLedgerId = 0;
                int dVatInCoaId = GetCachedAccountFromParam("coa_Ppn");
                int cAccountPayableCoaId = 0;
                int cAccountPayableSubLedgerId = 0;

                var eItems = new ItemTransactionItemCollection();
                var eItemQuery = new ItemTransactionItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var supplierName = string.Empty;
                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
                    return 0;

                supplierName = sup.SupplierName;
                if (sup.ChartOfAccountIdAP.HasValue)
                {
                    cAccountPayableCoaId = sup.ChartOfAccountIdAPInProcess.HasValue ? sup.ChartOfAccountIdAPInProcess.Value : 0;
                    cAccountPayableSubLedgerId = sup.SubledgerIdAPInProcess.HasValue ? sup.SubledgerIdAPInProcess.Value : 0;
                }

                if (cAccountPayableCoaId == 0)
                    return 0;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("CGT", e.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);
                var invNo = e.InvoiceNo ?? "-";

                var header = new JournalTransactions
                {
                    JournalType = journalType,
                    JournalCode = journalCode,
                    TransactionNumber = journalNumber,
                    TransactionDate = e.TransactionDate,
                    Description = string.Format("CONSIGNMENT RETURNED #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                    IsPosted = false,
                    DateCreated = DateTime.Now,
                    LastUpdateDateTime = DateTime.Now,
                    CreatedBy = editedBy,
                    LastUpdateByUserID = editedBy,
                    RefferenceNumber = e.TransactionNo
                };
                header.AddNew();
                header.Save();

                decimal payableAmount = 0;
                //decimal discountAmount = 0;
                decimal discTotal = 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                if (e.IsNonMasterOrder == true)
                {
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == e.ProductAccountID,
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(e.ProductAccountID))
                        //{
                        dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                        dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                    }
                }

                //-------------------------------------------------------------------------------
                // INVENTORY (D)
                //-------------------------------------------------------------------------------
                foreach (var p in eItems)
                {
                    //var dAmt = (p.Quantity.Value * p.PriceInCurrency.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.PriceInCurrency.Value));
                    var amount = (p.Quantity.Value * p.PriceInCurrency.Value);


                    var itemId = p.ItemID;
                    var itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //var proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                            //{
                            //TODO: Find COA purchase discount from Product Account
                            dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                        }
                    }

                    if (dInventoryCoaId == 0)
                        return 0;

                    var d = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = dInventoryCoaId,
                        SubLedgerId = dInventorySubLedgerId,
                        Debit = 0,
                        Credit = decimal.Round((decimal)amount, 2),
                        Description = string.Format("CONSIGNMENT RETURNED #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                        DocumentNumber = e.TransactionNo
                    };
                    d.AddNew();
                    d.Save();
                    totalCredit += d.Credit.Value;
                    payableAmount += amount;

                }

                //-------------------------------------------------------------------------------
                // VAT IN (D)
                //-------------------------------------------------------------------------------
                var taxAmount = decimal.Round(Abs((decimal)e.TaxAmount.Value), 2);

                if (taxAmount > 0)
                {
                    var tax = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = dVatInCoaId,
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = taxAmount,
                        Description = string.Format("CONSIGNMENT RETURNED #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                        DocumentNumber = e.TransactionNo
                    };
                    tax.AddNew();
                    tax.Save();
                    totalCredit += tax.Credit.Value;
                }

                //-------------------------------------------------------------------------------
                // ACCOUNT PAYABLE (C)
                //-------------------------------------------------------------------------------
                var netPayableAmount = (payableAmount + taxAmount);

                var payable = new JournalTransactionDetails
                {
                    JournalId = header.JournalId,
                    ChartOfAccountId = cAccountPayableCoaId,
                    SubLedgerId = cAccountPayableSubLedgerId,
                    Debit = decimal.Round((decimal)netPayableAmount, 2),
                    Credit = 0,
                    Description =
                        string.Format("CONSIGNMENT RETURNED #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                    DocumentNumber = e.TransactionNo
                };
                payable.AddNew();
                payable.Save();
                totalDebit += payable.Debit.Value;


                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedConsReturned) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        //public static int? AddNewConsignmentReceivedJournal(InvoiceSupplier e, string editedBy)
        //{
        //    if (!IsAutoJournalEnabled())
        //        return 0;

        //    string journalType = Temiang.Avicenna.BusinessObject.JournalType.PurchaseOrderReceived;

        //    var coll = new InvoiceSupplierItemCollection();
        //    var supItem = new InvoiceSupplierItemQuery("a");
        //    var it= new ItemTransactionQuery("b");

        //    supItem.Select(supItem);
        //    supItem.InnerJoin(it).On(it.TransactionNo == supItem.TransactionNo);
        //    supItem.Where(supItem.InvoiceNo == e.InvoiceNo, it.TransactionCode == Reference.TransactionCode.ConsignmentReceive);
        //    coll.Load(supItem);

        //    if (coll.Count == 0)
        //        return 0;

        //    //Logger.EnterMethod("AddNewPurchaseOrderReceivedJournal");
        //    try
        //    {
        //        int cAccount = 0; //GetCachedAccountFromParam("coa_ApInProcess"); // later must find this account from supplier
        //        int cSubledgerId = 0;

        //        string supplierName = string.Empty;
        //        Supplier sup = new Supplier();
        //        if (!sup.LoadByPrimaryKey(e.SupplierID))
        //            return 0;

        //        supplierName = sup.SupplierName;
        //        if (sup.ChartOfAccountIdAP.HasValue)
        //        {
        //            cAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
        //            cSubledgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;
        //        }

        //        if (cAccount == 0)
        //            return 0;

        //        //Journal Header
        //        JournalTransactions entity = new JournalTransactions();
        //        entity.AddNew();
        //        entity.JournalType = journalType;
        //        entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PO", e.InvoiceDate.Value);
        //        entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
        //        entity.TransactionDate = e.InvoiceDate;
        //        entity.Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.InvoiceNo, supplierName);
        //        entity.IsPosted = false;
        //        entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
        //        entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
        //        entity.RefferenceNumber = e.InvoiceNo;
        //        entity.Save();

        //        foreach (var b in coll)
        //        {

        //            //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", entity.TransactionNo));
        //            decimal totalDebit = 0;
        //            decimal totalCredit = 0;


        //            int dAccount = 0;
        //            int dSubLedgerId = 0;

        //            ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
        //            ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
        //            ItemQuery itemQuery = new ItemQuery("i");

        //            eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"));
        //            eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
        //            eItemQuery.Where(eItemQuery.TransactionNo == b.TransactionNo);
        //            if (!eItems.Load(eItemQuery))
        //               return 0;

        //            var z = new ItemTransaction();
        //            if (!z.LoadByPrimaryKey(b.TransactionNo)) return 0;

        //            decimal dAmt = 0;
        //            decimal cAmt = 0;
        //            foreach (var p in eItems)
        //            {
        //                dAmt = (p.Quantity.Value * p.Price.Value) + ( z.TaxPercentage.Value / 100 * (p.Quantity.Value * p.Price.Value));

        //                string itemId = p.ItemID;
        //                Item itemInv = new Item();
        //                itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
        //                if (itemInv.Query.Load())
        //                {
        //                    ProductAccount proacc = new ProductAccount();
        //                    if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
        //                    {
        //                        dAccount = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
        //                        dSubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
        //                    }
        //                }
        //                if (dAccount == 0)
        //                    return 0;


        //                JournalTransactionDetails d = new JournalTransactionDetails();
        //                d.AddNew();
        //                d.JournalId = entity.JournalId;
        //                d.ChartOfAccountId = dAccount;
        //                d.SubLedgerId = dSubLedgerId;
        //                d.Debit = dAmt;
        //                d.Credit = 0;
        //                d.Description = string.Format("RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.InvoiceNo, supplierName, p.ItemName);
        //                d.DocumentNumber = e.InvoiceNo;
        //                d.Save();

        //                totalDebit += d.Debit.Value;

        //                cAmt += dAmt;
        //            }

        //            JournalTransactionDetails c = new JournalTransactionDetails();
        //            c.AddNew();
        //            c.JournalId = entity.JournalId;
        //            c.ChartOfAccountId = cAccount;
        //            c.SubLedgerId = cSubledgerId;
        //            c.Debit = 0;
        //            c.Credit = cAmt;
        //            c.Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.InvoiceNo, supplierName);
        //            c.DocumentNumber = e.InvoiceNo;
        //            c.Save();

        //            totalCredit = c.Credit.Value;
        //        }

        //        return entity.JournalId;
        //    }
        //    catch (Exception ex)
        //    {
        //        //Logger.LogException(ex);
        //        return -1;

        //    }
        //}

        public static int? AddNewPurchaseOrderReceivedNonMasterJournal_(ItemTransaction e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.PurchaseOrderReceived;


            //Logger.EnterMethod("AddNewPurchaseOrderReceivedJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", entity.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0; //GetCachedAccountFromParam("coa_ApInProcess"); // later must find this account from supplier
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"));
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                string supplierName = string.Empty;
                Supplier sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
                    return 0;

                supplierName = sup.SupplierName;
                if (sup.ChartOfAccountIdAP.HasValue)
                {
                    cAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                    cSubledgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;
                }

                if (cAccount == 0)
                    return 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                var proacc = new ProductAccountGuarantorGroup();
                proacc.Query.Where(proacc.Query.ProductAccountID == e.ProductAccountID,
                    proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                if (proacc.Load(proacc.Query))
                {
                    //ProductAccount proacc = new ProductAccount();
                    //if (proacc.LoadByPrimaryKey(e.ProductAccountID))
                    //{
                    dAccount = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                    dSubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                }

                if (dAccount == 0)
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PO", e.TransactionDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = e.TransactionDate;
                entity.Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = e.TransactionNo;
                entity.Save();

                decimal dAmt = 0;
                decimal cAmt = 0;
                foreach (var p in eItems)
                {
                    dAmt = (p.Quantity.Value * p.Price.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.Price.Value));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = dAmt;
                    d.Credit = 0;
                    d.Description = string.Format("RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName);
                    d.DocumentNumber = e.TransactionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;

                    cAmt += dAmt;
                }

                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = cAccount;
                c.SubLedgerId = cSubledgerId;
                c.Debit = 0;
                c.Credit = cAmt;
                c.Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName);
                c.DocumentNumber = e.TransactionNo;
                c.Save();

                totalCredit = c.Credit.Value;

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                //if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                //{
                //    entity.BeginEdit();
                //    entity.IsPosted = true;
                //    entity.EndEdit();
                //    entity.Save();
                //}

                //Logger.LeaveMethod("AddNewPurchaseOrderReceivedJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewPurchaseOrderReturnedJournal(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.PurchaseOrderReturned;

            //Logger.EnterMethod("AddNewPurchaseOrderReturnedJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", entity.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                bool IsPpnJournaled = false;
                if (e.SRItemType == "11")
                {
                    IsPpnJournaled = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsPpnPurchasing);
                }
                else
                {
                    IsPpnJournaled = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsPpnPurchasingNonMedical);
                }

                int dVatInCoaId = GetCachedAccountFromParam("coa_Ppn");
                int dVatInCoaIdNonMedic = GetCachedAccountFromParam("coa_PpnNonMedic");
                int cDiscountCoaId = GetCachedAccountFromParam("coa_PurchaseDiscount");

                int cInventoryCoaId = 0;
                int cInventorySubLedgerId = 0;
                int dAccountM = 0, dAccountNM = 0; //GetCachedAccountFromParam("coa_ApInProcess"); // later must find this account from supplier
                int dSubLedgerIdM = 0, dSubLedgerIdNM = 0;

                ServiceUnit su = new ServiceUnit();
                if (!su.LoadByPrimaryKey(e.FromServiceUnitID))
                    return 0;

                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemTransactionQuery itQuery = new ItemTransactionQuery("a");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.Coalesce(eItemQuery.Description).As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itQuery).On(eItemQuery.TransactionNo == itQuery.TransactionNo);
                eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var supplierName = string.Empty;
                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.BusinessPartnerID))
                    return 0;

                ServiceUnit toServiceUnit = new ServiceUnit();
                //var svcID = (!(e.IsInventoryItem ?? false) || (e.IsNonMasterOrder ?? false)) ?
                //    (string.IsNullOrEmpty(e.ServiceUnitCostID) ? e.FromServiceUnitID : e.ServiceUnitCostID) : e.FromServiceUnitID;

                //db: 3 juli 2023, u/ jasa / biaya, subledger mengikuti subledger POR
                string svcID;
                if (!(e.IsInventoryItem ?? false) || (e.IsNonMasterOrder ?? false))
                {
                    var refTx = new ItemTransaction();
                    if (refTx.LoadByPrimaryKey(e.ReferenceNo))
                        svcID = (string.IsNullOrEmpty(refTx.ServiceUnitCostID) ? refTx.ToServiceUnitID : refTx.ServiceUnitCostID);
                    else
                        svcID = (string.IsNullOrEmpty(e.ServiceUnitCostID) ? e.FromServiceUnitID : e.ServiceUnitCostID);
                }
                else
                    svcID = e.FromServiceUnitID;
                //--

                if (!toServiceUnit.LoadByPrimaryKey(svcID))
                    return 0;

                supplierName = sup.SupplierName;
                string sAPident = string.Empty;
                if (sup.ChartOfAccountIdAP.HasValue)
                {
                    dAccountM = sup.ChartOfAccountIdPOReturn.HasValue ? sup.ChartOfAccountIdPOReturn.Value : 0;
                    dSubLedgerIdM = sup.SubledgerIdPOReturn.HasValue ? sup.SubledgerIdPOReturn.Value : 0;

                    dAccountNM = sup.ChartOfAccountIdPOReturnNonMedic.HasValue ? sup.ChartOfAccountIdPOReturnNonMedic.Value : 0;
                    dSubLedgerIdNM = sup.SubledgerIdPOReturnNonMedic.HasValue ? sup.SubledgerIdPOReturnNonMedic.Value : 0;
                }

                //Journal Header
                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //header.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    var appprmdate = new AppParameter();
                    DateTime jDate = DateTime.Now;
                    if (appprmdate.LoadByPrimaryKey("acc_JournalPORetDate"))
                        jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                            e.TransactionDate.Value.Date : e.ApprovedDate.Value.Date;

                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("RET", jDate);
                    header.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(header.JournalCode);
                    header.TransactionDate = jDate;
                    header.Description = string.Format("RET#:{0}. SUP:{1}.", e.TransactionNo, supplierName);
                    header.IsPosted = false;
                    header.DateCreated = header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = header.CreatedBy = header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = e.TransactionNo;
                    header.Save();

                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                decimal dAmt = 0;
                decimal cAmt = 0;
                decimal taxAmount = 0, pphAmount = 0;
                var isMedic = e.SRItemType == "11";

                taxAmount = decimal.Round(Abs((decimal)e.TaxAmount.Value), 2);
                var discGolobal = decimal.Round((decimal)e.DiscountAmount.Value, 2);
                // pph by stdref
                pphAmount = e.PphAmount.HasValue ? e.PphAmount.Value * e.CurrencyRate.Value : 0;

                foreach (var p in eItems)
                    //dAmt += (p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value);
                    dAmt += (p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value) +
                        (e.TaxPercentage.Value / 100 * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value)));


                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = header.JournalId;
                d.ChartOfAccountId = ValidateCOA(isMedic ? dAccountM : dAccountNM, coaColl, string.Format("Supplier {0}: Chart Of Account Id PO Return {1}", sup.SupplierName, isMedic ? "Medical" : "Non Medical"));
                d.SubLedgerId = isMedic ? dSubLedgerIdM : dSubLedgerIdNM;
                //d.Debit = dAmt + taxAmount + pphAmount + discGolobal;
                d.Debit = dAmt + pphAmount + discGolobal;
                d.Credit = 0;
                d.Description = string.Format("RET#:{0}. SUP:{1}. POR#:{2}", e.TransactionNo, supplierName, e.ReferenceNo);
                d.DocumentNumber = e.TransactionNo;
                AddMoreInfo(d, string.Empty, string.Empty, sup.SupplierID, string.Empty, null,
                    su.ServiceUnitID, string.Empty, string.Empty);
                d.Save();

                totalDebit += d.Debit.Value;
                totalCredit += d.Credit.Value;

                // discount global
                if (discGolobal < 0)
                {
                    var glob = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(cDiscountCoaId, coaColl, "App Parameter: coa_PurchaseDiscount (Global Discount)"),
                        SubLedgerId = 0,
                        Debit = -decimal.Round((decimal)discGolobal, 2),
                        Credit = 0,
                        Description = string.Format("DISC. GLOBAL RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(glob, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        su.ServiceUnitID, string.Empty, string.Empty);
                    glob.AddNew();
                    glob.Save();
                    totalDebit += glob.Debit.Value;
                    totalCredit += glob.Credit.Value;
                }

                // pph by stdref
                //var pph = e.PphAmount.HasValue ? e.PphAmount.Value * e.CurrencyRate.Value : 0;
                if (pphAmount < 0)
                {
                    var stdRef = new AppStandardReferenceItem();
                    stdRef.Query.Where(stdRef.Query.StandardReferenceID == "Pph",
                        stdRef.Query.ItemID == e.SRPph);
                    stdRef.Load(stdRef.Query);

                    pphAmount = decimal.Round((decimal)pphAmount, 2);

                    var vatPPh = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(stdRef.coaID, coaColl, "Standard Reference: Pph: " + stdRef.ItemName),
                        SubLedgerId = 0,
                        Debit = pphAmount < 0 ? -pphAmount : 0,
                        Credit = pphAmount >= 0 ? pphAmount : 0,
                        Description = string.Format("Tax for RET #:{0}. SUP:{1}. VAT {2} ", e.TransactionNo, supplierName, stdRef.ItemName),
                        DocumentNumber = e.TransactionNo
                    };
                    AddMoreInfo(vatPPh, string.Empty, string.Empty, e.BusinessPartnerID, string.Empty, null,
                        su.ServiceUnitID, string.Empty, string.Empty);
                    vatPPh.AddNew();
                    vatPPh.Save();

                    totalDebit += vatPPh.Debit.Value;
                    totalCredit += vatPPh.Credit.Value;
                }

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                var imColl = new ItemMovementCollection();
                imColl.Query.Where(imColl.Query.TransactionNo == e.TransactionNo);
                imColl.LoadAll();

                string paMsg = string.Empty;
                foreach (var p in eItems)   
                {
                    var itemId = p.ItemID;
                    var itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    itemInv.Query.Load();

                    var iMed = new ItemProductMedic();
                    var iNonMed = new ItemProductNonMedic();
                    var iKitc = new ItemKitchen();
                    var isInventory = true;

                    switch (itemInv.SRItemType)
                    {
                        case "11":
                            {
                                iMed.LoadByPrimaryKey(p.ItemID);
                                isInventory = iMed.IsInventoryItem ?? false;
                                break;
                            }
                        case "21":
                            {
                                iNonMed.LoadByPrimaryKey(p.ItemID);
                                isInventory = iNonMed.IsInventoryItem ?? false;
                                break;
                            }
                        case "81":
                            {
                                iKitc.LoadByPrimaryKey(p.ItemID);
                                isInventory = iKitc.IsInventoryItem ?? false;
                                break;
                            }
                    }

                    var pac = new ProductAccount();
                    var proacc = new ProductAccountGuarantorGroup();
                    var coaCostCorrection = 0;
                    var slCostCorrection = 0;
                    string costCorrMsg = string.Empty;
                    proacc.Query.Where(proacc.Query.ProductAccountID == p.ProductAccountId,
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        pac.LoadByPrimaryKey(proacc.ProductAccountID);

                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(p.ProductAccountId))
                        //{
                        cInventoryCoaId = su.SRRegistrationType == "IPR" ? (proacc.ChartOfAccountIdInventoryIP ?? 0) : (proacc.ChartOfAccountIdInventory ?? 0);
                        cInventorySubLedgerId = su.SRRegistrationType == "IPR" ? (proacc.SubledgerIdInventoryIP ?? 0) : (proacc.SubledgerIdInventory ?? 0);

                        coaCostCorrection = su.SRRegistrationType == "IPR" ? (proacc.ChartOfAccountIdCOGSIP ?? 0) : (proacc.ChartOfAccountIdCOGS ?? 0);
                        slCostCorrection = su.SRRegistrationType == "IPR" ? (proacc.SubledgerIdCOGSIP ?? 0) : (proacc.SubledgerIdCOGS ?? 0);

                        paMsg = "ProductAccount: " + pac.ProductAccountName;
                        costCorrMsg = string.Format("ProductAccount: {0}, {1}", pac.ProductAccountName, su.SRRegistrationType == "IPR" ? "ChartOfAccountIdCOGSIP" : "ChartOfAccountIdCOGS");
                    }


                    ///////////////////
                    bool isCost = true;
                    if (!e.IsNonMasterOrder ?? false)
                    {
                        if (isInventory || (e.IsAssets ?? false))
                        {
                            isCost = false;
                            //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                            AppParameter app = new AppParameter();
                            app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                            if (app.ParameterValue == "Yes")
                            {
                                //Matrix COA Unit 
                                ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                                supam.Query.Where(supam.Query.LocationId == e.ToLocationID, supam.Query.ServiceUnitId == /*e.ToServiceUnitID*/ toServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
                                if (supam.Query.Load())
                                {
                                    cInventoryCoaId = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                    cInventorySubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                                }
                                else
                                {
                                    cInventoryCoaId = 0;
                                    cInventorySubLedgerId = 0;
                                }
                                paMsg = string.Format("Service Unit Product Account Mapping: Service unit {0}, product account {1}", toServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            }
                        }
                        else
                        {
                            isCost = true;
                        }
                    }

                    if (isCost)
                    {
                        // non inventory / non master langsung jadi biaya
                        if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                        {
                            cInventoryCoaId = toServiceUnit.ChartOfAccountIdCost.HasValue ? toServiceUnit.ChartOfAccountIdCost.Value : 0;
                            cInventorySubLedgerId = toServiceUnit.SubledgerIdCost.HasValue ? toServiceUnit.SubledgerIdCost.Value : 0;
                            paMsg = string.Format("Service unit {0}: COA Cost Medic", toServiceUnit.ServiceUnitName);
                        }
                        else
                        {
                            cInventoryCoaId = toServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? toServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                            cInventorySubLedgerId = toServiceUnit.SubledgerIdCostNonMedic.HasValue ? toServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                            paMsg = string.Format("Service unit {0}: COA Cost Non Medic", toServiceUnit.ServiceUnitName);
                        }

                        AppParameter ap2 = new AppParameter();
                        ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                        if (ap2.ParameterValue == "Yes")
                        {
                            var pacc = e.IsNonMasterOrder ?? false ? e.ProductAccountID : p.ProductAccountId;
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();

                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, 
                            //    supam.Query.ServiceUnitId == e.ToServiceUnitID, 
                            //    supam.Query.ProductAccountId == p.ProductAccountId, 
                            //    supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                            supam.Query.Where(supam.Query.ServiceUnitId == toServiceUnit.ServiceUnitID,
                                supam.Query.ProductAccountId == pacc,
                                supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType))
                                .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                            supam.Query.es.Top = 1;

                            paMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                        toServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            if (supam.Query.Load())
                            {
                                cInventoryCoaId = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                cInventorySubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                cInventoryCoaId = 0;
                                cInventorySubLedgerId = 0;
                            }
                        }
                    }
                    ///////////////////

                    //if (!e.IsNonMasterOrder ?? false)
                    //{
                    //    //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                    //    AppParameter app = new AppParameter();
                    //    app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                    //    if (app.ParameterValue == "Yes")
                    //    {
                    //        //Matrix COA Unit 
                    //        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                    //        supam.Query.Where(supam.Query.LocationId == e.FromLocationID, supam.Query.ServiceUnitId == e.FromServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (su.SRRegistrationType == string.Empty ? "OPR" : su.SRRegistrationType));
                    //        if (supam.Query.Load())
                    //        {
                    //            cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                    //            cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                    //            sCreditCOAmsg = "ServiceUnitProductAccountMapping: ProductAccount " + pac.ProductAccountName + " Service Unit " + su.ServiceUnitName;
                    //        }
                    //    }
                    //}
                    //else
                    //{
                    //    var pacTrans = new ProductAccount();
                    //    var proaccTrans = new ProductAccountGuarantorGroup();
                    //    proaccTrans.Query.Where(proaccTrans.Query.ProductAccountID == e.ProductAccountID,
                    //        proaccTrans.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    //    if (proaccTrans.Load(proaccTrans.Query))
                    //    {
                    //        pacTrans.LoadByPrimaryKey(proaccTrans.ProductAccountID);
                    //        //var proaccTrans = new ProductAccount();
                    //        //if (proaccTrans.LoadByPrimaryKey(e.ProductAccountID))
                    //        //{
                    //        cAccount = proaccTrans.ChartOfAccountIdInventory.HasValue ? proaccTrans.ChartOfAccountIdInventory.Value : 0;
                    //        cSubledgerId = proaccTrans.SubledgerIdInventory.HasValue ? proaccTrans.SubledgerIdInventory.Value : 0;
                    //        sCreditCOAmsg = "ProductAccount: " + pacTrans.ProductAccountName;
                    //    }
                    //}

                    if (IsPpnJournaled)
                    {
                        cAmt = (p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value);
                    }
                    else
                    {
                        cAmt = (p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value) +
                        (e.TaxPercentage.Value / 100 * ((p.Quantity.Value * p.PriceInCurrency.Value) - (p.Quantity.Value * p.DiscountInCurrency.Value)));
                    }

                    decimal selisihCAmt = 0;
                    if (imColl.Any())
                    {
                        var imi = imColl.Where(im => im.ItemID == itemId);
                        if (imi.Any())
                        {
                            selisihCAmt = cAmt;
                            cAmt = imi.Sum(im => (im.CostPrice ?? 0) * (im.QuantityOut ?? 0));
                            selisihCAmt = selisihCAmt - cAmt;
                        }
                    }

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = header.JournalId;
                    c.ChartOfAccountId = ValidateCOA(cInventoryCoaId, coaColl, string.Format("{0}", paMsg));
                    c.SubLedgerId = cInventorySubLedgerId;
                    c.Debit = 0;
                    c.Credit = cAmt;
                    c.Description = string.Format("RET#:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName);
                    c.DocumentNumber = e.TransactionNo;
                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, sup.SupplierID, string.Empty, null,
                        su.ServiceUnitID, p.ItemID, string.Empty, p.SequenceNo);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;

                    // selisih
                    if (selisihCAmt != 0)
                    {
                        JournalTransactionDetails cost = new JournalTransactionDetails();
                        cost.AddNew();
                        cost.JournalId = header.JournalId;
                        cost.ChartOfAccountId = ValidateCOA(coaCostCorrection, coaColl, string.Format("{0}", costCorrMsg));
                        cost.SubLedgerId = slCostCorrection;
                        cost.Debit = (selisihCAmt < 0 ? (-selisihCAmt) : 0);
                        cost.Credit = (selisihCAmt > 0 ? selisihCAmt : 0);
                        cost.Description = string.Format("RET#:{0}. SUP:{1}. ITEM#:{2}. Koreksi biaya", e.TransactionNo, supplierName, p.ItemName);
                        cost.DocumentNumber = e.TransactionNo;
                        AddMoreInfo(cost, string.Empty, string.Empty, string.Empty, string.Empty, sup.SupplierID, string.Empty, null,
                            su.ServiceUnitID, p.ItemID, string.Empty, p.SequenceNo);
                        cost.Save();

                        totalDebit += cost.Debit.Value;
                        totalCredit += cost.Credit.Value;
                    }
                }

                // pajak
                if (IsPpnJournaled)
                {
                    if (e.SRItemType == "11")
                    {
                        if (taxAmount != 0)
                        {
                            bool coaPpnFromSU = false;
                            // PPN khusus obat alkes dibedain antara ppn rawat inap dan rawat jalan
                            var suPPN = new ServiceUnit();
                            if (suPPN.LoadByPrimaryKey(e.FromServiceUnitID))
                            {
                                if ((suPPN.ChartOfAccountIdPpnIn ?? 0) != 0)
                                {
                                    dVatInCoaId = suPPN.ChartOfAccountIdPpnIn.Value;
                                    coaPpnFromSU = true;
                                }
                            }

                            var tax = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = ValidateCOA(dVatInCoaId, coaColl, coaPpnFromSU ? string.Format("Service Unit: {0}: Chart Of Account Ppn In", suPPN.ServiceUnitName) : "App Parameter: coa_Ppn"),
                                SubLedgerId = 0,
                                Debit = 0,
                                Credit = taxAmount,
                                Description = string.Format("Tax for RET#:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                                DocumentNumber = e.TransactionNo
                            };
                            AddMoreInfo(tax, string.Empty, string.Empty, sup.SupplierID, string.Empty, null,
                                su.ServiceUnitID, string.Empty, string.Empty);
                            tax.AddNew();
                            tax.Save();
                            totalDebit += tax.Debit.Value;
                            totalCredit += tax.Credit.Value;
                        }
                    }
                    else
                    {
                        if (taxAmount > 0)
                        {
                            bool coaPpnFromSU = false;
                            // PPN khusus obat alkes dibedain antara ppn rawat inap dan rawat jalan
                            var suPPN = new ServiceUnit();
                            if (suPPN.LoadByPrimaryKey(e.FromServiceUnitID))
                            {
                                if ((suPPN.ChartOfAccountIdPpnIn ?? 0) != 0)
                                {
                                    dVatInCoaIdNonMedic = suPPN.ChartOfAccountIdPpnIn.Value;
                                    coaPpnFromSU = true;
                                }
                            }

                            var tax = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = ValidateCOA(dVatInCoaIdNonMedic, coaColl, coaPpnFromSU ? string.Format("Service Unit: {0}: Chart Of Account Ppn In", suPPN.ServiceUnitName) : "App Parameter: coa_PpnNonMedic"),
                                SubLedgerId = 0,
                                Debit = 0,
                                Credit = taxAmount,
                                Description = string.Format("Tax for RET #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                                DocumentNumber = e.TransactionNo
                            };
                            AddMoreInfo(tax, string.Empty, string.Empty, sup.SupplierID, string.Empty, null,
                                su.ServiceUnitID, string.Empty, string.Empty);
                            tax.AddNew();
                            tax.Save();
                            totalDebit += tax.Debit.Value;
                            totalCredit += tax.Credit.Value;
                        }
                    }
                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                // settingan autoapprove ngikut PO Received aja supaya tidak banyak settingan
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPOReceived) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }
                //Logger.LeaveMethod("AddNewPurchaseOrderReturnedJournal");
                return header.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        //jurnal ini dipanggil saat distribution confirm
        //public static int? AddNewDistributionLocationBasedJournal(ItemTransaction e, string editedBy, int journalId)
        //{
        //    if (!IsAutoJournalEnabled())
        //        return 0;

        //    string journalType = Temiang.Avicenna.BusinessObject.JournalType.Distribution;

        //    //Logger.EnterMethod("AddNewDistributionJournal");
        //    try
        //    {
        //        //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
        //        decimal totalDebit = 0;
        //        decimal totalCredit = 0;

        //        int cAccount = 0;
        //        int cSubledgerId = 0;
        //        int dAccount = 0;
        //        int dSubLedgerId = 0;

        //        // TO
        //        ServiceUnit toServiceUnit = new ServiceUnit();
        //        if (!toServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID))
        //            return 0;

        //        string toLocationId = e.ToLocationID;
        //        if (string.IsNullOrEmpty(toLocationId))
        //            toLocationId = toServiceUnit.GetMainLocationId(toServiceUnit.ServiceUnitID);

        //        Location toLocation = new Location();

        //        if (!toLocation.LoadByPrimaryKey(toLocationId))
        //            return 0;


        //        // FROM
        //        ItemTransaction fromItemTransaction = new ItemTransaction();
        //        if (!fromItemTransaction.LoadByPrimaryKey(e.TransactionNo))
        //            return 0;

        //        ServiceUnit fromServiceUnit = new ServiceUnit();
        //        if (!fromServiceUnit.LoadByPrimaryKey(fromItemTransaction.FromServiceUnitID))
        //            return 0;

        //        string fromLocationId = e.FromLocationID;
        //        if (string.IsNullOrEmpty(fromLocationId))
        //            fromLocationId = fromServiceUnit.GetMainLocationId(fromServiceUnit.ServiceUnitID);

        //        Location fromLocation = new Location();

        //        if (!fromLocation.LoadByPrimaryKey(fromLocationId))
        //            return 0;


        //        ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
        //        ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
        //        ItemTransactionQuery itm = new ItemTransactionQuery("it");
        //        ItemQuery itemQuery = new ItemQuery("i");
        //        ProductAccountQuery prod = new ProductAccountQuery("p");
        //        LocationQuery supF = new LocationQuery("locF");
        //        LocationQuery supT = new LocationQuery("locT");

        //        eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
        //        eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
        //        eItemQuery.InnerJoin(itm).On(eItemQuery.TransactionNo == itm.TransactionNo);
        //        eItemQuery.InnerJoin(prod).On(itemQuery.ProductAccountID == prod.ProductAccountID);
        //        eItemQuery.InnerJoin(supF).On(itm.FromLocationID == supF.LocationID);
        //        eItemQuery.InnerJoin(supT).On(itm.ToLocationID == supT.LocationID);
        //        eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
        //        if (!eItems.Load(eItemQuery))
        //            return 0;

        //        //Journal Header
        //        JournalTransactions entity = new JournalTransactions();
        //        if (entity.LoadByPrimaryKey(journalId))
        //        {
        //            var journalDetails = new JournalTransactionDetailsCollection();
        //            journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
        //            journalDetails.LoadAll();
        //            journalDetails.MarkAllAsDeleted();
        //            journalDetails.Save();

        //            // rejournal tidak usah update last update
        //            entity.LastUpdateDateTime = DateTime.Now;
        //            //entity.LastUpdateByUserID = editedBy;
        //        }
        //        else
        //        {
        //            entity.AddNew();
        //            entity.JournalType = journalType;
        //            entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", e.TransactionDate.Value);
        //            entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
        //            entity.TransactionDate = e.TransactionDate;
        //            entity.Description = string.Format("DIST #:{0}. FROM/TO:{1}-{2}/{3}-{4}.", e.TransactionNo, fromServiceUnit.ServiceUnitID, fromServiceUnit.ServiceUnitName, toServiceUnit.ServiceUnitID, toServiceUnit.ServiceUnitName);
        //            entity.IsPosted = false;
        //            entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
        //            entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
        //            entity.RefferenceNumber = e.TransactionNo;
        //        }
        //        entity.Save();

        //        foreach (var p in eItems)
        //        {
        //            //Matrix COA Unit Asal (From)
        //            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
        //            supam.Query.Where(supam.Query.LocationId == e.FromLocationID, supam.Query.ServiceUnitId == e.FromServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (fromServiceUnit.SRRegistrationType == string.Empty ? "OPR" : fromServiceUnit.SRRegistrationType));
        //            if (supam.Query.Load())
        //            {
        //                cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
        //                cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
        //            }

        //            //Matrix COA Unit Tujuan (To)
        //            ServiceUnitProductAccountMapping supam2 = new ServiceUnitProductAccountMapping();
        //            supam2.Query.Where(supam2.Query.LocationId == e.ToLocationID, supam2.Query.ServiceUnitId == e.ToServiceUnitID, supam2.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
        //            if (supam2.Query.Load())
        //            {
        //                dAccount = supam2.ChartOfAccountIdInventory.HasValue ? supam2.ChartOfAccountIdInventory.Value : 0;
        //                dSubLedgerId = supam2.SubledgerIdInventory.HasValue ? supam2.SubledgerIdInventory.Value : 0;
        //            }



        //            decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

        //            JournalTransactionDetails d = new JournalTransactionDetails();
        //            d.AddNew();
        //            d.JournalId = entity.JournalId;
        //            d.ChartOfAccountId = dAccount;
        //            d.SubLedgerId = dSubLedgerId;
        //            d.Debit = amt;
        //            d.Credit = 0;
        //            d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
        //            d.DocumentNumber = e.TransactionNo;
        //            d.Save();

        //            totalDebit += d.Debit.Value;

        //            JournalTransactionDetails c = new JournalTransactionDetails();
        //            c.AddNew();
        //            c.JournalId = entity.JournalId;
        //            c.ChartOfAccountId = cAccount;
        //            c.SubLedgerId = cSubledgerId;
        //            c.Debit = 0;
        //            c.Credit = amt;
        //            c.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
        //            c.DocumentNumber = e.TransactionNo;
        //            c.Save();

        //            totalCredit += c.Credit.Value;
        //        }

        //        //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

        //        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
        //        {
        //            entity.BeginEdit();
        //            entity.IsPosted = true;
        //            entity.EndEdit();
        //            entity.Save();
        //        }

        //        //Logger.LeaveMethod("AddNewDistributionJournal");
        //        return entity.JournalId;
        //    }
        //    catch (Exception ex)
        //    {
        //        //Logger.LogException(ex);
        //        return -1;

        //    }
        //}

        // This function will be called when Distribution Confirmation approved!

        public static int? AddNewDistributionConfirmJournal(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            var appDis = new AppParameter();
            if (appDis.LoadByPrimaryKey("acc_IsAutoJournalDistribution"))
            { // validasi jangan dihilangkan
                if (!AppParameter.IsYes(appDis.ParameterValue))
                {
                    return 0;
                }
            }

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.Distribution;

            try
            {
                if (e.TransactionCode != TransactionCode.DistributionConfirm &&
                    e.TransactionCode != TransactionCode.Distribution)
                    throw new Exception(string.Format("Transaction number {0} is not a valid distribution / distribution confirm", e.TransactionNo));

                bool IsConfirm = e.TransactionCode == TransactionCode.DistributionConfirm;

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("DIST #:{0}. FROM {1} TO {2}.", e.TransactionNo, "Unknown", "Unknown");
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                // TO
                ServiceUnit toServiceUnit = new ServiceUnit();
                string toLocationId = "";
                Location toLocation = new Location();

                ServiceUnit fromServiceUnit = new ServiceUnit();
                string fromLocationId = "";
                Location fromLocation = new Location();

                if (IsConfirm)
                {
                    if (!toServiceUnit.LoadByPrimaryKey(e.FromServiceUnitID))
                        throw new Exception(string.Format("Service Unit {0} Not Found", e.FromServiceUnitID));

                    toLocationId = e.FromLocationID;
                    if (string.IsNullOrEmpty(toLocationId))
                        toLocationId = toServiceUnit.GetMainLocationId(toServiceUnit.ServiceUnitID);

                    if (!toLocation.LoadByPrimaryKey(toLocationId))
                        throw new Exception(string.Format("Location {0} Not Found", toLocationId));

                    // FROM
                    ItemTransaction fromItemTransaction = new ItemTransaction();
                    if (!fromItemTransaction.LoadByPrimaryKey(e.ReferenceNo))
                        throw new Exception(string.Format("Reference {0} of distribution confirm is not found", e.ReferenceNo));

                    if (!fromServiceUnit.LoadByPrimaryKey(fromItemTransaction.FromServiceUnitID))
                        throw new Exception(string.Format("Service Unit {0} Not Found", fromItemTransaction.FromServiceUnitID));

                    fromLocationId = fromItemTransaction.FromLocationID;
                    if (string.IsNullOrEmpty(fromLocationId))
                        fromLocationId = fromServiceUnit.GetMainLocationId(fromServiceUnit.ServiceUnitID);

                    if (!fromLocation.LoadByPrimaryKey(fromLocationId))
                        throw new Exception(string.Format("Location {0} Not Found", fromLocationId));
                }
                else
                {
                    if (!toServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID))
                        throw new Exception(string.Format("Service Unit {0} Not Found", e.ToServiceUnitID));

                    toLocationId = e.ToLocationID;
                    if (string.IsNullOrEmpty(toLocationId))
                        toLocationId = toServiceUnit.GetMainLocationId(toServiceUnit.ServiceUnitID);

                    if (!toLocation.LoadByPrimaryKey(toLocationId))
                        throw new Exception(string.Format("Location {0} Not Found", toLocationId));

                    if (!fromServiceUnit.LoadByPrimaryKey(e.FromServiceUnitID))
                        throw new Exception(string.Format("Service Unit {0} Not Found", e.FromServiceUnitID));

                    fromLocationId = e.FromLocationID;
                    if (string.IsNullOrEmpty(fromLocationId))
                        fromLocationId = fromServiceUnit.GetMainLocationId(fromServiceUnit.ServiceUnitID);

                    if (!fromLocation.LoadByPrimaryKey(fromLocationId))
                        throw new Exception(string.Format("Location {0} Not Found", fromLocationId));
                }

                entity.Description = string.Format("DIST #:{0}. FROM {1} TO {2}.",
                    e.TransactionNo, fromServiceUnit.ServiceUnitName, toServiceUnit.ServiceUnitName);
                entity.Save();

                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(
                    eItemQuery,
                    itemQuery.ItemName.As("refToItem_ItemName"),
                    itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    throw new Exception("Detail transaction not found");

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var p in eItems)
                {
                    int dAccount = 0, cAccount = 0;
                    int dSubledgerId = 0, cSubledgerId = 0;
                    string dMsg = "", cMsg = "";

                    var pac = new ProductAccount();
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == p.ProductAccountId,
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        pac.LoadByPrimaryKey(proacc.ProductAccountID);
                        switch (toServiceUnit.SRRegistrationType)
                        {
                            case "IPR":
                                dAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                dSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                dMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                dAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                dSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                dMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                dAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                dSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                dMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }
                        switch (fromServiceUnit.SRRegistrationType)
                        {
                            case "IPR":
                                cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }
                    }
                    else
                    {
                        throw new Exception(string.Format("Product account {0} not found in ProductAccountGuarantorGroup", p.ProductAccountId));
                    }

                    if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsUnitBasedProductAccount))
                    {
                        //Matrix COA Unit Tujuan (To)
                        ServiceUnitProductAccountMapping supam2 = new ServiceUnitProductAccountMapping();
                        supam2.Query.Where(
                            supam2.Query.LocationId == toLocation.LocationID,
                            supam2.Query.ServiceUnitId == toServiceUnit.ServiceUnitID,
                            supam2.Query.ProductAccountId == p.ProductAccountId,
                            supam2.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
                        if (supam2.Query.Load())
                        {
                            dAccount = supam2.ChartOfAccountIdInventory.HasValue ? supam2.ChartOfAccountIdInventory.Value : 0;
                            dSubledgerId = supam2.SubledgerIdInventory.HasValue ? supam2.SubledgerIdInventory.Value : 0;
                            dMsg = string.Format("Service Unit Product Account {0}, Service Unit {1}, Location {2}, Service Unit Registration Type: {3}: COA Inventory",
                                pac.ProductAccountName, toServiceUnit.ServiceUnitName,
                                toLocation.LocationName, (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
                        }

                        //Matrix COA Unit Asal (From)
                        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        supam.Query.Where(
                            supam.Query.LocationId == fromLocation.LocationID,
                            supam.Query.ServiceUnitId == fromServiceUnit.ServiceUnitID,
                            supam.Query.ProductAccountId == p.ProductAccountId,
                            supam.Query.SRRegistrationType == (fromServiceUnit.SRRegistrationType == string.Empty ? "OPR" : fromServiceUnit.SRRegistrationType));
                        if (supam.Query.Load())
                        {
                            cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                            cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                            cMsg = string.Format("Service Unit Product Account {0}, Service Unit {1}, Location {2}, Service Unit Registration Type: {3}: COA Inventory",
                                pac.ProductAccountName, fromServiceUnit.ServiceUnitName,
                                fromLocation.LocationName, (fromServiceUnit.SRRegistrationType == string.Empty ? "OPR" : fromServiceUnit.SRRegistrationType));
                        }
                    }

                    decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                    d.SubLedgerId = dSubledgerId;
                    d.Debit = amt >= 0 ? amt : 0;
                    d.Credit = amt < 0 ? -amt : 0;
                    d.Description = string.Format("TR#:{0}. ITEM:{1}. Distribution In", e.TransactionNo, p.ItemName);
                    d.DocumentNumber = e.TransactionNo;
                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            toServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg);
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = amt < 0 ? -amt : 0;
                    c.Credit = amt >= 0 ? amt : 0;
                    c.Description = string.Format("TR#:{0}. ITEM:{1}. Distribution Out", e.TransactionNo, p.ItemName);
                    c.DocumentNumber = e.TransactionNo;
                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            fromServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;
                }
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryDistribution) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }


        //public static int? AddNewDistributionJournal(ItemTransaction e, string editedBy)
        //{
        //    if (!IsAutoJournalEnabled())
        //        return 0;

        //    string journalType = Temiang.Avicenna.BusinessObject.JournalType.Distribution;

        //    //Logger.EnterMethod("AddNewDistributionJournal");
        //    try
        //    {
        //        //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
        //        decimal totalDebit = 0;
        //        decimal totalCredit = 0;

        //        int cAccount = 0;
        //        int cSubledgerId = 0;
        //        int dAccount = 0;
        //        int dSubLedgerId = 0;

        //        // TO
        //        ServiceUnit toServiceUnit = new ServiceUnit();
        //        if (!toServiceUnit.LoadByPrimaryKey(e.FromServiceUnitID))
        //            return 0;

        //        string toLocationId = e.FromLocationID;
        //        if (string.IsNullOrEmpty(toLocationId))
        //            toLocationId = toServiceUnit.GetMainLocationId(toServiceUnit.ServiceUnitID);

        //        Location toLocation = new Location();

        //        if (!toLocation.LoadByPrimaryKey(toLocationId))
        //            return 0;

        //        dAccount = toLocation.ChartOfAccountIdCOGS.HasValue ? toLocation.ChartOfAccountIdCOGS.Value : 0;
        //        dSubLedgerId = toLocation.SubledgerIdCOGS.HasValue ? toLocation.SubledgerIdCOGS.Value : 0;

        //        // FROM
        //        ItemTransaction fromItemTransaction = new ItemTransaction();
        //        if (!fromItemTransaction.LoadByPrimaryKey(e.ReferenceNo))
        //            return 0;

        //        ServiceUnit fromServiceUnit = new ServiceUnit();
        //        if (!fromServiceUnit.LoadByPrimaryKey(fromItemTransaction.FromServiceUnitID))
        //            return 0;

        //        string fromLocationId = fromItemTransaction.FromLocationID;
        //        if (string.IsNullOrEmpty(fromLocationId))
        //            fromLocationId = fromServiceUnit.GetMainLocationId(fromServiceUnit.ServiceUnitID);

        //        Location fromLocation = new Location();

        //        if (!fromLocation.LoadByPrimaryKey(fromLocationId))
        //            return 0;

        //        cAccount = fromLocation.ChartOfAccountIdCOGS.HasValue ? fromLocation.ChartOfAccountIdCOGS.Value : 0;
        //        cSubledgerId = fromLocation.SubledgerIdCOGS.HasValue ? fromLocation.SubledgerIdCOGS.Value : 0;


        //        ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
        //        ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
        //        ItemQuery itemQuery = new ItemQuery("i");

        //        eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"));
        //        eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
        //        eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
        //        if (!eItems.Load(eItemQuery))
        //            return 0;

        //        //Journal Header
        //        JournalTransactions entity = new JournalTransactions();
        //        entity.AddNew();
        //        entity.JournalType = journalType;
        //        entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", e.TransactionDate.Value);
        //        entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
        //        entity.TransactionDate = e.TransactionDate;
        //        entity.Description = string.Format("DIST #:{0}. FROM/TO:{1}/{2}.", e.TransactionNo, fromServiceUnit.ServiceUnitID, toServiceUnit.ServiceUnitID);
        //        entity.IsPosted = false;
        //        entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
        //        entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
        //        entity.RefferenceNumber = e.TransactionNo;
        //        entity.Save();

        //        foreach (var p in eItems)
        //        {
        //            decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

        //            JournalTransactionDetails d = new JournalTransactionDetails();
        //            d.AddNew();
        //            d.JournalId = entity.JournalId;
        //            d.ChartOfAccountId = dAccount;
        //            d.SubLedgerId = dSubLedgerId;
        //            d.Debit = amt;
        //            d.Credit = 0;
        //            d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
        //            d.DocumentNumber = e.TransactionNo;
        //            d.Save();

        //            totalDebit += d.Debit.Value;

        //            JournalTransactionDetails c = new JournalTransactionDetails();
        //            c.AddNew();
        //            c.JournalId = entity.JournalId;
        //            c.ChartOfAccountId = cAccount;
        //            c.SubLedgerId = cSubledgerId;
        //            c.Debit = 0;
        //            c.Credit = amt;
        //            d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
        //            c.DocumentNumber = e.TransactionNo;
        //            c.Save();

        //            totalCredit += c.Credit.Value;
        //        }

        //        //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

        //        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
        //        {
        //            entity.BeginEdit();
        //            entity.IsPosted = true;
        //            entity.EndEdit();
        //            entity.Save();
        //        }

        //        //Logger.LeaveMethod("AddNewDistributionJournal");
        //        return entity.JournalId;
        //    }
        //    catch (Exception ex)
        //    {
        //        //Logger.LogException(ex);
        //        return -1;

        //    }
        //}

        public static int? AddNewSalesToBranchJournal(ItemTransaction e, string editedBy, int journalId)
        {

            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.SalesToBranch;


            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;



                ServiceUnit FromServiceUnit = new ServiceUnit();
                if (!FromServiceUnit.LoadByPrimaryKey(e.FromServiceUnitID))
                    return 0;
                if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                {

                    dAccount = FromServiceUnit.ChartOfAccountIdCost.HasValue ? FromServiceUnit.ChartOfAccountIdCost.Value : 0;
                    dSubLedgerId = FromServiceUnit.SubledgerIdCost.HasValue ? FromServiceUnit.SubledgerIdCost.Value : 0;
                }
                else
                {
                    dAccount = FromServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? FromServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                    dSubLedgerId = FromServiceUnit.SubledgerIdCostNonMedic.HasValue ? FromServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                }
                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("STB", e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("SALES TO BRANCH #:{0}. SERVICE UNIT:{1}.", e.TransactionNo, FromServiceUnit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;
                }
                entity.Save();

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var p in eItems)
                {
                    //decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

                    string itemId = p.ItemID;
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //ProductAccount proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                            //{
                            //dAccount = proacc.ChartOfAccountIdCost.HasValue ? proacc.ChartOfAccountIdCost.Value : 0;
                            cAccount = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            cSubledgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                        }
                    }

                    //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                    AppParameter app = new AppParameter();
                    app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                    if (app.ParameterValue == "Yes")
                    {
                        //Matrix COA Unit 
                        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        supam.Query.Where(supam.Query.LocationId == FromServiceUnit.GetMainLocationId(FromServiceUnit.ServiceUnitID), supam.Query.ServiceUnitId == e.FromServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (FromServiceUnit.SRRegistrationType == string.Empty ? "OPR" : FromServiceUnit.SRRegistrationType));
                        if (supam.Query.Load())
                        {
                            cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                            cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                            dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;

                        }
                    }

                    if (cAccount == 0 || dAccount == 0)
                        return 0;

                    ItemMovementQuery mov = new ItemMovementQuery();
                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                    mov.Where(mov.TransactionNo == p.TransactionNo, mov.SequenceNo == p.SequenceNo, mov.ItemID == p.ItemID);
                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                    DataTable tbl = mov.LoadDataTable();

                    foreach (DataRow row in tbl.Rows)
                    {
                        decimal? amt = (decimal)row["Quantity"] * (decimal)row["CostPrice"] * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1);

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = dAccount;
                        d.SubLedgerId = dSubLedgerId;
                        d.Debit = amt;
                        d.Credit = 0;
                        d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
                        d.DocumentNumber = e.TransactionNo;
                        d.Save();

                        totalDebit += d.Debit.Value;

                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = cAccount;
                        c.SubLedgerId = cSubledgerId;
                        c.Debit = 0;
                        c.Credit = amt;
                        c.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
                        c.DocumentNumber = e.TransactionNo;
                        c.Save();

                        totalCredit += c.Credit.Value;
                    }

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }


                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        // This function will be called when Inventory Issue approved!
        public static int? AddNewInventoryIssueJournal(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryIssue;

            //Logger.EnterMethod("AddNewDistributionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("ISSUE #:{0}.", e.TransactionNo);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                string dMsg = string.Empty;
                string cMsg = string.Empty;

                //var suID = string.IsNullOrEmpty(e.ToServiceUnitID) ? e.FromServiceUnitID : e.ToServiceUnitID;
                var suID = string.IsNullOrEmpty(e.ServiceUnitCostID) ? (string.IsNullOrEmpty(e.ToServiceUnitID) ? e.FromServiceUnitID : e.ToServiceUnitID) : e.ServiceUnitCostID;
                ServiceUnit ToServiceUnit = new ServiceUnit();
                if (!ToServiceUnit.LoadByPrimaryKey(suID))
                    throw new Exception(string.Format("Invalid service unit {0}", suID));

                entity.Description = string.Format("ISSUE #:{0}. SERVICE UNIT:{1}.", e.TransactionNo, ToServiceUnit.ServiceUnitName);
                entity.Save();

                ServiceUnit FromServiceUnit = new ServiceUnit();
                if (!FromServiceUnit.LoadByPrimaryKey(e.FromServiceUnitID))
                    throw new Exception(string.Format("Invalid service unit {0}", e.FromServiceUnitID));

                AppParameter ap = new AppParameter();
                ap.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                if (ap.ParameterValue == "No")
                {
                    if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                    {
                        dAccount = ToServiceUnit.ChartOfAccountIdCost.HasValue ? ToServiceUnit.ChartOfAccountIdCost.Value : 0;
                        dSubLedgerId = ToServiceUnit.SubledgerIdCost.HasValue ? ToServiceUnit.SubledgerIdCost.Value : 0;
                        dMsg = string.Format("Service unit {0}: COA Cost Medic", ToServiceUnit.ServiceUnitName);
                    }
                    else
                    {
                        dAccount = ToServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? ToServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                        dSubLedgerId = ToServiceUnit.SubledgerIdCostNonMedic.HasValue ? ToServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                        dMsg = string.Format("Service unit {0}: COA Cost Non Medic", ToServiceUnit.ServiceUnitName);
                    }
                }
                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var p in eItems)
                {
                    //decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

                    string itemId = p.ItemID;
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        if (itemInv.ProductAccountID == null) throw new Exception(string.Format("Item {0}: Invalid product account", itemInv.ItemName));

                        var pac = new ProductAccount();
                        pac.LoadByPrimaryKey(itemInv.ProductAccountID);
                        switch (FromServiceUnit.SRRegistrationType)
                        {
                            case "IPR":
                                cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }

                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //ProductAccount proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                            //{
                            //--dAccount = proacc.ChartOfAccountIdCost.HasValue ? proacc.ChartOfAccountIdCost.Value : 0;
                            //cAccount = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            //cSubledgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                            switch (FromServiceUnit.SRRegistrationType)
                            {
                                case "IPR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                    cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                    if (proacc.ChartOfAccountIdCOGSIP.HasValue)
                                    {
                                        dAccount = proacc.ChartOfAccountIdCOGSIP.Value;
                                        dSubLedgerId = proacc.SubledgerIdCOGSIP.Value;
                                        dMsg = string.Format("Product Account {0}: Inpatient: COGS", pac.ProductAccountName);
                                    }
                                    break;
                                case "EMR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                    cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                    if (proacc.ChartOfAccountIdCOGSIGD.HasValue)
                                    {
                                        dAccount = proacc.ChartOfAccountIdCOGSIGD.Value;
                                        dSubLedgerId = proacc.SubledgerIdCOGSIGD.Value;
                                        dMsg = string.Format("Product Account {0}: Emergency: COGS", pac.ProductAccountName);
                                    }
                                    break;
                                case "OPR":
                                default:
                                    cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                    cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                    if (proacc.ChartOfAccountIdCOGS.HasValue)
                                    {
                                        dAccount = proacc.ChartOfAccountIdCOGS.Value;
                                        dSubLedgerId = proacc.SubledgerIdCOGS.Value;
                                        dMsg = string.Format("Product Account {0}: Outpatient: COGS", pac.ProductAccountName);
                                    }

                                    break;
                            }
                        }
                        //AppParameter ap2 = new AppParameter();
                        //ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                        //if (ap2.ParameterValue == "Yes")
                        //{
                        //    //Matrix COA Unit 
                        //    ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        //    //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                        //    //supam.Query.Where(supam.Query.ServiceUnitId == e.ToServiceUnitID, 
                        //    //  supam.Query.ProductAccountId == p.ProductAccountId, 
                        //    //  supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                        //    supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                        //        supam.Query.ProductAccountId == p.ProductAccountId,
                        //        supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType))
                        //        .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                        //    supam.Query.es.Top = 1;

                        //    dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                        //                ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                        //    if (supam.Query.Load())
                        //    {
                        //        dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                        //        dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                        //    }
                        //    else
                        //    {
                        //        supam.QueryReset();
                        //        supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                        //            supam.Query.ProductAccountId == p.ProductAccountId,
                        //            supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));

                        //        supam.Query.es.Top = 1;
                        //        if (supam.Query.Load())
                        //        {
                        //            dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                        //            dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                        //        }
                        //    }
                        //}
                        AppParameter ap2 = new AppParameter();
                        ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                        if (ap2.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMappingCollection supamColl = new ServiceUnitProductAccountMappingCollection();
                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            //supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID, 
                            //    supam.Query.ProductAccountId == pRow["ProductAccountID"].ToString(), 
                            //    supam.Query.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : SU.SRRegistrationType));
                            var supamq = new ServiceUnitProductAccountMappingQuery("supamq");
                            var sulq = new ServiceUnitLocationQuery("sulq");
                            supamq.InnerJoin(sulq).On(supamq.ServiceUnitId == sulq.ServiceUnitID && supamq.LocationId == sulq.LocationID)
                                .Where(supamq.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                    supamq.ProductAccountId == p.ProductAccountId,
                                    supamq.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType)))
                                    .OrderBy(supamq.ChartOfAccountIdExpense.Descending)
                                    .Select(supamq);

                            supamq.es.Top = 1;

                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                            ToServiceUnit.ServiceUnitName, pac.ProductAccountName);

                            if (supamColl.Load(supamq))
                            {
                                var supam = supamColl.First();
                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                var supam = new ServiceUnitProductAccountMapping();
                                //supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                    supam.Query.ProductAccountId == p.ProductAccountId,
                                    supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));
                                supam.Query.es.Top = 1;
                                if (supam.Query.Load())
                                {
                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                        }

                        //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                        AppParameter app = new AppParameter();
                        app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                        if (app.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            //supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            supam.Query.Where(supam.Query.ServiceUnitId == FromServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (FromServiceUnit.SRRegistrationType == string.Empty ? "OPR" : FromServiceUnit.SRRegistrationType));

                            if (supam.Query.Load())
                            {
                                cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                //supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));
                                supam.Query.Where(supam.Query.ServiceUnitId == FromServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (FromServiceUnit.SRRegistrationType == "MCU" ? "OPR" : FromServiceUnit.SRRegistrationType));
                                if (supam.Query.Load())
                                {
                                    cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                    cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                            //cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                            //    ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            //dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                            //    ToServiceUnit.ServiceUnitName, pac.ProductAccountName);

                            cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                                FromServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                FromServiceUnit.ServiceUnitName, pac.ProductAccountName);
                        }

                    }

                    //if (cAccount == 0 || dAccount == 0)
                    //    return 0;

                    ItemMovementQuery mov = new ItemMovementQuery();
                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                    mov.Where(mov.TransactionNo == p.TransactionNo, mov.SequenceNo == p.SequenceNo, mov.ItemID == p.ItemID);
                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                    DataTable tbl = mov.LoadDataTable();

                    if (tbl.Rows.Count == 0)
                    {
                        var r = tbl.NewRow();
                        r["Quantity"] = p.Quantity;
                        r["CostPrice"] = p.CostPrice;
                        tbl.Rows.Add(r);
                        tbl.AcceptChanges();
                    }

                    foreach (DataRow row in tbl.Rows)
                    {
                        decimal? amt = (decimal)row["Quantity"] * (decimal)row["CostPrice"] * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1);

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                        d.SubLedgerId = dSubLedgerId;
                        d.Debit = amt;
                        d.Credit = 0;
                        d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
                        d.DocumentNumber = e.TransactionNo;
                        AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        d.Save();

                        totalDebit += d.Debit.Value;

                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg); ;
                        c.SubLedgerId = cSubledgerId;
                        c.Debit = 0;
                        c.Credit = amt;
                        c.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
                        c.DocumentNumber = e.TransactionNo;
                        AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        c.Save();

                        totalCredit += c.Credit.Value;
                    }

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryIssue) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewInventoryIssueVoidJournal(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryIssue;

            //Logger.EnterMethod("AddNewDistributionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var suID = string.IsNullOrEmpty(e.ToServiceUnitID) ? e.FromServiceUnitID : e.ToServiceUnitID;
                ServiceUnit ToServiceUnit = new ServiceUnit();
                if (!ToServiceUnit.LoadByPrimaryKey(suID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("VOID ISSUE #:{0}. SERVICE UNIT:{1}.", e.TransactionNo, ToServiceUnit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                string dMsg = string.Empty;
                string cMsg = string.Empty;

                AppParameter ap = new AppParameter();
                ap.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                if (ap.ParameterValue == "No")
                {
                    if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                    {
                        dAccount = ToServiceUnit.ChartOfAccountIdCost.HasValue ? ToServiceUnit.ChartOfAccountIdCost.Value : 0;
                        dSubLedgerId = ToServiceUnit.SubledgerIdCost.HasValue ? ToServiceUnit.SubledgerIdCost.Value : 0;
                        dMsg = string.Format("Service unit {0}: COA Cost Medic", ToServiceUnit.ServiceUnitName);
                    }
                    else
                    {
                        dAccount = ToServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? ToServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                        dSubLedgerId = ToServiceUnit.SubledgerIdCostNonMedic.HasValue ? ToServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                        dMsg = string.Format("Service unit {0}: COA Cost Non Medic", ToServiceUnit.ServiceUnitName);
                    }
                }
                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var p in eItems)
                {
                    //decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

                    string itemId = p.ItemID;
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        if (itemInv.ProductAccountID == null) throw new Exception(string.Format("Item {0}: Invalid product account", itemInv.ItemName));

                        var pac = new ProductAccount();
                        pac.LoadByPrimaryKey(itemInv.ProductAccountID);
                        switch (ToServiceUnit.SRRegistrationType)
                        {
                            case "IPR":
                                cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }

                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //ProductAccount proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                            //{
                            //--dAccount = proacc.ChartOfAccountIdCost.HasValue ? proacc.ChartOfAccountIdCost.Value : 0;
                            //cAccount = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            //cSubledgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                            switch (ToServiceUnit.SRRegistrationType)
                            {
                                case "IPR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                    cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                    break;
                                case "EMR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                    cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                    break;
                                case "OPR":
                                default:
                                    cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                    cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                    break;
                            }
                        }
                        AppParameter ap2 = new AppParameter();
                        ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                        if (ap2.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            //supam.Query.Where(supam.Query.ServiceUnitId == e.ToServiceUnitID, 
                            //  supam.Query.ProductAccountId == p.ProductAccountId, 
                            //  supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                            supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                supam.Query.ProductAccountId == p.ProductAccountId,
                                supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType))
                                .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                            supam.Query.es.Top = 1;

                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                        ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            if (supam.Query.Load())
                            {
                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                    supam.Query.ProductAccountId == p.ProductAccountId,
                                    supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));

                                supam.Query.es.Top = 1;
                                if (supam.Query.Load())
                                {
                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                        }

                        //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                        AppParameter app = new AppParameter();
                        app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                        if (app.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                            if (supam.Query.Load())
                            {
                                cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));
                                if (supam.Query.Load())
                                {
                                    cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                    cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                            cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                                ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                        }

                    }

                    //if (cAccount == 0 || dAccount == 0)
                    //    return 0;

                    ItemMovementQuery mov = new ItemMovementQuery();
                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                               mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                    mov.Where(mov.TransactionNo == p.TransactionNo, mov.SequenceNo == p.SequenceNo, mov.ItemID == p.ItemID);
                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                    DataTable tbl = mov.LoadDataTable();

                    foreach (DataRow row in tbl.Rows)
                    {
                        decimal? amt = (decimal)row["Quantity"] * (decimal)row["CostPrice"] * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1);

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                        d.SubLedgerId = dSubLedgerId;
                        d.Debit = 0;
                        d.Credit = amt;
                        d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
                        d.DocumentNumber = e.TransactionNo;
                        AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        d.Save();

                        totalCredit += d.Credit.Value;

                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg); ;
                        c.SubLedgerId = cSubledgerId;
                        c.Debit = amt;
                        c.Credit = 0;
                        c.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName);
                        c.DocumentNumber = e.TransactionNo;
                        AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        c.Save();

                        totalDebit += c.Debit.Value;
                    }

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryIssue) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewInventoryIssueFromWorkOrderJournal(AssetWorkOrder e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryIssue;

            //Logger.EnterMethod("AddNewDistributionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var suID = string.IsNullOrEmpty(e.FromServiceUnitID) ? e.ToServiceUnitID : e.FromServiceUnitID;
                ServiceUnit ToServiceUnit = new ServiceUnit();
                if (!ToServiceUnit.LoadByPrimaryKey(suID))
                    return 0;

                ServiceUnit FromServiceUnit = new ServiceUnit();
                if (!FromServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", DateTime.Now);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = DateTime.Now.Date;
                    entity.Description = string.Format("ISSUE #:{0}. SERVICE UNIT:{1}.", e.OrderNo, ToServiceUnit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.OrderNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                string dMsg = string.Empty;
                string cMsg = string.Empty;

                AppParameter ap = new AppParameter();
                ap.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                if (ap.ParameterValue == "No")
                {
                    dAccount = ToServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? ToServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                    dSubLedgerId = ToServiceUnit.SubledgerIdCostNonMedic.HasValue ? ToServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                    dMsg = string.Format("Service unit {0}: COA Cost Non Medic", ToServiceUnit.ServiceUnitName);
                }

                var eItems = new AssetWorkOrderItemCollection();
                var eItemQuery = new AssetWorkOrderItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.OrderNo == e.OrderNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var p in eItems)
                {
                    //decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

                    string itemId = p.ItemID;
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        if (itemInv.ProductAccountID == null) throw new Exception(string.Format("Item {0}: Invalid product account", itemInv.ItemName));

                        var pac = new ProductAccount();
                        pac.LoadByPrimaryKey(itemInv.ProductAccountID);
                        switch (FromServiceUnit.SRRegistrationType)
                        {
                            case "IPR":
                                cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }

                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            switch (FromServiceUnit.SRRegistrationType)
                            {
                                case "IPR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                    cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                    break;
                                case "EMR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                    cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                    break;
                                case "OPR":
                                default:
                                    cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                    cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                    break;
                            }
                        }
                        AppParameter ap2 = new AppParameter();
                        ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                        if (ap2.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                supam.Query.ProductAccountId == p.ProductAccountId,
                                supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType))
                                .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                            supam.Query.es.Top = 1;

                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                        ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            if (supam.Query.Load())
                            {
                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                    supam.Query.ProductAccountId == p.ProductAccountId,
                                    supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));

                                supam.Query.es.Top = 1;
                                if (supam.Query.Load())
                                {
                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                        }

                        //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                        AppParameter app = new AppParameter();
                        app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                        if (app.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            supam.Query.Where(supam.Query.ServiceUnitId == FromServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                            if (supam.Query.Load())
                            {
                                cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == FromServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));
                                if (supam.Query.Load())
                                {
                                    cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                    cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                            cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                                FromServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                FromServiceUnit.ServiceUnitName, pac.ProductAccountName);
                        }

                    }

                    //if (cAccount == 0 || dAccount == 0)
                    //    return 0;

                    ItemMovementQuery mov = new ItemMovementQuery();
                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                    mov.Where(mov.TransactionNo == p.OrderNo, mov.SequenceNo == p.SeqNo, mov.ItemID == p.ItemID);
                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                    DataTable tbl = mov.LoadDataTable();

                    foreach (DataRow row in tbl.Rows)
                    {
                        decimal? amt = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                        d.SubLedgerId = dSubLedgerId;
                        d.Debit = amt;
                        d.Credit = 0;
                        d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.OrderNo, p.ItemName);
                        d.DocumentNumber = e.OrderNo;
                        AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        d.Save();

                        totalDebit += d.Debit.Value;

                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg); ;
                        c.SubLedgerId = cSubledgerId;
                        c.Debit = 0;
                        c.Credit = amt;
                        c.Description = string.Format("TR#:{0}. ITEM:{1}.", e.OrderNo, p.ItemName);
                        c.DocumentNumber = e.OrderNo;
                        AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        c.Save();

                        totalCredit += c.Credit.Value;
                    }

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryIssue) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewInventoryIssueFromLaundryWashingProcessJournal(LaunderedProcess e, string serviceUnitId, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryIssue;

            //Logger.EnterMethod("AddNewDistributionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var suID = serviceUnitId;
                ServiceUnit ToServiceUnit = new ServiceUnit();
                if (!ToServiceUnit.LoadByPrimaryKey(suID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("DCF", DateTime.Now);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = DateTime.Now.Date;
                    entity.Description = string.Format("ISSUE #:{0}. SERVICE UNIT:{1}.", e.ProcessNo, ToServiceUnit.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.ProcessNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                string dMsg = string.Empty;
                string cMsg = string.Empty;

                AppParameter ap = new AppParameter();
                ap.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                if (ap.ParameterValue == "No")
                {
                    dAccount = ToServiceUnit.ChartOfAccountIdCostNonMedic.HasValue ? ToServiceUnit.ChartOfAccountIdCostNonMedic.Value : 0;
                    dSubLedgerId = ToServiceUnit.SubledgerIdCostNonMedic.HasValue ? ToServiceUnit.SubledgerIdCostNonMedic.Value : 0;
                    dMsg = string.Format("Service unit {0}: COA Cost Non Medic", ToServiceUnit.ServiceUnitName);
                }
                var eItems = new LaunderedProcessItemConsumptionCollection();
                var eItemQuery = new LaunderedProcessItemConsumptionQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.ProcessNo == e.ProcessNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var p in eItems)
                {
                    //decimal amt = (p.Quantity.Value * p.CostPrice.Value * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1));

                    string itemId = p.ItemID;
                    string itemName = string.Empty;

                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        if (itemInv.ProductAccountID == null) throw new Exception(string.Format("Item {0}: Invalid product account", itemInv.ItemName));

                        itemName = itemInv.ItemName;

                        var pac = new ProductAccount();
                        pac.LoadByPrimaryKey(itemInv.ProductAccountID);
                        switch (ToServiceUnit.SRRegistrationType)
                        {
                            case "IPR":
                                cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }

                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //ProductAccount proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                            //{
                            //--dAccount = proacc.ChartOfAccountIdCost.HasValue ? proacc.ChartOfAccountIdCost.Value : 0;
                            //cAccount = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            //cSubledgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                            switch (ToServiceUnit.SRRegistrationType)
                            {
                                case "IPR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                    cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                    break;
                                case "EMR":
                                    cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                    cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                    break;
                                case "OPR":
                                default:
                                    cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                    cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                    cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                    break;
                            }
                        }
                        AppParameter ap2 = new AppParameter();
                        ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                        if (ap2.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            //supam.Query.Where(supam.Query.ServiceUnitId == e.ToServiceUnitID, 
                            //  supam.Query.ProductAccountId == p.ProductAccountId, 
                            //  supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                            supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                supam.Query.ProductAccountId == p.ProductAccountId,
                                supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType))
                                .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                            supam.Query.es.Top = 1;

                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                        ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            if (supam.Query.Load())
                            {
                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID,
                                    supam.Query.ProductAccountId == p.ProductAccountId,
                                    supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));

                                supam.Query.es.Top = 1;
                                if (supam.Query.Load())
                                {
                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                        }

                        //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                        AppParameter app = new AppParameter();
                        app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                        if (app.ParameterValue == "Yes")
                        {
                            //Matrix COA Unit 
                            ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                            //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                            supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));

                            if (supam.Query.Load())
                            {
                                cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                            else
                            {
                                supam.QueryReset();
                                supam.Query.Where(supam.Query.ServiceUnitId == ToServiceUnit.ServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == "MCU" ? "OPR" : ToServiceUnit.SRRegistrationType));
                                if (supam.Query.Load())
                                {
                                    cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                    cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                    dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                    dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                }
                            }
                            cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                                ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                            dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                ToServiceUnit.ServiceUnitName, pac.ProductAccountName);
                        }

                    }

                    //if (cAccount == 0 || dAccount == 0)
                    //    return 0;

                    ItemMovementQuery mov = new ItemMovementQuery();
                    mov.Select(mov.TransactionNo, mov.ItemID,
                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                    mov.Where(mov.TransactionNo == p.ProcessNo, mov.ItemID == p.ItemID);
                    mov.GroupBy(mov.TransactionNo, mov.ItemID, mov.CostPrice);
                    DataTable tbl = mov.LoadDataTable();

                    foreach (DataRow row in tbl.Rows)
                    {
                        decimal? amt = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                        d.SubLedgerId = dSubLedgerId;
                        d.Debit = amt;
                        d.Credit = 0;
                        d.Description = string.Format("TR#:{0}. ITEM:{1}.", e.ProcessNo, itemName);
                        d.DocumentNumber = e.ProcessNo;
                        AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        d.Save();

                        totalDebit += d.Debit.Value;

                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg); ;
                        c.SubLedgerId = cSubledgerId;
                        c.Debit = 0;
                        c.Credit = amt;
                        c.Description = string.Format("TR#:{0}. ITEM:{1}.", e.ProcessNo, itemName);
                        c.DocumentNumber = e.ProcessNo;
                        AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            ToServiceUnit.ServiceUnitID, p.ItemID, string.Empty);
                        c.Save();

                        totalCredit += c.Credit.Value;
                    }

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryIssue) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }


        /// <summary>
        /// Journal function for Stock Adjustment and Stock Opname
        /// </summary>
        /// <param name="e">ItemTransaction</param>
        /// <param name="editedBy"></param>
        /// <param name="journalId"></param>
        /// <param name="prefix">SA for stock adjustment, ST for stock opname</param>
        /// <param name="pageNo">Stock Taking Page Number</param>
        /// <returns></returns>
        public static int? AddNewInventoryStockAdjustmentJournal(ItemTransaction e, string editedBy, int journalId, string prefix, int pageNo, bool isConsignmentTransfer)
        {
            if (!(new string[] { "SA", "ST" }).Contains(prefix)) return 0;

            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = string.Empty;
            var isInitialBalance = false;
            switch (prefix)
            {
                case "SA":
                    {
                        journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryStockAdjustment;
                        break;
                    }
                case "ST":
                    {
                        journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname;

                        var initBal = new ItemTransactionInitialBalance();
                        isInitialBalance = (initBal.LoadByPrimaryKey(e.TransactionNo) && initBal.IsInitialBalance == true);

                        break;
                    }
            }

            //Logger.EnterMethod("AddNewDistributionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                // belum selesai

                ServiceUnit SU = new ServiceUnit();
                if (!SU.LoadByPrimaryKey(e.FromServiceUnitID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    if (pageNo > 0) journalDetails.Query.Where(journalDetails.Query.DocumentPageNo == pageNo);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("{3}{0}#:{1}. SERVICE UNIT:{2}.", prefix, e.TransactionNo, SU.ServiceUnitName, isInitialBalance ? "IB " : string.Empty);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                string dMsg = string.Empty;
                string cMsg = string.Empty;

                // default coa
                if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                {
                    dAccount = SU.ChartOfAccountIdCost.HasValue ? SU.ChartOfAccountIdCost.Value : 0;
                    dSubLedgerId = SU.SubledgerIdCost.HasValue ? SU.SubledgerIdCost.Value : 0;
                    dMsg = string.Format("Service unit {0}: COA Cost Medic", SU.ServiceUnitName);
                }
                else
                {
                    dAccount = SU.ChartOfAccountIdCostNonMedic.HasValue ? SU.ChartOfAccountIdCostNonMedic.Value : 0;
                    dSubLedgerId = SU.SubledgerIdCostNonMedic.HasValue ? SU.SubledgerIdCostNonMedic.Value : 0;
                    dMsg = string.Format("Service unit {0}: COA Cost Non Medic", SU.ServiceUnitName);
                }

                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemMovementQuery eMovQuery = new ItemMovementQuery("m");
                ItemQuery itemQuery = new ItemQuery("i");

                if (isInitialBalance)
                {
                    // Stock awal by Handono Feb 2022
                    eItemQuery.Select(
                        eItemQuery.TransactionNo, eItemQuery.SequenceNo, eItemQuery.ItemID, eItemQuery.PageNo,
                        itemQuery.ItemName, itemQuery.ProductAccountID,
                        eItemQuery.CostPrice, eItemQuery.Quantity);
                    eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                    eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                }
                else
                {
                    eItemQuery.Select(
                        eItemQuery.TransactionNo, eItemQuery.SequenceNo, eItemQuery.ItemID, eItemQuery.PageNo,
                        itemQuery.ItemName, itemQuery.ProductAccountID,
                        eMovQuery.CostPrice, "< SUM(QuantityIn - QuantityOut) As Quantity >");
                    eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                    eItemQuery.InnerJoin(eMovQuery).On(eItemQuery.TransactionNo == eMovQuery.TransactionNo &&
                        eItemQuery.SequenceNo == eMovQuery.SequenceNo);
                    eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                    if (isConsignmentTransfer)
                        eItemQuery.Where(eMovQuery.QuantityIn > 0);
                    eItemQuery.GroupBy(
                        eItemQuery.TransactionNo, eItemQuery.SequenceNo, eItemQuery.ItemID, eItemQuery.PageNo,
                        itemQuery.ItemName, itemQuery.ProductAccountID,
                        eMovQuery.CostPrice);
                }

                // stock taking sees page number
                if (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname && pageNo > 0)
                {
                    eItemQuery.Where(eItemQuery.PageNo == pageNo);
                }

                // end of stock taking sees page number
                var Dttbl = eItemQuery.LoadDataTable();

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (System.Data.DataRow pRow in Dttbl.Rows)
                {
                    if ((decimal)pRow["Quantity"] == 0) continue; // skip 0

                    var pac = new ProductAccount();
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == pRow["ProductAccountID"].ToString(),
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        pac.LoadByPrimaryKey(proacc.ProductAccountID);
                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(pRow["ProductAccountID"].ToString()))
                        //{
                        switch (SU.SRRegistrationType)
                        {
                            case "IPR":
                                cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }
                    }

                    AppParameter ap2 = new AppParameter();
                    ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                    if (ap2.ParameterValue == "Yes")
                    {
                        //Matrix COA Unit 
                        ServiceUnitProductAccountMappingCollection supamColl = new ServiceUnitProductAccountMappingCollection();
                        //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                        //supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID, 
                        //    supam.Query.ProductAccountId == pRow["ProductAccountID"].ToString(), 
                        //    supam.Query.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : SU.SRRegistrationType));
                        var supamq = new ServiceUnitProductAccountMappingQuery("supamq");
                        var sulq = new ServiceUnitLocationQuery("sulq");
                        supamq.InnerJoin(sulq).On(supamq.ServiceUnitId == sulq.ServiceUnitID && supamq.LocationId == sulq.LocationID)
                            .Where(supamq.ServiceUnitId == SU.ServiceUnitID,
                                supamq.ProductAccountId == pRow["ProductAccountID"].ToString(),
                                supamq.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : (SU.SRRegistrationType == "MCU" ? "OPR" : SU.SRRegistrationType)))
                                .OrderBy(supamq.ChartOfAccountIdExpense.Descending)
                                .Select(supamq);

                        supamq.es.Top = 1;

                        dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                        SU.ServiceUnitName, pac.ProductAccountName);

                        if (supamColl.Load(supamq))
                        {
                            var supam = supamColl.First();
                            dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                        }
                        else
                        {
                            var supam = new ServiceUnitProductAccountMapping();
                            //supam.QueryReset();
                            supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID,
                                supam.Query.ProductAccountId == pRow["ProductAccountID"].ToString(),
                                supam.Query.SRRegistrationType == (SU.SRRegistrationType == "MCU" ? "OPR" : SU.SRRegistrationType));
                            supam.Query.es.Top = 1;
                            if (supam.Query.Load())
                            {
                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                        }
                    }

                    //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                    AppParameter app = new AppParameter();
                    app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                    if (app.ParameterValue == "Yes")
                    {
                        //Matrix COA Unit 
                        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID, supam.Query.ProductAccountId == pRow["ProductAccountId"].ToString(), supam.Query.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : SU.SRRegistrationType));
                        if (supam.Query.Load())
                        {
                            cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                            cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                            dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                        }
                        else
                        {
                            supam.QueryReset();
                            supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID,
                                supam.Query.ProductAccountId == pRow["ProductAccountId"].ToString(),
                                supam.Query.SRRegistrationType == (SU.SRRegistrationType == "MCU" ? "OPR" : SU.SRRegistrationType));
                            supam.Query.es.Top = 1;
                            if (supam.Query.Load())
                            {
                                cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                        }
                        cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                                SU.ServiceUnitName, pac.ProductAccountName);
                        dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                            SU.ServiceUnitName, pac.ProductAccountName);
                    }

                    //if (cAccount == 0 || dAccount == 0)
                    //    return 0;


                    decimal? amt = (decimal)pRow["Quantity"] * (decimal)pRow["CostPrice"] * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1);

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = amt < 0 ? -amt : 0;
                    d.Credit = amt >= 0 ? amt : 0;
                    d.Description = string.Format("{0}#:{1}. ITEM:{2}. {3}", prefix, e.TransactionNo, pRow["ItemName"].ToString(), pageNo > 0 ? ("Page:" + pageNo.ToString()) : "");
                    d.DocumentNumber = e.TransactionNo;
                    if (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname)
                        d.DocumentPageNo = (int)pRow["PageNo"];
                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            SU.ServiceUnitID, pRow["ItemID"].ToString(), string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg);
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = amt >= 0 ? amt : 0;
                    c.Credit = amt < 0 ? -amt : 0;
                    c.Description = string.Format("{0}#:{1}. ITEM:{2}. {3}", prefix, e.TransactionNo, pRow["ItemName"].ToString(), pageNo > 0 ? ("Page:" + pageNo.ToString()) : "");
                    c.DocumentNumber = e.TransactionNo;
                    if (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname)
                        c.DocumentPageNo = (int)pRow["PageNo"];
                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            SU.ServiceUnitID, pRow["ItemID"].ToString(), string.Empty);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryAdjustment) == "Yes")
                {
                    // untuk jurnal stock taking, bila selisih stock opname tidak ada 
                    // langsung diapprove aja.

                    if (((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit)) ||
                        (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname && totalDebit == 0 && totalCredit == 0)
                        )
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewInventoryStockAdjustmentReverseJournal(ItemTransaction e, string editedBy, int journalId, string prefix, int pageNo)
        {
            if (!(new string[] { "SA", "ST" }).Contains(prefix)) return 0;

            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryStockAdjustment;
            //string journalType = string.Empty;
            //switch (prefix)
            //{
            //    case "SA":
            //        {
            //            journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryStockAdjustment;
            //            break;
            //        }
            //    case "ST":
            //        {
            //            journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname;
            //            break;
            //        }
            //}

            //Logger.EnterMethod("AddNewDistributionJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                // belum selesai

                ServiceUnit SU = new ServiceUnit();
                if (!SU.LoadByPrimaryKey(e.ToServiceUnitID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    if (pageNo > 0) journalDetails.Query.Where(journalDetails.Query.DocumentPageNo == pageNo);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("{0}#:{1}. SERVICE UNIT:{2}.", prefix, e.TransactionNo, SU.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                string dMsg = string.Empty;
                string cMsg = string.Empty;

                // default coa
                if (e.SRItemType == BusinessObject.Reference.ItemType.Medical)
                {
                    //dAccount = SU.ChartOfAccountIdCost.HasValue ? SU.ChartOfAccountIdCost.Value : 0;
                    //dSubLedgerId = SU.SubledgerIdCost.HasValue ? SU.SubledgerIdCost.Value : 0;
                    //dMsg = string.Format("Service unit {0}: COA Cost Medic", SU.ServiceUnitName);
                    cAccount = SU.ChartOfAccountIdCost.HasValue ? SU.ChartOfAccountIdCost.Value : 0;
                    cSubledgerId = SU.SubledgerIdCost.HasValue ? SU.SubledgerIdCost.Value : 0;
                    cMsg = string.Format("Service unit {0}: COA Cost Medic", SU.ServiceUnitName);
                }
                else
                {
                    //dAccount = SU.ChartOfAccountIdCostNonMedic.HasValue ? SU.ChartOfAccountIdCostNonMedic.Value : 0;
                    //dSubLedgerId = SU.SubledgerIdCostNonMedic.HasValue ? SU.SubledgerIdCostNonMedic.Value : 0;
                    //dMsg = string.Format("Service unit {0}: COA Cost Non Medic", SU.ServiceUnitName);
                    cAccount = SU.ChartOfAccountIdCostNonMedic.HasValue ? SU.ChartOfAccountIdCostNonMedic.Value : 0;
                    cSubledgerId = SU.SubledgerIdCostNonMedic.HasValue ? SU.SubledgerIdCostNonMedic.Value : 0;
                    cMsg = string.Format("Service unit {0}: COA Cost Non Medic", SU.ServiceUnitName);
                }

                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                //ItemMovementQuery eMovQuery = new ItemMovementQuery("m");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(
                    eItemQuery.TransactionNo, eItemQuery.SequenceNo, eItemQuery.ItemID, eItemQuery.PageNo,
                    itemQuery.ItemName, itemQuery.ProductAccountID,
                    //eMovQuery.CostPrice, "< SUM(QuantityIn - QuantityOut) As Quantity >",
                    eItemQuery.CostPrice, "< SUM(e.Quantity * e.ConversionFactor) As Quantity >"
                    );
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                //eItemQuery.InnerJoin(eMovQuery).On(eItemQuery.TransactionNo == eMovQuery.TransactionNo &&
                //    eItemQuery.SequenceNo == eMovQuery.SequenceNo);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                //eItemQuery.GroupBy(
                //    eItemQuery.TransactionNo, eItemQuery.SequenceNo, eItemQuery.ItemID, eItemQuery.PageNo,
                //    itemQuery.ItemName, itemQuery.ProductAccountID,
                //    eMovQuery.CostPrice);
                eItemQuery.GroupBy(
                    eItemQuery.TransactionNo, eItemQuery.SequenceNo, eItemQuery.ItemID, eItemQuery.PageNo,
                    itemQuery.ItemName, itemQuery.ProductAccountID,
                    eItemQuery.CostPrice);
                // stock taking sees page number
                //if (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname && pageNo > 0)
                //{
                //    eItemQuery.Where(eItemQuery.PageNo == pageNo);
                //}
                // end of stock taking sees page number
                var Dttbl = eItemQuery.LoadDataTable();

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (System.Data.DataRow pRow in Dttbl.Rows)
                {
                    if ((decimal)pRow["Quantity"] == 0) continue; // skip 0

                    var pac = new ProductAccount();
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == pRow["ProductAccountID"].ToString(),
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        pac.LoadByPrimaryKey(proacc.ProductAccountID);
                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(pRow["ProductAccountID"].ToString()))
                        //{
                        switch (SU.SRRegistrationType)
                        {
                            case "IPR":
                                //cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                //cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                //cMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                dAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                dSubLedgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                dMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                //cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                //cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                //cMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                dAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                dSubLedgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                dMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                //cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                //cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                //cMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                dAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                dSubLedgerId = proacc.SubledgerIdInventory ?? 0;
                                dMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }
                    }

                    AppParameter ap2 = new AppParameter();
                    ap2.LoadByPrimaryKey("acc_IsUnitBasedInventoryIssueCost");
                    if (ap2.ParameterValue == "Yes")
                    {
                        //Matrix COA Unit 
                        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        //supam.Query.Where(supam.Query.LocationId == ToServiceUnit.LocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (ToServiceUnit.SRRegistrationType == string.Empty ? "OPR" : ToServiceUnit.SRRegistrationType));
                        //supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID, 
                        //    supam.Query.ProductAccountId == pRow["ProductAccountID"].ToString(), 
                        //    supam.Query.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : SU.SRRegistrationType));

                        supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID,
                                supam.Query.ProductAccountId == pRow["ProductAccountID"].ToString(),
                                supam.Query.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : SU.SRRegistrationType))
                                .OrderBy(supam.Query.ChartOfAccountIdExpense.Descending);

                        supam.Query.es.Top = 1;

                        //dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                        //                SU.ServiceUnitName, pac.ProductAccountName);
                        cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                                        SU.ServiceUnitName, pac.ProductAccountName);

                        if (supam.Query.Load())
                        {
                            //dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            //dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            cAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            cSubledgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                        }
                        else
                        {
                            supam.QueryReset();
                            supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID,
                                supam.Query.ProductAccountId == pRow["ProductAccountID"].ToString(),
                                supam.Query.SRRegistrationType == (SU.SRRegistrationType == "MCU" ? "OPR" : SU.SRRegistrationType));
                            supam.Query.es.Top = 1;
                            if (supam.Query.Load())
                            {
                                //dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                //dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                cAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                cSubledgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                        }
                    }

                    //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                    AppParameter app = new AppParameter();
                    app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                    if (app.ParameterValue == "Yes")
                    {
                        //Matrix COA Unit 
                        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID, supam.Query.ProductAccountId == pRow["ProductAccountId"].ToString(), supam.Query.SRRegistrationType == (SU.SRRegistrationType == string.Empty ? "OPR" : SU.SRRegistrationType));
                        if (supam.Query.Load())
                        {
                            //cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                            //cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                            dAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                            dSubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                            //dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            //dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            cAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                            cSubledgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                        }
                        else
                        {
                            supam.QueryReset();
                            supam.Query.Where(supam.Query.ServiceUnitId == SU.ServiceUnitID,
                                supam.Query.ProductAccountId == pRow["ProductAccountId"].ToString(),
                                supam.Query.SRRegistrationType == (SU.SRRegistrationType == "MCU" ? "OPR" : SU.SRRegistrationType));
                            supam.Query.es.Top = 1;
                            if (supam.Query.Load())
                            {
                                //cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                //cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                                dAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                dSubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                //dAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                //dSubLedgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                                cAccount = supam.ChartOfAccountIdExpense.HasValue ? supam.ChartOfAccountIdExpense.Value : 0;
                                cSubledgerId = supam.SubledgerIdExpense.HasValue ? supam.SubledgerIdExpense.Value : 0;
                            }
                        }
                        //cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                        //        SU.ServiceUnitName, pac.ProductAccountName);
                        dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Inventory coa",
                                SU.ServiceUnitName, pac.ProductAccountName);
                        //dMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                        //    SU.ServiceUnitName, pac.ProductAccountName);
                        cMsg = string.Format("ServiceUnitProductAccountMapping: Service unit {0}: Product account {1}: Expense coa",
                            SU.ServiceUnitName, pac.ProductAccountName);
                    }

                    //if (cAccount == 0 || dAccount == 0)
                    //    return 0;


                    decimal? amt = (decimal)pRow["Quantity"] * (decimal)pRow["CostPrice"] * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1);

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dMsg);
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = amt < 0 ? -amt : 0;
                    d.Credit = amt >= 0 ? amt : 0;
                    d.Description = string.Format("{0}#:{1}. ITEM:{2}. {3}", prefix, e.TransactionNo, pRow["ItemName"].ToString(), pageNo > 0 ? ("Page:" + pageNo.ToString()) : "");
                    d.DocumentNumber = e.TransactionNo;
                    if (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname)
                        d.DocumentPageNo = (int)pRow["PageNo"];
                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            SU.ServiceUnitID, pRow["ItemID"].ToString(), string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, cMsg);
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = amt >= 0 ? amt : 0;
                    c.Credit = amt < 0 ? -amt : 0;
                    c.Description = string.Format("{0}#:{1}. ITEM:{2}. {3}", prefix, e.TransactionNo, pRow["ItemName"].ToString(), pageNo > 0 ? ("Page:" + pageNo.ToString()) : "");
                    c.DocumentNumber = e.TransactionNo;
                    if (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname)
                        c.DocumentPageNo = (int)pRow["PageNo"];
                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty, null,
                            SU.ServiceUnitID, pRow["ItemID"].ToString(), string.Empty);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;

                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryAdjustment) == "Yes")
                {
                    // untuk jurnal stock taking, bila selisih stock opname tidak ada 
                    // langsung diapprove aja.

                    if (((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit)) ||
                        (journalType == Temiang.Avicenna.BusinessObject.JournalType.InventoryStockOpname && totalDebit == 0 && totalCredit == 0)
                        )
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewInventoryProductionJournal(ProductionOfGoods e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.InventoryProduction;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                ServiceUnit su = new ServiceUnit();
                if (!su.LoadByPrimaryKey(e.ServiceUnitID))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("POG", e.ProductionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.ProductionDate;
                    entity.Description = string.Format("Production #:{0}. SERVICE UNIT:{1}.", e.ProductionNo,
                        su.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.ProductionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                // journal detail
                ItemMovementQuery im = new ItemMovementQuery("im");
                ItemQuery i = new ItemQuery("i");
                ProductionOfGoodsItemQuery pg = new ProductionOfGoodsItemQuery("pg");

                im.InnerJoin(i).On(im.ItemID == i.ItemID)
                    .LeftJoin(pg).On(im.TransactionNo == pg.ProductionNo && im.ItemID == pg.ItemID)
                    .Select(im.TransactionNo, im.SequenceNo, im.ItemID, pg.ItemID.As("ItemID2"), i.ItemName, i.ProductAccountID,
                           im.CostPrice, "< SUM(QuantityOut) As QuantityOut >", "< SUM(QuantityIn) As QuantityIn >")
                    .Where(im.TransactionNo == e.ProductionNo)
                    .GroupBy(im.TransactionNo, im.SequenceNo, im.ItemID, pg.ItemID, i.ItemName, i.ProductAccountID, im.CostPrice)
                    .OrderBy(pg.ItemID.Ascending, im.ItemID.Ascending);
                DataTable tbl = im.LoadDataTable();

                string prodItemName = "";

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (DataRow row in tbl.Rows)
                {
                    decimal? amtIn = (decimal)row["QuantityIn"] * (decimal)row["CostPrice"];
                    decimal? amtOut = (decimal)row["QuantityOut"] * (decimal)row["CostPrice"];

                    string dcMsg = "";

                    var pac = new ProductAccount();
                    var proacc = new ProductAccountGuarantorGroup();
                    proacc.Query.Where(proacc.Query.ProductAccountID == row["ProductAccountID"].ToString(),
                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                    if (proacc.Load(proacc.Query))
                    {
                        pac.LoadByPrimaryKey(proacc.ProductAccountID);
                        //ProductAccount proacc = new ProductAccount();
                        //if (proacc.LoadByPrimaryKey(row["ProductAccountID"].ToString()))
                        //{
                        switch (su.SRRegistrationType)
                        {
                            case "IPR":
                                cAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                if (amtIn > 0)
                                {
                                    dAccount = proacc.ChartOfAccountIdInventoryIP ?? 0;
                                    dSubLedgerId = proacc.SubledgerIdInventoryIP ?? 0;
                                }
                                dcMsg = string.Format("Product Account {0}: Inpatient: COA Inventory", pac.ProductAccountName);
                                break;
                            case "EMR":
                                cAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                if (amtIn > 0)
                                {
                                    dAccount = proacc.ChartOfAccountIdInventoryIGD ?? 0;
                                    dSubLedgerId = proacc.SubledgerIdInventoryIGD ?? 0;
                                }
                                dcMsg = string.Format("Product Account {0}: Emergency: COA Inventory", pac.ProductAccountName);
                                break;
                            case "OPR":
                            default:
                                cAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                cSubledgerId = proacc.SubledgerIdInventory ?? 0;
                                if (amtIn > 0)
                                {
                                    dAccount = proacc.ChartOfAccountIdInventory ?? 0;
                                    dSubLedgerId = proacc.SubledgerIdInventory ?? 0;
                                }
                                dcMsg = string.Format("Product Account {0}: Outpatient: COA Inventory", pac.ProductAccountName);
                                break;
                        }
                    }
                    //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                    AppParameter app = new AppParameter();
                    app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                    if (app.ParameterValue == "Yes")
                    {
                        //Matrix COA Unit 
                        ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                        supam.Query.Where(supam.Query.ServiceUnitId == su.ServiceUnitID,
                            supam.Query.ProductAccountId == row["ProductAccountId"].ToString(),
                            supam.Query.SRRegistrationType == (su.SRRegistrationType == string.Empty ? "OPR" : su.SRRegistrationType));
                        if (supam.Query.Load())
                        {
                            cAccount = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                            cSubledgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;
                            if (amtIn > 0)
                            {
                                dAccount = supam.ChartOfAccountIdInventory ?? 0;
                                dSubLedgerId = supam.SubledgerIdInventory ?? 0;
                            }
                        }
                    }

                    if (amtIn > 0)
                    {
                        prodItemName = row["ItemName"].ToString();
                    }


                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(cAccount, coaColl, dcMsg);
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = amtIn;
                    c.Credit = amtOut;
                    c.Description = string.Format("Production#:{0}. ITEM:{1}.", e.ProductionNo, row["ItemName"].ToString());
                    c.DocumentNumber = e.ProductionNo;
                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, row["ItemID"].ToString(), string.Empty);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;
                }
                // jika ada selisih karena pembulatan costprice lebih dari 2 digit belakang koma
                if (totalDebit < totalCredit)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = totalCredit - totalDebit;
                    d.Credit = 0;
                    d.Description = string.Format("Production#:{0}. Item: {1}. Deviation due to rounding of more than two decimal places", e.ProductionNo, prodItemName);
                    d.DocumentNumber = e.ProductionNo;
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                ////////////////////

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedInventoryProduction) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAPJournal(InvoiceSupplier e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AP;

            //Logger.EnterMethod("AddNewAPJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;


                int dAccount = 0;
                int dSubLedgerId = 0;
                int cAccount = 0;
                int cSubledgerId = 0;

                InvoiceSupplierItemCollection items = new InvoiceSupplierItemCollection();
                items.Query.Where(items.Query.InvoiceNo == e.InvoiceNo);
                if (!items.Query.Load())
                    return 0;

                Supplier sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                dAccount = sup.ChartOfAccountIdAPInProcess.HasValue ? sup.ChartOfAccountIdAPInProcess.Value : 0;
                dSubLedgerId = sup.SubledgerIdAPInProcess.HasValue ? sup.SubledgerIdAPInProcess.Value : 0;

                cAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                cSubledgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                if (dAccount == 0 || cAccount == 0)
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                entity.AddNew();
                entity.JournalType = journalType;
                entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("AP", e.InvoiceDate.Value);
                entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                entity.TransactionDate = e.InvoiceDate;
                entity.Description = string.Format("AP#:{0}. SUP:{1}.", e.InvoiceNo, sup.SupplierName);
                entity.IsPosted = false;
                entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                entity.RefferenceNumber = e.InvoiceNo;
                entity.Save();

                foreach (var p in items)
                {
                    decimal amt = p.Amount.Value;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = amt;
                    d.Credit = 0;
                    d.Description = string.Format("AP#:{0}. SUP:{1}. PO:{2}", e.InvoiceNo, sup.SupplierName, p.TransactionNo);
                    d.DocumentNumber = e.InvoiceNo;
                    d.Save();

                    totalDebit += d.Debit.Value;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = 0;
                    c.Credit = amt;
                    c.Description = string.Format("AP#:{0}. SUP:{1}. PO:{2}", e.InvoiceNo, sup.SupplierName, p.TransactionNo);
                    c.DocumentNumber = e.InvoiceNo;
                    c.Save();

                    totalCredit += c.Credit.Value;
                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }

                //Logger.LeaveMethod("AddNewDistributionJournal");
                return entity.JournalId;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        //hapus
        public static int? AddNewAPPaymentJournal(InvoiceSupplierItem e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.APPayment;

            try
            {
                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal grandTotalBankAmount = 0;
                decimal grandTotalProfitLoss = 0;

                var it = new ItemTransaction();
                it.LoadByPrimaryKey(e.TransactionNo);
                decimal? Hutang = (it.ChargesAmount + it.TaxAmount - it.Pph22 - it.Pph23) * (it.CurrencyRate ?? 1);

                var hd = new InvoiceSupplier();
                hd.LoadByPrimaryKey(e.InvoiceNo);

                Supplier sup = new Supplier();
                if (!sup.LoadByPrimaryKey(hd.SupplierID))
                    return 0;

                Bank bankEntity = null;


                dAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                dSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                PaymentMethod pm = new PaymentMethod();
                if (pm.LoadByPrimaryKey("PaymentType-006", e.SRInvoicePayment))
                {
                    if (e.SRInvoicePayment == "PaymentMethod-001")
                    {
                        cAccount = pm.ChartOfAccountID.HasValue ? pm.ChartOfAccountID.Value : 0;
                        cSubledgerId = pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0;

                        bankEntity = new Bank();
                        bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                        if (!bankEntity.Query.Load()) return 0;
                    }
                    else
                    {
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(e.BankID))
                            if (!bankEntity.ChartOfAccountId.HasValue)
                                return 0;

                        cAccount = bankEntity.ChartOfAccountId.HasValue ? bankEntity.ChartOfAccountId.Value : 0;
                        cSubledgerId = bankEntity.SubledgerId.HasValue ? bankEntity.SubledgerId.Value : 0;


                    }
                }

                if (dAccount == 0 || cAccount == 0)
                    return 0;

                //Journal Header
                JournalTransactions headerJournal = new JournalTransactions();
                if (headerJournal.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == headerJournal.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    headerJournal.LastUpdateDateTime = DateTime.Now;
                    //headerJournal.LastUpdateByUserID = editedBy;
                }
                else
                {
                    headerJournal.AddNew();
                    headerJournal.JournalType = journalType;
                    headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("APP", hd.InvoiceDate.Value);
                    headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                    headerJournal.TransactionDate = hd.InvoiceDate;
                    headerJournal.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    headerJournal.IsPosted = false;
                    headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                    headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                    headerJournal.RefferenceNumber = e.InvoiceNo;
                }
                headerJournal.Save();

                //karena kurs bisa berbeda saat penerimaan & pembayaran, maka amount yg dipakai untuk sisi debit adalah amount saat penerimaan
                JournalTransactionDetails apLine = new JournalTransactionDetails();
                apLine.AddNew();
                apLine.JournalId = headerJournal.JournalId;
                apLine.ChartOfAccountId = dAccount;
                apLine.SubLedgerId = dSubLedgerId;
                // decimal? apAmount = e.VerifyAmount + e.PPnAmount;
                // apLine.Debit = apAmount;
                apLine.Debit = Hutang;
                apLine.Credit = 0;
                apLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                apLine.DocumentNumber = e.InvoiceNo;
                apLine.Save();
                totalDebit += apLine.Debit.Value;

                JournalTransactionDetails bankLine = new JournalTransactionDetails();
                bankLine.AddNew();
                bankLine.JournalId = headerJournal.JournalId;
                bankLine.ChartOfAccountId = cAccount;
                bankLine.SubLedgerId = cSubledgerId;
                bankLine.Debit = 0;
                // this total will be used in cash transaction
                // decimal? totalBankAmount = e.Amount - e.PPh22Amount - e.PPh23Amount;
                decimal? totalBankAmount = (e.VerifyAmount + e.PPnAmount - e.PPh22Amount - e.PPh23Amount) * e.CurrencyRate;
                bankLine.Credit = totalBankAmount;
                bankLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                bankLine.DocumentNumber = e.InvoiceNo;
                bankLine.Save();
                totalCredit += bankLine.Credit.Value;
                grandTotalBankAmount += Hutang ?? 0; // hutang yang dipakai karena harus sama dgn jurnal saat POR

                // jurnal tambahan apbila kurs berbeda pada saat penerimaan barang dengan pembayaran
                int dAccount_loss = GetCachedAccountFromParam("coa_inventory_loss");
                int cAccount_profit = GetCachedAccountFromParam("coa_inventory_profit");

                if (Hutang > totalBankAmount && cAccount_profit != 0)
                {
                    JournalTransactionDetails additional = new JournalTransactionDetails();
                    additional.AddNew();
                    additional.JournalId = headerJournal.JournalId;
                    additional.ChartOfAccountId = cAccount_profit;
                    additional.SubLedgerId = 0;
                    additional.Debit = 0;
                    additional.Credit = Hutang - totalBankAmount;
                    additional.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    additional.DocumentNumber = e.InvoiceNo;
                    additional.Save();
                    totalCredit += additional.Credit.Value;
                    grandTotalProfitLoss += (Hutang ?? 0) - (totalBankAmount ?? 0);
                }
                else if (Hutang < totalBankAmount && dAccount_loss != 0)
                {
                    JournalTransactionDetails additional = new JournalTransactionDetails();
                    additional.AddNew();
                    additional.JournalId = headerJournal.JournalId;
                    additional.ChartOfAccountId = dAccount_loss;
                    additional.SubLedgerId = 0;
                    additional.Debit = totalBankAmount - Hutang;
                    additional.Credit = 0;
                    additional.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    additional.DocumentNumber = e.InvoiceNo;
                    additional.Save();
                    totalDebit += additional.Debit.Value;
                    grandTotalProfitLoss += (totalBankAmount ?? 0) - (Hutang ?? 0);
                }

                if (totalBankAmount > 0 && bankEntity != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    int? cashTransactionId;

                    CashTransaction.AddNewAutomaticCashTransactionAP(bankEntity.BankID, cAccount, hd.InvoiceDate.Value,
                                                                  "AP", "SUPPAYMNT",
                                                                  pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                                                                  bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                                                                  headerJournal.Description, headerJournal.JournalId.Value,
                                                                  editedBy,
                                                                  dAccount,
                                                                  // Account Payable Amount. Should be in original currency
                                                                  dSubLedgerId, out cashTransactionId, dAccount, grandTotalBankAmount, 0, dAccount_loss, cAccount_profit, grandTotalProfitLoss);



                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (headerJournal.JournalId.HasValue && headerJournal.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, headerJournal.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        headerJournal.BeginEdit();
                        headerJournal.IsPosted = true;
                        headerJournal.EndEdit();
                        headerJournal.Save();
                    }
                }

                //PPN
                //int cAccount_PPN = GetCachedAccountFromParam("coa_Ppn");
                //if (cAccount_PPN == 0)
                //    return 0;

                //if (e.PPnAmount > 0)
                //{
                //    JournalTransactionDetails ppnLine = new JournalTransactionDetails();
                //    ppnLine.AddNew();
                //    ppnLine.JournalId = headerJournal.JournalId;
                //    ppnLine.ChartOfAccountId = cAccount_PPN;
                //    ppnLine.SubLedgerId = 0;
                //    ppnLine.Debit = 0;
                //    ppnLine.Credit = e.PPnAmount;
                //    ppnLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                //    ppnLine.DocumentNumber = e.InvoiceNo;
                //    ppnLine.Save();
                //}

                ////PPH 22
                //int cAccount_PPH22 = GetCachedAccountFromParam("coa_Pph22");
                //if (cAccount_PPH22 == 0)
                //    return 0;

                //if (e.PPh22Amount > 0)
                //{
                //    JournalTransactionDetails pphLine = new JournalTransactionDetails();
                //    pphLine.AddNew();
                //    pphLine.JournalId = headerJournal.JournalId;
                //    pphLine.ChartOfAccountId = cAccount_PPH22;
                //    pphLine.SubLedgerId = 0;
                //    pphLine.Debit = 0;
                //    pphLine.Credit = e.PPh22Amount;
                //    pphLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                //    pphLine.DocumentNumber = e.InvoiceNo;
                //    pphLine.Save();
                //}

                ////PPH 23
                //int cAccount_PPH23 = GetCachedAccountFromParam("coa_Pph23");
                //if (cAccount_PPH23 == 0)
                //    return 0;

                //if (e.PPh23Amount > 0)
                //{
                //    JournalTransactionDetails pph23Line = new JournalTransactionDetails();
                //    pph23Line.AddNew();
                //    pph23Line.JournalId = headerJournal.JournalId;
                //    pph23Line.ChartOfAccountId = cAccount_PPH23;
                //    pph23Line.SubLedgerId = 0;
                //    pph23Line.Debit = 0;
                //    pph23Line.Credit = e.PPh23Amount;
                //    pph23Line.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                //    pph23Line.DocumentNumber = e.InvoiceNo;
                //    pph23Line.Save();
                //}

                return headerJournal.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewAPPaymentJournal2Unapproval(InvoiceSupplier e, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Invoice Payment Supplier
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == e.InvoiceNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    //ctColl.Query.JournalId == jhcoll[0].JournalId.Value,
                    ctColl.Query.DocumentNumber == jhcoll[0].RefferenceNumber,
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current payment");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                int? ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "APP", editedBy);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                return ret;
            }
        }

        public static int? AddNewAPPaymentJournal2(InvoiceSupplier e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = BusinessObject.JournalType.APPayment;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal grandTotalBankAmount = 0;
                decimal grandTotalProfitLoss = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;
                int dAccountNM = 0;
                int dSubLedgerIdNM = 0;

                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                var eItems = new InvoiceSupplierItemCollection();
                eItems.Query.Where(eItems.Query.InvoiceNo == e.InvoiceNo);
                if (!eItems.Query.Load())
                    return 0;

                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalAPPaymentDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        e.InvoiceDate.Value.Date : e.PaymentApprovedDateTime.Value.Date;

                //Journal Header
                var headerJournal = new JournalTransactions();
                if (headerJournal.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(headerJournal);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == headerJournal.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    headerJournal.LastUpdateDateTime = DateTime.Now;
                    //headerJournal.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(headerJournal);

                    headerJournal.Save();
                }
                else
                {
                    headerJournal.AddNew();
                    headerJournal.JournalType = journalType;
                    headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("APP", jDate);
                    headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                    headerJournal.TransactionDate = jDate;
                    headerJournal.Description = CutString(string.Format("INV#:{0}. SUP#:{1}. {2}", e.InvoiceNo, sup.SupplierName, e.InvoiceNotes), 255);
                    headerJournal.IsPosted = false;
                    headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                    headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                    headerJournal.RefferenceNumber = e.InvoiceNo;

                    headerJournal.Save();
                    ValidateClosingPeriode(headerJournal);
                }

                journalId = headerJournal.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                var IsApNMSeparated = false;
                var PrmApNMSeparated = new AppParameter();
                if (PrmApNMSeparated.LoadByPrimaryKey("IsCoaAPNonMedicSeparated"))
                {
                    IsApNMSeparated = (PrmApNMSeparated.ParameterValue == "Yes");
                }

                dAccount = sup.ChartOfAccountIdAP ?? 0;
                dSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                dAccountNM = sup.ChartOfAccountIdAPNonMedic ?? 0;
                dSubLedgerIdNM = sup.SubledgerIdAPNonMedic.HasValue ? sup.SubledgerIdAPNonMedic.Value : 0;

                int dAccount_loss = GetCachedAccountFromParam("coa_inventory_loss");
                int cAccount_profit = GetCachedAccountFromParam("coa_inventory_profit");

                decimal tPay = 0;

                var IsDpOnReceivingInv = AppParameter.IsYes(AppParameter.ParameterItem.IsAccWriteDownPaymentOnReceivingInvoice);
                var IsUsingRoundingPaymentAP = AppParameter.IsYes(AppParameter.ParameterItem.IsUsingRoundingPaymentAP);

                decimal tUm = 0;

                //var IsPpnExcluded = !AppParameter.IsYes(AppParameter.ParameterItem.IsApInvoiceIncPPN);
                decimal ppnAmountMedicTotal = 0, ppnAmountNonMedicTotal = 0;

                decimal tHutangM = 0, tHutangNm = 0;

                foreach (var p in eItems)
                {
                    var it = new ItemTransaction();
                    it.LoadByPrimaryKey(p.TransactionNo);
                    //decimal? hutang = (p.PaymentAmount) * (it.CurrencyRate ?? 1);
                    decimal? hutang = 0;

                    //Request RSKS: Rounding AP (Fajri 2023/08/07)
                    if (sup.IsUsingRounding == true && IsUsingRoundingPaymentAP)
                        hutang = (p.PaymentAmount + (p.RoundingAmount < 0 ? Abs(p.RoundingAmount) : p.RoundingAmount * -1)) * (it.CurrencyRate ?? 1);
                    else
                        hutang = (p.PaymentAmount) * (it.CurrencyRate ?? 1);


                    var isMedic = p.SRItemType == "11";

                    if (isMedic)
                    {
                        tHutangM += hutang ?? 0;
                    }
                    else
                    {
                        tHutangNm += hutang ?? 0;
                    }

                    // inv ref
                    decimal um = 0;
                    decimal ppnAmountMedic = 0, ppnAmountNonMedic = 0;

                    if (!string.IsNullOrEmpty(p.InvoiceReferenceNo))
                    {
                        var ivsi = new InvoiceSupplierItem();
                        ivsi.Query.Where(ivsi.Query.InvoiceNo == p.InvoiceReferenceNo, ivsi.Query.TransactionNo == p.TransactionNo);
                        if (ivsi.Load(ivsi.Query))
                        {
                            var IsPpnExcluded = ivsi.IsPpnExcluded ?? false;

                            if ((!IsDpOnReceivingInv) && (p.PaymentAmount >= p.Amount))
                            {
                                um = ivsi.DownPaymentAmount ?? 0;
                                tUm += um;

                                if (um != 0)
                                {
                                    // cari nomor PO
                                    var porTrans = new ItemTransaction();
                                    if (porTrans.LoadByPrimaryKey(ivsi.TransactionNo))
                                    {
                                        var poTrans = new ItemTransaction();
                                        if (poTrans.LoadByPrimaryKey(porTrans.ReferenceNo))
                                        {
                                            if (!string.IsNullOrEmpty(poTrans.CashTransactionReconcileId))
                                            {
                                                var cids = poTrans.CashTransactionReconcileId.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                                                //decimal sumUM = 0;
                                                if (cids.Length > 0)
                                                {
                                                    var ctiQuery = new CashTransactionDetailQuery("cti");
                                                    var ctQuery = new CashTransactionQuery("ct");
                                                    ctiQuery.InnerJoin(ctQuery).On(ctQuery.TransactionId == ctiQuery.TransactionId);
                                                    ctiQuery.Where(ctiQuery.TransactionId.In(cids), ctQuery.IsVoid == false)
                                                        .OrderBy(ctiQuery.TransactionId.Ascending)
                                                        .Select(ctiQuery);

                                                    var ctiColl = new CashTransactionDetailCollection();
                                                    //ctiColl.Query.Where(ctiColl.Query.TransactionId.In(cids));
                                                    ctiColl.Load(ctiQuery);
                                                    if (ctiColl.LoadAll())
                                                    {
                                                        foreach (var cid in cids)
                                                        {
                                                            foreach (var cti in ctiColl.Where(x => (x.TransactionId ?? 0) == Convert.ToInt32(cid)))
                                                            {
                                                                var jum = new JournalTransactionDetails
                                                                {
                                                                    JournalId = headerJournal.JournalId,
                                                                    ChartOfAccountId = cti.ChartOfAccountId,
                                                                    SubLedgerId = cti.SubLedgerId,
                                                                    Debit = cti.Credit.Value,
                                                                    Credit = cti.Debit.Value,
                                                                    Description = string.Format("{3}. #:{0}. SUP:{1}. INV:{2}", e.InvoiceNo, sup.SupplierName, ivsi.InvoiceNo, string.Format("{1}, PO:{0}", poTrans.TransactionNo, cti.Description)),
                                                                    DocumentNumber = ivsi.InvoiceNo
                                                                };
                                                                AddMoreInfo(jum, string.Empty, string.Empty, poTrans.BusinessPartnerID, string.Empty, null,
                                                                    string.Empty, string.Empty, string.Empty);
                                                                jum.Save();
                                                                totalDebit += jum.Debit.Value;
                                                                totalCredit += jum.Credit.Value;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            // hutang ppn
                            if (IsPpnExcluded)
                            {
                                var porTrans = new ItemTransaction();
                                if (porTrans.LoadByPrimaryKey(ivsi.TransactionNo))
                                {
                                    if ((porTrans.TaxAmount ?? 0) != 0)
                                    {
                                        ppnAmountMedic = porTrans.SRItemType == "11" ? (ivsi.PPnAmount ?? 0) : 0;
                                        ppnAmountNonMedic = porTrans.SRItemType != "11" ? (ivsi.PPnAmount ?? 0) : 0;
                                    }
                                }
                            }
                        }
                    }

                    //if ((!IsDpOnReceivingInv) && (p.PaymentAmount >= p.Amount)) {
                    //    if (!string.IsNullOrEmpty(p.InvoiceReferenceNo))
                    //    {
                    //        var ivsi = new InvoiceSupplierItem();
                    //        ivsi.Query.Where(ivsi.Query.InvoiceNo == p.InvoiceReferenceNo, ivsi.Query.TransactionNo == p.TransactionNo);
                    //        if (ivsi.Load(ivsi.Query))
                    //        {
                    //            um = ivsi.DownPaymentAmount ?? 0;
                    //            tUm += um;

                    //            if (um != 0) {
                    //                // cari nomor PO
                    //                var porTrans = new ItemTransaction();
                    //                if (porTrans.LoadByPrimaryKey(ivsi.TransactionNo))
                    //                {
                    //                    var poTrans = new ItemTransaction();
                    //                    if (poTrans.LoadByPrimaryKey(porTrans.ReferenceNo))
                    //                    {
                    //                        if (!string.IsNullOrEmpty(poTrans.CashTransactionReconcileId))
                    //                        {
                    //                            var cids = poTrans.CashTransactionReconcileId.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                    //                            //decimal sumUM = 0;
                    //                            if (cids.Length > 0)
                    //                            {
                    //                                var ctiQuery = new CashTransactionDetailQuery("cti");
                    //                                var ctQuery = new CashTransactionQuery("ct");
                    //                                ctiQuery.InnerJoin(ctQuery).On(ctQuery.TransactionId == ctiQuery.TransactionId);
                    //                                ctiQuery.Where(ctiQuery.TransactionId.In(cids), ctQuery.IsVoid == false)
                    //                                    .OrderBy(ctiQuery.TransactionId.Ascending)
                    //                                    .Select(ctiQuery);

                    //                                var ctiColl = new CashTransactionDetailCollection();
                    //                                //ctiColl.Query.Where(ctiColl.Query.TransactionId.In(cids));
                    //                                ctiColl.Load(ctiQuery);
                    //                                if (ctiColl.LoadAll())
                    //                                {
                    //                                    foreach (var cid in cids)
                    //                                    {
                    //                                        foreach (var cti in ctiColl.Where(x => (x.TransactionId ?? 0) == Convert.ToInt32(cid)))
                    //                                        {
                    //                                            var jum = new JournalTransactionDetails
                    //                                            {
                    //                                                JournalId = headerJournal.JournalId,
                    //                                                ChartOfAccountId = cti.ChartOfAccountId,
                    //                                                SubLedgerId = cti.SubLedgerId,
                    //                                                Debit = cti.Credit.Value,
                    //                                                Credit = cti.Debit.Value,
                    //                                                Description = string.Format("{3}. #:{0}. SUP:{1}. INV:{2}", e.InvoiceNo, sup.SupplierName, ivsi.InvoiceNo, string.Format("{1}, PO:{0}", poTrans.TransactionNo, cti.Description)),
                    //                                                DocumentNumber = ivsi.InvoiceNo
                    //                                            };
                    //                                            AddMoreInfo(jum, string.Empty, string.Empty, poTrans.BusinessPartnerID, string.Empty, null,
                    //                                                string.Empty, string.Empty, string.Empty);
                    //                                            jum.Save();
                    //                                            totalDebit += jum.Debit.Value;
                    //                                            totalCredit += jum.Credit.Value;
                    //                                        }
                    //                                    }
                    //                                }
                    //                            }
                    //                        }
                    //                    }
                    //                }
                    //            }
                    //        }
                    //    }
                    //}

                    //karena kurs bisa berbeda saat penerimaan & pembayaran, maka amount yg dipakai untuk sisi debit adalah amount saat penerimaan
                    var apLine = new JournalTransactionDetails();
                    apLine.AddNew();
                    apLine.JournalId = headerJournal.JournalId;

                    if ((p.ChartOfAccountId ?? 0) != 0)
                    {
                        apLine.ChartOfAccountId = p.ChartOfAccountId;
                        apLine.SubLedgerId = p.SubLedgerId ?? 0;
                    }
                    else
                    {
                        apLine.ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                            ValidateCOA(dAccountNM, coaColl, string.Format("Supplier {0}: Chart Of Account A/P Non Medical", sup.SupplierName)) :
                            ValidateCOA(dAccount, coaColl, string.Format("Supplier {0}: Chart Of Account A/P", sup.SupplierName));
                        apLine.SubLedgerId = (IsApNMSeparated && !isMedic) ? dSubLedgerIdNM : dSubLedgerId;
                    }
                    // decimal? apAmount = e.VerifyAmount + e.PPnAmount;
                    // apLine.Debit = apAmount;
                    var h = hutang + (IsDpOnReceivingInv ? 0 : (p.PaymentAmount < p.Amount ? 0 : um));
                    apLine.Debit = (h >= 0) ? h : 0;
                    apLine.Credit = (h < 0) ? Abs(h) : 0;
                    apLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                    apLine.DocumentNumber = p.InvoiceReferenceNo ?? string.Empty;//e.InvoiceNo;
                    AddMoreInfo(apLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                        string.Empty, string.Empty, string.Empty);
                    apLine.Save();

                    totalDebit += apLine.Debit.Value;
                    totalCredit += apLine.Credit.Value;

                    decimal? totalBankAmount = p.PaymentAmount * p.CurrencyRate;
                    tPay += totalBankAmount.Value;

                    // grandTotalBankAmount += totalBankAmount ?? 0;
                    grandTotalBankAmount += hutang ?? 0; // hutang yang dipakai karena nilai hutang saat pembayaran hrs sama dengan POR

                    //Request RSKS: Rounding AP (Fajri 2023/08/07)
                    if (p.RoundingAmount != 0 && sup.IsUsingRounding == true)
                    {
                        var rndAmount = p.RoundingAmount ?? 0;
                        var coaRnd = GetCachedAccountFromParam("coa_RoundingAP");
                        var rnd = new JournalTransactionDetails();
                        rnd.AddNew();
                        rnd.JournalId = headerJournal.JournalId;
                        rnd.ChartOfAccountId = ValidateCOA(coaRnd, coaColl, "AppParameter: coa_RoundingAP");
                        rnd.SubLedgerId = 0;
                        rnd.Debit = rndAmount >= 0 ? rndAmount : 0;
                        rnd.Credit = rndAmount < 0 ? Abs(rndAmount) : 0;
                        rnd.Description = string.Format("ROUNDING. INV#:{0}. InvRef#:{1}.", e.InvoiceNo, p.InvoiceReferenceNo);
                        rnd.DocumentNumber = p.InvoiceReferenceNo ?? string.Empty;
                        rnd.Save();
                        totalDebit += rnd.Debit.Value;
                        totalCredit += rnd.Credit.Value;
                    }

                    // jurnal tambahan apbila kurs berbeda pada saat penerimaan barang dengan pembayaran
                    if (hutang > totalBankAmount && cAccount_profit != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = ValidateCOA(cAccount_profit, coaColl,
                            "App Parameter: coa_inventory_profit");
                        additional.SubLedgerId = 0;
                        additional.Debit = 0;
                        additional.Credit = hutang - totalBankAmount;
                        additional.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        additional.DocumentNumber = p.InvoiceReferenceNo;// e.InvoiceNo;
                        AddMoreInfo(additional, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        additional.Save();
                        totalCredit += additional.Credit.Value;
                        grandTotalProfitLoss += (hutang ?? 0) - (totalBankAmount ?? 0);
                    }
                    else if (hutang < totalBankAmount && dAccount_loss != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = ValidateCOA(dAccount_loss, coaColl,
                            "App Parameter: coa_inventory_loss");
                        additional.SubLedgerId = 0;
                        additional.Debit = totalBankAmount - hutang;
                        additional.Credit = 0;
                        additional.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        additional.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(additional, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        additional.Save();
                        totalCredit += additional.Debit.Value;
                        grandTotalProfitLoss += (totalBankAmount ?? 0) - (hutang ?? 0);
                    }

                    if (ppnAmountMedic != 0)
                    {
                        var coaPpnMedic = GetCachedAccountFromParam("coa_Ppn");
                        var jPpn = new JournalTransactionDetails
                        {
                            JournalId = headerJournal.JournalId,
                            ChartOfAccountId = ValidateCOA(coaPpnMedic, coaColl, "AppParameter: coa_Ppn"),
                            SubLedgerId = sup.SubledgerIdAP ?? 0,
                            Debit = ((ppnAmountMedic >= 0) ? ppnAmountMedic : 0),
                            Credit = ((ppnAmountMedic < 0) ? Abs(ppnAmountMedic) : 0),
                            Description = string.Format("TAX (Ppn) #:{0}. SUP:{1}. INV:{2} ", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo),
                            DocumentNumber = e.InvoiceNo
                        };
                        AddMoreInfo(jPpn, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        jPpn.Save();
                        totalDebit += jPpn.Debit.Value;
                        totalCredit += jPpn.Credit.Value;
                    }
                    if (ppnAmountNonMedic != 0)
                    {
                        var coaPpnNonMedic = GetCachedAccountFromParam("coa_PpnNonMedic");
                        var jPpn = new JournalTransactionDetails
                        {
                            JournalId = headerJournal.JournalId,
                            ChartOfAccountId = ValidateCOA(coaPpnNonMedic, coaColl, "AppParameter: coa_PpnNonMedic"),
                            SubLedgerId = sup.SubledgerIdAP ?? 0,
                            Debit = ((ppnAmountNonMedic >= 0) ? ppnAmountNonMedic : 0),
                            Credit = ((ppnAmountNonMedic < 0) ? Abs(ppnAmountNonMedic) : 0),
                            Description = string.Format("TAX (Ppn) #:{0}. SUP:{1}. INV:{2} ", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo),
                            DocumentNumber = e.InvoiceNo
                        };
                        AddMoreInfo(jPpn, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        jPpn.Save();
                        totalDebit += jPpn.Debit.Value;
                        totalCredit += jPpn.Credit.Value;
                    }
                    ppnAmountMedicTotal += ppnAmountMedic;
                    ppnAmountNonMedicTotal += ppnAmountNonMedic;
                }

                Bank bankEntity = null;
                var pt = new PaymentType();
                var pm = new PaymentMethod();

                if (pt.LoadByPrimaryKey("PaymentType-006"))
                {
                    if (pm.LoadByPrimaryKey("PaymentType-006", e.SRInvoicePayment))
                    {
                        cAccount = pm.ChartOfAccountID.HasValue ? pm.ChartOfAccountID.Value : 0;
                        cSubledgerId = pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0;

                        if (string.IsNullOrEmpty(e.BankID))
                        {
                            // cari setting bank dari master payment type
                            var bColl = new BankCollection();
                            bColl.Query.Where(bColl.Query.ChartOfAccountId == (pm.ChartOfAccountID ?? 0));
                            if (bColl.LoadAll())
                            {
                                e.BankID = bColl.First().BankID;
                            }
                        }

                        if (!string.IsNullOrEmpty(e.BankID))
                        {
                            bankEntity = new Bank();
                            if (bankEntity.LoadByPrimaryKey(e.BankID))
                            {
                                cAccount = ValidateCOA(bankEntity.ChartOfAccountId ?? 0, coaColl,
                                    string.Format(""));
                                cSubledgerId = bankEntity.SubledgerId.HasValue ? bankEntity.SubledgerId.Value : 0;
                            }
                            else
                            {
                                throw new Exception(string.Format("Bank with ID {0} not found.", e.BankID));
                            }
                        }
                        else
                        {
                            ValidateCOA(cAccount, coaColl,
                                string.Format("Payment type {0}, payment method {1}", pt.PaymentTypeName, pm.PaymentMethodName));
                        }
                    }
                    else
                    {
                        throw new Exception(string.Format("Payment type {}: Payment method {}: data not found.", pt.PaymentTypeName, e.SRInvoicePayment));
                    }
                }
                else
                {
                    throw new Exception("Invalid payment type of PaymentType-006.");
                }

                var bankLine = new JournalTransactionDetails();
                bankLine.AddNew();
                bankLine.JournalId = headerJournal.JournalId;
                bankLine.ChartOfAccountId = cAccount;
                bankLine.SubLedgerId = cSubledgerId;

                //bankLine.Debit = 0;
                //bankLine.Credit = tPay;
                bankLine.Debit = (tPay < 0) ? Abs(tPay) : 0;
                bankLine.Credit = (tPay >= 0) ? tPay : 0;

                bankLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                bankLine.DocumentNumber = e.InvoiceNo;
                AddMoreInfo(bankLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                    string.Empty, string.Empty, string.Empty);
                bankLine.Save();
                totalDebit += bankLine.Debit.Value;
                totalCredit += bankLine.Credit.Value;

                // hutang ppn
                if (ppnAmountMedicTotal != 0 || ppnAmountNonMedicTotal != 0)
                {
                    var coaPpnTerhutang = GetCachedAccountFromParam("coa_PpnPayable");
                    var ppnTerhutang = ppnAmountMedicTotal + ppnAmountNonMedicTotal;
                    var jPpn = new JournalTransactionDetails
                    {
                        JournalId = headerJournal.JournalId,
                        ChartOfAccountId = ValidateCOA(coaPpnTerhutang, coaColl, "AppParameter: coa_PpnPayable"),
                        SubLedgerId = 0,
                        Debit = ((ppnTerhutang < 0) ? Abs(ppnTerhutang) : 0),
                        Credit = ((ppnTerhutang >= 0) ? ppnTerhutang : 0),
                        Description = string.Format("Payable TAX (Ppn) #:{0}. SUP:{1}", e.InvoiceNo, sup.SupplierName),
                        DocumentNumber = e.InvoiceNo
                    };
                    AddMoreInfo(jPpn, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                        string.Empty, string.Empty, string.Empty);
                    jPpn.Save();
                    totalDebit += jPpn.Debit.Value;
                    totalCredit += jPpn.Credit.Value;
                }

                // uang muka
                if (IsDpOnReceivingInv)
                {
                    //uang muka dari cash entry, gimana cara ambil akunnya?
                    if (tUm > 0)
                    {

                    }
                }

                //if (totalCredit > 0 && bankEntity != null) --> payment kemungkinan bisa minus
                if (bankLine.Debit.Value + bankLine.Credit.Value != 0 && bankEntity != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    //int? cashTransactionId;
                    //CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                    //                                               "AP", "SUPPAYMNT",
                    //                                               pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                    //                                               bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                    //                                               headerJournal.Description, headerJournal.JournalId.Value,
                    //                                               editedBy,
                    //                                               dAccount,
                    //                                               grandTotalBankAmount,  // Account Payable Amount. Should be in original currency
                    //                                                dSubLedgerId, out cashTransactionId);

                    // prevent duplicate cash entry transaction when reprocessing journal is fired
                    var ceColl = new CashTransactionCollection();
                    ceColl.Query.Where(ceColl.Query.DocumentNumber == e.InvoiceNo && ceColl.Query.IsVoid != true);
                    if (ceColl.LoadAll())
                    {
                        var ce = ceColl.First();

                        if (ce.IsCleared ?? false)
                        {
                            throw new Exception("Cash transaction already cleared");
                        }

                        CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                        ce = new CashTransaction();
                        if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                        {
                            ce.Void(editedBy);
                        }

                        ceColl.Save();
                    }

                    int? cashTransactionId;

                    //var dAcc = dAccount;
                    //if (dAcc == 0) dAcc = dAccountNM;

                    CashTransaction.AddNewAutomaticCashTransactionAP(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                                                                    "AP", "SUPPAYMNT",
                                                                    pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                                                                    bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                                                                    headerJournal.Description, headerJournal.JournalId.Value,
                                                                    editedBy,
                                                                    dAccount,
                                                                    // Account Payable Amount. Should be in original currency
                                                                    dSubLedgerId, out cashTransactionId, dAccountNM, tHutangM, tHutangNm, dAccount_loss, cAccount_profit, grandTotalProfitLoss);


                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (headerJournal.JournalId.HasValue && headerJournal.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, headerJournal.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        headerJournal.BeginEdit();
                        headerJournal.IsPosted = true;
                        headerJournal.EndEdit();
                        headerJournal.Save();
                    }
                }

                return headerJournal.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAPPaymentJournal2RSMM(InvoiceSupplier e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = BusinessObject.JournalType.APPayment;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal grandTotalBankAmount = 0;
                decimal grandTotalProfitLoss = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;
                int dAccountNM = 0;
                int dSubLedgerIdNM = 0;

                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                var eItems = new InvoiceSupplierItemCollection();
                eItems.Query.Where(eItems.Query.InvoiceNo == e.InvoiceNo);
                if (!eItems.Query.Load())
                    return 0;

                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalAPPaymentDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        e.InvoiceDate.Value.Date : e.PaymentApprovedDateTime.Value.Date;

                //Journal Header
                var headerJournal = new JournalTransactions();
                if (headerJournal.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(headerJournal);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == headerJournal.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    headerJournal.LastUpdateDateTime = DateTime.Now;
                    //headerJournal.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(headerJournal);

                    headerJournal.Save();
                }
                else
                {
                    headerJournal.AddNew();
                    headerJournal.JournalType = journalType;
                    headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("APP", jDate);
                    headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                    headerJournal.TransactionDate = jDate;
                    headerJournal.Description = string.Format("INV#:{0}. SUP#:{1}. {2}", e.InvoiceNo, sup.SupplierName, e.InvoiceNotes);
                    headerJournal.IsPosted = false;
                    headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                    headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                    headerJournal.RefferenceNumber = e.InvoiceNo;

                    headerJournal.Save();
                    ValidateClosingPeriode(headerJournal);
                }

                journalId = headerJournal.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();

                var IsApNMSeparated = false;
                var PrmApNMSeparated = new AppParameter();
                if (PrmApNMSeparated.LoadByPrimaryKey("IsCoaAPNonMedicSeparated"))
                {
                    IsApNMSeparated = (PrmApNMSeparated.ParameterValue == "Yes");
                }

                dAccount = sup.ChartOfAccountIdAP ?? 0;
                dSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                dAccountNM = sup.ChartOfAccountIdAPNonMedic ?? 0;
                dSubLedgerIdNM = sup.SubledgerIdAPNonMedic.HasValue ? sup.SubledgerIdAPNonMedic.Value : 0;

                int dAccount_loss = GetCachedAccountFromParam("coa_inventory_loss");
                int cAccount_profit = GetCachedAccountFromParam("coa_inventory_profit");

                decimal tPay = 0;

                Bank bankEntity = null;
                var pt = new PaymentType();
                var pm = new PaymentMethod();

                if (pt.LoadByPrimaryKey("PaymentType-006"))
                {
                    if (pm.LoadByPrimaryKey("PaymentType-006", e.SRInvoicePayment))
                    {
                        cAccount = pm.ChartOfAccountID.HasValue ? pm.ChartOfAccountID.Value : 0;
                        cSubledgerId = pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0;

                        if (string.IsNullOrEmpty(e.BankID))
                        {
                            // cari setting bank dari master payment type
                            var bColl = new BankCollection();
                            bColl.Query.Where(bColl.Query.ChartOfAccountId == (pm.ChartOfAccountID ?? 0));
                            if (bColl.LoadAll())
                            {
                                e.BankID = bColl.First().BankID;
                            }
                        }

                        if (!string.IsNullOrEmpty(e.BankID))
                        {
                            bankEntity = new Bank();
                            if (bankEntity.LoadByPrimaryKey(e.BankID))
                            {
                                cAccount = ValidateCOA(bankEntity.ChartOfAccountId ?? 0, coaColl,
                                    string.Format(""));
                                cSubledgerId = bankEntity.SubledgerId.HasValue ? bankEntity.SubledgerId.Value : 0;
                            }
                            else
                            {
                                throw new Exception(string.Format("Bank with ID {0} not found.", e.BankID));
                            }
                        }
                        else
                        {
                            ValidateCOA(cAccount, coaColl,
                                string.Format("Payment type {0}, payment method {1}", pt.PaymentTypeName, pm.PaymentMethodName));
                        }
                    }
                    else
                    {
                        throw new Exception(string.Format("Payment type {}: Payment method {}: data not found.", pt.PaymentTypeName, e.SRInvoicePayment));
                    }
                }
                else
                {
                    throw new Exception("Invalid payment type of PaymentType-006.");
                }


                var paColl = new ProductAccountCollection();
                paColl.LoadAll();

                foreach (var p in eItems)
                {
                    var it = new ItemTransaction();
                    it.LoadByPrimaryKey(p.TransactionNo);
                    decimal? hutang = (p.PaymentAmount) * (it.CurrencyRate ?? 1);

                    var isMedic = p.SRItemType == "11";

                    var itiColl = new ItemTransactionItemCollection();
                    itiColl.Query.Where(itiColl.Query.TransactionNo == p.TransactionNo);
                    if (itiColl.LoadAll())
                    {
                        var tax = it.TaxAmount;
                        var totalTrans = itiColl.Sum(x => x.Quantity.Value * x.Price.Value);
                        // dikelompokkan per product account
                        var itemColl = new ItemCollection();
                        itemColl.Query.Where(itemColl.Query.ItemID.In(itiColl.Select(x => x.ItemID)));
                        itemColl.LoadAll();

                        foreach (var pa in itemColl.Select(x => x.ProductAccountID).Distinct())
                        {
                            var sumPA = itiColl.Where(x => (
                                    itemColl
                                    .Where(y => y.ProductAccountID == pa)
                                    .Select(y => y.ItemID)).Contains(x.ItemID))
                                .Sum(x => x.Quantity.Value * x.Price.Value);
                            var paPercentage = sumPA / totalTrans;

                            //karena kurs bisa berbeda saat penerimaan & pembayaran, maka amount yg dipakai untuk sisi debit adalah amount saat penerimaan
                            var apLine = new JournalTransactionDetails();
                            apLine.AddNew();
                            apLine.JournalId = headerJournal.JournalId;

                            apLine.ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                                ValidateCOA(dAccountNM, coaColl, string.Format("Supplier {0}: Chart Of Account A/P Non Medical", sup.SupplierName)) :
                                ValidateCOA(dAccount, coaColl, string.Format("Supplier {0}: Chart Of Account A/P", sup.SupplierName));
                            apLine.SubLedgerId = (IsApNMSeparated && !isMedic) ? dSubLedgerIdNM : dSubLedgerId;
                            // decimal? apAmount = e.VerifyAmount + e.PPnAmount;
                            // apLine.Debit = apAmount;
                            var newHutang = (hutang * paPercentage);
                            apLine.Debit = (newHutang >= 0) ? newHutang : 0;
                            apLine.Credit = (newHutang < 0) ? Abs(newHutang) : 0;
                            apLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}. ProductAccount:{3} Inv. {4}",
                                e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo,
                                (paColl.Where(x => x.ProductAccountID == pa).Select(x => x.ProductAccountName).FirstOrDefault()),
                                it.InvoiceNo);

                            apLine.DocumentNumber = e.InvoiceNo;
                            AddMoreInfo(apLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            apLine.Save();

                            totalDebit += apLine.Debit.Value;
                            totalCredit += apLine.Credit.Value;

                            var bankLine = new JournalTransactionDetails();
                            bankLine.AddNew();
                            bankLine.JournalId = headerJournal.JournalId;
                            bankLine.ChartOfAccountId = cAccount;
                            bankLine.SubLedgerId = cSubledgerId;

                            //bankLine.Debit = 0;
                            //bankLine.Credit = tPay;
                            bankLine.Debit = (newHutang < 0) ? Abs(newHutang) : 0;
                            bankLine.Credit = (newHutang >= 0) ? newHutang : 0;

                            bankLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}. ProductAccount:{3}",
                                e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo,
                                (paColl.Where(x => x.ProductAccountID == pa).Select(x => x.ProductAccountName).FirstOrDefault()));
                            bankLine.DocumentNumber = e.InvoiceNo;
                            AddMoreInfo(bankLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            bankLine.Save();
                            totalDebit += bankLine.Debit.Value;
                            totalCredit += bankLine.Credit.Value;
                        }
                    }
                    else
                    {
                        //karena kurs bisa berbeda saat penerimaan & pembayaran, maka amount yg dipakai untuk sisi debit adalah amount saat penerimaan
                        var apLine = new JournalTransactionDetails();
                        apLine.AddNew();
                        apLine.JournalId = headerJournal.JournalId;

                        apLine.ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                            ValidateCOA(dAccountNM, coaColl, string.Format("Supplier {0}: Chart Of Account A/P Non Medical", sup.SupplierName)) :
                            ValidateCOA(dAccount, coaColl, string.Format("Supplier {0}: Chart Of Account A/P", sup.SupplierName));
                        apLine.SubLedgerId = (IsApNMSeparated && !isMedic) ? dSubLedgerIdNM : dSubLedgerId;
                        // decimal? apAmount = e.VerifyAmount + e.PPnAmount;
                        // apLine.Debit = apAmount;
                        apLine.Debit = (hutang >= 0) ? hutang : 0;
                        apLine.Credit = (hutang < 0) ? Abs(hutang) : 0;
                        apLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        apLine.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(apLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        apLine.Save();

                        totalDebit += apLine.Debit.Value;
                        totalCredit += apLine.Credit.Value;

                        var bankLine = new JournalTransactionDetails();
                        bankLine.AddNew();
                        bankLine.JournalId = headerJournal.JournalId;
                        bankLine.ChartOfAccountId = cAccount;
                        bankLine.SubLedgerId = cSubledgerId;

                        //bankLine.Debit = 0;
                        //bankLine.Credit = tPay;
                        bankLine.Debit = (hutang < 0) ? Abs(hutang) : 0;
                        bankLine.Credit = (hutang >= 0) ? hutang : 0;

                        bankLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        bankLine.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(bankLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        bankLine.Save();
                        totalDebit += bankLine.Debit.Value;
                        totalCredit += bankLine.Credit.Value;
                    }

                    decimal? totalBankAmount = p.PaymentAmount * p.CurrencyRate;
                    tPay += totalBankAmount.Value;

                    // grandTotalBankAmount += totalBankAmount ?? 0;
                    grandTotalBankAmount += hutang ?? 0; // hutang yang dipakai karena nilai hutang saat pembayaran hrs sama dengan POR

                    // jurnal tambahan apbila kurs berbeda pada saat penerimaan barang dengan pembayaran
                    if (hutang > totalBankAmount && cAccount_profit != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = ValidateCOA(cAccount_profit, coaColl,
                            "App Parameter: coa_inventory_profit");
                        additional.SubLedgerId = 0;
                        additional.Debit = 0;
                        additional.Credit = hutang - totalBankAmount;
                        additional.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        additional.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(additional, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        additional.Save();
                        totalCredit += additional.Credit.Value;
                        grandTotalProfitLoss += (hutang ?? 0) - (totalBankAmount ?? 0);

                        var bankLine = new JournalTransactionDetails();
                        bankLine.AddNew();
                        bankLine.JournalId = headerJournal.JournalId;
                        bankLine.ChartOfAccountId = cAccount;
                        bankLine.SubLedgerId = cSubledgerId;

                        //bankLine.Debit = 0;
                        //bankLine.Credit = tPay;
                        bankLine.Debit = hutang - totalBankAmount;
                        bankLine.Credit = 0;

                        bankLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        bankLine.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(bankLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        bankLine.Save();
                        totalDebit += bankLine.Debit.Value;
                        totalCredit += bankLine.Credit.Value;
                    }
                    else if (hutang < totalBankAmount && dAccount_loss != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = ValidateCOA(dAccount_loss, coaColl,
                            "App Parameter: coa_inventory_loss");
                        additional.SubLedgerId = 0;
                        additional.Debit = totalBankAmount - hutang;
                        additional.Credit = 0;
                        additional.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        additional.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(additional, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        additional.Save();
                        totalCredit += additional.Debit.Value;
                        grandTotalProfitLoss += (totalBankAmount ?? 0) - (hutang ?? 0);

                        var bankLine = new JournalTransactionDetails();
                        bankLine.AddNew();
                        bankLine.JournalId = headerJournal.JournalId;
                        bankLine.ChartOfAccountId = cAccount;
                        bankLine.SubLedgerId = cSubledgerId;

                        //bankLine.Debit = 0;
                        //bankLine.Credit = tPay;
                        bankLine.Debit = 0;
                        bankLine.Credit = totalBankAmount - hutang;

                        bankLine.Description = string.Format("INV#:{0}. SUP#:{1}. InvRef#:{2}", e.InvoiceNo, sup.SupplierName, p.InvoiceReferenceNo);
                        bankLine.DocumentNumber = e.InvoiceNo;
                        AddMoreInfo(bankLine, string.Empty, string.Empty, e.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        bankLine.Save();
                        totalDebit += bankLine.Debit.Value;
                        totalCredit += bankLine.Credit.Value;
                    }
                }

                //if (totalCredit > 0 && bankEntity != null) --> payment kemungkinan bisa minus
                if (tPay != 0 && bankEntity != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    //int? cashTransactionId;
                    //CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                    //                                               "AP", "SUPPAYMNT",
                    //                                               pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                    //                                               bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                    //                                               headerJournal.Description, headerJournal.JournalId.Value,
                    //                                               editedBy,
                    //                                               dAccount,
                    //                                               grandTotalBankAmount,  // Account Payable Amount. Should be in original currency
                    //                                                dSubLedgerId, out cashTransactionId);

                    // prevent duplicate cash entry transaction when reprocessing journal is fired
                    var ceColl = new CashTransactionCollection();
                    ceColl.Query.Where(ceColl.Query.DocumentNumber == e.InvoiceNo && ceColl.Query.IsVoid != true);
                    ceColl.LoadAll();
                    if (ceColl.Count > 0)
                    {
                        foreach (var ce in ceColl)
                        {
                            ce.IsPosted = false; ce.IsVoid = true;
                            ce.Description = ce.Description + "(reprocessing)";
                            CashTransaction.UnPostingUpdateBalance(ce.TransactionId ?? 0);
                        }
                    }
                    ceColl.Save();

                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransactionAP(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                                                                   "AP", "SUPPAYMNT",
                                                                   pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                                                                   bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                                                                   headerJournal.Description, headerJournal.JournalId.Value,
                                                                   editedBy,
                                                                   dAccount,
                                                                   // Account Payable Amount. Should be in original currency
                                                                   dSubLedgerId, out cashTransactionId, dAccount, grandTotalBankAmount, 0, dAccount_loss, cAccount_profit, grandTotalProfitLoss);


                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (headerJournal.JournalId.HasValue && headerJournal.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, headerJournal.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        headerJournal.BeginEdit();
                        headerJournal.IsPosted = true;
                        headerJournal.EndEdit();
                        headerJournal.Save();
                    }
                }

                return headerJournal.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAPPaymentJournal(InvoiceSupplier e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = BusinessObject.JournalType.APPayment;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal grandTotalBankAmount = 0;
                decimal grandTotalProfitLoss = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                var eItems = new InvoiceSupplierItemCollection();
                eItems.Query.Where(eItems.Query.InvoiceNo == e.InvoiceNo);
                if (!eItems.Query.Load())
                    return 0;

                Bank bankEntity = null;

                dAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                dSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                var pm = new PaymentMethod();
                if (pm.LoadByPrimaryKey("PaymentType-006", e.SRInvoicePayment))
                {
                    if (e.SRInvoicePayment == "PaymentMethod-001")
                    {
                        cAccount = pm.ChartOfAccountID.HasValue ? pm.ChartOfAccountID.Value : 0;
                        cSubledgerId = pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0;

                        bankEntity = new Bank();
                        bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                        if (!bankEntity.Query.Load()) return 0;
                    }
                    else
                    {
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(e.BankID))
                            if (!bankEntity.ChartOfAccountId.HasValue)
                                return 0;

                        cAccount = bankEntity.ChartOfAccountId.HasValue ? bankEntity.ChartOfAccountId.Value : 0;
                        cSubledgerId = bankEntity.SubledgerId.HasValue ? bankEntity.SubledgerId.Value : 0;
                    }
                }

                if (dAccount == 0 || cAccount == 0)
                    return 0;

                int dAccount_loss = GetCachedAccountFromParam("coa_inventory_loss");
                int cAccount_profit = GetCachedAccountFromParam("coa_inventory_profit");

                //Journal Header
                var headerJournal = new JournalTransactions();
                if (headerJournal.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == headerJournal.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    headerJournal.LastUpdateDateTime = DateTime.Now;
                    //headerJournal.LastUpdateByUserID = editedBy;
                }
                else
                {
                    var appprmdate = new AppParameter();
                    DateTime jDate = DateTime.Now;
                    if (appprmdate.LoadByPrimaryKey("acc_JournalAPPaymentDate"))
                        jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                            e.InvoiceDate.Value.Date : e.PaymentApprovedDateTime.Value.Date;

                    headerJournal.AddNew();
                    headerJournal.JournalType = journalType;
                    //headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("APP", e.InvoiceDate.Value);
                    headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("APP", jDate);
                    headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                    //headerJournal.TransactionDate = e.InvoiceDate;
                    headerJournal.TransactionDate = jDate;
                    headerJournal.Description = string.Format("INV#:{0}. SUP#:{1}. {2}", e.InvoiceNo, sup.SupplierName, e.InvoiceNotes);
                    headerJournal.IsPosted = false;
                    headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                    headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                    headerJournal.RefferenceNumber = e.InvoiceNo;
                }
                headerJournal.Save();

                foreach (var p in eItems)
                {
                    var it = new ItemTransaction();
                    it.LoadByPrimaryKey(p.TransactionNo);
                    decimal? hutang = (p.PaymentAmount) * (it.CurrencyRate ?? 1);

                    //karena kurs bisa berbeda saat penerimaan & pembayaran, maka amount yg dipakai untuk sisi debit adalah amount saat penerimaan
                    var apLine = new JournalTransactionDetails();
                    apLine.AddNew();
                    apLine.JournalId = headerJournal.JournalId;
                    apLine.ChartOfAccountId = dAccount;
                    apLine.SubLedgerId = dSubLedgerId;
                    // decimal? apAmount = e.VerifyAmount + e.PPnAmount;
                    // apLine.Debit = apAmount;
                    apLine.Debit = hutang;
                    apLine.Credit = 0;
                    apLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    apLine.DocumentNumber = e.InvoiceNo;
                    apLine.Save();
                    totalDebit += apLine.Debit.Value;

                    var bankLine = new JournalTransactionDetails();
                    bankLine.AddNew();
                    bankLine.JournalId = headerJournal.JournalId;
                    bankLine.ChartOfAccountId = cAccount;
                    bankLine.SubLedgerId = cSubledgerId;
                    bankLine.Debit = 0;
                    // this total will be used in cash transaction
                    decimal? totalBankAmount = p.PaymentAmount * p.CurrencyRate;
                    bankLine.Credit = totalBankAmount;
                    bankLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    bankLine.DocumentNumber = e.InvoiceNo;
                    bankLine.Save();
                    totalCredit += bankLine.Credit.Value;
                    // grandTotalBankAmount += totalBankAmount ?? 0;
                    grandTotalBankAmount += hutang ?? 0; // hutang yang dipakai karena nilai hutang saat pembayaran hrs sama dengan POR

                    // jurnal tambahan apbila kurs berbeda pada saat penerimaan barang dengan pembayaran
                    if (hutang > totalBankAmount && cAccount_profit != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = cAccount_profit;
                        additional.SubLedgerId = 0;
                        additional.Debit = 0;
                        additional.Credit = hutang - totalBankAmount;
                        additional.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                        additional.DocumentNumber = e.InvoiceNo;
                        additional.Save();
                        totalCredit += additional.Credit.Value;
                        grandTotalProfitLoss += (hutang ?? 0) - (totalBankAmount ?? 0);
                    }
                    else if (hutang < totalBankAmount && dAccount_loss != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = dAccount_loss;
                        additional.SubLedgerId = 0;
                        additional.Debit = totalBankAmount - hutang;
                        additional.Credit = 0;
                        additional.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                        additional.DocumentNumber = e.InvoiceNo;
                        additional.Save();
                        totalCredit += additional.Debit.Value;
                        grandTotalProfitLoss += (totalBankAmount ?? 0) - (hutang ?? 0);
                    }

                    //PPN
                    //int cAccount_PPN = GetCachedAccountFromParam("coa_Ppn");
                    //if (cAccount_PPN == 0)
                    //    return 0;

                    //if (e.PPnAmount > 0)
                    //{
                    //    JournalTransactionDetails ppnLine = new JournalTransactionDetails();
                    //    ppnLine.AddNew();
                    //    ppnLine.JournalId = headerJournal.JournalId;
                    //    ppnLine.ChartOfAccountId = cAccount_PPN;
                    //    ppnLine.SubLedgerId = 0;
                    //    ppnLine.Debit = 0;
                    //    ppnLine.Credit = e.PPnAmount;
                    //    ppnLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    //    ppnLine.DocumentNumber = e.InvoiceNo;
                    //    ppnLine.Save();
                    //}

                    ////PPH 22
                    //int cAccount_PPH22 = GetCachedAccountFromParam("coa_Pph22");
                    //if (cAccount_PPH22 == 0)
                    //    return 0;

                    //if (e.PPh22Amount > 0)
                    //{
                    //    JournalTransactionDetails pphLine = new JournalTransactionDetails();
                    //    pphLine.AddNew();
                    //    pphLine.JournalId = headerJournal.JournalId;
                    //    pphLine.ChartOfAccountId = cAccount_PPH22;
                    //    pphLine.SubLedgerId = 0;
                    //    pphLine.Debit = 0;
                    //    pphLine.Credit = e.PPh22Amount;
                    //    pphLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    //    pphLine.DocumentNumber = e.InvoiceNo;
                    //    pphLine.Save();
                    //}

                    ////PPH 23
                    //int cAccount_PPH23 = GetCachedAccountFromParam("coa_Pph23");
                    //if (cAccount_PPH23 == 0)
                    //    return 0;

                    //if (e.PPh23Amount > 0)
                    //{
                    //    JournalTransactionDetails pph23Line = new JournalTransactionDetails();
                    //    pph23Line.AddNew();
                    //    pph23Line.JournalId = headerJournal.JournalId;
                    //    pph23Line.ChartOfAccountId = cAccount_PPH23;
                    //    pph23Line.SubLedgerId = 0;
                    //    pph23Line.Debit = 0;
                    //    pph23Line.Credit = e.PPh23Amount;
                    //    pph23Line.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    //    pph23Line.DocumentNumber = e.InvoiceNo;
                    //    pph23Line.Save();
                    //}

                }

                if (totalCredit != 0 && bankEntity != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    //int? cashTransactionId;
                    //CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                    //                                               "AP", "SUPPAYMNT",
                    //                                               pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                    //                                               bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                    //                                               headerJournal.Description, headerJournal.JournalId.Value,
                    //                                               editedBy,
                    //                                               dAccount,
                    //                                               grandTotalBankAmount,  // Account Payable Amount. Should be in original currency
                    //                                                dSubLedgerId, out cashTransactionId);
                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransactionAP(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                                                                   "AP", "SUPPAYMNT",
                                                                   pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                                                                   bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                                                                   headerJournal.Description, headerJournal.JournalId.Value,
                                                                   editedBy,
                                                                   dAccount,
                                                                   // Account Payable Amount. Should be in original currency
                                                                   dSubLedgerId, out cashTransactionId, dAccount, grandTotalBankAmount, 0, dAccount_loss, cAccount_profit, grandTotalProfitLoss);


                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (headerJournal.JournalId.HasValue && headerJournal.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, headerJournal.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(journalId, editedBy);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit != 0 && totalDebit != 0) && (totalDebit == totalCredit))
                    {
                        headerJournal.BeginEdit();
                        headerJournal.IsPosted = true;
                        headerJournal.EndEdit();
                        headerJournal.Save();
                    }
                }

                return headerJournal.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewAPAddPaymentJournal(InvoiceSupplier e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = BusinessObject.JournalType.APPayment;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal grandTotalBankAmount = 0;
                decimal grandTotalProfitLoss = 0;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                var eItems = new InvoiceAdjusmentCollection();
                eItems.Query.Where(eItems.Query.InvoicePaymentNo == e.InvoiceNo);
                if (!eItems.Query.Load())
                    return 0;

                Bank bankEntity = null;

                dAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                dSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                var pm = new PaymentMethod();
                if (pm.LoadByPrimaryKey("PaymentType-006", e.SRInvoicePayment))
                {
                    if (e.SRInvoicePayment == "PaymentMethod-001")
                    {
                        cAccount = pm.ChartOfAccountID.HasValue ? pm.ChartOfAccountID.Value : 0;
                        cSubledgerId = pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0;

                        bankEntity = new Bank();
                        bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                        if (!bankEntity.Query.Load()) return 0;
                    }
                    else
                    {
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(e.BankID))
                            if (!bankEntity.ChartOfAccountId.HasValue)
                                return 0;

                        cAccount = bankEntity.ChartOfAccountId.HasValue ? bankEntity.ChartOfAccountId.Value : 0;
                        cSubledgerId = bankEntity.SubledgerId.HasValue ? bankEntity.SubledgerId.Value : 0;
                    }
                }

                if (dAccount == 0 || cAccount == 0)
                    return 0;

                int dAccount_loss = GetCachedAccountFromParam("coa_inventory_loss");
                int cAccount_profit = GetCachedAccountFromParam("coa_inventory_profit");

                //Journal Header
                var headerJournal = new JournalTransactions();
                headerJournal.AddNew();
                headerJournal.JournalType = journalType;
                headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("APP", e.InvoiceDate.Value);
                headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                headerJournal.TransactionDate = e.InvoiceDate;
                headerJournal.Description = string.Format("ADD INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                headerJournal.IsPosted = false;
                headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                headerJournal.RefferenceNumber = e.InvoiceNo;
                headerJournal.Save();

                foreach (var p in eItems)
                {
                    decimal? hutang = p.PaymentAmount;

                    //karena kurs bisa berbeda saat penerimaan & pembayaran, maka amount yg dipakai untuk sisi debit adalah amount saat penerimaan
                    var apLine = new JournalTransactionDetails();
                    apLine.AddNew();
                    apLine.JournalId = headerJournal.JournalId;
                    apLine.ChartOfAccountId = dAccount;
                    apLine.SubLedgerId = dSubLedgerId;
                    // decimal? apAmount = e.VerifyAmount + e.PPnAmount;
                    // apLine.Debit = apAmount;
                    apLine.Debit = hutang;
                    apLine.Credit = 0;
                    apLine.Description = string.Format("ADD INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    apLine.DocumentNumber = e.InvoiceNo;
                    apLine.Save();
                    totalDebit += apLine.Debit.Value;

                    var bankLine = new JournalTransactionDetails();
                    bankLine.AddNew();
                    bankLine.JournalId = headerJournal.JournalId;
                    bankLine.ChartOfAccountId = cAccount;
                    bankLine.SubLedgerId = cSubledgerId;
                    bankLine.Debit = 0;
                    // this total will be used in cash transaction
                    decimal? totalBankAmount = p.PaymentAmount;
                    bankLine.Credit = totalBankAmount;
                    bankLine.Description = string.Format("ADD INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    bankLine.DocumentNumber = e.InvoiceNo;
                    bankLine.Save();
                    totalCredit += bankLine.Credit.Value;
                    // grandTotalBankAmount += totalBankAmount ?? 0;
                    grandTotalBankAmount += hutang ?? 0; // hutang yang dipakai karena nilai hutang saat pembayaran hrs sama dengan POR

                    // jurnal tambahan apbila kurs berbeda pada saat penerimaan barang dengan pembayaran
                    if (hutang > totalBankAmount && cAccount_profit != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = cAccount_profit;
                        additional.SubLedgerId = 0;
                        additional.Debit = 0;
                        additional.Credit = hutang - totalBankAmount;
                        additional.Description = string.Format("ADD INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                        additional.DocumentNumber = e.InvoiceNo;
                        additional.Save();
                        totalCredit += additional.Credit.Value;
                        grandTotalProfitLoss += (hutang ?? 0) - (totalBankAmount ?? 0);
                    }
                    else if (hutang < totalBankAmount && dAccount_loss != 0)
                    {
                        var additional = new JournalTransactionDetails();
                        additional.AddNew();
                        additional.JournalId = headerJournal.JournalId;
                        additional.ChartOfAccountId = dAccount_loss;
                        additional.SubLedgerId = 0;
                        additional.Debit = totalBankAmount - hutang;
                        additional.Credit = 0;
                        additional.Description = string.Format("ADD INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                        additional.DocumentNumber = e.InvoiceNo;
                        additional.Save();
                        totalCredit += additional.Debit.Value;
                        grandTotalProfitLoss += (totalBankAmount ?? 0) - (hutang ?? 0);
                    }

                    //PPN
                    //int cAccount_PPN = GetCachedAccountFromParam("coa_Ppn");
                    //if (cAccount_PPN == 0)
                    //    return 0;

                    //if (e.PPnAmount > 0)
                    //{
                    //    JournalTransactionDetails ppnLine = new JournalTransactionDetails();
                    //    ppnLine.AddNew();
                    //    ppnLine.JournalId = headerJournal.JournalId;
                    //    ppnLine.ChartOfAccountId = cAccount_PPN;
                    //    ppnLine.SubLedgerId = 0;
                    //    ppnLine.Debit = 0;
                    //    ppnLine.Credit = e.PPnAmount;
                    //    ppnLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    //    ppnLine.DocumentNumber = e.InvoiceNo;
                    //    ppnLine.Save();
                    //}

                    ////PPH 22
                    //int cAccount_PPH22 = GetCachedAccountFromParam("coa_Pph22");
                    //if (cAccount_PPH22 == 0)
                    //    return 0;

                    //if (e.PPh22Amount > 0)
                    //{
                    //    JournalTransactionDetails pphLine = new JournalTransactionDetails();
                    //    pphLine.AddNew();
                    //    pphLine.JournalId = headerJournal.JournalId;
                    //    pphLine.ChartOfAccountId = cAccount_PPH22;
                    //    pphLine.SubLedgerId = 0;
                    //    pphLine.Debit = 0;
                    //    pphLine.Credit = e.PPh22Amount;
                    //    pphLine.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    //    pphLine.DocumentNumber = e.InvoiceNo;
                    //    pphLine.Save();
                    //}

                    ////PPH 23
                    //int cAccount_PPH23 = GetCachedAccountFromParam("coa_Pph23");
                    //if (cAccount_PPH23 == 0)
                    //    return 0;

                    //if (e.PPh23Amount > 0)
                    //{
                    //    JournalTransactionDetails pph23Line = new JournalTransactionDetails();
                    //    pph23Line.AddNew();
                    //    pph23Line.JournalId = headerJournal.JournalId;
                    //    pph23Line.ChartOfAccountId = cAccount_PPH23;
                    //    pph23Line.SubLedgerId = 0;
                    //    pph23Line.Debit = 0;
                    //    pph23Line.Credit = e.PPh23Amount;
                    //    pph23Line.Description = string.Format("INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                    //    pph23Line.DocumentNumber = e.InvoiceNo;
                    //    pph23Line.Save();
                    //}

                }

                if (totalCredit > 0 && bankEntity != null)
                {
                    // string paymentMethod = e.SRInvoicePayment == "2" ? "PaymentMethod-004" : "PaymentMethod-001";
                    //int? cashTransactionId;
                    //CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                    //                                               "AP", "SUPPAYMNT",
                    //                                               pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                    //                                               bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                    //                                               headerJournal.Description, headerJournal.JournalId.Value,
                    //                                               editedBy,
                    //                                               dAccount,
                    //                                               grandTotalBankAmount,  // Account Payable Amount. Should be in original currency
                    //                                                dSubLedgerId, out cashTransactionId);
                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransactionAP(bankEntity.BankID, cAccount, e.InvoiceDate.Value,
                                                                   "AP", "SUPPAYMNT",
                                                                   pm.SRPaymentTypeID, e.SRInvoicePayment, "K",
                                                                   bankEntity.CurrencyCode, 1, e.BankAccountNo, e.InvoiceNo,
                                                                   headerJournal.Description, headerJournal.JournalId.Value,
                                                                   editedBy,
                                                                   dAccount,
                                                                   // Account Payable Amount. Should be in original currency
                                                                   dSubLedgerId, out cashTransactionId, dAccount, grandTotalBankAmount, 0, dAccount_loss, cAccount_profit, grandTotalProfitLoss);


                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (headerJournal.JournalId.HasValue && headerJournal.JournalId.Value > 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, headerJournal.JournalId.Value);
                    }
                }
                BkuJournalTransactions.AddBkuJournalByJournalTransactions(headerJournal.JournalId ?? 0, editedBy);
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        headerJournal.BeginEdit();
                        headerJournal.IsPosted = true;
                        headerJournal.EndEdit();
                        headerJournal.Save();
                    }
                }

                return headerJournal.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewConsignmentInvoicingJournal(InvoiceSupplier e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = BusinessObject.JournalType.ConsignmentInvoicing;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;


                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                //var itm = new InvoiceSupplierItem();
                //if (!itm.LoadByPrimaryKey(e.InvoiceNo))
                //    return 0;

                var eItems = new InvoiceSupplierItemCollection();
                eItems.Query.Where(eItems.Query.InvoiceNo == e.InvoiceNo);
                if (!eItems.Query.Load())
                    return 0;

                dAccount = sup.ChartOfAccountIdAPInProcess.HasValue ? sup.ChartOfAccountIdAPInProcess.Value : 0;
                dSubLedgerId = sup.SubledgerIdAPInProcess.HasValue ? sup.SubledgerIdAPInProcess.Value : 0;

                cAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                cSubledgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                if (dAccount == 0 || cAccount == 0)
                    return 0;

                //Journal Header
                var headerJournal = new JournalTransactions();
                headerJournal.AddNew();
                headerJournal.JournalType = journalType;
                headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("CGIV", e.InvoiceDate.Value);
                headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                headerJournal.TransactionDate = e.InvoiceDate;
                headerJournal.Description = string.Format("CONSIGNMENT INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                headerJournal.IsPosted = false;
                headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                headerJournal.RefferenceNumber = e.InvoiceNo;
                headerJournal.Save();

                decimal hutang = 0;
                //sebenarnya hanya 1 faktur saja per nomor invoice
                foreach (var p in eItems)
                {
                    hutang = ((p.Amount ?? 0) * (p.CurrencyRate ?? 1)) + (p.PPnAmount ?? 0);
                }

                var apLine = new JournalTransactionDetails();
                apLine.AddNew();
                apLine.JournalId = headerJournal.JournalId;
                apLine.ChartOfAccountId = dAccount;
                apLine.SubLedgerId = dSubLedgerId;
                apLine.Debit = hutang;
                apLine.Credit = 0;
                apLine.Description = string.Format("CONSIGNMENT INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                apLine.DocumentNumber = e.InvoiceNo;
                apLine.Save();
                totalDebit += apLine.Debit.Value;

                var bankLine = new JournalTransactionDetails();
                bankLine.AddNew();
                bankLine.JournalId = headerJournal.JournalId;
                bankLine.ChartOfAccountId = cAccount;
                bankLine.SubLedgerId = cSubledgerId;
                bankLine.Debit = 0;
                bankLine.Credit = hutang;
                bankLine.Description = string.Format("CONSIGNMENT INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                bankLine.DocumentNumber = e.InvoiceNo;
                bankLine.Save();
                totalCredit += bankLine.Credit.Value;


                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    headerJournal.BeginEdit();
                    headerJournal.IsPosted = true;
                    headerJournal.EndEdit();
                    headerJournal.Save();
                }

                return headerJournal.JournalId;

            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewARInvoicingJournal_DEACTIVATED(Invoices iv, string editedBy, bool isApproval, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AR;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal totalAmount = 0;
                int dAccount = 0;
                int cAccount = 0;
                int dSubledger = 0;
                int cSubledger = 0;

                var guarantor = new Guarantor();
                if (!guarantor.LoadByPrimaryKey(iv.GuarantorID))
                    return -1;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("IV", isApproval ? iv.InvoiceDate.Value : iv.VoidDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var keterangan = isApproval ? "CREATING INVOICE" : "VOID INVOICE";
                var header = new JournalTransactions();
                if (!header.LoadByPrimaryKey(journalId))
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = isApproval ? iv.InvoiceDate.Value : iv.VoidDate.Value;
                    header.Description = string.Format("{0} #: {1}. SUP:{2}.", keterangan, iv.InvoiceNo, guarantor.GuarantorName);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = iv.InvoiceNo;
                    header.Save();
                }
                else
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //header.LastUpdateByUserID = editedBy;
                    header.Save();
                }

                if (isApproval)
                {
                    dAccount = guarantor.ChartOfAccountId.HasValue ? guarantor.ChartOfAccountId.Value : 0;
                    dSubledger = guarantor.SubLedgerId.HasValue ? guarantor.SubLedgerId.Value : 0;
                    cAccount = guarantor.ChartOfAccountIdTemporary.HasValue ? guarantor.ChartOfAccountIdTemporary.Value : 0;
                    cSubledger = guarantor.SubledgerIdTemporary.HasValue ? guarantor.SubledgerIdTemporary.Value : 0;
                }
                else
                {
                    dAccount = guarantor.ChartOfAccountIdTemporary.HasValue ? guarantor.ChartOfAccountIdTemporary.Value : 0;
                    dSubledger = guarantor.SubledgerIdTemporary.HasValue ? guarantor.SubledgerIdTemporary.Value : 0;
                    cAccount = guarantor.ChartOfAccountId.HasValue ? guarantor.ChartOfAccountId.Value : 0;
                    cSubledger = guarantor.SubLedgerId.HasValue ? guarantor.SubLedgerId.Value : 0;
                }

                if (dAccount == 0 || cAccount == 0)
                    return -1;

                var detailInvColl = new InvoicesItemCollection();
                detailInvColl.Query.Where(detailInvColl.Query.InvoiceNo == iv.InvoiceNo);
                detailInvColl.LoadAll();

                foreach (var r in detailInvColl)
                {
                    totalAmount += r.Amount.Value;
                }

                var c = new JournalTransactionDetails
                {
                    JournalId = header.JournalId,
                    ChartOfAccountId = cAccount,
                    SubLedgerId = cSubledger,
                    Debit = 0,
                    Credit = totalAmount,
                    Description = string.Format("{0} #:{1}. GUARANTOR:{2}.", keterangan, iv.InvoiceNo, guarantor.GuarantorName),
                    DocumentNumber = iv.InvoiceNo
                };
                c.AddNew();
                c.Save();
                totalCredit = c.Credit.Value;


                var d = new JournalTransactionDetails
                {
                    JournalId = header.JournalId,
                    ChartOfAccountId = dAccount,
                    SubLedgerId = dSubledger,
                    Debit = totalAmount,
                    Credit = 0,
                    Description = string.Format("{0} #:{1}. GUARANTOR:{2}.", keterangan, iv.InvoiceNo, guarantor.GuarantorName),
                    DocumentNumber = iv.InvoiceNo
                };
                d.AddNew();
                d.Save();
                totalCredit = d.Debit.Value;

                if (totalCredit > 0 && totalDebit > 0 && (totalDebit == totalCredit))
                {
                    header.BeginEdit();
                    header.IsPosted = true;
                    header.EndEdit();
                    header.Save();
                }
                return header.JournalId;
            }
            catch
            {
                return -1;
            }
        }

        public static int? AddNewARInvoicingJournal2Unapproval(Invoices iv, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Invoice
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == iv.InvoiceNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                return AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "IV", editedBy, iv.VoidDate.Value);
            }
        }

        /// <summary>
        /// Jurnal AR Invoice, 
        /// Debet: Piutang Guarantor (satu gepok), Credit: Temporary payment (per nomor payment PM).
        /// Tanggal journal lihat settingan AppParameter: acc_JournalARInvoicingDate
        /// </summary>
        /// <param name="iv"></param>
        /// <param name="editedBy"></param>
        /// <param name="journalId"></param>
        /// <returns></returns>
        public static int? AddNewARInvoicingJournal2(Invoices iv, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AR;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal totalAmountOpr = 0;
                decimal totalAmountIpr = 0;
                int dAccountOpr = 0;
                int dAccountIpr = 0;
                int dSubledgerOpr = 0;
                int dSubledgerIpr;

                int cAccountOpr = 0;
                int cSubledgerOpr = 0;
                int cAccountIpr = 0;
                int cSubledgerIpr = 0;

                int dVatInCoaId = GetCachedAccountFromParam("coa_Ppn");
                int dVatPphInCoaId = GetCachedAccountFromParam("coa_Pph23");
                var coaColl = new ChartOfAccountsCollection();

                var guarantor = new Guarantor();
                if (!guarantor.LoadByPrimaryKey(iv.GuarantorID))
                    return -1;

                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalARInvoicingDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        iv.InvoiceDate.Value.Date : iv.ApprovedDate.Value.Date;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("IV", jDate);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var keterangan = "CREATING INVOICE";
                var header = new JournalTransactions();
                if (!header.LoadByPrimaryKey(journalId))
                {
                    header = new JournalTransactions();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = jDate;
                    header.Description = string.Format("{0} #: {1}. SUP:{2}.", keterangan, iv.InvoiceNo, guarantor.GuarantorName);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = iv.InvoiceNo;

                    header.Save();
                    ValidateClosingPeriode(header);
                }
                else
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //header.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(header);

                    header.Save();
                }

                journalId = header.JournalId.Value;

                var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);
                string dMsg = string.Empty, cMsg = string.Empty;

                AppParameter app = new AppParameter();
                app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                {
                    /* 
                     * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                     * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                     * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                     */
                    dMsg = "COA (A/R Invoice)";
                    cMsg = "COA (A/R Process)";

                    dAccountOpr = guarantor.ChartOfAccountIdTemporary ?? 0;
                    dSubledgerOpr = guarantor.SubledgerIdTemporary ?? 0;
                    dAccountIpr = guarantor.ChartOfAccountIdTemporaryIPR ?? 0;
                    dSubledgerIpr = guarantor.SubledgerIdTemporaryIPR ?? 0;
                    cAccountOpr = guarantor.ChartOfAccountId ?? 0;
                    cSubledgerOpr = guarantor.SubLedgerId ?? 0;
                    cAccountIpr = guarantor.ChartOfAccountIdIPR ?? 0;
                    cSubledgerIpr = guarantor.SubLedgerIdIPR ?? 0;
                }
                else
                {
                    dMsg = "COA (A/R Process)";
                    cMsg = "COA (A/R Invoice)";

                    dAccountOpr = guarantor.ChartOfAccountId ?? 0;
                    dSubledgerOpr = guarantor.SubLedgerId ?? 0;
                    dAccountIpr = guarantor.ChartOfAccountIdIPR ?? 0;
                    dSubledgerIpr = guarantor.SubLedgerIdIPR ?? 0;
                    cAccountOpr = guarantor.ChartOfAccountIdTemporary ?? 0;
                    cSubledgerOpr = guarantor.SubledgerIdTemporary ?? 0;
                    cAccountIpr = guarantor.ChartOfAccountIdTemporaryIPR ?? 0;
                    cSubledgerIpr = guarantor.SubledgerIdTemporaryIPR ?? 0;
                }

                var detailInvColl = new InvoicesItemCollection();
                detailInvColl.Query.Where(detailInvColl.Query.InvoiceNo == iv.InvoiceNo);
                detailInvColl.LoadAll();

                foreach (var r in detailInvColl)
                {
                    var IsIpr = (r.RegistrationNo ?? "").ToUpper().Contains("REG/IP");
                    if (IsSplitIprOpr && IsIpr)
                    {
                        totalAmountIpr += r.Amount.Value;
                        if ((r.PpnAmount ?? 0) > 0) totalAmountIpr += (r.PpnAmount ?? 0);
                        //if (r.PphAmount > 0) totalAmount += r.PphAmount.Value;
                        totalAmountIpr += (r.PphAmount ?? 0);
                    }
                    else
                    {
                        totalAmountOpr += r.Amount.Value;
                        if ((r.PpnAmount ?? 0) > 0) totalAmountOpr += (r.PpnAmount ?? 0);
                        //if (r.PphAmount > 0) totalAmount += r.PphAmount.Value;
                        totalAmountOpr += (r.PphAmount ?? 0);
                    }
                }

                if (totalAmountOpr != 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(dAccountOpr, coaColl, string.Format("Guarantor {0}:{1}{2}", guarantor.GuarantorName, dMsg, IsSplitIprOpr ? " - OPR" : "")),
                        SubLedgerId = dSubledgerOpr,
                        Debit = totalAmountOpr >= 0 ? totalAmountOpr : 0,
                        Credit = totalAmountOpr < 0 ? (-1 * totalAmountOpr) : 0,
                        Description = string.Format("{0} #:{1}. GUARANTOR:{2}.", keterangan, iv.InvoiceNo, guarantor.GuarantorName),
                        DocumentNumber = iv.InvoiceNo
                    };
                    AddMoreInfo(d, string.Empty, guarantor.GuarantorID, string.Empty, string.Empty, iv.AgingDate,
                        string.Empty, string.Empty, string.Empty);
                    d.Save();
                    totalDebit = d.Debit.Value; totalCredit = d.Credit.Value;
                }
                if (totalAmountIpr != 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = ValidateCOA(dAccountIpr, coaColl, string.Format("Guarantor {0}:{1}{2}", guarantor.GuarantorName, dMsg, IsSplitIprOpr ? " - IPR" : "")),
                        SubLedgerId = dSubledgerIpr,
                        Debit = totalAmountIpr >= 0 ? totalAmountIpr : 0,
                        Credit = totalAmountIpr < 0 ? (-1 * totalAmountIpr) : 0,
                        Description = string.Format("{0} #:{1}. GUARANTOR:{2}.", keterangan, iv.InvoiceNo, guarantor.GuarantorName),
                        DocumentNumber = iv.InvoiceNo
                    };
                    AddMoreInfo(d, string.Empty, guarantor.GuarantorID, string.Empty, string.Empty, iv.AgingDate,
                        string.Empty, string.Empty, string.Empty);
                    d.Save();
                    totalDebit = d.Debit.Value; totalCredit = d.Credit.Value;
                }

                var PphColl = new AppStandardReferenceItemCollection();
                PphColl.Query.Where(PphColl.Query.StandardReferenceID == "Pph");
                PphColl.LoadAll();

                var tpiColl = new TransPaymentItemCollection();
                var tpi = new TransPaymentItemQuery("tpi");
                var tp = new TransPaymentQuery("tp");
                var ivi = new InvoicesItemQuery("ivi");
                tpi.InnerJoin(tp).On(tpi.PaymentNo == tp.PaymentNo && tpi.SRPaymentType.In("PaymentType-003", "PaymentType-004"))
                    .InnerJoin(ivi).On(tp.PaymentNo == ivi.PaymentNo)
                    .Where(ivi.InvoiceNo == iv.InvoiceNo);
                tpiColl.Load(tpi);

                var GuarDtColl = new GuarantorCollection();
                foreach (var r in detailInvColl)
                {
                    Guarantor GuarDT = null;
                    var pay = new TransPayment();
                    if (pay.LoadByPrimaryKey(r.PaymentNo))
                    {
                        var GrColl = GuarDtColl.Where(x => x.GuarantorID == pay.GuarantorID);
                        if (GrColl.Count() > 0)
                        {
                            GuarDT = GrColl.First();
                        }
                        else
                        {
                            // requery from db
                            GuarDT = new Guarantor();
                            if (GuarDT.LoadByPrimaryKey(pay.GuarantorID))
                            {
                                GuarDtColl.AttachEntity(GuarDT);
                            }
                            else
                            {
                                GuarDT = null; // something goes wrong
                                continue;
                            }
                        }

                        if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                        {
                            /* 
                             * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                             * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya
                             * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                             */
                            cAccountOpr = GuarDT.ChartOfAccountId ?? 0;
                            cSubledgerOpr = GuarDT.SubLedgerId ?? 0;
                            cAccountIpr = GuarDT.ChartOfAccountIdIPR ?? 0;
                            cSubledgerIpr = GuarDT.SubLedgerIdIPR ?? 0;
                        }
                        else
                        {
                            cAccountOpr = GuarDT.ChartOfAccountIdTemporary ?? 0;
                            cSubledgerOpr = GuarDT.SubledgerIdTemporary ?? 0;
                            cAccountIpr = GuarDT.ChartOfAccountIdTemporaryIPR ?? 0;
                            cSubledgerIpr = GuarDT.SubledgerIdTemporaryIPR ?? 0;

                            // alternatif lain bisa ambil dari jurnal ar uninvoice
                            // untuk mencegah kerusuhan jika settingan pengakuan ar di 
                            // master penjamin diganti
                            if (app.ParameterValue == "RSMM")
                            {
                                var jdq = new JournalTransactionDetailsQuery("jdq");
                                var jq = new JournalTransactionsQuery("jq");
                                jdq.InnerJoin(jq).On(jq.JournalId == jdq.JournalId &&
                                    jq.RefferenceNumber == r.PaymentNo &&
                                    jq.JournalType == "13" &&
                                    jdq.DocumentNumber == r.PaymentNo)
                                    .Where("<(jdq.Debit - jdq.Credit) = " + r.Amount + ">")
                                    .OrderBy(jdq.JournalId.Descending)
                                    .Select(jdq);
                                var jdqColl = new JournalTransactionDetailsCollection();
                                if (jdqColl.Load(jdq))
                                {
                                    // harusnya record pertama valid
                                    cAccountOpr = jdqColl.First().ChartOfAccountId.Value;
                                    cSubledgerOpr = jdqColl.First().SubLedgerId.Value;
                                    //cAccount = jdqColl.First().ChartOfAccountId.Value;
                                    //cSubledger = jdqColl.First().SubLedgerId.Value;

                                    // OPR atau IPR gak ada identifikasi di row berapa dari jurnal uninvoiced
                                }
                            }
                        }
                    }

                    var IsIpr = (r.RegistrationNo ?? "").ToUpper().Contains("REG/IP");
                    decimal cAmountOpr = (IsSplitIprOpr && IsIpr) ? 0 : (r.Amount ?? 0);
                    decimal cAmountIpr = (IsSplitIprOpr && IsIpr) ? (r.Amount ?? 0) : 0;
                    decimal diffAmount = 0;

                    var _tpi = tpiColl.Where(x => x.PaymentNo == r.PaymentNo).FirstOrDefault();
                    if (_tpi != null)
                    {
                        //if ((_tpi.Amount ?? 0) > 0)
                        //{
                        //    diffAmount = (_tpi.Amount ?? 0) - cAmount;
                        //}
                        diffAmount = (_tpi.Amount ?? 0) - (cAmountOpr + cAmountIpr);
                        cAmountOpr = (IsSplitIprOpr && IsIpr) ? 0 : (_tpi.Amount ?? 0);
                        cAmountIpr = (IsSplitIprOpr && IsIpr) ? (_tpi.Amount ?? 0) : 0;
                    }

                    if (cAmountOpr != 0)
                    {
                        var c = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = iv.IsAdditionalInvoice == true ? r.ChartOfAccountId ?? 0 : ValidateCOA(cAccountOpr, coaColl, string.Format("Guarantor {0}:{1}{2}", GuarDT.GuarantorName, cMsg, IsSplitIprOpr ? " - OPR" : "")),
                            SubLedgerId = iv.IsAdditionalInvoice == true ? r.SubLedgerId : cSubledgerOpr,
                            Debit = cAmountOpr >= 0 ? 0 : (cAmountOpr * -1),
                            Credit = cAmountOpr >= 0 ? cAmountOpr : 0,
                            Description = iv.IsAdditionalInvoice == true ? string.Format("{0} {1}", r.Notes, iv.InvoiceNotes).Trim() : string.Format("{0} #:{1}. GUARANTOR:{2}. PAYMENT:{3}. PATIENT:{4}", keterangan, iv.InvoiceNo, guarantor.GuarantorName, r.PaymentNo, r.PatientName),
                            DocumentNumber = r.PaymentNo //iv.InvoiceNo
                        };
                        AddMoreInfo(c, string.Empty, GuarDT == null ? string.Empty : GuarDT.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, r.RegistrationNo);
                        c.Save();
                        totalDebit += c.Debit.Value;
                        totalCredit += c.Credit.Value;
                    }
                    if (cAmountIpr != 0)
                    {
                        var c = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = iv.IsAdditionalInvoice == true ? r.ChartOfAccountId ?? 0 : ValidateCOA(cAccountIpr, coaColl, string.Format("Guarantor {0}:{1}{2}", GuarDT.GuarantorName, cMsg, IsSplitIprOpr ? " - IPR" : "")),
                            SubLedgerId = iv.IsAdditionalInvoice == true ? r.SubLedgerId : cSubledgerIpr,
                            Debit = cAmountIpr >= 0 ? 0 : (cAmountIpr * -1),
                            Credit = cAmountIpr >= 0 ? cAmountIpr : 0,
                            Description = iv.IsAdditionalInvoice == true ? string.Format("{0} {1}", r.Notes, iv.InvoiceNotes).Trim() : string.Format("{0} #:{1}. GUARANTOR:{2}. PAYMENT:{3}. PATIENT:{4}", keterangan, iv.InvoiceNo, guarantor.GuarantorName, r.PaymentNo, r.PatientName),
                            DocumentNumber = r.PaymentNo //iv.InvoiceNo
                        };
                        AddMoreInfo(c, string.Empty, GuarDT == null ? string.Empty : GuarDT.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, r.RegistrationNo);
                        c.Save();
                        totalDebit += c.Debit.Value;
                        totalCredit += c.Credit.Value;
                    }

                    if (diffAmount != 0)
                    {
                        if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsAccrualProrataRevenue))
                        {
                            // proporsi ke pendapatan
                            var tpiibgColl = new TransPaymentItemIntermBillGuarantorCollection();
                            tpiibgColl.Query.Where(tpiibgColl.Query.PaymentNo == r.PaymentNo);
                            if (tpiibgColl.LoadAll())
                            {
                                var jtdColl = GetNewIncomeAdjustProrataCashBased(header, r.PaymentNo, diffAmount, "Adjustment ", coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            }
                        }
                        else
                        {
                            if (diffAmount < 0)
                            {
                                var coaOverPayment = GuarDT.ChartOfAccountIdOverPayment ?? 0;
                                var cDiff = new JournalTransactionDetails
                                {
                                    JournalId = header.JournalId,
                                    ChartOfAccountId = ValidateCOA(coaOverPayment, coaColl, string.Format("Guarantor {0}:{1}", GuarDT.GuarantorName, "COA Exccess Payment / Discount (A/R)(+)")),
                                    SubLedgerId = iv.IsAdditionalInvoice == true ? r.SubLedgerId : cSubledgerOpr,
                                    Debit = diffAmount >= 0 ? diffAmount : 0,
                                    Credit = diffAmount >= 0 ? 0 : (diffAmount * -1),
                                    Description = string.Format("{0} #:{1}. GUARANTOR:{2}. PAYMENT:{3}. PATIENT:{4}", keterangan, iv.InvoiceNo, guarantor.GuarantorName, r.PaymentNo, r.PatientName),
                                    DocumentNumber = r.PaymentNo //iv.InvoiceNo
                                };
                                AddMoreInfo(cDiff, string.Empty, GuarDT == null ? string.Empty : GuarDT.GuarantorID, string.Empty, string.Empty, null,
                                string.Empty, string.Empty, r.RegistrationNo);
                                cDiff.Save();
                                totalDebit += cDiff.Debit.Value;
                                totalCredit += cDiff.Credit.Value;
                            }
                            if (diffAmount > 0)
                            {
                                var coaOverPaymentMin = GuarDT.ChartOfAccountIdOverPaymentMin ?? 0;
                                var cDiff = new JournalTransactionDetails
                                {
                                    JournalId = header.JournalId,
                                    ChartOfAccountId = ValidateCOA(coaOverPaymentMin, coaColl, string.Format("Guarantor {0}:{1}", GuarDT.GuarantorName, "COA Exccess Payment / Discount (A/R)(-)")),
                                    SubLedgerId = iv.IsAdditionalInvoice == true ? r.SubLedgerId : cSubledgerOpr,
                                    Debit = diffAmount >= 0 ? diffAmount : 0,
                                    Credit = diffAmount >= 0 ? 0 : (diffAmount * -1),
                                    Description = string.Format("{0} #:{1}. GUARANTOR:{2}. PAYMENT:{3}. PATIENT:{4}", keterangan, iv.InvoiceNo, guarantor.GuarantorName, r.PaymentNo, r.PatientName),
                                    DocumentNumber = r.PaymentNo //iv.InvoiceNo
                                };
                                AddMoreInfo(cDiff, string.Empty, GuarDT == null ? string.Empty : GuarDT.GuarantorID, string.Empty, string.Empty, null,
                                string.Empty, string.Empty, r.RegistrationNo);
                                cDiff.Save();
                                totalDebit += cDiff.Debit.Value;
                                totalCredit += cDiff.Credit.Value;
                            }
                        }
                    }

                    //--------------- Ppn additional invoice
                    if ((r.PpnAmount ?? 0) > 0)
                    {
                        //dVal += r.PpnAmount;
                        var dPpn = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(dVatInCoaId, coaColl, string.Format("AppParameter: coa_Ppn")),
                            SubLedgerId = r.SubLedgerId ?? 0,
                            Debit = (r.PpnAmount ?? 0) >= 0 ? 0 : ((r.PpnAmount ?? 0) * -1),
                            Credit = (r.PpnAmount ?? 0) >= 0 ? (r.PpnAmount ?? 0) : 0,
                            Description = string.Format("TAX (Ppn)#:{0}. Guarantor:{1}. INV:{2}, {3} ", iv.InvoiceNo, guarantor.GuarantorName, iv.InvoiceNo, r.Notes),
                            DocumentNumber = r.PaymentNo //iv.InvoiceNo
                        };
                        AddMoreInfo(dPpn, string.Empty, guarantor.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, r.RegistrationNo);
                        dPpn.Save();
                        totalDebit += dPpn.Debit.Value;
                        totalCredit += dPpn.Credit.Value;
                    }
                    //--------------- End Ppn

                    //--------------- Pph additional invoice
                    if ((r.PphAmount ?? 0) != 0)
                    {
                        var dVatPphInCoaIdRef = dVatPphInCoaId;
                        var pphErrMsg = string.Format("AppParameter: coa_Pph");
                        if (!string.IsNullOrEmpty(r.SRPph))
                        {
                            var pphRef = PphColl.Where(x => x.ItemID == r.SRPph);
                            if (pphRef.Any())
                            {
                                dVatPphInCoaIdRef = pphRef.First().coaID ?? 0;
                                pphErrMsg = string.Format("AppStandardReference: Pph");
                            }
                        }
                        var docNumber = string.Empty;
                        //dVal += r.PpnAmount;
                        var dPph = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(dVatPphInCoaIdRef, coaColl, pphErrMsg),
                            SubLedgerId = r.SubLedgerId ?? 0,
                            Debit = (r.PphAmount ?? 0) >= 0 ? 0 : ((r.PphAmount ?? 0) * -1),
                            Credit = (r.PphAmount ?? 0) >= 0 ? (r.PphAmount ?? 0) : 0,
                            Description = string.Format("TAX (Pph)#:{0}. Guarantor:{1}. INV:{2}, {3} ", iv.InvoiceNo, guarantor.GuarantorName, iv.InvoiceNo, r.Notes),
                            DocumentNumber = r.PaymentNo //iv.InvoiceNo
                        };
                        AddMoreInfo(dPph, string.Empty, guarantor.GuarantorID, string.Empty, string.Empty, null,
                            string.Empty, string.Empty, r.RegistrationNo);
                        dPph.Save();
                        totalDebit += dPph.Debit.Value;
                        totalCredit += dPph.Credit.Value;
                    }
                    //--------------- End Ppn
                }

                if (totalCredit > 0 && totalDebit > 0 && (totalDebit == totalCredit))
                {
                    header.BeginEdit();
                    header.IsPosted = true;
                    header.EndEdit();
                    header.Save();
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAPInvoicingJournal2Unapproval(InvoiceSupplier iv, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Invoice supplier
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == iv.InvoiceNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                return AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "IV", editedBy);
            }
        }

        public static int? AddNewAPInvoicingJournal2(InvoiceSupplier iv, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AP;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccountPayableCoaId = 0;
                int cAccountPayableSubLedgerId = 0;
                int dAccountPayableCoaId = 0;
                int dAccountPayableSubLedgerId = 0;

                int cAccountPayableCoaIdNM = 0;
                int cAccountPayableSubLedgerIdNM = 0;
                int dAccountPayableCoaIdNM = 0;
                int dAccountPayableSubLedgerIdNM = 0;



                int dVatInCoaId = GetCachedAccountFromParam("coa_PpnNonMedic"); // ppn additional diset ke non medis saja
                                                                                //int dVatPPh22CoaId = GetCachedAccountFromParam("coa_Pph22");
                                                                                //int dVatPPh23CoaId = GetCachedAccountFromParam("coa_Pph23");

                var supplierName = string.Empty;
                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(iv.SupplierID))
                    return 0;
                supplierName = sup.SupplierName;

                var appprmdate = new AppParameter();
                DateTime jDate = (new DateTime()).NowAtSqlServer();
                if (appprmdate.LoadByPrimaryKey("acc_JournalAPInvoicingDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        iv.InvoiceDate.Value.Date : iv.ApprovedDate.Value.Date;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("IV", jDate);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //header.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = jDate;
                    header.Description = string.Format("RECEIVING INVOICE #:{0}. SUP:{1}.", iv.InvoiceNo, supplierName);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = iv.InvoiceNo;

                    header.Save();
                    ValidateClosingPeriode(header);
                }
                journalId = header.JournalId.Value;

                supplierName = sup.SupplierName;
                if (sup.ChartOfAccountIdAP.HasValue)
                {
                    cAccountPayableCoaId = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                    cAccountPayableSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;
                    dAccountPayableCoaId = sup.ChartOfAccountIdAPTemporary.HasValue ? sup.ChartOfAccountIdAPTemporary.Value : 0;
                    dAccountPayableSubLedgerId = sup.SubledgerIdAPTemporary.HasValue ? sup.SubledgerIdAPTemporary.Value : 0;

                    cAccountPayableCoaIdNM = sup.ChartOfAccountIdAPNonMedic.HasValue ? sup.ChartOfAccountIdAPNonMedic.Value : 0;
                    cAccountPayableSubLedgerIdNM = sup.SubledgerIdAPNonMedic.HasValue ? sup.SubledgerIdAPNonMedic.Value : 0;
                    dAccountPayableCoaIdNM = sup.ChartOfAccountIdAPTemporaryNonMedic.HasValue ? sup.ChartOfAccountIdAPTemporaryNonMedic.Value : 0;
                    dAccountPayableSubLedgerIdNM = sup.SubledgerIdAPTemporaryNonMedic.HasValue ? sup.SubledgerIdAPTemporaryNonMedic.Value : 0;
                }

                var coaColl = new ChartOfAccountsCollection();

                var eSup = new InvoiceSupplierItemCollection();
                eSup.Query.Where(eSup.Query.InvoiceNo == iv.InvoiceNo);
                if (!eSup.Query.Load())
                    return 0;

                var IsApNMSeparated = false;
                var PrmApNMSeparated = new AppParameter();
                if (PrmApNMSeparated.LoadByPrimaryKey("IsCoaAPNonMedicSeparated"))
                {
                    IsApNMSeparated = (PrmApNMSeparated.ParameterValue == "Yes");
                }

                var coaMaterai = GetCachedAccountFromParam("coa_StampAmountPOR");

                var IsDpOnReceivingInv = AppParameter.IsYes(AppParameter.ParameterItem.IsAccWriteDownPaymentOnReceivingInvoice);

                //var IsPpnExcluded = !AppParameter.IsYes(AppParameter.ParameterItem.IsApInvoiceIncPPN);

                foreach (var s in eSup)
                {
                    var isMedic = false;
                    var docNumber = "-";
                    var invSuppNo = "";
                    decimal? dVal = 0, umVal = 0;

                    decimal ppnAmountMedic = 0, ppnAmountNonMedic = 0;

                    var IsPpnExcluded = s.IsPpnExcluded ?? false;

                    if ((s.IsAdditionalInvoice ?? false) == false)
                    {
                        var e = new ItemTransaction();
                        e.LoadByPrimaryKey(s.TransactionNo);
                        docNumber = e.TransactionNo;
                        invSuppNo = e.InvoiceNo;
                        isMedic = e.SRItemType == "11";

                        // kurangin hutang dalam proses
                        dVal = s.Amount + s.PPnAmount - s.PPh22Amount - s.PPh23Amount + s.StampAmount;// +s.DownPaymentAmount/*- s.OtherDeduction*/ ;
                                                                                                      // stamp amount harus cek selisih por dengan tukar faktur, siapa tau diedit nilainya
                        if (IsPpnExcluded)
                        {
                            ppnAmountMedic = isMedic ? (s.PPnAmount ?? 0) : 0;
                            ppnAmountNonMedic = isMedic ? 0 : (s.PPnAmount ?? 0);
                            //dVal += s.PPnAmount ?? 0;
                        }

                        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsPphUsesAfixedValue) == "Yes")
                        {
                            dVal -= s.PphAmount;
                        }

                        umVal = IsDpOnReceivingInv ? s.DownPaymentAmount : 0;
                        if (dVal < 0)
                        {
                            // po return
                            var d = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                                    ValidateCOA(sup.ChartOfAccountIdPOReturnNonMedic, coaColl, string.Format("Supplier {0}: Chart Of Account PO Return Non Medical", sup.SupplierName)) :
                                    ValidateCOA(sup.ChartOfAccountIdPOReturn, coaColl, string.Format("Supplier {0}: Chart Of Account PO Return", sup.SupplierName)),
                                SubLedgerId = (IsApNMSeparated && !isMedic) ? dAccountPayableSubLedgerIdNM : dAccountPayableSubLedgerId,
                                Debit = ((dVal >= 0) ? dVal : 0),
                                Credit = ((dVal < 0) ? (dVal * -1) : 0),
                                Description = string.Format("RETUR #:{0}. SUP:{1}. INV:{2} ", docNumber, supplierName, iv.InvoiceNo),
                                DocumentNumber = docNumber
                            };
                            AddMoreInfo(d, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            d.Save();
                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else
                        {
                            // cari POR-nya
                            decimal StampDiff = (s.StampAmount ?? 0) - (e.StampAmount ?? 0) - (e.DownPaymentAmount ?? 0);

                            // POR
                            var d = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                                    ValidateCOA(dAccountPayableCoaIdNM, coaColl, string.Format("Supplier {0}: Chart Of Account AP Non Medical", sup.SupplierName)) :
                                    ValidateCOA(dAccountPayableCoaId, coaColl, string.Format("Supplier {0}: Chart Of Account AP", sup.SupplierName)),
                                SubLedgerId = (IsApNMSeparated && !isMedic) ? dAccountPayableSubLedgerIdNM : dAccountPayableSubLedgerId,
                                // perlu dibuat pph22prior dan pph23prior di tabel itemtransaction !
                                //Debit = totalAmount + (e.PriorTaxAmount ?? 0) + e.StampAmount - e.Pph22 - e.Pph23 - e.DiscountAmount,
                                Debit = (((dVal - StampDiff) >= 0) ? (dVal - StampDiff) : 0),
                                Credit = (((dVal - StampDiff) < 0) ? ((dVal - StampDiff) * -1) : 0),
                                Description = string.Format("RECEIVE #:{0}. SUP:{1}. INV:{2}. Inv:{3}", docNumber, supplierName, iv.InvoiceNo, e.InvoiceNo),
                                DocumentNumber = docNumber
                            };
                            AddMoreInfo(d, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            d.Save();
                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;


                            //Biaya Materai
                            if (StampDiff != 0)
                            {
                                var materai = new JournalTransactionDetails
                                {
                                    JournalId = header.JournalId,
                                    ChartOfAccountId = ValidateCOA(coaMaterai, coaColl, "App Parameter: coa_StampAmountPOR"),
                                    SubLedgerId = 0,
                                    Debit = StampDiff >= 0 ? StampDiff : 0,
                                    Credit = StampDiff < 0 ? -StampDiff : 0,
                                    Description =
                                        string.Format("STAMP AMOUNT #:{0}. SUP:{1}. INV:{2}. Inv:{3}", s.TransactionNo, supplierName, iv.InvoiceNo, e.InvoiceNo),
                                    DocumentNumber = e.TransactionNo
                                };
                                AddMoreInfo(materai, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                                    string.Empty, string.Empty, string.Empty);
                                materai.AddNew();
                                materai.Save();
                                totalDebit += materai.Debit.Value;
                                totalCredit += materai.Credit.Value;
                            }
                        }
                    }
                    else
                    {
                        // kurangin hutang dalam proses
                        isMedic = s.SRItemType == "11";
                        dVal = s.Amount - s.PPh22Amount - s.PPh23Amount + s.StampAmount /*- s.DownPaymentAmount - s.OtherDeduction*/;
                        umVal = IsDpOnReceivingInv ? s.DownPaymentAmount : 0;
                        var d = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(s.ChartOfAccountId ?? 0, coaColl, string.Format("Supplier {0}: Chart Of Account Id AP", sup.SupplierName)),
                            SubLedgerId = s.SubLedgerId ?? 0,
                            // perlu dibuat pph22prior dan pph23prior di tabel itemtransaction !
                            //Debit = totalAmount + (e.PriorTaxAmount ?? 0) + e.StampAmount - e.Pph22 - e.Pph23 - e.DiscountAmount,
                            Debit = ((dVal >= 0) ? dVal : 0),
                            Credit = ((dVal < 0) ? Abs(dVal) : 0),
                            Description = string.Format(((dVal >= 0) ? "ADDITIONAL" : "DEDUCTION") + " #:{0}. SUP:{1}. INV:{2}, {3} ", docNumber, supplierName, iv.InvoiceNo, s.Notes),
                            DocumentNumber = docNumber
                        };
                        AddMoreInfo(d, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        d.Save();
                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;

                        // ppn additional invoice
                        if ((s.PPnAmount ?? 0) != 0)
                        {
                            dVal += s.PPnAmount;
                            var dPpn = new JournalTransactionDetails
                            {
                                JournalId = header.JournalId,
                                ChartOfAccountId = ValidateCOA(dVatInCoaId, coaColl, string.Format("AppParameter: coa_PpnNonMedic")),
                                SubLedgerId = s.SubLedgerId ?? 0,
                                // perlu dibuat pph22prior dan pph23prior di tabel itemtransaction !
                                //Debit = totalAmount + (e.PriorTaxAmount ?? 0) + e.StampAmount - e.Pph22 - e.Pph23 - e.DiscountAmount,
                                Debit = ((s.PPnAmount >= 0) ? s.PPnAmount : 0),
                                Credit = ((s.PPnAmount < 0) ? Abs(s.PPnAmount) : 0),
                                Description = string.Format("TAX (Ppn)#:{0}. SUP:{1}. INV:{2}, {3} ", docNumber, supplierName, iv.InvoiceNo, s.Notes),
                                DocumentNumber = docNumber
                            };
                            AddMoreInfo(dPpn, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                                string.Empty, string.Empty, string.Empty);
                            dPpn.Save();
                            totalDebit += dPpn.Debit.Value;
                            totalCredit += dPpn.Credit.Value;
                        }
                    }

                    var ddVal = s.OtherDeduction.Value;

                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsPphUsesAfixedValue) == "No")
                    {
                        // PPH 
                        if ((s.PphAmount ?? 0) > 0 && s.SRPph != string.Empty)
                        {
                            var stdRef = new AppStandardReferenceItemCollection();
                            if (stdRef.LoadByStandardReferenceID("Pph", 0))
                            {
                                var pphtypes = stdRef.Where(x => x.ItemID == s.SRPph);
                                if (pphtypes.Any())
                                {
                                    var pphtype = pphtypes.First();
                                    var dPph = new JournalTransactionDetails
                                    {
                                        JournalId = header.JournalId,
                                        ChartOfAccountId = ValidateCOA(pphtype.coaID, coaColl, string.Format("App Standard Reference: Pph: {0}", pphtype.ItemName)),
                                        SubLedgerId = 0,
                                        Debit = ((s.PphAmount < 0) ? Abs(s.PphAmount) : 0),
                                        Credit = ((s.PphAmount >= 0) ? s.PphAmount : 0),
                                        Description = string.Format("TAX ({4})#:{0}. SUP:{1}. INV:{2}, {3} ", docNumber, supplierName, iv.InvoiceNo, s.Notes, pphtype.ItemName),
                                        DocumentNumber = docNumber
                                    };
                                    AddMoreInfo(dPph, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                                        string.Empty, string.Empty, string.Empty);
                                    dPph.Save();
                                    totalDebit += dPph.Debit.Value;
                                    totalCredit += dPph.Credit.Value;
                                }
                            }
                        }
                    }

                    //masukkan hutang terbaru
                    var cVal = dVal - ddVal - umVal - ppnAmountMedic - ppnAmountNonMedic;
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsPphUsesAfixedValue) != "Yes")
                    {
                        cVal -= (s.PphAmount ?? 0);
                    }

                    var f = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = (IsApNMSeparated && !isMedic) ?
                                    ValidateCOA(cAccountPayableCoaIdNM, coaColl, string.Format("Supplier {0}: Chart Of Account AP Uninvoice Non Medical", sup.SupplierName)) :
                                    ValidateCOA(cAccountPayableCoaId, coaColl, string.Format("Supplier {0}: Chart Of Account AP Uninvoice", sup.SupplierName)),
                        SubLedgerId = (IsApNMSeparated && !isMedic) ? cAccountPayableSubLedgerIdNM : cAccountPayableSubLedgerId,
                        Debit = ((cVal < 0) ? Abs(cVal) : 0),
                        //Credit = totalAmount + e.StampAmount + e.TaxAmount - e.Pph22 - e.Pph23 - e.DiscountAmount,
                        Credit = ((cVal >= 0) ? cVal : 0),
                        Description = string.Format("RECEIVE #:{0}. SUP:{1}. INV:{2}. Inv:{3}", docNumber, supplierName, iv.InvoiceNo, invSuppNo),
                        DocumentNumber = iv.InvoiceNo
                    };
                    AddMoreInfo(f, string.Empty, string.Empty, iv.SupplierID, string.Empty, iv.InvoiceDueDate,
                        string.Empty, string.Empty, string.Empty);
                    f.Save();
                    totalDebit += f.Debit.Value;
                    totalCredit += f.Credit.Value;

                    //uang muka dari cash entry, gimana cara ambil akunnya?
                    if (umVal > 0)
                    {
                        // cari nomor PO
                        var porTrans = new ItemTransaction();
                        if (porTrans.LoadByPrimaryKey(docNumber))
                        {
                            var poTrans = new ItemTransaction();
                            if (poTrans.LoadByPrimaryKey(porTrans.ReferenceNo))
                            {
                                if (!string.IsNullOrEmpty(poTrans.CashTransactionReconcileId))
                                {
                                    var cids = poTrans.CashTransactionReconcileId.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                                    //decimal sumUM = 0;
                                    if (cids.Length > 0)
                                    {
                                        var ctiQuery = new CashTransactionDetailQuery("cti");
                                        var ctQuery = new CashTransactionQuery("ct");
                                        ctiQuery.InnerJoin(ctQuery).On(ctQuery.TransactionId == ctiQuery.TransactionId);
                                        ctiQuery.Where(ctiQuery.TransactionId.In(cids), ctQuery.IsVoid == false);

                                        var ctiColl = new CashTransactionDetailCollection();
                                        ctiColl.Load(ctiQuery);
                                        //ctiColl.Query.Where(ctiColl.Query.TransactionId.In(cids));
                                        if (ctiColl.LoadAll())
                                        {
                                            foreach (var cid in cids)
                                            {
                                                foreach (var cti in ctiColl.Where(x => (x.TransactionId ?? 0) == Convert.ToInt32(cid)))
                                                {
                                                    var um = new JournalTransactionDetails
                                                    {
                                                        JournalId = header.JournalId,
                                                        ChartOfAccountId = cti.ChartOfAccountId,
                                                        SubLedgerId = cti.SubLedgerId,
                                                        Debit = cti.Credit.Value,
                                                        Credit = cti.Debit.Value,
                                                        Description = string.Format("{3}. #:{0}. SUP:{1}. INV:{2}", docNumber, supplierName, iv.InvoiceNo, string.Format("{1}, PO:{0}", poTrans.TransactionNo, cti.Description)),
                                                        DocumentNumber = docNumber
                                                    };
                                                    AddMoreInfo(um, string.Empty, string.Empty, iv.SupplierID, string.Empty, iv.InvoiceDueDate,
                                                        string.Empty, string.Empty, string.Empty);
                                                    um.Save();
                                                    totalDebit += um.Debit.Value;
                                                    totalCredit += um.Credit.Value;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }


                        //var dcList = new dcList();

                        //// cari nomor PO
                        //var porTrans = new ItemTransaction();
                        //if (porTrans.LoadByPrimaryKey(docNumber))
                        //{
                        //    var poTrans = new ItemTransaction();
                        //    if (poTrans.LoadByPrimaryKey(porTrans.ReferenceNo))
                        //    {
                        //        if (!string.IsNullOrEmpty(poTrans.CashTransactionReconcileId))
                        //        {
                        //            var cids = poTrans.CashTransactionReconcileId.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                        //            //decimal sumUM = 0;
                        //            if (cids.Length > 0)
                        //            {
                        //                var ctiColl = new CashTransactionDetailCollection();
                        //                ctiColl.Query.Where(ctiColl.Query.TransactionId.In(cids));
                        //                if (ctiColl.LoadAll())
                        //                {
                        //                    foreach (var cid in cids)
                        //                    {
                        //                        var cti = ctiColl.Where(x => (x.TransactionId ?? 0) == Convert.ToInt32(cid)).FirstOrDefault();
                        //                        if (cti != null)
                        //                        {
                        //                            var dc = new dc();
                        //                            dc.id = poTrans.TransactionNo + cti.ChartOfAccountId.ToString(); // unik id pake po + coa
                        //                            dc.name = string.Format("{1}, PO:{0}", poTrans.TransactionNo, cti.Description);
                        //                            dc.COAID = cti.ChartOfAccountId;
                        //                            dc.SLID = cti.SubLedgerId;
                        //                            dc.credit = cti.Debit.Value;
                        //                            dc.debit = cti.Credit.Value;
                        //                            dcList.Add(dc);
                        //                        }
                        //                    }
                        //                }
                        //            }
                        //        }
                        //    }
                        //}

                        //foreach (var dc in dcList.GetList)
                        //{
                        //    var um = new JournalTransactionDetails
                        //    {
                        //        JournalId = header.JournalId,
                        //        ChartOfAccountId = ValidateCOA(dc.COAID, coaColl, "(COA Uang Muka)"),
                        //        SubLedgerId = dc.SLID,
                        //        Debit = dc.debit,
                        //        Credit = dc.credit,
                        //        Description = string.Format("{3}. #:{0}. SUP:{1}. INV:{2}", docNumber, supplierName, iv.InvoiceNo, dc.name),
                        //        DocumentNumber = docNumber
                        //    };
                        //    AddMoreInfo(um, string.Empty, string.Empty, iv.SupplierID, string.Empty, iv.InvoiceDueDate,
                        //        string.Empty, string.Empty, string.Empty);
                        //    um.Save();
                        //    totalDebit += um.Debit.Value;
                        //    totalCredit += um.Credit.Value;
                        //}
                    }

                    //deduction
                    if (ddVal != 0)
                    {
                        var dd = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(sup.ChartOfAccountIdAPCost ?? 0, coaColl, string.Format("Supplier {0}: Chart Of Account Id Cost", sup.SupplierName)),
                            SubLedgerId = sup.SubledgerIdAPCost ?? 0,
                            Debit = ((ddVal < 0) ? Abs(ddVal) : 0),
                            Credit = ((ddVal >= 0) ? ddVal : 0),
                            Description = string.Format("Other Deduction For " + ((ddVal >= 0) ? "RECEIVE" : "RETUR") + " #:{0}. SUP:{1}. INV:{2} ", docNumber, supplierName, iv.InvoiceNo),
                            DocumentNumber = docNumber
                        };
                        AddMoreInfo(dd, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        dd.Save();
                        totalDebit += dd.Debit.Value;
                        totalCredit += dd.Credit.Value;
                    }

                    if (ppnAmountMedic != 0)
                    {
                        var coaPpnMedic = GetCachedAccountFromParam("coa_Ppn");
                        var jPpn = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(coaPpnMedic, coaColl, "AppParameter: coa_Ppn"),
                            SubLedgerId = sup.SubledgerIdAP ?? 0,
                            Debit = ((ppnAmountMedic < 0) ? Abs(ppnAmountMedic) : 0),
                            Credit = ((ppnAmountMedic >= 0) ? ppnAmountMedic : 0),
                            Description = string.Format("TAX (Ppn) #:{0}. SUP:{1}. INV:{2} ", docNumber, supplierName, iv.InvoiceNo),
                            DocumentNumber = docNumber
                        };
                        AddMoreInfo(jPpn, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        jPpn.Save();
                        totalDebit += jPpn.Debit.Value;
                        totalCredit += jPpn.Credit.Value;
                    }
                    if (ppnAmountNonMedic != 0)
                    {
                        var coaPpnNonMedic = GetCachedAccountFromParam("coa_PpnNonMedic");
                        var jPpn = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = ValidateCOA(coaPpnNonMedic, coaColl, "AppParameter: coa_PpnNonMedic"),
                            SubLedgerId = sup.SubledgerIdAP ?? 0,
                            Debit = ((ppnAmountNonMedic < 0) ? Abs(ppnAmountNonMedic) : 0),
                            Credit = ((ppnAmountNonMedic >= 0) ? ppnAmountNonMedic : 0),
                            Description = string.Format("TAX (Ppn) #:{0}. SUP:{1}. INV:{2} ", docNumber, supplierName, iv.InvoiceNo),
                            DocumentNumber = docNumber
                        };
                        AddMoreInfo(jPpn, string.Empty, string.Empty, iv.SupplierID, string.Empty, null,
                            string.Empty, string.Empty, string.Empty);
                        jPpn.Save();
                        totalDebit += jPpn.Debit.Value;
                        totalCredit += jPpn.Credit.Value;
                    }
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPOReceived) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAPInvoicingJournal(InvoiceSupplier iv, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AP;

            try
            {
                //
                // Requirement:
                //
                // INVENTORY (D)
                // VAT IN (D)
                // PURCHASE DISCOUNT (C)
                // ACCOUNT PAYABLE (C)
                // VAT PPH 22/23 (C)

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int dInventoryCoaId = 0;
                int dInventorySubLedgerId = 0;
                int dVatInCoaId = GetCachedAccountFromParam("coa_Ppn");
                int dVatPPh22CoaId = GetCachedAccountFromParam("coa_Pph22");
                int dVatPPh23CoaId = GetCachedAccountFromParam("coa_Pph23");
                int cAccountPayableCoaId = 0; //GetCachedAccountFromParam("coa_ApInProcess"); 
                int cAccountPayableSubLedgerId = 0;
                int cAccountCash = GetCachedAccountFromParam("coa_PurchaseCash");

                //Discount mengurangi persediaan sesuai product account-nya, jd ambil COA dr persediaan saja, kalo pakai appparameter jd hanya bisa utk 1 product account saja
                int cDiscountCoaId = GetCachedAccountFromParam("coa_PurchaseDiscount");

                var eSup = new InvoiceSupplierItemCollection();
                eSup.Query.Where(eSup.Query.InvoiceNo == iv.InvoiceNo);
                if (!eSup.Query.Load())
                    return 0;

                var idx = 0; // counter untuk validasi header jurnal tercreate atau tidak
                var header = new JournalTransactions();

                var stdGG = new AppStandardReferenceItemCollection();
                stdGG.Query.Where(stdGG.Query.StandardReferenceID == "GuarantorIncomeGroup")
                    .OrderBy(stdGG.Query.ItemID.Ascending);
                stdGG.Query.es.Top = 1;
                stdGG.LoadAll();

                foreach (var s in eSup)
                {
                    var e = new ItemTransaction();
                    e.LoadByPrimaryKey(s.TransactionNo);

                    var eItems = new ItemTransactionItemCollection();
                    var eItemQuery = new ItemTransactionItemQuery("e");
                    var itemQuery = new ItemQuery("i");

                    eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                    eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                    eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                    if (!eItems.Load(eItemQuery))
                        return 0;

                    var supplierName = string.Empty;
                    var sup = new Supplier();
                    if (!sup.LoadByPrimaryKey(iv.SupplierID))
                        return 0;

                    supplierName = sup.SupplierName;
                    if (sup.ChartOfAccountIdAP.HasValue)
                    {
                        cAccountPayableCoaId = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                        cAccountPayableSubLedgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;
                    }

                    if (cAccountPayableCoaId == 0)
                        return 0;

                    //Journal Header
                    var journalCode = JournalCodes.GetOrCreateAutoJournalCode("IV", e.TransactionDate.Value);
                    var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);
                    var invNo = e.InvoiceNo ?? "-";

                    decimal payableAmount = 0;
                    //decimal discountAmount = 0;
                    decimal discTotal = 0;

                    if (e.IsNonMasterOrder == true)
                    {
                        var proacc = new ProductAccountGuarantorGroup();
                        proacc.Query.Where(proacc.Query.ProductAccountID == e.ProductAccountID,
                            proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                        if (proacc.Load(proacc.Query))
                        {
                            //ProductAccount proacc = new ProductAccount();
                            //if (proacc.LoadByPrimaryKey(e.ProductAccountID))
                            //{
                            dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                            dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                        }
                    }

                    var toServiceUnit = new ServiceUnit();
                    toServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID);

                    //-------------------------------------------------------------------------------
                    // INVENTORY (D)
                    //-------------------------------------------------------------------------------
                    foreach (var p in eItems)
                    {
                        // khusus RSSA inventory yang diterima langsung dikurang dengan diskonnya (diskon detail ga dijurnal lagi) biar bisa dibuat jurnal selisihnya pas tukar faktur,
                        // kalo dipisah susah bikin jurnal selisih untuk diskonnya.
                        var amount = (p.Quantity.Value * p.PriceInCurrency.Value);
                        var discountAmount = (decimal)(p.DiscountInCurrency.Value * p.Quantity.Value);

                        var prioramount = (p.Quantity.Value * p.PriorPriceInCurrency.Value);
                        var priordiscountAmount = (decimal)(p.PriorDiscountInCurrency.Value * p.Quantity.Value);

                        AppParameter app2 = new AppParameter();
                        app2.LoadByPrimaryKey("HealthcareInitialAppsVersion");

                        if (p.PriceInCurrency != p.PriorPriceInCurrency)
                        {
                            idx++;
                            //header ditaruh di sini pakai counter idx karena baru create header kalau ada transaksi yang harganya berubah saja
                            if (idx == 1)
                            {
                                header = new JournalTransactions
                                {
                                    JournalType = journalType,
                                    JournalCode = journalCode,
                                    TransactionNumber = journalNumber,
                                    TransactionDate = e.TransactionDate,
                                    Description = string.Format("INVOICING #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                                    IsPosted = false,
                                    DateCreated = DateTime.Now,
                                    LastUpdateDateTime = DateTime.Now,
                                    CreatedBy = editedBy,
                                    LastUpdateByUserID = editedBy,
                                    RefferenceNumber = e.TransactionNo
                                };
                                header.Save();
                            }

                            //var dAmt = (p.Quantity.Value * p.PriceInCurrency.Value) + (e.TaxPercentage.Value / 100 * (p.Quantity.Value * p.PriceInCurrency.Value));


                            if (app2.ParameterValue == "RSSA")
                            {
                                amount = amount - discountAmount;
                                prioramount = prioramount - priordiscountAmount;
                                amount = amount - prioramount;
                            }

                            if (!e.IsNonMasterOrder ?? false)
                            {
                                var itemId = p.ItemID;
                                var itemInv = new Item();
                                itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                                if (itemInv.Query.Load())
                                {
                                    var proacc = new ProductAccountGuarantorGroup();
                                    proacc.Query.Where(proacc.Query.ProductAccountID == itemInv.ProductAccountID,
                                        proacc.Query.SRGuarantorIncomeGroup == stdGG.First().ItemID);
                                    if (proacc.Load(proacc.Query))
                                    {
                                        //var proacc = new ProductAccount();
                                        //if (proacc.LoadByPrimaryKey(itemInv.ProductAccountID))
                                        //{
                                        //TODO: Find COA purchase discount from Product Account
                                        dInventoryCoaId = proacc.ChartOfAccountIdInventory.HasValue ? proacc.ChartOfAccountIdInventory.Value : 0;
                                        dInventorySubLedgerId = proacc.SubledgerIdInventory.HasValue ? proacc.SubledgerIdInventory.Value : 0;
                                    }
                                }


                                //jurnal ini dijalankan jika inventory dilihat ingin dicatat per lokasi
                                AppParameter app = new AppParameter();
                                app.LoadByPrimaryKey("acc_IsUnitBasedProductAccount");
                                if (app.ParameterValue == "Yes")
                                {
                                    //Matrix COA Unit 
                                    ServiceUnitProductAccountMapping supam = new ServiceUnitProductAccountMapping();
                                    supam.Query.Where(supam.Query.LocationId == e.ToLocationID, supam.Query.ServiceUnitId == e.ToServiceUnitID, supam.Query.ProductAccountId == p.ProductAccountId, supam.Query.SRRegistrationType == (toServiceUnit.SRRegistrationType == string.Empty ? "OPR" : toServiceUnit.SRRegistrationType));
                                    if (supam.Query.Load())
                                    {
                                        dInventoryCoaId = supam.ChartOfAccountIdInventory.HasValue ? supam.ChartOfAccountIdInventory.Value : 0;
                                        dInventorySubLedgerId = supam.SubledgerIdInventory.HasValue ? supam.SubledgerIdInventory.Value : 0;

                                    }
                                }
                            }
                        }


                        if (dInventoryCoaId == 0)
                            return 0;


                        var d = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = dInventoryCoaId,
                            SubLedgerId = dInventorySubLedgerId,
                            //kalau harga baru lebih besar berarti nambah inventory, kalo lebih kecil ngurangin inventory
                            Debit = ((p.PriceInCurrency < p.PriorPriceInCurrency) ? decimal.Round((decimal)(Abs(amount)), 2) : 0),
                            Credit = ((p.PriceInCurrency < p.PriorPriceInCurrency) ? 0 : decimal.Round((decimal)(Abs(amount)), 2)),
                            Description = string.Format("RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                            DocumentNumber = e.TransactionNo
                        };
                        d.Save();

                        payableAmount += amount;
                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;

                        //-------------------------------------------------------------------------------
                        // PURCHASE DISCOUNT (C)
                        //-------------------------------------------------------------------------------
                        //decimal discountAmount = decimal.Round((decimal)(p.Discount1Percentage.HasValue ? (p.PriceInCurrency.Value * p.Quantity * (p.Discount1Percentage / 100)) : 0), 2);
                        //discountAmount += decimal.Round((decimal)(p.Discount2Percentage.HasValue ? (((p.PriceInCurrency.Value * p.Quantity) - discountAmount) * (p.Discount2Percentage / 100)) : 0), 2);


                        //if (app2.ParameterValue != "RSSA")
                        //{
                        //    if (discountAmount > 0)
                        //    {
                        //        var discount = new JournalTransactionDetails
                        //        {
                        //            JournalId = header.JournalId,
                        //            ChartOfAccountId = dInventoryCoaId,
                        //            SubLedgerId = 0,
                        //            Debit = 0,
                        //            Credit = decimal.Round(discountAmount, 2),
                        //            Description = string.Format("DISC. RECEIVE #:{0}. SUP:{1}. ITEM#:{2}.", e.TransactionNo, supplierName, p.ItemName),
                        //            DocumentNumber = e.TransactionNo
                        //        };

                        //        discount.AddNew();
                        //        discount.Save();
                        //        totalCredit += discount.Credit.Value;

                        //        discTotal += discountAmount;
                        //    }
                        //}


                    }

                    //-------------------------------------------------------------------------------
                    // VAT IN (D)
                    //-------------------------------------------------------------------------------
                    var taxAmount = decimal.Round((decimal)e.TaxAmount.Value, 2) - decimal.Round((decimal)e.PriorTaxAmount.Value, 2);

                    if (taxAmount > 0 && idx > 0)
                    {
                        var tax = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = dVatInCoaId,
                            SubLedgerId = 0,
                            Debit = ((e.TaxAmount.Value < e.PriorTaxAmount.Value) ? Abs(taxAmount) : 0),
                            Credit = ((e.TaxAmount.Value < e.PriorTaxAmount.Value) ? 0 : Abs(taxAmount)),
                            Description = string.Format("RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                            DocumentNumber = e.TransactionNo
                        };
                        tax.AddNew();
                        tax.Save();
                        totalDebit += tax.Debit.Value;
                        totalCredit += tax.Credit.Value;
                    }

                    var discGolobal = decimal.Round((decimal)e.DiscountAmount.Value, 2);

                    //if (discGolobal > 0 && idx > 0)
                    //{
                    //    var glob = new JournalTransactionDetails
                    //    {
                    //        JournalId = header.JournalId,
                    //        ChartOfAccountId = cDiscountCoaId,
                    //        SubLedgerId = 0,
                    //        Debit = 0,
                    //        Credit = decimal.Round((decimal)discGolobal, 2),
                    //        Description = string.Format("DISC. GLOBAL RECEIVE #:{0}. SUP:{1}.", e.TransactionNo, supplierName),
                    //        DocumentNumber = e.TransactionNo
                    //    };

                    //    glob.AddNew();
                    //    glob.Save();
                    //    totalCredit += glob.Credit.Value;
                    //}

                    ////-------------------------------------------------------------------------------
                    //// VAT PPh article 22/23
                    ////-------------------------------------------------------------------------------
                    //var pph22Amt = e.Pph22.HasValue ? e.Pph22.Value * e.CurrencyRate.Value : 0;
                    //if (pph22Amt > 0 && idx > 0)
                    //{
                    //    var vatPPh22 = new JournalTransactionDetails
                    //    {
                    //        JournalId = header.JournalId,
                    //        ChartOfAccountId = dVatPPh22CoaId,
                    //        SubLedgerId = 0,
                    //        Debit = 0,
                    //        Credit = decimal.Round((decimal)pph22Amt, 2),
                    //        Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT PPh22 ", e.TransactionNo, supplierName),
                    //        DocumentNumber = e.TransactionNo
                    //    };

                    //    vatPPh22.AddNew();
                    //    vatPPh22.Save();
                    //    totalCredit += vatPPh22.Credit.Value;
                    //}

                    //var pph23Amt = e.Pph23.HasValue ? e.Pph23.Value * e.CurrencyRate.Value : 0;
                    //if (pph23Amt > 0 && idx > 0)
                    //{
                    //    var vatPPh23 = new JournalTransactionDetails
                    //    {
                    //        JournalId = header.JournalId,
                    //        ChartOfAccountId = dVatPPh23CoaId,
                    //        SubLedgerId = 0,
                    //        Debit = 0,
                    //        Credit = decimal.Round((decimal)pph23Amt),
                    //        Description = string.Format("RECEIVE #:{0}. SUP:{1}. VAT PPh23", e.TransactionNo, supplierName),
                    //        DocumentNumber = e.TransactionNo
                    //    };

                    //    vatPPh23.AddNew();
                    //    vatPPh23.Save();
                    //    totalCredit += vatPPh23.Credit.Value;
                    //}

                    //-------------------------------------------------------------------------------
                    // ACCOUNT PAYABLE (C)
                    //-------------------------------------------------------------------------------
                    //var netPayableAmount = (payableAmount + taxAmount) - (discTotal + pph22Amt + pph23Amt + discGolobal);
                    var netPayableAmount = (e.ChargesAmount + e.TaxAmount) - (e.PriorChargesAmount + e.PriorTaxAmount);
                    //untuk tipe PO Credit
                    if (e.SRPurchaseOrderType == "CR" && idx > 0)
                    {

                        var payable = new JournalTransactionDetails
                        {
                            JournalId = header.JournalId,
                            ChartOfAccountId = cAccountPayableCoaId,
                            SubLedgerId = cAccountPayableSubLedgerId,
                            Debit = (((e.ChargesAmount + e.TaxAmount) < (e.PriorChargesAmount + e.PriorTaxAmount)) ? 0 : decimal.Round((decimal)(Abs(netPayableAmount)), 2)),
                            Credit = (((e.ChargesAmount + e.TaxAmount) < (e.PriorChargesAmount + e.PriorTaxAmount)) ? decimal.Round((decimal)(Abs(netPayableAmount)), 2) : 0),
                            Description =
                                string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                            DocumentNumber = e.TransactionNo
                        };

                        payable.AddNew();
                        payable.Save();
                        totalDebit += payable.Debit.Value;
                        totalCredit += payable.Credit.Value;
                    }
                    //else //untuk tipe PO Cash
                    //{
                    //    var payable = new JournalTransactionDetails
                    //    {
                    //        JournalId = header.JournalId,
                    //        ChartOfAccountId = cAccountCash,
                    //        SubLedgerId = 0,
                    //        Debit = 0,
                    //        Credit = decimal.Round((decimal)netPayableAmount, 2),
                    //        Description =
                    //            string.Format("RECEIVE #:{0}. SUP:{1}. INV SUP #: {2}.", e.TransactionNo, supplierName, invNo),
                    //        DocumentNumber = e.TransactionNo
                    //    };

                    //    payable.AddNew();
                    //    payable.Save();
                    //    totalCredit += payable.Credit.Value;

                    //}
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPOReceived) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return header.JournalId;
            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        public static int? AddNewConsignmentInvoicingVoidJournal(InvoiceSupplier e, string editedBy)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = BusinessObject.JournalType.ConsignmentInvoicing;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;


                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                var sup = new Supplier();
                if (!sup.LoadByPrimaryKey(e.SupplierID))
                    return 0;

                //var itm = new InvoiceSupplierItem();
                //if (!itm.LoadByPrimaryKey(e.InvoiceNo))
                //    return 0;

                var eItems = new InvoiceSupplierItemCollection();
                eItems.Query.Where(eItems.Query.InvoiceNo == e.InvoiceNo);
                if (!eItems.Query.Load())
                    return 0;

                dAccount = sup.ChartOfAccountIdAPInProcess.HasValue ? sup.ChartOfAccountIdAPInProcess.Value : 0;
                dSubLedgerId = sup.SubledgerIdAPInProcess.HasValue ? sup.SubledgerIdAPInProcess.Value : 0;

                cAccount = sup.ChartOfAccountIdAP.HasValue ? sup.ChartOfAccountIdAP.Value : 0;
                cSubledgerId = sup.SubledgerIdAP.HasValue ? sup.SubledgerIdAP.Value : 0;

                if (dAccount == 0 || cAccount == 0)
                    return 0;

                //Journal Header
                var headerJournal = new JournalTransactions();
                headerJournal.AddNew();
                headerJournal.JournalType = journalType;
                headerJournal.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("CGIV", e.InvoiceDate.Value);
                headerJournal.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(headerJournal.JournalCode);
                headerJournal.TransactionDate = e.InvoiceDate;
                headerJournal.Description = string.Format("VOID CONSIGNMENT INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                headerJournal.IsPosted = false;
                headerJournal.DateCreated = headerJournal.LastUpdateDateTime = DateTime.Now;
                headerJournal.CreatedBy = headerJournal.CreatedBy = headerJournal.LastUpdateByUserID = editedBy;
                headerJournal.RefferenceNumber = e.InvoiceNo;
                headerJournal.Save();

                decimal hutang = 0;
                //sebenarnya hanya 1 faktur saja per nomor invoice
                foreach (var p in eItems)
                {
                    hutang = ((p.Amount ?? 0) * (p.CurrencyRate ?? 1)) + (p.PPnAmount ?? 0);
                }

                var apLine = new JournalTransactionDetails();
                apLine.AddNew();
                apLine.JournalId = headerJournal.JournalId;
                apLine.ChartOfAccountId = dAccount;
                apLine.SubLedgerId = dSubLedgerId;
                apLine.Debit = 0;
                apLine.Credit = hutang;
                apLine.Description = string.Format("VOID CONSIGNMENT INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                apLine.DocumentNumber = e.InvoiceNo;
                apLine.Save();
                totalDebit += apLine.Debit.Value;

                var bankLine = new JournalTransactionDetails();
                bankLine.AddNew();
                bankLine.JournalId = headerJournal.JournalId;
                bankLine.ChartOfAccountId = cAccount;
                bankLine.SubLedgerId = cSubledgerId;
                bankLine.Debit = hutang;
                bankLine.Credit = 0;
                bankLine.Description = string.Format("VOID CONSIGNMENT INV#:{0}. SUP#:{1}.", e.InvoiceNo, sup.SupplierName);
                bankLine.DocumentNumber = e.InvoiceNo;
                bankLine.Save();
                totalCredit += bankLine.Credit.Value;


                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    headerJournal.BeginEdit();
                    headerJournal.IsPosted = true;
                    headerJournal.EndEdit();
                    headerJournal.Save();
                }

                return headerJournal.JournalId;

            }
            catch (Exception ex)
            {
                return -1;
            }
        }

        //public static int? AddNewPatientPaymentReceiveAccrual_NoTemp(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string RefNo, string editedBy, int journalId)
        //{
        //    //payment received
        //    if (!IsAutoJournalEnabled())
        //        return 0;

        //    //if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsAccrualProrataRevenue)) {
        //    return AddNewPatientPaymentReceiveAccrualProporsi_NoTemp(journalType, tp, reg, tpItems, prefix, RefNo, editedBy, journalId);
        //    //}

        //    //Logger.EnterMethod("AddNewPaymentJournal");
        //    try
        //    {
        //        bool newJournal = journalId == 0;
        //        //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

        //        //var CoaColl = new ChartOfAccountsCollection();
        //        var regType = reg.SRRegistrationType;

        //        string guarID = string.IsNullOrEmpty(tp.GuarantorID) ? reg.GuarantorID : tp.GuarantorID;
        //        var grn = new Guarantor();
        //        grn.LoadByPrimaryKey(guarID);

        //        var sSelfGuarantorID = "SELF";
        //        var self = new AppParameter();
        //        self.LoadByPrimaryKey("SelfGuarantorID");
        //        sSelfGuarantorID = self.ParameterValue;

        //        if (regType != "EMR")
        //        {
        //            var merge = new MergeBilling();
        //            if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
        //            {
        //                var r = new Registration();
        //                r.LoadByPrimaryKey(merge.FromRegistrationNo);
        //                regType = r.SRRegistrationType;
        //            }
        //        }
        //        if (regType == "MCU")
        //            regType = "OPR";

        //        Patient pEnity = new Patient();
        //        pEnity.LoadByPrimaryKey(reg.PatientID);

        //        var keterangan = (journalType == "07") ? "PAYMENT RETURN" : "PAYMENT";

        //        //Journal Header
        //        JournalTransactions entity = new JournalTransactions();

        //        // cegah double jurnal
        //        if (journalId == 0)
        //        {
        //            entity.Query.Where(entity.Query.RefferenceNumber == RefNo, entity.Query.JournalIdRefference.IsNull());
        //            entity.Query.es.Top = 1;
        //            if (entity.Load(entity.Query))
        //            {
        //                journalId = entity.JournalId.Value;
        //            }
        //        }

        //        entity = new JournalTransactions();
        //        if (entity.LoadByPrimaryKey(journalId))
        //        {
        //            ValidateClosingPeriode(entity);

        //            var journalDetails = new JournalTransactionDetailsCollection();
        //            journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
        //            journalDetails.LoadAll();
        //            journalDetails.MarkAllAsDeleted();
        //            journalDetails.Save();

        //            // rejournal tidak usah update last update
        //            entity.LastUpdateDateTime = DateTime.Now;
        //            //entity.LastUpdateByUserID = editedBy;
        //            entity.IsVoid = false;

        //            // delete prev message
        //            JournalErrorMessageDelete(entity);

        //            entity.Save();
        //        }
        //        else
        //        {
        //            entity = new JournalTransactions();
        //            entity.AddNew();
        //            entity.JournalType = journalType;
        //            entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
        //            entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
        //            entity.TransactionDate = tp.PaymentDate;
        //            entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //            if (journalType == BusinessObject.JournalType.ARCreating)
        //            {
        //                if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
        //                {
        //                    entity.Description = string.Format("{0} SUP#:{1}", entity.Description, grn.GuarantorName);
        //                }
        //            }
        //            entity.IsPosted = false;
        //            entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
        //            entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
        //            entity.RefferenceNumber = tp.PaymentNo;

        //            entity.Save();
        //            ValidateClosingPeriode(entity);
        //        }

        //        journalId = entity.JournalId.Value;

        //        var coaColl = new ChartOfAccountsCollection();

        //        decimal totalDebit = 0;
        //        decimal totalCredit = 0;
        //        decimal PayCurrent = 0;
        //        decimal PayCurrentRound = 0;
        //        decimal PayCurrentBalance = 0;
        //        decimal adminGuarantor = 0;

        //        DataTable dtbl = new DataTable();
        //        dtbl.Columns.Add("coaId", typeof(int));
        //        dtbl.Columns.Add("subledgerId", typeof(int));
        //        dtbl.Columns.Add("balance", Type.GetType("System.String"));
        //        dtbl.Columns.Add("Amount", Type.GetType("System.Decimal"));

        //        keterangan = (journalType == "07") ? "RETURN" : "";

        //        var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

        //        var stdDR = new AppStandardReferenceItemCollection();
        //        stdDR.Query.Where(stdDR.Query.StandardReferenceID == "DiscountReason");
        //        stdDR.LoadAll();

        //        foreach (var p in tpItems)
        //        {
        //            string payMethode = p.SRPaymentMethod;
        //            string payType = p.SRPaymentType;
        //            bool isCardPayment = false;

        //            PaymentType pt = new PaymentType();
        //            if (!pt.LoadByPrimaryKey(payType))
        //                continue;

        //            int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
        //            string dAccountMsg = string.Empty;
        //            int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
        //            int cAccount = 0;

        //            PaymentMethod pm = new PaymentMethod();
        //            if (!pm.LoadByPrimaryKey(payType, payMethode))
        //            {
        //                if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
        //                    continue;
        //            }

        //            if (pm.ChartOfAccountID.HasValue)
        //            {
        //                dAccount = pm.ChartOfAccountID.Value;
        //                dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
        //                dAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
        //            }

        //            // if appstdref of discount reason has coa
        //            string DiscountReason = string.Empty;
        //            if (!string.IsNullOrEmpty(p.SRDiscountReason) && p.SRPaymentType == "PaymentType-005")
        //            {
        //                var sDiscReason = stdDR.Where(std => std.ItemID == p.SRDiscountReason);
        //                if (sDiscReason.Count() > 0)
        //                {
        //                    var dsc = sDiscReason.First();
        //                    DiscountReason = dsc.ItemName;
        //                    dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
        //                    if ((dsc.coaID ?? 0) != 0)
        //                    {
        //                        dAccount = dsc.coaID.Value;
        //                        dSubledgerId = dsc.subledgerID ?? 0;
        //                    }
        //                }
        //            }

        //            if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
        //            {
        //                //transfer
        //                if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
        //                {
        //                    bool skipBank = false;
        //                    if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaCashierPaymentTransferFromPaymentMethod))
        //                    {
        //                        // 
        //                        try
        //                        {
        //                            ValidateCOA(pm.ChartOfAccountID, coaColl);
        //                            skipBank = true;
        //                        }
        //                        catch (Exception ex)
        //                        {

        //                        }
        //                    }
        //                    if (!skipBank)
        //                    {
        //                        Bank bank = new Bank();
        //                        if (bank.LoadByPrimaryKey(p.BankID))
        //                        {
        //                            if (bank.ChartOfAccountId.HasValue)
        //                                dAccount = bank.ChartOfAccountId.Value;
        //                            if (bank.SubledgerId.HasValue)
        //                                dSubledgerId = bank.SubledgerId.Value;
        //                            dAccountMsg = string.Format("Bank: {0}", bank.BankName);
        //                        }
        //                    }
        //                }
        //            }

        //            if (p.IsFromDownPayment.Value)
        //            {
        //                // amount that we receive from the payment
        //                //if (p.Amount.Value != 0)
        //                //{
        //                //    int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
        //                //    // int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");




        //                //    JournalTransactionDetails d = new JournalTransactionDetails();
        //                //    d.AddNew();
        //                //    d.JournalId = entity.JournalId;
        //                //    d.ChartOfAccountId = dAccount_off;
        //                //    d.SubLedgerId = 0;
        //                //    d.Debit = Abs(p.Amount + p.Balance ?? 0);
        //                //    d.Credit = 0;
        //                //    d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan, 
        //                //        (DiscountReason.Length > 0 ? " ":"") + DiscountReason);
        //                //    d.DocumentNumber = tp.PaymentNo;
        //                //    d.Save();

        //                //    totalDebit += d.Debit.Value;
        //                //}

        //                // start uang muka
        //                // perlu dicari ini uang muka dari payment registrasi yang mana supaya 
        //                // pas tarik ledger bisa direkon, harus pecah per noreg
        //                int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
        //                var dpdt = new TransPaymentItemQuery("a");
        //                var dphd = new TransPaymentQuery("b");

        //                dpdt.InnerJoin(dphd).On(dpdt.PaymentNo == dphd.PaymentNo)
        //                    .Where(dphd.PaymentReferenceNo == p.PaymentNo,
        //                        dphd.IsApproved == true,
        //                        dphd.IsVoid == false,
        //                        dphd.TransactionCode == "018")
        //                    .OrderBy(dphd.RegistrationNo.Descending, dphd.PaymentNo.Ascending)
        //                    .Select(dphd.RegistrationNo, dphd.PaymentNo, dpdt.Amount, dpdt.Balance);
        //                DataTable dtpay = dpdt.LoadDataTable();
        //                decimal sumAmount = 0;
        //                for (int i = 0; i < dtpay.Rows.Count; i++)
        //                {
        //                    sumAmount += (decimal)(dtpay.Rows[i]["Amount"] ?? 0) + (decimal)(dtpay.Rows[i]["Balance"] ?? 0);
        //                    if (dtpay.Rows[i]["RegistrationNo"].ToString() !=
        //                        ((i + 1 == dtpay.Rows.Count) ? "" : dtpay.Rows[i + 1]["RegistrationNo"].ToString()))
        //                    {
        //                        // this is the last row or last current reg, do save
        //                        JournalTransactionDetails d = new JournalTransactionDetails();
        //                        d.AddNew();
        //                        d.JournalId = entity.JournalId;
        //                        d.ChartOfAccountId = ValidateCOA(dAccount_off, coaColl, "App Parameter: coa_DownPayment");
        //                        d.SubLedgerId = 0;

        //                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
        //                        d.Debit = (sumAmount > 0) ? sumAmount : 0;
        //                        d.Credit = (sumAmount < 0) ? (sumAmount * -1) : 0;
        //                        // end of modif teguh s 2016 06 02

        //                        d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", dtpay.Rows[i]["RegistrationNo"].ToString(), pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
        //                            (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
        //                        d.DocumentNumber = tp.PaymentNo;
        //                        d.DocumentNumberSequenceNo = p.SequenceNo;

        //                        AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);

        //                        d.Save();

        //                        totalDebit += d.Debit.Value;
        //                        totalCredit += d.Credit.Value;
        //                        PayCurrent += sumAmount;
        //                        sumAmount = 0;
        //                    }
        //                }
        //                // end uang muka

        //                if (p.Balance.Value != 0) //payment return
        //                {
        //                    //int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
        //                    //Modif By Hermawan
        //                    //int cAccount_off = dAccount;
        //                    //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
        //                    int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");
        //                    int cAccountPayable_off = GetCachedAccountFromParam("coa_DownPaymentReturnPayable");

        //                    ////-------------- ini dulunya kenapa diremark?
        //                    //JournalTransactionDetails d = new JournalTransactionDetails();
        //                    //d.AddNew();
        //                    //d.JournalId = entity.JournalId;
        //                    //d.ChartOfAccountId = dAccount_off;
        //                    //d.SubLedgerId = 0;
        //                    //d.Debit = Abs(p.Balance);
        //                    //d.Credit = 0;
        //                    //d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                    //d.DocumentNumber = tp.PaymentNo;
        //                    //d.Save();

        //                    //totalDebit += d.Debit.Value;
        //                    ////-------------------------------------

        //                    JournalTransactionDetails c = new JournalTransactionDetails();
        //                    c.AddNew();
        //                    c.JournalId = entity.JournalId;
        //                    if (p.IsBackOfficeReturn ?? false)
        //                        c.ChartOfAccountId = ValidateCOA(cAccountPayable_off, coaColl, "App Parameter: coa_DownPaymentReturnPayable");
        //                    else
        //                        c.ChartOfAccountId = ValidateCOA(cAccount_off, coaColl, "App Parameter: coa_DownPaymentReturn");
        //                    c.SubLedgerId = 0;

        //                    // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
        //                    c.Debit = (p.Balance < 0) ? (p.Balance * -1) : 0;
        //                    c.Credit = (p.Balance > 0) ? p.Balance : 0;
        //                    // end of modif teguh s 2016 06 02

        //                    c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                    c.DocumentNumber = tp.PaymentNo;
        //                    c.DocumentNumberSequenceNo = p.SequenceNo;

        //                    AddMoreInfo(c, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);

        //                    c.Save();

        //                    totalDebit += c.Debit.Value;
        //                    totalCredit += c.Credit.Value;
        //                    PayCurrentBalance += p.Balance.Value;
        //                }
        //            }
        //            else
        //            {
        //                cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
        //                if (journalType.Equals(BusinessObject.JournalType.DownPayment))
        //                {
        //                    cAccount = GetCachedAccountFromParam("coa_DownPayment");
        //                }

        //                // piutang instansi || piutang personal
        //                if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
        //                {
        //                    Guarantor guarantorEntity = new Guarantor();
        //                    if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
        //                    {
        //                        var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);
        //                        //var coaInv = IsSplitIprOpr ? guarantorEntity.ChartOfAccountId : ();
        //                        //if (guarantorEntity.ChartOfAccountId.HasValue)
        //                        //{
        //                        var PrmUsingInvoicing = new AppParameter();
        //                        if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
        //                        {
        //                            throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
        //                        }
        //                        if (PrmUsingInvoicing.ParameterValue == "Yes")
        //                        {
        //                            AppParameter app = new AppParameter();
        //                            app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
        //                            if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
        //                            {
        //                                /* 
        //                                 * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
        //                                 * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
        //                                 * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
        //                                 * kalau bingung tanya teguh s
        //                                 */
        //                                dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
        //                                dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
        //                                dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
        //                            }
        //                            else
        //                            {
        //                                dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdTemporaryIPR ?? 0) : (guarantorEntity.ChartOfAccountIdTemporary ?? 0);
        //                                dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubledgerIdTemporaryIPR ?? 0) : (guarantorEntity.SubledgerIdTemporary ?? 0);
        //                                dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Invoice)", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
        //                            }
        //                        }
        //                        else
        //                        {
        //                            dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
        //                            dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
        //                            dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process){1}", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
        //                        }
        //                        //}
        //                    }
        //                }

        //                if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
        //                {
        //                    // Payment Credit Card || Payment Debit Card 
        //                    if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
        //                    {
        //                        isCardPayment = true;
        //                        EDCMachine edcMachineEntity = new EDCMachine();
        //                        if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
        //                        {
        //                            // Setting Account Code Per EDC Machine
        //                            if (edcMachineEntity.ChartOfAccountID.HasValue)
        //                            {
        //                                dAccount = edcMachineEntity.ChartOfAccountID.Value;
        //                                dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
        //                                dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);
        //                            }
        //                        }
        //                    }
        //                }

        //                //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
        //                JournalTransactionDetails d = new JournalTransactionDetails();
        //                d.AddNew();
        //                d.JournalId = entity.JournalId;
        //                d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
        //                d.SubLedgerId = dSubledgerId;

        //                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
        //                d.Debit = (p.Amount > 0) ? p.Amount : 0;
        //                d.Credit = (p.Amount < 0) ? (p.Amount * -1) : 0;
        //                // end of modif teguh s 2016 06 02

        //                d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
        //                    (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
        //                if (journalType == BusinessObject.JournalType.ARCreating)
        //                {
        //                    if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
        //                    {
        //                        d.Description = string.Format("{0} SUP#:{1}", d.Description, grn.GuarantorName);
        //                    }
        //                }
        //                d.DocumentNumber = tp.PaymentNo;
        //                d.DocumentNumberSequenceNo = p.SequenceNo;

        //                AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);

        //                d.Save();

        //                totalDebit += d.Debit.Value;
        //                totalCredit += d.Credit.Value;
        //                PayCurrent += p.Amount.Value;

        //            }

        //            if ((p.RoundingAmount ?? 0) != 0)
        //            {
        //                // no rounding for card payment, (payment bugs escape)
        //                //if (!isCardPayment)
        //                //{
        //                int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
        //                JournalTransactionDetails k = new JournalTransactionDetails();
        //                k.AddNew();
        //                k.JournalId = entity.JournalId;
        //                k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
        //                k.SubLedgerId = 0;

        //                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
        //                k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
        //                k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
        //                // end of modif teguh s 2016 06 02

        //                k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                k.DocumentNumber = tp.PaymentNo;
        //                k.DocumentNumberSequenceNo = p.SequenceNo;

        //                AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);

        //                k.Save();

        //                totalDebit += k.Debit.Value;
        //                totalCredit += k.Credit.Value;

        //                PayCurrentRound += (p.RoundingAmount ?? 0);
        //                //}
        //            }
        //            // ADM pindah kebawah

        //            // if there is CC fee
        //            if (p.CardFeeAmount > 0)
        //            {
        //                // debit
        //                JournalTransactionDetails dFee = new JournalTransactionDetails();
        //                dFee.AddNew();
        //                dFee.JournalId = entity.JournalId;
        //                dFee.ChartOfAccountId = dAccount;
        //                dFee.SubLedgerId = 0;
        //                dFee.Debit = Abs(p.CardFeeAmount);
        //                dFee.Credit = 0;
        //                dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                dFee.DocumentNumber = tp.PaymentNo;
        //                dFee.DocumentNumberSequenceNo = p.SequenceNo;

        //                dFee.GuarantorID = grn.GuarantorID;
        //                dFee.Save();

        //                totalDebit += dFee.Debit.Value;

        //                // credit
        //                JournalTransactionDetails cFee = new JournalTransactionDetails();
        //                cFee.AddNew();
        //                cFee.JournalId = entity.JournalId;
        //                cFee.ChartOfAccountId = ValidateCOA(GetCachedAccountFromParam("coa_PaymentCardFeeAmt"), coaColl, "AppParameter:coa_PaymentCardFeeAmt");
        //                cFee.SubLedgerId = 0;
        //                cFee.Debit = 0;
        //                cFee.Credit = Abs(p.CardFeeAmount);
        //                cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                cFee.DocumentNumber = tp.PaymentNo;
        //                cFee.DocumentNumberSequenceNo = p.SequenceNo;

        //                AddMoreInfo(cFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);

        //                cFee.Save();

        //                totalCredit += cFee.Credit.Value;
        //            }
        //        }

        //        /* start hitung jurnal pendapatan */
        //        DataTable dtb;
        //        decimal transCurrent = 0, transCurrentIB = 0;

        //        List<PackageJournal> pkg = new List<PackageJournal>();

        //        var a = new TransPaymentItemIntermBillQuery();
        //        a.Where(a.PaymentNo == RefNo);
        //        dtb = a.LoadDataTable();
        //        if (dtb.Rows.Count == 0)
        //        {
        //            var b = new TransPaymentItemIntermBillGuarantorQuery();
        //            b.Where(b.PaymentNo == RefNo);
        //            dtb = new DataTable();
        //            dtb = b.LoadDataTable();
        //        }

        //        var cc = new TransPaymentItemOrderCollection();
        //        cc.Query.Where(cc.Query.PaymentNo == RefNo);
        //        cc.LoadAll();

        //        var jtdActualColl = new JournalTransactionDetailsCollection();
        //        var trNoSeqNo = new List<Tuple<string, string>>();
        //        var trNoSeqNoDetailPkg = new List<Tuple<string, string>>();

        //        foreach (var row in cc)
        //        {
        //            trNoSeqNo.Add(new Tuple<string, string>(row.TransactionNo, row.SequenceNo));

        //            var prs = new TransPrescriptionItem();
        //            if (prs.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
        //                transCurrent += prs.LineAmount.Value;
        //            else
        //                transCurrent += row.Qty.Value * row.Price.Value;

        //            //harus dihitung ulang jurnal pendapatan dan diskon karena diskon dari verifikasi billing tidak ada jurnal khusus 
        //            var TransC = new TransCharges();
        //            if (TransC.LoadByPrimaryKey(row.TransactionNo))
        //            {
        //                var transCI = new TransChargesItem();
        //                if (transCI.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
        //                {
        //                    var cCalc = new CostCalculation();
        //                    if (cCalc.LoadByPrimaryKey(TransC.RegistrationNo, row.TransactionNo, row.SequenceNo))
        //                    {
        //                        /* start journal*/
        //                        var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
        //                        if (jtdColl.Count > 0)
        //                        {
        //                            trNoSeqNoDetailPkg.AddRange(jtdColl.Where(j =>
        //                                !trNoSeqNo.Contains(new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo)) &&
        //                                (!string.IsNullOrEmpty(j.DocumentNumber)) &&
        //                                (!string.IsNullOrEmpty(j.DocumentNumberSequenceNo))
        //                            ).Select(j => new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo))
        //                            .Distinct());
        //                        }
        //                        jtdActualColl.Combine(jtdColl);
        //                        /* end journal */
        //                    }
        //                    else
        //                    {
        //                        cCalc = new CostCalculation();
        //                        cCalc.RegistrationNo = TransC.RegistrationNo;
        //                        cCalc.TransactionNo = row.TransactionNo;
        //                        cCalc.SequenceNo = row.SequenceNo;
        //                        cCalc.ItemID = row.ItemID;
        //                        cCalc.PatientAmount = transCI.ChargeQuantity * (transCI.Price - (transCI.DiscountAmount / (transCI.ChargeQuantity == 0 ? 1 : transCI.ChargeQuantity)));
        //                        cCalc.GuarantorAmount = 0;
        //                        cCalc.DiscountAmount = transCI.DiscountAmount;

        //                        /* start journal*/
        //                        var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
        //                        if (jtdColl.Count > 0)
        //                        {
        //                            trNoSeqNoDetailPkg.AddRange(jtdColl.Where(j =>
        //                                !trNoSeqNo.Contains(new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo)) &&
        //                                (!string.IsNullOrEmpty(j.DocumentNumber)) &&
        //                                (!string.IsNullOrEmpty(j.DocumentNumberSequenceNo))
        //                            ).Select(j => new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo))
        //                            .Distinct());
        //                        }
        //                        jtdActualColl.Combine(jtdColl);
        //                        /* end journal */
        //                    }
        //                }
        //            }
        //            //precription
        //            else
        //            {
        //                var transPresc = new TransPrescription();
        //                transPresc.LoadByPrimaryKey(row.TransactionNo);

        //                var cCalc = new CostCalculation();
        //                if (cCalc.LoadByPrimaryKey(transPresc.RegistrationNo, row.TransactionNo, row.SequenceNo))
        //                {
        //                    trNoSeqNo.Add(new Tuple<string, string>(cCalc.TransactionNo, cCalc.SequenceNo));
        //                    /* start journal*/
        //                    var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, 0, coaColl);
        //                    jtdActualColl.Combine(jtdColl);
        //                    /* end journal */
        //                }
        //            }
        //        }

        //        //decimal TIntermbill = 0, TPayment = 0;
        //        if (dtb.Rows.Count > 0)
        //        {
        //            foreach (DataRow row in dtb.Rows)
        //            {
        //                var q = new IntermBillCollection();
        //                q.Query.Where(
        //                    q.Query.IntermBillNo == row["intermBillNo"],
        //                    q.Query.Or(
        //                        q.Query.JournalIncomePaymentNo == string.Empty,
        //                        q.Query.JournalIncomePaymentNo == RefNo
        //                        )
        //                    );
        //                //q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"], q.Query.JournalIncomePaymentNo == RefNo);
        //                //q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"]);
        //                q.LoadAll();

        //                var ibq = new IntermBillQuery("ibq");
        //                var tp2 = new TransPaymentQuery("tp2");
        //                ibq.LeftJoin(tp2).On(ibq.JournalIncomePaymentNo == tp2.PaymentNo && tp2.IsVoid == false);
        //                ibq.Where(
        //                    ibq.IntermBillNo == row["intermBillNo"],
        //                    ibq.Or(
        //                        "<ISNULL(tp2.PaymentNo,'') = '' OR >",
        //                        ibq.JournalIncomePaymentNo == RefNo
        //                        )
        //                    );
        //                ibq.Select(ibq);
        //                ibq.es.Distinct = true;
        //                q.Load(ibq);

        //                foreach (var x in q)
        //                {
        //                    x.JournalIncomePaymentNo = RefNo;
        //                    q.Save();

        //                    // ======
        //                    var costColl = new CostCalculationCollection();

        //                    costColl.Query.Where(
        //                        costColl.Query.IntermBillNo == x.IntermBillNo
        //                        );
        //                    costColl.Query.OrderBy(
        //                        costColl.Query.RegistrationNo.Ascending,
        //                        costColl.Query.TransactionNo.Ascending,
        //                        costColl.Query.SequenceNo.Ascending
        //                        );

        //                    costColl.LoadAll();
        //                    foreach (var cost in costColl)
        //                    {
        //                        trNoSeqNo.Add(new Tuple<string, string>(cost.TransactionNo, cost.SequenceNo));

        //                        var jtdColl = GetNewIncomeJournalCashBased(entity, cost, false, 0, coaColl);
        //                        if (jtdColl.Count > 0) {
        //                            trNoSeqNoDetailPkg.AddRange(jtdColl.Where(j =>
        //                                !trNoSeqNo.Contains(new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo)) &&
        //                                (!string.IsNullOrEmpty(j.DocumentNumber)) &&
        //                                (!string.IsNullOrEmpty(j.DocumentNumberSequenceNo))
        //                            ).Select(j => new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo))
        //                            .Distinct());
        //                        } 


        //                        jtdActualColl.Combine(jtdColl);
        //                    }
        //                    // ======
        //                }

        //                // ambil total trnsaksi dari intermbill
        //                var ibT = new IntermBill();
        //                if (ibT.LoadByPrimaryKey(row["intermBillNo"].ToString()))
        //                {
        //                    transCurrentIB += ibT.PatientAmount.Value + ibT.GuarantorAmount.Value +
        //                        ibT.AdministrationAmount.Value + ibT.GuarantorAdministrationAmount.Value -
        //                        ibT.DiscAdmPatient.Value - ibT.DiscAdmGuarantor.Value;
        //                }
        //            }
        //        }

        //        int coaPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
        //        if (trNoSeqNo.Count > 0) {
        //            var regs = MergeBilling.GetMergeBillingByReg(reg.RegistrationNo);
        //            var transNos = trNoSeqNo.Select(t => t.Item1).Distinct().ToList();

        //            // load jurnal accru
        //            var jadColl = new JournalTransactionDetailsCollection();
        //            jadColl.LoadByRefNoForAccrual(transNos);
        //            // load journal bill recal existing
        //            var jbdColl = new JournalTransactionDetailsCollection();
        //            jbdColl.LoadByRefNoBillRecalForAccrual(regs, transNos, DateTime.Now);
        //            jadColl.Combine(jbdColl);

        //            var trNoALL = trNoSeqNo.Union(trNoSeqNoDetailPkg);
        //            foreach (var jad in jadColl)
        //            {
        //                if (!trNoALL.Any(ts => ts.Item1 == jad.DocumentNumber && ts.Item2 == jad.DocumentNumberSequenceNo) && !string.IsNullOrEmpty(jad.DocumentNumberSequenceNo))
        //                {
        //                    jadColl.DetachEntity(jad); // detach from coll,
        //                }
        //                else
        //                {
        //                    // reverse
        //                    jad.SwabDK();
        //                    //var credit = jad.Credit ?? 0;
        //                    //jad.Credit = jad.Debit;
        //                    //jad.Debit = credit;
        //                }
        //            }

        //            jtdActualColl.MergeJournalRevenue(jadColl, entity, coaPatRec);
        //            //foreach (var jad in jadColl)
        //            //{
        //            //    JournalTransactionDetails jd = null;
        //            //    if (string.IsNullOrEmpty(jad.TariffComponentID))
        //            //    {
        //            //        // data lama gak ada data tariff componentid, atau jurnal obat alkes gak ada tariff componentid gpp masuk sini
        //            //        jd = jtdActualColl.Where(j => j.ChartOfAccountId == jad.ChartOfAccountId &&
        //            //            j.SubLedgerId == jad.SubLedgerId &&
        //            //            j.DocumentNumber == jad.DocumentNumber &&
        //            //            j.DocumentNumberSequenceNo == jad.DocumentNumberSequenceNo &&
        //            //            j.ItemID == jad.ItemID // <-- diperlukan untuk item consumption
        //            //        ).FirstOrDefault();
        //            //    }
        //            //    else {
        //            //        jd = jtdActualColl.Where(j => j.ChartOfAccountId == jad.ChartOfAccountId &&
        //            //                j.SubLedgerId == jad.SubLedgerId &&
        //            //                j.DocumentNumber == jad.DocumentNumber &&
        //            //                j.DocumentNumberSequenceNo == jad.DocumentNumberSequenceNo &&
        //            //                j.TariffComponentID == jad.TariffComponentID &&
        //            //                j.ItemID == jad.ItemID // <-- diperlukan untuk item consumption
        //            //            ).FirstOrDefault();
        //            //    }

        //            //    if (jd == null)
        //            //    {
        //            //        jadColl.DetachEntity(jad);
        //            //        jad.AcceptChanges();
        //            //        jad.MarkAllColumnsAsDirty(DataRowState.Added);
        //            //        jad.JournalId = entity.JournalId;
        //            //        jtdActualColl.AttachEntity(jad);
        //            //    }
        //            //    else
        //            //    {
        //            //        jd.Debit += jad.Debit.Value;
        //            //        jd.Credit += jad.Credit.Value;
        //            //    }
        //            //}

        //            //foreach (var jd in jtdActualColl)
        //            //{
        //            //    var amt = jd.Debit.Value - jd.Credit.Value;
        //            //    jd.Debit = amt > 0 ? amt : 0;
        //            //    jd.Credit = amt < 0 ? (amt * -1) : 0;

        //            //    if (jd.ChartOfAccountId.Value == coaPatRec && jd.SubLedgerId == 0)
        //            //    {
        //            //        jtdActualColl.DetachEntity(jd);
        //            //    }
        //            //    else
        //            //    if (jd.Debit.Value + jd.Credit.Value == 0)
        //            //    {
        //            //        jtdActualColl.DetachEntity(jd);
        //            //    }
        //            //}

        //            var sDeb = jtdActualColl.Sum(jtd => jtd.Debit ?? 0);
        //            var sCre = jtdActualColl.Sum(jtd => jtd.Credit ?? 0);
        //            var sAmt = sDeb - sCre;
        //            if (sAmt != 0)
        //            {

        //                JournalTransactionDetails pdp = jtdActualColl.AddNew();
        //                pdp.JournalId = entity.JournalId;
        //                pdp.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable");
        //                pdp.SubLedgerId = 0;
        //                pdp.Debit = (sAmt > 0) ? 0 : Abs(sAmt);
        //                pdp.Credit = (sAmt > 0) ? sAmt : 0;
        //                pdp.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, "Patient receivable correction");
        //                pdp.DocumentNumber = tp.PaymentNo;
        //                //cFee.DocumentNumberSequenceNo = p.SequenceNo;

        //                AddMoreInfo(pdp, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);
        //            }

        //            jtdActualColl.Save();
        //            totalDebit += jtdActualColl.Sum(d => d.Debit.Value);
        //            totalCredit += jtdActualColl.Sum(d => d.Credit.Value);
        //        }

        //        // ADM
        //        foreach (var p in tpItems)
        //        {
        //            string[] intermBillNo = new string[0];

        //            var a1 = new TransPaymentItemIntermBillCollection();
        //            a1.Query.Where(a1.Query.PaymentNo == RefNo);
        //            if (a1.Query.Load())
        //            {
        //                intermBillNo = new string[a1.Count];
        //                for (int i = 0; i < a1.Count; i++)
        //                {
        //                    intermBillNo.SetValue(a1[i].IntermBillNo, i);
        //                }
        //            }
        //            else
        //            {
        //                var b1 = new TransPaymentItemIntermBillGuarantorCollection();
        //                b1.Query.Where(b1.Query.PaymentNo == RefNo);
        //                if (b1.Query.Load())
        //                {
        //                    intermBillNo = new string[b1.Count];
        //                    for (int i = 0; i < b1.Count; i++)
        //                    {
        //                        intermBillNo.SetValue(b1[i].IntermBillNo, i);
        //                    }
        //                }
        //            }

        //            foreach (string ib1 in intermBillNo)
        //            {
        //                var ib = new IntermBill();
        //                ib.LoadByPrimaryKey(ib1);
        //                if (string.IsNullOrEmpty(ib.JournalIncomePaymentNo) || ib.JournalIncomePaymentNo == RefNo)
        //                {
        //                    // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
        //                    //if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
        //                    {
        //                        if (((ib.AdministrationAmount - ib.DiscAdmPatient) + (ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor)) != 0
        //                            // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
        //                            //if (reg.AdministrationAmount > 0 
        //                            && (journalType.Equals(BusinessObject.JournalType.ARCreating) || journalType.Equals(BusinessObject.JournalType.Payment)) &&
        //                            //tp.RemainingAmount <= 0 && 
        //                            p.SequenceNo == lastRow.SequenceNo)
        //                        {
        //                            var itemAdm = String.Empty;
        //                            var CompID = String.Empty;
        //                            AppParameter app = new AppParameter();
        //                            if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
        //                                itemAdm = app.ParameterValue;
        //                            Item item = new Item();
        //                            item.Query.Where(item.Query.ItemID == itemAdm);
        //                            if (!item.Query.Load())
        //                            {
        //                                throw new Exception("App Parameter: coa_ItemIdBillingTotalAdmFee: " + itemAdm + " is not a valid service");
        //                            }


        //                            //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
        //                            AppParameter app2 = new AppParameter();
        //                            if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
        //                                CompID = app2.ParameterValue;
        //                            TariffComponent ic = new TariffComponent();
        //                            ic.Query.Where(ic.Query.TariffComponentID == CompID);
        //                            if (!ic.Query.Load())
        //                            {
        //                                throw new Exception("App Parameter: coa_CompIDForBillingAdm: " + CompID + " is not a valid tarif component");
        //                            }

        //                            var su = new ServiceUnit();
        //                            if (su.LoadByPrimaryKey(reg.ServiceUnitID))
        //                            { }

        //                            ServiceUnitItemService itemService = new ServiceUnitItemService();
        //                            itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
        //                                                    itemService.Query.ItemID == itemAdm);
        //                            if (!itemService.Query.Load())
        //                            {
        //                                throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
        //                            }
        //                            int? coaId = 0;
        //                            int? subLedgerId = 0;

        //                            var grr = new Guarantor();
        //                            grr.LoadByPrimaryKey(reg.GuarantorID);

        //                            ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
        //                            itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
        //                                                 itemComp.Query.ItemID == itemAdm,
        //                                                 itemComp.Query.TariffComponentID == CompID,
        //                                                 itemComp.Query.SRRegistrationType == regType,
        //                                                 itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


        //                            if (itemComp.Query.Load())
        //                            {
        //                                if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
        //                                {
        //                                    coaId = itemComp.ChartOfAccountIdIncome;
        //                                    subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
        //                                }
        //                            }

        //                            // kalau Rawat Inap
        //                            if (reg.SRRegistrationType == "IPR")
        //                            {
        //                                ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
        //                                itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
        //                                    itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

        //                                if (itemClass.Query.Load())
        //                                {
        //                                    if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
        //                                    {
        //                                        coaId = itemClass.ChartOfAccountIdIncome.Value;
        //                                        subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
        //                                    }
        //                                }
        //                            }

        //                            //adm pasien
        //                            if ((ib.AdministrationAmount - ib.DiscAdmPatient) != 0)
        //                            {
        //                                JournalTransactionDetails j = new JournalTransactionDetails();
        //                                j.AddNew();
        //                                j.JournalId = entity.JournalId;
        //                                j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
        //                                j.SubLedgerId = subLedgerId;

        //                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
        //                                var admIB = (ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0);
        //                                j.Debit = (admIB < 0) ? (admIB * -1) : 0;
        //                                j.Credit = (admIB > 0) ? admIB : 0;
        //                                // end of modif teguh s 2016 06 02

        //                                j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
        //                                j.DocumentNumber = tp.PaymentNo;

        //                                AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                                    null, su.ServiceUnitID, item.ItemID, tp.RegistrationNo);
        //                                j.Save();

        //                                totalDebit += j.Debit.Value;
        //                                totalCredit += j.Credit.Value;
        //                                adminGuarantor += Abs((ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0));
        //                                // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
        //                                //transCurrent += j.Credit.Value - j.Debit.Value;
        //                            }

        //                            //adm guarantor
        //                            if ((ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor) != 0)
        //                            {
        //                                JournalTransactionDetails j = new JournalTransactionDetails();
        //                                j.AddNew();
        //                                j.JournalId = entity.JournalId;
        //                                j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
        //                                j.SubLedgerId = subLedgerId;

        //                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
        //                                var admIB = (ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0);
        //                                j.Debit = (admIB < 0) ? (admIB * -1) : 0;
        //                                j.Credit = (admIB > 0) ? admIB : 0;
        //                                // end of modif teguh s 2016 06 02

        //                                j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
        //                                j.DocumentNumber = tp.PaymentNo;

        //                                AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                                    null, string.Empty, item.ItemID, tp.RegistrationNo);
        //                                j.Save();

        //                                totalDebit += j.Debit.Value;
        //                                totalCredit += j.Credit.Value;
        //                                adminGuarantor += Abs((ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0));
        //                                // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
        //                                //transCurrent += j.Credit.Value - j.Debit.Value;
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //        }
        //        // End of ADM

        //        // item tambahan tpio
        //        var tpacColl = new TransPaymentAdditionalChargesCollection();
        //        tpacColl.Query.Where(tpacColl.Query.PaymentNo == tp.PaymentNo);
        //        if (tpacColl.LoadAll())
        //        {
        //            var stdAddCharges = new AppStandardReferenceItemCollection();
        //            stdAddCharges.LoadByStandardReferenceID("CafeAdditionalCharges");
        //            foreach (var tpac in tpacColl)
        //            {
        //                var addCharge = stdAddCharges.Where(ad => ad.ItemID == tpac.SRCafeAdditionalCharges).FirstOrDefault();
        //                if (addCharge == null)
        //                {
        //                    throw new Exception(string.Format("StandardRef: CafeAdditionalCharges: item {0} not found in data master", tpac.SRCafeAdditionalCharges));
        //                }
        //                var jTpac = new JournalTransactionDetails();
        //                jTpac.AddNew();
        //                jTpac.JournalId = entity.JournalId;
        //                jTpac.ChartOfAccountId = ValidateCOA(addCharge.coaID, coaColl, "StandardRef: CafeAdditionalCharges: {0}", addCharge.ItemName);
        //                jTpac.SubLedgerId = 0;
        //                jTpac.Debit = 0;
        //                jTpac.Credit = tpac.ChargeAmount;
        //                jTpac.Description = string.Format("REG#:{0}. PATIENT:{1}. {2}",
        //                    reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, addCharge.ItemName);
        //                jTpac.DocumentNumber = tp.PaymentNo;

        //                AddMoreInfo(jTpac, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                    null, string.Empty, string.Empty, tp.RegistrationNo);
        //                jTpac.Save();

        //                totalDebit += jTpac.Debit.Value;
        //                totalCredit += jTpac.Credit.Value;

        //                transCurrent += jTpac.Credit.Value;
        //            }
        //        }

        //        var SelisihPaket = pkg.Sum(x => x.PackageAmount) - pkg.Sum(x => x.PackageDetailAmount);

        //        //int coa_contemporary = GetCachedAccountFromParam("coa_ContemporaryPayment");
        //        int sl_contemporary = 0;
        //        var slregColl = new SubLedgersCollection();
        //        slregColl.Query.Where(slregColl.Query.SubLedgerName == reg.GuarantorID,
        //            slregColl.Query.GroupId == AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdGuarantor));
        //        if (slregColl.LoadAll())
        //        {
        //            sl_contemporary = slregColl.First().SubLedgerId ?? 0;
        //        }

        //        int coa_overPayment = grn.ChartOfAccountIdOverPayment ?? 0;
        //        int coa_overPaymentmin = grn.ChartOfAccountIdOverPaymentMin ?? 0;

        //        if (tp.IsVoid ?? false)
        //        {
        //            // kalau payment void, seimbangkan saja jurnalnya
        //            var dBal = totalCredit - totalDebit;

        //            JournalTransactionDetails x = new JournalTransactionDetails();
        //            x.AddNew();
        //            x.JournalId = entity.JournalId;
        //            x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
        //            x.SubLedgerId = 0;// sl_contemporary;
        //            x.Debit = (dBal > 0) ? dBal : 0;
        //            x.Credit = (dBal < 0) ? (dBal * -1) : 0;
        //            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //            x.DocumentNumber = tp.PaymentNo;

        //            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                null, string.Empty, string.Empty, tp.RegistrationNo);
        //            x.Save();

        //            totalDebit += x.Debit.Value;
        //            totalCredit += x.Credit.Value;
        //        }
        //        else
        //        {
        //            if (dtb.Rows.Count > 0)
        //            {
        //                decimal paidTrans = 0;

        //                List<string> ibs = new List<string>();
        //                foreach (DataRow row in dtb.Rows)
        //                {
        //                    ibs.Add(row["intermBillNo"].ToString());
        //                }

        //                var ibColl = new IntermBillCollection();
        //                ibColl.Query.Where(ibColl.Query.IntermBillNo.In(ibs), ibColl.Query.JournalIncomePaymentNo == tp.PaymentNo);
        //                if (ibColl.LoadAll())
        //                {
        //                    paidTrans = 0;
        //                }
        //                else
        //                {
        //                    // ambil payment intermbil yang bersangkutan
        //                    var tpiTColl = new TransPaymentItemCollection();
        //                    var tpiT = new TransPaymentItemQuery("tpi");
        //                    var tpT = new TransPaymentQuery("tp");
        //                    var tpibgTColl = new TransPaymentItemIntermBillGuarantorCollection();
        //                    var tpibTColl = new TransPaymentItemIntermBillCollection();
        //                    tpibgTColl.Query.Where(tpibgTColl.Query.IntermBillNo.In(ibs) && tpibgTColl.Query.IsPaymentReturned == false);
        //                    tpibTColl.Query.Where(tpibTColl.Query.IntermBillNo.In(ibs) && tpibTColl.Query.IsPaymentReturned == false);
        //                    tpibgTColl.LoadAll();
        //                    tpibTColl.LoadAll();
        //                    var PaymentNos = ((from s in tpibgTColl select s.PaymentNo)
        //                        .Union(from s in tpibTColl select s.PaymentNo)).Distinct();
        //                    if (PaymentNos.Count() > 0)
        //                    {
        //                        tpiT.InnerJoin(tpT).On(tpT.PaymentNo == tpiT.PaymentNo)
        //                            .Where(
        //                                tpT.IsApproved == true,
        //                                tpT.PaymentNo.In(PaymentNos),
        //                                tpT.PaymentNo != tp.PaymentNo)
        //                            .Select(tpiT);
        //                        tpiTColl.Load(tpiT);
        //                        paidTrans += tpiTColl.Sum(x => x.Amount.Value - x.RoundingAmount.Value);
        //                    }
        //                    // end of ambil total payment intermbil yang bersangkutan
        //                }

        //                decimal tmpVal = 0;
        //                var maxTmpVal = (Abs(paidTrans) >= Abs(transCurrentIB)) ? 0 : (transCurrentIB - paidTrans);

        //                var PayCurrentWithRound = PayCurrent - PayCurrentBalance - PayCurrentRound;
        //                maxTmpVal = ((Abs(maxTmpVal) - Abs(PayCurrentWithRound)) > 0) ? PayCurrentWithRound : maxTmpVal;
        //                var overPay = Abs(PayCurrentWithRound) > Abs(maxTmpVal) ? (PayCurrentWithRound - maxTmpVal) : 0;

        //                var firstJ = paidTrans == 0;
        //                if (firstJ)
        //                {
        //                    //////tmpVal = transCurrentIB - paidTrans - PayCurrentWithRound;
        //                    //////var currTmpVal = tmpVal;
        //                    //////if (Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal;
        //                    //////if (Abs(tmpVal) < 0) currTmpVal = maxTmpVal;// lebih bayar

        //                    maxTmpVal -= adminGuarantor;

        //                    // jurnal temporary
        //                    if (maxTmpVal != 0)
        //                    {
        //                        JournalTransactionDetails x = new JournalTransactionDetails();
        //                        x.AddNew();
        //                        x.JournalId = entity.JournalId;
        //                        x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
        //                        x.SubLedgerId = 0;//sl_contemporary;
        //                        x.Debit = (maxTmpVal < 0) ? (maxTmpVal * -1) : 0;
        //                        x.Credit = (maxTmpVal > 0) ? maxTmpVal : 0;
        //                        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                        x.DocumentNumber = tp.PaymentNo;

        //                        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);
        //                        x.Save();

        //                        totalDebit += x.Debit.Value;
        //                        totalCredit += x.Credit.Value;
        //                    }
        //                }
        //                else
        //                {
        //                    //// pembayaran kedua / split bayar kedua
        //                    //tmpVal = PayCurrentWithRound;
        //                    //var currTmpVal = tmpVal;
        //                    //if (Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal;
        //                    //if (Abs(tmpVal) < 0) currTmpVal = maxTmpVal;// lebih bayar
        //                    // jurnal temporary
        //                    if (maxTmpVal != 0)
        //                    {
        //                        JournalTransactionDetails x = new JournalTransactionDetails();
        //                        x.AddNew();
        //                        x.JournalId = entity.JournalId;
        //                        x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
        //                        x.SubLedgerId = 0;//sl_contemporary;
        //                        x.Debit = (maxTmpVal < 0) ? (maxTmpVal * -1) : 0;
        //                        x.Credit = (maxTmpVal > 0) ? maxTmpVal : 0;
        //                        x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                        x.DocumentNumber = tp.PaymentNo;

        //                        AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                            null, string.Empty, string.Empty, tp.RegistrationNo);
        //                        x.Save();

        //                        totalDebit += x.Debit.Value;
        //                        totalCredit += x.Credit.Value;
        //                    }
        //                }

        //                if (overPay > 0)
        //                {
        //                    // ambil subledger
        //                    var slColl = new SubLedgersCollection();
        //                    slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
        //                    if (slColl.LoadAll())
        //                    {

        //                    }

        //                    JournalTransactionDetails xo = new JournalTransactionDetails();
        //                    xo.AddNew();
        //                    xo.JournalId = entity.JournalId;
        //                    xo.ChartOfAccountId = ValidateCOA(coa_overPayment, coaColl, string.Format(
        //                        "Master Guarantor: {0}: COA: COA Exccess Payment / Discount (A/R)", grn.GuarantorName));
        //                    xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
        //                    xo.Debit = (overPay < 0) ? (overPay * -1) : 0;
        //                    xo.Credit = (overPay > 0) ? overPay : 0;
        //                    xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                    xo.DocumentNumber = tp.PaymentNo;

        //                    AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                        null, string.Empty, string.Empty, tp.RegistrationNo);
        //                    xo.Save();

        //                    totalDebit += xo.Debit.Value;
        //                    totalCredit += xo.Credit.Value;
        //                }
        //            }

        //            // COB
        //            if (cc.Count == 0 && dtb.Rows.Count == 0)
        //            {
        //                var currTmpVal = tpItems.Sum(tpi => (tpi.Amount ?? 0) - (tpi.Balance ?? 0) - (tpi.RoundingAmount ?? 0));

        //                if (currTmpVal != 0)
        //                {
        //                    JournalTransactionDetails x = new JournalTransactionDetails();
        //                    x.AddNew();
        //                    x.JournalId = entity.JournalId;
        //                    x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
        //                    x.SubLedgerId = 0;//sl_contemporary;
        //                    x.Debit = (currTmpVal < 0) ? (currTmpVal * -1) : 0;
        //                    x.Credit = (currTmpVal > 0) ? currTmpVal : 0;
        //                    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                    x.DocumentNumber = tp.PaymentNo;

        //                    AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                        null, string.Empty, string.Empty, tp.RegistrationNo);
        //                    x.Save();

        //                    totalDebit += x.Debit.Value;
        //                    totalCredit += x.Credit.Value;
        //                }
        //            }

        //            if (cc.Count > 0)
        //            {
        //                if (transCurrent != 0)
        //                {
        //                    JournalTransactionDetails x = new JournalTransactionDetails();
        //                    x.AddNew();
        //                    x.JournalId = entity.JournalId;
        //                    x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
        //                    x.SubLedgerId = 0;//sl_contemporary;
        //                    x.Debit = (transCurrent < 0) ? (transCurrent * -1) : 0;
        //                    x.Credit = (transCurrent > 0) ? transCurrent : 0;
        //                    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
        //                    x.DocumentNumber = tp.PaymentNo;

        //                    AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
        //                        null, string.Empty, string.Empty, tp.RegistrationNo);
        //                    x.Save();

        //                    totalDebit += x.Debit.Value;
        //                    totalCredit += x.Credit.Value;
        //                }
        //            }

        //            if (totalCredit != totalDebit && pkg.Sum(x => x.PackageAmount) != pkg.Sum(x => x.PackageDetailAmount))
        //            {
        //                string errMsg = "Different package price:";
        //                var items = new ItemCollection();
        //                items.Query.Where(items.Query.ItemID.In(pkg.Select(p => p.ItemID)));
        //                items.LoadAll();

        //                foreach (var x in pkg.Where(p => p.PackageAmount != p.PackageDetailAmount))
        //                {
        //                    errMsg += string.Format("TransNo: {0} {3}, Package Price: {1:n2}, Detail Package Price: {2:n2}",
        //                        x.TransactionNo, x.PackageAmount, x.PackageDetailAmount,
        //                        items.Where(z => z.ItemID == x.ItemID).Select(z => z.ItemName).FirstOrDefault());
        //                }
        //                throw new Exception(errMsg);
        //            }
        //        }

        //        if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
        //        {
        //            if (/*(totalCredit > 0 && totalDebit > 0) &&*/ (totalDebit == totalCredit))
        //            {
        //                entity.BeginEdit();
        //                entity.IsPosted = true;
        //                entity.EndEdit();
        //                entity.Save();
        //            }

        //            // insert cash transaction here
        //            var cashID = AutoCashEntryOnPaymentReceive(tp, tpItems, entity, editedBy);
        //        }
        //        return entity.JournalId;
        //    }

        //    catch (Exception ex)
        //    {
        //        //Logger.LogException(ex);
        //        JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
        //    }
        //    return journalId;
        //}

        public static int? AddNewPatientPaymentReceiveAccrualProporsi_NoTemp(string journalType, TransPayment tp, Registration reg, TransPaymentItemCollection tpItems, string prefix, string RefNo, string editedBy, int journalId)
        {
            //payment received
            if (!IsAutoJournalEnabled())
                return 0;

            //Logger.EnterMethod("AddNewPaymentJournal");
            try
            {
                bool newJournal = journalId == 0;
                //Logger.LogMessage(string.Format("Create Journal Header for TransNo={0}", tp.PaymentNo));

                //var CoaColl = new ChartOfAccountsCollection();
                var regType = reg.SRRegistrationType;

                string guarID = string.IsNullOrEmpty(tp.GuarantorID) ? reg.GuarantorID : tp.GuarantorID;
                var grn = new Guarantor();
                grn.LoadByPrimaryKey(guarID);

                var sSelfGuarantorID = "SELF";
                var self = new AppParameter();
                self.LoadByPrimaryKey("SelfGuarantorID");
                sSelfGuarantorID = self.ParameterValue;

                if (regType != "EMR")
                {
                    var merge = new MergeBilling();
                    if (merge.LoadByPrimaryKey(reg.RegistrationNo) && !string.IsNullOrEmpty(merge.FromRegistrationNo))
                    {
                        var r = new Registration();
                        r.LoadByPrimaryKey(merge.FromRegistrationNo);
                        regType = r.SRRegistrationType;
                    }
                }
                if (regType == "MCU")
                    regType = "OPR";

                Patient pEnity = new Patient();
                pEnity.LoadByPrimaryKey(reg.PatientID);

                var keterangan = (journalType == "07") ? "PAYMENT RETURN" : "PAYMENT";

                //Journal Header
                JournalTransactions entity = new JournalTransactions();

                // cegah double jurnal
                if (journalId == 0)
                {
                    entity.Query.Where(entity.Query.RefferenceNumber == RefNo, entity.Query.JournalIdRefference.IsNull());
                    entity.Query.es.Top = 1;
                    if (entity.Load(entity.Query))
                    {
                        journalId = entity.JournalId.Value;
                    }
                }

                entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                    entity.IsVoid = false;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(prefix, tp.PaymentDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = tp.PaymentDate;
                    entity.Description = string.Format("{2} REG#:{0}. PAT#:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    if (journalType == BusinessObject.JournalType.ARCreating)
                    {
                        if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                        {
                            entity.Description = string.Format("{0} SUP#:{1}", entity.Description, grn.GuarantorName);
                        }
                    }
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = tp.PaymentNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();
                bool IsProrataToRevenue = (grn.IsDiscountProrataToRevenue ?? false);

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal PayCurrent = 0;
                decimal PayCurrentRound = 0;
                decimal PayCurrentBalance = 0;
                decimal adminGuarantor = 0;

                DataTable dtbl = new DataTable();
                dtbl.Columns.Add("coaId", typeof(int));
                dtbl.Columns.Add("subledgerId", typeof(int));
                dtbl.Columns.Add("balance", Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", Type.GetType("System.Decimal"));

                keterangan = (journalType == "07") ? "RETURN" : "";

                var lastRow = tpItems.OrderByDescending(t => t.SequenceNo).Take(1).SingleOrDefault();

                var stdDR = new AppStandardReferenceItemCollection();
                stdDR.Query.Where(stdDR.Query.StandardReferenceID == "DiscountReason");
                stdDR.LoadAll();

                foreach (var p in tpItems)
                {
                    string payMethode = p.SRPaymentMethod;
                    string payType = p.SRPaymentType;
                    bool isCardPayment = false;

                    PaymentType pt = new PaymentType();
                    if (!pt.LoadByPrimaryKey(payType))
                        continue;

                    int dAccount = (pt.ChartOfAccountID.HasValue ? pt.ChartOfAccountID.Value : 0);
                    string dAccountMsg = string.Empty;
                    int dSubledgerId = (pt.SubledgerID.HasValue ? pt.SubledgerID.Value : 0);
                    int cAccount = 0;

                    PaymentMethod pm = new PaymentMethod();
                    if (!pm.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pt.SRPaymentTypeID.Equals("PaymentType-001"))
                            continue;
                    }

                    if (pm.ChartOfAccountID.HasValue)
                    {
                        dAccount = pm.ChartOfAccountID.Value;
                        dSubledgerId = (pm.SubledgerID.HasValue ? pm.SubledgerID.Value : 0);
                        dAccountMsg = string.Format("Payment Method: {0}", pm.PaymentMethodName);
                    }

                    // if appstdref of discount reason has coa
                    string DiscountReason = string.Empty;
                    if (!string.IsNullOrEmpty(p.SRDiscountReason) && p.SRPaymentType == "PaymentType-005")
                    {
                        var sDiscReason = stdDR.Where(std => std.ItemID == p.SRDiscountReason);
                        if (sDiscReason.Count() > 0)
                        {
                            var dsc = sDiscReason.First();
                            DiscountReason = dsc.ItemName;
                            dAccountMsg = string.Format("Discount Reason: {0}", dsc.ItemName);
                            if ((dsc.coaID ?? 0) != 0)
                            {
                                dAccount = dsc.coaID.Value;
                                dSubledgerId = dsc.subledgerID ?? 0;
                            }
                        }
                    }

                    if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002") || pt.SRPaymentTypeID.Equals("PaymentType-005"))
                    {
                        //transfer
                        if (p.SRPaymentMethod.Equals("PaymentMethod-004"))
                        {
                            bool skipBank = false;
                            if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaCashierPaymentTransferFromPaymentMethod))
                            {
                                // 
                                try
                                {
                                    ValidateCOA(pm.ChartOfAccountID, coaColl);
                                    skipBank = true;
                                }
                                catch (Exception ex)
                                {

                                }
                            }
                            if (!skipBank)
                            {
                                Bank bank = new Bank();
                                if (bank.LoadByPrimaryKey(p.BankID))
                                {
                                    if (bank.ChartOfAccountId.HasValue)
                                        dAccount = bank.ChartOfAccountId.Value;
                                    if (bank.SubledgerId.HasValue)
                                        dSubledgerId = bank.SubledgerId.Value;
                                    dAccountMsg = string.Format("Bank: {0}", bank.BankName);
                                }
                            }
                        }
                    }

                    if (p.IsFromDownPayment.Value)
                    {
                        // amount that we receive from the payment
                        //if (p.Amount.Value != 0)
                        //{
                        //    int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                        //    // int cAccount_off = GetCachedAccountFromParam("coa_AccrualIncome");




                        //    JournalTransactionDetails d = new JournalTransactionDetails();
                        //    d.AddNew();
                        //    d.JournalId = entity.JournalId;
                        //    d.ChartOfAccountId = dAccount_off;
                        //    d.SubLedgerId = 0;
                        //    d.Debit = Abs(p.Amount + p.Balance ?? 0);
                        //    d.Credit = 0;
                        //    d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan, 
                        //        (DiscountReason.Length > 0 ? " ":"") + DiscountReason);
                        //    d.DocumentNumber = tp.PaymentNo;
                        //    d.Save();

                        //    totalDebit += d.Debit.Value;
                        //}

                        // start uang muka
                        // perlu dicari ini uang muka dari payment registrasi yang mana supaya 
                        // pas tarik ledger bisa direkon, harus pecah per noreg
                        int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                        var dpdt = new TransPaymentItemQuery("a");
                        var dphd = new TransPaymentQuery("b");

                        dpdt.InnerJoin(dphd).On(dpdt.PaymentNo == dphd.PaymentNo)
                            .Where(dphd.PaymentReferenceNo == p.PaymentNo,
                                dphd.IsApproved == true,
                                dphd.IsVoid == false,
                                dphd.TransactionCode == "018")
                            .OrderBy(dphd.RegistrationNo.Descending, dphd.PaymentNo.Ascending)
                            .Select(dphd.RegistrationNo, dphd.PaymentNo, dpdt.Amount, dpdt.Balance);
                        DataTable dtpay = dpdt.LoadDataTable();
                        decimal sumAmount = 0;
                        for (int i = 0; i < dtpay.Rows.Count; i++)
                        {
                            sumAmount += (decimal)(dtpay.Rows[i]["Amount"] ?? 0) + (decimal)(dtpay.Rows[i]["Balance"] ?? 0);
                            if (dtpay.Rows[i]["RegistrationNo"].ToString() !=
                                ((i + 1 == dtpay.Rows.Count) ? "" : dtpay.Rows[i + 1]["RegistrationNo"].ToString()))
                            {
                                // this is the last row or last current reg, do save
                                JournalTransactionDetails d = new JournalTransactionDetails();
                                d.AddNew();
                                d.JournalId = entity.JournalId;
                                d.ChartOfAccountId = ValidateCOA(dAccount_off, coaColl, "App Parameter: coa_DownPayment");
                                d.SubLedgerId = 0;

                                // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                d.Debit = (sumAmount > 0) ? sumAmount : 0;
                                d.Credit = (sumAmount < 0) ? (sumAmount * -1) : 0;
                                // end of modif teguh s 2016 06 02

                                d.Description = string.Format("{2} REG#:{0}. PAT#:{1}.{3}", dtpay.Rows[i]["RegistrationNo"].ToString(), pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                                    (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                                d.DocumentNumber = tp.PaymentNo;
                                d.DocumentNumberSequenceNo = p.SequenceNo;

                                AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                                d.Save();

                                totalDebit += d.Debit.Value;
                                totalCredit += d.Credit.Value;
                                PayCurrent += sumAmount;
                                sumAmount = 0;
                            }
                        }
                        // end uang muka

                        if (p.Balance.Value != 0) //payment return
                        {
                            //int dAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            //Modif By Hermawan
                            //int cAccount_off = dAccount;
                            //int cAccount_off = GetCachedAccountFromParam("coa_DownPayment");
                            int cAccount_off = GetCachedAccountFromParam("coa_DownPaymentReturn");
                            int cAccountPayable_off = GetCachedAccountFromParam("coa_DownPaymentReturnPayable");

                            ////-------------- ini dulunya kenapa diremark?
                            //JournalTransactionDetails d = new JournalTransactionDetails();
                            //d.AddNew();
                            //d.JournalId = entity.JournalId;
                            //d.ChartOfAccountId = dAccount_off;
                            //d.SubLedgerId = 0;
                            //d.Debit = Abs(p.Balance);
                            //d.Credit = 0;
                            //d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            //d.DocumentNumber = tp.PaymentNo;
                            //d.Save();

                            //totalDebit += d.Debit.Value;
                            ////-------------------------------------

                            JournalTransactionDetails c = new JournalTransactionDetails();
                            c.AddNew();
                            c.JournalId = entity.JournalId;
                            if (p.IsBackOfficeReturn ?? false)
                                c.ChartOfAccountId = ValidateCOA(cAccountPayable_off, coaColl, "App Parameter: coa_DownPaymentReturnPayable");
                            else
                                c.ChartOfAccountId = ValidateCOA(cAccount_off, coaColl, "App Parameter: coa_DownPaymentReturn");
                            c.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            c.Debit = (p.Balance < 0) ? (p.Balance * -1) : 0;
                            c.Credit = (p.Balance > 0) ? p.Balance : 0;
                            // end of modif teguh s 2016 06 02

                            c.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            c.DocumentNumber = tp.PaymentNo;
                            c.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(c, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                            c.Save();

                            totalDebit += c.Debit.Value;
                            totalCredit += c.Credit.Value;
                            PayCurrentBalance += p.Balance.Value;
                        }
                    }
                    else
                    {
                        cAccount = GetCachedAccountFromParam("coa_AccrualIncome");
                        if (journalType.Equals(BusinessObject.JournalType.DownPayment))
                        {
                            cAccount = GetCachedAccountFromParam("coa_DownPayment");
                        }

                        // piutang instansi || piutang personal
                        if (pt.SRPaymentTypeID.Equals("PaymentType-004") || pt.SRPaymentTypeID.Equals("PaymentType-003"))
                        {
                            Guarantor guarantorEntity = new Guarantor();
                            if (guarantorEntity.LoadByPrimaryKey(tp.GuarantorID))
                            {
                                var IsSplitIprOpr = AppParameter.IsYes(AppParameter.ParameterItem.acc_IsCoaInvoiceGuarantorSplitIprOpr);
                                //var coaInv = IsSplitIprOpr ? guarantorEntity.ChartOfAccountId : ();
                                //if (guarantorEntity.ChartOfAccountId.HasValue)
                                //{
                                var PrmUsingInvoicing = new AppParameter();
                                if (!PrmUsingInvoicing.LoadByPrimaryKey("acc_IsJournalArUsingInvoicing"))
                                {
                                    throw new Exception("Parameter acc_IsJournalArUsingInvoicing not yet configured!");
                                }
                                if (PrmUsingInvoicing.ParameterValue == "Yes")
                                {
                                    AppParameter app = new AppParameter();
                                    app.LoadByPrimaryKey("HealthcareInitialAppsVersion");
                                    if (app.ParameterValue == "RSALMAH" || app.ParameterValue == "RSUTAMA")
                                    {
                                        /* 
                                         * RSALMAH dan RSUTAMA sudah terlajur jalan, jika mau disamakan harus buat script
                                         * untuk swap ChartOfAccountIdTemporary ke ChartOfAccountId berikut juga subledgernya,
                                         * dan pastikan jika script dijalankan lebih dari 1x maka script tidak melakukan swap lagi
                                         * kalau bingung tanya teguh s
                                         */
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process)", guarantorEntity.GuarantorName);
                                    }
                                    else
                                    {
                                        dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdTemporaryIPR ?? 0) : (guarantorEntity.ChartOfAccountIdTemporary ?? 0);
                                        dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubledgerIdTemporaryIPR ?? 0) : (guarantorEntity.SubledgerIdTemporary ?? 0);
                                        dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Invoice)", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                    }
                                }
                                else
                                {
                                    dAccount = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.ChartOfAccountIdIPR ?? 0) : (guarantorEntity.ChartOfAccountId ?? 0);
                                    dSubledgerId = (IsSplitIprOpr && (regType == "IPR")) ? (guarantorEntity.SubLedgerIdIPR ?? 0) : (guarantorEntity.SubLedgerId ?? 0);
                                    dAccountMsg = string.Format("Guarantor: {0}: COA (A/R Process){1}", guarantorEntity.GuarantorName, (IsSplitIprOpr ? (regType == "IPR" ? " - IPR" : " - OPR") : ""));
                                }
                                //}
                            }
                        }

                        if (pt.SRPaymentTypeID.Equals("PaymentType-001") || pt.SRPaymentTypeID.Equals("PaymentType-002"))
                        {
                            // Payment Credit Card || Payment Debit Card 
                            if (pm.SRPaymentMethodID.Equals("PaymentMethod-002") || pm.SRPaymentMethodID.Equals("PaymentMethod-003"))
                            {
                                isCardPayment = true;
                                EDCMachine edcMachineEntity = new EDCMachine();
                                if (edcMachineEntity.LoadByPrimaryKey(p.EDCMachineID))
                                {
                                    // Setting Account Code Per EDC Machine
                                    if (edcMachineEntity.ChartOfAccountID.HasValue)
                                    {
                                        dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                        dSubledgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);
                                        dAccountMsg = string.Format("EDC Machine: {0}", edcMachineEntity.EDCMachineName);
                                    }
                                }
                            }
                        }

                        if (IsProrataToRevenue && pt.SRPaymentTypeID.Equals("PaymentType-005"))
                        {
                            var jtdColl = GetNewIncomeAdjustProrataCashBased(entity, tp.PaymentNo, p.Amount ?? 0, "", coaColl);
                            jtdColl.Save();
                            totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                            totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                        }
                        else
                        {
                            //Logger.LogMessage(string.Format("Creating CASH/DP payment Journal for :{0}. (C)", p.PaymentNo));
                            JournalTransactionDetails d = new JournalTransactionDetails();
                            d.AddNew();
                            d.JournalId = entity.JournalId;
                            d.ChartOfAccountId = ValidateCOA(dAccount, coaColl, dAccountMsg);
                            d.SubLedgerId = dSubledgerId;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            d.Debit = (p.Amount > 0) ? p.Amount : 0;
                            d.Credit = (p.Amount < 0) ? (p.Amount * -1) : 0;
                            // end of modif teguh s 2016 06 02

                            d.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan,
                                (DiscountReason.Length > 0 ? " " : "") + DiscountReason);
                            if (journalType == BusinessObject.JournalType.ARCreating)
                            {
                                if (!string.Equals(tp.GuarantorID, sSelfGuarantorID))
                                {
                                    d.Description = string.Format("{0} SUP#:{1}", d.Description, grn.GuarantorName);
                                }
                            }
                            d.DocumentNumber = tp.PaymentNo;
                            d.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(d, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        PayCurrent += p.Amount.Value;

                    }
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.IsSeparatedRounding) == "Yes")
                    {
                        if ((p.RoundingAmount ?? 0) > 0)
                        {
                            // no rounding for card payment, (payment bugs escape)
                            //if (!isCardPayment)
                            //{
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entity.JournalId;
                            k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
                            k.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                            k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                            // end of modif teguh s 2016 06 02

                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                            k.Save();

                            totalDebit += k.Debit.Value;
                            totalCredit += k.Credit.Value;

                            PayCurrentRound += (p.RoundingAmount ?? 0);
                            //}
                        }
                        if ((p.RoundingAmount ?? 0) < 0)
                        {
                            // no rounding for card payment, (payment bugs escape)
                            //if (!isCardPayment)
                            //{
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmountMin");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entity.JournalId;
                            k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmountMin");
                            k.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                            k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                            // end of modif teguh s 2016 06 02

                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                            k.Save();

                            totalDebit += k.Debit.Value;
                            totalCredit += k.Credit.Value;

                            PayCurrentRound += (p.RoundingAmount ?? 0);
                            //}
                        }
                    }
                    else
                    {
                        if ((p.RoundingAmount ?? 0) != 0)
                        {
                            // no rounding for card payment, (payment bugs escape)
                            //if (!isCardPayment)
                            //{
                            int roundAmt = GetCachedAccountFromParam("coa_PaymentRoundingAmount");
                            JournalTransactionDetails k = new JournalTransactionDetails();
                            k.AddNew();
                            k.JournalId = entity.JournalId;
                            k.ChartOfAccountId = ValidateCOA(roundAmt, coaColl, "App Parameter: coa_PaymentRoundingAmount");
                            k.SubLedgerId = 0;

                            // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                            k.Debit = (p.RoundingAmount < 0) ? (p.RoundingAmount * -1) : 0;
                            k.Credit = (p.RoundingAmount > 0) ? p.RoundingAmount : 0;
                            // end of modif teguh s 2016 06 02

                            k.Description = string.Format("{2} ROUNDING AMOUNT REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            k.DocumentNumber = tp.PaymentNo;
                            k.DocumentNumberSequenceNo = p.SequenceNo;

                            AddMoreInfo(k, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                        null, string.Empty, string.Empty, tp.RegistrationNo);

                            k.Save();

                            totalDebit += k.Debit.Value;
                            totalCredit += k.Credit.Value;

                            PayCurrentRound += (p.RoundingAmount ?? 0);
                            //}
                        }
                    }
                    // ADM pindah kebawah

                    // if there is CC fee
                    if (p.CardFeeAmount > 0)
                    {
                        // debit
                        JournalTransactionDetails dFee = new JournalTransactionDetails();
                        dFee.AddNew();
                        dFee.JournalId = entity.JournalId;
                        dFee.ChartOfAccountId = dAccount;
                        dFee.SubLedgerId = 0;
                        dFee.Debit = Abs(p.CardFeeAmount);
                        dFee.Credit = 0;
                        dFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        dFee.DocumentNumber = tp.PaymentNo;
                        dFee.DocumentNumberSequenceNo = p.SequenceNo;

                        dFee.GuarantorID = grn.GuarantorID;
                        dFee.Save();

                        totalDebit += dFee.Debit.Value;

                        // credit
                        JournalTransactionDetails cFee = new JournalTransactionDetails();
                        cFee.AddNew();
                        cFee.JournalId = entity.JournalId;
                        cFee.ChartOfAccountId = ValidateCOA(GetCachedAccountFromParam("coa_PaymentCardFeeAmt"), coaColl, "AppParameter:coa_PaymentCardFeeAmt");
                        cFee.SubLedgerId = 0;
                        cFee.Debit = 0;
                        cFee.Credit = Abs(p.CardFeeAmount);
                        cFee.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                        cFee.DocumentNumber = tp.PaymentNo;
                        cFee.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(cFee, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);

                        cFee.Save();

                        totalCredit += cFee.Credit.Value;
                    }
                }

                /* start hitung jurnal pendapatan */
                DataTable dtb;
                decimal transCurrent = 0, transCurrentIB = 0;

                List<PackageJournal> pkg = new List<PackageJournal>();

                var a = new TransPaymentItemIntermBillQuery();
                a.Where(a.PaymentNo == RefNo);
                dtb = a.LoadDataTable();
                if (dtb.Rows.Count == 0)
                {
                    var b = new TransPaymentItemIntermBillGuarantorQuery();
                    b.Where(b.PaymentNo == RefNo);
                    dtb = new DataTable();
                    dtb = b.LoadDataTable();
                }

                var cc = new TransPaymentItemOrderCollection();
                cc.Query.Where(cc.Query.PaymentNo == RefNo);
                cc.LoadAll();

                var jtdActualColl = new JournalTransactionDetailsCollection();
                var trNoSeqNo = new List<Tuple<string, string>>();
                var trNoSeqNoDetailPkg = new List<Tuple<string, string>>();

                foreach (var row in cc)
                {
                    trNoSeqNo.Add(new Tuple<string, string>(row.TransactionNo, row.SequenceNo));

                    var prs = new TransPrescriptionItem();
                    if (prs.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                        transCurrent += prs.LineAmount.Value;
                    else
                        transCurrent += row.Qty.Value * row.Price.Value;

                    //harus dihitung ulang jurnal pendapatan dan diskon karena diskon dari verifikasi billing tidak ada jurnal khusus 
                    var TransC = new TransCharges();
                    if (TransC.LoadByPrimaryKey(row.TransactionNo))
                    {
                        var transCI = new TransChargesItem();
                        if (transCI.LoadByPrimaryKey(row.TransactionNo, row.SequenceNo))
                        {
                            var cCalc = new CostCalculation();
                            if (cCalc.LoadByPrimaryKey(TransC.RegistrationNo, row.TransactionNo, row.SequenceNo))
                            {
                                /* start journal*/
                                var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
                                if (jtdColl.Count > 0)
                                {
                                    trNoSeqNoDetailPkg.AddRange(jtdColl.Where(j =>
                                        !trNoSeqNo.Contains(new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo)) &&
                                        (!string.IsNullOrEmpty(j.DocumentNumber)) &&
                                        (!string.IsNullOrEmpty(j.DocumentNumberSequenceNo))
                                    ).Select(j => new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo))
                                    .Distinct());
                                }
                                jtdActualColl.Combine(jtdColl);
                                /* end journal */
                            }
                            else
                            {
                                cCalc = new CostCalculation();
                                cCalc.RegistrationNo = TransC.RegistrationNo;
                                cCalc.TransactionNo = row.TransactionNo;
                                cCalc.SequenceNo = row.SequenceNo;
                                cCalc.ItemID = row.ItemID;
                                cCalc.PatientAmount = transCI.ChargeQuantity * (transCI.Price - (transCI.DiscountAmount / (transCI.ChargeQuantity == 0 ? 1 : transCI.ChargeQuantity)));
                                cCalc.GuarantorAmount = 0;
                                cCalc.DiscountAmount = transCI.DiscountAmount;

                                /* start journal*/
                                var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, transCI.ChargeQuantity ?? 0, coaColl);
                                if (jtdColl.Count > 0)
                                {
                                    trNoSeqNoDetailPkg.AddRange(jtdColl.Where(j =>
                                        !trNoSeqNo.Contains(new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo)) &&
                                        (!string.IsNullOrEmpty(j.DocumentNumber)) &&
                                        (!string.IsNullOrEmpty(j.DocumentNumberSequenceNo))
                                    ).Select(j => new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo))
                                    .Distinct());
                                }
                                jtdActualColl.Combine(jtdColl);
                                /* end journal */
                            }
                        }
                    }
                    //precription
                    else
                    {
                        var transPresc = new TransPrescription();
                        transPresc.LoadByPrimaryKey(row.TransactionNo);

                        var cCalc = new CostCalculation();
                        if (cCalc.LoadByPrimaryKey(transPresc.RegistrationNo, row.TransactionNo, row.SequenceNo))
                        {
                            trNoSeqNo.Add(new Tuple<string, string>(cCalc.TransactionNo, cCalc.SequenceNo));
                            /* start journal*/
                            var jtdColl = GetNewIncomeJournalCashBased(entity, cCalc, false, 0, coaColl);
                            jtdActualColl.Combine(jtdColl);
                            /* end journal */
                        }
                    }
                }

                //decimal TIntermbill = 0, TPayment = 0;
                if (dtb.Rows.Count > 0)
                {
                    foreach (DataRow row in dtb.Rows)
                    {
                        var q = new IntermBillCollection();
                        q.Query.Where(
                            q.Query.IntermBillNo == row["intermBillNo"],
                            q.Query.Or(
                                q.Query.JournalIncomePaymentNo == string.Empty,
                                q.Query.JournalIncomePaymentNo == RefNo
                                )
                            );
                        //q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"], q.Query.JournalIncomePaymentNo == RefNo);
                        //q.Query.Where(q.Query.IntermBillNo == row["intermBillNo"]);
                        q.LoadAll();

                        var ibq = new IntermBillQuery("ibq");
                        var tp2 = new TransPaymentQuery("tp2");
                        ibq.LeftJoin(tp2).On(ibq.JournalIncomePaymentNo == tp2.PaymentNo && tp2.IsVoid == false);
                        ibq.Where(
                            ibq.IntermBillNo == row["intermBillNo"],
                            ibq.Or(
                                "<ISNULL(tp2.PaymentNo,'') = '' OR >",
                                ibq.JournalIncomePaymentNo == RefNo
                                )
                            );
                        ibq.Select(ibq);
                        ibq.es.Distinct = true;
                        q.Load(ibq);

                        foreach (var x in q)
                        {
                            x.JournalIncomePaymentNo = RefNo;
                            q.Save();

                            // ======
                            var costColl = new CostCalculationCollection();

                            costColl.Query.Where(
                                costColl.Query.IntermBillNo == x.IntermBillNo
                                );
                            costColl.Query.OrderBy(
                                costColl.Query.RegistrationNo.Ascending,
                                costColl.Query.TransactionNo.Ascending,
                                costColl.Query.SequenceNo.Ascending
                                );

                            costColl.LoadAll();
                            foreach (var cost in costColl)
                            {
                                trNoSeqNo.Add(new Tuple<string, string>(cost.TransactionNo, cost.SequenceNo));

                                var jtdColl = GetNewIncomeJournalCashBased(entity, cost, false, 0, coaColl);
                                if (jtdColl.Count > 0)
                                {
                                    trNoSeqNoDetailPkg.AddRange(jtdColl.Where(j =>
                                        !trNoSeqNo.Contains(new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo)) &&
                                        (!string.IsNullOrEmpty(j.DocumentNumber)) &&
                                        (!string.IsNullOrEmpty(j.DocumentNumberSequenceNo))
                                    ).Select(j => new Tuple<string, string>(j.DocumentNumber, j.DocumentNumberSequenceNo))
                                    .Distinct());
                                }


                                jtdActualColl.Combine(jtdColl);
                            }
                            // ======
                        }

                        // ambil total trnsaksi dari intermbill
                        var ibT = new IntermBill();
                        if (ibT.LoadByPrimaryKey(row["intermBillNo"].ToString()))
                        {
                            transCurrentIB += ibT.PatientAmount.Value + ibT.GuarantorAmount.Value +
                                ibT.AdministrationAmount.Value + ibT.GuarantorAdministrationAmount.Value -
                                ibT.DiscAdmPatient.Value - ibT.DiscAdmGuarantor.Value;
                        }
                    }
                }

                int coaPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
                if (trNoSeqNo.Count > 0)
                {
                    var regs = MergeBilling.GetMergeBillingByReg(reg.RegistrationNo);
                    var transNos = trNoSeqNo.Select(t => t.Item1).Distinct().ToList();

                    // load jurnal accru
                    var jadColl = new JournalTransactionDetailsCollection();
                    jadColl.LoadByRefNoForAccrual(transNos);
                    // load journal bill recal existing
                    var jbdColl = new JournalTransactionDetailsCollection();
                    jbdColl.LoadByRefNoBillRecalForAccrual(regs, transNos, DateTime.Now);
                    jadColl.Combine(jbdColl);

                    var trNoALL = trNoSeqNo.Union(trNoSeqNoDetailPkg);
                    foreach (var jad in jadColl)
                    {
                        if (!trNoALL.Any(ts => ts.Item1 == jad.DocumentNumber && ts.Item2 == jad.DocumentNumberSequenceNo) && !string.IsNullOrEmpty(jad.DocumentNumberSequenceNo))
                        {
                            jadColl.DetachEntity(jad); // detach from coll,
                        }
                        else
                        {
                            // reverse
                            jad.SwabDK();
                            //var credit = jad.Credit ?? 0;
                            //jad.Credit = jad.Debit;
                            //jad.Debit = credit;
                        }
                    }

                    jtdActualColl.MergeJournalRevenue(jadColl, entity, coaPatRec);
                    //foreach (var jad in jadColl)
                    //{
                    //    JournalTransactionDetails jd = null;
                    //    if (string.IsNullOrEmpty(jad.TariffComponentID))
                    //    {
                    //        // data lama gak ada data tariff componentid, atau jurnal obat alkes gak ada tariff componentid gpp masuk sini
                    //        jd = jtdActualColl.Where(j => j.ChartOfAccountId == jad.ChartOfAccountId &&
                    //            j.SubLedgerId == jad.SubLedgerId &&
                    //            j.DocumentNumber == jad.DocumentNumber &&
                    //            j.DocumentNumberSequenceNo == jad.DocumentNumberSequenceNo &&
                    //            j.ItemID == jad.ItemID // <-- diperlukan untuk item consumption
                    //        ).FirstOrDefault();
                    //    }
                    //    else
                    //    {
                    //        jd = jtdActualColl.Where(j => j.ChartOfAccountId == jad.ChartOfAccountId &&
                    //                j.SubLedgerId == jad.SubLedgerId &&
                    //                j.DocumentNumber == jad.DocumentNumber &&
                    //                j.DocumentNumberSequenceNo == jad.DocumentNumberSequenceNo &&
                    //                j.TariffComponentID == jad.TariffComponentID &&
                    //                j.ItemID == jad.ItemID // <-- diperlukan untuk item consumption
                    //            ).FirstOrDefault();
                    //    }

                    //    if (jd == null)
                    //    {
                    //        jadColl.DetachEntity(jad);
                    //        jad.AcceptChanges();
                    //        jad.MarkAllColumnsAsDirty(DataRowState.Added);
                    //        jad.JournalId = entity.JournalId;
                    //        jtdActualColl.AttachEntity(jad);
                    //    }
                    //    else
                    //    {
                    //        jd.Debit += jad.Debit.Value;
                    //        jd.Credit += jad.Credit.Value;
                    //    }
                    //}

                    //foreach (var jd in jtdActualColl)
                    //{
                    //    var amt = jd.Debit.Value - jd.Credit.Value;
                    //    jd.Debit = amt > 0 ? amt : 0;
                    //    jd.Credit = amt < 0 ? (amt * -1) : 0;

                    //    if (jd.ChartOfAccountId.Value == coaPatRec && jd.SubLedgerId == 0)
                    //    {
                    //        jtdActualColl.DetachEntity(jd);
                    //    }
                    //    else
                    //    if (jd.Debit.Value + jd.Credit.Value == 0)
                    //    {
                    //        jtdActualColl.DetachEntity(jd);
                    //    }
                    //}

                    var sDeb = jtdActualColl.Sum(jtd => jtd.Debit ?? 0);
                    var sCre = jtdActualColl.Sum(jtd => jtd.Credit ?? 0);
                    var sAmt = sDeb - sCre;
                    if (sAmt != 0)
                    {

                        JournalTransactionDetails pdp = jtdActualColl.AddNew();
                        pdp.JournalId = entity.JournalId;
                        pdp.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable");
                        pdp.SubLedgerId = 0;
                        pdp.Debit = (sAmt > 0) ? 0 : Abs(sAmt);
                        pdp.Credit = (sAmt > 0) ? sAmt : 0;
                        pdp.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, "Patient receivable correction");
                        pdp.DocumentNumber = tp.PaymentNo;
                        //cFee.DocumentNumberSequenceNo = p.SequenceNo;

                        AddMoreInfo(pdp, string.Empty, grn.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                    }

                    jtdActualColl.Save();
                    totalDebit += jtdActualColl.Sum(d => d.Debit.Value);
                    totalCredit += jtdActualColl.Sum(d => d.Credit.Value);
                }

                // ADM
                foreach (var p in tpItems)
                {
                    string[] intermBillNo = new string[0];

                    var a1 = new TransPaymentItemIntermBillCollection();
                    a1.Query.Where(a1.Query.PaymentNo == RefNo);
                    if (a1.Query.Load())
                    {
                        intermBillNo = new string[a1.Count];
                        for (int i = 0; i < a1.Count; i++)
                        {
                            intermBillNo.SetValue(a1[i].IntermBillNo, i);
                        }
                    }
                    else
                    {
                        var b1 = new TransPaymentItemIntermBillGuarantorCollection();
                        b1.Query.Where(b1.Query.PaymentNo == RefNo);
                        if (b1.Query.Load())
                        {
                            intermBillNo = new string[b1.Count];
                            for (int i = 0; i < b1.Count; i++)
                            {
                                intermBillNo.SetValue(b1[i].IntermBillNo, i);
                            }
                        }
                    }

                    foreach (string ib1 in intermBillNo)
                    {
                        var ib = new IntermBill();
                        ib.LoadByPrimaryKey(ib1);
                        if (string.IsNullOrEmpty(ib.JournalIncomePaymentNo) || ib.JournalIncomePaymentNo == RefNo)
                        {
                            // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                            //if (reg.AdministrationAmount > 0 && (journalType.Equals(BusinessObject.JournalType.Payment) || journalType.Equals(BusinessObject.JournalType.ARCreating)) && tp.RemainingAmount <= 0 && p.SequenceNo == lastRow.SequenceNo)
                            {
                                if (((ib.AdministrationAmount - ib.DiscAdmPatient) + (ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor)) != 0
                                    // jurnal utk biaya adm dari total billing (hanya utk tipe Payment, kalo DP tidak usah
                                    //if (reg.AdministrationAmount > 0 
                                    && (journalType.Equals(BusinessObject.JournalType.ARCreating) || journalType.Equals(BusinessObject.JournalType.Payment)) &&
                                    //tp.RemainingAmount <= 0 && 
                                    p.SequenceNo == lastRow.SequenceNo)
                                {
                                    var itemAdm = String.Empty;
                                    var CompID = String.Empty;
                                    AppParameter app = new AppParameter();
                                    if (app.LoadByPrimaryKey("coa_ItemIdBillingTotalAdmFee"))
                                        itemAdm = app.ParameterValue;
                                    Item item = new Item();
                                    item.Query.Where(item.Query.ItemID == itemAdm);
                                    if (!item.Query.Load())
                                    {
                                        throw new Exception("App Parameter: coa_ItemIdBillingTotalAdmFee: " + itemAdm + " is not a valid service");
                                    }


                                    //cari ComponentID utk biaya ini mau masuk ke component tariff yg mana
                                    AppParameter app2 = new AppParameter();
                                    if (app2.LoadByPrimaryKey("coa_CompIDForBillingAdm"))
                                        CompID = app2.ParameterValue;
                                    TariffComponent ic = new TariffComponent();
                                    ic.Query.Where(ic.Query.TariffComponentID == CompID);
                                    if (!ic.Query.Load())
                                    {
                                        throw new Exception("App Parameter: coa_CompIDForBillingAdm: " + CompID + " is not a valid tarif component");
                                    }

                                    var su = new ServiceUnit();
                                    if (su.LoadByPrimaryKey(reg.ServiceUnitID))
                                    { }

                                    ServiceUnitItemService itemService = new ServiceUnitItemService();
                                    itemService.Query.Where(itemService.Query.ServiceUnitID == reg.ServiceUnitID,
                                                            itemService.Query.ItemID == itemAdm);
                                    if (!itemService.Query.Load())
                                    {
                                        throw new Exception("Item " + item.ItemName + " has no mapping for service unit " + su.ServiceUnitName);
                                    }
                                    int? coaId = 0;
                                    int? subLedgerId = 0;

                                    var grr = new Guarantor();
                                    grr.LoadByPrimaryKey(reg.GuarantorID);

                                    ServiceUnitItemServiceCompMapping itemComp = new ServiceUnitItemServiceCompMapping();
                                    itemComp.Query.Where(itemComp.Query.ServiceUnitID == reg.ServiceUnitID,
                                                         itemComp.Query.ItemID == itemAdm,
                                                         itemComp.Query.TariffComponentID == CompID,
                                                         itemComp.Query.SRRegistrationType == regType,
                                                         itemComp.Query.SRGuarantorIncomeGroup == grr.SRGuarantorIncomeGroup);


                                    if (itemComp.Query.Load())
                                    {
                                        if (itemComp.ChartOfAccountIdIncome.HasValue && itemComp.ChartOfAccountIdIncome > 0)
                                        {
                                            coaId = itemComp.ChartOfAccountIdIncome;
                                            subLedgerId = itemComp.SubledgerIdIncome.HasValue ? itemComp.SubledgerIdIncome : 0;
                                        }
                                    }

                                    // kalau Rawat Inap
                                    if (reg.SRRegistrationType == "IPR")
                                    {
                                        ServiceUnitItemServiceClass itemClass = new ServiceUnitItemServiceClass();
                                        itemClass.Query.Where(itemClass.Query.ServiceUnitID == reg.ServiceUnitID, itemClass.Query.ItemID == itemAdm,
                                            itemClass.Query.ClassID == reg.ClassID, itemClass.Query.TariffComponentID == CompID);

                                        if (itemClass.Query.Load())
                                        {
                                            if (itemClass.ChartOfAccountIdIncome.HasValue && itemClass.ChartOfAccountIdIncome > 0)
                                            {
                                                coaId = itemClass.ChartOfAccountIdIncome.Value;
                                                subLedgerId = itemClass.SubledgerIdIncome.HasValue ? itemClass.SubledgerIdIncome : 0;
                                            }
                                        }
                                    }

                                    //adm pasien
                                    if ((ib.AdministrationAmount - ib.DiscAdmPatient) != 0)
                                    {
                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                        j.SubLedgerId = subLedgerId;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var admIB = (ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0);
                                        j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                        j.Credit = (admIB > 0) ? admIB : 0;
                                        // end of modif teguh s 2016 06 02

                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, su.ServiceUnitID, item.ItemID, tp.RegistrationNo);
                                        j.Save();

                                        totalDebit += j.Debit.Value;
                                        totalCredit += j.Credit.Value;
                                        adminGuarantor += Abs((ib.AdministrationAmount ?? 0) - (ib.DiscAdmPatient ?? 0));
                                        // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                        //transCurrent += j.Credit.Value - j.Debit.Value;
                                    }

                                    //adm guarantor
                                    if ((ib.GuarantorAdministrationAmount - ib.DiscAdmGuarantor) != 0)
                                    {
                                        JournalTransactionDetails j = new JournalTransactionDetails();
                                        j.AddNew();
                                        j.JournalId = entity.JournalId;
                                        j.ChartOfAccountId = ValidateCOA(coaId.Value, coaColl, "COA mapping: service unit " + su.ServiceUnitName + " Item " + item.ItemName + "");
                                        j.SubLedgerId = subLedgerId;

                                        // modif teguh s 2016 06 02, sedang dimonitor efeknya jadi bagaimana
                                        var admIB = (ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0);
                                        j.Debit = (admIB < 0) ? (admIB * -1) : 0;
                                        j.Credit = (admIB > 0) ? admIB : 0;
                                        // end of modif teguh s 2016 06 02

                                        j.Description = string.Format("{4} REG#:{0}. PAT#:{1}. ITEM:{2}-{3}", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, itemAdm, item.ItemName, keterangan);
                                        j.DocumentNumber = tp.PaymentNo;

                                        AddMoreInfo(j, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                            null, string.Empty, item.ItemID, tp.RegistrationNo);
                                        j.Save();

                                        totalDebit += j.Debit.Value;
                                        totalCredit += j.Credit.Value;
                                        adminGuarantor += Abs((ib.GuarantorAdministrationAmount ?? 0) - (ib.DiscAdmGuarantor ?? 0));
                                        // karena adm digeser kebawah maka harus ditambahkan ke totalintermbill
                                        //transCurrent += j.Credit.Value - j.Debit.Value;
                                    }
                                }
                            }
                        }
                    }
                }
                // End of ADM

                // item tambahan tpio
                var tpacColl = new TransPaymentAdditionalChargesCollection();
                tpacColl.Query.Where(tpacColl.Query.PaymentNo == tp.PaymentNo);
                if (tpacColl.LoadAll())
                {
                    var stdAddCharges = new AppStandardReferenceItemCollection();
                    stdAddCharges.LoadByStandardReferenceID("CafeAdditionalCharges");
                    foreach (var tpac in tpacColl)
                    {
                        var addCharge = stdAddCharges.Where(ad => ad.ItemID == tpac.SRCafeAdditionalCharges).FirstOrDefault();
                        if (addCharge == null)
                        {
                            throw new Exception(string.Format("StandardRef: CafeAdditionalCharges: item {0} not found in data master", tpac.SRCafeAdditionalCharges));
                        }
                        var jTpac = new JournalTransactionDetails();
                        jTpac.AddNew();
                        jTpac.JournalId = entity.JournalId;
                        jTpac.ChartOfAccountId = ValidateCOA(addCharge.coaID, coaColl, "StandardRef: CafeAdditionalCharges: {0}", addCharge.ItemName);
                        jTpac.SubLedgerId = 0;
                        jTpac.Debit = 0;
                        jTpac.Credit = tpac.ChargeAmount;
                        jTpac.Description = string.Format("REG#:{0}. PATIENT:{1}. {2}",
                            reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, addCharge.ItemName);
                        jTpac.DocumentNumber = tp.PaymentNo;

                        AddMoreInfo(jTpac, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, tp.RegistrationNo);
                        jTpac.Save();

                        totalDebit += jTpac.Debit.Value;
                        totalCredit += jTpac.Credit.Value;

                        transCurrent += jTpac.Credit.Value;
                    }
                }

                var SelisihPaket = pkg.Sum(x => x.PackageAmount) - pkg.Sum(x => x.PackageDetailAmount);

                //int coa_contemporary = GetCachedAccountFromParam("coa_ContemporaryPayment");
                int sl_contemporary = 0;
                var slregColl = new SubLedgersCollection();
                slregColl.Query.Where(slregColl.Query.SubLedgerName == reg.GuarantorID,
                    slregColl.Query.GroupId == AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdGuarantor));
                if (slregColl.LoadAll())
                {
                    sl_contemporary = slregColl.First().SubLedgerId ?? 0;
                }

                int coa_overPayment = grn.ChartOfAccountIdOverPayment ?? 0;
                int coa_overPaymentmin = grn.ChartOfAccountIdOverPaymentMin ?? 0;

                if (tp.IsVoid ?? false)
                {
                    // kalau payment void, seimbangkan saja jurnalnya
                    var dBal = totalCredit - totalDebit;

                    JournalTransactionDetails x = new JournalTransactionDetails();
                    x.AddNew();
                    x.JournalId = entity.JournalId;
                    x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                    x.SubLedgerId = 0;// sl_contemporary;
                    x.Debit = (dBal > 0) ? dBal : 0;
                    x.Credit = (dBal < 0) ? (dBal * -1) : 0;
                    x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                    x.DocumentNumber = tp.PaymentNo;

                    AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, tp.RegistrationNo);
                    x.Save();

                    totalDebit += x.Debit.Value;
                    totalCredit += x.Credit.Value;
                }
                else
                {
                    if (dtb.Rows.Count > 0)
                    {
                        decimal paidTrans = 0;

                        List<string> ibs = new List<string>();
                        foreach (DataRow row in dtb.Rows)
                        {
                            ibs.Add(row["intermBillNo"].ToString());
                        }

                        var ibColl = new IntermBillCollection();
                        ibColl.Query.Where(ibColl.Query.IntermBillNo.In(ibs), ibColl.Query.JournalIncomePaymentNo == tp.PaymentNo);
                        if (ibColl.LoadAll())
                        {
                            paidTrans = 0;
                        }
                        else
                        {
                            // ambil payment intermbil yang bersangkutan
                            var tpiTColl = new TransPaymentItemCollection();
                            var tpiT = new TransPaymentItemQuery("tpi");
                            var tpT = new TransPaymentQuery("tp");
                            var tpibgTColl = new TransPaymentItemIntermBillGuarantorCollection();
                            var tpibTColl = new TransPaymentItemIntermBillCollection();
                            tpibgTColl.Query.Where(tpibgTColl.Query.IntermBillNo.In(ibs) && tpibgTColl.Query.IsPaymentReturned == false);
                            tpibTColl.Query.Where(tpibTColl.Query.IntermBillNo.In(ibs) && tpibTColl.Query.IsPaymentReturned == false);
                            tpibgTColl.LoadAll();
                            tpibTColl.LoadAll();

                            var PaymentNos = ((from s in tpibgTColl select s.PaymentNo)
                                .Union(from s in tpibTColl select s.PaymentNo)).Distinct();
                            if (PaymentNos.Count() > 0)
                            {
                                tpiT.InnerJoin(tpT).On(tpT.PaymentNo == tpiT.PaymentNo)
                                    .Where(
                                        tpT.IsApproved == true,
                                        tpT.PaymentNo.In(PaymentNos),
                                        tpT.PaymentNo != tp.PaymentNo)
                                    .Select(tpiT);
                                tpiTColl.Load(tpiT);
                                paidTrans += tpiTColl.Sum(x => x.Amount.Value - x.RoundingAmount.Value);
                            }
                            // end of ambil total payment intermbil yang bersangkutan
                        }

                        // ambil pembayaran COB atau plafon COB
                        decimal allocCOB = 0;
                        var rgColl = new RegistrationGuarantorCollection();
                        rgColl.Query.Where(
                            rgColl.Query.RegistrationNo == tp.RegistrationNo
                        );
                        if (rgColl.LoadAll())
                        {
                            allocCOB += rgColl.Sum(rg => rg.PlafondAmount ?? 0);
                        }

                        var paidTransWithCOB = paidTrans + allocCOB;

                        decimal tmpVal = 0;
                        var maxTmpVal = (Abs(paidTransWithCOB) >= Abs(transCurrentIB)) ? 0 : (transCurrentIB - paidTransWithCOB);

                        var PayCurrentWithRound = PayCurrent - PayCurrentBalance - PayCurrentRound;
                        maxTmpVal = ((Abs(maxTmpVal) - Abs(PayCurrentWithRound)) > 0) ? PayCurrentWithRound : maxTmpVal;
                        var overPay = Abs(PayCurrentWithRound) > Abs(maxTmpVal) ? (PayCurrentWithRound - maxTmpVal) : 0;

                        var firstJ = paidTrans == 0;
                        if (firstJ)
                        {
                            //////tmpVal = transCurrentIB - paidTrans - PayCurrentWithRound;
                            //////var currTmpVal = tmpVal;
                            //////if (Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal;
                            //////if (Abs(tmpVal) < 0) currTmpVal = maxTmpVal;// lebih bayar

                            maxTmpVal -= adminGuarantor;

                            // jurnal temporary
                            if (maxTmpVal != 0)
                            {
                                JournalTransactionDetails x = new JournalTransactionDetails();
                                x.AddNew();
                                x.JournalId = entity.JournalId;
                                x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                                x.SubLedgerId = 0;//sl_contemporary;
                                x.Debit = (maxTmpVal < 0) ? (maxTmpVal * -1) : 0;
                                x.Credit = (maxTmpVal > 0) ? maxTmpVal : 0;
                                x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                x.DocumentNumber = tp.PaymentNo;

                                AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                                x.Save();

                                totalDebit += x.Debit.Value;
                                totalCredit += x.Credit.Value;
                            }
                        }
                        else
                        {
                            //// pembayaran kedua / split bayar kedua
                            //tmpVal = PayCurrentWithRound;
                            //var currTmpVal = tmpVal;
                            //if (Abs(tmpVal) > Abs(maxTmpVal)) currTmpVal = maxTmpVal;
                            //if (Abs(tmpVal) < 0) currTmpVal = maxTmpVal;// lebih bayar
                            // jurnal temporary
                            if (maxTmpVal != 0)
                            {
                                JournalTransactionDetails x = new JournalTransactionDetails();
                                x.AddNew();
                                x.JournalId = entity.JournalId;
                                x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                                x.SubLedgerId = 0;//sl_contemporary;
                                x.Debit = (maxTmpVal < 0) ? (maxTmpVal * -1) : 0;
                                x.Credit = (maxTmpVal > 0) ? maxTmpVal : 0;
                                x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                x.DocumentNumber = tp.PaymentNo;

                                AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                                x.Save();

                                totalDebit += x.Debit.Value;
                                totalCredit += x.Credit.Value;
                            }
                        }

                        if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsAccrualProrataRevenue))
                        {
                            // pindah (koreksi) pendapatan beda guarantor antara payment dan reg
                            var ibNos = dtb.AsEnumerable().Select(r => r["intermBillNo"].ToString()).Distinct().ToArray();
                            var jmColl = GetNewIncomeCorrectionProportional(tp, tpItems, reg, ibNos, entity, coaColl);
                            jmColl.Save();
                            totalDebit += jmColl.Sum(j => j.Debit.Value);
                            totalCredit += jmColl.Sum(j => j.Credit.Value);
                        }

                        if (overPay > 0)
                        {
                            if (IsProrataToRevenue && AppParameter.IsYes(AppParameter.ParameterItem.IsOverpaymentProrataToRevenue))
                            {
                                var jtdColl = GetNewIncomeAdjustProrataCashBased(entity, tp.PaymentNo, -overPay, "", coaColl);
                                jtdColl.Save();
                                totalDebit += jtdColl.Sum(jtd => jtd.Debit.Value);
                                totalCredit += jtdColl.Sum(jtd => jtd.Credit.Value);
                            }
                            else
                            {
                                // ambil subledger
                                var slColl = new SubLedgersCollection();
                                slColl.Query.Where(slColl.Query.SubLedgerName == tp.GuarantorID);
                                if (slColl.LoadAll())
                                {

                                }

                                JournalTransactionDetails xo = new JournalTransactionDetails();
                                xo.AddNew();
                                xo.JournalId = entity.JournalId;
                                xo.ChartOfAccountId = ValidateCOA(coa_overPayment, coaColl, string.Format(
                                    "Master Guarantor: {0}: COA: COA Exccess Payment / Discount (A/R)", grn.GuarantorName));
                                xo.SubLedgerId = slColl.Count > 0 ? slColl.First().SubLedgerId : 0;
                                xo.Debit = (overPay < 0) ? (overPay * -1) : 0;
                                xo.Credit = (overPay > 0) ? overPay : 0;
                                xo.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                                xo.DocumentNumber = tp.PaymentNo;

                                AddMoreInfo(xo, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                    null, string.Empty, string.Empty, tp.RegistrationNo);
                                xo.Save();

                                totalDebit += xo.Debit.Value;
                                totalCredit += xo.Credit.Value;
                            }

                        }
                    }

                    // COB
                    if (cc.Count == 0 && dtb.Rows.Count == 0)
                    {
                        var currTmpVal = tpItems.Sum(tpi => (tpi.Amount ?? 0) - (tpi.Balance ?? 0) - (tpi.RoundingAmount ?? 0));

                        if (currTmpVal != 0)
                        {
                            JournalTransactionDetails x = new JournalTransactionDetails();
                            x.AddNew();
                            x.JournalId = entity.JournalId;
                            x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                            x.SubLedgerId = 0;//sl_contemporary;
                            x.Debit = (currTmpVal < 0) ? (currTmpVal * -1) : 0;
                            x.Credit = (currTmpVal > 0) ? currTmpVal : 0;
                            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            x.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            x.Save();

                            totalDebit += x.Debit.Value;
                            totalCredit += x.Credit.Value;
                        }
                    }

                    if (cc.Count > 0)
                    {
                        if (transCurrent != 0)
                        {
                            JournalTransactionDetails x = new JournalTransactionDetails();
                            x.AddNew();
                            x.JournalId = entity.JournalId;
                            x.ChartOfAccountId = ValidateCOA(coaPatRec, coaColl, "AppParameter:coa_PatientReceivable"); //ValidateCOA(coa_contemporary, coaColl, "App Parameter: coa_ContemporaryPayment");
                            x.SubLedgerId = 0;//sl_contemporary;
                            x.Debit = (transCurrent < 0) ? (transCurrent * -1) : 0;
                            x.Credit = (transCurrent > 0) ? transCurrent : 0;
                            x.Description = string.Format("{2} REG#:{0}. PATIENT:{1}.", reg.RegistrationNo, pEnity.MedicalNo + " - " + pEnity.PatientName, keterangan);
                            x.DocumentNumber = tp.PaymentNo;

                            AddMoreInfo(x, reg.ChargeClassID, reg.GuarantorID, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, tp.RegistrationNo);
                            x.Save();

                            totalDebit += x.Debit.Value;
                            totalCredit += x.Credit.Value;
                        }
                    }

                    if (totalCredit != totalDebit && pkg.Sum(x => x.PackageAmount) != pkg.Sum(x => x.PackageDetailAmount))
                    {
                        string errMsg = "Different package price:";
                        var items = new ItemCollection();
                        items.Query.Where(items.Query.ItemID.In(pkg.Select(p => p.ItemID)));
                        items.LoadAll();

                        foreach (var x in pkg.Where(p => p.PackageAmount != p.PackageDetailAmount))
                        {
                            errMsg += string.Format("TransNo: {0} {3}, Package Price: {1:n2}, Detail Package Price: {2:n2}",
                                x.TransactionNo, x.PackageAmount, x.PackageDetailAmount,
                                items.Where(z => z.ItemID == x.ItemID).Select(z => z.ItemName).FirstOrDefault());
                        }
                        throw new Exception(errMsg);
                    }
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if (/*(totalCredit > 0 && totalDebit > 0) &&*/ (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }

                    // insert cash transaction here
                    var cashID = AutoCashEntryOnPaymentReceive(tp, tpItems, entity, editedBy);
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static JournalTransactionDetailsCollection GetNewIncomeCorrectionProportional(TransPayment tp, TransPaymentItemCollection tpiColl,
            Registration reg, string[] ibNos, JournalTransactions entity, ChartOfAccountsCollection coaColl)
        {

            var jtdCorrectionPayColl = new JournalTransactionDetailsCollection();

            if (reg.GuarantorID != tp.GuarantorID && ibNos.Any())
            {
                var amount = tpiColl.Sum(t => t.Amount ?? 0);

                var ccColl = new CostCalculationCollection();
                if (ibNos.Length == 1)
                {
                    ccColl.Query.Where(ccColl.Query.IntermBillNo == ibNos[0]);
                }
                else
                {
                    ccColl.Query.Where(ccColl.Query.IntermBillNo.In(ibNos));
                }
                ccColl.LoadAll();

                var totalCC = ccColl.Sum(cc => (cc.PatientAmount ?? 0) + (cc.GuarantorAmount ?? 0));

                var jtdCorrectionRegColl = new JournalTransactionDetailsCollection();
                foreach (var cost in ccColl)
                {
                    var pctg = ((cost.PatientAmount ?? 0) + (cost.GuarantorAmount ?? 0)) / totalCC;
                    //trNoSeqNo.Add(new Tuple<string, string>(cost.TransactionNo, cost.SequenceNo));
                    var jtdGuarRegColl = GetNewIncomeJournalCashBased(entity, cost, false, 0, coaColl);
                    foreach (var jtdg in jtdGuarRegColl)
                    {
                        jtdg.SwabDK();

                        jtdg.Credit = pctg * (jtdg.Credit ?? 0);
                        jtdg.Debit = pctg * (jtdg.Debit ?? 0);
                    }
                    jtdCorrectionRegColl.Combine(jtdGuarRegColl);

                    var jtdGuarPayColl = GetNewIncomeJournalCashBasedByGurantor(entity, cost, false, 0, coaColl, false, false, true, tp);
                    foreach (var jtdg in jtdGuarPayColl)
                    {
                        jtdg.Credit = pctg * (jtdg.Credit ?? 0);
                        jtdg.Debit = pctg * (jtdg.Debit ?? 0);
                    }
                    jtdCorrectionPayColl.Combine(jtdGuarPayColl);
                }

                int dAccPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
                jtdCorrectionPayColl.MergeJournalRevenue(jtdCorrectionRegColl, entity, dAccPatRec);
            }

            return jtdCorrectionPayColl;
        }

        public static int? AddNewPatientIncomeAccrualUnapproval(string transactionNo, DateTime date, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == transactionNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                return AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "ACR", editedBy, date);
            }
        }

        public static int? AddNewPatientIncomeAccrual(string journalType, string transactionNo, string editedBy, int journalId)
        {
            if (journalId == 0)
            {
                // create new thread
                new System.Threading.Thread(delegate ()
                {
                    AddNewPatientIncomeAccrual_Exec(journalType, transactionNo, editedBy, journalId);
                }).Start();
                return journalId;
            }
            else
            {
                return AddNewPatientIncomeAccrual_Exec(journalType, transactionNo, editedBy, journalId);
            }
        }
        public static int? AddNewPatientIncomeAccrual_Exec(string journalType, string transactionNo, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var ccColl = new CostCalculationCollection();
                if (!ccColl.LoadByTransactionNo(transactionNo))
                {
                    var tc = new TransCharges();
                    var tp = new TransPrescription();
                    if (tc.LoadByPrimaryKey(transactionNo))
                    {
                        var tciColl = new TransChargesItemCollection();
                        tciColl.Query.Where(tciColl.Query.TransactionNo == tc.TransactionNo);
                        if (tciColl.LoadAll())
                        {
                            foreach (var tci in tciColl)
                            {
                                var cCalc = ccColl.AddNew();
                                cCalc.RegistrationNo = tc.RegistrationNo;
                                cCalc.TransactionNo = tci.TransactionNo;
                                cCalc.SequenceNo = tci.SequenceNo;
                                cCalc.ItemID = tci.ItemID;
                                cCalc.PatientAmount = tci.ChargeQuantity * (tci.Price - (tci.DiscountAmount / (tci.ChargeQuantity == 0 ? 1 : tci.ChargeQuantity)));
                                cCalc.GuarantorAmount = 0;
                                cCalc.DiscountAmount = tci.DiscountAmount;
                            }
                        }
                    }
                    else if (tp.LoadByPrimaryKey(transactionNo))
                    {
                        var tpiColl = new TransPrescriptionItemCollection();
                        tpiColl.Query.Where(tpiColl.Query.PrescriptionNo == tp.PrescriptionNo);
                        if (tpiColl.LoadAll())
                        {
                            foreach (var tpi in tpiColl)
                            {
                                var cCalc = ccColl.AddNew();
                                cCalc.RegistrationNo = tp.RegistrationNo;
                                cCalc.TransactionNo = tpi.PrescriptionNo;
                                cCalc.SequenceNo = tpi.SequenceNo;
                                cCalc.ItemID = tpi.ItemID;
                                cCalc.PatientAmount = tpi.LineAmount;
                                cCalc.GuarantorAmount = 0;
                                cCalc.DiscountAmount = tpi.DiscountAmount;
                            }
                        }
                    }
                }
                if (ccColl.Count == 0)
                {
                    throw new Exception("Costcalculation " + transactionNo + " not found!");
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();

                // cegah double jurnal
                if (journalId == 0)
                {
                    entity.Query.Where(entity.Query.RefferenceNumber == transactionNo, entity.Query.JournalIdRefference.IsNull());
                    entity.Query.es.Top = 1;
                    if (entity.Load(entity.Query))
                    {
                        journalId = entity.JournalId.Value;
                    }
                }

                var reg = new Registration();
                reg.LoadByPrimaryKey(ccColl.First().RegistrationNo);
                var pat = new Patient();
                pat.LoadByPrimaryKey(reg.PatientID);

                DateTime transDate;
                entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;
                    entity.IsVoid = false;

                    transDate = entity.TransactionDate.Value.Date;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    string suid;
                    var tc = new TransCharges();
                    if (tc.LoadByPrimaryKey(transactionNo))
                    {
                        transDate = tc.TransactionDate.Value.Date;
                        suid = tc.ToServiceUnitID;
                    }
                    else
                    {
                        var tp = new TransPrescription();
                        tp.LoadByPrimaryKey(transactionNo);

                        transDate = tp.PrescriptionDate.Value.Date;
                        suid = tp.ServiceUnitID;
                    }

                    var su = new ServiceUnit();
                    su.LoadByPrimaryKey(suid);

                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("ACR", transDate);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = transDate;
                    entity.Description = string.Format("TRANS REG#:{0}. PAT#:{1}. Unit:{2}", reg.RegistrationNo, pat.MedicalNo + " - " + pat.PatientName, su.ServiceUnitName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = transactionNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();
                string errMsg = string.Empty;
                decimal totalDebit = 0, totalCredit = 0;

                var jtdRegColl = new JournalTransactionDetailsCollection();
                foreach (var cc in ccColl)
                {
                    var jtdColl = GetNewIncomeJournalCashBased(entity, cc, false, 0, coaColl, true);
                    foreach (var jtd in jtdColl)
                    {
                        if (!string.IsNullOrEmpty(jtd.ErrorMsg))
                        {
                            errMsg += jtd.ErrorMsg + System.Environment.NewLine;
                            jtdColl.DetachEntity(jtd);
                        }
                    }
                    jtdRegColl.Combine(jtdColl);
                }

                // jurnal detail paket tidak perlu menjurnal pendapatan dan piutang
                var tcp = new TransCharges();
                if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsPackageRevenueOnMainPackage) &&
                    tcp.LoadByPrimaryKey(transactionNo) && !string.IsNullOrEmpty(tcp.PackageReferenceNo))
                {
                    // skip
                }
                else
                {
                    //var patRecAmount = jtdRegColl.Sum(d => d.Debit.Value - d.Credit.Value);
                    var patRecAmount = ccColl.Sum(cc => (cc.PatientAmount ?? 0) + (cc.GuarantorAmount ?? 0));
                    int dAccPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
                    if (patRecAmount != 0)
                    {
                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = ValidateCOA(dAccPatRec, coaColl, "AppParameter: coa_PatientReceivable");
                        d.SubLedgerId = 0;
                        d.Debit = patRecAmount > 0 ? patRecAmount : 0;
                        d.Credit = patRecAmount < 0 ? (patRecAmount * -1) : 0;
                        d.Description = string.Format("Receivable REG#:{0}. PAT#:{1}", reg.RegistrationNo, pat.MedicalNo + " - " + pat.PatientName);
                        d.DocumentNumber = entity.RefferenceNumber;

                        AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, string.Empty);
                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                    }
                }

                jtdRegColl.Save();
                totalDebit += jtdRegColl.Sum(d => d.Debit.Value);
                totalCredit += jtdRegColl.Sum(d => d.Credit.Value);

                if (!string.IsNullOrEmpty(errMsg)) throw new Exception(errMsg);


                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedTransaction) == "Yes")
                {
                    if (/*(totalCredit > 0 && totalDebit > 0) &&*/ (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewPatientBillingRecalculation(string journalType, string registrationNo, DateTime date, string editedBy, int journalId)
        {
            if (journalId == 0)
            {
                // create new thread
                (new System.Threading.Thread(delegate ()
                {
                    AddNewPatientBillingRecalculation_Exec(journalType, registrationNo, date, editedBy, journalId);
                })
                { IsBackground = true }).Start();
                return journalId;
            }
            else
            {
                return AddNewPatientBillingRecalculation_Exec(journalType, registrationNo, date, editedBy, journalId);
            }
        }

        public static int? AddNewPatientBillingRecalculation_Exec(string journalType, string registrationNo, DateTime date, string editedBy, int journalId)
        {
            if (journalId == 0)
                JournalErrorMessageSave(journalId,
                    new Exception(string.Format("Tread Start For Journal Billing Recal {0}", registrationNo)),
                    string.Empty, editedBy);

            if (!IsAutoJournalEnabled())
                return 0;

            date = date.Date;

            var regs = MergeBilling.GetMergeBillingByReg(registrationNo);

            //var listRev = new RevenueList();
            var jtdRevColl = new JournalTransactionDetailsCollection();
            try
            {
                // ambil semua transaksi yang belum ada pembayaran sd tanggal @date
                var ccColl = new CostCalculationCollection();
                var ccq = new CostCalculationQuery("ccq");
                var regq = new RegistrationQuery("regq");

                var tc = new TransChargesQuery("tc");
                var tp = new TransPrescriptionQuery("tp");

                var tpibg = new TransPaymentItemIntermBillGuarantorQuery("tpibg");
                var tpg = new TransPaymentQuery("tpg");
                var tpib = new TransPaymentItemIntermBillQuery("tpib");
                var tpp = new TransPaymentQuery("tpp");
                var tpio = new TransPaymentItemOrderQuery("tpio");
                var tpo = new TransPaymentQuery("tpo");

                var tc_p = new TransChargesQuery("tc_p");
                var ccq_p = new CostCalculationQuery("ccq_p");
                var tpibg_p = new TransPaymentItemIntermBillGuarantorQuery("tpibg_p");
                var tpg_p = new TransPaymentQuery("tpg_p");
                var tpib_p = new TransPaymentItemIntermBillQuery("tpib_p");
                var tpp_p = new TransPaymentQuery("tpp_p");
                var tpio_p = new TransPaymentItemOrderQuery("tpio_p");
                var tpo_p = new TransPaymentQuery("tpo_p");

                ccq
                    .InnerJoin(regq).On(ccq.RegistrationNo == regq.RegistrationNo && regq.IsVoid == false)

                    .LeftJoin(tc).On(ccq.TransactionNo == tc.TransactionNo && tc.IsApproved == true && tc.IsVoid == false && tc.PackageReferenceNo.Coalesce("''") == string.Empty/*bukan paket*/)
                    .LeftJoin(tp).On(ccq.TransactionNo == tp.PrescriptionNo && tp.IsApproval == true && tp.IsVoid == false)

                    .LeftJoin(tpibg).On(ccq.IntermBillNo == tpibg.IntermBillNo && tpibg.IsPaymentProceed == true && tpibg.IsPaymentReturned == false)
                    .LeftJoin(tpg).On(tpibg.PaymentNo == tpg.PaymentNo && tpg.IsVoid == false && tpg.IsApproved == true)
                    .LeftJoin(tpib).On(ccq.IntermBillNo == tpib.IntermBillNo && tpib.IsPaymentProceed == true && tpib.IsPaymentReturned == false)
                    .LeftJoin(tpp).On(tpib.PaymentNo == tpp.PaymentNo && tpp.IsVoid == false && tpp.IsApproved == true)
                    .LeftJoin(tpio).On(ccq.TransactionNo == tpio.TransactionNo && ccq.SequenceNo == tpio.SequenceNo && tpio.IsPaymentProceed == true && tpio.IsPaymentReturned == false)
                    .LeftJoin(tpo).On(tpio.PaymentNo == tpo.PaymentNo && tpo.IsVoid == false && tpo.IsApproved == true)

                    .LeftJoin(tc_p).On(tc.PackageReferenceNo == tc_p.TransactionNo)
                    .LeftJoin(ccq_p).On(tc_p.TransactionNo == ccq_p.TransactionNo)
                    .LeftJoin(tpibg_p).On(ccq_p.IntermBillNo == tpibg_p.IntermBillNo && tpibg_p.IsPaymentProceed == true && tpibg_p.IsPaymentReturned == false)
                    .LeftJoin(tpg_p).On(tpibg_p.PaymentNo == tpg_p.PaymentNo && tpg_p.IsVoid == false && tpg_p.IsApproved == true)
                    .LeftJoin(tpib_p).On(ccq_p.IntermBillNo == tpib_p.IntermBillNo && tpib_p.IsPaymentProceed == true && tpib_p.IsPaymentReturned == false)
                    .LeftJoin(tpp_p).On(tpib_p.PaymentNo == tpp_p.PaymentNo && tpp_p.IsVoid == false && tpp_p.IsApproved == true)
                    .LeftJoin(tpio_p).On(ccq_p.TransactionNo == tpio_p.TransactionNo && ccq_p.SequenceNo == tpio_p.SequenceNo && tpio_p.IsPaymentProceed == true && tpio_p.IsPaymentReturned == false)
                    .LeftJoin(tpo_p).On(tpio_p.PaymentNo == tpo_p.PaymentNo && tpo_p.IsVoid == false && tpo_p.IsApproved == true)

                    .Where(
                        regq.RegistrationNo.In(regs),
                        "<CAST(ISNULL(tpg.PaymentDate, ISNULL(tpp.PaymentDate, ISNULL(tpo.PaymentDate, ISNULL(tpg_p.PaymentDate, ISNULL(tpp_p.PaymentDate, ISNULL(tpo_p.PaymentDate,'" + date.AddMonths(1).ToString("yyyy-MM-dd") + "')))))) AS DATE) > CAST('" + date.ToString("yyyy-MM-dd") + "' AS DATE)>",
                        "<CAST(ISNULL(tc.ExecutionDate, tp.PrescriptionDate) AS DATE) <= CAST('" + date.ToString("yyyy-MM-dd") + "' AS DATE)>")
                    .Select(ccq);

                List<string> transNos = new List<string>();

                var dpTciColl = new TransChargesItemCollection();
                if (ccColl.Load(ccq))
                {
                    transNos = ccColl.Select(c => c.TransactionNo).Distinct().ToList();
                    if (transNos.Count > 0)
                    {
                        // ambil detail paket

                        var dpTc = new TransChargesQuery("tc");
                        var dpTci = new TransChargesItemQuery("tci");
                        dpTci.InnerJoin(dpTc).On(dpTci.TransactionNo == dpTc.TransactionNo)
                            .Where(dpTc.PackageReferenceNo.In(transNos))
                            .Select(dpTci.TransactionNo, dpTci.SequenceNo);
                        dpTciColl.Load(dpTci);
                    }
                }
                else
                {
                    // fake it
                    transNos.Add("xxxxx");
                }

                var trNoSeqNo = ccColl.Select(c => new { c.TransactionNo, c.SequenceNo }).Union(
                        dpTciColl.Select(tci => new { tci.TransactionNo, tci.SequenceNo })
                    );

                // load journal accrual existing
                var jadColl = new JournalTransactionDetailsCollection();
                jadColl.LoadByRefNoForAccrual(transNos);
                //var jadq = new JournalTransactionDetailsQuery("jad");
                //var jaq = new JournalTransactionsQuery("ja");
                //jadq.InnerJoin(jaq).On(jadq.JournalId == jaq.JournalId)
                //    .Where(jaq.RefferenceNumber.In(transNos), jaq.IsVoid == false);
                //jadColl.Load(jadq);

                // load journal bill recal existing
                var jbdColl = new JournalTransactionDetailsCollection();
                jbdColl.LoadByRefNoBillRecalForAccrual(regs, transNos, date);
                //var jbdq = new JournalTransactionDetailsQuery("jbd");
                //var jbq = new JournalTransactionsQuery("jb");
                //jbdq.InnerJoin(jbq).On(jbdq.JournalId == jbq.JournalId)
                //    .Where(jbq.RefferenceNumber.In(regs), jbq.TransactionDate < date, jbdq.DocumentNumber.In(transNos), jbq.IsVoid == false);
                //jbdColl.Load(jbdq);

                jadColl.Combine(jbdColl);
                foreach (var jad in jadColl)
                {
                    if (!trNoSeqNo.Any(ts => ts.TransactionNo == jad.DocumentNumber && ts.SequenceNo == jad.DocumentNumberSequenceNo) && !string.IsNullOrEmpty(jad.DocumentNumberSequenceNo))
                    {
                        jadColl.DetachEntity(jad); // detach from coll, kemungkinan sudah dibayar duluan
                    }
                    else
                    {
                        // reverse
                        jad.SwabDK();
                        //var credit = jad.Credit ?? 0;
                        //jad.Credit = jad.Debit;
                        //jad.Debit = credit;
                    }
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (journalId == 0)
                {
                    //var jCurrent = new JournalTransactions();
                    entity.Query.Where(
                        entity.Query.RefferenceNumber == registrationNo,
                        entity.Query.TransactionDate == date,
                        entity.Query.IsVoid == false
                    );

                    if (entity.Load(entity.Query))
                    {
                        journalId = entity.JournalId ?? 0;
                    }
                }

                var reg = new Registration();
                reg.LoadByPrimaryKey(registrationNo);
                var pat = new Patient();
                pat.LoadByPrimaryKey(reg.PatientID);

                entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    entity.IsVoid = false;
                    entity.IsPosted = false;

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("RCL", date);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = date;
                    entity.Description = string.Format("Billing Recalculation for REG#:{0}. PAT#:{1}. on {2}", reg.RegistrationNo, pat.MedicalNo + " - " + pat.PatientName, date.ToShortDateString());
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = registrationNo;

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();
                string errMsg = string.Empty;
                decimal totalDebit = 0, totalCredit = 0;

                //var jtdRegColl = new JournalTransactionDetailsCollection();
                foreach (var cc in ccColl)
                {
                    var jtdColl = GetNewIncomeJournalCashBased(entity, cc, false, 0, coaColl, true);
                    foreach (var jtd in jtdColl)
                    {
                        if (!string.IsNullOrEmpty(jtd.ErrorMsg))
                            errMsg += jtd.ErrorMsg + System.Environment.NewLine;
                    }
                    jtdRevColl.Combine(jtdColl);
                }

                int dAccPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
                jtdRevColl.MergeJournalRevenue(jadColl, entity, dAccPatRec);
                //foreach (var jad in jadColl)
                //{
                //    var jd = jtdRevColl.Where(j => j.ChartOfAccountId == jad.ChartOfAccountId &&
                //        j.SubLedgerId == jad.SubLedgerId &&
                //        j.DocumentNumber == jad.DocumentNumber &&
                //        j.DocumentNumberSequenceNo == jad.DocumentNumberSequenceNo &&
                //        j.ItemID == jad.ItemID // <-- diperlukan untuk item consumption
                //    ).FirstOrDefault();

                //    if (jd == null)
                //    {
                //        jadColl.DetachEntity(jad);
                //        jad.AcceptChanges();
                //        jad.MarkAllColumnsAsDirty(DataRowState.Added);
                //        jad.JournalId = entity.JournalId;
                //        jtdRevColl.AttachEntity(jad);
                //    }
                //    else
                //    {
                //        jd.Debit += jad.Debit.Value;
                //        jd.Credit += jad.Credit.Value;
                //    }
                //}


                //foreach (var jd in jtdRevColl)
                //{
                //    var amt = jd.Debit.Value - jd.Credit.Value;
                //    jd.Debit = amt > 0 ? amt : 0;
                //    jd.Credit = amt < 0 ? (amt * -1) : 0;

                //    if (jd.ChartOfAccountId.Value == dAccPatRec && jd.SubLedgerId == 0)
                //    {
                //        jtdRevColl.DetachEntity(jd);
                //    }
                //    else if (jd.Debit.Value + jd.Credit.Value == 0)
                //    {
                //        jtdRevColl.DetachEntity(jd);
                //    }
                //}

                var patRecAmount = jtdRevColl.Sum(d => d.Debit.Value - d.Credit.Value);

                if (patRecAmount != 0)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccPatRec, coaColl, "AppParameter: coa_PatientReceivable");
                    d.SubLedgerId = 0;
                    d.Debit = patRecAmount < 0 ? (patRecAmount * -1) : 0;
                    d.Credit = patRecAmount < 0 ? 0 : patRecAmount;
                    d.Description = string.Format("Receivable REG#:{0}. PAT#:{1}", reg.RegistrationNo, pat.MedicalNo + " - " + pat.PatientName);
                    d.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }

                jtdRevColl.Save();
                totalDebit += jtdRevColl.Sum(d => d.Debit.Value);
                totalCredit += jtdRevColl.Sum(d => d.Credit.Value);


                /////////////////////////////////////////////////////
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedTransaction) == "Yes")
                {
                    if (/*(totalCredit > 0 && totalDebit > 0) &&*/ (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                // try to save error
                var listUnMap = jtdRevColl.Where(x => x.ChartOfAccountId == 0 && x.IsRevenue == true)
                    .Select(x => new CoaMapping
                    {
                        ServiceUnitID = x.ServiceUnitID,
                        ItemID = x.ItemID,
                        TariffComponentID = x.TariffComponentID,
                        SRRegistrationType = x.SRRegistrationType
                    }).ToList();
                JournalErrorMessageSave(journalId, ex,
                    Newtonsoft.Json.JsonConvert.SerializeObject(listUnMap), editedBy);
                //JournalErrorMessageSave(journalId, ex,"", editedBy);
            }
            return journalId;
        }

        public static int? AddNewPatientReceivableJournal_V2(string journalType, DateTime date, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            //var listRev = new RevenueList();
            var jtdRevColl = new JournalTransactionDetailsCollection();
            try
            {
                // jurnal ini tidak boleh double dalam satu tanggal
                var jt = new JournalTransactionsCollection();
                jt.Query.Where(jt.Query.TransactionDate == date,
                    jt.Query.JournalType == journalType,
                    jt.Query.IsVoid == false,
                    jt.Query.JournalIdRefference.IsNull());
                jt.LoadAll();
                if (jt.Count > 0)
                {
                    journalId = jt[0].JournalId ?? 0;
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    entity.IsVoid = false;

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PRV", date);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = date;
                    entity.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = "PRV-" + date.ToString("yyyy/MM/dd");

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                // ambil semua transaksi yang belum ada pembayaran sd tanggal @date
                var cccColl = new CostCalculationCollection();
                var ccq = new CostCalculationQuery("ccq");
                var regq = new RegistrationQuery("regq");
                var mb = new MergeBillingQuery("mb");
                var regmb = new RegistrationQuery("regmb");

                var tc = new TransChargesQuery("tc");
                var tp = new TransPrescriptionQuery("tp");

                var tpibg = new TransPaymentItemIntermBillGuarantorQuery("tpibg");
                var tpg = new TransPaymentQuery("tpg");
                var tpib = new TransPaymentItemIntermBillQuery("tpib");
                var tpp = new TransPaymentQuery("tpp");
                var tpio = new TransPaymentItemOrderQuery("tpio");
                var tpo = new TransPaymentQuery("tpo");

                var tc_p = new TransChargesQuery("tc_p");
                var ccq_p = new CostCalculationQuery("ccq_p");
                var tpibg_p = new TransPaymentItemIntermBillGuarantorQuery("tpibg_p");
                var tpg_p = new TransPaymentQuery("tpg_p");
                var tpib_p = new TransPaymentItemIntermBillQuery("tpib_p");
                var tpp_p = new TransPaymentQuery("tpp_p");
                var tpio_p = new TransPaymentItemOrderQuery("tpio_p");
                var tpo_p = new TransPaymentQuery("tpo_p");

                ccq
                    .InnerJoin(regq).On(ccq.RegistrationNo == regq.RegistrationNo && regq.IsVoid == false)
                    .LeftJoin(mb).On(regq.RegistrationNo == mb.RegistrationNo)
                    .LeftJoin(regmb).On(mb.FromRegistrationNo == regmb.RegistrationNo && regmb.IsVoid == false)

                    .LeftJoin(tc).On(ccq.TransactionNo == tc.TransactionNo && tc.IsApproved == true && tc.IsVoid == false && tc.PackageReferenceNo.Coalesce("''") == string.Empty/*bukan paket*/)
                    .LeftJoin(tp).On(ccq.TransactionNo == tp.PrescriptionNo && tp.IsApproval == true && tp.IsVoid == false)

                    .LeftJoin(tpibg).On(ccq.IntermBillNo == tpibg.IntermBillNo && tpibg.IsPaymentProceed == true && tpibg.IsPaymentReturned == false)
                    .LeftJoin(tpg).On(tpibg.PaymentNo == tpg.PaymentNo && tpg.IsVoid == false && tpg.IsApproved == true)
                    .LeftJoin(tpib).On(ccq.IntermBillNo == tpib.IntermBillNo && tpib.IsPaymentProceed == true && tpib.IsPaymentReturned == false)
                    .LeftJoin(tpp).On(tpib.PaymentNo == tpp.PaymentNo && tpp.IsVoid == false && tpp.IsApproved == true)
                    .LeftJoin(tpio).On(ccq.TransactionNo == tpio.TransactionNo && ccq.SequenceNo == tpio.SequenceNo && tpio.IsPaymentProceed == true && tpio.IsPaymentReturned == false)
                    .LeftJoin(tpo).On(tpio.PaymentNo == tpo.PaymentNo && tpo.IsVoid == false && tpo.IsApproved == true)

                    .LeftJoin(tc_p).On(tc.PackageReferenceNo == tc_p.TransactionNo)
                    .LeftJoin(ccq_p).On(tc_p.TransactionNo == ccq_p.TransactionNo)
                    .LeftJoin(tpibg_p).On(ccq_p.IntermBillNo == tpibg_p.IntermBillNo && tpibg_p.IsPaymentProceed == true && tpibg_p.IsPaymentReturned == false)
                    .LeftJoin(tpg_p).On(tpibg_p.PaymentNo == tpg_p.PaymentNo && tpg_p.IsVoid == false && tpg_p.IsApproved == true)
                    .LeftJoin(tpib_p).On(ccq_p.IntermBillNo == tpib_p.IntermBillNo && tpib_p.IsPaymentProceed == true && tpib_p.IsPaymentReturned == false)
                    .LeftJoin(tpp_p).On(tpib_p.PaymentNo == tpp_p.PaymentNo && tpp_p.IsVoid == false && tpp_p.IsApproved == true)
                    .LeftJoin(tpio_p).On(ccq_p.TransactionNo == tpio_p.TransactionNo && ccq_p.SequenceNo == tpio_p.SequenceNo && tpio_p.IsPaymentProceed == true && tpio_p.IsPaymentReturned == false)
                    .LeftJoin(tpo_p).On(tpio_p.PaymentNo == tpo_p.PaymentNo && tpo_p.IsVoid == false && tpo_p.IsApproved == true)

                    .Where(//ccq.RegistrationNo == "REG/SO/220128-0001",
                           //ccq.Or(
                           //    "<ISNULL(tpg.PaymentDate, ISNULL(tpp.PaymentDate, tpo.PaymentDate)) IS NULL>",
                           //    "< OR CAST(ISNULL(tpg.PaymentDate, ISNULL(tpp.PaymentDate, tpo.PaymentDate)) AS DATE) > '" + date.ToShortDateString() + "'>"
                           //    ),
                        "<CAST(ISNULL(tpg.PaymentDate, ISNULL(tpp.PaymentDate, ISNULL(tpo.PaymentDate, ISNULL(tpg_p.PaymentDate, ISNULL(tpp_p.PaymentDate, ISNULL(tpo_p.PaymentDate,'" + date.AddMonths(1).ToString("yyyy-MM-dd") + "')))))) AS DATE) > CAST('" + date.ToString("yyyy-MM-dd") + "' AS DATE)>",
                        "<CAST(ISNULL(tc.ExecutionDate, tp.PrescriptionDate) AS DATE) <= CAST('" + date.ToString("yyyy-MM-dd") + "' AS DATE)>")
                    .Select(
                        ccq,
                        "<CASE regq.SRRegistrationType WHEN 'IPR' THEN ISNULL(regmb.DischargeDate, regq.DischargeDate) ELSE regq.RegistrationDate END refTo_DischargeDate>"
                    );

                // batas tgl cut off jika ada
                DateTime tglStr = DateTime.ParseExact(
                        AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_PatientReceivableDateStart),
                        "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);

                if (tglStr > (new DateTime(2000, 1, 1)))
                {
                    ccq.Where("<CAST(ISNULL(tc.ExecutionDate, tp.PrescriptionDate) AS DATE) >= CAST('" + tglStr.ToString("yyyy-MM-dd") + "' AS DATE)'>");
                }

                cccColl.Load(ccq);

                var RegNos = cccColl.Select(c => c.RegistrationNo).Distinct().ToArray();

                var prsColl = new PatientReceivableMonthlySummaryCollection();
                var prsdColl = new PatientReceivableMonthlySummaryDetailCollection();

                prsdColl.DeleteByPeriod(date);
                prsColl.DeleteByPeriod(date);

                //prsColl.Query.Where(prsColl.Query.Period.Equal(date));
                //prsColl.LoadAll();

                //var prsq = new PatientReceivableMonthlySummaryQuery("a");
                //var prsdq = new PatientReceivableMonthlySummaryDetailQuery("b");

                //prsdq.InnerJoin(prsq).On(prsdq.ID.Equal(prsq.ID))
                //    .Where(prsq.Period.Equal(date))
                //    .Select(prsdq);
                //prsdColl.Load(prsdq);

                //prsdColl.MarkAllAsDeleted();
                //prsColl.MarkAllAsDeleted();
                //prsdColl.Save();

                //prsColl.Save();

                var coaColl = new ChartOfAccountsCollection();

                decimal um = 0;
                string errMsg = string.Empty;
                foreach (var RegNo in RegNos)
                {
                    //var RegNo = row["RegistrationNo"].ToString();

                    var reg = new Registration();
                    reg.LoadByPrimaryKey(RegNo);
                    var guar = new Guarantor();
                    guar.LoadByPrimaryKey(reg.GuarantorID);

                    var prs = prsColl.Where(p => p.RegistrationNo.Equals(RegNo)).FirstOrDefault();
                    if (prs == null)
                    {
                        prs = prsColl.AddNew();
                        prs.Period = date;
                        prs.RegistrationNo = RegNo;
                        prs.DownPayment = 0;
                        prs.CreateByUserID = editedBy;
                        prs.CreateDateTime = DateTime.Now;
                    }
                    prs.GuarantorID = reg.GuarantorID;
                    prs.SRGuarantorType = guar.SRGuarantorType;

                    #region Uang Muka 
                    //// ambil uang muka yang masih valid/outstanding sampai dengan tanggal param
                    //var tpiColl = new TransPaymentItemCollection();
                    //var tpQ = new TransPaymentQuery("tp");
                    //var tpiQ = new TransPaymentItemQuery("tpi");
                    //var tpiRetQ = new TransPaymentItemQuery("tpiRet");
                    //var tpRetQ = new TransPaymentQuery("tpRet");
                    //var tpPay = new TransPaymentQuery("tpPay");

                    //tpiQ.InnerJoin(tpQ).On(tpQ.PaymentNo == tpiQ.PaymentNo)
                    //    .LeftJoin(tpiRetQ).On(tpQ.PaymentNo == tpiRetQ.ReferenceNo)
                    //    .LeftJoin(tpRetQ).On(tpiRetQ.PaymentNo == tpRetQ.PaymentNo && tpRetQ.IsApproved == true &&
                    //        tpRetQ.IsVoid == false && tpRetQ.PaymentDate.Date() <= date)
                    //    .LeftJoin(tpPay).On(tpQ.PaymentReferenceNo == tpPay.PaymentNo && tpPay.IsApproved == true &&
                    //        tpPay.IsVoid == false && tpPay.PaymentDate.Date() <= date)
                    //    .Where(
                    //        tpQ.RegistrationNo == RegNo,
                    //        tpQ.IsApproved == true,
                    //        tpQ.IsVoid == false,
                    //        tpQ.TransactionCode == "018",
                    //        "<ISNULL(tpPay.PaymentNo,'') = ''>",//tpQ.PaymentReferenceNo == string.Empty,
                    //        "<ISNULL(tpRet.PaymentNo,'') = ''>",
                    //        tpQ.PaymentDate.Date() <= date)
                    //    //"<CAST(tp.PaymentDate as DATE) <= " + date.ToShortDateString() + ">")
                    //    .Select(tpiQ);
                    //if (tpiColl.Load(tpiQ))
                    //{
                    //    var _um = tpiColl.Sum(x => x.Amount).Value;
                    //    prs.DownPayment = _um;
                    //    prs.LastUpdateByUserID = editedBy;
                    //    prs.LastUpdateDateTime = DateTime.Now;

                    //    um += _um;
                    //}
                    //prsColl.Save();
                    #endregion Uang Muka

                    #region Uang Muka 
                    // ambil uang muka yang masih valid/outstanding sampai dengan tanggal param
                    var tpiColl = new TransPaymentItemCollection();
                    var tpQ = new TransPaymentQuery("tp");
                    var tpiQ = new TransPaymentItemQuery("tpi");
                    var tpPay = new TransPaymentQuery("tpPay");

                    tpiQ.InnerJoin(tpQ).On(tpQ.PaymentNo == tpiQ.PaymentNo)

                        .LeftJoin(tpPay).On(tpQ.PaymentReferenceNo == tpPay.PaymentNo && tpPay.IsApproved == true &&
                            tpPay.IsVoid == false && tpPay.PaymentDate.Date() <= date)
                        .Where(
                            tpQ.RegistrationNo == RegNo,
                            tpQ.IsApproved == true,
                            tpQ.IsVoid == false,
                            tpQ.TransactionCode == "018",
                            "<ISNULL(tpPay.PaymentNo,'') = ''>",//tpQ.PaymentReferenceNo == string.Empty,
                            tpQ.PaymentDate.Date() <= date)
                        //"<CAST(tp.PaymentDate as DATE) <= " + date.ToShortDateString() + ">")
                        .Select(tpiQ);
                    if (tpiColl.Load(tpiQ))
                    {
                        decimal _um = 0;

                        // Return UM
                        var tpiRetColl = new TransPaymentItemCollection();
                        var tpiRetQ = new TransPaymentItemQuery("tpiRet");
                        var tpRetQ = new TransPaymentQuery("tpRet");
                        //.LeftJoin(tpiRetQ).On(tpQ.PaymentNo == tpiRetQ.ReferenceNo)
                        tpiRetQ.InnerJoin(tpRetQ).On(tpiRetQ.PaymentNo == tpRetQ.PaymentNo)
                        .Where(
                            tpiRetQ.ReferenceNo.In(tpiColl.Select(t => t.PaymentNo)),
                            tpRetQ.IsApproved == true,
                            tpRetQ.IsVoid == false,
                            tpRetQ.PaymentDate.Date() <= date);
                        if (tpiRetColl.Load(tpiRetQ))
                        {
                            var tpis = tpiColl.Where(t => !tpiRetColl.Select(tr => tr.ReferenceNo).Contains(t.PaymentNo));
                            if (tpis.Any())
                            {
                                _um = tpis.Sum(x => x.Amount).Value;
                            }
                        }
                        else
                        {
                            _um = tpiColl.Sum(x => x.Amount).Value;
                        }

                        prs.DownPayment = _um;
                        prs.LastUpdateByUserID = editedBy;
                        prs.LastUpdateDateTime = DateTime.Now;

                        um += _um;
                    }
                    prsColl.Save();
                    #endregion Uang Muka

                    // ambil transaksi per registrasi yang belum ada pembayarannya
                    // pada tanggal param dan tanggal transaksi tidak lebih dari tanggal param
                    var ccs = cccColl.Where(c => c.RegistrationNo == RegNo);

                    prs.IsDischarged = false;
                    if (ccs.Any()) prs.IsDischarged = ccs.First().GetColumn("refTo_DischargeDate") is DBNull ? false : (ccs.First().DischargeDate.Value.Date <= date.Date);

                    var jtdRegColl = new JournalTransactionDetailsCollection();
                    foreach (var c in ccs)
                    {
                        var jtdColl = GetNewIncomeJournalCashBased(entity, c, false, 0, coaColl, true);
                        foreach (var jtd in jtdColl)
                        {
                            if (!string.IsNullOrEmpty(jtd.ErrorMsg))
                                errMsg += jtd.ErrorMsg + System.Environment.NewLine;
                        }
                        jtdRegColl.Combine(jtdColl);
                    }

                    // summarydetail
                    //foreach (var rev in _listRev.Revenues.Where(x => x.IsRevenue.Equals(true)))
                    //foreach (var rev in jtdRegColl.Where(x => x.IsRevenue.Equals(true)))
                    foreach (var rev in jtdRegColl)
                    {
                        var p = prsdColl.AddNew();
                        p.ID = prs.ID;
                        p.ChartOfAccountId = rev.ChartOfAccountId;
                        p.SRBillingGroup = rev.SRBillingGroup;
                        p.Amount = rev.Credit - rev.Debit;
                        p.CreateByUserID = editedBy;
                        p.CreateDateTime = DateTime.Now;
                        p.LastUpdateByUserID = editedBy;
                        p.LastUpdateDateTime = DateTime.Now;
                        p.ClassID = rev.ClassID;
                        p.ParamedicID = rev.ParamedicID;
                        p.ServiceUnitID = rev.ServiceUnitID;
                        p.ItemID = rev.ItemID;
                        p.TransactionNo = rev.DocumentNumber;
                        p.SequenceNo = rev.DocumentNumberSequenceNo;
                        p.IsRevenue = rev.IsRevenue;
                    }
                    prsdColl.Save();

                    jtdRevColl.Combine(jtdRegColl);

                    //foreach (var r in _listRev.Revenues)
                    //{
                    //    listRev.Revenues.Add(r);
                    //    //listRev.Add(r.CoaID, r.SlID, r.SRBillingGroup, r.IsRevenue, r.Debit, r.Credit, r.ser);
                    //}
                }
                //if (listRev.Revenues.Count == 0) return 0;
                if (jtdRevColl.Count == 0) return 0;

                foreach (var prs in prsColl)
                {
                    prs.JournalId = journalId;
                }
                prsColl.Save();

                if (!errMsg.Equals(string.Empty)) throw new Exception(errMsg);

                decimal totalDebit = 0, totalCredit = 0;

                // DEBIT
                // create jurnal piutang dalam perawatan group by guarantor type
                var guarids = prsColl.Select(p => p.GuarantorID).Distinct().ToArray();
                var Guars = new GuarantorCollection();
                if (guarids.Count() > 0)
                {
                    Guars.Query.Where(Guars.Query.GuarantorID.In(guarids));
                    Guars.LoadAll();
                }
                var gtColl = new AppStandardReferenceItemCollection();
                gtColl.Query.Where(
                    gtColl.Query.StandardReferenceID == "GuarantorType"
                    );
                gtColl.LoadAll();

                decimal dUnpammedDGRype_discharged = 0, dUnpammedDGRype_incharge = 0;
                //decimal dUM = 0;
                foreach (var x in gtColl.Where(x => (Guars.Select(y => y.SRGuarantorType).Distinct()).Contains(x.ItemID)))
                {
                    bool[] IsDischargeds = new[] { true, false };

                    foreach (var IsDischarge in IsDischargeds)
                    {
                        // dari jurnal detail ambil guarantoridnya
                        decimal dgrVal = (from p in prsdColl
                                          join q in prsColl on p.ID equals q.ID
                                          where q.SRGuarantorType.Equals(x.ItemID) && p.IsRevenue == true && q.IsDischarged == IsDischarge
                                          select (p.Amount ?? 0)).Sum();
                        dgrVal -= (from q in prsColl
                                   where q.SRGuarantorType.Equals(x.ItemID) && q.IsDischarged == IsDischarge
                                   select (q.DownPayment ?? 0)).Sum();

                        if ((x.coaID ?? 0) != 0)
                        {
                            JournalTransactionDetails dGRType = new JournalTransactionDetails();
                            dGRType.AddNew();
                            dGRType.JournalId = entity.JournalId;
                            dGRType.ChartOfAccountId = ValidateCOA(x.coaID, coaColl,
                                string.Format("Standard Reference: GuarantorType: {0}", x.ItemName));
                            dGRType.SubLedgerId = x.subledgerID;
                            dGRType.Debit = dgrVal > 0 ? dgrVal : 0;
                            dGRType.Credit = dgrVal < 0 ? dgrVal * -1 : 0;
                            dGRType.Description = string.Format("Patient-{1} receivable until {0}, guarantor type: {2}",
                                date.ToShortDateString(),
                                IsDischarge ? "discharged" : "in-charge",
                                x.ItemName);
                            dGRType.DocumentNumber = entity.RefferenceNumber;

                            AddMoreInfo(dGRType, string.Empty, string.Empty, string.Empty, string.Empty,
                                null, string.Empty, string.Empty, string.Empty);
                            dGRType.Save();

                            totalDebit += dGRType.Debit.Value;
                            totalCredit += dGRType.Credit.Value;
                        }
                        else
                        {
                            if (IsDischarge)
                                dUnpammedDGRype_discharged += dgrVal;
                            else
                                dUnpammedDGRype_incharge += dgrVal;
                        }
                    }
                }

                int dAccPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
                if (dUnpammedDGRype_discharged != 0)
                {
                    //decimal revC = jtdRevColl.Sum(x => x.Credit.Value);
                    //decimal revD = jtdRevColl.Sum(x => x.Debit.Value);
                    //decimal dval = revC - revD - um;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccPatRec, coaColl, "AppParameter: coa_PatientReceivable");
                    d.SubLedgerId = 0;
                    d.Debit = dUnpammedDGRype_discharged > 0 ? dUnpammedDGRype_discharged : 0;
                    d.Credit = dUnpammedDGRype_discharged < 0 ? dUnpammedDGRype_discharged * -1 : 0;
                    d.Description = string.Format("Patient-discharged receivable until {0}", date.ToShortDateString());
                    d.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                if (dUnpammedDGRype_incharge != 0)
                {
                    //decimal revC = jtdRevColl.Sum(x => x.Credit.Value);
                    //decimal revD = jtdRevColl.Sum(x => x.Debit.Value);
                    //decimal dval = revC - revD - um;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccPatRec, coaColl, "AppParameter: coa_PatientReceivable");
                    d.SubLedgerId = 0;
                    d.Debit = dUnpammedDGRype_incharge > 0 ? dUnpammedDGRype_incharge : 0;
                    d.Credit = dUnpammedDGRype_incharge < 0 ? dUnpammedDGRype_incharge * -1 : 0;
                    d.Description = string.Format("Patient-in-charge receivable until {0}", date.ToShortDateString());
                    d.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                // end of create jurnal piutang dalam perawatan group by guarantor type

                // UM
                if (um > 0)
                {
                    var coaUM = GetCachedAccountFromParam("coa_DownPayment");

                    JournalTransactionDetails cum = new JournalTransactionDetails();
                    cum.AddNew();
                    cum.JournalId = entity.JournalId;
                    cum.ChartOfAccountId = ValidateCOA(coaUM, coaColl, "AppParameter: coa_DownPayment");
                    cum.SubLedgerId = 0;
                    cum.Debit = um > 0 ? um : 0;
                    cum.Credit = um < 0 ? um * -1 : 0;
                    cum.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    cum.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(cum, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    cum.Save();

                    totalDebit += cum.Debit.Value;
                    totalCredit += cum.Credit.Value;
                }

                // CREDIT
                // Revenue
                var newRevList = jtdRevColl.GroupBy(a => new { a.ChartOfAccountId, a.SubLedgerId })
                    .Select(b => new
                    {
                        CoaID = b.Key.ChartOfAccountId,
                        SlID = b.Key.SubLedgerId,
                        Debit = b.Sum(x => x.Debit),
                        Credit = b.Sum(x => x.Credit)
                    });

                foreach (var rev in newRevList)
                {
                    var cVal = rev.Debit - rev.Credit;
                    if (cVal == 0) continue; // tidak perlu dijurnal jika nominal 0;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(rev.CoaID, coaColl, "");
                    c.SubLedgerId = rev.SlID;
                    c.Debit = cVal > 0 ? cVal : 0;
                    c.Credit = cVal < 0 ? cVal * -1 : 0;
                    c.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    c.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;
                }

                /////////////////////////////////////////////////////
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                // try to save error
                var listUnMap = jtdRevColl.Where(x => x.ChartOfAccountId == 0 && x.IsRevenue == true)
                    .Select(x => new CoaMapping
                    {
                        ServiceUnitID = x.ServiceUnitID,
                        ItemID = x.ItemID,
                        TariffComponentID = x.TariffComponentID,
                        SRRegistrationType = x.SRRegistrationType
                    }).ToList();
                JournalErrorMessageSave(journalId, ex,
                    Newtonsoft.Json.JsonConvert.SerializeObject(listUnMap), editedBy);
                //JournalErrorMessageSave(journalId, ex,"", editedBy);
            }
            return journalId;
        }

        public static int? AddNewPatientReceivableJournal(string journalType, DateTime date, string editedBy, int journalId, bool IsAccountReceivableByDischargeDate)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            var isClosingPeriod = PostingStatus.IsPeriodeClosed(date);
            if (isClosingPeriod)
            {
                throw new Exception("Financial statements for period: " +
                                   string.Format("{0:MMMM-yyyy}", date) +
                                   " have been closed. Please contact the authorities.");
            }

            if (!IsAccountReceivableByDischargeDate) return AddNewPatientReceivableJournal_V2(journalType, date, editedBy, journalId);

            //var listRev = new RevenueList();
            var jtdRevColl = new JournalTransactionDetailsCollection();
            try
            {
                // jurnal ini tidak boleh double dalam satu tanggal
                var jt = new JournalTransactionsCollection();
                jt.Query.Where(jt.Query.TransactionDate == date,
                    jt.Query.JournalType == journalType,
                    jt.Query.IsVoid == false,
                    jt.Query.JournalIdRefference.IsNull());
                jt.LoadAll();
                if (jt.Count > 0)
                {
                    journalId = jt[0].JournalId ?? 0;
                }

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(entity);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    entity.IsVoid = false;

                    // rejournal tidak usah update last update
                    entity.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(entity);

                    entity.Save();
                }
                else
                {
                    entity = new JournalTransactions();
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("PRV", date);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = date;
                    entity.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = "PRV-" + date.ToString("yyyy/MM/dd");

                    entity.Save();
                    ValidateClosingPeriode(entity);
                }

                journalId = entity.JournalId.Value;

                // ambil pasien RI yang belum pulang pada tanggal @date
                var regq = new RegistrationQuery("reg");
                var mbq = new MergeBillingQuery("mb");
                regq.LeftJoin(mbq).On(regq.RegistrationNo == mbq.RegistrationNo)
                    .Where(
                        regq.IsVoid == false,
                        regq.SRRegistrationType == "IPR",
                        regq.RegistrationDate <= date,
                        mbq.FromRegistrationNo == string.Empty
                    ).Where(regq.Or(
                        regq.DischargeDate.IsNull(), // ambil yang belum pulang
                        regq.DischargeDate > date // atau yang pulang setelah tanggal param
                        )
                    )
                    .Select(
                        regq.RegistrationNo,
                        regq.RegistrationNo.As("RegistrationNoMB"),
                        regq.RegistrationDate,
                        regq.DischargeDate,
                        regq.GuarantorID
                    );
                var dttblReg = regq.LoadDataTable();
                // gabung dengan yang mergebilling
                var regq2 = new RegistrationQuery("reg2");
                var regq21 = new RegistrationQuery("reg21");
                var mbq2 = new MergeBillingQuery("mb2");
                regq2.InnerJoin(mbq2).On(regq2.RegistrationNo == mbq2.FromRegistrationNo)
                    .InnerJoin(regq21).On(mbq2.RegistrationNo == regq21.RegistrationNo)
                    .Where(
                        regq2.IsVoid == false,
                        regq21.IsVoid == false,
                        regq2.SRRegistrationType == "IPR",
                        regq2.RegistrationDate <= date
                    ).Where(regq2.Or(
                        regq2.DischargeDate.IsNull(), // ambil yang belum pulang
                        regq2.DischargeDate > date // atau yang pulang setelah tanggal param
                        )
                    )
                    .Select(
                        regq21.RegistrationNo,
                        regq2.RegistrationNo.As("RegistrationNoMB"),
                        regq21.RegistrationDate,
                        regq2.DischargeDate,
                        regq21.GuarantorID
                    );
                dttblReg.Merge(regq2.LoadDataTable());

                if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsJournalPatReceivedIGD))
                { // IGD
                  // ambil pasien IGD yang belum pulang pada tanggal @date
                    var regq3 = new RegistrationQuery("reg");
                    var mbq3 = new MergeBillingQuery("mb");
                    regq3.LeftJoin(mbq3).On(regq3.RegistrationNo == mbq3.RegistrationNo)
                        .Where(
                            regq3.IsVoid == false,
                            regq3.SRRegistrationType == "EMR",
                            regq3.RegistrationDate <= date,
                            regq3.RegistrationDate > date.AddDays(3), // << optimasi query
                            mbq3.FromRegistrationNo == string.Empty
                        ).Where(regq3.Or(
                            regq3.DischargeDate.IsNull(), // ambil yang belum pulang
                            regq3.DischargeDate > date // atau yang pulang setelah tanggal param
                            )
                        )
                        .Select(
                            regq3.RegistrationNo,
                            regq3.RegistrationNo.As("RegistrationNoMB"),
                            regq3.RegistrationDate,
                            regq3.DischargeDate,
                            regq3.GuarantorID
                        );
                    dttblReg.Merge(regq3.LoadDataTable());
                }

                var prsColl = new PatientReceivableMonthlySummaryCollection();
                var prsdColl = new PatientReceivableMonthlySummaryDetailCollection();

                prsColl.Query.Where(prsColl.Query.Period.Equal(date));
                prsColl.LoadAll();

                var prsq = new PatientReceivableMonthlySummaryQuery("a");
                var prsdq = new PatientReceivableMonthlySummaryDetailQuery("b");

                prsdq.InnerJoin(prsq).On(prsdq.ID.Equal(prsq.ID))
                    .Where(prsq.Period.Equal(date))
                    .Select(prsdq);
                prsdColl.Load(prsdq);

                prsdColl.MarkAllAsDeleted();
                prsColl.MarkAllAsDeleted();
                prsdColl.Save();
                prsColl.Save();

                var coaColl = new ChartOfAccountsCollection();

                decimal um = 0;
                string errMsg = string.Empty;
                foreach (System.Data.DataRow row in dttblReg.Rows)
                {
                    var RegNo = row["RegistrationNo"].ToString();

                    var reg = new Registration();
                    reg.LoadByPrimaryKey(RegNo);
                    var guar = new Guarantor();
                    guar.LoadByPrimaryKey(reg.GuarantorID);

                    var prs = prsColl.Where(p => p.RegistrationNo.Equals(RegNo)).FirstOrDefault();
                    if (prs == null)
                    {
                        prs = prsColl.AddNew();
                        prs.Period = date;
                        prs.RegistrationNo = RegNo;
                        prs.DownPayment = 0;
                        prs.CreateByUserID = editedBy;
                        prs.CreateDateTime = DateTime.Now;
                    }
                    prs.GuarantorID = reg.GuarantorID;
                    prs.SRGuarantorType = guar.SRGuarantorType;

                    #region Uang Muka
                    //// ambil uang muka yang masih valid/outstanding sampai dengan tanggal param
                    //var tpiColl = new TransPaymentItemCollection();
                    //var tpQ = new TransPaymentQuery("tp");
                    //var tpiQ = new TransPaymentItemQuery("tpi");
                    //var tpiRetQ = new TransPaymentItemQuery("tpiRet");
                    //var tpRetQ = new TransPaymentQuery("tpRet");
                    //var tpPay = new TransPaymentQuery("tpPay");

                    //tpiQ.InnerJoin(tpQ).On(tpQ.PaymentNo == tpiQ.PaymentNo)
                    //    .LeftJoin(tpiRetQ).On(tpQ.PaymentNo == tpiRetQ.ReferenceNo)
                    //    .LeftJoin(tpRetQ).On(tpiRetQ.PaymentNo == tpRetQ.PaymentNo && tpRetQ.IsApproved == true &&
                    //        tpRetQ.IsVoid == false && tpRetQ.PaymentDate.Date() <= date)
                    //    .LeftJoin(tpPay).On(tpQ.PaymentReferenceNo == tpPay.PaymentNo && tpPay.IsApproved == true &&
                    //        tpPay.IsVoid == false && tpPay.PaymentDate.Date() <= date)
                    //    .Where(
                    //        tpQ.RegistrationNo == RegNo,
                    //        tpQ.IsApproved == true,
                    //        tpQ.IsVoid == false,
                    //        tpQ.TransactionCode == "018",
                    //        "<ISNULL(tpPay.PaymentNo,'') = ''>",//tpQ.PaymentReferenceNo == string.Empty,
                    //        "<ISNULL(tpRet.PaymentNo,'') = ''>",
                    //        tpQ.PaymentDate.Date() <= date)
                    //    //"<CAST(tp.PaymentDate as DATE) <= " + date.ToShortDateString() + ">")
                    //    .Select(tpiQ);
                    //if (tpiColl.Load(tpiQ))
                    //{
                    //    var _um = tpiColl.Sum(x => x.Amount).Value;
                    //    prs.DownPayment = _um;
                    //    prs.LastUpdateByUserID = editedBy;
                    //    prs.LastUpdateDateTime = DateTime.Now;

                    //    um += _um;
                    //}
                    //prsColl.Save();
                    #endregion Uang Muka

                    #region Uang Muka 
                    // ambil uang muka yang masih valid/outstanding sampai dengan tanggal param
                    var tpiColl = new TransPaymentItemCollection();
                    var tpQ = new TransPaymentQuery("tp");
                    var tpiQ = new TransPaymentItemQuery("tpi");
                    var tpPay = new TransPaymentQuery("tpPay");

                    tpiQ.InnerJoin(tpQ).On(tpQ.PaymentNo == tpiQ.PaymentNo)

                        .LeftJoin(tpPay).On(tpQ.PaymentReferenceNo == tpPay.PaymentNo && tpPay.IsApproved == true &&
                            tpPay.IsVoid == false && tpPay.PaymentDate.Date() <= date)
                        .Where(
                            tpQ.RegistrationNo == RegNo,
                            tpQ.IsApproved == true,
                            tpQ.IsVoid == false,
                            tpQ.TransactionCode == "018",
                            "<ISNULL(tpPay.PaymentNo,'') = ''>",//tpQ.PaymentReferenceNo == string.Empty,
                            tpQ.PaymentDate.Date() <= date)
                        //"<CAST(tp.PaymentDate as DATE) <= " + date.ToShortDateString() + ">")
                        .Select(tpiQ);
                    if (tpiColl.Load(tpiQ))
                    {
                        decimal _um = 0;

                        // Return UM
                        var tpiRetColl = new TransPaymentItemCollection();
                        var tpiRetQ = new TransPaymentItemQuery("tpiRet");
                        var tpRetQ = new TransPaymentQuery("tpRet");
                        //.LeftJoin(tpiRetQ).On(tpQ.PaymentNo == tpiRetQ.ReferenceNo)
                        tpiRetQ.InnerJoin(tpRetQ).On(tpiRetQ.PaymentNo == tpRetQ.PaymentNo)
                        .Where(
                            tpiRetQ.ReferenceNo.In(tpiColl.Select(tpi => tpi.PaymentNo)),
                            tpRetQ.IsApproved == true,
                            tpRetQ.IsVoid == false,
                            tpRetQ.PaymentDate.Date() <= date);
                        if (tpiRetColl.Load(tpiRetQ))
                        {
                            var tpis = tpiColl.Where(tpi => !tpiRetColl.Select(tr => tr.ReferenceNo).Contains(tpi.PaymentNo));
                            if (tpis.Any())
                            {
                                _um = tpis.Sum(x => x.Amount).Value;
                            }
                        }
                        else
                        {
                            _um = tpiColl.Sum(x => x.Amount).Value;
                        }

                        prs.DownPayment = _um;
                        prs.LastUpdateByUserID = editedBy;
                        prs.LastUpdateDateTime = DateTime.Now;

                        um += _um;
                    }
                    prsColl.Save();
                    #endregion Uang Muka


                    // ambil transaksi per registrasi yang belum ada pembayarannya
                    // pada tanggal param dan tanggal transaksi tidak lebih dari tanggal param

                    var ccColl = new CostCalculationCollection();
                    var cc = new CostCalculationQuery("cc");
                    var tpiig = new TransPaymentItemIntermBillGuarantorQuery("tpiig");
                    var tpg = new TransPaymentQuery("tpg");
                    var tpii = new TransPaymentItemIntermBillQuery("tpii");
                    var tp = new TransPaymentQuery("tp");
                    var tpio = new TransPaymentItemOrderQuery("tpio");
                    var t = new TransPaymentQuery("t");
                    var tc = new TransChargesQuery("tc");
                    var tpr = new TransPrescriptionQuery("tpr");

                    cc.LeftJoin(tpiig).On(cc.IntermBillNo == tpiig.IntermBillNo && tpiig.IsPaymentProceed == true)
                        .LeftJoin(tpg).On(tpiig.PaymentNo == tpg.PaymentNo &&
                            tpg.IsVoid == false && tpg.IsApproved == true && tpg.PaymentDate <= date)

                        .LeftJoin(tpii).On(cc.IntermBillNo == tpii.IntermBillNo && tpii.IsPaymentProceed == true)
                        .LeftJoin(tp).On(tpii.PaymentNo == tp.PaymentNo &&
                            tp.IsVoid == false && tp.IsApproved == true && tp.PaymentDate <= date)

                        .LeftJoin(tpio).On(cc.TransactionNo == tpio.TransactionNo && cc.SequenceNo == tpio.SequenceNo)
                        .LeftJoin(t).On(tpio.PaymentNo == t.PaymentNo &&
                            t.IsVoid == false && t.IsApproved == true && t.PaymentDate <= date)
                        .LeftJoin(tc).On(cc.TransactionNo == tc.TransactionNo)
                        .LeftJoin(tpr).On(cc.TransactionNo == tpr.PrescriptionNo)

                        .Where(cc.RegistrationNo == RegNo, "<CAST(ISNULL(tc.ExecutionDate, tpr.PrescriptionDate) AS DATE) <= CAST('" + date.ToString("yyyy-MM-dd") + "' AS DATE)>")
                        .Select(cc,
                            "<ISNULL(tpg.PaymentNo,ISNULL(tp.PaymentNo,ISNULL(t.PaymentNo,''))) refToPayment_PaymentNo>"
                        );
                    ccColl.Load(cc);
                    var jtdRegColl = new JournalTransactionDetailsCollection();
                    foreach (var c in ccColl)
                    {
                        // jika salah satu payment ada nomornya berarti transaksi ini sudah ada payment
                        // jangan dijurnal sebagai jurnal piutang dalam perawatan
                        if (c.PaymentNo == string.Empty)
                        {
                            //var sMsg = GetRevenueByCC(c, _listRev, false);
                            //if (!sMsg.Equals(string.Empty))
                            //{
                            //    errMsg += sMsg + System.Environment.NewLine;
                            //}

                            if (c.ItemID == "DON-0021")
                            {
                                c.ItemID = c.ItemID;
                            }

                            var jtdColl = GetNewIncomeJournalCashBased(entity, c, false, 0, coaColl, true);
                            foreach (var jtd in jtdColl)
                            {
                                if (!string.IsNullOrEmpty(jtd.ErrorMsg))
                                    errMsg += jtd.ErrorMsg + System.Environment.NewLine;
                            }
                            jtdRegColl.Combine(jtdColl);
                            //foreach (var jtd in jtdColl) {
                            //    jtdRegColl.AttachEntity(jtd);
                            //}
                        }
                    }

                    // summarydetail
                    //foreach (var rev in _listRev.Revenues.Where(x => x.IsRevenue.Equals(true)))
                    //foreach (var rev in jtdRegColl.Where(x => x.IsRevenue.Equals(true)))
                    foreach (var rev in jtdRegColl)
                    {
                        var p = prsdColl.AddNew();
                        p.ID = prs.ID;
                        p.ChartOfAccountId = rev.ChartOfAccountId;
                        p.SRBillingGroup = rev.SRBillingGroup;
                        p.Amount = rev.Credit - rev.Debit;
                        p.CreateByUserID = editedBy;
                        p.CreateDateTime = DateTime.Now;
                        p.LastUpdateByUserID = editedBy;
                        p.LastUpdateDateTime = DateTime.Now;
                        p.ClassID = rev.ClassID;
                        p.ParamedicID = rev.ParamedicID;
                        p.ServiceUnitID = rev.ServiceUnitID;
                        p.ItemID = rev.ItemID;
                        p.TransactionNo = rev.DocumentNumber;
                        p.SequenceNo = rev.DocumentNumberSequenceNo;
                        p.IsRevenue = rev.IsRevenue;
                    }
                    prsdColl.Save();

                    jtdRevColl.Combine(jtdRegColl);

                    //foreach (var r in _listRev.Revenues)
                    //{
                    //    listRev.Revenues.Add(r);
                    //    //listRev.Add(r.CoaID, r.SlID, r.SRBillingGroup, r.IsRevenue, r.Debit, r.Credit, r.ser);
                    //}
                }
                //if (listRev.Revenues.Count == 0) return 0;
                if (jtdRevColl.Count == 0) return 0;

                foreach (var prs in prsColl)
                {
                    prs.JournalId = journalId;
                }
                prsColl.Save();

                if (!errMsg.Equals(string.Empty)) throw new Exception(errMsg);

                decimal totalDebit = 0, totalCredit = 0;

                // DEBIT
                // create jurnal piutang dalam perawatan group by guarantor type
                var guarids = dttblReg.AsEnumerable().Select(x => x["GuarantorID"].ToString()).ToArray().Distinct();
                var Guars = new GuarantorCollection();
                if (guarids.Count() > 0)
                {
                    Guars.Query.Where(Guars.Query.GuarantorID.In(guarids));
                    Guars.LoadAll();
                }
                var gtColl = new AppStandardReferenceItemCollection();
                gtColl.Query.Where(
                    gtColl.Query.StandardReferenceID == "GuarantorType"
                    );
                gtColl.LoadAll();

                decimal dUnpammedDGRype = 0;
                decimal dUM = 0;
                foreach (var x in gtColl.Where(x => (Guars.Select(y => y.SRGuarantorType).Distinct()).Contains(x.ItemID)))
                {
                    // dari jurnal detail ambil guarantoridnya
                    decimal dgrVal = (from p in prsdColl
                                      join q in prsColl on p.ID equals q.ID
                                      where q.SRGuarantorType.Equals(x.ItemID) && p.IsRevenue == true
                                      select (p.Amount ?? 0)).Sum();
                    dgrVal -= (from q in prsColl
                               where q.SRGuarantorType.Equals(x.ItemID)
                               select (q.DownPayment ?? 0)).Sum();

                    if ((x.coaID ?? 0) != 0)
                    {
                        JournalTransactionDetails dGRType = new JournalTransactionDetails();
                        dGRType.AddNew();
                        dGRType.JournalId = entity.JournalId;
                        dGRType.ChartOfAccountId = ValidateCOA(x.coaID, coaColl,
                            string.Format("Standard Reference: GuarantorType: {0}", x.ItemName));
                        dGRType.SubLedgerId = x.subledgerID;
                        dGRType.Debit = dgrVal > 0 ? dgrVal : 0;
                        dGRType.Credit = dgrVal < 0 ? dgrVal * -1 : 0;
                        dGRType.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                        dGRType.DocumentNumber = entity.RefferenceNumber;

                        AddMoreInfo(dGRType, string.Empty, string.Empty, string.Empty, string.Empty,
                            null, string.Empty, string.Empty, string.Empty);
                        dGRType.Save();

                        totalDebit += dGRType.Debit.Value;
                        totalCredit += dGRType.Credit.Value;
                    }
                    else
                    {
                        dUnpammedDGRype += dgrVal;
                    }
                }
                if (dUnpammedDGRype != 0)
                {
                    int dAccPatRec = GetCachedAccountFromParam("coa_PatientReceivable");
                    //decimal revC = jtdRevColl.Sum(x => x.Credit.Value);
                    //decimal revD = jtdRevColl.Sum(x => x.Debit.Value);
                    //decimal dval = revC - revD - um;

                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = ValidateCOA(dAccPatRec, coaColl, "AppParameter: coa_PatientReceivable");
                    d.SubLedgerId = 0;
                    d.Debit = dUnpammedDGRype > 0 ? dUnpammedDGRype : 0;
                    d.Credit = dUnpammedDGRype < 0 ? dUnpammedDGRype * -1 : 0;
                    d.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    d.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(d, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                // end of create jurnal piutang dalam perawatan group by guarantor type

                // UM
                if (um > 0)
                {
                    var coaUM = GetCachedAccountFromParam("coa_DownPayment");

                    JournalTransactionDetails cum = new JournalTransactionDetails();
                    cum.AddNew();
                    cum.JournalId = entity.JournalId;
                    cum.ChartOfAccountId = ValidateCOA(coaUM, coaColl, "AppParameter: coa_DownPayment");
                    cum.SubLedgerId = 0;
                    cum.Debit = um > 0 ? um : 0;
                    cum.Credit = um < 0 ? um * -1 : 0;
                    cum.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    cum.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(cum, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    cum.Save();

                    totalDebit += cum.Debit.Value;
                    totalCredit += cum.Credit.Value;
                }

                // CREDIT
                // Revenue
                var newRevList = jtdRevColl.GroupBy(a => new { a.ChartOfAccountId, a.SubLedgerId })
                    .Select(b => new
                    {
                        CoaID = b.Key.ChartOfAccountId,
                        SlID = b.Key.SubLedgerId,
                        Debit = b.Sum(x => x.Debit),
                        Credit = b.Sum(x => x.Credit)
                    });

                foreach (var rev in newRevList)
                {
                    var cVal = rev.Debit - rev.Credit;
                    if (cVal == 0) continue; // tidak perlu dijurnal jika nominal 0;

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = ValidateCOA(rev.CoaID, coaColl, "");
                    c.SubLedgerId = rev.SlID;
                    c.Debit = cVal > 0 ? cVal : 0;
                    c.Credit = cVal < 0 ? cVal * -1 : 0;
                    c.Description = string.Format("Patient receivable until {0}", date.ToShortDateString());
                    c.DocumentNumber = entity.RefferenceNumber;

                    AddMoreInfo(c, string.Empty, string.Empty, string.Empty, string.Empty,
                        null, string.Empty, string.Empty, string.Empty);
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;
                }

                /////////////////////////////////////////////////////
                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        entity.BeginEdit();
                        entity.IsPosted = true;
                        entity.EndEdit();
                        entity.Save();
                    }
                }
                return entity.JournalId;
            }

            catch (Exception ex)
            {
                //Logger.LogException(ex);
                // try to save error
                var listUnMap = jtdRevColl.Where(x => x.ChartOfAccountId == 0 && x.IsRevenue == true)
                    .Select(x => new CoaMapping
                    {
                        ServiceUnitID = x.ServiceUnitID,
                        ItemID = x.ItemID,
                        TariffComponentID = x.TariffComponentID,
                        SRRegistrationType = x.SRRegistrationType
                    }).ToList();
                JournalErrorMessageSave(journalId, ex,
                    Newtonsoft.Json.JsonConvert.SerializeObject(listUnMap), editedBy);
                //JournalErrorMessageSave(journalId, ex,"", editedBy);
            }
            return journalId;
        }

        public static int? AddNewPatientReceivableJournalReversed(string journalType, DateTime date, DateTime refDate,
            string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference && qh2.IsVoid == false);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull(), qh.TransactionDate == refDate, qh.IsVoid == false);
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(
                qh.JournalType == journalType,
                qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                return AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "PRV", editedBy, date, "Reverse");
            }
        }


        public static int? AddNewPayrollJournal(int payrollPeriodId, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.Payroll;

            try
            {
                // BANK (C)
                // BIAYA GAJI (D)
                // POTONGAN (C)

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                int typeId = 1;

                var wtColl = new WageTransactionCollection();
                wtColl.Query.Where(wtColl.Query.WageProcessTypeID == typeId, wtColl.Query.PayrollPeriodID == payrollPeriodId);
                if (!wtColl.Query.Load())
                    return 0;

                var pp = new PayrollPeriod();
                pp.LoadByPrimaryKey(payrollPeriodId);

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("PYR", pp.PayDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                JournalTransactions header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.IsVoid = false;

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header = new JournalTransactions();
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = pp.PayDate;
                    header.Description = string.Format("PAYROLL #:{0}.", pp.PayrollPeriodName);
                    header.IsPosted = false;
                    header.DateCreated = header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = "PYR" + pp.PayrollPeriodCode.Trim();

                    header.Save();
                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var takeHomePay = new AppParameter();
                takeHomePay.LoadByPrimaryKey("SalaryTypeTakeHomePay");

                //CREDIT (JUMLAH PEMBAYARAN GAJI)
                var wtiQ = new WageTransactionItemQuery("a");
                var wtQ = new WageTransactionQuery("b");
                var scQ = new SalaryComponentQuery("c");
                var esiQ = new EmployeeSalaryInfoQuery("d");
                var asriQ = new AppStandardReferenceItemQuery("e");
                var coaQ = new ChartOfAccountsQuery("f");

                wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                wtiQ.InnerJoin(esiQ).On(esiQ.PersonID == wtQ.PersonID);
                wtiQ.InnerJoin(asriQ).On(asriQ.StandardReferenceID == "BankHRD" && asriQ.ItemID == esiQ.BankID);
                wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == asriQ.coaID);

                wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType == takeHomePay.ParameterValue);

                wtiQ.Select(asriQ.ItemName, asriQ.coaID, asriQ.subledgerID, wtiQ.NominalAmount.Sum().As("NominalAmount"));
                wtiQ.GroupBy(asriQ.ItemName, asriQ.coaID, asriQ.subledgerID);

                var wtiDtb = wtiQ.LoadDataTable();

                foreach (DataRow row in wtiDtb.Rows)
                {
                    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    {
                        var d = new JournalTransactionDetails
                        {
                            JournalId = journalId,
                            ChartOfAccountId = row["coaID"].ToInt(),
                            SubLedgerId = row["subledgerID"].ToInt(),
                            Debit = 0,
                            Credit = Convert.ToDecimal(row["NominalAmount"]),
                            Description = string.Format("PAYROLL #:{0}. BANK:{1}.", pp.PayrollPeriodName, row["ItemName"].ToString()),
                            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                        };
                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                    }
                }

                bool defNb = false;
                //var nb = new AppParameter();
                //if (nb.LoadByPrimaryKey("acc_IsJournalPayrollWithDefaultNormalBalance"))
                //    defNb = nb.ParameterValue.ToLower() == "yes";


                bool isUsingDirectIndirectCost = false;
                var dic = new AppParameter();
                if (dic.LoadByPrimaryKey("acc_IsJournalPayrollWithDirectIndirectCost"))
                    isUsingDirectIndirectCost = dic.ParameterValue.ToLower() == "yes";

                if (!isUsingDirectIndirectCost)
                {
                    #region -old-
                    ////DEBET (SALARY COMPONENT)
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //var orgQ = new OrganizationUnitQuery("f");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && coaQ.NormalBalance == "D");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "D");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue);

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountId,
                    //    @"<CASE WHEN ISNULL(c.SubLedgerId, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerId END AS SubLedgerId>",
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(
                    //    @"<c.SalaryComponentName>",
                    //    @"<c.ChartOfAccountId>",
                    //    @"<CASE WHEN ISNULL(c.SubLedgerId, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerId END>"
                    //    );

                    //var wtiDtb1 = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb1.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Credit = 0,
                    //            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    ////CREDIT (SALARY COMPONENT)
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && coaQ.NormalBalance == "K");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "K");

                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue);

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountId,
                    //    @"<CASE WHEN ISNULL(c.SubLedgerId, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerId END AS SubLedgerId>",
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(
                    //    @"<c.SalaryComponentName>",
                    //    @"<c.ChartOfAccountId>",
                    //    @"<CASE WHEN ISNULL(c.SubLedgerId, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerId END>"
                    //    );

                    //var wtiDtb2 = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb2.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = 0,
                    //            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}
                    #endregion

                    //DEBET - CREDIT (SALARY COMPONENT)
                    wtiQ = new WageTransactionItemQuery("a");
                    wtQ = new WageTransactionQuery("b");
                    scQ = new SalaryComponentQuery("c");
                    coaQ = new ChartOfAccountsQuery("d");
                    var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    var orgQ = new OrganizationUnitQuery("f");

                    wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId);
                    wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue);

                    wtiQ.Select(scQ.SalaryComponentCode.Ascending, scQ.SalaryComponentName, scQ.ChartOfAccountId,
                        @"<CASE WHEN ISNULL(c.SubLedgerId, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerId END AS SubLedgerId>",
                        scQ.NormalBalance,
                        wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    wtiQ.GroupBy(
                        scQ.SalaryComponentCode,
                        scQ.SalaryComponentName,
                        scQ.ChartOfAccountId,
                        @"<CASE WHEN ISNULL(c.SubLedgerId, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerId END>",
                        scQ.NormalBalance
                        );
                    wtiQ.Having(wtiQ.NominalAmount.Sum() > 0);
                    wtiQ.OrderBy(scQ.NormalBalance.Ascending, scQ.SalaryComponentCode.Ascending);

                    var wtiDtb1 = wtiQ.LoadDataTable();

                    foreach (DataRow row in wtiDtb1.Rows)
                    {
                        if (row["NormalBalance"].ToString() == "D")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = Convert.ToDecimal(row["NominalAmount"]),
                                Credit = 0,
                                Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else if (row["NormalBalance"].ToString() == "K")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = 0,
                                Credit = Convert.ToDecimal(row["NominalAmount"]),
                                Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                    }
                }
                else
                {
                    #region -old-
                    //#region - DEBET (SALARY COMPONENT) - GLOBAL 
                    //////DEBET (SALARY COMPONENT) - GLOBAL 
                    ////wtiQ = new WageTransactionItemQuery("a");
                    ////wtQ = new WageTransactionQuery("b");
                    ////scQ = new SalaryComponentQuery("c");
                    ////coaQ = new ChartOfAccountsQuery("d");
                    //////var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //////var orgQ = new OrganizationUnitQuery("f");

                    ////wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    ////wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && coaQ.NormalBalance == "D");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "D");
                    //////wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //////wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    ////wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue,
                    ////    scQ.SubLedgerId.IsNotNull(), scQ.SubLedgerId > 0);

                    ////wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountId, scQ.SubLedgerId,
                    ////    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    ////wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountId, scQ.SubLedgerId);

                    ////var wtiDtb1 = wtiQ.LoadDataTable();

                    ////foreach (DataRow row in wtiDtb1.Rows)
                    ////{
                    ////    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    ////    {
                    ////        var d = new JournalTransactionDetails
                    ////        {
                    ////            JournalId = journalId,
                    ////            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    ////            SubLedgerId = row["SubLedgerId"].ToInt(),
                    ////            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    ////            Credit = 0,
                    ////            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    ////            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    ////        };
                    ////        d.Save();

                    ////        totalDebit += d.Debit.Value;
                    ////        totalCredit += d.Credit.Value;
                    ////    }
                    ////}
                    //#endregion

                    ////DEBET (SALARY COMPONENT) - DIRECT COST
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //var orgQ = new OrganizationUnitQuery("f");
                    //var slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && coaQ.NormalBalance == "D");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "D");
                    //wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "D");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == true);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue,
                    //    wtiQ.Or(scQ.SubLedgerId.IsNull(), scQ.SubLedgerId == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountId, orgQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountId, orgQ.SubLedgerId);

                    //var wtiDtb1a = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb1a.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Credit = 0,
                    //            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    ////DEBET (SALARY COMPONENT) - INDIRECT COST
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");
                    //slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect && coaQ.NormalBalance == "D");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect && scQ.NormalBalanceIndirect == "D");
                    //wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect && scQ.NormalBalanceIndirect == "D");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == false);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue,
                    //    wtiQ.Or(scQ.SubLedgerId.IsNull(), scQ.SubLedgerId == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdIndirect.As("ChartOfAccountId"), orgQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdIndirect, orgQ.SubLedgerId);

                    //var wtiDtb1b = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb1b.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Credit = 0,
                    //            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    //#region - CREDIT (SALARY COMPONENT) - GLOBAL
                    //////CREDIT (SALARY COMPONENT) - GLOBAL
                    ////wtiQ = new WageTransactionItemQuery("a");
                    ////wtQ = new WageTransactionQuery("b");
                    ////scQ = new SalaryComponentQuery("c");
                    ////coaQ = new ChartOfAccountsQuery("d");
                    //////empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //////orgQ = new OrganizationUnitQuery("f");

                    ////wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    ////wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && coaQ.NormalBalance == "K");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "K");

                    //////wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //////wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    ////wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue);

                    ////wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue,
                    ////    scQ.SubLedgerId.IsNotNull(), scQ.SubLedgerId > 0);

                    ////wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountId, scQ.SubLedgerId,
                    ////    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    ////wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountId, scQ.SubLedgerId);

                    ////var wtiDtb2 = wtiQ.LoadDataTable();

                    ////foreach (DataRow row in wtiDtb2.Rows)
                    ////{
                    ////    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    ////    {
                    ////        var d = new JournalTransactionDetails
                    ////        {
                    ////            JournalId = journalId,
                    ////            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    ////            SubLedgerId = row["SubLedgerId"].ToInt(),
                    ////            Debit = 0,
                    ////            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    ////            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    ////            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    ////        };
                    ////        d.Save();

                    ////        totalDebit += d.Debit.Value;
                    ////        totalCredit += d.Credit.Value;
                    ////    }
                    ////}
                    //#endregion

                    ////CREDIT (SALARY COMPONENT) - DIRECT COST
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");
                    //slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && coaQ.NormalBalance == "K");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "K");
                    //wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId && scQ.NormalBalance == "K");

                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == true);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue,
                    //    wtiQ.Or(scQ.SubLedgerId.IsNull(), scQ.SubLedgerId == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountId.As("ChartOfAccountId"), orgQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountId, orgQ.SubLedgerId);

                    //var wtiDtb2a = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb2a.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = 0,
                    //            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    ////CREDIT (SALARY COMPONENT) - INDIRECT COST
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");
                    //slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect && coaQ.NormalBalance == "K");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect && scQ.NormalBalance == "K");
                    //wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect && scQ.NormalBalance == "K");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == false);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue,
                    //    wtiQ.Or(scQ.SubLedgerId.IsNull(), scQ.SubLedgerId == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdIndirect.As("ChartOfAccountId"), orgQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdIndirect, orgQ.SubLedgerId);

                    //var wtiDtb2b = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb2b.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = 0,
                    //            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}
                    #endregion

                    //DEBET - CREDIT (SALARY COMPONENT) - DIRECT COST
                    wtiQ = new WageTransactionItemQuery("a");
                    wtQ = new WageTransactionQuery("b");
                    scQ = new SalaryComponentQuery("c");
                    coaQ = new ChartOfAccountsQuery("d");
                    var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    var orgQ = new OrganizationUnitQuery("f");
                    var slQ = new SubLedgersQuery("sl");

                    wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountId);
                    wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == true);

                    wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue);

                    wtiQ.Select(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountId, orgQ.SubLedgerId, scQ.NormalBalance,
                        wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    wtiQ.GroupBy(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountId, orgQ.SubLedgerId, scQ.NormalBalance);
                    wtiQ.Having(wtiQ.NominalAmount.Sum() > 0);
                    wtiQ.OrderBy(scQ.NormalBalance.Ascending, scQ.SalaryComponentCode.Ascending);

                    var wtiDtb1a = wtiQ.LoadDataTable();

                    foreach (DataRow row in wtiDtb1a.Rows)
                    {
                        if (row["NormalBalance"].ToString() == "D")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = Convert.ToDecimal(row["NominalAmount"]),
                                Credit = 0,
                                Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;

                        }
                        else if (row["NormalBalance"].ToString() == "K")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = 0,
                                Credit = Convert.ToDecimal(row["NominalAmount"]),
                                Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                    }

                    //DEBET - CREDIT (SALARY COMPONENT) - INDIRECT COST
                    wtiQ = new WageTransactionItemQuery("a");
                    wtQ = new WageTransactionQuery("b");
                    scQ = new SalaryComponentQuery("c");
                    coaQ = new ChartOfAccountsQuery("d");
                    empQ = new VwEmployeeOrganizationUnitQuery("e");
                    orgQ = new OrganizationUnitQuery("f");
                    slQ = new SubLedgersQuery("sl");

                    wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdIndirect);
                    wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == false);

                    wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, scQ.SRSalaryType != takeHomePay.ParameterValue);

                    wtiQ.Select(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdIndirect.As("ChartOfAccountId"), orgQ.SubLedgerId, scQ.NormalBalanceIndirect.As("NormalBalance"),
                        wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    wtiQ.GroupBy(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdIndirect, orgQ.SubLedgerId, scQ.NormalBalanceIndirect);
                    wtiQ.Having(wtiQ.NominalAmount.Sum() > 0);
                    wtiQ.OrderBy(scQ.NormalBalanceIndirect.Ascending, scQ.SalaryComponentCode.Ascending);

                    var wtiDtb1b = wtiQ.LoadDataTable();

                    foreach (DataRow row in wtiDtb1b.Rows)
                    {
                        if (row["NormalBalance"].ToString() == "D")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = Convert.ToDecimal(row["NominalAmount"]),
                                Credit = 0,
                                Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else if (row["NormalBalance"].ToString() == "K")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountId"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = 0,
                                Credit = Convert.ToDecimal(row["NominalAmount"]),
                                Description = string.Format("PAYROLL #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                    }
                }

                if (totalCredit != totalDebit & Math.Abs(totalCredit - totalDebit) <= 1000)
                {
                    //selisih pembulatan
                    var coa_selisih = GetCachedAccountFromParam("coa_RoundingPayroll");
                    if (coa_selisih != 0)
                    {
                        var coaColl = new ChartOfAccountsCollection();

                        int sl_selisih = 0;
                        var param = new AppParameter();
                        if (param.LoadByPrimaryKey("SubLedgerCodeRoundingPayroll"))
                        {
                            if (!string.IsNullOrEmpty(param.ParameterValue))
                            {
                                var param2 = new AppParameter();
                                param2.LoadByPrimaryKey("SubLedgerGroupIdServiceUnit");
                                var subledgerQ = new SubLedgersQuery();
                                subledgerQ.Where(subledgerQ.GroupId == param2.ParameterValue.ToInt(), subledgerQ.SubLedgerName == param.ParameterValue);
                                var subledger = new SubLedgers();
                                if (subledger.Load(subledgerQ) && subledger != null)
                                {
                                    sl_selisih = subledger.SubLedgerId ?? 0;
                                }
                            }
                        }

                        decimal debit = 0, credit = 0;
                        if (totalCredit > totalDebit)
                            debit = totalCredit - totalDebit;
                        else
                            credit = totalDebit - totalCredit;

                        var sl = new JournalTransactionDetails
                        {
                            JournalId = journalId,
                            ChartOfAccountId = ValidateCOA(coa_selisih, coaColl, "AppParameter: coa_RoundingPayroll"),
                            SubLedgerId = sl_selisih,
                            Debit = debit,
                            Credit = credit,
                            Description = string.Format("PAYROLL #:{0} - PEMBULATAN.", pp.PayrollPeriodName),
                            DocumentNumber = "PYR" + pp.PayrollPeriodCode.Trim()
                        };
                        sl.Save();

                        totalDebit += sl.Debit.Value;
                        totalCredit += sl.Credit.Value;
                    }
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayroll) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return journalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewThrJournal(int payrollPeriodId, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.THR;

            try
            {
                // BIAYA GAJI (D)
                // BANK (C)

                decimal totalDebit = 0;
                decimal totalCredit = 0;
                int typeId = 2;

                var wtColl = new WageTransactionCollection();
                wtColl.Query.Where(wtColl.Query.WageProcessTypeID == typeId, wtColl.Query.PayrollPeriodID == payrollPeriodId);
                if (!wtColl.Query.Load())
                    return 0;

                var ts = new ThrSchedule();
                var tsq = new ThrScheduleQuery();
                tsq.Where(tsq.PayrollPeriodID == payrollPeriodId);
                ts.Load(tsq);

                var pp = new PayrollPeriod();
                pp.LoadByPrimaryKey(payrollPeriodId);

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("THR", ts.PayDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                JournalTransactions header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.IsVoid = false;

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header = new JournalTransactions();
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = ts.PayDate;
                    header.Description = ts.PayrollPeriodName;
                    header.IsPosted = false;
                    header.DateCreated = header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = "THR" + pp.PayrollPeriodCode.Trim();

                    header.Save();
                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var takeHomeThr = new AppParameter();
                takeHomeThr.LoadByPrimaryKey("SalaryComponentIdTHR");

                //CREDIT (JUMLAH PEMBAYARAN THR)
                var wtiQ = new WageTransactionItemQuery("a");
                var wtQ = new WageTransactionQuery("b");
                var scQ = new SalaryComponentQuery("c");
                var esiQ = new EmployeeSalaryInfoQuery("d");
                var asriQ = new AppStandardReferenceItemQuery("e");
                var coaQ = new ChartOfAccountsQuery("f");

                wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                wtiQ.InnerJoin(esiQ).On(esiQ.PersonID == wtQ.PersonID);
                wtiQ.InnerJoin(asriQ).On(asriQ.StandardReferenceID == "BankHRD" && asriQ.ItemID == esiQ.BankID);
                wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == asriQ.coaID);

                wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID == takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true);

                wtiQ.Select(asriQ.ItemName, asriQ.coaID, asriQ.subledgerID, wtiQ.NominalAmount.Sum().As("NominalAmount"));
                wtiQ.GroupBy(asriQ.ItemName, asriQ.coaID, asriQ.subledgerID);

                var wtiDtb = wtiQ.LoadDataTable();

                foreach (DataRow row in wtiDtb.Rows)
                {
                    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    {
                        var d = new JournalTransactionDetails
                        {
                            JournalId = journalId,
                            ChartOfAccountId = row["coaID"].ToInt(),
                            SubLedgerId = row["subledgerID"].ToInt(),
                            Debit = 0,
                            Credit = Convert.ToDecimal(row["NominalAmount"]),
                            Description = string.Format("THR #:{0}. BANK:{1}.", pp.PayrollPeriodName, row["ItemName"].ToString()),
                            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                        };
                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                    }
                }

                bool defNb = false;
                //var nb = new AppParameter();
                //if (nb.LoadByPrimaryKey("acc_IsJournalPayrollWithDefaultNormalBalance"))
                //    defNb = nb.ParameterValue.ToLower() == "yes";

                bool isUsingDirectIndirectCost = false;
                var dic = new AppParameter();
                if (dic.LoadByPrimaryKey("acc_IsJournalPayrollWithDirectIndirectCost"))
                    isUsingDirectIndirectCost = dic.ParameterValue.ToLower() == "yes";

                if (!isUsingDirectIndirectCost)
                {
                    #region -old-
                    ////DEBET (SALARY COMPONENT)
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //var empQ = new VwEmployeeTableQuery("e");
                    //var orgQ = new OrganizationUnitQuery("f");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "D");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "D");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true);

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr,
                    //    @"<CASE WHEN ISNULL(c.SubLedgerIdThr, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerIdThr END AS SubLedgerId>",
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(
                    //    @"<c.SalaryComponentName>",
                    //    @"<c.ChartOfAccountIdThr>",
                    //    @"<CASE WHEN ISNULL(c.SubLedgerIdThr, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerIdThr END>"
                    //    );

                    //var wtiDtb1 = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb1.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Credit = 0,
                    //            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    ////CREDIT (SALARY COMPONENT)
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeTableQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "K");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "K");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true);

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr,
                    //    @"<CASE WHEN ISNULL(c.SubLedgerIdThr, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerIdThr END AS SubLedgerId>",
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(
                    //    @"<c.SalaryComponentName>",
                    //    @"<c.ChartOfAccountIdThr>",
                    //    @"<CASE WHEN ISNULL(c.SubLedgerIdThr, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerIdThr END>"
                    //    );

                    //var wtiDtb2 = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb2.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = 0,
                    //            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}
                    #endregion

                    //DEBET - CREDIT (SALARY COMPONENT)
                    wtiQ = new WageTransactionItemQuery("a");
                    wtQ = new WageTransactionQuery("b");
                    scQ = new SalaryComponentQuery("c");
                    coaQ = new ChartOfAccountsQuery("d");
                    var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    var orgQ = new OrganizationUnitQuery("f");

                    wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr);
                    wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true);

                    wtiQ.Select(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdThr,
                        @"<CASE WHEN ISNULL(c.SubLedgerIdThr, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerIdThr END AS SubLedgerId>", scQ.NormalBalanceThr,
                        wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    wtiQ.GroupBy(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdThr,
                        @"<CASE WHEN ISNULL(c.SubLedgerIdThr, 0) = 0 THEN ISNULL(f.SubLedgerId, 0) ELSE c.SubLedgerIdThr END>", scQ.NormalBalanceThr);
                    wtiQ.Having(wtiQ.NominalAmount.Sum() > 0);
                    wtiQ.OrderBy(scQ.NormalBalanceThr.Ascending, scQ.SalaryComponentCode.Ascending);

                    var wtiDtb1 = wtiQ.LoadDataTable();

                    foreach (DataRow row in wtiDtb1.Rows)
                    {
                        if (row["NormalBalanceThr"].ToString() == "D")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = Convert.ToDecimal(row["NominalAmount"]),
                                Credit = 0,
                                Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else if (row["NormalBalanceThr"].ToString() == "K")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = 0,
                                Credit = Convert.ToDecimal(row["NominalAmount"]),
                                Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                    }
                }
                else
                {
                    #region -old-
                    //#region - DEBET (SALARY COMPONENT) - GLOBAL
                    //////DEBET (SALARY COMPONENT) - GLOBAL
                    ////wtiQ = new WageTransactionItemQuery("a");
                    ////wtQ = new WageTransactionQuery("b");
                    ////scQ = new SalaryComponentQuery("c");
                    ////coaQ = new ChartOfAccountsQuery("d");
                    ////var empQ = new VwEmployeeTableQuery("e");
                    ////var orgQ = new OrganizationUnitQuery("f");

                    ////wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    ////wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "D");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "D");
                    ////wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    ////wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    ////wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                    ////    scQ.SubLedgerIdThr.IsNotNull(), scQ.SubLedgerIdThr > 0);

                    ////wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, scQ.SubLedgerIdThr.As("SubLedgerId"),
                    ////    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    ////wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, scQ.SubLedgerIdThr);

                    ////var wtiDtb1 = wtiQ.LoadDataTable();

                    ////foreach (DataRow row in wtiDtb1.Rows)
                    ////{
                    ////    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    ////    {
                    ////        var d = new JournalTransactionDetails
                    ////        {
                    ////            JournalId = journalId,
                    ////            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    ////            SubLedgerId = row["SubLedgerId"].ToInt(),
                    ////            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    ////            Credit = 0,
                    ////            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    ////            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    ////        };
                    ////        d.Save();

                    ////        totalDebit += d.Debit.Value;
                    ////        totalCredit += d.Credit.Value;
                    ////    }
                    ////}
                    //#endregion

                    ////DEBET (SALARY COMPONENT) - DIRECT
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //var orgQ = new OrganizationUnitQuery("f");
                    //var slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "D");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "D");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == true);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                    //    wtiQ.Or(scQ.SubLedgerIdThr.IsNull(), scQ.SubLedgerIdThr == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId);

                    //var wtiDtb1a = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb1a.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Credit = 0,
                    //            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    ////DEBET (SALARY COMPONENT) - INDIRECT
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");
                    //slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "D");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "D");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == false);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                    //    wtiQ.Or(scQ.SubLedgerIdThr.IsNull(), scQ.SubLedgerIdThr == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId);

                    //var wtiDtb1b = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb1b.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Credit = 0,
                    //            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    //#region - CREDIT (SALARY COMPONENT) - GLOBAL
                    //////CREDIT (SALARY COMPONENT) - GLOBAL
                    ////wtiQ = new WageTransactionItemQuery("a");
                    ////wtQ = new WageTransactionQuery("b");
                    ////scQ = new SalaryComponentQuery("c");
                    ////coaQ = new ChartOfAccountsQuery("d");
                    ////empQ = new VwEmployeeTableQuery("e");
                    ////orgQ = new OrganizationUnitQuery("f");

                    ////wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    ////wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    ////if (defNb)
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "K");
                    ////else
                    ////    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "K");
                    ////wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    ////wtiQ.LeftJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);

                    ////wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                    ////    scQ.SubLedgerIdThr.IsNotNull(), scQ.SubLedgerIdThr > 0);

                    ////wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, scQ.SubLedgerIdThr.As("SubLedgerId"),
                    ////    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    ////wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, scQ.SubLedgerIdThr);

                    ////var wtiDtb2 = wtiQ.LoadDataTable();

                    ////foreach (DataRow row in wtiDtb2.Rows)
                    ////{
                    ////    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    ////    {
                    ////        var d = new JournalTransactionDetails
                    ////        {
                    ////            JournalId = journalId,
                    ////            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    ////            SubLedgerId = row["SubLedgerId"].ToInt(),
                    ////            Debit = 0,
                    ////            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    ////            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    ////            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    ////        };
                    ////        d.Save();

                    ////        totalDebit += d.Debit.Value;
                    ////        totalCredit += d.Credit.Value;
                    ////    }
                    ////}
                    //#endregion

                    ////CREDIT (SALARY COMPONENT) - DIRECT
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");
                    //slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "K");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "K");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == true);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                    //    wtiQ.Or(scQ.SubLedgerIdThr.IsNull(), scQ.SubLedgerIdThr == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, orgQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, orgQ.SubLedgerId);

                    //var wtiDtb2a = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb2a.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = 0,
                    //            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}

                    ////CREDIT (SALARY COMPONENT) - DIRECT
                    //wtiQ = new WageTransactionItemQuery("a");
                    //wtQ = new WageTransactionQuery("b");
                    //scQ = new SalaryComponentQuery("c");
                    //coaQ = new ChartOfAccountsQuery("d");
                    //empQ = new VwEmployeeOrganizationUnitQuery("e");
                    //orgQ = new OrganizationUnitQuery("f");
                    //slQ = new SubLedgersQuery("sl");

                    //wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    //wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    //if (defNb)
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && coaQ.NormalBalance == "K");
                    //else
                    //    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr && scQ.NormalBalanceThr == "K");
                    //wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    //wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    //wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == false);

                    //wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                    //    wtiQ.Or(scQ.SubLedgerIdThr.IsNull(), scQ.SubLedgerIdThr == 0));

                    //wtiQ.Select(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, orgQ.SubLedgerId,
                    //    wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    //wtiQ.GroupBy(scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, orgQ.SubLedgerId);

                    //var wtiDtb2b = wtiQ.LoadDataTable();

                    //foreach (DataRow row in wtiDtb2b.Rows)
                    //{
                    //    if (Convert.ToDecimal(row["NominalAmount"]) != 0)
                    //    {
                    //        var d = new JournalTransactionDetails
                    //        {
                    //            JournalId = journalId,
                    //            ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                    //            SubLedgerId = row["SubLedgerId"].ToInt(),
                    //            Debit = 0,
                    //            Credit = Convert.ToDecimal(row["NominalAmount"]),
                    //            Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                    //            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                    //        };
                    //        d.Save();

                    //        totalDebit += d.Debit.Value;
                    //        totalCredit += d.Credit.Value;
                    //    }
                    //}
                    #endregion

                    //DEBET - CREDIT (SALARY COMPONENT) - DIRECT
                    wtiQ = new WageTransactionItemQuery("a");
                    wtQ = new WageTransactionQuery("b");
                    scQ = new SalaryComponentQuery("c");
                    coaQ = new ChartOfAccountsQuery("d");
                    var empQ = new VwEmployeeOrganizationUnitQuery("e");
                    var orgQ = new OrganizationUnitQuery("f");
                    var slQ = new SubLedgersQuery("sl");

                    wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr);
                    wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == true);

                    wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                        wtiQ.Or(scQ.SubLedgerIdThr.IsNull(), scQ.SubLedgerIdThr == 0));

                    wtiQ.Select(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId, scQ.NormalBalanceThr,
                        wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    wtiQ.GroupBy(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId, scQ.NormalBalanceThr);
                    wtiQ.Having(wtiQ.NominalAmount.Sum() > 0);
                    wtiQ.OrderBy(scQ.NormalBalanceThr.Ascending, scQ.SalaryComponentCode.Ascending);

                    var wtiDtb1a = wtiQ.LoadDataTable();

                    foreach (DataRow row in wtiDtb1a.Rows)
                    {
                        if (row["NormalBalanceThr"].ToString() == "D")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = Convert.ToDecimal(row["NominalAmount"]),
                                Credit = 0,
                                Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else if (row["NormalBalanceThr"].ToString() == "K")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = 0,
                                Credit = Convert.ToDecimal(row["NominalAmount"]),
                                Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                    }

                    //DEBET - CREDIT (SALARY COMPONENT) - INDIRECT
                    wtiQ = new WageTransactionItemQuery("a");
                    wtQ = new WageTransactionQuery("b");
                    scQ = new SalaryComponentQuery("c");
                    coaQ = new ChartOfAccountsQuery("d");
                    empQ = new VwEmployeeOrganizationUnitQuery("e");
                    orgQ = new OrganizationUnitQuery("f");
                    slQ = new SubLedgersQuery("sl");

                    wtiQ.InnerJoin(wtQ).On(wtQ.WageTransactionID == wtiQ.WageTransactionID);
                    wtiQ.InnerJoin(scQ).On(scQ.SalaryComponentID == wtiQ.SalaryComponentID);
                    wtiQ.InnerJoin(coaQ).On(coaQ.ChartOfAccountId == scQ.ChartOfAccountIdThr);
                    wtiQ.InnerJoin(empQ).On(empQ.PersonID == wtQ.PersonID);
                    wtiQ.InnerJoin(orgQ).On(orgQ.OrganizationUnitID == empQ.ServiceUnitID);
                    wtiQ.InnerJoin(slQ).On(slQ.SubLedgerId == orgQ.SubLedgerId && slQ.IsDirectCost == false);

                    wtiQ.Where(wtQ.WageProcessTypeID == typeId, wtQ.PayrollPeriodID == payrollPeriodId, wtiQ.SalaryComponentID != takeHomeThr.ParameterValue.ToInt(), scQ.IsDisplayInThrSlip == true,
                        wtiQ.Or(scQ.SubLedgerIdThr.IsNull(), scQ.SubLedgerIdThr == 0));

                    wtiQ.Select(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId, scQ.NormalBalanceThr,
                        wtiQ.NominalAmount.Sum().As("NominalAmount"));
                    wtiQ.GroupBy(scQ.SalaryComponentCode, scQ.SalaryComponentName, scQ.ChartOfAccountIdThr, slQ.SubLedgerId, scQ.NormalBalanceThr);
                    wtiQ.Having(wtiQ.NominalAmount.Sum() > 0);
                    wtiQ.OrderBy(scQ.NormalBalanceThr.Ascending, scQ.SalaryComponentCode.Ascending);

                    var wtiDtb1b = wtiQ.LoadDataTable();

                    foreach (DataRow row in wtiDtb1b.Rows)
                    {
                        if (row["NormalBalanceThr"].ToString() == "D")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = Convert.ToDecimal(row["NominalAmount"]),
                                Credit = 0,
                                Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                        else if (row["NormalBalanceThr"].ToString() == "K")
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = row["ChartOfAccountIdThr"].ToInt(),
                                SubLedgerId = row["SubLedgerId"].ToInt(),
                                Debit = 0,
                                Credit = Convert.ToDecimal(row["NominalAmount"]),
                                Description = string.Format("THR #:{0}. SALARY COMPONENT:{1}.", pp.PayrollPeriodName, row["SalaryComponentName"].ToString()),
                                DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }
                    }
                }

                if (totalCredit != totalDebit & Math.Abs(totalCredit - totalDebit) <= 1000)
                {
                    //selisih pembulatan
                    var coa_selisih = GetCachedAccountFromParam("coa_RoundingPayroll");
                    if (coa_selisih != 0)
                    {
                        var coaColl = new ChartOfAccountsCollection();

                        int sl_selisih = 0;
                        var param = new AppParameter();
                        if (param.LoadByPrimaryKey("SubLedgerCodeRoundingPayroll"))
                        {
                            if (!string.IsNullOrEmpty(param.ParameterValue))
                            {
                                var param2 = new AppParameter();
                                param2.LoadByPrimaryKey("SubLedgerGroupIdServiceUnit");
                                var subledgerQ = new SubLedgersQuery();
                                subledgerQ.Where(subledgerQ.GroupId == param2.ParameterValue.ToInt(), subledgerQ.SubLedgerName == param.ParameterValue);
                                var subledger = new SubLedgers();
                                if (subledger.Load(subledgerQ) && subledger != null)
                                {
                                    sl_selisih = subledger.SubLedgerId ?? 0;
                                }
                            }
                        }

                        decimal debit = 0, credit = 0;
                        if (totalCredit > totalDebit)
                            debit = totalCredit - totalDebit;
                        else
                            credit = totalDebit - totalCredit;

                        var sl = new JournalTransactionDetails
                        {
                            JournalId = journalId,
                            ChartOfAccountId = ValidateCOA(coa_selisih, coaColl, "AppParameter: coa_RoundingPayroll"),
                            SubLedgerId = sl_selisih,
                            Debit = debit,
                            Credit = credit,
                            Description = string.Format("THR #:{0} - PEMBULATAN.", pp.PayrollPeriodName),
                            DocumentNumber = "THR" + pp.PayrollPeriodCode.Trim()
                        };
                        sl.Save();

                        totalDebit += sl.Debit.Value;
                        totalCredit += sl.Credit.Value;
                    }
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayroll) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return journalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAssetDestructionJournal(AssetStatusHistory sh, Asset asset, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AssetDestruction;

            try
            {
                // (D) Biaya Penghapusan Aset (Nilai Buku)
                //     (C) Akumulasi Penyusutan
                //     (C) Aset Tetap
                //--------------------------------------------------------------
                //- SUDAH HABIS MASA PENYUSUTAN
                // (D) akumulasi penyusutan       48.000.000
                //     (C) asset tetap                         48.000.000

                //- BELUM HABIS MASA PENYUSUTAN (misal: sisa penyusutan 6 bln)
                // (D) biaya penghapusan asset     6.000.000
                // (D) akumulasi penyusutan       42.000.000
                //     (C) asset tetap                         48.000.000
                //--------------------------------------------------------------

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("FAD", sh.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var assetStatus = asset.SRAssetsStatus == "3" ? "Disposed" : (asset.SRAssetsStatus == "4" ? "Lost" : "-");

                JournalTransactions header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.IsVoid = false;

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header = new JournalTransactions();
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = sh.TransactionDate.Value.Date;
                    header.Description = string.Format("{2} ID#:{0}. NAME#:{1}.", asset.AssetID, asset.AssetName + " [SN: " + asset.SerialNumber + "]", "Asset Destruction (" + assetStatus + ")");
                    header.IsPosted = false;
                    header.DateCreated = header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = sh.SeqNo.ToString();

                    header.Save();
                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();
                var subledgerId = 0;
                var subLedgerGroupIdServiceUnit = AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdServiceUnit);
                var slq = new SubLedgersQuery();
                slq.Where(slq.GroupId == subLedgerGroupIdServiceUnit, slq.SubLedgerName == asset.ServiceUnitID);
                var sl = new SubLedgers();
                if (sl.Load(slq))
                    subledgerId = sl.SubLedgerId ?? 0;

                var ag = new AssetGroup();
                ag.LoadByPrimaryKey(asset.AssetGroupID);
                var coa_costDest = ag.AssetCostDestructionAccountId;
                var sub_costDest = ag.AssetCostDestructionSubLedgerId == 0 ? subledgerId : ag.AssetCostDestructionSubLedgerId;
                var coa_accDep = ag.AssetAccumulationAccountId;
                var sub_accDep = ag.AssetAccumulationSubLedgerId == 0 ? subledgerId : ag.AssetAccumulationSubLedgerId;
                var coa_fa = ag.AssetAccountId;
                var sub_fa = ag.AssetSubLedgerId == 0 ? subledgerId : ag.AssetSubLedgerId;

                var costDest = (sh.CurrentValue ?? 0); //-sebagai nilai residu
                if (costDest != 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_costDest, coaColl, "Asset Group - " + ag.GroupName + " : Cost of Destruction"),
                        SubLedgerId = sub_costDest,
                        Debit = costDest,
                        Credit = 0,
                        Description = "Asset Destruction Cost (" + assetStatus + ")",
                        DocumentNumber = "FAD-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }

                var accDep = (sh.DepreciationAccValue ?? 0);
                if (accDep != 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_accDep, coaColl, "Asset Group: " + ag.GroupName + " - COA Depreciation"),
                        SubLedgerId = sub_accDep,
                        Debit = accDep,
                        Credit = 0,
                        Description = "Accumulated Depreciation",
                        DocumentNumber = "FAD-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }

                if (asset.CurrentValue > 0)
                {
                    //sudah habis masa penyusutan
                    // (D) akumulasi penyusutan  99.99
                    //     (C) asset tetap             99.99
                    if (costDest == 0 && accDep == 0) //sudah habis masa penyusutan
                    {
                        if (asset.ResidualValue > 0)
                        {
                            var d = new JournalTransactionDetails
                            {
                                JournalId = journalId,
                                ChartOfAccountId = ValidateCOA(coa_costDest, coaColl, "Asset Group - " + ag.GroupName + " : Cost of Destruction"),
                                SubLedgerId = sub_costDest,
                                Debit = asset.ResidualValue,
                                Credit = 0,
                                Description = "Asset Destruction Cost (" + assetStatus + ")",
                                DocumentNumber = "FAD-" + sh.SeqNo.ToString()
                            };
                            d.Save();

                            totalDebit += d.Debit.Value;
                            totalCredit += d.Credit.Value;
                        }

                        var d2 = new JournalTransactionDetails
                        {
                            JournalId = journalId,
                            ChartOfAccountId = ValidateCOA(coa_accDep, coaColl, "Asset Group: " + ag.GroupName + " - COA Depreciation"),
                            SubLedgerId = sub_accDep,
                            Debit = (asset.CurrentValue - asset.ResidualValue),
                            Credit = 0,
                            Description = "Accumulated Depreciation",
                            DocumentNumber = "FAD-" + sh.SeqNo.ToString()
                        };
                        d2.Save();

                        totalDebit += d2.Debit.Value;
                        totalCredit += d2.Credit.Value;
                    }

                    var c = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_fa, coaColl, "Asset Group: " + ag.GroupName + " - COA Assets"),
                        SubLedgerId = sub_fa,
                        Debit = 0,
                        Credit = asset.CurrentValue,
                        Description = "Fixed Assets",
                        DocumentNumber = "FAD-" + sh.SeqNo.ToString()
                    };
                    c.Save();

                    totalDebit += c.Debit.Value;
                    totalCredit += c.Credit.Value;
                }

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedAssetDestruction) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return journalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAssetMovementJournal(AssetMovement am, Asset asset, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;
            if (am.CurrentValue == 0)
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AssetMovement;

            try
            {
                // Aset Tetap From (Credit) 
                // Aset Tetap To (Debit)

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("FAM", am.MovementDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                JournalTransactions header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.IsVoid = false;

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header = new JournalTransactions();
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = am.MovementDate.Value.Date;
                    header.Description = string.Format("{2} ID#:{0}. NAME#:{1}.", asset.AssetID, asset.AssetName + " [SN: " + asset.SerialNumber + "]", "Asset Movement");
                    header.IsPosted = false;
                    header.DateCreated = header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = am.AssetMovementNo;

                    header.Save();
                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();
                var subledgerIdFrom = 0;
                var subledgerIdTo = 0;
                var subLedgerGroupIdServiceUnit = AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdServiceUnit);
                var slq = new SubLedgersQuery();
                slq.Where(slq.GroupId == subLedgerGroupIdServiceUnit, slq.SubLedgerName == am.FromServiceUnitID);
                var sl = new SubLedgers();
                if (sl.Load(slq))
                    subledgerIdFrom = sl.SubLedgerId ?? 0;

                slq = new SubLedgersQuery();
                slq.Where(slq.GroupId == subLedgerGroupIdServiceUnit, slq.SubLedgerName == am.ToServiceUnitID);
                sl = new SubLedgers();
                if (sl.Load(slq))
                    subledgerIdTo = sl.SubLedgerId ?? 0;

                var ag = new AssetGroup();
                ag.LoadByPrimaryKey(asset.AssetGroupID);
                var coa_fa = ag.AssetAccountId;
                var sub_fa_from = ag.AssetSubLedgerId == 0 ? subledgerIdFrom : ag.AssetSubLedgerId;
                var sub_fa_to = ag.AssetSubLedgerId == 0 ? subledgerIdTo : ag.AssetSubLedgerId;

                var coa_acc = ag.AssetAccumulationAccountId;
                var sub_acc_from = ag.AssetAccumulationSubLedgerId == 0 ? subledgerIdFrom : ag.AssetSubLedgerId;
                var sub_acc_to = ag.AssetAccumulationSubLedgerId == 0 ? subledgerIdTo : ag.AssetSubLedgerId;

                var currentValue = (asset.CurrentValue ?? 0); //-sebagai asset yg dipindahkan
                var depreValue = (am.CurrentValue ?? 0) == 0 ? (asset.CurrentValue ?? 0) : (am.CurrentValue ?? 0); //-sebagai akumlasi depre yg dipindahkan

                var dt = new JournalTransactionDetails
                {
                    JournalId = journalId,
                    ChartOfAccountId = ValidateCOA(coa_fa, coaColl, "Asset Group: " + ag.GroupName + " - COA Assets"),
                    SubLedgerId = sub_fa_to,
                    Debit = currentValue,
                    Credit = 0,
                    Description = "Fixed Assets",
                    DocumentNumber = am.AssetMovementNo
                };
                dt.Save();

                totalDebit += dt.Debit.Value;
                totalCredit += dt.Credit.Value;

                var dt2 = new JournalTransactionDetails
                {
                    JournalId = journalId,
                    ChartOfAccountId = ValidateCOA(coa_acc, coaColl, "Asset Group: " + ag.GroupName + " - COA Assets Depreciation"),
                    SubLedgerId = sub_acc_to,
                    Debit = depreValue,
                    Credit = 0,
                    Description = " Assets Depreciation",
                    DocumentNumber = am.AssetMovementNo
                };
                dt2.Save();

                totalDebit += dt2.Debit.Value;
                totalCredit += dt2.Credit.Value;

                var df = new JournalTransactionDetails
                {
                    JournalId = journalId,
                    ChartOfAccountId = ValidateCOA(coa_fa, coaColl, "Asset Group: " + ag.GroupName + " - COA Assets"),
                    SubLedgerId = sub_fa_from,
                    Debit = 0,
                    Credit = currentValue,
                    Description = "Fixed Assets",
                    DocumentNumber = am.AssetMovementNo
                };
                df.Save();

                totalDebit += df.Debit.Value;
                totalCredit += df.Credit.Value;

                var df2 = new JournalTransactionDetails
                {
                    JournalId = journalId,
                    ChartOfAccountId = ValidateCOA(coa_acc, coaColl, "Asset Group: " + ag.GroupName + " - COA Assets Depreciation"),
                    SubLedgerId = sub_acc_from,
                    Debit = 0,
                    Credit = depreValue,
                    Description = "Assets Depreciation",
                    DocumentNumber = am.AssetMovementNo
                };
                df2.Save();

                totalDebit += df2.Debit.Value;
                totalCredit += df2.Credit.Value;

                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedAssetMovement) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }
                }

                return journalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int? AddNewAssetAuctionJournal(AssetStatusHistory sh, Asset asset, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.AssetAuction;

            try
            {
                // (D) Kas/Bank Penerimaan
                // (D) Akumulasi Penyusutan Aset Tetap
                //     (C) Aset Tetap
                //     (C) Laba (Rugi) Penjualan Aset ==> untung (kalo rugi pindah ke debet)
                //     (C) PPN Keluaran (Credit)

                decimal totalDebit = 0;
                decimal totalCredit = 0;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("FAA", sh.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                JournalTransactions header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    ValidateClosingPeriode(header);

                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.IsVoid = false;

                    // rejournal tidak usah update last update
                    header.LastUpdateDateTime = DateTime.Now;
                    //entity.LastUpdateByUserID = editedBy;

                    // delete prev message
                    JournalErrorMessageDelete(header);

                    header.Save();
                }
                else
                {
                    header = new JournalTransactions();
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = sh.TransactionDate.Value.Date;
                    header.Description = string.Format("{2} ID#:{0}. NAME#:{1}.", asset.AssetID, asset.AssetName + " [SN: " + asset.SerialNumber + "]", "Asset Auction");
                    header.IsPosted = false;
                    header.DateCreated = header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = sh.SeqNo.ToString();

                    header.Save();
                    ValidateClosingPeriode(header);
                }

                journalId = header.JournalId.Value;

                var coaColl = new ChartOfAccountsCollection();
                var subledgerId = 0;
                var subLedgerGroupIdServiceUnit = AppParameter.GetParameterValue(AppParameter.ParameterItem.SubLedgerGroupIdServiceUnit);
                var slq = new SubLedgersQuery();
                slq.Where(slq.GroupId == subLedgerGroupIdServiceUnit, slq.SubLedgerName == asset.ServiceUnitID);
                var sl = new SubLedgers();
                if (sl.Load(slq))
                    subledgerId = sl.SubLedgerId ?? 0;

                var ag = new AssetGroup();
                ag.LoadByPrimaryKey(asset.AssetGroupID);
                var coa_costDest = ag.AssetCostDestructionAccountId;
                var sub_costDest = ag.AssetCostDestructionSubLedgerId == 0 ? subledgerId : ag.AssetCostDestructionSubLedgerId;
                var coa_accDep = ag.AssetAccumulationAccountId;
                var sub_accDep = ag.AssetAccumulationSubLedgerId == 0 ? subledgerId : ag.AssetAccumulationSubLedgerId;
                var coa_fa = ag.AssetAccountId;
                var sub_fa = ag.AssetSubLedgerId == 0 ? subledgerId : ag.AssetSubLedgerId;

                var paymentTypeCredit = string.Empty;

                var coa_bank = 0;
                var sub_bank = 0;
                var bank_name = string.Empty;
                var app = new AppParameter();
                if (app.LoadByPrimaryKey("PaymentTypeCredit"))
                    paymentTypeCredit = app.ParameterValue;

                if (sh.SRPaymentType == paymentTypeCredit)
                {
                    var ptype = new PaymentType();
                    if (ptype.LoadByPrimaryKey(sh.SRPaymentType))
                    {
                        coa_bank = ptype.ChartOfAccountID ?? 0;
                        sub_bank = ptype.SubledgerID ?? 0;
                        bank_name = ptype.PaymentTypeName;
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(sh.BankID))
                    {
                        var bank = new Bank();
                        if (bank.LoadByPrimaryKey(sh.BankID))
                        {
                            coa_bank = bank.ChartOfAccountId ?? 0;
                            sub_bank = bank.SubledgerId ?? 0;
                            bank_name = bank.BankName;
                        }
                    }
                    else
                    {
                        var pmethode = new PaymentMethod();
                        if (pmethode.LoadByPrimaryKey(sh.SRPaymentType, sh.SRPaymentMethod))
                        {
                            coa_bank = pmethode.ChartOfAccountID ?? 0;
                            sub_bank = pmethode.SubledgerID ?? 0;
                            bank_name = pmethode.PaymentMethodName;
                        }
                    }
                }

                decimal bankAmt = (sh.SalesPrice ?? 0);
                decimal taxAmt = (sh.TaxAmount ?? 0);
                if (sh.TaxStatus == "0")
                    taxAmt = bankAmt - (bankAmt / (1 + ((sh.TaxPercentage ?? 0) / 100)));
                else
                    bankAmt = bankAmt + taxAmt;

                // Kas/Bank Penerimaan (Debit)
                if (bankAmt > 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_bank, coaColl, bank_name + " : COA"),
                        SubLedgerId = sub_bank,
                        Debit = bankAmt,
                        Credit = 0,
                        Description = "Cash/Bank - AR",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString(),
                        DocumentNumberSequenceNo = sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }

                // Akumulasi Penyusutan Aset Tetap (Debit)
                if (sh.DepreciationAccValue > 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_accDep, coaColl, "Asset Group: " + ag.GroupName + " - COA Depreciation"),
                        SubLedgerId = sub_accDep,
                        Debit = sh.DepreciationAccValue,
                        Credit = 0,
                        Description = "Accumulated Depreciation of Fixed Assets",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                else
                {
                    // sudah habis masa penyusutan
                    if (asset.ResidualValue > 0)
                    {
                        var d = new JournalTransactionDetails
                        {
                            JournalId = journalId,
                            ChartOfAccountId = ValidateCOA(coa_costDest, coaColl, "Asset Group - " + ag.GroupName + " : Cost of Destruction"),
                            SubLedgerId = sub_costDest,
                            Debit = asset.ResidualValue,
                            Credit = 0,
                            Description = "Asset Destruction Cost",
                            DocumentNumber = "FAD-" + sh.SeqNo.ToString()
                        };
                        d.Save();

                        totalDebit += d.Debit.Value;
                        totalCredit += d.Credit.Value;
                    }

                    var d2 = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_accDep, coaColl, "Asset Group: " + ag.GroupName + " - COA Depreciation"),
                        SubLedgerId = sub_accDep,
                        Debit = (asset.CurrentValue - asset.ResidualValue),
                        Credit = 0,
                        Description = "Accumulated Depreciation of Fixed Assets",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d2.Save();

                    totalDebit += d2.Debit.Value;
                    totalCredit += d2.Credit.Value;
                }

                int coa_profitloss = GetCachedAccountFromParam("coa_ProfitLossOnSaleOfAssets");

                if (bankAmt - taxAmt > sh.CurrentValue)
                {
                    // Laba (Rugi) Penjualan Aset (Credit) ==> untung
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_profitloss, coaColl, "AppParameter: coa_ProfitLossOnSaleOfAssets"),
                        SubLedgerId = subledgerId,
                        Debit = 0,
                        Credit = bankAmt - taxAmt - sh.CurrentValue,
                        Description = "Profit/Loss on Sale of Assets",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                else
                {
                    // Laba (Rugi) Penjualan Aset (Debit) ==> rugi
                    decimal lostAmt = (bankAmt - taxAmt - (sh.CurrentValue ?? 0));
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_profitloss, coaColl, "AppParameter: coa_ProfitLossOnSaleOfAssets"),
                        SubLedgerId = subledgerId,
                        Debit = Math.Abs(lostAmt),
                        Credit = 0,
                        Description = "Profit/Loss on Sale of Assets",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }

                // Aset Tetap (Credit)
                if (sh.DepreciationAccValue + sh.CurrentValue > 0)
                {
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_fa, coaColl, "Asset Group: " + ag.GroupName + " - COA Asset"),
                        SubLedgerId = sub_fa,
                        Debit = 0,
                        Credit = sh.DepreciationAccValue + sh.CurrentValue,
                        Description = "Fixed Assets",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }
                else
                {
                    // sudah habis masa penyusutan
                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_fa, coaColl, "Asset Group: " + ag.GroupName + " - COA Asset"),
                        SubLedgerId = sub_fa,
                        Debit = 0,
                        Credit = asset.CurrentValue,
                        Description = "Fixed Assets",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }


                // PPN Keluaran (Credit)
                if (taxAmt > 0)
                {
                    int coa_tax = GetCachedAccountFromParam("coa_OutputVAT");

                    var d = new JournalTransactionDetails
                    {
                        JournalId = journalId,
                        ChartOfAccountId = ValidateCOA(coa_tax, coaColl, "AppParameter: coa_OutputVAT"),
                        SubLedgerId = 0,
                        Debit = 0,
                        Credit = taxAmt,
                        Description = "Output VAT",
                        DocumentNumber = "FAA-" + sh.SeqNo.ToString()
                    };
                    d.Save();

                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                }


                if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedAssetAuction) == "Yes")
                {
                    if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                    {
                        header.BeginEdit();
                        header.IsPosted = true;
                        header.EndEdit();
                        header.Save();
                    }

                    // insert cash transaction here
                    var cashId = AutoCashEntryOnAssetAuction(sh, header, ValidateCOA(coa_fa, coaColl, "Asset Group: " + ag.GroupName + " - COA Asset"), editedBy);
                }

                return journalId;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        public static int AutoCashEntryOnAssetAuction(AssetStatusHistory sh, JournalTransactions jt, int coa_fa, string editedBy)
        {
            if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoCashEntryOnAssetAuction) == "Yes")
            {
                // prevent duplicate cash entry transaction when reprocessing journal is fired
                var documentNo = "FAA-" + sh.SeqNo.ToString();

                var ceColl = new CashTransactionCollection();
                ceColl.Query.Where(ceColl.Query.DocumentNumber == documentNo && ceColl.Query.IsVoid != true);
                if (ceColl.LoadAll())
                {
                    var ce = ceColl.First();

                    if (ce.IsCleared ?? false)
                    {
                        throw new Exception("Cash transaction already cleared");
                    }

                    CashTransaction.UnPostingUpdateBalance(ce.TransactionId.Value);

                    ce = new CashTransaction();
                    if (ce.LoadByPrimaryKey(ceColl.First().TransactionId.Value))
                    {
                        ce.Void(editedBy);
                    }

                    ceColl.Save();
                }

                int? cashTransactionId;
                CashTransaction.AddNewAutomaticCashTransactionAssetAuctionFromJournal(sh, jt, coa_fa, editedBy, out cashTransactionId);
                // otomatis posting
                if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (jt.JournalId.HasValue && jt.JournalId.Value > 0))
                {
                    CashTransaction.PostingUpdateBalance(cashTransactionId.Value, jt.JournalId.Value);
                }
                return cashTransactionId ?? 0;
            }

            return 0;
        }

        private static void JournalErrorMessageSave(int journalId, Exception ex, string additionalData, string userID)
        {
            if (journalId != 0)
            {
                try
                {
                    var msg = new JournalMessage();
                    if (!msg.LoadByPrimaryKey(journalId))
                        msg.AddNew();

                    msg.JournalID = journalId;
                    msg.Message = ex.Message.Substring(0, ex.Message.Length > 500 ? 500 : ex.Message.Length);
                    if (ex.Message.Length > 500)
                        msg.Message = msg.Message.Substring(0, msg.Message.Length - 3) + "...";
                    msg.AdditionalData = additionalData;
                    msg.CreatedBy = userID;
                    msg.CreatedDateTime = DateTime.Now;
                    msg.Save();
                }
                catch (Exception exc)
                {

                }
            }
            else
            {
                try
                {
                    // untuk mencari jurnal yang gagal tercreate tapi tidak ketahuan penyebabnya

                    ErrorMessage.CreateSave(ex, userID);
                }
                catch (Exception exc)
                {

                }
            }
        }
        private static void JournalErrorMessageDelete(JournalTransactions jt)
        {
            jt.IsPosted = false;

            // delete prev message
            var msgColl = new JournalMessageCollection();
            msgColl.Query.Where(msgColl.Query.JournalID == jt.JournalId);
            if (msgColl.LoadAll())
            {
                msgColl.MarkAllAsDeleted();
                msgColl.Save();
            }
        }
        //using System.Linq;
        public class CoaMapping
        {
            public string ServiceUnitID;
            public string ItemID;
            public string TariffComponentID;
            public string SRRegistrationType;
            //public string SRGuarantorIncomeGroup;
        }

        public static int GetCachedAccountFromParam(string parameterID)
        {
            object cachedVal = null;
            try
            { // try catch dipakai untuk fungsi jurnal yang dijalankan dengan new thread, HttpContext gak dapat
                cachedVal = System.Web.HttpContext.Current.Cache["par_" + parameterID];
                if (cachedVal != null)
                    return Convert.ToInt32(cachedVal);
            }
            catch { }

            AppParameter entity = new AppParameter();
            int retVal = 0;
            string coaCode = string.Empty;

            if (entity.LoadByPrimaryKey(parameterID))
                coaCode = entity.ParameterValue;

            ChartOfAccounts coa = ChartOfAccounts.Get(coaCode);
            if (coa != null)
                retVal = coa.ChartOfAccountId.Value;

            if (cachedVal != null)
            {
                System.Web.HttpContext.Current.Cache["par_" + parameterID] = retVal;
            }

            return retVal;
        }

        public static int? AddNewReverseJournal(int journalId, int journalIdToBeReversed, string JournalCodePrefix,
            string editedBy)
        {
            return AddNewReverseJournal(journalId, journalIdToBeReversed, JournalCodePrefix, editedBy, DateTime.Now.Date);
        }

        public static int? AddNewReverseJournal(int journalId, int journalIdToBeReversed, string JournalCodePrefix,
            string editedBy, DateTime JournalDate)
        {
            return AddNewReverseJournal(journalId, journalIdToBeReversed, JournalCodePrefix, editedBy, JournalDate, "Void");
        }

        public static int? AddNewReverseJournal(int journalId, int journalIdToBeReversed, string JournalCodePrefix,
            string editedBy, DateTime JournalDate, string PreTextDescription)
        {
            return AddNewReverseJournal(journalId, journalIdToBeReversed, JournalCodePrefix,
                editedBy, JournalDate, PreTextDescription, string.Empty, false);
        }

        public static int? AddNewReverseJournal(int journalId, int journalIdToBeReversed, string JournalCodePrefix,
            string editedBy, DateTime JournalDate, string PreTextDescription, string RefferenceNumber, bool DoNotReplaceDocNumber)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            try
            {
                var JH = new JournalTransactions();
                if (JH.LoadByPrimaryKey(journalIdToBeReversed))
                {
                    // header
                    var JHR = new JournalTransactions();
                    if (JHR.LoadByPrimaryKey(journalId))
                    {
                        ValidateClosingPeriode(JHR);

                        var journalDetails = new JournalTransactionDetailsCollection();
                        journalDetails.Query.Where(journalDetails.Query.JournalId == JHR.JournalId);
                        journalDetails.LoadAll();
                        journalDetails.MarkAllAsDeleted();
                        journalDetails.Save();

                        // rejournal tidak usah update last update
                        JHR.LastUpdateDateTime = DateTime.Now;
                        //JHR.LastUpdateByUserID = editedBy;

                        JournalErrorMessageDelete(JHR);

                        JHR.Save();
                    }
                    else
                    {
                        JHR.AddNew();
                        JHR.JournalType = JH.JournalType;
                        JHR.JournalCode = JournalCodes.GetOrCreateAutoJournalCode(JournalCodePrefix, JournalDate);
                        JHR.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(JHR.JournalCode);
                        JHR.TransactionDate = JournalDate;
                        JHR.Description = PreTextDescription + " " + JH.Description;
                        JHR.IsPosted = false;
                        JHR.DateCreated = JHR.LastUpdateDateTime = DateTime.Now;
                        JHR.CreatedBy = JHR.CreatedBy = JHR.LastUpdateByUserID = editedBy;
                        JHR.RefferenceNumber = string.IsNullOrEmpty(RefferenceNumber) ? JH.RefferenceNumber : RefferenceNumber;
                        JHR.JournalIdRefference = journalIdToBeReversed;

                        JHR.Save();
                        ValidateClosingPeriode(JHR);
                    }

                    journalId = JHR.JournalId.Value;

                    // detail
                    var JDColl = new JournalTransactionDetailsCollection();
                    var JDRColl = new JournalTransactionDetailsCollection();

                    JDColl.Query.Where(JDColl.Query.JournalId == journalIdToBeReversed);
                    JDColl.LoadAll();
                    foreach (var JD in JDColl)
                    {
                        var JDR = JDRColl.AddNew();
                        JDR.JournalId = JHR.JournalId;
                        JDR.ChartOfAccountId = JD.ChartOfAccountId;
                        JDR.Debit = JD.Credit;
                        JDR.Credit = JD.Debit;
                        JDR.Description = PreTextDescription + " " + JD.Description;
                        JDR.SubLedgerId = JD.SubLedgerId;
                        if (DoNotReplaceDocNumber)
                        {
                            JDR.DocumentNumber = JD.DocumentNumber;
                        }
                        else
                        {
                            JDR.DocumentNumber = (JH.RefferenceNumber ?? string.Empty)
                                .Equals(JD.DocumentNumber ?? string.Empty) ?
                                (string.IsNullOrEmpty(RefferenceNumber) ? (JD.DocumentNumber ?? string.Empty) : RefferenceNumber) : (JD.DocumentNumber ?? string.Empty);
                        }
                        JDR.ClassID = JD.ClassID;
                        JDR.GuarantorID = JD.GuarantorID;
                        JDR.SupplierID = JD.SupplierID;
                        JDR.ParamedicID = JD.ParamedicID;
                        JDR.DueDate = JD.DueDate;

                        // add info
                        JDR.ClassID = JD.ClassID;
                        JDR.GuarantorID = JD.GuarantorID;
                        JDR.SupplierID = JD.SupplierID;
                        JDR.ParamedicID = JD.ParamedicID;
                        JDR.DueDate = JD.DueDate;
                        JDR.ServiceUnitID = JD.ServiceUnitID;
                        JDR.ItemID = JD.ItemID;
                        JDR.RegistrationNo = JD.RegistrationNo;
                        JDR.DocumentNumberSequenceNo = JD.DocumentNumberSequenceNo;
                    }

                    JDRColl.Save();

                    if (JH.IsPosted ?? false)
                    {
                        JHR.BeginEdit();
                        JHR.IsPosted = true;
                        JHR.EndEdit();
                        JHR.Save();
                    }

                    return JHR.JournalId;
                }
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        private static void ValidateClosingPeriode(JournalTransactions entity)
        {
            if (PostingStatus.IsPeriodeClosed(entity.TransactionDate.Value))
            {
                throw new Exception("Financial statements for period: " +
                                    string.Format("{0:MMMM-yyyy}", entity.TransactionDate) +
                                    " have been closed. " +
                                    string.Format("{0} journal aborted.", entity.es.IsAdded ? "Create new" : "Reprocessing"));
            }
        }

        public static string ValidateCOARetMsg(int? CoaID, ChartOfAccountsCollection CoaColl, string MessagePrefix, string MessageSuffix)
        {
            if ((CoaID ?? 0) == 0)
                return (MessagePrefix + (MessagePrefix.Length == 0 ? "" : ": ") + "Invalid Chart Of Account" + (MessageSuffix.Length == 0 ? "" : (". " + MessageSuffix)));
            ChartOfAccounts coa = CoaColl.Where(x => x.ChartOfAccountId == CoaID).FirstOrDefault();
            if (coa == null)
            {
                coa = new ChartOfAccounts();
                if (coa.LoadByPrimaryKey(CoaID ?? 0))
                {
                    CoaColl.AttachEntity(coa);
                }
                else
                {
                    return ((MessagePrefix.Length == 0 ? "" : (MessagePrefix + ": ")) + "Invalid Chart Of Account ID " + CoaID + (MessageSuffix.Length == 0 ? "" : (". " + MessageSuffix)));
                }
            }
            return string.Empty;
        }

        public static int ValidateCOA(int? CoaID, ChartOfAccountsCollection CoaColl, string MessagePrefix, string MessageSuffix, JournalTransactionDetails d, bool ContinueWhenError)
        {
            d.ChartOfAccountId = CoaID ?? 0;
            if (!ContinueWhenError)
            {
                return ValidateCOA(CoaID, CoaColl, MessagePrefix, MessageSuffix);
            }

            var msg = ValidateCOARetMsg(CoaID, CoaColl, MessagePrefix, MessageSuffix);
            d.ErrorMsg = msg;
            return CoaID ?? 0;
        }
        public static int ValidateCOA(int? CoaID, ChartOfAccountsCollection CoaColl, string MessagePrefix, string MessageSuffix)
        {
            //if ((CoaID ?? 0) == 0) throw new Exception(
            //    MessagePrefix + (MessagePrefix.Length == 0 ? "" : ": ") + "Invalid Chart Of Account" + (MessageSuffix.Length == 0 ? "" : (". " + MessageSuffix)));
            //ChartOfAccounts coa = CoaColl.Where(x => x.ChartOfAccountId == CoaID).FirstOrDefault();
            //if (coa == null)
            //{
            //    coa = new ChartOfAccounts();
            //    if (coa.LoadByPrimaryKey(CoaID ?? 0))
            //    {
            //        CoaColl.AttachEntity(coa);
            //    }
            //    else
            //    {
            //        throw new Exception((MessagePrefix.Length == 0 ? "" : (MessagePrefix + ": ")) + "Invalid Chart Of Account ID " + CoaID + (MessageSuffix.Length == 0 ? "" : (". " + MessageSuffix)));
            //    }
            //}
            //return coa.ChartOfAccountId ?? 0;
            var msg = ValidateCOARetMsg(CoaID, CoaColl, MessagePrefix, MessageSuffix);
            if (!string.IsNullOrEmpty(msg)) throw new Exception(msg);
            return CoaID ?? 0;
        }
        public static int ValidateCOA(int? CoaID, ChartOfAccountsCollection CoaColl)
        {
            return ValidateCOA(CoaID, CoaColl, string.Empty);
        }
        public static int ValidateCOA(int? CoaID)
        {
            var CoaColl = new ChartOfAccountsCollection();
            return ValidateCOA(CoaID, CoaColl, string.Empty);
        }
        public static int ValidateCOA(int? CoaID, string MessagePrefix, string MessageSuffix)
        {
            var CoaColl = new ChartOfAccountsCollection();
            return ValidateCOA(CoaID, CoaColl, MessagePrefix, MessageSuffix);
        }
        public static int ValidateCOA(int? CoaID, ChartOfAccountsCollection CoaColl, string MessagePrefix)
        {
            return ValidateCOA(CoaID, CoaColl, MessagePrefix, string.Empty);
        }

        private static KeyValuePair<string, string> FindClass(Dictionary<string, string> ClassDict, string Key)
        {
            if (!string.IsNullOrEmpty(Key))
            {
                var cls = ClassDict.Where(x => x.Key == Key);
                if (cls.Any())
                {
                    return cls.First();
                }
            }
            return new KeyValuePair<string, string>(Key, string.Empty);
        }

        private static string GetClass(string RoomID, string BedID)
        {
            var ClassDict = new Dictionary<string, string>();
            if (System.Web.HttpContext.Current.Application["ClassDict"] != null)
            {
                ClassDict = (Dictionary<string, string>)System.Web.HttpContext.Current.Application["ClassDict"];
            }
            var item = string.IsNullOrEmpty(BedID) ? RoomID : BedID;

            if (!string.IsNullOrEmpty(item))
            {
                var cls = FindClass(ClassDict, item);
                if (!string.IsNullOrEmpty(cls.Value)) return cls.Value;
            }

            if (!string.IsNullOrEmpty(BedID))
            {
                var bed = new Bed();
                if (bed.LoadByPrimaryKey(BedID))
                {
                    ClassDict.Add(BedID, bed.ClassID);
                    System.Web.HttpContext.Current.Application["ClassDict"] = ClassDict;
                    return bed.ClassID;
                }
                else
                {
                    return string.Empty;
                }
            }

            if (!string.IsNullOrEmpty(RoomID))
            {
                var Room = new ServiceRoom();
                var SuID = RoomID;
                if (Room.LoadByPrimaryKey(RoomID))
                {
                    SuID = Room.ServiceUnitID;
                    var cls = FindClass(ClassDict, SuID);
                    if (!string.IsNullOrEmpty(cls.Value))
                    {
                        ClassDict.Add(RoomID, cls.Value);
                        System.Web.HttpContext.Current.Application["ClassDict"] = ClassDict;
                        return cls.Value;
                    }
                }
                var su = new ServiceUnit();
                if (su.LoadByPrimaryKey(SuID))
                {
                    ClassDict.Add(SuID, su.DefaultChargeClassID);
                    System.Web.HttpContext.Current.Application["ClassDict"] = ClassDict;
                    return su.DefaultChargeClassID;
                }
            }
            return string.Empty;
        }

        private static void AddMoreInfo(JournalTransactionDetails jtd,
            string ClassID, string RoomID, string BedID, string GuarantorID, string SupplierID, string ParamedicID,
            DateTime? DueDate, string ServiceUnitID, string ItemID, string RegistrationNo,
            string DocumentSequenceNo)
        {
            // string ClassID = GetClass(RoomID, BedID); // Belum Jadi Dipakai, ini untuk kelas berdasarkan service unit / bed, bukan berdasarkan charge class
            AddMoreInfo(jtd, ClassID, GuarantorID, SupplierID, ParamedicID,
            DueDate, ServiceUnitID, ItemID, RegistrationNo);

            jtd.DocumentNumberSequenceNo = DocumentSequenceNo;
        }

        private static void AddMoreInfo(JournalTransactionDetails jtd,
            string ClassID, string GuarantorID, string SupplierID, string ParamedicID,
            DateTime? DueDate, string ServiceUnitID, string ItemID, string RegistrationNo)
        {
            jtd.ClassID = ClassID;
            jtd.GuarantorID = GuarantorID;
            jtd.SupplierID = SupplierID;
            jtd.ParamedicID = ParamedicID;
            jtd.DueDate = DueDate;
            jtd.ServiceUnitID = ServiceUnitID;
            jtd.ItemID = ItemID;
            jtd.RegistrationNo = RegistrationNo;

            if (!jtd.IsProrataDiscToRevenue.HasValue) jtd.IsProrataDiscToRevenue = false;
        }

        private static string CutString(string str, int len)
        {
            return str.Substring(0, str.Length > len ? len : str.Length);
        }
        #endregion

        #region adop from CLinic App
        #region Sales to Customer (Klinik)
        private class CoaProductAccount
        {
            public string ProductAccountID { get; set; }
            public int CoaIdIncome { get; set; }
            public int SubledgerIdIncome { get; set; }
            public int CoaIdCOGS { get; set; }
            public int SubledgerIdCOGS { get; set; }
            public int CoaIdInventory { get; set; }
            public int SubledgerIdInventory { get; set; }
            public int CoaIdDiscount { get; set; }
            public int SubledgerIdDiscount { get; set; }

            public CoaProductAccount()
            {
            }

            public CoaProductAccount(string productAccountID, string itemType, string serviceUnitID)
            {
                ProductAccountID = productAccountID;
                var su = new ServiceUnit();
                su.LoadByPrimaryKey(serviceUnitID);
                string locationID = su.GetMainLocationId();

                if (itemType == BusinessObject.Reference.ItemType.Medical)
                {
                    this.CoaIdCOGS = su.ChartOfAccountIdCost.HasValue ? su.ChartOfAccountIdCost.Value : 0;
                    this.SubledgerIdCOGS = su.SubledgerIdCost.HasValue ? su.SubledgerIdCost.Value : 0;
                }
                else
                {
                    this.CoaIdCOGS = su.ChartOfAccountIdCostNonMedic.HasValue ? su.ChartOfAccountIdCostNonMedic.Value : 0;
                    this.SubledgerIdCOGS = su.SubledgerIdCostNonMedic.HasValue ? su.SubledgerIdCostNonMedic.Value : 0;
                }

                // Default ProductAccount
                var pacc = new ProductAccount();
                if (pacc.LoadByPrimaryKey(productAccountID))
                {
                    this.CoaIdIncome = pacc.ChartOfAccountIdIncome ?? 0;
                    this.SubledgerIdIncome = pacc.SubledgerIdIncome ?? 0;
                    this.CoaIdCOGS = pacc.ChartOfAccountIdCOGS ?? 0;
                    this.SubledgerIdCOGS = pacc.SubledgerIdCOGS ?? 0;
                    this.CoaIdInventory = pacc.ChartOfAccountIdInventory ?? 0;
                    this.SubledgerIdInventory = pacc.SubledgerIdInventory ?? 0;
                    this.CoaIdDiscount = pacc.ChartOfAccountIdDiscount ?? 0;
                    this.SubledgerIdDiscount = pacc.SubledgerIdDiscount ?? 0;
                }


                if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsUnitBasedProductAccount))
                {
                    ServiceUnitProductAccountMapping proacc = new ServiceUnitProductAccountMapping();
                    if (proacc.LoadByPrimaryKey(locationID, serviceUnitID, productAccountID, "OPR"))
                    {
                        if (proacc.ChartOfAccountIdIncome > 0)
                        {
                            this.CoaIdIncome = proacc.ChartOfAccountIdIncome ?? 0;
                            this.SubledgerIdIncome = proacc.SubledgerIdIncome ?? 0;
                        }

                        if (proacc.ChartOfAccountIdCOGS > 0)
                        {
                            this.CoaIdCOGS = proacc.ChartOfAccountIdCOGS ?? 0;
                            this.SubledgerIdCOGS = proacc.SubledgerIdCOGS ?? 0;
                        }

                        if (proacc.ChartOfAccountIdInventory > 0)
                        {
                            this.CoaIdInventory = proacc.ChartOfAccountIdInventory ?? 0;
                            this.SubledgerIdInventory = proacc.SubledgerIdInventory ?? 0;
                        }
                        if (proacc.ChartOfAccountIdDiscount > 0)
                        {
                            this.CoaIdDiscount = proacc.ChartOfAccountIdDiscount ?? 0;
                            this.SubledgerIdDiscount = proacc.SubledgerIdDiscount ?? 0;
                        }
                    }
                }

            }

        }

        public static int AddNewSalesJournal_xx(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.Sales;

            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for TransactionNo={0}", e.TransactionNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                var cust = new Customer();
                cust.LoadByPrimaryKey(e.CustomerID);


                ItemTransactionItemCollection eItems = new ItemTransactionItemCollection();
                ItemTransactionItemQuery eItemQuery = new ItemTransactionItemQuery("e");
                ItemQuery itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, itemQuery.ItemName.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.InnerJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    entity.LastUpdateDateTime = DateTime.Now;
                    entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("SLS", e.TransactionDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = e.TransactionDate;
                    entity.Description = string.Format("SALES #:{0}. CUST: {1} ", e.TransactionNo, cust.CustomerName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = e.TransactionNo;
                }
                entity.Save();

                var coaPa = new CoaProductAccount();
                foreach (var p in eItems)
                {
                    Item itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load())
                    {
                        coaPa = new CoaProductAccount(itemInv.ProductAccountID, itemInv.SRItemType,
                            e.FromServiceUnitID);

                    }

                    if (coaPa.CoaIdInventory == 0 || coaPa.CoaIdCOGS == 0)
                        return 0;

                    // Income
                    JournalTransactionDetails itemMedicIncome = new JournalTransactionDetails();
                    itemMedicIncome.AddNew();
                    itemMedicIncome.JournalId = entity.JournalId;
                    itemMedicIncome.ChartOfAccountId = coaPa.CoaIdIncome;
                    itemMedicIncome.SubLedgerId = coaPa.SubledgerIdIncome;
                    itemMedicIncome.Debit = 0;
                    itemMedicIncome.Credit = e.ChargesAmount;
                    itemMedicIncome.Description = string.Format("TR#:{0}. CUST#:{1}. ITEM:{2}-{3}", e.TransactionNo, cust.CustomerName, p.ItemID, p.ItemName);
                    itemMedicIncome.DocumentNumber = e.TransactionNo;
                    itemMedicIncome.ItemID = p.ItemID;
                    itemMedicIncome.DocumentNumberSequenceNo = p.SequenceNo;
                    itemMedicIncome.Save();

                    totalCredit += itemMedicIncome.Credit.Value;


                    // COGS & Persediaan
                    ItemMovementQuery mov = new ItemMovementQuery();
                    mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                               mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                    mov.Where(mov.TransactionNo == p.TransactionNo, mov.SequenceNo == p.SequenceNo, mov.ItemID == p.ItemID);
                    mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                    DataTable tbl = mov.LoadDataTable();

                    foreach (DataRow row in tbl.Rows)
                    {
                        decimal? amt = (decimal)row["Quantity"] * (decimal)row["CostPrice"] * (e.CurrencyRate.HasValue ? e.CurrencyRate.Value : 1);

                        JournalTransactionDetails d = new JournalTransactionDetails();
                        d.AddNew();
                        d.JournalId = entity.JournalId;
                        d.ChartOfAccountId = coaPa.CoaIdCOGS;
                        d.SubLedgerId = coaPa.SubledgerIdCOGS;
                        d.Debit = amt;
                        d.Credit = 0;
                        d.Description = string.Format("TR#:{0}. CUST#:{1}. ITEM:{2}-{3}", e.TransactionNo, cust.CustomerName, p.ItemID, p.ItemName);
                        d.DocumentNumber = e.TransactionNo;
                        d.ItemID = p.ItemID;
                        d.DocumentNumberSequenceNo = p.SequenceNo;

                        d.Save();

                        totalDebit += d.Debit.Value;

                        JournalTransactionDetails c = new JournalTransactionDetails();
                        c.AddNew();
                        c.JournalId = entity.JournalId;
                        c.ChartOfAccountId = coaPa.CoaIdInventory;
                        c.SubLedgerId = coaPa.SubledgerIdInventory;
                        c.Debit = 0;
                        c.Credit = amt;
                        c.Description = string.Format("TR#:{0}. CUST#:{1}. ITEM:{2}-{3}", e.TransactionNo, cust.CustomerName, p.ItemID, p.ItemName);
                        c.DocumentNumber = e.TransactionNo;
                        d.ItemID = p.ItemID;
                        d.DocumentNumberSequenceNo = p.SequenceNo;
                        c.Save();

                        totalCredit += c.Credit.Value;
                    }


                    //discount DEBIT
                    if (p.Discount.Value > 0)
                    {
                        JournalTransactionDetails disc = new JournalTransactionDetails();
                        disc.AddNew();
                        disc.JournalId = entity.JournalId;
                        disc.ChartOfAccountId = coaPa.CoaIdDiscount;
                        disc.SubLedgerId = coaPa.SubledgerIdDiscount;
                        disc.Debit = p.Discount.Value;
                        disc.Credit = 0;
                        disc.Description = string.Format("TR#:{0}. ITEM:{1}.", e.TransactionNo, p.ItemName); ;
                        disc.DocumentNumber = e.TransactionNo;
                        disc.ItemID = p.ItemID;
                        disc.DocumentNumberSequenceNo = p.SequenceNo;
                        disc.Save();

                        totalDebit += disc.Debit.Value;
                    }
                }

                //Logger.LogMessage(string.Format("AutoJournal Created JournalID:{0} JournalCode:{1} TransactionNumber:{2}", entity.JournalId, entity.JournalCode, entity.TransactionNumber));

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    entity.BeginEdit();
                    entity.IsPosted = true;
                    entity.EndEdit();
                    entity.Save();
                }


                return entity.JournalId ?? 0;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }


        public static int AddNewSalesJournal(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            if (e.SRPaymentType == "CS" && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalCashSalesToCustomer) == "No")
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.Sales;

            ServiceUnit toServiceUnit = new ServiceUnit();
            if (!toServiceUnit.LoadByPrimaryKey(e.FromServiceUnitID))
                return 0;

            try
            {
                //
                // Requirement:
                // ACCOUNT PAYABLE (D)
                // INCOME (C)
                // HPP (D)
                // INVENTORY (C)

                var eItems = new ItemTransactionItemCollection();
                var eItemQuery = new ItemTransactionItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var customerName = string.Empty;
                var cust = new Customer();
                if (!cust.LoadByPrimaryKey(e.CustomerID))
                    return 0;

                customerName = cust.CustomerName;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("SLS", e.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.LastUpdateDateTime = DateTime.Now;
                    header.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(header);
                }
                else
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = e.TransactionDate;
                    header.Description = string.Format("SALES #:{0}. CUST:{1}.", e.TransactionNo, customerName);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = e.TransactionNo;
                }
                header.Save();


                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int dAccountReceivableCoaId = 0; //GetCachedAccountFromParam("coa_ApInProcess"); 
                int dAccountReceivableSubLedgerId = 0;

                int cIncomeCoaId = 0;
                int cIncomeSubledgerId = 0;

                int dCogsCoaId = 0;
                int dCogsSubledgerId = 0;

                int cInventoryCoaId = 0;
                int cInventorySubLedgerId = 0;

                int dDiscountCoaId = 0;
                int dDiscountSubledgerId = 0;

                string paMsg = string.Empty;

                if (e.SRPaymentType == "CS")
                {
                    var appCoaCash = new AppParameter();
                    if (!appCoaCash.LoadByPrimaryKey("coa_SalesToCustomerCash"))
                        throw new Exception("App Parameter: coa_SalesToCustomerCash: Parameter not found!!");

                    dAccountReceivableCoaId = GetCachedAccountFromParam("coa_SalesToCustomerCash");
                    paMsg = "Sales To Customer Cash";
                }
                else if (cust.ChartOfAccountIdARTemporary.HasValue)
                {
                    //hutang diakui saat tukar faktur sehingga saat POR ditampung terlebih dahulu di account sementara
                    dAccountReceivableCoaId = cust.ChartOfAccountIdARTemporary.Value;
                    dAccountReceivableSubLedgerId = cust.SubledgerIdARTemporary.Value;
                    paMsg = "Customer A/R Process";
                }

                decimal receivableAmount = (e.ChargesAmount ?? 0) + (e.TaxAmount ?? 0);
                decimal discTotal = 0;

                var coaColl = new ChartOfAccountsCollection();

                //-------------------------------------------------------------------------------
                // ACCOUNT PAYABLE (D)
                //-------------------------------------------------------------------------------
                var netReceivableAmount = receivableAmount - discTotal;

                var detail = new JournalTransactionDetails
                {
                    JournalId = header.JournalId,
                    ChartOfAccountId = ValidateCOA(dAccountReceivableCoaId, coaColl, paMsg),
                    SubLedgerId = dAccountReceivableSubLedgerId,
                    Debit = decimal.Round((decimal)netReceivableAmount, 2),
                    Credit = 0,
                    Description = string.Format("SALES #:{0}. CUST:{1}.", e.TransactionNo, customerName),
                    DocumentNumber = e.TransactionNo
                };

                detail.AddNew();
                detail.Save();
                totalDebit += detail.Debit.Value;

                //-------------------------------------------------------------------------------
                // INCOME (C), COGS(D), INVENTORY (C)
                //-------------------------------------------------------------------------------
                foreach (var p in eItems)
                {
                    decimal amount;
                    decimal taxPercentage = e.IsTaxable.Value == 0 ? e.TaxPercentage.Value : 0;
                    amount = (p.Quantity.Value * p.Price.Value) + (taxPercentage / 100 * (p.Quantity.Value * p.Price.Value));

                    var itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var guarantorIncomeGroupDefault = "001";
                        var app = new AppParameter();
                        if (app.LoadByPrimaryKey("GuarantorIncomeGroupDefault"))
                            guarantorIncomeGroupDefault = app.ParameterValue;

                        var proAcc = new ProductAccountGuarantorGroup();
                        proAcc.Query.Where(proAcc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proAcc.Query.SRGuarantorIncomeGroup == guarantorIncomeGroupDefault);

                        if (proAcc.Load(proAcc.Query))
                        {
                            cIncomeCoaId = proAcc.ChartOfAccountIdIncome.Value;
                            cIncomeSubledgerId = proAcc.SubledgerIdIncome.Value;
                            dCogsCoaId = proAcc.ChartOfAccountIdCOGS.Value;
                            dCogsSubledgerId = proAcc.SubledgerIdCOGS.Value;
                            cInventoryCoaId = proAcc.ChartOfAccountIdInventory.Value;
                            cInventorySubLedgerId = proAcc.SubledgerIdInventory.Value;
                            dDiscountCoaId = proAcc.ChartOfAccountIdDiscount.Value;
                            dDiscountSubledgerId = proAcc.SubledgerIdDiscount.Value;

                            var paramCoaPPN = new AppParameter();
                            paramCoaPPN.LoadByPrimaryKey("coa_PpnSalesRJ");

                            var coaPPN = new ChartOfAccounts();
                            coaPPN.Query.Where(coaPPN.Query.ChartOfAccountCode == paramCoaPPN.ParameterValue);
                            coaPPN.Query.Load();

                            var discountAmount = (decimal)(p.Discount.Value * p.Quantity.Value);

                            JournalTransactionDetails income = new JournalTransactionDetails();
                            income.JournalId = header.JournalId;
                            income.ChartOfAccountId = ValidateCOA(cIncomeCoaId, coaColl, "PA Revenue");
                            income.SubLedgerId = cIncomeSubledgerId;
                            income.Debit = 0;
                            income.Credit = (e.ChargesAmount ?? 0) + discountAmount;
                            income.Description = string.Format("SALES #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                            income.DocumentNumber = e.TransactionNo;
                            income.Save();

                            totalCredit += income.Credit.Value;

                            if ((e.TaxAmount) != 0)
                            {
                                JournalTransactionDetails ppnSales = new JournalTransactionDetails();
                                ppnSales.JournalId = header.JournalId;
                                ppnSales.ChartOfAccountId = coaPPN.ChartOfAccountId;
                                ppnSales.SubLedgerId = cIncomeSubledgerId;
                                ppnSales.Debit = 0;
                                ppnSales.Credit = (e.TaxAmount ?? 0);
                                ppnSales.Description = string.Format("SALES TAX #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                                ppnSales.DocumentNumber = e.TransactionNo;
                                ppnSales.Save();

                                totalCredit += ppnSales.Credit.Value;
                            }

                            if (discountAmount > 0)
                            {
                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                disc.AddNew();
                                disc.JournalId = header.JournalId;
                                disc.ChartOfAccountId = ValidateCOA(dDiscountCoaId, coaColl, "PA Discount");
                                disc.SubLedgerId = dDiscountSubledgerId;
                                disc.Debit = Math.Abs(discountAmount);
                                disc.Credit = 0;
                                disc.Description = string.Format("DISC. SALES #:{0}. CUST:{1}. ITEM#:{2}.", e.TransactionNo, customerName, p.ItemName);
                                disc.DocumentNumber = e.TransactionNo;
                                disc.ItemID = p.ItemID;
                                disc.DocumentNumberSequenceNo = p.SequenceNo;
                                disc.Save();

                                totalDebit += disc.Debit.Value;
                            }

                            var mov = new ItemMovementQuery();
                            mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                       mov.CostPrice, "< SUM(QuantityOut) As Quantity >");
                            mov.Where(mov.TransactionNo == p.TransactionNo,
                                      mov.SequenceNo == p.SequenceNo, mov.ItemID == p.ItemID);
                            mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                            DataTable tbl = mov.LoadDataTable();

                            foreach (DataRow row in tbl.Rows)
                            {
                                decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                if (dCogsCoaId != 0)
                                {
                                    JournalTransactionDetails itemMedicCogs =
                                        new JournalTransactionDetails();
                                    itemMedicCogs.AddNew();
                                    itemMedicCogs.JournalId = header.JournalId;
                                    itemMedicCogs.ChartOfAccountId = ValidateCOA(dCogsCoaId, coaColl, "PA COGS");
                                    itemMedicCogs.SubLedgerId = dCogsSubledgerId;
                                    itemMedicCogs.Debit = Math.Abs(cogs ?? 0);
                                    itemMedicCogs.Credit = 0;
                                    itemMedicCogs.Description = string.Format("SALES #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                                    itemMedicCogs.DocumentNumber = e.TransactionNo;
                                    itemMedicCogs.ItemID = p.ItemID;
                                    itemMedicCogs.DocumentNumberSequenceNo = p.SequenceNo;
                                    itemMedicCogs.Save();

                                    totalDebit += itemMedicCogs.Debit.Value;
                                }

                                if (cInventoryCoaId != 0)
                                {
                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                    itemMedicInv.AddNew();
                                    itemMedicInv.JournalId = header.JournalId;
                                    itemMedicInv.ChartOfAccountId = ValidateCOA(cInventoryCoaId, coaColl, "PA Inventory");
                                    itemMedicInv.SubLedgerId = cInventorySubLedgerId;
                                    itemMedicInv.Debit = 0;
                                    itemMedicInv.Credit = Math.Abs(cogs ?? 0);
                                    itemMedicInv.Description = string.Format("SALES #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                                    itemMedicInv.DocumentNumber = e.TransactionNo;
                                    itemMedicInv.ItemID = p.ItemID;
                                    itemMedicInv.DocumentNumberSequenceNo = p.SequenceNo;
                                    itemMedicInv.Save();

                                    totalCredit += itemMedicInv.Credit.Value;
                                }
                            }
                        }
                    }
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    header.BeginEdit();
                    header.IsPosted = true;
                    header.EndEdit();
                    header.Save();
                }

                return header.JournalId ?? 0;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }


        public static int AddNewSalesReturnedJournal(ItemTransaction e, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            if (e.SRPaymentType == "CS" && AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoJournalCashSalesToCustomer) == "No")
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.SalesReturn;

            ServiceUnit toServiceUnit = new ServiceUnit();
            if (!toServiceUnit.LoadByPrimaryKey(e.ToServiceUnitID))
                return 0;

            try
            {
                //
                // Requirement:
                // ACCOUNT PAYABLE (C)
                // INCOME (D)
                // HPP (C)
                // INVENTORY (D)

                var eItems = new ItemTransactionItemCollection();
                var eItemQuery = new ItemTransactionItemQuery("e");
                var itemQuery = new ItemQuery("i");

                eItemQuery.Select(eItemQuery, eItemQuery.Description.As("refToItem_ItemName"), itemQuery.ProductAccountID.As("refToItem_ProductAccountId"));
                eItemQuery.LeftJoin(itemQuery).On(eItemQuery.ItemID == itemQuery.ItemID);
                eItemQuery.Where(eItemQuery.TransactionNo == e.TransactionNo);
                if (!eItems.Load(eItemQuery))
                    return 0;

                var customerName = string.Empty;
                var cust = new Customer();
                if (!cust.LoadByPrimaryKey(e.CustomerID))
                    return 0;

                customerName = cust.CustomerName;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("RET", e.TransactionDate.Value);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.LastUpdateDateTime = DateTime.Now;
                    header.LastUpdateByUserID = editedBy;

                    JournalErrorMessageDelete(header);
                }
                else
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = e.TransactionDate;
                    header.Description = string.Format("RETURN #:{0}. CUST:{1}.", e.TransactionNo, customerName);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = e.TransactionNo;
                }
                header.Save();


                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccountReceivableCoaId = 0;
                int cAccountReceivableSubLedgerId = 0;

                int dIncomeCoaId = 0;
                int dIncomeSubledgerId = 0;

                int cCogsCoaId = 0;
                int cCogsSubledgerId = 0;

                int dInventoryCoaId = 0;
                int dInventorySubLedgerId = 0;

                int cDiscountCoaId = 0;
                int cDiscountSubledgerId = 0;

                string paMsg = string.Empty;
                if (e.SRPaymentType == "CS")
                {
                    var appCoaCash = new AppParameter();
                    if (!appCoaCash.LoadByPrimaryKey("coa_SalesToCustomerCash"))
                        throw new Exception("App Parameter: coa_SalesToCustomerCash: Parameter not found!!");

                    cAccountReceivableCoaId = GetCachedAccountFromParam("coa_SalesToCustomerCash");
                    paMsg = "Sales To Customer Cash";
                }
                else if (cust.ChartOfAccountIdARTemporary.HasValue)
                {
                    //hutang diakui saat tukar faktur sehingga saat POR ditampung terlebih dahulu di account sementara
                    cAccountReceivableCoaId = cust.ChartOfAccountIdARTemporary.Value;
                    cAccountReceivableSubLedgerId = cust.SubledgerIdARTemporary.Value;
                    paMsg = "Customer A/R Process";
                }

                decimal receivableAmount = (e.ChargesAmount ?? 0) + (e.TaxAmount ?? 0);
                decimal discTotal = 0;

                var coaColl = new ChartOfAccountsCollection();

                //-------------------------------------------------------------------------------
                // ACCOUNT PAYABLE (C)
                //-------------------------------------------------------------------------------
                var netReceivableAmount = Math.Abs(receivableAmount) - discTotal;

                var detail = new JournalTransactionDetails
                {
                    JournalId = header.JournalId,
                    ChartOfAccountId = ValidateCOA(cAccountReceivableCoaId, coaColl, paMsg),
                    SubLedgerId = cAccountReceivableSubLedgerId,
                    Debit = 0,
                    Credit = decimal.Round((decimal)netReceivableAmount, 2),
                    Description = string.Format("RETURN #:{0}. CUST:{1}.", e.TransactionNo, customerName),
                    DocumentNumber = e.TransactionNo
                };

                detail.AddNew();
                detail.Save();
                totalCredit += detail.Credit.Value;

                //-------------------------------------------------------------------------------
                // INCOME (D), COGS(C), INVENTORY (D)
                //-------------------------------------------------------------------------------
                foreach (var p in eItems)
                {
                    decimal amount;
                    decimal taxPercentage = e.IsTaxable.Value == 0 ? e.TaxPercentage.Value : 0;
                    amount = (p.Quantity.Value * p.Price.Value) + (taxPercentage / 100 * (p.Quantity.Value * p.Price.Value));

                    var itemInv = new Item();
                    itemInv.Query.Where(itemInv.Query.ItemID == p.ItemID);
                    if (itemInv.Query.Load() && (itemInv.ProductAccountID != null))
                    {
                        var guarantorIncomeGroupDefault = "001";
                        var app = new AppParameter();
                        if (app.LoadByPrimaryKey("GuarantorIncomeGroupDefault"))
                            guarantorIncomeGroupDefault = app.ParameterValue;

                        var proAcc = new ProductAccountGuarantorGroup();
                        proAcc.Query.Where(proAcc.Query.ProductAccountID == itemInv.ProductAccountID,
                            proAcc.Query.SRGuarantorIncomeGroup == guarantorIncomeGroupDefault);

                        if (proAcc.Load(proAcc.Query))
                        {
                            dIncomeCoaId = proAcc.ChartOfAccountIdIncome.Value;
                            dIncomeSubledgerId = proAcc.SubledgerIdIncome.Value;
                            cCogsCoaId = proAcc.ChartOfAccountIdCOGS.Value;
                            cCogsSubledgerId = proAcc.SubledgerIdCOGS.Value;
                            dInventoryCoaId = proAcc.ChartOfAccountIdInventory.Value;
                            dInventorySubLedgerId = proAcc.SubledgerIdInventory.Value;
                            cDiscountCoaId = proAcc.ChartOfAccountIdDiscount.Value;
                            cDiscountSubledgerId = proAcc.SubledgerIdDiscount.Value;

                            var paramCoaPPN = new AppParameter();
                            paramCoaPPN.LoadByPrimaryKey("coa_PpnSalesRJ");

                            var coaPPN = new ChartOfAccounts();
                            coaPPN.Query.Where(coaPPN.Query.ChartOfAccountCode == paramCoaPPN.ParameterValue);
                            coaPPN.Query.Load();

                            var discountAmount = (decimal)(p.Discount.Value * p.Quantity.Value);

                            JournalTransactionDetails income = new JournalTransactionDetails();
                            income.JournalId = header.JournalId;
                            income.ChartOfAccountId = ValidateCOA(dIncomeCoaId, coaColl, "PA Revenue");
                            income.SubLedgerId = dIncomeSubledgerId;
                            income.Debit = Math.Abs(e.ChargesAmount ?? 0) - Math.Abs(discountAmount);
                            income.Credit = 0;
                            income.Description = string.Format("SALES RETURN #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                            income.DocumentNumber = e.TransactionNo;
                            income.Save();

                            totalDebit += income.Debit.Value;

                            if ((e.TaxAmount) != 0)
                            {
                                JournalTransactionDetails ppnSales = new JournalTransactionDetails();
                                ppnSales.JournalId = header.JournalId;
                                ppnSales.ChartOfAccountId = coaPPN.ChartOfAccountId;
                                ppnSales.SubLedgerId = dIncomeSubledgerId;
                                ppnSales.Debit = Math.Abs(e.TaxAmount ?? 0);
                                ppnSales.Credit = 0;
                                ppnSales.Description = string.Format("SALES RETURN TAX #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                                ppnSales.DocumentNumber = e.TransactionNo;
                                ppnSales.Save();

                                totalDebit += ppnSales.Debit.Value;
                            }


                            if (discountAmount > 0)
                            {
                                JournalTransactionDetails disc = new JournalTransactionDetails();
                                disc.AddNew();
                                disc.JournalId = header.JournalId;
                                disc.ChartOfAccountId = ValidateCOA(cDiscountCoaId, coaColl, "PA Discount");
                                disc.SubLedgerId = cDiscountSubledgerId;
                                disc.Debit = 0;
                                disc.Credit = Math.Abs(discountAmount);
                                disc.Description = string.Format("DISC. SALES RETURN #:{0}. CUST:{1}. ITEM#:{2}.", e.TransactionNo, customerName, p.ItemName);
                                disc.DocumentNumber = e.TransactionNo;
                                disc.ItemID = p.ItemID;
                                disc.DocumentNumberSequenceNo = p.SequenceNo;
                                disc.Save();

                                totalCredit += disc.Credit.Value;
                            }

                            var mov = new ItemMovementQuery();
                            mov.Select(mov.TransactionNo, mov.SequenceNo, mov.ItemID,
                                       mov.CostPrice, "< SUM(QuantityIn) As Quantity >");
                            mov.Where(mov.TransactionNo == p.TransactionNo,
                                      mov.SequenceNo == p.SequenceNo, mov.ItemID == p.ItemID);
                            mov.GroupBy(mov.TransactionNo, mov.SequenceNo, mov.ItemID, mov.CostPrice);
                            DataTable tbl = mov.LoadDataTable();

                            foreach (DataRow row in tbl.Rows)
                            {
                                decimal? cogs = (decimal)row["Quantity"] * (decimal)row["CostPrice"];

                                if (cCogsCoaId != 0)
                                {
                                    JournalTransactionDetails itemMedicCogs =
                                        new JournalTransactionDetails();
                                    itemMedicCogs.AddNew();
                                    itemMedicCogs.JournalId = header.JournalId;
                                    itemMedicCogs.ChartOfAccountId = ValidateCOA(cCogsCoaId, coaColl, "PA COGS");
                                    itemMedicCogs.SubLedgerId = cCogsSubledgerId;
                                    itemMedicCogs.Debit = 0;
                                    itemMedicCogs.Credit = Math.Abs(cogs ?? 0);
                                    itemMedicCogs.Description = string.Format("SALES RETURN #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                                    itemMedicCogs.DocumentNumber = e.TransactionNo;
                                    itemMedicCogs.ItemID = p.ItemID;
                                    itemMedicCogs.DocumentNumberSequenceNo = p.SequenceNo;
                                    itemMedicCogs.Save();

                                    totalCredit += itemMedicCogs.Credit.Value;
                                }

                                if (dInventoryCoaId != 0)
                                {
                                    JournalTransactionDetails itemMedicInv = new JournalTransactionDetails();
                                    itemMedicInv.AddNew();
                                    itemMedicInv.JournalId = header.JournalId;
                                    itemMedicInv.ChartOfAccountId = ValidateCOA(dInventoryCoaId, coaColl, "PA Inventory");
                                    itemMedicInv.SubLedgerId = dInventorySubLedgerId;
                                    itemMedicInv.Debit = Math.Abs(cogs ?? 0);
                                    itemMedicInv.Credit = 0;
                                    itemMedicInv.Description = string.Format("SALES RETURN #:{0}. CUST:{1}. ITEM:{2}-{3}", e.TransactionNo, customerName, p.ItemID, itemInv.ItemName);
                                    itemMedicInv.DocumentNumber = e.TransactionNo;
                                    itemMedicInv.ItemID = p.ItemID;
                                    itemMedicInv.DocumentNumberSequenceNo = p.SequenceNo;
                                    itemMedicInv.Save();

                                    totalDebit += itemMedicInv.Debit.Value;
                                }
                            }
                        }
                    }
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    header.BeginEdit();
                    header.IsPosted = true;
                    header.EndEdit();
                    header.Save();
                }

                return header.JournalId ?? 0;
            }
            catch (Exception ex)
            {
                JournalErrorMessageSave(journalId, ex, string.Empty, editedBy);
            }
            return journalId;
        }

        #endregion

        #region AR Customer
        public static int AddNewARCustomerPaymentJournal2(InvoiceCustomer ti, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ARCustomerPayment;

            //Logger.EnterMethod("AddNewARPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for InvoiceNo={0}", ti.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal payAmt = 0;
                decimal OtherAmt = 0;
                decimal Bank_Cost = 0;

                string payMethode = ti.SRPaymentMethod;
                string payType = ti.SRPaymentType;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                Bank bankEntity = null;  // used to create auto CM txn


                Customer g = new Customer();
                if (!g.LoadByPrimaryKey(ti.CustomerID))
                    return 0;

                InvoiceCustomerItemCollection tiItems = new InvoiceCustomerItemCollection();
                tiItems.Query.Where(tiItems.Query.InvoiceNo == ti.InvoiceNo);
                if (!tiItems.Query.Load())
                    return 0;

                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalARPaymentDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        ti.PaymentDate.Value.Date : ti.PaymentApprovedDate.Value.Date;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    entity.LastUpdateDateTime = DateTime.Now;
                    entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("ARC", jDate);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = jDate;
                    entity.Description = string.Format("INV PAYMENT#:{0} FOR INV#:{2}. CUST#:{1}.", ti.InvoiceNo, g.CustomerName, ti.InvoiceReferenceNo);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = ti.InvoiceNo;
                }
                entity.Save();

                Customer custEntity = new Customer();
                if (custEntity.LoadByPrimaryKey(ti.CustomerID))
                {
                    if (custEntity.ChartOfAccountIdAR.HasValue)
                    {
                        cAccount = custEntity.ChartOfAccountIdAR.Value;
                        cSubledgerId = (custEntity.SubledgerIdAR.HasValue ? custEntity.SubledgerIdAR.Value : 0);
                    }
                }


                // Hermawan
                if (ti.SRPaymentType.Equals("PaymentType-002") || ti.SRPaymentType.Equals("PaymentType-008") ||
                    ti.SRPaymentType.Equals("PaymentType-009")) /*ini saya tidak mengerti maksudnya yang ini,
                                                                 *kenapa tidak di loss-kan saja ya? (bt)20160201*/
                {
                    // BT
                    PaymentMethod pmAll = new PaymentMethod();
                    if (pmAll.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pmAll.ChartOfAccountID.HasValue)
                            dAccount = pmAll.ChartOfAccountID.Value;

                        if (pmAll.SubledgerID.HasValue)
                            dSubLedgerId = pmAll.SubledgerID.Value;
                    }
                    // -- end if BT

                    // Biaya Plafon RS
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-005"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-008"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }
                    }

                    // Payment Cash 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-001"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-002"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }
                    }

                    // Payment Credit Card || Payment Debit Card 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-002") || ti.SRPaymentMethod.Equals("PaymentMethod-003"))
                    {
                        EDCMachine edcMachineEntity = new EDCMachine();
                        if (edcMachineEntity.LoadByPrimaryKey(ti.EDCMachineID))
                        {
                            // Setting Account Code Per EDC Machine
                            if (edcMachineEntity.ChartOfAccountID.HasValue)
                            {
                                dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                dSubLedgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);

                                // di-unmark karena GPI payment kartu langsung masuk ke akun bank
                                bankEntity = new Bank();
                                bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == edcMachineEntity.ChartOfAccountID);
                                bankEntity.Query.Load();
                            }
                        }
                    }

                    // Payment Transfer 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-004"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;
                        }
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(ti.BankID))
                        {
                            if (bankEntity.ChartOfAccountId.HasValue)
                                dAccount = bankEntity.ChartOfAccountId.Value;
                            if (bankEntity.SubledgerId.HasValue)
                                dSubLedgerId = bankEntity.SubledgerId.Value;
                        }
                    }
                    //Cash AR
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-006"))
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;
                        }
                    }
                }

                int coa_discount = GetCachedAccountFromParam("coa_ReceiveableDiscount");
                int coa_biaya = GetCachedAccountFromParam("coa_BankCost");

                foreach (var p in tiItems)
                {
                    payAmt += (p.PaymentAmount ?? 0);
                    OtherAmt += (p.OtherAmount ?? 0);
                    Bank_Cost += (p.BankCost ?? 0);
                }

                // payment
                JournalTransactionDetails d = new JournalTransactionDetails();
                d.AddNew();
                d.JournalId = entity.JournalId;
                d.ChartOfAccountId = dAccount;
                d.SubLedgerId = dSubLedgerId;
                d.Debit = payAmt;
                d.Credit = 0;
                d.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. CUST#:{1}.", ti.InvoiceNo, g.CustomerName, ti.InvoiceReferenceNo);
                d.DocumentNumber = ti.InvoiceNo;
                d.Save();
                totalDebit += d.Debit.Value;

                //diskon
                if ((OtherAmt) > 0)
                {
                    JournalTransactionDetails e = new JournalTransactionDetails();
                    e.AddNew();
                    e.JournalId = entity.JournalId;
                    e.ChartOfAccountId = coa_discount;
                    e.SubLedgerId = 0;
                    e.Debit = OtherAmt;
                    e.Credit = 0;
                    e.Description = string.Format("INV PAYMENT DISCOUNT#:{0}. FOR INV#:{2}. CUST#:{1}.", ti.InvoiceNo, g.CustomerName, ti.InvoiceReferenceNo);
                    e.DocumentNumber = ti.InvoiceNo;
                    e.Save();
                    totalDebit += e.Debit.Value;
                }

                //biaya bank
                if (Bank_Cost > 0)
                {
                    JournalTransactionDetails f = new JournalTransactionDetails();
                    f.AddNew();
                    f.JournalId = entity.JournalId;
                    f.ChartOfAccountId = coa_biaya;
                    f.SubLedgerId = 0;
                    f.Debit = Bank_Cost;
                    f.Credit = 0;
                    f.Description = string.Format("INV PAYMENT BANK COST#:{0}. FOR INV#:{2}. CUST#:{1}.", ti.InvoiceNo, g.CustomerName, ti.InvoiceReferenceNo);
                    f.DocumentNumber = ti.InvoiceNo;
                    f.Save();
                    totalDebit += f.Debit.Value;
                }

                // credit
                JournalTransactionDetails c = new JournalTransactionDetails();
                c.AddNew();
                c.JournalId = entity.JournalId;
                c.ChartOfAccountId = cAccount;
                c.SubLedgerId = cSubledgerId;
                c.Debit = 0;
                c.Credit = payAmt + OtherAmt + Bank_Cost;
                c.Description = string.Format("INV PAYMENT#:{0}. FOR INV#:{2}. CUST#:{1}.", ti.InvoiceNo, g.CustomerName, ti.InvoiceReferenceNo);
                c.DocumentNumber = ti.InvoiceNo;
                c.Save();
                totalCredit += c.Credit.Value;

                if (totalDebit > 0 && bankEntity != null)
                {

                    decimal rate = 0;
                    CurrencyRate currencyRateEntity = new CurrencyRate();

                    if (currencyRateEntity.LoadByPrimaryKey(bankEntity.CurrencyCode))
                    {
                        rate = currencyRateEntity.CurrencyRate.Value;
                    }

                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, dAccount, ti.PaymentDate.Value,
                                                                   "ARC", "CUSTPAYMNT",
                                                                   ti.SRPaymentType, ti.SRPaymentMethod, "D",
                                                                   bankEntity.CurrencyCode, rate, string.Empty, ti.InvoiceNo,
                                                                   entity.Description, entity.JournalId ?? 0,
                                                                   editedBy,
                                                                   cAccount,
                                                                   payAmt,  // Account Payable Amount. Should be in original currency
                                                                   OtherAmt,//Diskon
                                                                   coa_discount,
                                                                   Bank_Cost,
                                                                   coa_biaya,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId != null && entity.JournalId != 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId ?? 0);
                    }

                    //jurnal auto approved
                    if (AppParameter.IsYes(AppParameter.ParameterItem.acc_IsAutoApprovedPayment))
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }

                //Logger.LeaveMethod("AddNewPaymentJournal");
                return entity.JournalId ?? 0;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }
        public static int AddNewARCustomerInvoicingJournal2Unapproval(InvoiceCustomer iv, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Invoice
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == iv.InvoiceNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                return AddNewReverseJournal(journalId, jhcoll[0].JournalId ?? 0, "IVC", editedBy, iv.VoidDate.Value) ?? 0;
            }
        }

        public static int AddNewARCustomerInvoicingJournal2(InvoiceCustomer iv, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ARCustomer;

            try
            {
                decimal totalDebit = 0;
                decimal totalCredit = 0;

                int cAccountReceivableCoaId = 0;
                int cAccountReceivableSubLedgerId = 0;
                int dAccountReceivableCoaId = 0;
                int dAccountReceivableSubLedgerId = 0;

                var customerName = string.Empty;
                var cust = new Customer();
                if (!cust.LoadByPrimaryKey(iv.CustomerID))
                    return 0;
                customerName = cust.CustomerName;

                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalARInvoicingDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ?
                        iv.InvoiceDate.Value.Date : iv.ApprovedDate.Value.Date;

                //Journal Header
                var journalCode = JournalCodes.GetOrCreateAutoJournalCode("IV", jDate);
                var journalNumber = JournalCodes.GenerateAndIncrementAutoNumber(journalCode);

                var header = new JournalTransactions();
                if (header.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == header.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    header.LastUpdateDateTime = DateTime.Now;
                    header.LastUpdateByUserID = editedBy;
                }
                else
                {
                    header.AddNew();
                    header.JournalType = journalType;
                    header.JournalCode = journalCode;
                    header.TransactionNumber = journalNumber;
                    header.TransactionDate = jDate;
                    header.Description = string.Format("CREATING INVOICE #:{0}. CUST:{1}.", iv.InvoiceNo, customerName);
                    header.IsPosted = false;
                    header.DateCreated = DateTime.Now;
                    header.LastUpdateDateTime = DateTime.Now;
                    header.CreatedBy = editedBy;
                    header.LastUpdateByUserID = editedBy;
                    header.RefferenceNumber = iv.InvoiceNo;
                }
                header.Save();

                if (cust.ChartOfAccountIdAR.HasValue)
                {
                    dAccountReceivableCoaId = cust.ChartOfAccountIdAR.HasValue ? cust.ChartOfAccountIdAR.Value : 0;
                    dAccountReceivableSubLedgerId = cust.SubledgerIdAR.HasValue ? cust.SubledgerIdAR.Value : 0;
                    cAccountReceivableCoaId = cust.ChartOfAccountIdARTemporary.HasValue ? cust.ChartOfAccountIdARTemporary.Value : 0;
                    cAccountReceivableSubLedgerId = cust.SubledgerIdARTemporary.HasValue ? cust.SubledgerIdARTemporary.Value : 0;
                }

                if (cAccountReceivableCoaId == 0)
                    return 0;
                if (dAccountReceivableCoaId == 0)
                    return 0;

                var eCust = new InvoiceCustomerItemCollection();
                eCust.Query.Where(eCust.Query.InvoiceNo == iv.InvoiceNo);
                if (!eCust.Query.Load())
                    return 0;

                foreach (var s in eCust)
                {
                    var e = new ItemTransaction();
                    e.LoadByPrimaryKey(s.TransactionNo);

                    // kurangin piutang dalam proses
                    var c = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = cAccountReceivableCoaId,
                        SubLedgerId = cAccountReceivableSubLedgerId,
                        Debit = s.Amount > 0 ? 0 : Math.Abs(s.Amount ?? 0),
                        Credit = s.Amount > 0 ? s.Amount : 0,
                        Description = string.Format("SALES #:{0}. CUST:{1}. INV:{2} ", e.TransactionNo, customerName, iv.InvoiceNo),
                        DocumentNumber = e.TransactionNo
                    };
                    c.AddNew();
                    c.Save();
                    totalCredit += c.Credit.Value;
                    totalDebit += c.Debit.Value;

                    //masukkan piutang terbaru
                    var f = new JournalTransactionDetails
                    {
                        JournalId = header.JournalId,
                        ChartOfAccountId = dAccountReceivableCoaId,
                        SubLedgerId = dAccountReceivableSubLedgerId,
                        Debit = s.Amount > 0 ? s.Amount : 0,
                        Credit = s.Amount > 0 ? 0 : Math.Abs(s.Amount ?? 0),
                        Description = string.Format("SALES #:{0}. CUST:{1}. INV:{2} ", e.TransactionNo, customerName, iv.InvoiceNo),
                        DocumentNumber = e.TransactionNo
                    };
                    f.AddNew();
                    f.Save();
                    totalDebit += f.Debit.Value;
                    totalCredit += f.Credit.Value;
                }

                if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                {
                    header.BeginEdit();
                    header.IsPosted = true;
                    header.EndEdit();
                    header.Save();
                }

                return header.JournalId ?? 0;
            }
            catch
            {
                return -1;
            }
        }
        public static int AddNewARCustomerPaymentJournal(InvoiceCustomer ti, string editedBy, int journalId)
        {
            if (!IsAutoJournalEnabled())
                return 0;

            string journalType = Temiang.Avicenna.BusinessObject.JournalType.ARCustomerPayment;

            //Logger.EnterMethod("AddNewARPaymentJournal");
            try
            {
                //Logger.LogMessage(string.Format("Create Journal Header for InvoiceNo={0}", ti.InvoiceNo));
                decimal totalDebit = 0;
                decimal totalCredit = 0;
                decimal payAmt = 0;
                decimal OtherAmt = 0;
                decimal Bank_Cost = 0;

                string payMethode = ti.SRPaymentMethod;
                string payType = ti.SRPaymentType;

                int cAccount = 0;
                int cSubledgerId = 0;
                int dAccount = 0;
                int dSubLedgerId = 0;

                Bank bankEntity = null;  // used to create auto CM txn


                Customer g = new Customer();
                if (!g.LoadByPrimaryKey(ti.CustomerID))
                    return 0;

                InvoiceCustomerItemCollection tiItems = new InvoiceCustomerItemCollection();
                tiItems.Query.Where(tiItems.Query.InvoiceNo == ti.InvoiceNo);
                if (!tiItems.Query.Load())
                    return 0;



                var appprmdate = new AppParameter();
                DateTime jDate = DateTime.Now;
                if (appprmdate.LoadByPrimaryKey("acc_JournalARPaymentDate"))
                    jDate = appprmdate.ParameterValue.ToString().Equals("0") ? ti.PaymentDate.Value.Date : ti.PaymentApprovedDate.Value.Date;

                //Journal Header
                JournalTransactions entity = new JournalTransactions();
                if (entity.LoadByPrimaryKey(journalId))
                {
                    var journalDetails = new JournalTransactionDetailsCollection();
                    journalDetails.Query.Where(journalDetails.Query.JournalId == entity.JournalId);
                    journalDetails.LoadAll();
                    journalDetails.MarkAllAsDeleted();
                    journalDetails.Save();

                    entity.LastUpdateDateTime = DateTime.Now;
                    entity.LastUpdateByUserID = editedBy;
                }
                else
                {
                    entity.AddNew();
                    entity.JournalType = journalType;
                    entity.JournalCode = JournalCodes.GetOrCreateAutoJournalCode("ARC", ti.InvoiceDate.Value);
                    entity.TransactionNumber = JournalCodes.GenerateAndIncrementAutoNumber(entity.JournalCode);
                    entity.TransactionDate = jDate;
                    entity.Description = string.Format("PAYMENT INV#:{0}. CUST#:{1}.", ti.InvoiceNo, g.CustomerName);
                    entity.IsPosted = false;
                    entity.DateCreated = entity.LastUpdateDateTime = DateTime.Now;
                    entity.CreatedBy = entity.CreatedBy = entity.LastUpdateByUserID = editedBy;
                    entity.RefferenceNumber = ti.InvoiceNo;
                }
                entity.Save();

                Customer custEntity = new Customer();
                if (custEntity.LoadByPrimaryKey(ti.CustomerID))
                {
                    if (custEntity.ChartOfAccountIdAR.HasValue)
                    {
                        cAccount = custEntity.ChartOfAccountIdAR.Value;
                        cSubledgerId = (custEntity.SubledgerIdAR.HasValue ? custEntity.SubledgerIdAR.Value : 0);
                    }
                }


                // Hermawan
                //if (ti.SRPaymentType.Equals("PaymentType-002") || ti.SRPaymentType.Equals("PaymentType-008"))
                {
                    // BT
                    PaymentMethod pmAll = new PaymentMethod();
                    if (pmAll.LoadByPrimaryKey(payType, payMethode))
                    {
                        if (pmAll.ChartOfAccountID.HasValue)
                            dAccount = pmAll.ChartOfAccountID.Value;

                        if (pmAll.SubledgerID.HasValue)
                            dSubLedgerId = pmAll.SubledgerID.Value;
                    }
                    // -- end if BT

                    // Biaya Plafon RS
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-005"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-008"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;

                            //var bankColl = new BankCollection();
                            //bankColl.Query.Where(bankColl.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankColl.LoadAll();
                            //if (bankColl.Count == 0)
                            //    return 2;

                            //bankEntity = new Bank();
                            //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                            //bankEntity.Query.Load();
                        }
                    }

                    // Payment Cash 
                    if (ti.SRPaymentMethod.Equals("PaymentMethod-001"))
                    {
                        PaymentType pt = new PaymentType();
                        if (pt.LoadByPrimaryKey("PaymentType-002"))
                        {
                            if (pt.ChartOfAccountID.HasValue)
                                dAccount = pt.ChartOfAccountID.Value;
                            if (pt.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;
                        }

                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pt.SubledgerID.Value;

                            bankEntity = new Bank();
                            bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == dAccount);
                            bankEntity.Query.Load();
                        }
                    }

                    // Payment Credit Card || Payment Debit Card 
                    else if (ti.SRPaymentMethod.Equals("PaymentMethod-002") || ti.SRPaymentMethod.Equals("PaymentMethod-003"))
                    {
                        EDCMachine edcMachineEntity = new EDCMachine();
                        if (edcMachineEntity.LoadByPrimaryKey(ti.EDCMachineID))
                        {
                            // Setting Account Code Per EDC Machine
                            if (edcMachineEntity.ChartOfAccountID.HasValue)
                            {
                                dAccount = edcMachineEntity.ChartOfAccountID.Value;
                                dSubLedgerId = (edcMachineEntity.SubledgerID.HasValue ? edcMachineEntity.SubledgerID.Value : 0);

                                // di-unmark karena GPI payment kartu langsung masuk ke akun bank
                                bankEntity = new Bank();
                                bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == edcMachineEntity.ChartOfAccountID);
                                bankEntity.Query.Load();
                            }
                        }
                    }
                    else
                    {
                        PaymentMethod pm = new PaymentMethod();
                        if (pm.LoadByPrimaryKey(payType, payMethode))
                        {
                            if (pm.ChartOfAccountID.HasValue)
                                dAccount = pm.ChartOfAccountID.Value;

                            if (pm.SubledgerID.HasValue)
                                dSubLedgerId = pm.SubledgerID.Value;
                        }
                        bankEntity = new Bank();
                        if (bankEntity.LoadByPrimaryKey(ti.BankID))
                        {
                            if (bankEntity.ChartOfAccountId.HasValue)
                                dAccount = bankEntity.ChartOfAccountId.Value;
                            if (bankEntity.SubledgerId.HasValue)
                                dSubLedgerId = bankEntity.SubledgerId.Value;
                        }

                        //// Payment Transfer 
                        //if (ti.SRPaymentMethod.Equals("PaymentMethod-004"))
                        //{
                        //    PaymentMethod pm = new PaymentMethod();
                        //    if (pm.LoadByPrimaryKey(payType, payMethode))
                        //    {
                        //        if (pm.ChartOfAccountID.HasValue)
                        //            dAccount = pm.ChartOfAccountID.Value;

                        //        if (pm.SubledgerID.HasValue)
                        //            dSubLedgerId = pm.SubledgerID.Value;
                        //    }
                        //    bankEntity = new Bank();
                        //    if (bankEntity.LoadByPrimaryKey(ti.BankID))
                        //    {
                        //        if (bankEntity.ChartOfAccountId.HasValue)
                        //            dAccount = bankEntity.ChartOfAccountId.Value;
                        //        if (bankEntity.SubledgerId.HasValue)
                        //            dSubLedgerId = bankEntity.SubledgerId.Value;
                        //    }
                        //}
                        ////Cash AR
                        //if (ti.SRPaymentMethod.Equals("PaymentMethod-006"))
                        //{
                        //    PaymentMethod pm = new PaymentMethod();
                        //    if (pm.LoadByPrimaryKey(payType, payMethode))
                        //    {
                        //        if (pm.ChartOfAccountID.HasValue)
                        //            dAccount = pm.ChartOfAccountID.Value;

                        //        if (pm.SubledgerID.HasValue)
                        //            dSubLedgerId = pm.SubledgerID.Value;

                        //        //bankEntity = new Bank();
                        //        //bankEntity.Query.Where(bankEntity.Query.ChartOfAccountId == pm.ChartOfAccountID);
                        //        //bankEntity.Query.Load();


                        //    }
                        //}

                    }

                }

                int coa_discount = GetCachedAccountFromParam("coa_ReceiveableDiscount");
                int coa_biaya = GetCachedAccountFromParam("coa_BankCost");

                foreach (var p in tiItems)
                {
                    JournalTransactionDetails d = new JournalTransactionDetails();
                    d.AddNew();
                    d.JournalId = entity.JournalId;
                    d.ChartOfAccountId = dAccount;
                    d.SubLedgerId = dSubLedgerId;
                    d.Debit = p.PaymentAmount > 0 ? p.PaymentAmount : 0;
                    d.Credit = p.PaymentAmount > 0 ? 0 : Math.Abs(p.PaymentAmount ?? 0);
                    d.Description = string.Format("INV#:{0}. CUST#:{1}. SALES#:{2}.", ti.InvoiceNo, g.CustomerName, p.TransactionNo);
                    d.DocumentNumber = ti.InvoiceNo;
                    d.Save();
                    totalDebit += d.Debit.Value;
                    totalCredit += d.Credit.Value;
                    payAmt += (p.PaymentAmount ?? 0);


                    //diskon
                    if ((p.OtherAmount ?? 0) > 0)
                    {
                        JournalTransactionDetails e = new JournalTransactionDetails();
                        e.AddNew();
                        e.JournalId = entity.JournalId;
                        e.ChartOfAccountId = coa_discount;
                        e.SubLedgerId = 0;
                        e.Debit = (p.OtherAmount ?? 0) > 0 ? (p.OtherAmount ?? 0) : 0;
                        e.Credit = (p.OtherAmount ?? 0) > 0 ? 0 : Math.Abs(p.OtherAmount ?? 0);
                        e.Description = string.Format("INV#:{0}. CUST#:{1}. SALES#:{2}.", ti.InvoiceNo, g.CustomerName, p.TransactionNo);
                        e.DocumentNumber = ti.InvoiceNo;
                        e.Save();
                        totalDebit += e.Debit.Value;
                        totalCredit += e.Credit.Value;
                        OtherAmt += e.Debit.Value;
                        payAmt += e.Debit.Value;
                    }


                    //biaya bank
                    if ((p.BankCost ?? 0) > 0)
                    {
                        JournalTransactionDetails f = new JournalTransactionDetails();
                        f.AddNew();
                        f.JournalId = entity.JournalId;
                        f.ChartOfAccountId = coa_biaya;
                        f.SubLedgerId = 0;
                        f.Debit = (p.BankCost ?? 0) > 0 ? (p.BankCost ?? 0) : 0;
                        f.Credit = (p.BankCost ?? 0) > 0 ? 0 : Math.Abs(p.BankCost ?? 0);
                        f.Description = string.Format("INV#:{0}. CUST#:{1}. SALES#:{2}.", ti.InvoiceNo, g.CustomerName, p.TransactionNo);
                        f.DocumentNumber = ti.InvoiceNo;
                        f.Save();
                        totalDebit += f.Debit.Value;
                        totalCredit += f.Credit.Value;
                        Bank_Cost += f.Debit.Value;
                        payAmt += f.Debit.Value;
                    }

                    decimal totAmt = (p.PaymentAmount ?? 0) + (p.OtherAmount ?? 0) + (p.BankCost ?? 0);

                    JournalTransactionDetails c = new JournalTransactionDetails();
                    c.AddNew();
                    c.JournalId = entity.JournalId;
                    c.ChartOfAccountId = cAccount;
                    c.SubLedgerId = cSubledgerId;
                    c.Debit = totAmt > 0 ? 0 : Math.Abs(totAmt);
                    c.Credit = totAmt > 0 ? totAmt : 0; // p.Amount;
                    c.Description = string.Format("SALES#:{0}. CUST:{1}.", p.TransactionNo, g.CustomerName);
                    c.DocumentNumber = ti.InvoiceNo;
                    c.Save();

                    totalCredit += c.Credit.Value;
                    totalDebit += c.Debit.Value;

                }

                if (totalDebit > 0 && bankEntity != null)
                {

                    decimal rate = 0;
                    CurrencyRate currencyRateEntity = new CurrencyRate();

                    if (currencyRateEntity.LoadByPrimaryKey(bankEntity.CurrencyCode))
                    {
                        rate = currencyRateEntity.CurrencyRate.Value;
                    }

                    int? cashTransactionId;
                    CashTransaction.AddNewAutomaticCashTransaction(bankEntity.BankID, dAccount, ti.PaymentDate.Value,
                                                                   "ARC", "CUSTPAYMNT",
                                                                   ti.SRPaymentType, ti.SRPaymentMethod, "D",
                                                                   bankEntity.CurrencyCode, rate, string.Empty, ti.InvoiceNo,
                                                                   entity.Description, entity.JournalId ?? 0,
                                                                   editedBy,
                                                                   cAccount,
                                                                   payAmt,  // Account Payable Amount. Should be in original currency
                                                                   OtherAmt,//Diskon
                                                                   coa_discount,
                                                                   Bank_Cost,
                                                                   coa_biaya,
                                                                   dSubLedgerId, out cashTransactionId);

                    // otomatis posting
                    if ((cashTransactionId.HasValue && cashTransactionId.Value > 0) && (entity.JournalId != null && entity.JournalId != 0))
                    {
                        CashTransaction.PostingUpdateBalance(cashTransactionId.Value, entity.JournalId ?? 0);
                    }

                    //jurnal auto approved
                    if (AppParameter.GetParameterValue(AppParameter.ParameterItem.acc_IsAutoApprovedPayment) == "Yes")
                    {
                        if ((totalCredit > 0 && totalDebit > 0) && (totalDebit == totalCredit))
                        {
                            entity.BeginEdit();
                            entity.IsPosted = true;
                            entity.EndEdit();
                            entity.Save();
                        }
                    }
                }

                return entity.JournalId ?? 0;
            }
            catch (Exception ex)
            {
                //Logger.LogException(ex);
                return -1;

            }
        }

        public static int? AddNewARCustomerPaymentJournalUnapproval(InvoiceCustomer ti, string editedBy, int journalId)
        {
            //Function ini digunakan untuk transaksi Void Invoice Payment Guarantor
            if (!IsAutoJournalEnabled())
                return 0;

            var jhcoll = new JournalTransactionsCollection();
            var qh = new JournalTransactionsQuery("qh");
            var qh2 = new JournalTransactionsQuery("qh2");
            qh.LeftJoin(qh2).On(qh.JournalId == qh2.JournalIdRefference);

            qh.es.Distinct = true;
            if (journalId == 0)
            {
                qh.Where(qh2.JournalId.IsNull());
            }
            else
            {
                qh.Where(qh2.JournalId == journalId);
            }

            qh.Where(qh.RefferenceNumber == ti.InvoiceNo, qh.JournalIdRefference.IsNull())
                .Select(qh);
            jhcoll.Load(qh);

            if (jhcoll.Count == 0)
            {
                return -1; // nothing to be reversed
            }
            else
            {
                // get cash entry by journalid
                CashTransactionCollection ctColl = new CashTransactionCollection();
                ctColl.Query.Where(
                    ctColl.Query.IsVoid == false, ctColl.Query.IsPosted == true);

                if (journalId == 0)
                {
                    ctColl.Query.Where(ctColl.Query.DocumentNumber == jhcoll[0].RefferenceNumber);
                }
                else
                {
                    ctColl.Query.Where(ctColl.Query.JournalId == jhcoll[0].JournalId.Value);
                }

                ctColl.LoadAll();

                if (ctColl.Count > 1)
                {
                    throw new Exception("Multiple cash entry detected for current payment");
                }
                else if (ctColl.Count == 1)
                {
                    if (ctColl.First().IsCleared ?? false == true)
                    {
                        throw new Exception("Cash entry for current payment is already cleared");
                    }
                }

                int? ret = AddNewReverseJournal(journalId, jhcoll[0].JournalId.Value, "ARC", editedBy);

                if (ret > 0 && ctColl.Count == 1)
                {
                    // undo cash entry
                    CashTransaction.UnPostingUpdateBalance(ctColl.First().TransactionId.Value);
                    //requery
                    CashTransaction ct = new CashTransaction();
                    if (ct.LoadByPrimaryKey(ctColl.First().TransactionId.Value))
                    {
                        ct.Void(editedBy);
                    }
                }

                return ret;
            }
        }

        #endregion
        #endregion

    }
}