using System;
using System.Data;
using System.Linq;
using System.Collections.Generic;
using Temiang.Avicenna.BusinessObject.Common;

namespace Temiang.Avicenna.BusinessObject
{
    public partial class ItemBalance
    {

        private const string _chargesCode = Reference.TransactionCode.Charges; //"003";
        private const string _adjustmentCode = Reference.TransactionCode.StockAdjustment; // "074";
        private const string _opnameCode = Reference.TransactionCode.StockTaking; // "075";
        private const string _distributionCode = Reference.TransactionCode.Distribution; // "050";
        private const string _productionOfGoodsCode = Reference.TransactionCode.ProductionOfGoods; // "046";
        private const string _assetWorkOrderRealizationCode = Reference.TransactionCode.AssetWorkOrderRealization; // "202";
        private const string _consignmentTransferCode = Reference.TransactionCode.ConsignmentTransfer; // "060";
        private const string _laundryWashingProcessCode = Reference.TransactionCode.LaundryWashingProcess; // "206";

        public string ItemName
        {
            get { return GetColumn("refToItem_ItemName").ToString(); }
            set { SetColumn("refToItem_ItemName", value); }
        }

        public string LocationName
        {
            get { return GetColumn("refToLocation_LocationName").ToString(); }
            set { SetColumn("refToLocation_LocationName", value); }
        }

        public string SRItemUnitName
        {
            get { return GetColumn("refToSRI_ItemUnit").ToString(); }
            set { SetColumn("refToSRI_ItemUnit", value); }
        }

        public string SRItemBinName
        {
            get { return GetColumn("refToSRI_ItemBin").ToString(); }
            set { SetColumn("refToSRI_ItemBin", value); }
        }

        public static void PrepareItemBalances(TransChargesItem entity, string serviceUnitID, string locationID, string userID,
            ref ItemBalance itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements,
            ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            decimal? resultQty = entity.StockQuantity;
            string itemID = entity.ItemID;

            var item = new Item();
            item.LoadByPrimaryKey(entity.ItemID);

            decimal lastPrice = 0;
            decimal price = 0;
            switch (item.SRItemType)
            {
                case Reference.ItemType.Medical:
                    var med = new ItemProductMedic();
                    med.LoadByPrimaryKey(item.ItemID);
                    entity.CostPrice = med.CostPrice;
                    lastPrice = med.LastPriceInBaseUnit ?? 0;
                    price = med.PriceInBaseUnit ?? 0;

                    if (!(med.IsInventoryItem ?? false))
                        return;

                    break;
                case Reference.ItemType.NonMedical:
                    var nmed = new ItemProductNonMedic();
                    nmed.LoadByPrimaryKey(item.ItemID);
                    entity.CostPrice = nmed.CostPrice;
                    lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                    price = nmed.PriceInBaseUnit ?? 0;

                    if (!(nmed.IsInventoryItem ?? false))
                        return;
                    break;
                case Reference.ItemType.Kitchen:
                    var kitc = new ItemKitchen();
                    kitc.LoadByPrimaryKey(item.ItemID);
                    entity.CostPrice = kitc.CostPrice;
                    lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                    price = kitc.PriceInBaseUnit ?? 0;

                    if (!(kitc.IsInventoryItem ?? false))
                        return;
                    break;
            }

            #region balance
            if (!itemBalance.LoadByPrimaryKey(locationID, entity.ItemID))
            {
                itemBalance = null;
                return;
            }

            itemBalance.Balance -= resultQty;
            itemBalance.LastUpdateDateTime = Utils.NowAtSqlServer();
            itemBalance.LastUpdateByUserID = userID;
            #endregion

            if (!isEnabledStockWithEdControl)
            {
                // balance detail (fifo) and movement
                itemBalanceDetails.Query.Where
                    (
                        itemBalanceDetails.Query.LocationID == locationID,
                        itemBalanceDetails.Query.ItemID == entity.ItemID,
                        itemBalanceDetails.Query.Balance > 0
                    );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemBalanceDetails = null;
                //    return;
                //}

                itemBalanceDetailEds = null;

                try
                {
                    // query
                    var details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                    if (details.Balance >= entity.StockQuantity)
                    {
                        // mark if using average
                        //if (parCostType != "AVG")
                        //    entity.CostPrice = details.Price;

                        #region balance detail (fifo)
                        details.Balance -= resultQty;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        #endregion

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer();
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _chargesCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.InitialStock = itemBalance.Balance + resultQty;
                        movement.QuantityOut = resultQty;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = entity.SRItemUnit;
                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                        movement.SalesPrice = entity.Price;
                        movement.PurchasePrice = details.Price;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion
                    }
                    else
                    {
                        decimal? qty = resultQty; // 5
                        int i = 0;
                        while (qty > 0)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //    entity.CostPrice = details.Price;

                            if (i == 0)
                                qty = resultQty - details.Balance; // 5 - 2
                            else
                                qty -= details.Balance;

                            if (qty > 0)
                            {
                                var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                        .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = mvm == null ? (itemBalance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                movement.QuantityOut = details.Balance;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.SalesPrice = entity.Price;
                                movement.PurchasePrice = details.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                var initialStock = movement.InitialStock - movement.QuantityOut;

                                #region balance detail (fifo)
                                details.Balance = 0;
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion

                                try
                                {
                                    // re-query
                                    details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                             .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                }
                                catch (Exception)
                                {
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                             .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                        #region movement
                                        movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = initialStock;
                                        movement.QuantityOut = qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                        movement.SalesPrice = entity.Price;
                                        movement.PurchasePrice = details.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        details.Balance = movement.InitialStock - movement.QuantityOut;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        qty = 0;
                                    }
                                    catch (Exception)
                                    {
                                        #region movement
                                        movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = initialStock;
                                        movement.QuantityOut = qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                        movement.SalesPrice = entity.Price;
                                        movement.PurchasePrice = details.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = entity.ItemID;
                                        details.ReferenceNo = string.Empty;
                                        details.TransactionCode = string.Empty;
                                        details.BalanceDate = Utils.NowAtSqlServer();
                                        details.Balance = movement.InitialStock - movement.QuantityOut;
                                        details.Booking = 0;
                                        details.Price = entity.CostPrice;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        details.PurchaseReceiveNo = string.Empty;
                                        #endregion

                                        qty = 0;
                                    }
                                }
                            }
                            else
                            {
                                #region balance detail (fifo)
                                var bal = details.Balance;
                                details.Balance -= (details.Balance + qty);
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                movement.QuantityOut = bal + qty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.SalesPrice = entity.Price;
                                movement.PurchasePrice = details.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }

                            i++;
                        }
                    }
                }
                catch (Exception)
                {
                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                             .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer();
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _chargesCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.InitialStock = itemBalance.Balance + resultQty;
                        movement.QuantityOut = resultQty;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = entity.SRItemUnit;
                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                        movement.SalesPrice = entity.Price;
                        movement.PurchasePrice = details.Price;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail (fifo)
                        details.Balance = movement.InitialStock - movement.QuantityOut;
                        details.LastUpdateByUserID = userID;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        #endregion
                    }
                    catch (Exception)
                    {
                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer();
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _chargesCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.InitialStock = itemBalance.Balance + resultQty;
                        movement.QuantityOut = resultQty;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = entity.SRItemUnit;
                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                        movement.SalesPrice = entity.Price;
                        movement.PurchasePrice = entity.Price;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail (fifo)
                        var details = itemBalanceDetails.AddNew();
                        details.LocationID = locationID;
                        details.ItemID = entity.ItemID;
                        details.ReferenceNo = string.Empty;
                        details.TransactionCode = string.Empty;
                        details.BalanceDate = Utils.NowAtSqlServer();
                        details.Balance = movement.InitialStock - movement.QuantityOut;
                        details.Booking = 0;
                        details.Price = entity.CostPrice;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        details.PurchaseReceiveNo = string.Empty;
                        #endregion
                    }
                }
            }
            else
            {
                // balance detail (fefo) and movement
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == locationID,
                        itemBalanceDetailEds.Query.ItemID == entity.ItemID, itemBalanceDetailEds.Query.IsActive == true
                    );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Ascending);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemBalanceDetailEds = null;
                //    return;
                //}

                itemBalanceDetails = null;

                try
                {
                    // query
                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                    if (details.Balance >= entity.StockQuantity)
                    {

                        #region balance detail (fefo)
                        details.Balance -= resultQty;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        #endregion

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer();
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _chargesCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.ExpiredDate = details.ExpiredDate;
                        movement.BatchNumber = details.BatchNumber;
                        movement.InitialStock = itemBalance.Balance + resultQty;
                        movement.QuantityOut = resultQty;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = entity.SRItemUnit;
                        movement.CostPrice = entity.CostPrice;
                        movement.SalesPrice = entity.Price;
                        movement.PurchasePrice = price;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion
                    }
                    else
                    {
                        decimal? qty = resultQty; // 5
                        int i = 0;
                        while (qty > 0)
                        {
                            if (i == 0)
                                qty = resultQty - details.Balance; // 5 - 2
                            else
                                qty -= details.Balance;

                            if (qty > 0)
                            {
                                var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                        .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = mvm == null ? (itemBalance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                movement.QuantityOut = details.Balance;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = entity.Price;
                                movement.PurchasePrice = price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;

                                var initialStock = movement.InitialStock - movement.QuantityOut;
                                #endregion

                                #region balance detail (fefo)
                                details.Balance = 0;
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion

                                try
                                {
                                    // re-query
                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                }
                                catch (Exception)
                                {
                                    try
                                    {
                                        // re-query
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                        #region movement
                                        movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = initialStock;
                                        movement.QuantityOut = qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = entity.Price;
                                        movement.PurchasePrice = price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fefo)
                                        details.Balance = movement.InitialStock - movement.QuantityOut;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        qty = 0;
                                    }
                                    catch (Exception)
                                    {
                                        return;
                                    }
                                }
                            }
                            else
                            {
                                #region balance detail (fefo)
                                var bal = details.Balance;
                                details.Balance -= (details.Balance + qty);
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                movement.QuantityOut = bal + qty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.SalesPrice = entity.Price;
                                movement.PurchasePrice = price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }

                            i++;
                        }
                    }
                }
                catch (Exception)
                {
                    try
                    {
                        var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer();
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _chargesCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.ExpiredDate = details.ExpiredDate;
                        movement.BatchNumber = details.BatchNumber;
                        movement.InitialStock = itemBalance.Balance + resultQty;
                        movement.QuantityOut = resultQty;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = entity.SRItemUnit;
                        movement.CostPrice = entity.CostPrice;
                        movement.SalesPrice = entity.Price;
                        movement.PurchasePrice = price;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail (fefo)
                        details.Balance = movement.InitialStock - movement.QuantityOut;
                        details.LastUpdateByUserID = userID;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        #endregion
                    }
                    catch (Exception)
                    {
                        return;
                    }
                }

            }
        }

        public static void PrepareItemBalances(TransChargesItemCollection coll, string serviceUnitID, string locationID,
           string userID, bool isApproval, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
           ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var itemsX = (coll.Select(i => i.ItemID)).Distinct();
            var itemColl = new ItemCollection();
            itemColl.Query.Where(
                itemColl.Query.ItemID.In(itemsX),
                itemColl.Query.SRItemType.In(
                    new string[]{
                        Reference.ItemType.Medical,
                        Reference.ItemType.NonMedical,
                        Reference.ItemType.Kitchen
                    }));

            if (!itemColl.LoadAll())
            {
                // no item product, we can skip the rest
                return;
            }

            var itemproducts = (itemColl.Select(i => i.ItemID)).Distinct();

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(itemproducts)
                );
            itemBalance.LoadAll();

            var unmappedItems = itemBalance.Where(x => !itemproducts.Contains(x.ItemID)).Select(x => x.ItemID);
            if (itemBalance.Count == 0) unmappedItems = itemproducts;

            if (unmappedItems.Count() > 0)
            {
                var ret = string.Empty;
                foreach (var unmappedItem in unmappedItems)
                {
                    ret += (ret.Length == 0 ? "" : ", ") + itemColl.Where(x => x.ItemID == unmappedItem).First().ItemName;
                }
                itemNoStock = ret + " (Unmapping item: ItemBalance)";
                return;
            }

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where(
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(itemproducts)
                //,
                //itemBalanceDetails.Query.Balance > 0
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //unmappedItems = itemBalanceDetails.Where(x => !itemproducts.Contains(x.ItemID)).Select(x => x.ItemID);
                //if (itemBalanceDetails.Count == 0) unmappedItems = itemproducts;

                //if (unmappedItems.Count() > 0)
                //{
                //    var ret = string.Empty;
                //    foreach (var unmappedItem in unmappedItems)
                //    {
                //        ret += (ret.Length == 0 ? "" : ", ") + itemColl.Where(x => x.ItemID == unmappedItem).First().ItemName;
                //    }
                //    itemNoStock = ret + " (Unmapping item: ItemBalanceDetail)";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed
                itemBalanceDetailEds.Query.Where(
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(itemproducts), itemBalanceDetailEds.Query.IsActive == true
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Ascending);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //unmappedItems = itemBalanceDetailEds.Where(x => !itemproducts.Contains(x.ItemID)).Select(x => x.ItemID);
                //if (itemBalanceDetailEds.Count == 0) unmappedItems = itemproducts;

                //if (unmappedItems.Count() > 0)
                //{
                //    var ret = string.Empty;
                //    foreach (var unmappedItem in unmappedItems)
                //    {
                //        ret += (ret.Length == 0 ? "" : ", ") + itemColl.Where(x => x.ItemID == unmappedItem).First().ItemName;
                //    }
                //    itemNoStock = ret + " (Unmapping item: ItemBalanceDetailEd)";
                //    return;
                //}

                itemBalanceDetails = null;
            }

            foreach (var entity in coll.Where(c => string.IsNullOrEmpty(c.ParentNo) &&
                                                   !(c.IsVoid ?? false)))
            {
                // kl detail package maka diskip karena nanti akan dihitung di function PrepareItemBalances-TransChargesItemConsumptions
                var resultQty = entity.StockQuantity;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                decimal price = 0;
                decimal lastPrice = 0;
                decimal discPctg = 0;
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        discPctg = med.PurchaseDiscount1 ?? 0;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        discPctg = nmed.PurchaseDiscount1 ?? 0;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        discPctg = kitc.PurchaseDiscount1 ?? 0;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        break;
                    default:
                        continue;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0 && discPctg < 100)
                {
                    itemNoStock = "Zero|" + item.ItemName;
                    return;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                if (resultQty > 0)
                {
                    if (balance == null)
                    {
                        itemNoStock = item.ItemName;
                        return;
                    }

                    if (balance.Balance < resultQty)
                    {
                        itemNoStock = item.ItemName;
                        return;
                    }
                }

                if (isApproval)
                    balance.Balance -= resultQty;

                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                if (!isEnabledStockWithEdControl)
                {
                    // balance detail (fifo) and movement
                    if (isApproval)
                    {
                        // query
                        if (resultQty > 0)
                        {
                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == item.ItemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                             .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG")
                                    //    entity.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    var qty = resultQty; // 5
                                    var i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG")
                                        //    entity.CostPrice = details.Price;

                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            try
                                            {
                                                // re-query
                                                details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                             .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                            .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _chargesCode;
                                                    movement.TransactionNo = entity.TransactionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _chargesCode;
                                                    movement.TransactionNo = entity.TransactionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = entity.ItemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = entity.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }

                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                            .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = entity.ItemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = entity.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                    }
                }
                else
                {
                    // balance detail ed (fefo) and movement
                    if (isApproval)
                    {
                        // query
                        if (resultQty > 0)
                        {
                            try
                            {
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID &&
                                                                         b.Balance > 0)
                                                             .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {

                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    var qty = resultQty; // 5
                                    var i = 0;
                                    while (qty > 0)
                                    {
                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            try
                                            {
                                                // re-query
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                             .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    // re-query
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                                 .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _chargesCode;
                                                    movement.TransactionNo = entity.TransactionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                                    return;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fefo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    // re-query
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                 .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                    return;
                                }
                            }
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalances(TransChargesItemConsumptionCollection consColl, string serviceUnitID, string locationID, string userID,
            ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements,
            ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var coll = consColl.Where(i => i.LocationID == locationID);
            var items = (coll.Select(i => i.DetailItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            //cek mapping item
            var unmappedItems = itemBalance.Where(x => !items.Contains(x.ItemID)).Select(x => x.ItemID);
            if (itemBalance.Count == 0) unmappedItems = items;

            if (unmappedItems.Count() > 0)
            {
                var ret = string.Empty;
                foreach (var unmappedItem in unmappedItems)
                {
                    ret += (ret.Length == 0 ? "" : ", ") + coll.Where(x => x.DetailItemID == unmappedItem).First().ItemName;
                }
                itemNoStock = ret + " (Unmapping item: ItemBalance)";
                return;
            }

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                //,
                //itemBalanceDetails.Query.Balance > 0
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                ////cek mapping item
                //unmappedItems = itemBalanceDetails.Where(x => !items.Contains(x.ItemID)).Select(x => x.ItemID);
                //if (itemBalanceDetails.Count == 0) unmappedItems = items;

                //if (unmappedItems.Count() > 0)
                //{
                //    var ret = string.Empty;
                //    foreach (var unmappedItem in unmappedItems)
                //    {
                //        ret += (ret.Length == 0 ? "" : ", ") + coll.Where(x => x.DetailItemID == unmappedItem).First().ItemName;
                //    }
                //    itemNoStock = ret + " (Unmapping item: ItemBalanceDetail)";
                //    return;
                //}

                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items),
                    itemBalanceDetailEds.Query.IsActive == true
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Ascending);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //cek mapping item
                //unmappedItems = itemBalanceDetailEds.Where(x => !items.Contains(x.ItemID)).Select(x => x.ItemID);
                //if (itemBalanceDetailEds.Count == 0) unmappedItems = items;

                //if (unmappedItems.Count() > 0)
                //{
                //    var ret = string.Empty;
                //    foreach (var unmappedItem in unmappedItems)
                //    {
                //        ret += (ret.Length == 0 ? "" : ", ") + coll.Where(x => x.DetailItemID == unmappedItem).First().ItemName;
                //    }
                //    itemNoStock = ret + " (Unmapping item: ItemBalanceDetailEd)";
                //    return;
                //}

                //if (itemBalanceDetailEds.Count == 0)
                //    return;

                itemBalanceDetails = null;
            }


            foreach (TransChargesItemConsumption entity in coll)
            {
                decimal? resultQty = entity.QtyRealization;
                decimal price = 0;
                decimal lastPrice = 0;
                decimal discPctg = 0;
                var item = new Item();
                item.LoadByPrimaryKey(entity.DetailItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = med.CostPrice;
                        entity.FifoPrice = med.CostPrice;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        discPctg = med.PurchaseDiscount1 ?? 0;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = nmed.CostPrice;
                        entity.FifoPrice = nmed.CostPrice;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        discPctg = nmed.PurchaseDiscount1 ?? 0;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemProductNonMedic();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = kitc.CostPrice;
                        entity.FifoPrice = kitc.CostPrice;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        discPctg = kitc.PurchaseDiscount1 ?? 0;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        break;
                    default:
                        continue;
                }

                if ((entity.AveragePrice ?? 0) == 0 && price > 0 && discPctg < 100)
                {
                    itemNoStock = "Zero|" + item.ItemName;
                    return;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.DetailItemID);
                if (balance == null)
                {
                    itemNoStock = item.ItemName;
                    return;
                }
                if (resultQty > 0)
                {
                    if ((balance.Balance) < resultQty)
                    {
                        itemNoStock = item.ItemName;
                        return;
                    }
                }

                balance.Balance -= resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                // balance detail (fifo) and movement

                // query
                if (resultQty > 0)
                {
                    if (!isEnabledStockWithEdControl)
                    {
                        //db:20231219 - override jika tidak ada
                        //// cek balance detail
                        //var ibds = new ItemBalanceDetailCollection();
                        //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == item.ItemID, ibds.Query.Balance > 0);
                        //ibds.LoadAll();

                        //if (ibds.Count == 0)
                        //{
                        //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                        //    return;
                        //}

                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.DetailItemID && b.Balance > 0)
                                .OrderBy(b => b.BalanceDate)).Take(1).Single();

                            if (details.Balance >= resultQty)
                            {
                                // mark if using average
                                //if (parCostType != "AVG")
                                //    entity.FifoPrice = details.Price;

                                #region balance detail (fifo)
                                details.Balance -= resultQty;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityIn = 0;
                                movement.QuantityOut = resultQty;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.AveragePrice : details.Price;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = details.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }
                            else
                            {
                                decimal? qty = resultQty; // 5
                                int i = 0;
                                while (qty > 0)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG")
                                    //    entity.FifoPrice = details.Price;

                                    if (i == 0)
                                        qty = resultQty - details.Balance; // 5 - 2
                                    else
                                        qty -= details.Balance;

                                    if (qty > 0)
                                    {
                                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                        movement.QuantityOut = details.Balance;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.AveragePrice : details.Price;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = details.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        var initialStock = movement.InitialStock - movement.QuantityOut;

                                        #region balance detail (fifo)
                                        details.Balance = 0;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        // re-query
                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.DetailItemID && b.Balance > 0)
                                                                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                        }
                                        catch (Exception)
                                        {
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == entity.DetailItemID)
                                                        .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _chargesCode;
                                                movement.TransactionNo = entity.TransactionNo;
                                                movement.SequenceNo = entity.SequenceNo;
                                                movement.ItemID = entity.DetailItemID;
                                                movement.str.ExpiredDate = string.Empty;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                movement.SalesPrice = 0;
                                                movement.PurchasePrice = details.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fifo)
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                qty = 0;
                                            }
                                            catch (Exception)
                                            {
                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _chargesCode;
                                                movement.TransactionNo = entity.TransactionNo;
                                                movement.SequenceNo = entity.SequenceNo;
                                                movement.ItemID = entity.DetailItemID;
                                                movement.str.ExpiredDate = string.Empty;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                movement.SalesPrice = 0;
                                                movement.PurchasePrice = details.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fifo)
                                                details = itemBalanceDetails.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = entity.DetailItemID;
                                                details.ReferenceNo = string.Empty;
                                                details.TransactionCode = string.Empty;
                                                details.BalanceDate = Utils.NowAtSqlServer();
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.Booking = 0;
                                                details.Price = entity.AveragePrice;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                details.LastUpdateByUserID = userID;
                                                details.PurchaseReceiveNo = string.Empty;
                                                #endregion

                                                qty = 0;
                                            }

                                            //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                            //return;
                                            ////throw;
                                        }

                                    }
                                    else
                                    {
                                        #region balance detail (fifo)
                                        var bal = details.Balance;
                                        details.Balance -= (details.Balance + qty);
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                        movement.QuantityOut = bal + qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.AveragePrice : details.Price;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = details.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion
                                    }

                                    i++;
                                }
                            }
                        }
                        catch (Exception)
                        {
                            try
                            {
                                var details = (itemBalanceDetails.Where(b => b.ItemID == entity.DetailItemID)
                                        .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityIn = 0;
                                movement.QuantityOut = resultQty;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.AveragePrice : details.Price;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = details.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fifo)
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion
                            }
                            catch (Exception)
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityIn = 0;
                                movement.QuantityOut = resultQty;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.AveragePrice; // (parCostType == "AVG") ? entity.AveragePrice : details.Price;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = entity.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fifo)
                                var details = itemBalanceDetails.AddNew();
                                details.LocationID = locationID;
                                details.ItemID = entity.DetailItemID;
                                details.ReferenceNo = string.Empty;
                                details.TransactionCode = string.Empty;
                                details.BalanceDate = Utils.NowAtSqlServer();
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.Booking = 0;
                                details.Price = entity.AveragePrice;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                details.PurchaseReceiveNo = string.Empty;
                                #endregion
                            }
                        }
                    }
                    else
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.DetailItemID && b.Balance > 0)
                            .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                            if (details.Balance >= resultQty)
                            {
                                #region balance detail ed (fefo)
                                details.Balance -= resultQty;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityIn = 0;
                                movement.QuantityOut = resultQty;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.AveragePrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }
                            else
                            {
                                decimal? qty = resultQty; // 5
                                int i = 0;
                                while (qty > 0)
                                {
                                    if (i == 0)
                                        qty = resultQty - details.Balance; // 5 - 2
                                    else
                                        qty -= details.Balance;

                                    if (qty > 0)
                                    {
                                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                        movement.QuantityOut = details.Balance;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.AveragePrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;

                                        var initialStock = movement.InitialStock - movement.QuantityOut;
                                        #endregion

                                        #region balance detail (fefo)
                                        details.Balance = 0;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        // re-query
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.DetailItemID && b.Balance > 0)
                                                                                                         .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                        }
                                        catch (Exception)
                                        {
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.DetailItemID)
                                                                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _chargesCode;
                                                movement.TransactionNo = entity.TransactionNo;
                                                movement.SequenceNo = entity.SequenceNo;
                                                movement.ItemID = entity.DetailItemID;
                                                movement.ExpiredDate = details.ExpiredDate;
                                                movement.BatchNumber = details.BatchNumber;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.AveragePrice;
                                                movement.SalesPrice = 0;
                                                movement.PurchasePrice = price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fefo)
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                qty = 0;
                                            }
                                            catch (Exception)
                                            {
                                                itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                                return;
                                            }
                                        }

                                    }
                                    else
                                    {
                                        #region balance detail (fefo)
                                        var bal = details.Balance;
                                        details.Balance -= (details.Balance + qty);
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                        movement.QuantityOut = bal + qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.AveragePrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion
                                    }

                                    i++;
                                }
                            }
                        }
                        catch (Exception)
                        {
                            try
                            {
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.DetailItemID)
                                                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.AveragePrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fefo)
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion
                            }
                            catch (Exception)
                            {
                                itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                return;
                            }
                        }

                    }

                }
            }
        }

        public static void PrepareItemBalancesForCorrection(TransChargesItemCollection coll, string serviceUnitID, string locationID,
           string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
           ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemZeroCostPrice)
        {
            itemZeroCostPrice = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where(
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Descending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail
                itemBalanceDetailEds.Query.Where(
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items)
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Descending);
                itemBalanceDetailEds.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //    return;

                itemBalanceDetails = null;
            }

            foreach (var entity in coll.Where(c => string.IsNullOrEmpty(c.ParentNo) &&
                                                   !(c.IsVoid ?? false)))
            {
                // kl detail package maka diskip karena nanti akan dihitung di function PrepareItemBalances-TransChargesItemConsumptions
                var resultQty = entity.StockQuantity;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                decimal price = 0;
                decimal lastPrice = 0;

                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        break;
                    default:
                        continue;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0)
                {
                    itemZeroCostPrice = item.ItemName;
                    return;
                }

                var tc = new TransCharges();
                tc.LoadByPrimaryKey(entity.TransactionNo);

                var query = new ItemMovementQuery();
                query.Where(query.TransactionNo == tc.ReferenceNo, query.SequenceNo == entity.SequenceNo, query.ItemID == entity.ItemID);
                query.OrderBy(query.MovementDate.Descending);

                var tbl = new DataTable();
                tbl = query.LoadDataTable();

                var tp = new TransChargesQuery("a");
                var tpi = new TransChargesItemQuery("b");

                tp.Select("<SUM(ISNULL(b.StockQuantity,0)) AS Qty>");
                tp.InnerJoin(tpi).On(
                    tp.TransactionNo == tpi.TransactionNo &&
                    tp.ReferenceNo == tc.ReferenceNo &&
                    tpi.SequenceNo == entity.SequenceNo &&
                    tp.TransactionNo != tc.TransactionNo
                    )
                    .Where(tp.IsApproved == true, tp.IsVoid == false,
                        tpi.IsApprove == true, tpi.IsVoid == false);
                tp.GroupBy(tpi.ItemID);

                DataTable tblReturnedQty = tp.LoadDataTable();

                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);
                decimal blc = (balance.Balance ?? 0);
                decimal qty = Math.Abs(resultQty ?? 0);
                decimal returnedQty = 0;
                decimal ctr = 0;

                returnedQty = tblReturnedQty.Rows.Count > 0 ? Math.Abs((decimal)tblReturnedQty.Rows[0]["Qty"]) : 0;

                if (!isEnabledStockWithEdControl)
                {
                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (returnedQty == 0)
                            {
                                if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = blc;
                                    movement.QuantityOut = 0;
                                    movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya 
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    blc += (movement.QuantityIn ?? 0);
                                    qty -= (decimal)movement.QuantityIn;
                                    returnedQty = 0;

                                    #region balance
                                    balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    balance.LastUpdateByUserID = userID;
                                    #endregion

                                    // balance detail (fifo) and movement
                                    #region balance detail (fifo)
                                    var balanceDetail = itemBalanceDetails.AddNew();
                                    balanceDetail.LocationID = locationID;
                                    balanceDetail.ItemID = entity.ItemID;
                                    balanceDetail.ReferenceNo = entity.TransactionNo;
                                    balanceDetail.TransactionCode = _chargesCode;
                                    balanceDetail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx);
                                    balanceDetail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                    balanceDetail.Booking = 0;
                                    balanceDetail.Price = (decimal)row["CostPrice"];
                                    balanceDetail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    balanceDetail.LastUpdateByUserID = userID;
                                    #endregion

                                }
                                else
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = blc;
                                    movement.QuantityOut = 0;
                                    movement.QuantityIn = Math.Abs(qty);
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    blc += (movement.QuantityIn ?? 0);
                                    qty = 0;
                                    returnedQty = 0;

                                    #region balance
                                    balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    balance.LastUpdateByUserID = userID;
                                    #endregion

                                    // balance detail (fifo) and movement
                                    #region balance detail (fifo)
                                    var balanceDetail = itemBalanceDetails.AddNew();
                                    balanceDetail.LocationID = locationID;
                                    balanceDetail.ItemID = entity.ItemID;
                                    balanceDetail.ReferenceNo = entity.TransactionNo;
                                    balanceDetail.TransactionCode = _chargesCode;
                                    balanceDetail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                    balanceDetail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                    balanceDetail.Booking = 0;
                                    balanceDetail.Price = (decimal)row["CostPrice"];
                                    balanceDetail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    balanceDetail.LastUpdateByUserID = userID;
                                    #endregion
                                }
                            }
                            else
                            {
                                if (returnedQty < ctr)
                                {
                                    if (qty > (ctr - Math.Abs(returnedQty)))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(ctr - returnedQty);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty -= (decimal)movement.QuantityIn;

                                        #region balance
                                        balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail (fifo) and movement
                                        #region balance detail (fifo)
                                        var balanceDetail = itemBalanceDetails.AddNew();
                                        balanceDetail.LocationID = locationID;
                                        balanceDetail.ItemID = entity.ItemID;
                                        balanceDetail.ReferenceNo = entity.TransactionNo;
                                        balanceDetail.TransactionCode = _chargesCode;
                                        balanceDetail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        balanceDetail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                        balanceDetail.Booking = 0;
                                        balanceDetail.Price = (decimal)row["CostPrice"];
                                        balanceDetail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balanceDetail.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(qty);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty -= (decimal)movement.QuantityIn;

                                        #region balance
                                        balance.Balance -= Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail (fifo) and movement
                                        #region balance detail (fifo)
                                        var balanceDetail = itemBalanceDetails.AddNew();
                                        balanceDetail.LocationID = locationID;
                                        balanceDetail.ItemID = entity.ItemID;
                                        balanceDetail.ReferenceNo = entity.TransactionNo;
                                        balanceDetail.TransactionCode = _chargesCode;
                                        balanceDetail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        balanceDetail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                        balanceDetail.Booking = 0;
                                        balanceDetail.Price = (decimal)row["CostPrice"];
                                        balanceDetail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balanceDetail.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                            }
                        }

                        idx++;
                    }
                }
                else
                {
                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        DateTime expiredDate;
                        string batchNumber;

                        try
                        {
                            expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                            batchNumber = Convert.ToString(row["BatchNumber"]);
                        }
                        catch (Exception)
                        {
                            var ibedq = new ItemBalanceDetailEdQuery();
                            ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == entity.ItemID, ibedq.IsActive == true);
                            ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                            ibedq.es.Top = 1;
                            var ibed = new ItemBalanceDetailEd();
                            if (ibed.Load(ibedq))
                            {
                                expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                batchNumber = ibed.BatchNumber;
                            }
                            else
                            {
                                expiredDate = Convert.ToDateTime("1/1/2999");
                                batchNumber = "-N/A-";
                            }
                        }

                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (returnedQty == 0)
                            {
                                if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = expiredDate;
                                    movement.BatchNumber = batchNumber;
                                    movement.InitialStock = blc;
                                    movement.QuantityOut = 0;
                                    movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya 
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    blc += (movement.QuantityIn ?? 0);
                                    qty -= (decimal)movement.QuantityIn;
                                    returnedQty = 0;

                                    #region balance
                                    balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    balance.LastUpdateByUserID = userID;
                                    #endregion

                                    // balance detail ed (fefo) and movement
                                    #region balance detail ed (fefo)
                                    var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                    if (details == null)
                                    {
                                        details = itemBalanceDetailEds.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = entity.ItemID;
                                        details.ExpiredDate = movement.ExpiredDate;
                                        details.BatchNumber = movement.BatchNumber;
                                        details.Balance = movement.QuantityIn;
                                        details.ST = string.Empty;
                                        details.IsActive = true;
                                        details.CreatedDateTime = Utils.NowAtSqlServer();
                                        details.CreatedByUserID = userID;
                                    }
                                    else
                                    {
                                        if (details.Balance < 0)
                                            details.Balance = movement.QuantityIn;
                                        else
                                            details.Balance += movement.QuantityIn;
                                        details.IsActive = true;
                                    }

                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                }
                                else
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _chargesCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = expiredDate;
                                    movement.BatchNumber = batchNumber;
                                    movement.InitialStock = blc;
                                    movement.QuantityOut = 0;
                                    movement.QuantityIn = Math.Abs(qty);
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    blc += (movement.QuantityIn ?? 0);
                                    qty = 0;
                                    returnedQty = 0;

                                    #region balance
                                    balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    balance.LastUpdateByUserID = userID;
                                    #endregion

                                    // balance detail ed (fefo) and movement
                                    #region balance detail ed (fefo)
                                    var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                    if (details == null)
                                    {
                                        details = itemBalanceDetailEds.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = entity.ItemID;
                                        details.ExpiredDate = movement.ExpiredDate;
                                        details.BatchNumber = movement.BatchNumber;
                                        details.Balance = movement.QuantityIn;
                                        details.ST = string.Empty;
                                        details.IsActive = true;
                                        details.CreatedDateTime = Utils.NowAtSqlServer();
                                        details.CreatedByUserID = userID;
                                    }
                                    else
                                    {
                                        if (details.Balance < 0)
                                            details.Balance = movement.QuantityIn;
                                        else
                                            details.Balance += movement.QuantityIn;
                                        details.IsActive = true;
                                    }

                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion
                                }
                            }
                            else
                            {
                                if (returnedQty < ctr)
                                {
                                    if (qty > (ctr - Math.Abs(returnedQty)))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(ctr - returnedQty);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty -= (decimal)movement.QuantityIn;

                                        #region balance
                                        balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail ed (fefo) and movement
                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(qty);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty -= (decimal)movement.QuantityIn;

                                        #region balance
                                        balance.Balance -= Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail (fifo) and movement
                                        #region balance detail (fifo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                            }
                        }

                        idx++;
                    }
                }
            }
        }

        public static void PrepareItemBalancesForCorrection(TransChargesItemConsumptionCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.DetailItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Descending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items)
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Descending);
                itemBalanceDetailEds.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //    return;

                itemBalanceDetails = null;
            }

            foreach (TransChargesItemConsumption entity in coll)
            {
                decimal? resultQty = entity.QtyRealization;
                decimal lastPrice = 0;
                var item = new Item();
                item.LoadByPrimaryKey(entity.DetailItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = med.CostPrice;
                        entity.FifoPrice = med.CostPrice;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;

                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = nmed.CostPrice;
                        entity.FifoPrice = nmed.CostPrice;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.Kitchen:
                        var ik = new ItemKitchen();
                        ik.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = ik.CostPrice;
                        entity.FifoPrice = ik.CostPrice;
                        lastPrice = ik.LastPriceInBaseUnit ?? 0;

                        if (!ik.IsInventoryItem ?? false)
                            continue;

                        break;
                    default:
                        continue;
                }

                var tc = new TransCharges();
                tc.LoadByPrimaryKey(entity.TransactionNo);

                var query = new ItemMovementQuery();
                query.Where(
                    query.TransactionNo == tc.ReferenceNo,
                    query.SequenceNo == entity.SequenceNo,
                    query.ItemID == entity.DetailItemID
                    );
                query.OrderBy(query.MovementDate.Descending);

                DataTable tbl = query.LoadDataTable();
                if (tbl.Rows.Count > 0)
                {
                    var tp = new TransChargesQuery("a");
                    var tpi = new TransChargesItemQuery("b");
                    var tpic = new TransChargesItemConsumptionQuery("c");

                    tp.Select("<SUM(ISNULL(c.QtyRealization,0)) AS Qty>");
                    tp.InnerJoin(tpi).On(
                        tp.TransactionNo == tpi.TransactionNo &&
                        tp.ReferenceNo == tc.ReferenceNo &&
                        tpi.SequenceNo == entity.SequenceNo &&
                        tp.TransactionNo != tc.TransactionNo
                        );
                    tp.InnerJoin(tpic).On(
                        tp.TransactionNo == tpic.TransactionNo &&
                        tpi.SequenceNo == tpic.SequenceNo &&
                        tpic.DetailItemID == entity.DetailItemID
                        );
                    tp.GroupBy(tpi.ItemID);

                    DataTable tblReturnedQty = tp.LoadDataTable();

                    var balance = itemBalance.FindByPrimaryKey(locationID, entity.DetailItemID);
                    decimal blc = (balance.Balance ?? 0);//- Math.Abs(resultQty ?? 0);
                    decimal qty = Math.Abs(resultQty ?? 0);
                    decimal returnedQty = 0;
                    decimal ctr = 0;

                    returnedQty = tblReturnedQty.Rows.Count > 0 ? Math.Abs((decimal)tblReturnedQty.Rows[0]["Qty"]) : 0;

                    if (!isEnabledStockWithEdControl)
                    {
                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.AveragePrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty = 0;

                                        #region balance
                                        balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail (fifo) and movement
                                        #region detail
                                        var detail = itemBalanceDetails.AddNew();
                                        detail.LocationID = locationID;
                                        detail.ItemID = entity.DetailItemID;
                                        detail.ReferenceNo = entity.TransactionNo;
                                        detail.TransactionCode = _chargesCode;
                                        detail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        detail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                        detail.Booking = 0;
                                        detail.Price = (decimal)row["CostPrice"];
                                        detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        detail.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(qty);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.AveragePrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty = 0;
                                        returnedQty = 0;

                                        #region balance
                                        balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail (fifo) and movement
                                        #region detail
                                        var detail = itemBalanceDetails.AddNew();
                                        detail.LocationID = locationID;
                                        detail.ItemID = entity.DetailItemID;
                                        detail.ReferenceNo = entity.TransactionNo;
                                        detail.TransactionCode = _chargesCode;
                                        detail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        detail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                        detail.Booking = 0;
                                        detail.Price = (decimal)row["CostPrice"];
                                        detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        detail.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.DetailItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(ctr - returnedQty);
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = entity.AveragePrice;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;

                                            #region balance
                                            balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                            balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            balance.LastUpdateByUserID = userID;
                                            #endregion

                                            // balance detail (fifo) and movement
                                            #region detail
                                            var detail = itemBalanceDetails.AddNew();
                                            detail.LocationID = locationID;
                                            detail.ItemID = entity.DetailItemID;
                                            detail.ReferenceNo = entity.TransactionNo;
                                            detail.TransactionCode = _chargesCode;
                                            detail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            detail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                            detail.Booking = 0;
                                            detail.Price = (decimal)row["CostPrice"];
                                            detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            detail.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.DetailItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = entity.AveragePrice;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;

                                            #region balance
                                            balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                            balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            balance.LastUpdateByUserID = userID;
                                            #endregion

                                            // balance detail (fifo) and movement
                                            #region detail
                                            var detail = itemBalanceDetails.AddNew();
                                            detail.LocationID = locationID;
                                            detail.ItemID = entity.DetailItemID;
                                            detail.ReferenceNo = entity.TransactionNo;
                                            detail.TransactionCode = _chargesCode;
                                            detail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            detail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                            detail.Booking = 0;
                                            detail.Price = (decimal)row["CostPrice"];
                                            detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            detail.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }

                            idx++;
                        }
                    }
                    else
                    {
                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            DateTime expiredDate;
                            string batchNumber;

                            try
                            {
                                expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                                batchNumber = Convert.ToString(row["BatchNumber"]);
                            }
                            catch (Exception)
                            {
                                var ibedq = new ItemBalanceDetailEdQuery();
                                ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == entity.DetailItemID, ibedq.IsActive == true);
                                ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                                ibedq.es.Top = 1;
                                var ibed = new ItemBalanceDetailEd();
                                if (ibed.Load(ibedq))
                                {
                                    expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                    batchNumber = ibed.BatchNumber;
                                }
                                else
                                {
                                    expiredDate = Convert.ToDateTime("1/1/2999");
                                    batchNumber = "-N/A-";
                                }
                            }

                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.AveragePrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty = 0;

                                        #region balance
                                        balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail ed (fefo) and movement
                                        #region detail
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.DetailItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.DetailItemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _chargesCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.DetailItemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(qty);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = entity.AveragePrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        blc += (movement.QuantityIn ?? 0);
                                        qty = 0;
                                        returnedQty = 0;

                                        #region balance
                                        balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        balance.LastUpdateByUserID = userID;
                                        #endregion

                                        // balance detail ed (fefo) and movement
                                        #region detail
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.DetailItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.DetailItemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.DetailItemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(ctr - returnedQty);
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = entity.AveragePrice;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;

                                            #region balance
                                            balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                            balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            balance.LastUpdateByUserID = userID;
                                            #endregion

                                            // balance detail ed (fefo) and movement
                                            #region detail
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.DetailItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = entity.DetailItemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _chargesCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.DetailItemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek --> (decimal)row["CostPrice"] harusnya ikut costprice master, bukan ikut cost price pada saat transaksi induknya
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = entity.AveragePrice;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;

                                            #region balance
                                            balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                            balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            balance.LastUpdateByUserID = userID;
                                            #endregion

                                            // balance detail ed (fefo) and movement
                                            #region detail
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.DetailItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = entity.DetailItemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }

                            idx++;
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalances(string prescriptionNo, TransPrescriptionItemCollection coll, string transactionCode, string serviceUnitID,
            string locationID, string userID, bool isApproval, ref ItemBalanceCollection itemBalances,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Where(i => !(i.IsPendingDelivery ?? false) && !(i.IsVoid ?? false) && i.ResultQty > 0).Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct();

            if (!items.Any())
            {
                //itemNoStock = "--[Item]--";
                return;
            }

            //balance
            itemBalances.Query.Where
                (
                    itemBalances.Query.LocationID == locationID,
                    itemBalances.Query.ItemID.In(items)
                );
            itemBalances.LoadAll();

            if (itemBalances.Count == 0)
            {
                itemNoStock = "--[Unmapping item: ItemBalance]--";
                return;
            }

            if (!isEnabledStockWithEdControl)
            {
                // balance detail (fifo) and movement
                itemBalanceDetails.Query.Where
                    (
                        itemBalanceDetails.Query.LocationID == locationID,
                        itemBalanceDetails.Query.ItemID.In(items)
                    );

                //if (isApproval)
                //    itemBalanceDetails.Query.Where(itemBalanceDetails.Query.Balance > 0);

                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "--[Item Balance Detail]--";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed (fefo) and movement
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == locationID,
                        itemBalanceDetailEds.Query.ItemID.In(items),
                        itemBalanceDetailEds.Query.IsActive == true
                    );

                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "--[Unmapping item: ItemBalanceDetailEd]--";
                //    return;
                //}

                itemBalanceDetails = null;
            }

            if (items.Count() != (coll.Where(i => !(i.IsPendingDelivery ?? false) && !(i.IsVoid ?? false) && i.ResultQty > 0).Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct().Count())
            {
                var collTemp = new TransPrescriptionItemCollection();
                var query = new TransPrescriptionItemQuery();
                query.Where(
                    query.PrescriptionNo == prescriptionNo,
                    query.IsVoid == false,
                    query.Or(query.IsPendingDelivery.IsNull(), query.IsPendingDelivery == false));
                query.Select(
                    query.PrescriptionNo,
                    query.ItemID,
                    query.ItemInterventionID,
                    query.ResultQty.Sum().As("ResultQty"),
                    query.CostPrice,
                    query.Price
                    );
                query.GroupBy(
                    query.PrescriptionNo,
                    query.ItemID,
                    query.ItemInterventionID,
                    query.CostPrice,
                    query.Price
                    );
                collTemp.Load(query);

                var collTemp2 = new TransPrescriptionItemCollection();

                foreach (var temp in collTemp)
                {
                    if (temp.ResultQty == 0) continue;

                    var itemID = string.IsNullOrEmpty(temp.ItemInterventionID) ? temp.ItemID : temp.ItemInterventionID;

                    var temp2 = collTemp2.AddNew();
                    temp2.ItemID = itemID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    //Pembulatan qty
                    decimal? resultQty = temp.ResultQty;
                    decimal lastPrice = 0;
                    decimal price = 0;
                    var item = new Item();
                    item.LoadByPrimaryKey(itemID);
                    var srItemUnit = string.Empty;
                    switch (item.SRItemType)
                    {
                        case Reference.ItemType.Medical:
                            var med = new ItemProductMedic();
                            med.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = med.SRItemUnit;
                            lastPrice = med.LastPriceInBaseUnit ?? 0;
                            price = med.PriceInBaseUnit ?? 0;
                            temp2.CostPrice = med.CostPrice;

                            if (!med.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.NonMedical:
                            var nmed = new ItemProductNonMedic();
                            nmed.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = nmed.SRItemUnit;
                            lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                            price = nmed.PriceInBaseUnit ?? 0;
                            temp2.CostPrice = nmed.CostPrice;

                            if (!nmed.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.Kitchen:
                            var kitc = new ItemKitchen();
                            kitc.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = kitc.SRItemUnit;
                            lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                            price = kitc.PriceInBaseUnit ?? 0;
                            temp2.CostPrice = kitc.CostPrice;

                            if (!kitc.IsInventoryItem ?? false) continue;
                            break;
                        default:
                            continue;
                    }

                    if (balance == null)
                    {
                        itemNoStock = item.ItemName + " [Item Balance]";
                        return;
                    }

                    #region balance
                    if (isApproval)
                    {
                        if (balance.Balance < resultQty)
                        {
                            itemNoStock = item.ItemName;

                            return;
                        }
                        balance.Balance -= resultQty;
                    }
                    else
                        balance.Balance += resultQty;

                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    if (isApproval)
                    {
                        if (!isEnabledStockWithEdControl)
                        {
                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == itemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                // query
                                var details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG") temp2.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = srItemUnit;
                                    // TODO: cek --> temp2.CostPrice dapat value dari mana
                                    movement.CostPrice = temp2.CostPrice;// (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG") temp2.CostPrice = details.Price;

                                        if (i == 0) qty = resultQty - details.Balance; // 5 - 2
                                        else qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: Cek costprice dapat value apa dari mana
                                            movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                        .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                            }
                                            catch (Exception)
                                            {
                                                //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                                //return;

                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                        .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = temp.PrescriptionNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = srItemUnit;
                                                    // TODO: Cek costprice dapat value apa dari mana
                                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                                    movement.SalesPrice = temp.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = temp.PrescriptionNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = srItemUnit;
                                                    // TODO: Cek costprice dapat value apa dari mana
                                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                                    movement.SalesPrice = temp.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = itemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = temp2.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: costprice dapat value dari mana?
                                            movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                        .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = srItemUnit;
                                    // TODO: cek --> temp2.CostPrice dapat value dari mana
                                    movement.CostPrice = temp2.CostPrice;// (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = srItemUnit;
                                    // TODO: cek --> temp2.CostPrice dapat value dari mana
                                    movement.CostPrice = temp2.CostPrice;// (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = temp.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = itemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = temp2.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                // query
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = srItemUnit;
                                    movement.CostPrice = temp2.CostPrice;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        if (i == 0) qty = resultQty - details.Balance; // 5 - 2
                                        else qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = srItemUnit;
                                            movement.CostPrice = temp2.CostPrice;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                        .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                            .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = temp.PrescriptionNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = itemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = srItemUnit;
                                                    movement.CostPrice = temp2.CostPrice;
                                                    movement.SalesPrice = temp.Price;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;

                                                }
                                                catch (Exception)
                                                {
                                                    itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";
                                                    return;
                                                }
                                            }

                                        }
                                        else
                                        {
                                            #region balance detail (fefo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = srItemUnit;
                                            movement.CostPrice = temp2.CostPrice;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                            .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = srItemUnit;
                                    movement.CostPrice = temp2.CostPrice;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                }
                                catch (Exception)
                                {
                                    itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";
                                    return;
                                }
                            }
                        }
                    }
                }

            }
            else
            {
                foreach (var entity in coll.Where(c => !(c.IsVoid ?? false) && !(c.IsPendingDelivery ?? false)))
                {
                    if (entity.ResultQty == 0) continue;

                    var itemID = string.IsNullOrEmpty(entity.ItemInterventionID) ? entity.ItemID : entity.ItemInterventionID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    //Pembulatan qty
                    decimal? resultQty = entity.ResultQty;
                    decimal lastPrice = 0;
                    decimal price = 0;
                    var item = new Item();
                    item.LoadByPrimaryKey(itemID);
                    var srItemUnit = string.Empty;
                    switch (item.SRItemType)
                    {
                        case Reference.ItemType.Medical:
                            var med = new ItemProductMedic();
                            med.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = med.SRItemUnit;
                            lastPrice = med.LastPriceInBaseUnit ?? 0;
                            price = med.PriceInBaseUnit ?? 0;
                            entity.CostPrice = med.CostPrice;

                            if (!med.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.NonMedical:
                            var nmed = new ItemProductNonMedic();
                            nmed.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = nmed.SRItemUnit;
                            lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                            price = nmed.PriceInBaseUnit ?? 0;
                            entity.CostPrice = nmed.CostPrice;

                            if (!nmed.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.Kitchen:
                            var kitc = new ItemKitchen();
                            kitc.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = kitc.SRItemUnit;
                            lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                            price = kitc.PriceInBaseUnit ?? 0;
                            entity.CostPrice = kitc.CostPrice;

                            if (!kitc.IsInventoryItem ?? false) continue;
                            break;
                        default:
                            continue;
                    }

                    if (balance == null)
                    {
                        itemNoStock = item.ItemName + " [Item Balance]";
                        return;
                    }

                    #region balance
                    if (isApproval)
                    {
                        if (balance.Balance < resultQty)
                        {
                            itemNoStock = item.ItemName;

                            return;
                        }
                        balance.Balance -= resultQty;
                    }
                    else
                        balance.Balance += resultQty;

                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    if (isApproval)
                    {
                        if (!isEnabledStockWithEdControl)
                        {
                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == itemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                // query
                                var details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG") entity.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG") entity.CostPrice = details.Price;

                                        if (i == 0) qty = resultQty - details.Balance; // 5 - 2
                                        else qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                             .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                            }
                                            catch (Exception)
                                            {
                                                //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                                //return;

                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                             .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = entity.PrescriptionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = entity.PrescriptionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = itemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = entity.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = itemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = entity.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG") entity.CostPrice = details.Price;

                                        if (i == 0) qty = resultQty - details.Balance; // 5 - 2
                                        else qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                             .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                                 .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = entity.PrescriptionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = itemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                                    movement.CostPrice = entity.CostPrice;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                                    return;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fefo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                 .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? srItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                    return;
                                }
                            }

                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForDelivery(string prescriptionNo, TransPrescriptionItemCollection coll, string transactionCode, string serviceUnitID,
            string locationID, string userID, bool isApproval, ref ItemBalanceCollection itemBalances,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl,
            out string itemNoStock, decimal qtyDelivery)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct();

            if (!items.Any())
            {
                itemNoStock = "--[Item]--";
                return;
            }

            //balance
            itemBalances.Query.Where
                (
                    itemBalances.Query.LocationID == locationID,
                    itemBalances.Query.ItemID.In(items)
                );
            itemBalances.LoadAll();

            if (itemBalances.Count == 0)
            {
                itemNoStock = "--[Unmapping item: ItemBalance]--";
                return;
            }

            if (!isEnabledStockWithEdControl)
            {
                // balance detail (fifo) and movement
                itemBalanceDetails.Query.Where
                    (
                        itemBalanceDetails.Query.LocationID == locationID,
                        itemBalanceDetails.Query.ItemID.In(items)
                    );

                //if (isApproval)
                //    itemBalanceDetails.Query.Where(itemBalanceDetails.Query.Balance > 0);

                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "--[Item Balance Detail]--";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed (fefo) and movement
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == locationID,
                        itemBalanceDetailEds.Query.ItemID.In(items), itemBalanceDetailEds.Query.IsActive == true
                    );

                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "--[Unmapping item: ItemBalanceDetailEd]--";
                //    return;
                //}

                itemBalanceDetails = null;
            }

            if (items.Count() != coll.Count)
            {
                var collTemp = new TransPrescriptionItemCollection();
                var query = new TransPrescriptionItemQuery();
                query.Where(query.PrescriptionNo == prescriptionNo);
                query.Select(
                    query.PrescriptionNo,
                    query.ItemID,
                    query.ItemInterventionID,
                    query.DeliveryQty.Sum().As("DeliveryQty"),
                    query.CostPrice,
                    query.Price
                    );
                query.GroupBy(
                    query.PrescriptionNo,
                    query.ItemID,
                    query.ItemInterventionID,
                    query.CostPrice,
                    query.Price
                    );
                collTemp.Load(query);

                var collTemp2 = new TransPrescriptionItemCollection();

                foreach (var temp in collTemp)
                {
                    if (temp.ResultQty == 0)
                        continue;

                    var itemID = string.IsNullOrEmpty(temp.ItemInterventionID) ? temp.ItemID : temp.ItemInterventionID;

                    var temp2 = collTemp2.AddNew();
                    temp2.ItemID = itemID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    //Pembulatan qty
                    var itemMedic = new ItemProductMedic();
                    decimal? resultQty = temp.DeliveryQty;
                    decimal lastPrice = 0;
                    decimal? price = 0;

                    if (itemMedic.LoadByPrimaryKey(itemID))
                    {
                        temp2.CostPrice = itemMedic.CostPrice;
                        lastPrice = itemMedic.LastPriceInBaseUnit ?? 0;
                        price = itemMedic.PriceInBaseUnit ?? 0;
                        if (!itemMedic.IsInventoryItem ?? false)
                            continue;
                    }

                    #region balance
                    if (isApproval)
                    {
                        if (balance.Balance < resultQty)
                        {
                            var item = new Item();
                            item.LoadByPrimaryKey(itemID);
                            itemNoStock = item.ItemName;

                            return;
                        }
                        balance.Balance -= resultQty;
                    }
                    else
                        balance.Balance += resultQty;

                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    if (isApproval)
                    {
                        if (!isEnabledStockWithEdControl)
                        {
                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == itemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    var item = new Item();
                            //    item.LoadByPrimaryKey(itemID);
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                // query
                                var details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();


                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG") temp2.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG") temp2.CostPrice = details.Price;

                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemMedic.SRItemUnit;
                                            movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                        .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                            }
                                            catch (Exception)
                                            {
                                                //var item = new Item();
                                                //item.LoadByPrimaryKey(itemID);
                                                //itemNoStock = item.ItemName + " [Item Balance Detail]";

                                                //return;
                                                ////throw;
                                                ///

                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                        .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = temp.PrescriptionNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                                    movement.SalesPrice = temp.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = temp.PrescriptionNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                                    movement.SalesPrice = temp.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = itemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = temp2.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }

                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemMedic.SRItemUnit;
                                            movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                        .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = temp.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = itemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = temp2.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                // query
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();


                                if (details.Balance >= resultQty)
                                {
                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemMedic.SRItemUnit;
                                            movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                        .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                            .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = temp.PrescriptionNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = itemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                                    movement.CostPrice = temp2.CostPrice;
                                                    movement.SalesPrice = temp.Price;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;

                                                }
                                                catch (Exception)
                                                {
                                                    var item = new Item();
                                                    item.LoadByPrimaryKey(itemID);
                                                    itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";

                                                    return;
                                                }
                                            }

                                        }
                                        else
                                        {
                                            #region balance detail (fefo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemMedic.SRItemUnit;
                                            movement.CostPrice = temp2.CostPrice;
                                            movement.SalesPrice = temp.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                            .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = temp.PrescriptionNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice;
                                    movement.SalesPrice = temp.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                }
                                catch (Exception)
                                {
                                    var item = new Item();
                                    item.LoadByPrimaryKey(itemID);
                                    itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";

                                    return;
                                }
                            }
                        }
                    }
                }
            }
            else
            {
                foreach (var entity in coll)
                {
                    if (qtyDelivery == 0)
                        continue;

                    var itemID = string.IsNullOrEmpty(entity.ItemInterventionID) ? entity.ItemID : entity.ItemInterventionID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    //Pembulatan qty
                    var itemMedic = new ItemProductMedic();
                    decimal? resultQty = qtyDelivery;
                    decimal lastPrice = 0;
                    decimal price = 0;
                    if (itemMedic.LoadByPrimaryKey(itemID))
                    {
                        entity.CostPrice = itemMedic.CostPrice;
                        lastPrice = itemMedic.LastPriceInBaseUnit ?? 0;
                        price = itemMedic.PriceInBaseUnit ?? 0;
                        if (!itemMedic.IsInventoryItem ?? false)
                            continue;
                    }

                    #region balance
                    if (isApproval)
                    {
                        if (balance.Balance < resultQty)
                        {
                            var item = new Item();
                            item.LoadByPrimaryKey(entity.ItemID);
                            itemNoStock = item.ItemName;

                            return;
                        }
                        balance.Balance -= resultQty;
                    }
                    else
                        balance.Balance += resultQty;

                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    if (isApproval)
                    {
                        if (!isEnabledStockWithEdControl)
                        {
                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == itemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    var item = new Item();
                            //    item.LoadByPrimaryKey(itemID);
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                // query
                                var details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG") entity.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG") entity.CostPrice = details.Price;

                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                //var item = new Item();
                                                //item.LoadByPrimaryKey(itemID);
                                                //itemNoStock = item.ItemName + " [Item Balance Detail]";

                                                //return;
                                                ////throw;
                                                ///

                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = entity.PrescriptionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = entity.PrescriptionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = itemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = itemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = entity.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit ?? itemMedic.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = itemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = entity.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                // query
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();


                                if (details.Balance >= resultQty)
                                {
                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemMedic.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                        .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                            .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = transactionCode;
                                                    movement.TransactionNo = entity.PrescriptionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = itemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;

                                                }
                                                catch (Exception)
                                                {
                                                    var item = new Item();
                                                    item.LoadByPrimaryKey(itemID);
                                                    itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";

                                                    return;
                                                }
                                            }

                                        }
                                        else
                                        {
                                            #region balance detail (fefo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemMedic.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                            .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemMedic.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                }
                                catch (Exception)
                                {
                                    var item = new Item();
                                    item.LoadByPrimaryKey(itemID);
                                    itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";

                                    return;
                                }
                            }
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForReturn(TransPrescriptionItemCollection coll, string transactionCode, string serviceUnitID,
            string locationID, string userID, ref ItemBalanceCollection itemBalances,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);

            var items = (coll.Where(b => b.IsVoid == false).Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct();

            if (!items.Any()) return;

            //balance
            itemBalances.Query.Where
                (
                    itemBalances.Query.LocationID == locationID,
                    itemBalances.Query.ItemID.In(items)
                );
            itemBalances.LoadAll();

            if (itemBalances.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail (fifo) and movement
                itemBalanceDetails.Query.Where
                    (
                        itemBalanceDetails.Query.LocationID == locationID,
                        itemBalanceDetails.Query.ItemID.In(items)
                    );

                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0) return;

                itemBalanceDetailEds = null;
            }
            else
            {
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == locationID,
                        itemBalanceDetailEds.Query.ItemID.In(items),
                        itemBalanceDetailEds.Query.IsActive == true
                    );

                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0) return;

                itemBalanceDetails = null;
            }

            foreach (var entity in coll)
            {
                if (entity.IsVoid ?? false) continue;
                if (entity.ResultQty == 0) continue;

                var itemID = string.IsNullOrEmpty(entity.ItemInterventionID) ? entity.ItemID : entity.ItemInterventionID;

                var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                decimal? resultQty = Math.Abs(entity.ResultQty ?? 0);

                #region balance
                balance.Balance -= resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                var header = new TransPrescription();
                header.LoadByPrimaryKey(coll.Select(c => c.PrescriptionNo).Distinct().Single());

                var query = new ItemMovementQuery();
                query.Where(
                    query.TransactionNo == header.ReferenceNo,
                    query.ItemID == itemID
                    );
                query.es.Top = 1;
                query.OrderBy(query.MovementDate.Ascending);
                DataTable dtb = query.LoadDataTable();

                var itemMedic = new ItemProductMedic();
                decimal lastPrice = 0;

                if (itemMedic.LoadByPrimaryKey(itemID))
                {
                    lastPrice = itemMedic.LastPriceInBaseUnit ?? 0;
                    if (!itemMedic.IsInventoryItem ?? false)
                        continue;
                }

                if (!isEnabledStockWithEdControl)
                {
                    try
                    {
                        // query
                        var details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG") entity.CostPrice = details.Price;

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.PrescriptionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = itemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            try
                            {
                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                            }
                            catch (Exception)
                            {
                                movement.LastPriceInBaseUnit = lastPrice;
                            }
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                // mark if using average
                                //if (parCostType != "AVG") entity.CostPrice = details.Price;

                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    try
                                    {
                                        // re-query
                                        details = (itemBalanceDetails.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == itemID)
                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.PrescriptionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = itemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            try
                            {
                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                            }
                            catch (Exception)
                            {
                                movement.LastPriceInBaseUnit = lastPrice;
                            }
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateByUserID = userID;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.PrescriptionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = itemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            try
                            {
                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                            }
                            catch (Exception)
                            {
                                movement.LastPriceInBaseUnit = lastPrice;
                            }
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = itemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else
                {
                    try
                    {
                        // query
                        var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                         .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            #region balance detail (fefo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.PrescriptionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = itemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            try
                            {
                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                            }
                            catch (Exception)
                            {
                                movement.LastPriceInBaseUnit = lastPrice;
                            }
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == itemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;

                                    var initialStock = movement.InitialStock - movement.QuantityOut;
                                    #endregion

                                    #region balance detail ed (fefo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    try
                                    {
                                        // re-query
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID && b.Balance > 0)
                                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                                         .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = entity.Price;
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            return;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail ed (fefo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == itemID)
                                                         .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.PrescriptionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = itemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            try
                            {
                                movement.LastPriceInBaseUnit = (decimal)dtb.Rows[0]["LastPriceInBaseUnit"];
                            }
                            catch (Exception)
                            {
                                movement.LastPriceInBaseUnit = lastPrice;
                            }
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fefo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            return;
                        }
                    }
                }

            }
        }

        public static void PrepareItemBalancesForReturn(string prescriptionNo, TransPrescriptionItemCollection coll, string transactionCode,
            string serviceUnitID, string locationID, string userID, bool isApproval, ref ItemBalanceCollection itemBalances,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Where(b => b.IsVoid == false && !(b.IsPendingDelivery ?? false)).Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalances.Query.Where
                (
                    itemBalances.Query.LocationID == locationID,
                    itemBalances.Query.ItemID.In(items)
                );
            itemBalances.LoadAll();

            if (itemBalances.Count == 0)
                return;

            if (isEnabledStockWithEdControl)
            {
                itemBalanceDetailEds.Query.Where(itemBalanceDetailEds.Query.LocationID == locationID, itemBalanceDetailEds.Query.ItemID.In(items));
                itemBalanceDetailEds.LoadAll();
            }

            var header = new TransPrescription();
            header.LoadByPrimaryKey(coll.Select(c => c.PrescriptionNo).Distinct().Single());

            if (items.Count() != coll.Count)
            {
                var collTemp = new TransPrescriptionItemCollection();
                var queryTemp = new TransPrescriptionItemQuery();
                queryTemp.Where(queryTemp.PrescriptionNo == prescriptionNo, queryTemp.IsVoid == false);
                queryTemp.Select(
                    queryTemp.PrescriptionNo,
                    queryTemp.ItemID,
                    queryTemp.ItemInterventionID,
                    queryTemp.ResultQty.Sum().As("ResultQty"),
                    queryTemp.CostPrice,
                    queryTemp.Price,
                    queryTemp.IsPendingDelivery,
                    queryTemp.DeliveryQty.Sum().As("DeliveryQty")
                    );
                queryTemp.GroupBy(
                    queryTemp.PrescriptionNo,
                    queryTemp.ItemID,
                    queryTemp.ItemInterventionID,
                    queryTemp.CostPrice,
                    queryTemp.Price,
                    queryTemp.IsPendingDelivery
                    );
                collTemp.Load(queryTemp);

                foreach (var temp in collTemp)
                {
                    decimal resultQty = (temp.IsPendingDelivery ?? false) ? (temp.DeliveryQty ?? 0) : (temp.ResultQty ?? 0);

                    if (resultQty == 0)//temp.ResultQty == 0)
                        continue;

                    var itemID = string.IsNullOrEmpty(temp.ItemInterventionID) ? temp.ItemID : temp.ItemInterventionID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    decimal lastPrice = 0; decimal costPrice = 0;
                    var item = new Item();
                    item.LoadByPrimaryKey(itemID);
                    var srItemUnit = string.Empty;
                    switch (item.SRItemType)
                    {
                        case Reference.ItemType.Medical:
                            var med = new ItemProductMedic();
                            med.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = med.SRItemUnit;
                            lastPrice = med.LastPriceInBaseUnit ?? 0;
                            costPrice = med.CostPrice.Value;

                            if (!med.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.NonMedical:
                            var nmed = new ItemProductNonMedic();
                            nmed.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = nmed.SRItemUnit;
                            lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                            costPrice = nmed.CostPrice.Value;

                            if (!nmed.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.Kitchen:
                            var kitc = new ItemKitchen();
                            kitc.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = kitc.SRItemUnit;
                            lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                            costPrice = kitc.CostPrice.Value;

                            if (!kitc.IsInventoryItem ?? false) continue;
                            break;
                        default:
                            continue;
                    }

                    #region balance
                    balance.Balance += Math.Abs(resultQty);
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    var query = new ItemMovementQuery();
                    query.Where(
                        query.TransactionNo == header.ReferenceNo,
                        query.ItemID == itemID
                        );
                    query.OrderBy(query.MovementDate.Descending);

                    DataTable tbl = query.LoadDataTable();

                    var tp = new TransPrescriptionQuery("a");
                    var tpi = new TransPrescriptionItemQuery("b");

                    tp.Select("<SUM(ISNULL(b.ResultQty,0)) AS Qty>");
                    tp.InnerJoin(tpi).On(
                        tp.PrescriptionNo == tpi.PrescriptionNo &&
                        tp.ReferenceNo == header.ReferenceNo &&
                        tpi.ItemID == itemID &&
                        tp.PrescriptionNo != header.PrescriptionNo
                        );
                    tp.Where(tp.IsApproval == true);
                    tp.GroupBy(tpi.ItemID);

                    DataTable tblReturnedQty = tp.LoadDataTable();

                    decimal blc = (balance.Balance ?? 0) - Math.Abs(resultQty);
                    decimal qty = Math.Abs(resultQty);
                    decimal returnedQty = 0;
                    decimal ctr = 0;

                    returnedQty = tblReturnedQty.Rows.Count > 0 ? Math.Abs((decimal)tblReturnedQty.Rows[0]["Qty"]) : 0;

                    if (!isEnabledStockWithEdControl)
                    {
                        itemBalanceDetailEds = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: Costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"]; 
                                        movement.CostPrice = costPrice; ;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = temp.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }

                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = temp.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx);
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }
                                            //else
                                            //{
                                            //    movement.InitialStock = blc + Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityOut = Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityIn = 0;
                                            //    blc = movement.InitialStock ?? 0;
                                            //}

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }
                                            //else
                                            //{
                                            //    movement.InitialStock = blc + Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityOut = Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityIn = 0;
                                            //    blc = movement.InitialStock ?? 0;
                                            //}

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                    else
                    {
                        itemBalanceDetails = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            DateTime expiredDate;
                            string batchNumber;

                            try
                            {
                                expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                                batchNumber = Convert.ToString(row["BatchNumber"]);
                            }
                            catch (Exception)
                            {
                                var ibedq = new ItemBalanceDetailEdQuery();
                                ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == itemID, ibedq.IsActive == true);
                                ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                                ibedq.es.Top = 1;
                                var ibed = new ItemBalanceDetailEd();
                                if (ibed.Load(ibedq))
                                {
                                    expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                    batchNumber = ibed.BatchNumber;
                                }
                                else
                                {
                                    expiredDate = Convert.ToDateTime("1/1/2999");
                                    batchNumber = "-N/A-";
                                }
                            }

                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: Costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"]; 
                                        movement.CostPrice = costPrice; ;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }

                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                }
            }
            else
            {
                foreach (var entity in coll)
                {
                    if (entity.IsVoid ?? false)
                        continue;

                    decimal resultQty = (entity.IsPendingDelivery ?? false) ? (entity.DeliveryQty ?? 0) : (entity.ResultQty ?? 0);
                    if (resultQty == 0) //entity.ResultQty == 0)
                        continue;

                    var itemID = string.IsNullOrEmpty(entity.ItemInterventionID) ? entity.ItemID : entity.ItemInterventionID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    decimal lastPrice = 0; decimal costPrice = 0;
                    var item = new Item();
                    item.LoadByPrimaryKey(itemID);
                    var srItemUnit = string.Empty;
                    switch (item.SRItemType)
                    {
                        case Reference.ItemType.Medical:
                            var med = new ItemProductMedic();
                            med.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = med.SRItemUnit;
                            lastPrice = med.LastPriceInBaseUnit ?? 0;
                            costPrice = med.CostPrice.Value;

                            if (!med.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.NonMedical:
                            var nmed = new ItemProductNonMedic();
                            nmed.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = nmed.SRItemUnit;
                            lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                            costPrice = nmed.CostPrice.Value;

                            if (!nmed.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.Kitchen:
                            var kitc = new ItemKitchen();
                            kitc.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = kitc.SRItemUnit;
                            lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                            costPrice = kitc.CostPrice.Value;

                            if (!kitc.IsInventoryItem ?? false) continue;
                            break;
                        default:
                            continue;
                    }

                    #region balance
                    balance.Balance += Math.Abs(resultQty);
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    var query = new ItemMovementQuery();
                    query.Where(query.TransactionNo == header.ReferenceNo, query.ItemID == itemID);
                    query.OrderBy(query.MovementDate.Descending);

                    DataTable tbl = query.LoadDataTable();

                    var tp = new TransPrescriptionQuery("a");
                    var tpi = new TransPrescriptionItemQuery("b");

                    tp.Select("<SUM(ISNULL(b.ResultQty,0)) AS Qty>");
                    tp.InnerJoin(tpi).On(
                        tp.PrescriptionNo == tpi.PrescriptionNo &&
                        tp.ReferenceNo == header.ReferenceNo &&
                        tpi.ItemID == itemID &&
                        tp.PrescriptionNo != header.PrescriptionNo
                        );
                    tp.Where(tp.IsApproval == true);
                    tp.GroupBy(tpi.ItemID);

                    DataTable tblReturnedQty = tp.LoadDataTable();

                    decimal blc = (balance.Balance ?? 0) - Math.Abs(resultQty);
                    decimal qty = Math.Abs(resultQty);
                    decimal returnedQty = 0;
                    decimal ctr = 0;

                    returnedQty = tblReturnedQty.Rows.Count > 0 ? Math.Abs((decimal)tblReturnedQty.Rows[0]["Qty"]) : 0;

                    if (!isEnabledStockWithEdControl)
                    {
                        itemBalanceDetailEds = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];

                                        movement.CostPrice = costPrice;

                                        //movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek costprice ambil data dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];

                                        movement.CostPrice = costPrice;
                                        //movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;
                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;

                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;
                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;

                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                    else
                    {
                        itemBalanceDetails = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            DateTime expiredDate;
                            string batchNumber;

                            try
                            {
                                expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                                batchNumber = Convert.ToString(row["BatchNumber"]);
                            }
                            catch (Exception)
                            {
                                var ibedq = new ItemBalanceDetailEdQuery();
                                ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == itemID, ibedq.IsActive == true);
                                ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                                ibedq.es.Top = 1;
                                var ibed = new ItemBalanceDetailEd();
                                if (ibed.Load(ibedq))
                                {
                                    expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                    batchNumber = ibed.BatchNumber;
                                }
                                else
                                {
                                    expiredDate = Convert.ToDateTime("1/1/2999");
                                    batchNumber = "-N/A-";
                                }
                            }

                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];

                                        movement.CostPrice = costPrice;

                                        //movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek costprice ambil data dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];

                                        movement.CostPrice = costPrice;
                                        //movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;
                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;

                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;
                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];

                                            movement.CostPrice = costPrice;

                                            //movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForReturn2(string prescriptionNo, TransPrescriptionItemCollection coll, string transactionCode,
            string serviceUnitID, string locationID, string userID, bool isApproval, ref ItemBalanceCollection itemBalances,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Where(b => b.IsVoid == false).Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalances.Query.Where
                (
                    itemBalances.Query.LocationID == locationID,
                    itemBalances.Query.ItemID.In(items)
                );
            itemBalances.LoadAll();

            if (itemBalances.Count == 0)
                return;

            if (isEnabledStockWithEdControl)
            {
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == locationID,
                        itemBalanceDetailEds.Query.ItemID.In(items)
                    );
                itemBalanceDetailEds.LoadAll();
            }

            var header = new TransPrescription();
            header.LoadByPrimaryKey(coll.Select(c => c.PrescriptionNo).Distinct().Single());

            if (items.Count() != coll.Count)
            {
                var collTemp = new TransPrescriptionItemCollection();
                var queryTemp = new TransPrescriptionItemQuery();
                queryTemp.Where(queryTemp.PrescriptionNo == prescriptionNo, queryTemp.IsVoid == false);
                queryTemp.Select(
                    queryTemp.PrescriptionNo,
                    queryTemp.ItemID,
                    queryTemp.ItemInterventionID,
                    queryTemp.ResultQty.Sum().As("ResultQty"),
                    queryTemp.CostPrice,
                    queryTemp.Price,
                    queryTemp.IsPendingDelivery,
                    queryTemp.DeliveryQty.Sum().As("DeliveryQty")
                    );
                queryTemp.GroupBy(
                    queryTemp.PrescriptionNo,
                    queryTemp.ItemID,
                    queryTemp.ItemInterventionID,
                    queryTemp.CostPrice,
                    queryTemp.Price,
                    queryTemp.IsPendingDelivery
                    );
                collTemp.Load(queryTemp);

                foreach (var temp in collTemp)
                {
                    decimal resultQty = (temp.IsPendingDelivery ?? false) ? (temp.DeliveryQty ?? 0) : (temp.ResultQty ?? 0);

                    if (resultQty == 0)//temp.ResultQty == 0)
                        continue;

                    var itemID = string.IsNullOrEmpty(temp.ItemInterventionID) ? temp.ItemID : temp.ItemInterventionID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    decimal lastPrice = 0; decimal costPrice = 0;
                    var item = new Item();
                    item.LoadByPrimaryKey(itemID);
                    var srItemUnit = string.Empty;
                    switch (item.SRItemType)
                    {
                        case Reference.ItemType.Medical:
                            var med = new ItemProductMedic();
                            med.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = med.SRItemUnit;
                            lastPrice = med.LastPriceInBaseUnit ?? 0;
                            costPrice = med.CostPrice.Value;

                            if (!med.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.NonMedical:
                            var nmed = new ItemProductNonMedic();
                            nmed.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = nmed.SRItemUnit;
                            lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                            costPrice = nmed.CostPrice.Value;

                            if (!nmed.IsInventoryItem ?? false) continue;
                            break;
                        case Reference.ItemType.Kitchen:
                            var kitc = new ItemKitchen();
                            kitc.LoadByPrimaryKey(item.ItemID);
                            srItemUnit = kitc.SRItemUnit;
                            lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                            costPrice = kitc.CostPrice.Value;

                            if (!kitc.IsInventoryItem ?? false) continue;
                            break;
                        default:
                            continue;
                    }

                    #region balance
                    balance.Balance += Math.Abs(resultQty);
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    var query = new ItemMovementQuery();
                    query.Where(
                        query.TransactionNo == header.PrescriptionNo,
                        query.ItemID == itemID
                        );
                    query.OrderBy(query.MovementDate.Descending);

                    DataTable tbl = query.LoadDataTable();

                    decimal blc = (balance.Balance ?? 0) - Math.Abs(resultQty);
                    decimal qty = Math.Abs(resultQty);
                    decimal returnedQty = 0;
                    decimal ctr = 0;

                    if (!isEnabledStockWithEdControl)
                    {
                        itemBalanceDetailEds = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: Costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice; ;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = temp.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }

                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = temp.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx);
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }
                                            //else
                                            //{
                                            //    movement.InitialStock = blc + Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityOut = Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityIn = 0;
                                            //    blc = movement.InitialStock ?? 0;
                                            //}

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }
                                            //else
                                            //{
                                            //    movement.InitialStock = blc + Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityOut = Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityIn = 0;
                                            //    blc = movement.InitialStock ?? 0;
                                            //}

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = temp.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                    else
                    {
                        itemBalanceDetails = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            DateTime expiredDate;
                            string batchNumber;

                            try
                            {
                                expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                                batchNumber = Convert.ToString(row["BatchNumber"]);
                            }
                            catch (Exception)
                            {
                                var ibedq = new ItemBalanceDetailEdQuery();
                                ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == itemID, ibedq.IsActive == true);
                                ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                                ibedq.es.Top = 1;
                                var ibed = new ItemBalanceDetailEd();
                                if (ibed.Load(ibedq))
                                {
                                    expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                    batchNumber = ibed.BatchNumber;
                                }
                                else
                                {
                                    expiredDate = Convert.ToDateTime("1/1/2999");
                                    batchNumber = "-N/A-";
                                }
                            }

                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: Costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice; ;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = temp.PrescriptionNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = srItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }

                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }
                                            //else
                                            //{
                                            //    movement.InitialStock = blc + Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityOut = Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityIn = 0;
                                            //    blc = movement.InitialStock ?? 0;
                                            //}

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = temp.PrescriptionNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }
                                            //else
                                            //{
                                            //    movement.InitialStock = blc + Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityOut = Math.Abs((decimal)row["QuantityOut"]);
                                            //    movement.QuantityIn = 0;
                                            //    blc = movement.InitialStock ?? 0;
                                            //}

                                            movement.SRItemUnit = srItemUnit;
                                            // TODO: cek costprice ambil data dari mana
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = costPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                }
            }
            else
            {
                foreach (var entity in coll)
                {
                    if (entity.IsVoid ?? false)
                        continue;

                    decimal resultQty = (entity.IsPendingDelivery ?? false) ? (entity.DeliveryQty ?? 0) : (entity.ResultQty ?? 0);
                    if (resultQty == 0) //entity.ResultQty == 0)
                        continue;

                    var itemID = string.IsNullOrEmpty(entity.ItemInterventionID) ? entity.ItemID : entity.ItemInterventionID;

                    var balance = itemBalances.FindByPrimaryKey(locationID, itemID);

                    var itemMedic = new ItemProductMedic();
                    decimal lastPrice = 0;

                    if (itemMedic.LoadByPrimaryKey(itemID))
                    {
                        lastPrice = itemMedic.LastPriceInBaseUnit ?? 0;
                        if (!itemMedic.IsInventoryItem ?? false)
                            continue;
                    }

                    #region balance
                    balance.Balance += Math.Abs(resultQty);
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    var query = new ItemMovementQuery();
                    query.Where(query.TransactionNo == header.PrescriptionNo, query.ItemID == itemID);
                    query.OrderBy(query.MovementDate.Descending);

                    DataTable tbl = query.LoadDataTable();

                    decimal blc = (balance.Balance ?? 0) - Math.Abs(resultQty);
                    decimal qty = Math.Abs(resultQty);
                    decimal returnedQty = 0;
                    decimal ctr = 0;

                    //returnedQty = tblReturnedQty.Rows.Count > 0 ? Math.Abs((decimal)tblReturnedQty.Rows[0]["Qty"]) : 0;

                    if (!isEnabledStockWithEdControl)
                    {
                        itemBalanceDetailEds = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek costprice ambil data dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.str.ExpiredDate = string.Empty;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            var details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ReferenceNo = entity.PrescriptionNo;
                                            details.TransactionCode = transactionCode;
                                            details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                            details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                            details.Booking = 0;
                                            details.Price = (decimal)row["CostPrice"];
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                    else
                    {
                        itemBalanceDetails = null;

                        int idx = 0;

                        foreach (DataRow row in tbl.Rows)
                        {
                            DateTime expiredDate;
                            string batchNumber;

                            try
                            {
                                expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                                batchNumber = Convert.ToString(row["BatchNumber"]);
                            }
                            catch (Exception)
                            {
                                var ibedq = new ItemBalanceDetailEdQuery();
                                ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == itemID, ibedq.IsActive == true);
                                ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                                ibedq.es.Top = 1;
                                var ibed = new ItemBalanceDetailEd();
                                if (ibed.Load(ibedq))
                                {
                                    expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                    batchNumber = ibed.BatchNumber;
                                }
                                else
                                {
                                    expiredDate = Convert.ToDateTime("1/1/2999");
                                    batchNumber = "-N/A-";
                                }
                            }

                            ctr += Math.Abs((decimal)row["QuantityOut"]);

                            if (qty > 0)
                            {
                                if (returnedQty == 0)
                                {
                                    if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty = 0;
                                            returnedQty = 0;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek costprice ambil data dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = itemMedic.CostPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    if (returnedQty < ctr)
                                    {
                                        if (qty > (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                    if (returnedQty > ctr)
                                    {
                                        if (qty < (ctr - Math.Abs(returnedQty)))
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = ctr - returnedQty;
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                        else
                                        {
                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.PrescriptionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = itemID;
                                            movement.ExpiredDate = expiredDate;
                                            movement.BatchNumber = batchNumber;

                                            if (isApproval)
                                            {
                                                movement.InitialStock = blc;
                                                movement.QuantityOut = 0;
                                                movement.QuantityIn = Math.Abs(qty);
                                                blc += (movement.QuantityIn ?? 0);
                                                qty -= (decimal)movement.QuantityIn;
                                                returnedQty -= (decimal)movement.QuantityIn;
                                            }

                                            movement.SRItemUnit = entity.SRItemUnit;
                                            // TODO: cek data costprice ambil dari mana?
                                            //movement.CostPrice = (decimal)row["CostPrice"];
                                            movement.CostPrice = itemMedic.CostPrice;
                                            movement.SalesPrice = (decimal)row["SalesPrice"];
                                            movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                            try
                                            {
                                                movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                            }
                                            catch (Exception)
                                            {
                                                movement.LastPriceInBaseUnit = lastPrice;
                                            }
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                    .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                            if (details == null)
                                            {
                                                details = itemBalanceDetailEds.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = itemID;
                                                details.ExpiredDate = movement.ExpiredDate;
                                                details.BatchNumber = movement.BatchNumber;
                                                details.Balance = movement.QuantityIn;
                                                details.ST = string.Empty;
                                                details.IsActive = true;
                                                details.CreatedDateTime = Utils.NowAtSqlServer();
                                                details.CreatedByUserID = userID;
                                            }
                                            else
                                            {
                                                if (details.Balance < 0)
                                                    details.Balance = movement.QuantityIn;
                                                else
                                                    details.Balance += movement.QuantityIn;
                                                details.IsActive = true;
                                            }

                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion
                                        }
                                    }
                                }
                            }
                            idx++;
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForReturn(TransPrescription header, IEnumerable<TransPrescriptionItem> coll, string transactionCode,
            string serviceUnitID, string locationID, string userID, bool isApproval, ref ItemBalanceCollection itemBalances,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => (i.ItemInterventionID == string.Empty ? i.ItemID : i.ItemInterventionID))).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalances.Query.Where
                (
                    itemBalances.Query.LocationID == locationID,
                    itemBalances.Query.ItemID.In(items)
                );
            itemBalances.LoadAll();

            //if (itemBalances.Count == 0)
            //    return;

            if (isEnabledStockWithEdControl)
            {
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == locationID,
                        itemBalanceDetailEds.Query.ItemID.In(items)
                    );
                itemBalanceDetailEds.LoadAll();
            }

            foreach (var entity in coll)
            {
                decimal resultQty = (entity.IsPendingDelivery ?? false) ? (entity.DeliveryQty ?? 0) : (entity.ResultQty ?? 0);

                if (resultQty == 0)
                    continue;

                var itemID = string.IsNullOrEmpty(entity.ItemInterventionID) ? entity.ItemID : entity.ItemInterventionID;

                //TODO: Item bisa tidak ditemukan krn locationid bisa dipilih berbeda dg tempat transaksinya dan mengakibatkan error dibaris berikutnya
                var balance = itemBalances.FindByPrimaryKey(locationID, itemID);
                if (balance == null)
                {
                    balance = itemBalances.AddNew();
                    balance.LocationID = locationID;
                    balance.ItemID = itemID;
                    balance.ReorderType = string.Empty;
                    balance.Minimum = 0;
                    balance.Maximum = 0;
                    balance.Balance = 0;
                    balance.Booking = 0;
                    balance.SRItemBin = string.Empty;
                }

                decimal lastPrice = 0, costPrice = 0;
                var itm = new Item();
                itm.LoadByPrimaryKey(itemID);

                if (itm.SRItemType == "11")
                {
                    var itemMedicx = new ItemProductMedic();
                    if (itemMedicx.LoadByPrimaryKey(itemID))
                    {
                        lastPrice = itemMedicx.LastPriceInBaseUnit ?? 0;
                        costPrice = itemMedicx.CostPrice ?? 0;
                        if (!itemMedicx.IsInventoryItem ?? false)
                            continue;
                    }
                }
                else if (itm.SRItemType == "21")
                {
                    var itemMedicx = new ItemProductNonMedic();
                    if (itemMedicx.LoadByPrimaryKey(itemID))
                    {
                        lastPrice = itemMedicx.LastPriceInBaseUnit ?? 0;
                        costPrice = itemMedicx.CostPrice ?? 0;
                        if (!itemMedicx.IsInventoryItem ?? false)
                            continue;
                    }
                }


                #region balance
                balance.Balance += Math.Abs(resultQty);
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                var query = new ItemMovementQuery("im");
                query.Where(query.TransactionNo == header.ReferenceNo, query.ItemID == itemID);
                query.OrderBy(query.MovementDate.Descending);

                DataTable tbl = query.LoadDataTable();

                var tp = new TransPrescriptionQuery("a");
                var tpi = new TransPrescriptionItemQuery("b");

                tp.Select("<SUM(ISNULL(b.ResultQty,0)) AS Qty>");
                tp.InnerJoin(tpi).On(
                    tp.PrescriptionNo == tpi.PrescriptionNo &&
                    tp.ReferenceNo == header.ReferenceNo &&
                    tpi.ItemID == entity.ItemID &&
                    tp.PrescriptionNo != header.PrescriptionNo
                    );
                tp.Where(tp.IsApproval == true);
                tp.GroupBy(tpi.ItemID);

                DataTable tblReturnedQty = tp.LoadDataTable();

                decimal blc = (balance.Balance ?? 0) - Math.Abs(resultQty);
                decimal qty = Math.Abs(resultQty);
                decimal returnedQty = 0;
                decimal ctr = 0;

                returnedQty = tblReturnedQty.Rows.Count > 0 ? Math.Abs((decimal)tblReturnedQty.Rows[0]["Qty"]) : 0;

                if (!isEnabledStockWithEdControl)
                {
                    itemBalanceDetailEds = null;

                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (returnedQty == 0)
                            {
                                if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;

                                    if (isApproval)
                                    {
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty = 0;
                                    }

                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek data costprice ambil dari mana?
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = costPrice;
                                    movement.SalesPrice = (decimal)row["SalesPrice"];
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = itemID;
                                    details.ReferenceNo = entity.PrescriptionNo;
                                    details.TransactionCode = transactionCode;
                                    details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                    details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                    details.Booking = 0;
                                    details.Price = (decimal)row["CostPrice"];
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                }
                                else
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.str.ExpiredDate = string.Empty;

                                    if (isApproval)
                                    {
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(qty);
                                        blc += (movement.QuantityIn ?? 0);
                                        qty = 0;
                                        returnedQty = 0;
                                    }

                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek data costprice ambil dari mana?
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = costPrice;
                                    movement.SalesPrice = (decimal)row["SalesPrice"];
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = itemID;
                                    details.ReferenceNo = entity.PrescriptionNo;
                                    details.TransactionCode = transactionCode;
                                    details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                    details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                    details.Booking = 0;
                                    details.Price = (decimal)row["CostPrice"];
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion
                                }
                            }
                            else
                            {
                                if (returnedQty < ctr)
                                {
                                    if (qty > (ctr - Math.Abs(returnedQty)))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = ctr - returnedQty;
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                if (returnedQty > ctr)
                                {
                                    if (qty < (ctr - Math.Abs(returnedQty)))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = ctr - returnedQty;
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.str.ExpiredDate = string.Empty;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail (fifo)
                                        var details = itemBalanceDetails.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ReferenceNo = entity.PrescriptionNo;
                                        details.TransactionCode = transactionCode;
                                        details.Balance = (movement.QuantityIn != 0) ? movement.QuantityIn : movement.QuantityOut;
                                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                        details.Booking = 0;
                                        details.Price = (decimal)row["CostPrice"];
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                            }
                        }
                        idx++;
                    }
                }
                else
                {
                    itemBalanceDetails = null;

                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        DateTime expiredDate;
                        string batchNumber;

                        try
                        {
                            expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                            batchNumber = Convert.ToString(row["BatchNumber"]);
                        }
                        catch (Exception)
                        {
                            var ibedq = new ItemBalanceDetailEdQuery();
                            ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == itemID, ibedq.IsActive == true);
                            ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                            ibedq.es.Top = 1;
                            var ibed = new ItemBalanceDetailEd();
                            if (ibed.Load(ibedq))
                            {
                                expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                batchNumber = ibed.BatchNumber;
                            }
                            else
                            {
                                expiredDate = Convert.ToDateTime("1/1/2999");
                                batchNumber = "-N/A-";
                            }
                        }

                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (returnedQty == 0)
                            {
                                if (qty > Math.Abs((decimal)row["QuantityOut"]))
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = expiredDate;
                                    movement.BatchNumber = batchNumber;

                                    if (isApproval)
                                    {
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                        blc += (movement.QuantityIn ?? 0);
                                        qty -= (decimal)movement.QuantityIn;
                                        returnedQty = 0;
                                    }

                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek data costprice ambil dari mana?
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = costPrice;
                                    movement.SalesPrice = (decimal)row["SalesPrice"];
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail ed (fefo)
                                    var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                            .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                    if (details == null)
                                    {
                                        details = itemBalanceDetailEds.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ExpiredDate = movement.ExpiredDate;
                                        details.BatchNumber = movement.BatchNumber;
                                        details.Balance = movement.QuantityIn;
                                        details.ST = string.Empty;
                                        details.IsActive = true;
                                        details.CreatedDateTime = Utils.NowAtSqlServer();
                                        details.CreatedByUserID = userID;
                                    }
                                    else
                                    {
                                        if (details.Balance < 0)
                                            details.Balance = movement.QuantityIn;
                                        else
                                            details.Balance += movement.QuantityIn;
                                        details.IsActive = true;
                                    }

                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                }
                                else
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.PrescriptionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = itemID;
                                    movement.ExpiredDate = expiredDate;
                                    movement.BatchNumber = batchNumber;

                                    if (isApproval)
                                    {
                                        movement.InitialStock = blc;
                                        movement.QuantityOut = 0;
                                        movement.QuantityIn = Math.Abs(qty);
                                        blc += (movement.QuantityIn ?? 0);
                                        qty = 0;
                                        returnedQty = 0;
                                    }

                                    movement.SRItemUnit = entity.SRItemUnit;
                                    // TODO: cek data costprice ambil dari mana?
                                    //movement.CostPrice = (decimal)row["CostPrice"];
                                    movement.CostPrice = costPrice;
                                    movement.SalesPrice = (decimal)row["SalesPrice"];
                                    movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                    try
                                    {
                                        movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                    }
                                    catch (Exception)
                                    {
                                        movement.LastPriceInBaseUnit = lastPrice;
                                    }
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail ed (fefo)
                                    var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                            .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                    if (details == null)
                                    {
                                        details = itemBalanceDetailEds.AddNew();
                                        details.LocationID = locationID;
                                        details.ItemID = itemID;
                                        details.ExpiredDate = movement.ExpiredDate;
                                        details.BatchNumber = movement.BatchNumber;
                                        details.Balance = movement.QuantityIn;
                                        details.ST = string.Empty;
                                        details.IsActive = true;
                                        details.CreatedDateTime = Utils.NowAtSqlServer();
                                        details.CreatedByUserID = userID;
                                    }
                                    else
                                    {
                                        if (details.Balance < 0)
                                            details.Balance = movement.QuantityIn;
                                        else
                                            details.Balance += movement.QuantityIn;
                                        details.IsActive = true;
                                    }

                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion
                                }
                            }
                            else
                            {
                                if (returnedQty < ctr)
                                {
                                    if (qty > (ctr - Math.Abs(returnedQty)))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = ctr - returnedQty;
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                                if (returnedQty > ctr)
                                {
                                    if (qty < (ctr - Math.Abs(returnedQty)))
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = ctr - returnedQty;
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = transactionCode;
                                        movement.TransactionNo = entity.PrescriptionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = itemID;
                                        movement.ExpiredDate = expiredDate;
                                        movement.BatchNumber = batchNumber;

                                        if (isApproval)
                                        {
                                            movement.InitialStock = blc;
                                            movement.QuantityOut = 0;
                                            movement.QuantityIn = Math.Abs(qty);
                                            blc += (movement.QuantityIn ?? 0);
                                            qty -= (decimal)movement.QuantityIn;
                                            returnedQty -= (decimal)movement.QuantityIn;
                                        }

                                        movement.SRItemUnit = entity.SRItemUnit;
                                        // TODO: cek data costprice ambil dari mana?
                                        //movement.CostPrice = (decimal)row["CostPrice"];
                                        movement.CostPrice = costPrice;
                                        movement.SalesPrice = (decimal)row["SalesPrice"];
                                        movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                        try
                                        {
                                            movement.LastPriceInBaseUnit = (decimal)row["LastPriceInBaseUnit"];
                                        }
                                        catch (Exception)
                                        {
                                            movement.LastPriceInBaseUnit = lastPrice;
                                        }
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        #region balance detail ed (fefo)
                                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == itemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                        if (details == null)
                                        {
                                            details = itemBalanceDetailEds.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = itemID;
                                            details.ExpiredDate = movement.ExpiredDate;
                                            details.BatchNumber = movement.BatchNumber;
                                            details.Balance = movement.QuantityIn;
                                            details.ST = string.Empty;
                                            details.IsActive = true;
                                            details.CreatedDateTime = Utils.NowAtSqlServer();
                                            details.CreatedByUserID = userID;
                                        }
                                        else
                                        {
                                            if (details.Balance < 0)
                                                details.Balance = movement.QuantityIn;
                                            else
                                                details.Balance += movement.QuantityIn;
                                            details.IsActive = true;
                                        }

                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion
                                    }
                                }
                            }
                        }
                        idx++;
                    }
                }
            }
        }

        public static void UpdateCostPrice(TransPrescriptionItemCollection coll, out string itemZeroCostPrice)
        {
            itemZeroCostPrice = string.Empty;
            foreach (var entity in coll)
            {
                string itemId = string.IsNullOrEmpty(entity.ItemInterventionID)
                                    ? entity.ItemID
                                    : entity.ItemInterventionID;

                var item = new Item();
                item.LoadByPrimaryKey(itemId);
                decimal price = 0;
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;
                        price = med.PriceInBaseUnit ?? 0;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;
                        price = nmed.PriceInBaseUnit ?? 0;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;
                        price = kitc.PriceInBaseUnit ?? 0;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        break;
                    default:
                        continue;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0)
                {
                    itemZeroCostPrice = item.ItemName;
                    return;
                }
            }
        }

        public static void UpdateCostPrice(IEnumerable<TransPrescriptionItem> coll, out string itemZeroCostPrice)
        {
            itemZeroCostPrice = string.Empty;
            foreach (var entity in coll)
            {
                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        break;
                    default:
                        continue;
                }

                if ((entity.CostPrice ?? 0) == 0)
                {
                    itemZeroCostPrice = item.ItemName;
                    return;
                }
            }
        }

        public static void PrepareItemBalances(ItemTransaction it, ItemTransactionItemCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, out string itemNoStock, bool isEnabledStockWithEdControl)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                //,
                //itemBalanceDetails.Query.Balance > 0
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items),
                    itemBalanceDetailEds.Query.IsActive == true
                //,
                //itemBalanceDetailEds.Query.Balance > 0
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Ascending);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //    return;

                itemBalanceDetails = null;
            }


            foreach (ItemTransactionItem entity in coll)
            {
                decimal? resultQty = entity.Quantity * entity.ConversionFactor;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                decimal price = 0;
                decimal lastPrice = 0;
                decimal discPctg = 0;
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        discPctg = med.PurchaseDiscount1 ?? 0;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        discPctg = nmed.PurchaseDiscount1 ?? 0;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        discPctg = kitc.PurchaseDiscount1 ?? 0;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;
                        break;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0 && discPctg < 100)
                {
                    itemNoStock = "Zero|" + item.ItemName;
                    return;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                if (balance.Balance < resultQty)
                {
                    itemNoStock = item.ItemName;
                    return;
                }

                balance.Balance -= resultQty;

                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                // balance detail (fifo) and movement

                //// cek balance detail
                //var ibds = new ItemBalanceDetailCollection();
                //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == entity.ItemID, ibds.Query.Balance > 0);
                //ibds.LoadAll();

                //if (ibds.Count == 0)
                //{
                //    itemNoStock = item.ItemName + " [Item Balance Detail]";
                //    return;
                //}

                if (!isEnabledStockWithEdControl)
                {
                    try
                    {
                        // query
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                // mark if using average
                                //if (parCostType != "AVG")
                                //{
                                //    entity.Price = details.Price;
                                //    entity.CostPrice = details.Price;
                                //}

                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                        //return;
                                        ////throw;
                                        ///

                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = it.TransactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = it.TransactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                        //return;

                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else
                {
                    try
                    {
                        // query
                        var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                         .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            #region balance detail (fefo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;

                                    var initialStock = movement.InitialStock - movement.QuantityOut;
                                    #endregion

                                    #region balance detail ed (fefo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = it.TransactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = entity.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail ed (fefo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                            return;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail ed (fefo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fefo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                            return;
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForInventoryIssueVoid(ItemTransaction it, ItemTransactionItemCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
            (
                itemBalance.Query.LocationID == locationID,
                itemBalance.Query.ItemID.In(items)
            );
            itemBalance.LoadAll();

            foreach (var item in coll)
            {
                string itemUnit = string.Empty;

                var i = new Item();
                i.LoadByPrimaryKey(item.ItemID);

                switch (i.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        break;
                }

                var balance = itemBalance.SingleOrDefault(ib => ib.ItemID == item.ItemID);
                if (balance != null)
                {
                    #region balance
                    balance.Balance += Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }
                else
                {
                    #region balance
                    balance = itemBalance.AddNew();
                    balance.LocationID = locationID;
                    balance.ItemID = item.ItemID;
                    balance.ReorderType = string.Empty;
                    balance.Minimum = 0;
                    balance.Maximum = 0;
                    balance.Balance = Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }

                if (!isEnabledStockWithEdControl)
                {
                    itemBalanceDetailEds = null;

                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                    decimal? prev = 0;
                    if (mvm == null)
                    {
                        var mov = new ItemMovement();
                        mov.Query.es.Top = 1;
                        mov.Query.Where(
                            mov.Query.LocationID == locationID &&
                            mov.Query.ItemID == item.ItemID
                            );
                        mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                        prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                    }
                    else
                        prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                    #region movement
                    var movement = itemMovements.AddNew();
                    movement.MovementDate = Utils.NowAtSqlServer();
                    movement.ServiceUnitID = serviceUnitID;
                    movement.LocationID = locationID;
                    movement.TransactionCode = it.TransactionCode;
                    movement.TransactionNo = item.TransactionNo;
                    movement.SequenceNo = item.SequenceNo;
                    movement.ItemID = item.ItemID;
                    movement.str.ExpiredDate = string.Empty;
                    movement.InitialStock = prev;
                    movement.QuantityOut = 0;
                    movement.QuantityIn = (item.Quantity ?? 0) * (item.ConversionFactor ?? 0);
                    movement.SRItemUnit = itemUnit;
                    // TODO: cek data costprice ambil dari mana?
                    movement.CostPrice = item.CostPrice;
                    movement.SalesPrice = item.Price;
                    movement.PurchasePrice = item.Price;
                    movement.LastPriceInBaseUnit = 0;
                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                    movement.LastUpdateByUserID = userID;
                    #endregion

                    #region balance detail (fifo)
                    var details = itemBalanceDetails.AddNew();
                    details.LocationID = locationID;
                    details.ItemID = item.ItemID;
                    details.ReferenceNo = item.TransactionNo;
                    details.TransactionCode = it.TransactionCode;
                    details.Balance = (item.Quantity ?? 0) * (item.ConversionFactor ?? 0);
                    details.BalanceDate = Utils.NowAtSqlServer();
                    details.Booking = 0;
                    details.Price = item.Price;
                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                    details.LastUpdateByUserID = userID;
                    details.PurchaseReceiveNo = string.Empty;
                    #endregion
                }
                else
                {
                    itemBalanceDetails = null;

                    var history = new ItemMovementCollection();
                    history.Query.Where(history.Query.TransactionNo == item.TransactionNo, history.Query.ItemID == item.ItemID);
                    history.Query.OrderBy(history.Query.MovementDate.Ascending, history.Query.LastUpdateDateTime.Ascending);
                    history.LoadAll();

                    int idx = 0;

                    foreach (var hist in history)
                    {
                        DateTime expiredDate;
                        string batchNumber;

                        if (hist.ExpiredDate == null)
                        {
                            var ibedq = new ItemBalanceDetailEdQuery();
                            ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == item.ItemID, ibedq.IsActive == true);
                            ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                            ibedq.es.Top = 1;
                            var ibed = new ItemBalanceDetailEd();
                            if (ibed.Load(ibedq))
                            {
                                expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                batchNumber = ibed.BatchNumber;
                            }
                            else
                            {
                                expiredDate = Convert.ToDateTime("1/1/2999");
                                batchNumber = "-N/A-";
                            }
                        }
                        else
                        {
                            expiredDate = Convert.ToDateTime(hist.ExpiredDate);
                            batchNumber = hist.BatchNumber;
                        }

                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                        decimal? prev = 0;
                        if (mvm == null)
                        {
                            var mov = new ItemMovement();
                            mov.Query.es.Top = 1;
                            mov.Query.Where(
                                mov.Query.LocationID == locationID &&
                                mov.Query.ItemID == item.ItemID
                                );
                            mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                            prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                        }
                        else
                            prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = BusinessObject.Reference.TransactionCode.DistributionConfirm;
                        movement.TransactionNo = it.TransactionCode;
                        movement.SequenceNo = hist.SequenceNo;
                        movement.ItemID = item.ItemID;
                        movement.ExpiredDate = expiredDate;
                        movement.BatchNumber = batchNumber;
                        movement.InitialStock = prev;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = hist.QuantityOut;
                        movement.SRItemUnit = itemUnit;
                        movement.CostPrice = hist.CostPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = hist.PurchasePrice;
                        movement.LastPriceInBaseUnit = hist.LastPriceInBaseUnit;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail ed (fefo)
                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == item.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderBy(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                        if (details == null)
                        {
                            details = itemBalanceDetailEds.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = item.ItemID;
                            details.ExpiredDate = movement.ExpiredDate;
                            details.BatchNumber = movement.BatchNumber;
                            details.Balance = hist.QuantityOut;
                            details.ST = string.Empty;
                            details.IsActive = true;
                            details.CreatedDateTime = Utils.NowAtSqlServer();
                            details.CreatedByUserID = userID;
                        }
                        else
                        {
                            if (details.Balance < 0)
                                details.Balance = hist.QuantityOut;
                            else
                                details.Balance += hist.QuantityOut;
                            details.IsActive = true;
                        }

                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        #endregion

                        idx++;
                    }
                }
            }
        }

        public static void PrepareItemBalancesForStockOpname(ItemTransactionItemCollection itemTransactionItemColl, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, ref ItemStockOpnamePrevBalanceCollection itemStockOpnamePrevBalances,
            ref ItemStockOpnamePrevBalanceEdCollection itemStockOpnamePrevBalanceEds)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            var items = (itemTransactionItemColl.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            var transactionNo = itemTransactionItemColl[0].TransactionNo;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            // balance detail
            itemBalanceDetails.Query.Where
            (
                itemBalanceDetails.Query.LocationID == locationID,
                itemBalanceDetails.Query.ItemID.In(items)
            );
            itemBalanceDetails.LoadAll();

            //db:20231219 - override jika tidak ada
            //if (itemBalanceDetails.Count == 0)
            //    return;

            itemBalanceDetailEds = null;
            itemStockOpnamePrevBalanceEds = null;

            // Stock Opname Prev Balance
            itemStockOpnamePrevBalances.Query.Where
            (
                itemStockOpnamePrevBalances.Query.TransactionNo == transactionNo,
                itemStockOpnamePrevBalances.Query.ItemID.In(items)
            );
            itemStockOpnamePrevBalances.LoadAll();


            var serverTime = Utils.NowAtSqlServer();
            foreach (var iti in itemTransactionItemColl)
            {
                decimal? purchase = 0;
                decimal lastPrice = 0;
                var item = new Item();
                item.LoadByPrimaryKey(iti.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        iti.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        purchase = med.PriceInBaseUnit;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        iti.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        purchase = nmed.PriceInBaseUnit;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        iti.CostPrice = kitc.CostPrice;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        purchase = kitc.PriceInBaseUnit;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        break;
                }

                #region balance
                var ib = itemBalance.FindByPrimaryKey(locationID, iti.ItemID);

                var resultQty = iti.Quantity;

                // Jika ternyata Balance sudah berubah maka kurangi entry qty dgn perubahan balance nya (Live count by Handono 2020.02)
                var pb = itemStockOpnamePrevBalances.First(b => b.ItemID == iti.ItemID);
                if (pb.Quantity != ib.Balance)
                {
                    resultQty = iti.Quantity - (pb.Quantity - ib.Balance);

                    // Override menjadi 0 jika ternyata hasilnya <0 Handono 2020.12.02
                    if (resultQty < 0) resultQty = 0;

                    // Override iti.Quantity Handono 2020.12.02
                    if (iti.Quantity != resultQty)
                    {
                        iti.Note = (!string.IsNullOrWhiteSpace(iti.Note) ? string.Format("{0}. ", iti.Note) : string.Empty) + string.Format("Qty entried has override by system from {0} to {1} because Balance has changed", iti.Quantity, resultQty);
                        iti.Quantity = resultQty;
                    }
                }

                // Update kembali info Balancenya
                pb.QtyAtApprove = ib.Balance;

                decimal? diff = resultQty - ib.Balance;
                ib.Balance = resultQty;
                ib.Booking = 0;

                ib.LastUpdateDateTime = serverTime;
                ib.LastUpdateByUserID = userID;
                #endregion

                if (diff < 0)
                {
                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == iti.ItemID && b.Balance > 0)
                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= Math.Abs(diff ?? 0))
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    iti.Price = details.Price;
                            //    iti.CostPrice = details.Price;
                            //}

                            #region balance detail (fifo)
                            details.Balance -= Math.Abs(diff ?? 0);
                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = serverTime;
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _opnameCode;
                            movement.TransactionNo = iti.TransactionNo;
                            movement.SequenceNo = iti.SequenceNo;
                            movement.ItemID = iti.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = ib.Balance + Math.Abs(diff ?? 0);
                            movement.QuantityOut = Math.Abs(diff ?? 0);
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = iti.SRItemUnit;
                            movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                            movement.SalesPrice = iti.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = serverTime;
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = Math.Abs(diff ?? 0); // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                // mark if using average
                                //if (parCostType != "AVG")
                                //{
                                //    iti.Price = details.Price;
                                //    iti.CostPrice = details.Price;
                                //}

                                if (i == 0)
                                    qty = Math.Abs(diff ?? 0) - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = serverTime.AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _opnameCode;
                                    movement.TransactionNo = iti.TransactionNo;
                                    movement.SequenceNo = iti.SequenceNo;
                                    movement.ItemID = iti.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? ib.Balance - (diff ?? 0) : (mvm.InitialStock - mvm.QuantityOut);
                                    //movement.InitialStock = mvm == null ? balance.Balance : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = iti.SRItemUnit;
                                    movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                                    movement.SalesPrice = iti.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = serverTime;
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = serverTime;
                                    #endregion

                                    try
                                    {
                                        // re-query
                                        details = (itemBalanceDetails.Where(b => b.ItemID == iti.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            // re-query
                                            details = (itemBalanceDetails.Where(b => b.ItemID == iti.ItemID)
                                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = serverTime.AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _opnameCode;
                                            movement.TransactionNo = iti.TransactionNo;
                                            movement.SequenceNo = iti.SequenceNo;
                                            movement.ItemID = iti.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = iti.SRItemUnit;
                                            movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                                            movement.SalesPrice = iti.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = serverTime;
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = serverTime.AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _opnameCode;
                                            movement.TransactionNo = iti.TransactionNo;
                                            movement.SequenceNo = iti.SequenceNo;
                                            movement.ItemID = iti.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = iti.SRItemUnit;
                                            movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                                            movement.SalesPrice = iti.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = serverTime;
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = iti.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = iti.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }

                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = serverTime;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = serverTime.AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _opnameCode;
                                    movement.TransactionNo = iti.TransactionNo;
                                    movement.SequenceNo = iti.SequenceNo;
                                    movement.ItemID = iti.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = iti.SRItemUnit;
                                    movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                                    movement.SalesPrice = iti.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = serverTime;
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == iti.ItemID)
                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = serverTime;
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _opnameCode;
                            movement.TransactionNo = iti.TransactionNo;
                            movement.SequenceNo = iti.SequenceNo;
                            movement.ItemID = iti.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = ib.Balance + Math.Abs(diff ?? 0);
                            movement.QuantityOut = Math.Abs(diff ?? 0);
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = iti.SRItemUnit;
                            movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                            movement.SalesPrice = iti.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = serverTime;
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = serverTime;
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _opnameCode;
                            movement.TransactionNo = iti.TransactionNo;
                            movement.SequenceNo = iti.SequenceNo;
                            movement.ItemID = iti.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = ib.Balance + Math.Abs(diff ?? 0);
                            movement.QuantityOut = Math.Abs(diff ?? 0);
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = iti.SRItemUnit;
                            movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                            movement.SalesPrice = iti.Price;
                            movement.PurchasePrice = iti.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = serverTime;
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = iti.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = iti.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else if (diff == 0)
                {
                    var query = new ItemBalanceDetailQuery();
                    query.es.Top = 1;
                    query.Where(query.LocationID == locationID && query.ItemID == iti.ItemID);
                    query.OrderBy(query.BalanceDate.Descending);

                    var details = new ItemBalanceDetail();
                    details.Load(query);

                    if (details != null)
                    {
                        //if (parCostType != "AVG")
                        //{
                        //    iti.Price = details.Price;
                        //    iti.CostPrice = details.Price;
                        //}
                    }
                    #region movement
                    var movement = itemMovements.AddNew();
                    movement.MovementDate = serverTime;
                    movement.ServiceUnitID = serviceUnitID;
                    movement.LocationID = locationID;
                    movement.TransactionCode = _opnameCode;
                    movement.TransactionNo = iti.TransactionNo;
                    movement.SequenceNo = iti.SequenceNo;
                    movement.ItemID = iti.ItemID;
                    movement.str.ExpiredDate = string.Empty;
                    movement.InitialStock = resultQty - (diff ?? 0);
                    movement.QuantityOut = 0;
                    movement.QuantityIn = 0;
                    movement.SRItemUnit = iti.SRItemUnit;
                    movement.CostPrice = iti.CostPrice; // (parCostType == "AVG") ? iti.CostPrice : details.Price;
                    movement.SalesPrice = iti.Price;
                    movement.PurchasePrice = purchase;
                    movement.LastPriceInBaseUnit = lastPrice;
                    movement.LastUpdateDateTime = serverTime;
                    movement.LastUpdateByUserID = userID;
                    #endregion
                }
                else if (diff > 0)
                {
                    var query = new ItemBalanceDetailQuery();
                    query.es.Top = 1;
                    query.Where(query.LocationID == locationID && query.ItemID == iti.ItemID);
                    query.OrderBy(query.BalanceDate.Descending);

                    var details = new ItemBalanceDetail();
                    details.Load(query);

                    if (details != null)
                    {
                        //if (parCostType != "AVG")
                        //{
                        //    iti.Price = details.Price;
                        //    iti.CostPrice = details.Price;
                        //}
                    }

                    #region balance detail (fifo)
                    var balanceDetail = itemBalanceDetails.AddNew();
                    balanceDetail.LocationID = locationID;
                    balanceDetail.ItemID = iti.ItemID;
                    balanceDetail.ReferenceNo = iti.TransactionNo;
                    balanceDetail.TransactionCode = _opnameCode;
                    balanceDetail.BalanceDate = serverTime;
                    balanceDetail.Balance = Math.Abs(diff ?? 0);
                    balanceDetail.Booking = 0;
                    balanceDetail.Price = parCostType != "AVG" ? details.Price : iti.CostPrice;
                    balanceDetail.LastUpdateDateTime = serverTime;
                    balanceDetail.LastUpdateByUserID = userID;
                    #endregion

                    #region movement
                    var movement = itemMovements.AddNew();
                    movement.MovementDate = serverTime;
                    movement.ServiceUnitID = serviceUnitID;
                    movement.LocationID = locationID;
                    movement.TransactionCode = _opnameCode;
                    movement.TransactionNo = iti.TransactionNo;
                    movement.SequenceNo = iti.SequenceNo;
                    movement.ItemID = iti.ItemID;
                    movement.str.ExpiredDate = string.Empty;
                    movement.InitialStock = ib.Balance - Math.Abs(diff ?? 0);
                    movement.QuantityOut = 0;
                    movement.QuantityIn = Math.Abs(diff ?? 0);
                    movement.SRItemUnit = iti.SRItemUnit;
                    movement.CostPrice = iti.CostPrice; // parCostType != "AVG" ? details.Price : iti.CostPrice;
                    movement.SalesPrice = 0;
                    movement.LastPriceInBaseUnit = lastPrice;
                    movement.LastUpdateDateTime = serverTime;
                    movement.LastUpdateByUserID = userID;
                    #endregion
                }
            }
        }

        public static void PrepareItemBalancesForStockOpnameWithEdControl(ItemTransactionItemCollection itemTransactionItemColl, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, ref ItemStockOpnamePrevBalanceCollection itemStockOpnamePrevBalances,
            ref ItemStockOpnamePrevBalanceEdCollection itemStockOpnamePrevBalanceEds)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            var items = (itemTransactionItemColl.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            var transactionNo = itemTransactionItemColl[0].TransactionNo;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            // balance detail ed
            itemBalanceDetailEds.Query.Where
            (
                itemBalanceDetailEds.Query.LocationID == locationID,
                itemBalanceDetailEds.Query.ItemID.In(items)
            );
            itemBalanceDetailEds.LoadAll();

            //db:20240429 - override jika tidak ada
            //if (itemBalanceDetailEds.Count == 0)
            //    return;

            itemBalanceDetails = null;

            // Stock Opname Prev Balance
            itemStockOpnamePrevBalances.Query.Where
            (
                itemStockOpnamePrevBalances.Query.TransactionNo == transactionNo,
                itemStockOpnamePrevBalances.Query.ItemID.In(items)
            );
            itemStockOpnamePrevBalances.LoadAll();

            // Stock Opname Prev Balance ED
            itemStockOpnamePrevBalanceEds.Query.Where
            (
                itemStockOpnamePrevBalanceEds.Query.TransactionNo == transactionNo,
                itemStockOpnamePrevBalanceEds.Query.ItemID.In(items)
            );
            itemStockOpnamePrevBalanceEds.LoadAll();

            var serverTime = Utils.NowAtSqlServer();

            var list = itemTransactionItemColl.GroupBy(c => new
            {
                c.ItemID
            }).Select(q => new
            {
                q.Key.ItemID,
                Quantity = q.Sum(p => (p.ConversionFactor * p.Quantity))
            });

            foreach (var l in list)
            {
                decimal? purchase = 0;
                decimal lastPrice = 0;
                decimal costPrice = 0;
                bool isControlExpired = false;
                var item = new Item();
                item.LoadByPrimaryKey(l.ItemID);

                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        costPrice = med.CostPrice ?? 0;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        purchase = med.PriceInBaseUnit;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        isControlExpired = med.IsControlExpired ?? false;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        costPrice = nmed.CostPrice ?? 0;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        purchase = nmed.PriceInBaseUnit;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        isControlExpired = nmed.IsControlExpired ?? false;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        costPrice = kitc.CostPrice ?? 0;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        purchase = kitc.PriceInBaseUnit;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        isControlExpired = kitc.IsControlExpired ?? false;
                        break;
                }

                #region balance
                var ib = itemBalance.FindByPrimaryKey(locationID, l.ItemID);

                var resultQty = l.Quantity;
                decimal diffOverrideQty = 0;

                // Jika ternyata Balance sudah berubah maka kurangi entry qty dgn perubahan balance nya (Live count by Handono 2020.02)
                var pb = itemStockOpnamePrevBalances.First(b => b.ItemID == l.ItemID);
                if (pb.Quantity != ib.Balance)
                {
                    resultQty = l.Quantity - (pb.Quantity - ib.Balance);

                    // Override menjadi 0 jika ternyata hasilnya <0 Handono 2020.12.02
                    if (resultQty < 0)
                        resultQty = 0;

                    //// Override iti.Quantity Handono 2020.12.02
                    if (l.Quantity != resultQty && resultQty > 0)
                    {
                        //iti.Note = (!string.IsNullOrWhiteSpace(iti.Note) ? string.Format("{0}. ", iti.Note) : string.Empty) + string.Format("Qty entried has override by system from {0} to {1} because Balance has changed", iti.Quantity, resultQty);
                        //iti.Quantity = resultQty;
                        diffOverrideQty = (l.Quantity ?? 0) - (resultQty ?? 0);
                    }
                }

                // Update kembali info Balancenya
                pb.QtyAtApprove = ib.Balance;

                decimal? diff = resultQty - ib.Balance;

                ib.Balance = resultQty;
                ib.Booking = 0;

                ib.LastUpdateDateTime = serverTime;
                ib.LastUpdateByUserID = userID;
                #endregion

                if (diff < 0)
                {
                    int x = 0;
                    decimal reminingOverrideQty = diffOverrideQty;
                    decimal initialStock = 0;
                    decimal qtyOut = 0;

                    var newColl = itemTransactionItemColl.Where(b => b.ItemID == l.ItemID).OrderBy(b => b.ExpiredDate).ThenBy(b => b.SequenceNo);
                    foreach (var iti in newColl)
                    {
                        iti.CostPrice = costPrice;

                        decimal stQty = (iti.Quantity ?? 0) * (iti.ConversionFactor ?? 1);
                        decimal newResultQty = 0;
                        DateTime expiredDate = iti.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                        string batchNumber = string.IsNullOrEmpty(iti.BatchNumber) ? "-N/A-" : iti.BatchNumber;

                        if (reminingOverrideQty == 0)
                        {
                            if (resultQty == 0)
                                newResultQty = 0;
                            else
                                newResultQty = stQty;
                        }
                        else // diffOverrideQty > 0
                        {
                            if (reminingOverrideQty > 0)
                            {
                                if (stQty <= reminingOverrideQty)
                                {
                                    newResultQty = stQty;
                                }
                                else
                                {
                                    newResultQty = stQty - reminingOverrideQty;

                                    foreach (var p in itemTransactionItemColl.Where(p => (p.SequenceNo == iti.SequenceNo)))
                                    {
                                        p.Note = (!string.IsNullOrWhiteSpace(p.Note) ? string.Format("{0}. ", p.Note) : string.Empty) + string.Format("Qty entried has override by system from {0} to {1} because Balance has changed", p.Quantity, newResultQty);
                                        p.Quantity = newResultQty;
                                    }
                                }
                                reminingOverrideQty -= newResultQty;
                            }
                            else
                                newResultQty = stQty;
                        }

                        #region balance detail ed (fefo)
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == iti.ItemID && b.ExpiredDate == expiredDate && b.BatchNumber.ToLower() == batchNumber.ToLower())).Take(1).Single();

                            try
                            {
                                var pbed = itemStockOpnamePrevBalanceEds.Where(b => b.SequenceNo == iti.SequenceNo).Take(1).Single();
                                // Update kembali info Balancenya
                                pbed.QtyAtApprove = details.Balance ?? 0;
                            }
                            catch (Exception)
                            {
                            }

                            details.Balance = newResultQty;

                            var isActive = true;
                            if (isControlExpired)
                                isActive = (newResultQty > 0);

                            //if (details.ExpiredDate == Convert.ToDateTime("1/1/2999") && details.BatchNumber == "-N/A-" && newResultQty == 0)
                            //{
                            //    details.IsActive = true;
                            //    details.ST = "U";
                            //}
                            //else
                            //{
                            //    details.IsActive = (newResultQty > 0);
                            //    details.ST = "U";
                            //}

                            details.IsActive = isActive;
                            details.ST = "U";

                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;

                        }
                        catch (Exception)
                        {
                            var details = itemBalanceDetailEds.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = iti.ItemID;
                            details.ExpiredDate = expiredDate;
                            details.BatchNumber = batchNumber;
                            details.Balance = newResultQty;
                            details.IsActive = true;
                            details.ST = "U";
                            details.CreatedDateTime = serverTime;
                            details.CreatedByUserID = userID;
                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;
                        }
                        #endregion

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = serverTime.AddMilliseconds(x * 100);
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _opnameCode;
                        movement.TransactionNo = iti.TransactionNo;
                        movement.SequenceNo = iti.SequenceNo;
                        movement.ItemID = iti.ItemID;
                        movement.ExpiredDate = expiredDate;
                        movement.BatchNumber = batchNumber;

                        if (x == 0)
                        {
                            movement.InitialStock = ib.Balance + Math.Abs(diff ?? 0);

                            initialStock = movement.InitialStock ?? 0;
                            movement.QuantityOut = Math.Abs(diff ?? 0);
                        }
                        else
                        {
                            movement.InitialStock = initialStock - qtyOut;
                            movement.QuantityOut = 0;
                        }
                        movement.QuantityIn = 0;

                        qtyOut += (movement.QuantityOut ?? 0);

                        movement.SRItemUnit = iti.SRItemUnit;
                        movement.CostPrice = iti.CostPrice;
                        movement.SalesPrice = iti.Price;
                        movement.PurchasePrice = purchase;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = serverTime;
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        x += 1;
                    }

                    var otherDetails = itemBalanceDetailEds.Where(b => b.ItemID == l.ItemID && b.IsActive == true && b.ST == "").OrderBy(b => b.ExpiredDate);
                    foreach (var otherDetail in otherDetails)
                    {
                        otherDetail.Balance = 0;
                        otherDetail.IsActive = false;
                        otherDetail.LastUpdateDateTime = serverTime;
                        otherDetail.LastUpdateByUserID = userID;
                    }
                }
                else if (diff == 0)
                {
                    int x = 0;
                    decimal reminingOverrideQty = diffOverrideQty;

                    var newColl = itemTransactionItemColl.Where(b => b.ItemID == l.ItemID).OrderBy(b => b.ExpiredDate).ThenBy(b => b.SequenceNo);
                    foreach (var iti in newColl)
                    {
                        iti.CostPrice = costPrice;

                        decimal stQty = (iti.Quantity ?? 0) * (iti.ConversionFactor ?? 1);
                        decimal newResultQty = 0;
                        DateTime expiredDate = iti.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                        string batchNumber = string.IsNullOrEmpty(iti.BatchNumber) ? "-N/A-" : iti.BatchNumber;

                        if (reminingOverrideQty == 0)
                        {
                            if (resultQty == 0)
                                newResultQty = 0;
                            else
                                newResultQty = stQty;
                        }
                        else // diffOverrideQty > 0
                        {
                            if (reminingOverrideQty > 0)
                            {
                                if (stQty <= reminingOverrideQty)
                                {
                                    newResultQty = stQty;
                                }
                                else
                                {
                                    newResultQty = stQty - reminingOverrideQty;

                                    foreach (var p in itemTransactionItemColl.Where(p => (p.SequenceNo == iti.SequenceNo)))
                                    {
                                        p.Note = (!string.IsNullOrWhiteSpace(p.Note) ? string.Format("{0}. ", p.Note) : string.Empty) + string.Format("Qty entried has override by system from {0} to {1} because Balance has changed", p.Quantity, newResultQty);
                                        p.Quantity = newResultQty;
                                    }
                                }
                                reminingOverrideQty -= newResultQty;
                            }
                            else
                                newResultQty = stQty;
                        }

                        #region balance detail ed(fefo)
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == iti.ItemID && b.ExpiredDate == expiredDate && b.BatchNumber.ToLower() == batchNumber.ToLower())).Take(1).Single();

                            try
                            {
                                var pbed = itemStockOpnamePrevBalanceEds.Where(b => b.SequenceNo == iti.SequenceNo).Take(1).Single();
                                // Update kembali info Balancenya
                                pbed.QtyAtApprove = details.Balance ?? 0;
                            }
                            catch (Exception)
                            {
                            }

                            details.Balance = newResultQty;

                            var isActive = true;
                            if (isControlExpired)
                                isActive = (newResultQty > 0);

                            //if (details.ExpiredDate == Convert.ToDateTime("1/1/2999") && details.BatchNumber == "-N/A-" && newResultQty == 0)
                            //{
                            //    details.IsActive = true;
                            //    details.ST = "U";
                            //}
                            //else
                            //{
                            //    details.IsActive = (newResultQty > 0);
                            //    details.ST = "U";
                            //}

                            details.IsActive = isActive;
                            details.ST = "U";

                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;
                        }
                        catch (Exception)
                        {
                            var details = itemBalanceDetailEds.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = iti.ItemID;
                            details.ExpiredDate = expiredDate;
                            details.BatchNumber = batchNumber;
                            details.Balance = newResultQty;
                            details.IsActive = true;
                            details.ST = "U";
                            details.CreatedDateTime = serverTime;
                            details.CreatedByUserID = userID;
                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;
                        }
                        #endregion

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = serverTime.AddMilliseconds(x * 100);
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _opnameCode;
                        movement.TransactionNo = iti.TransactionNo;
                        movement.SequenceNo = iti.SequenceNo;
                        movement.ItemID = iti.ItemID;
                        movement.ExpiredDate = expiredDate;
                        movement.BatchNumber = batchNumber;
                        movement.InitialStock = ib.Balance;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = iti.SRItemUnit;
                        movement.CostPrice = iti.CostPrice;
                        movement.SalesPrice = iti.Price;
                        movement.PurchasePrice = purchase;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = serverTime;
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        x += 1;
                    }

                    var otherDetails = itemBalanceDetailEds.Where(b => b.ItemID == l.ItemID && b.IsActive == true && b.ST == "").OrderBy(b => b.ExpiredDate);
                    foreach (var otherDetail in otherDetails)
                    {
                        otherDetail.Balance = 0;
                        otherDetail.IsActive = false;
                        otherDetail.LastUpdateDateTime = serverTime;
                        otherDetail.LastUpdateByUserID = userID;
                    }
                }
                else // diff > 0
                {
                    int x = 0;
                    decimal reminingOverrideQty = diffOverrideQty;
                    decimal qtyIn = 0;
                    decimal initialStock = 0;

                    var newColl = itemTransactionItemColl.Where(b => b.ItemID == l.ItemID).OrderBy(b => b.ExpiredDate).ThenBy(b => b.SequenceNo);
                    foreach (var iti in newColl)
                    {
                        iti.CostPrice = costPrice;

                        decimal stQty = (iti.Quantity ?? 0) * (iti.ConversionFactor ?? 1);
                        decimal newResultQty = 0;
                        DateTime expiredDate = iti.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                        string batchNumber = string.IsNullOrEmpty(iti.BatchNumber) ? "-N/A-" : iti.BatchNumber;

                        if (reminingOverrideQty == 0)
                        {
                            if (resultQty == 0)
                                newResultQty = 0;
                            else
                                newResultQty = stQty;
                        }
                        else // diffOverrideQty > 0
                        {
                            if (reminingOverrideQty > 0)
                            {
                                if (stQty <= reminingOverrideQty)
                                {
                                    newResultQty = stQty;
                                }
                                else
                                {
                                    newResultQty = stQty - reminingOverrideQty;

                                    foreach (var p in itemTransactionItemColl.Where(p => (p.SequenceNo == iti.SequenceNo)))
                                    {
                                        p.Note = (!string.IsNullOrWhiteSpace(p.Note) ? string.Format("{0}. ", p.Note) : string.Empty) + string.Format("Qty entried has override by system from {0} to {1} because Balance has changed", p.Quantity, newResultQty);
                                        p.Quantity = newResultQty;
                                    }
                                }
                                reminingOverrideQty -= newResultQty;
                            }
                            else
                                newResultQty = stQty;
                        }

                        #region balance detail ed (fefo)
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == iti.ItemID && b.ExpiredDate == expiredDate && b.BatchNumber.ToLower() == batchNumber.ToLower())).Take(1).Single();

                            try
                            {
                                var pbed = itemStockOpnamePrevBalanceEds.Where(b => b.SequenceNo == iti.SequenceNo).Take(1).Single();
                                // Update kembali info Balancenya
                                pbed.QtyAtApprove = details.Balance ?? 0;
                            }
                            catch (Exception)
                            {
                            }

                            details.Balance = newResultQty;

                            var isActive = true;
                            if (isControlExpired)
                                isActive = (newResultQty > 0);

                            //if (details.ExpiredDate == Convert.ToDateTime("1/1/2999") && details.BatchNumber == "-N/A-" && newResultQty == 0)
                            //{
                            //    details.IsActive = true;
                            //    details.ST = "U";
                            //}
                            //else
                            //{
                            //    details.IsActive = (newResultQty > 0);
                            //    details.ST = "U";
                            //}

                            details.IsActive = isActive;
                            details.ST = "U";

                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;

                        }
                        catch (Exception)
                        {
                            var details = itemBalanceDetailEds.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = iti.ItemID;
                            details.ExpiredDate = expiredDate;
                            details.BatchNumber = batchNumber;
                            details.Balance = newResultQty;
                            details.IsActive = true;
                            details.ST = "U";
                            details.CreatedDateTime = serverTime;
                            details.CreatedByUserID = userID;
                            details.LastUpdateDateTime = serverTime;
                            details.LastUpdateByUserID = userID;
                        }
                        #endregion

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = serverTime.AddMilliseconds(x * 100);
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _opnameCode;
                        movement.TransactionNo = iti.TransactionNo;
                        movement.SequenceNo = iti.SequenceNo;
                        movement.ItemID = iti.ItemID;
                        movement.ExpiredDate = expiredDate;
                        movement.BatchNumber = batchNumber;

                        if (x == 0)
                        {
                            movement.InitialStock = ib.Balance - Math.Abs(diff ?? 0);

                            initialStock = movement.InitialStock ?? 0;
                            movement.QuantityIn = Math.Abs(diff ?? 0);
                        }
                        else
                        {
                            movement.InitialStock = initialStock + qtyIn;
                            movement.QuantityIn = 0;
                        }
                        movement.QuantityOut = 0;

                        qtyIn += (movement.QuantityIn ?? 0);

                        movement.SRItemUnit = iti.SRItemUnit;
                        movement.CostPrice = iti.CostPrice;
                        movement.SalesPrice = iti.Price;
                        movement.PurchasePrice = purchase;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = serverTime;
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        x += 1;
                    }

                    var otherDetails = itemBalanceDetailEds.Where(b => b.ItemID == l.ItemID && b.IsActive == true && b.ST == "").OrderBy(b => b.ExpiredDate);
                    foreach (var otherDetail in otherDetails)
                    {
                        otherDetail.Balance = 0;
                        otherDetail.IsActive = false;
                        otherDetail.LastUpdateDateTime = serverTime;
                        otherDetail.LastUpdateByUserID = userID;
                    }
                }
            }
        }


        public static void PrepareItemBalancesForAdjustment(ItemTransactionItemCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            // balance detail
            itemBalanceDetails.Query.Where
            (
                itemBalanceDetails.Query.LocationID == locationID,
                itemBalanceDetails.Query.ItemID.In(items)
            );
            itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
            itemBalanceDetails.LoadAll();

            // ini diremark, karena kalau mau adjust + sementara belum ada itembalance detail jadi tidak masuk ke balance
            //if (itemBalanceDetails.Count == 0)
            //    return;

            itemBalanceDetailEds = null;

            foreach (ItemTransactionItem entity in coll)
            {
                decimal? purchase = 0, resultQty = entity.Quantity;
                decimal lastPrice = 0;
                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        purchase = med.PriceInBaseUnit;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        purchase = nmed.PriceInBaseUnit;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        purchase = kitc.PriceInBaseUnit;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        break;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);
                balance.Balance += resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                if (balance.Balance < 0)
                {
                    throw new Exception("Item balance result of item " + item.ItemName + " can't be less than zero");
                }

                // balance detail (fifo) and movement
                // query
                if (resultQty < 0)
                {
                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID &&
                                                                 b.Balance > 0)
                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= Math.Abs(resultQty ?? 0))
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            #region balance detail (fifo)
                            details.Balance -= Math.Abs(resultQty ?? 0);
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _adjustmentCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + Math.Abs(resultQty ?? 0);
                            movement.QuantityOut = Math.Abs(resultQty ?? 0);
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = Math.Abs(resultQty ?? 0); // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                // mark if using average
                                //if (parCostType != "AVG")
                                //{
                                //    entity.Price = details.Price;
                                //    entity.CostPrice = details.Price;
                                //}

                                if (i == 0)
                                    qty = Math.Abs(resultQty ?? 0) - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _adjustmentCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + Math.Abs(resultQty ?? 0)) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    try
                                    {
                                        // re-query
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            // re-query
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _adjustmentCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _adjustmentCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _adjustmentCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _adjustmentCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + Math.Abs(resultQty ?? 0);
                            movement.QuantityOut = Math.Abs(resultQty ?? 0);
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _adjustmentCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + Math.Abs(resultQty ?? 0);
                            movement.QuantityOut = Math.Abs(resultQty ?? 0);
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else
                {
                    var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).SingleOrDefault();
                    if (details != null)
                    {
                        //if (parCostType != "AVG")
                        //{
                        //    entity.Price = details.Price;
                        //    entity.CostPrice = details.Price;
                        //}
                    }

                    #region balance detail (fifo)
                    var detail = itemBalanceDetails.AddNew();
                    detail.LocationID = locationID;
                    detail.ItemID = entity.ItemID;
                    detail.ReferenceNo = entity.TransactionNo;
                    detail.TransactionCode = _adjustmentCode;
                    detail.BalanceDate = Utils.NowAtSqlServer();
                    detail.Balance = resultQty;
                    detail.Booking = 0;
                    detail.Price = parCostType != "AVG" ? (details != null ? details.Price : entity.CostPrice) : entity.CostPrice;
                    detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                    detail.LastUpdateByUserID = userID;
                    #endregion

                    #region movement
                    var movement = itemMovements.AddNew();
                    movement.MovementDate = Utils.NowAtSqlServer();
                    movement.ServiceUnitID = serviceUnitID;
                    movement.LocationID = locationID;
                    movement.TransactionCode = _adjustmentCode;
                    movement.TransactionNo = entity.TransactionNo;
                    movement.SequenceNo = entity.SequenceNo;
                    movement.ItemID = entity.ItemID;
                    movement.str.ExpiredDate = string.Empty;
                    movement.InitialStock = balance.Balance - resultQty;
                    movement.QuantityOut = 0;
                    movement.QuantityIn = resultQty;
                    movement.SRItemUnit = entity.SRItemUnit;
                    movement.CostPrice = entity.CostPrice; // parCostType != "AVG" ? (details != null ? details.Price : entity.CostPrice) : entity.CostPrice;
                    movement.SalesPrice = entity.Price;
                    movement.PurchasePrice = purchase;
                    movement.LastPriceInBaseUnit = lastPrice;
                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                    movement.LastUpdateByUserID = userID;
                    #endregion
                }
            }
        }

        public static void PrepareItemBalancesForAdjustmentWithEdControl(ItemTransactionItemCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            //balance detail 
            itemBalanceDetailEds.Query.Where
                                (
                                    itemBalanceDetailEds.Query.LocationID == locationID,
                                    itemBalanceDetailEds.Query.ItemID.In(items)
                                );
            itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Ascending);
            itemBalanceDetailEds.LoadAll();

            itemBalanceDetails = null;

            var list = coll.GroupBy(c => new
            {
                c.ItemID
            }).Select(q => new
            {
                q.Key.ItemID,
                Quantity = q.Sum(p => (p.ConversionFactor * p.Quantity))
            });

            foreach (var l in list)
            {
                decimal? purchase = 0, resultQty = l.Quantity;
                decimal lastPrice = 0;
                bool isControlExpired = false;
                var item = new Item();
                item.LoadByPrimaryKey(l.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        purchase = med.PriceInBaseUnit;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        isControlExpired = med.IsControlExpired ?? false;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        purchase = nmed.PriceInBaseUnit;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        isControlExpired = nmed.IsControlExpired ?? false;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        purchase = kitc.PriceInBaseUnit;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        isControlExpired = kitc.IsControlExpired ?? false;
                        break;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, l.ItemID);
                var initialStock = balance.Balance;

                balance.Balance += resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                if (balance.Balance < 0)
                {
                    throw new Exception("Item balance result of item " + item.ItemName + " can't be less than zero");
                }

                var newColl = coll.Where(b => b.ItemID == l.ItemID);

                int x = 0;
                foreach (ItemTransactionItem entity in newColl)
                {

                    decimal? newResultQty = entity.Quantity * entity.ConversionFactor;
                    DateTime expiredDate = entity.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                    // balance detail (fefo) and movement
                    // query
                    if (newResultQty < 0)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.ExpiredDate == expiredDate && b.BatchNumber.ToLower() == entity.BatchNumber.ToLower())).Take(1).Single();

                            if (details.Balance >= Math.Abs(newResultQty ?? 0))
                            {
                                #region balance detail (fefo)
                                details.Balance -= Math.Abs(newResultQty ?? 0);
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(x * 10);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _adjustmentCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = initialStock;
                                movement.QuantityIn = 0;
                                movement.QuantityOut = Math.Abs(newResultQty ?? 0);

                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = entity.Price;
                                movement.PurchasePrice = entity.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;

                                initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                #endregion
                            }
                            else
                            {
                                if (!isControlExpired)
                                {
                                    #region balance detail (fefo)
                                    details.Balance = 0;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID).OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(x * 10);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _adjustmentCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = expiredDate;
                                    movement.BatchNumber = entity.BatchNumber;
                                    movement.InitialStock = initialStock;
                                    movement.QuantityIn = 0;
                                    movement.QuantityOut = Math.Abs(newResultQty ?? 0);
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;

                                    initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                    #endregion
                                }
                                else
                                {
                                    try
                                    {
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0).OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                        if (details.Balance >= Math.Abs(newResultQty ?? 0))
                                        {
                                            #region balance detail (fefo)
                                            details.Balance -= Math.Abs(newResultQty ?? 0);
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            #endregion

                                            #region movement
                                            var mvm = (itemMovements.Where(im => im.ItemID == entity.ItemID).OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(x * 10);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _adjustmentCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityIn = 0;
                                            movement.QuantityOut = Math.Abs(newResultQty ?? 0);
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = entity.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                            #endregion
                                        }
                                        else
                                        {
                                            decimal? qty = Math.Abs(newResultQty ?? 0); // 5
                                            int i = 0;
                                            while (qty > 0)
                                            {
                                                if (i == 0)
                                                    qty = Math.Abs(newResultQty ?? 0) - details.Balance; // 5 - 2
                                                else
                                                    qty -= details.Balance;

                                                if (qty > 0)
                                                {
                                                    #region movement
                                                    var movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _adjustmentCode;
                                                    movement.TransactionNo = entity.TransactionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = details.Balance;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = entity.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;

                                                    initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = 0;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    // re-query
                                                    try
                                                    {
                                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                                    }
                                                    catch (Exception)
                                                    {
                                                        throw new Exception(string.Format("Insufficient balance of item {0} with selected expired date & batch number", item.ItemName));
                                                    }
                                                }
                                                else
                                                {
                                                    #region balance detail ed (fefo)
                                                    var bal = details.Balance;
                                                    details.Balance -= (details.Balance + qty);
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    #region movement
                                                    var movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _adjustmentCode;
                                                    movement.TransactionNo = entity.TransactionNo;
                                                    movement.SequenceNo = entity.SequenceNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = bal + qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice;
                                                    movement.SalesPrice = entity.Price;
                                                    movement.PurchasePrice = entity.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;

                                                    initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                                    #endregion
                                                }

                                                i++;
                                            }
                                        }
                                    }
                                    catch (Exception)
                                    {
                                        throw new Exception(string.Format("Insufficient balance of item {0} with selected expired date & batch number", item.ItemName));
                                    }
                                }

                            }
                        }
                        catch (Exception)
                        {
                            if (!isControlExpired)
                            {
                                var itemBalanceDetailEd = itemBalanceDetailEds.AddNew();
                                itemBalanceDetailEd.LocationID = locationID;
                                itemBalanceDetailEd.ItemID = item.ItemID;
                                itemBalanceDetailEd.ExpiredDate = expiredDate;
                                itemBalanceDetailEd.BatchNumber = "-N/A-";
                                itemBalanceDetailEd.Balance = 0;
                                itemBalanceDetailEd.IsActive = true;
                                itemBalanceDetailEd.CreatedDateTime = Utils.NowAtSqlServer();
                                itemBalanceDetailEd.CreatedByUserID = userID;
                                itemBalanceDetailEd.LastUpdateDateTime = Utils.NowAtSqlServer();
                                itemBalanceDetailEd.LastUpdateByUserID = userID;

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(x * 10);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _adjustmentCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = expiredDate;
                                movement.BatchNumber = entity.BatchNumber;
                                movement.InitialStock = initialStock;
                                movement.QuantityIn = 0;
                                movement.QuantityOut = Math.Abs(newResultQty ?? 0);
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = entity.Price;
                                movement.PurchasePrice = entity.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;

                                initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                #endregion
                            }
                            else
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0).OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                    if (details.Balance >= Math.Abs(newResultQty ?? 0))
                                    {
                                        #region balance detail (fefo)
                                        details.Balance -= Math.Abs(newResultQty ?? 0);
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        details.LastUpdateByUserID = userID;
                                        #endregion

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(x * 10);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _adjustmentCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = initialStock;
                                        movement.QuantityIn = 0;
                                        movement.QuantityOut = Math.Abs(newResultQty ?? 0);
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = entity.Price;
                                        movement.PurchasePrice = entity.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;

                                        initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                        #endregion
                                    }
                                    else
                                    {
                                        decimal? qty = Math.Abs(newResultQty ?? 0); // 5
                                        int i = 0;
                                        while (qty > 0)
                                        {
                                            if (i == 0)
                                                qty = Math.Abs(newResultQty ?? 0) - details.Balance; // 5 - 2
                                            else
                                                qty -= details.Balance;

                                            if (qty > 0)
                                            {
                                                #region movement
                                                var movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _adjustmentCode;
                                                movement.TransactionNo = entity.TransactionNo;
                                                movement.SequenceNo = entity.SequenceNo;
                                                movement.ItemID = entity.ItemID;
                                                movement.ExpiredDate = details.ExpiredDate;
                                                movement.BatchNumber = details.BatchNumber;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = details.Balance;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.CostPrice;
                                                movement.SalesPrice = entity.Price;
                                                movement.PurchasePrice = entity.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;

                                                initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                                #endregion

                                                #region balance detail (fefo)
                                                details.Balance = 0;
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                // re-query
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                                }
                                                catch (Exception)
                                                {
                                                    throw new Exception(string.Format("Insufficient balance of item {0} with selected expired date & batch number", item.ItemName));
                                                }
                                            }
                                            else
                                            {
                                                #region balance detail ed (fefo)
                                                var bal = details.Balance;
                                                details.Balance -= (details.Balance + qty);
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                #region movement
                                                var movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _adjustmentCode;
                                                movement.TransactionNo = entity.TransactionNo;
                                                movement.SequenceNo = entity.SequenceNo;
                                                movement.ItemID = entity.ItemID;
                                                movement.ExpiredDate = details.ExpiredDate;
                                                movement.BatchNumber = details.BatchNumber;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = bal + qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.CostPrice;
                                                movement.SalesPrice = entity.Price;
                                                movement.PurchasePrice = entity.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;

                                                initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                                                #endregion
                                            }

                                            i++;
                                        }
                                    }
                                }
                                catch (Exception)
                                {
                                    throw new Exception(string.Format("Insufficient balance of item {0} with selected expired date & batch number", item.ItemName));
                                }
                            }
                        }
                    }
                    else
                    {
                        #region ItemBalanceDetailEd

                        ItemBalanceDetailEd itemBalanceDetailEd = null;
                        var isAvailable = false;
                        foreach (var findBalance in itemBalanceDetailEds.Where(findBalance => findBalance.ItemID.Equals(entity.ItemID) &&
                                                                                findBalance.ExpiredDate.Equals(expiredDate) &&
                                                                                  findBalance.BatchNumber.ToLower().Equals(entity.BatchNumber.ToLower())))
                        {
                            isAvailable = true;
                            itemBalanceDetailEd = findBalance;
                            break;
                        }
                        if (!isAvailable)
                        {
                            itemBalanceDetailEd = itemBalanceDetailEds.AddNew();
                            itemBalanceDetailEd.LocationID = locationID;
                            itemBalanceDetailEd.ItemID = entity.ItemID;
                            itemBalanceDetailEd.ExpiredDate = expiredDate;
                            itemBalanceDetailEd.BatchNumber = entity.BatchNumber;
                            itemBalanceDetailEd.Balance = newResultQty;
                            itemBalanceDetailEd.IsActive = true;
                            itemBalanceDetailEd.CreatedDateTime = Utils.NowAtSqlServer();
                            itemBalanceDetailEd.CreatedByUserID = userID;
                        }
                        else
                        {
                            itemBalanceDetailEd.Balance += newResultQty;
                        }
                        itemBalanceDetailEd.LastUpdateDateTime = Utils.NowAtSqlServer();
                        itemBalanceDetailEd.LastUpdateByUserID = userID;

                        #endregion

                        #region movement

                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(x * 100);
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _adjustmentCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.ExpiredDate = expiredDate;
                        movement.BatchNumber = entity.BatchNumber;
                        movement.InitialStock = initialStock;
                        movement.QuantityIn = Math.Abs(newResultQty ?? 0);
                        movement.QuantityOut = 0;
                        movement.SRItemUnit = entity.SRItemUnit;
                        movement.CostPrice = entity.CostPrice;
                        movement.SalesPrice = entity.Price;
                        movement.PurchasePrice = purchase;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        initialStock = movement.InitialStock + movement.QuantityIn - movement.QuantityOut;
                    }

                    x += 1;
                }
            }
        }

        public static void PrepareItemBalancesForProduction(ProductionOfGoods entityHd, ProductionOfGoodsItemCollection collDt,
            ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, ref ItemMovementCollection itemMovements,
            string userID, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var coll = collDt.Where(c => c.IsConsumables == true);
            var list = coll.GroupBy(c => c.ItemID).Select(q => new
            {
                ItemID = q.Key,
                Quantity = q.Sum(p => (p.Qty))
            });

            var balances = new ItemBalanceCollection();
            balances.Query.Where(
                balances.Query.LocationID == entityHd.LocationID,
                balances.Query.ItemID.In(list.Select(l => l.ItemID))
                );
            balances.LoadAll();

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == entityHd.LocationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
            {
                itemNoStock = "Unmapping item: ItemBalance";
                return;
            }

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == entityHd.LocationID,
                    itemBalanceDetails.Query.ItemID.In(items),
                    itemBalanceDetails.Query.Balance > 0
                );
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "Item Balance Detail";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ED
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == entityHd.LocationID,
                    itemBalanceDetailEds.Query.ItemID.In(items),
                    itemBalanceDetailEds.Query.IsActive == true
                );
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "Unmapping item: ItemBalanceDetailEd";
                //    return;
                //}

                itemBalanceDetails = null;
            }

            foreach (var entity in coll)
            {
                //karena production pakai satuan kecil jadi conversion factor tdk dimasukkan (dianggap 1)
                decimal? resultQty = entity.Qty;
                string itemUnit = string.Empty;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        break;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(entityHd.LocationID, entity.ItemID);

                //if (balance.Balance < resultQty)
                //{
                //    itemNoStock = item.ItemName;
                //    return;
                //}

                balance.Balance -= resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                if (!isEnabledStockWithEdControl)
                {
                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.CostPrice = details.Price;
                            //}

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                            movement.LocationID = entityHd.LocationID;
                            movement.TransactionCode = _productionOfGoodsCode;
                            movement.TransactionNo = entityHd.ProductionNo;
                            movement.SequenceNo = string.Empty;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.CostPrice = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = entityHd.ServiceUnitID;
                                    movement.LocationID = entityHd.LocationID;
                                    movement.TransactionCode = _productionOfGoodsCode;
                                    movement.TransactionNo = entityHd.ProductionNo;
                                    movement.SequenceNo = string.Empty;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                               .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                        //return;

                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                               .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                                            movement.LocationID = entityHd.LocationID;
                                            movement.TransactionCode = _productionOfGoodsCode;
                                            movement.TransactionNo = entityHd.ProductionNo;
                                            movement.SequenceNo = string.Empty;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                                            movement.LocationID = entityHd.LocationID;
                                            movement.TransactionCode = _productionOfGoodsCode;
                                            movement.TransactionNo = entityHd.ProductionNo;
                                            movement.SequenceNo = string.Empty;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = entityHd.LocationID;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = entityHd.ServiceUnitID;
                                    movement.LocationID = entityHd.LocationID;
                                    movement.TransactionCode = _productionOfGoodsCode;
                                    movement.TransactionNo = entityHd.ProductionNo;
                                    movement.SequenceNo = string.Empty;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                        //return;

                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                            movement.LocationID = entityHd.LocationID;
                            movement.TransactionCode = _productionOfGoodsCode;
                            movement.TransactionNo = entityHd.ProductionNo;
                            movement.SequenceNo = string.Empty;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                            movement.LocationID = entityHd.LocationID;
                            movement.TransactionCode = _productionOfGoodsCode;
                            movement.TransactionNo = entityHd.ProductionNo;
                            movement.SequenceNo = string.Empty;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = entity.PriceInBaseUnit;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = entityHd.LocationID;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else
                {
                    try
                    {
                        var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            #region balance detail ed (fefo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                            movement.LocationID = entityHd.LocationID;
                            movement.TransactionCode = _productionOfGoodsCode;
                            movement.TransactionNo = entityHd.ProductionNo;
                            movement.SequenceNo = string.Empty;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = entity.PriceInBaseUnit;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = entityHd.ServiceUnitID;
                                    movement.LocationID = entityHd.LocationID;
                                    movement.TransactionCode = _productionOfGoodsCode;
                                    movement.TransactionNo = entityHd.ProductionNo;
                                    movement.SequenceNo = string.Empty;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = entity.PriceInBaseUnit;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;

                                    var initialStock = movement.InitialStock - movement.QuantityOut;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                                            movement.LocationID = entityHd.LocationID;
                                            movement.TransactionCode = _productionOfGoodsCode;
                                            movement.TransactionNo = entityHd.ProductionNo;
                                            movement.SequenceNo = string.Empty;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = entity.PriceInBaseUnit;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                            return;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail ed (fefo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = entityHd.ServiceUnitID;
                                    movement.LocationID = entityHd.LocationID;
                                    movement.TransactionCode = _productionOfGoodsCode;
                                    movement.TransactionNo = entityHd.ProductionNo;
                                    movement.SequenceNo = string.Empty;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = entity.PriceInBaseUnit;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = entityHd.ServiceUnitID;
                            movement.LocationID = entityHd.LocationID;
                            movement.TransactionCode = _productionOfGoodsCode;
                            movement.TransactionNo = entityHd.ProductionNo;
                            movement.SequenceNo = string.Empty;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = entity.PriceInBaseUnit;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fefo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateByUserID = userID;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            #endregion
                        }
                        catch (Exception)
                        {
                            itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                            return;
                        }
                    }
                }
            }

        }


        public static void PrepareItemBalancesForDistribution(ItemTransactionItemCollection coll, string serviceUnitID, string locationID, string toLocationID,
            string userID, string referenceNo, ref ItemTransaction reference, ref ItemTransactionItemCollection referenceItems,
            ref ItemBalanceCollection itemBalance, ref ItemBalanceCollection itemBalanceTo, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements,
            ref ItemTransactionItemHistoryCollection itemHistory, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, out string itemNoStock, bool isEnabledStockWithEdControl)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            string isAutoClosedDistReq =
                AppParameter.GetParameterValue(AppParameter.ParameterItem.IsAutoClosedDistRequest);

            if (isAutoClosedDistReq == "Yes")
            {
                if (!string.IsNullOrEmpty(referenceNo))
                {
                    reference.LoadByPrimaryKey(referenceNo);
                    reference.IsClosed = true;
                    reference.LastUpdateDateTime = Utils.NowAtSqlServer();
                    reference.LastUpdateByUserID = userID;
                }
                else
                    reference = null;

                if (!string.IsNullOrEmpty(referenceNo))
                {
                    referenceItems.Query.Where(referenceItems.Query.TransactionNo == referenceNo);
                    referenceItems.LoadAll();

                    foreach (var referenceItem in referenceItems)
                    {
                        referenceItem.IsClosed = true;
                        referenceItem.LastUpdateDateTime = Utils.NowAtSqlServer();
                        referenceItem.LastUpdateByUserID = userID;
                    }
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(referenceNo))
                {
                    referenceItems.Query.Where(referenceItems.Query.TransactionNo == referenceNo);
                    referenceItems.LoadAll();
                }
            }

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
            {
                itemNoStock = "x|-Item Balance-";
                return;
            }

            //balance to
            itemBalanceTo.Query.Where
                (
                    itemBalanceTo.Query.LocationID == toLocationID,
                    itemBalanceTo.Query.ItemID.In(items)
                );
            itemBalanceTo.LoadAll();

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "x|-Item Balance Detail-";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed
                itemBalanceDetailEds.Query.Where(itemBalanceDetailEds.Query.LocationID == locationID, itemBalanceDetailEds.Query.ItemID.In(items), itemBalanceDetailEds.Query.IsActive == true);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "x|-Item Balance Detail Expired-";
                //    return;
                //}

                itemBalanceDetails = null;
                itemHistory = null;
            }

            foreach (var entity in coll)
            {
                decimal? resultQty = entity.Quantity * entity.ConversionFactor;
                string itemUnit = string.Empty;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                decimal price = 0;
                decimal lastPrice = 0;
                decimal discPctg = 0;
                bool isControlEd = false;
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        discPctg = med.PurchaseDiscount1 ?? 0;
                        isControlEd = med.IsControlExpired ?? false;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        discPctg = nmed.PurchaseDiscount1 ?? 0;
                        isControlEd = nmed.IsControlExpired ?? false;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        discPctg = kitc.PurchaseDiscount1 ?? 0;
                        isControlEd = kitc.IsControlExpired ?? false;
                        break;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0 && discPctg < 100)
                {
                    itemNoStock = "Zero|" + item.ItemName;
                    return;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                if (balance.Balance < resultQty)
                {
                    itemNoStock = item.ItemName;
                    return;
                }

                balance.Balance -= resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                #region balance to
                var balanceTo = itemBalanceTo.FindByPrimaryKey(toLocationID, entity.ItemID);
                if (balanceTo != null)
                {
                    balanceTo.Booking += resultQty;
                    balanceTo.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balanceTo.LastUpdateByUserID = userID;
                }
                else
                {
                    balanceTo = itemBalance.AddNew();
                    balanceTo.LocationID = toLocationID;
                    balanceTo.ItemID = entity.ItemID;
                    balanceTo.ReorderType = string.Empty;
                    balanceTo.Minimum = 0;
                    balanceTo.Maximum = 0;
                    balanceTo.Balance = 0;
                    balanceTo.Booking = resultQty;
                    balanceTo.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balanceTo.LastUpdateByUserID = userID;
                }
                #endregion

                //// cek balance detail
                //var ibds = new ItemBalanceDetailCollection();
                //ibds.Query.Where(
                //    ibds.Query.LocationID == locationID,
                //    ibds.Query.ItemID == item.ItemID,
                //    ibds.Query.Balance > 0
                //    );
                //ibds.LoadAll();

                //if (ibds.Count == 0)
                //{
                //    itemNoStock = item.ItemName + " [Item Balance Detail]";
                //    return;
                //}

                if (isAutoClosedDistReq == "No")
                {
                    if (referenceItems.Count > 0)
                    {
                        try
                        {
                            var dtRef = referenceItems.Single(r => r.SequenceNo == entity.ReferenceSequenceNo);
                            dtRef.QuantityFinishInBaseUnit += resultQty;
                            dtRef.IsClosed = dtRef.QuantityFinishInBaseUnit >= (dtRef.Quantity * dtRef.ConversionFactor);
                            if (dtRef.IsClosed ?? false)
                            {
                                dtRef.LastInvoiceUpdateByUserID = userID;
                                dtRef.LastInvoiceUpdateDateTime = Utils.NowAtSqlServer();
                            }
                        }
                        catch (Exception)
                        {
                            //throw;
                        }

                    }
                }

                if (!isEnabledStockWithEdControl)
                {
                    // FIFO (ItemBalanceDetail)

                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            #region history
                            var history = itemHistory.AddNew();
                            history.TransactionNo = entity.TransactionNo;
                            history.LocationID = details.LocationID;
                            history.ItemID = details.ItemID;
                            history.ReferenceNo = details.PurchaseReceiveNo ?? (string.IsNullOrEmpty(details.ReferenceNo) ? entity.TransactionNo : details.ReferenceNo);
                            history.BalanceDate = details.BalanceDate;
                            history.Balance = resultQty;
                            history.Price = details.Price;
                            history.CostPrice = entity.CostPrice;
                            history.LastPriceInBaseUnit = lastPrice;
                            history.LastUpdateDateTime = Utils.NowAtSqlServer();
                            history.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _distributionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region history
                                    var history = itemHistory.AddNew();
                                    history.TransactionNo = entity.TransactionNo;
                                    history.LocationID = details.LocationID;
                                    history.ItemID = details.ItemID;
                                    history.ReferenceNo = details.PurchaseReceiveNo ?? (string.IsNullOrEmpty(details.ReferenceNo) ? entity.TransactionNo : details.ReferenceNo);
                                    history.BalanceDate = details.BalanceDate;
                                    history.Balance = details.Balance;
                                    history.Price = details.Price;
                                    history.CostPrice = entity.CostPrice;
                                    history.LastPriceInBaseUnit = lastPrice;
                                    history.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    history.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _distributionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                        //return;

                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _distributionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _distributionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = entity.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }

                                }
                                else
                                {
                                    #region history
                                    var history = itemHistory.AddNew();
                                    history.TransactionNo = entity.TransactionNo;
                                    history.LocationID = details.LocationID;
                                    history.ItemID = details.ItemID;
                                    history.ReferenceNo = details.PurchaseReceiveNo ?? (string.IsNullOrEmpty(details.ReferenceNo) ? entity.TransactionNo : details.ReferenceNo);
                                    history.BalanceDate = details.BalanceDate;
                                    history.Balance = (details.Balance + qty);
                                    history.Price = details.Price;
                                    history.CostPrice = entity.CostPrice;
                                    history.LastPriceInBaseUnit = lastPrice;
                                    history.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    history.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _distributionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                        //return;

                        #region history
                        var history = itemHistory.AddNew();
                        history.TransactionNo = entity.TransactionNo;
                        history.LocationID = locationID;
                        history.ItemID = entity.ItemID;
                        history.ReferenceNo = entity.TransactionNo;
                        history.BalanceDate = Utils.NowAtSqlServer();
                        history.Balance = resultQty;
                        history.Price = entity.Price;
                        history.CostPrice = entity.CostPrice;
                        history.LastPriceInBaseUnit = lastPrice;
                        history.LastUpdateDateTime = Utils.NowAtSqlServer();
                        history.LastUpdateByUserID = userID;
                        #endregion

                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _distributionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _distributionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else
                {
                    // FEFO (ItemBalanceDetailEd)
                    if (isControlEd)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                            if (details.Balance >= resultQty)
                            {
                                #region balance detail ed 
                                details.Balance -= resultQty;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _distributionCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = itemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }
                            else
                            {
                                decimal? qty = resultQty; // 5
                                int i = 0;
                                while (qty > 0)
                                {
                                    if (i == 0)
                                        qty = resultQty - details.Balance; // 5 - 2
                                    else
                                        qty -= details.Balance;

                                    if (qty > 0)
                                    {
                                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _distributionCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                        movement.QuantityOut = details.Balance;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = itemUnit;
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;

                                        var initialStock = movement.InitialStock - movement.QuantityOut;
                                        #endregion

                                        #region balance detail (fefo)
                                        details.Balance = 0;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        // re-query
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                         .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                        }
                                        catch (Exception)
                                        {
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _distributionCode;
                                                movement.TransactionNo = entity.TransactionNo;
                                                movement.SequenceNo = entity.SequenceNo;
                                                movement.ItemID = entity.ItemID;
                                                movement.ExpiredDate = details.ExpiredDate;
                                                movement.BatchNumber = details.BatchNumber;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = itemUnit;
                                                movement.CostPrice = entity.CostPrice;
                                                movement.SalesPrice = 0;
                                                movement.PurchasePrice = price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fefo)
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                qty = 0;
                                            }
                                            catch (Exception)
                                            {
                                                itemNoStock = item.ItemName + " [Item Balance Expired Detail]";
                                                return;
                                            }
                                        }
                                    }
                                    else
                                    {

                                        #region balance detail ed (fefo)
                                        var bal = details.Balance;
                                        details.Balance -= (details.Balance + qty);
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _distributionCode;
                                        movement.TransactionNo = entity.TransactionNo;
                                        movement.SequenceNo = entity.SequenceNo;
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                        movement.QuantityOut = bal + qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = itemUnit;
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = 0;
                                        movement.PurchasePrice = price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion
                                    }

                                    i++;
                                }
                            }
                        }
                        catch (Exception)
                        {
                            try
                            {
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _distributionCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = itemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fefo)
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion
                            }
                            catch (Exception)
                            {
                                itemNoStock = item.ItemName + " [Item Balance Expired Detail]";
                                return;
                            }
                        }
                    }
                    else
                    {
                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer();
                        movement.ServiceUnitID = serviceUnitID;
                        movement.LocationID = locationID;
                        movement.TransactionCode = _distributionCode;
                        movement.TransactionNo = entity.TransactionNo;
                        movement.SequenceNo = entity.SequenceNo;
                        movement.ItemID = entity.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.BatchNumber = string.Empty;
                        movement.InitialStock = balance.Balance + resultQty;
                        movement.QuantityOut = resultQty;
                        movement.QuantityIn = 0;
                        movement.SRItemUnit = itemUnit;
                        movement.CostPrice = entity.CostPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = price;
                        movement.LastPriceInBaseUnit = lastPrice;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion
                    }

                }
            }

            if (isAutoClosedDistReq == "No")
            {
                if (string.IsNullOrEmpty(referenceNo))
                {
                    reference.LoadByPrimaryKey(referenceNo);
                    reference.IsClosed = referenceItems.Count(r => r.IsClosed ?? false) == referenceItems.Count();
                    if (reference.IsClosed ?? false)
                    {
                        reference.LastUpdateDateTime = Utils.NowAtSqlServer();
                        reference.LastUpdateByUserID = userID;
                    }
                }
                else
                    reference = null;
            }
        }


        public static void PrepareItemBalancesForDistribution(ItemTransactionItemCollection coll, ItemTransaction header,
            string userID, ref ItemTransaction reference, ref ItemTransactionItemCollection referenceItems, ref ItemBalanceCollection itemBalance,
            ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            var mvms = new ItemMovementCollection();
            mvms.Query.Where(mvms.Query.TransactionNo == header.TransactionNo);
            mvms.LoadAll();
            if (mvms.Count > 0)
            {
                reference = null;
                referenceItems = null;

                return;
            }

            referenceItems.Query.Where(
                referenceItems.Query.TransactionNo == header.ReferenceNo &&
                referenceItems.Query.IsClosed == false
                );
            referenceItems.LoadAll();

            foreach (var item in coll)
            {
                var refs = referenceItems.SingleOrDefault(r => r.SequenceNo == item.ReferenceSequenceNo);
                if (refs != null)
                {
                    if (item.Quantity == refs.Quantity)
                    {
                        refs.IsClosed = true;
                        refs.LastUpdateDateTime = Utils.NowAtSqlServer();
                        refs.LastUpdateByUserID = userID;
                    }
                }
            }

            if (reference.LoadByPrimaryKey(header.ReferenceNo))
            {
                var closed = false;
                foreach (var refs in referenceItems)
                {
                    if (!(refs.IsClosed ?? false))
                    {
                        closed = false;
                        break;
                    }
                    closed = refs.IsClosed ?? false;
                }

                if (closed)
                {
                    reference.IsClosed = closed;
                    reference.LastUpdateDateTime = Utils.NowAtSqlServer();
                    reference.LastUpdateByUserID = userID;
                }
            }

            //balance
            itemBalance.Query.Where
            (
                itemBalance.Query.LocationID == header.FromLocationID,
                itemBalance.Query.ItemID.In(items)
            );
            itemBalance.LoadAll();

            if (isEnabledStockWithEdControl)
            {
                itemBalanceDetailEds.Query.Where
                    (
                        itemBalanceDetailEds.Query.LocationID == header.FromLocationID,
                        itemBalanceDetailEds.Query.ItemID.In(items)
                    );
                itemBalanceDetailEds.LoadAll();
            }

            decimal? costPrice = 0;

            foreach (var item in coll)
            {
                string itemUnit = string.Empty;

                var i = new Item();
                i.LoadByPrimaryKey(item.ItemID);
                switch (i.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        costPrice = med.CostPrice;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        costPrice = nmed.CostPrice;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        costPrice = kitc.CostPrice;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        break;
                }

                var balance = itemBalance.SingleOrDefault(ib => ib.ItemID == item.ItemID);
                if (balance != null)
                {
                    #region balance
                    balance.Balance += Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking -= Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    if (balance.Booking < 0)
                        balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }
                else
                {
                    #region balance
                    balance = itemBalance.AddNew();
                    balance.LocationID = header.FromLocationID;
                    balance.ItemID = item.ItemID;
                    balance.ReorderType = string.Empty;
                    balance.Minimum = 0;
                    balance.Maximum = 0;
                    balance.Balance = Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }

                //decimal qty = Math.Abs((item.Quantity * item.ConversionFactor) ?? 0);
                if (!isEnabledStockWithEdControl)
                {
                    itemBalanceDetailEds = null;

                    var history = new ItemTransactionItemHistoryCollection();
                    history.Query.Where(
                        history.Query.TransactionNo == header.ReferenceNo &&
                        history.Query.ItemID == item.ItemID
                        );
                    history.LoadAll();

                    int idx = 0;

                    foreach (var hist in history)
                    {
                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                        decimal? prev = 0;
                        if (mvm == null)
                        {
                            var mov = new ItemMovement();
                            mov.Query.es.Top = 1;
                            mov.Query.Where(
                                mov.Query.LocationID == header.FromLocationID &&
                                mov.Query.ItemID == item.ItemID
                                );
                            mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                            prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                        }
                        else
                            prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                        movement.ServiceUnitID = header.FromServiceUnitID;
                        movement.LocationID = header.FromLocationID;
                        movement.TransactionCode = header.TransactionCode;
                        movement.TransactionNo = header.TransactionNo;
                        movement.SequenceNo = item.SequenceNo;
                        movement.ItemID = item.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.InitialStock = prev;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = hist.Balance;
                        movement.SRItemUnit = itemUnit;
                        // TODO: cek data costprice ambil dari mana??
                        //movement.CostPrice = hist.CostPrice;
                        movement.CostPrice = costPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = hist.Price;
                        movement.LastPriceInBaseUnit = hist.LastPriceInBaseUnit;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail (fifo)
                        var details = itemBalanceDetails.AddNew();
                        details.LocationID = header.FromLocationID;
                        details.ItemID = item.ItemID;
                        details.ReferenceNo = header.TransactionNo;
                        details.TransactionCode = header.TransactionCode;
                        details.Balance = hist.Balance;
                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);// .AddMilliseconds(10 * idx); 
                        details.Booking = 0;
                        details.Price = hist.Price;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        details.PurchaseReceiveNo = hist.ReferenceNo;
                        #endregion

                        idx++;
                    }
                }
                else
                {
                    itemBalanceDetails = null;

                    var history = new ItemMovementCollection();
                    history.Query.Where(
                        history.Query.TransactionNo == header.ReferenceNo &&
                        history.Query.ItemID == item.ItemID
                        );
                    history.LoadAll();

                    int idx = 0;

                    foreach (var hist in history)
                    {
                        DateTime expiredDate;
                        string batchNumber;

                        if (hist.ExpiredDate == null)
                        {
                            var ibedq = new ItemBalanceDetailEdQuery();
                            ibedq.Where(ibedq.LocationID == header.FromLocationID, ibedq.ItemID == item.ItemID, ibedq.IsActive == true);
                            ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                            ibedq.es.Top = 1;
                            var ibed = new ItemBalanceDetailEd();
                            if (ibed.Load(ibedq))
                            {
                                expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                batchNumber = ibed.BatchNumber;
                            }
                            else
                            {
                                expiredDate = Convert.ToDateTime("1/1/2999");
                                batchNumber = "-N/A-";
                            }
                        }
                        else
                        {
                            expiredDate = Convert.ToDateTime(hist.ExpiredDate);
                            batchNumber = hist.BatchNumber;
                        }

                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                        decimal? prev = 0;
                        if (mvm == null)
                        {
                            var mov = new ItemMovement();
                            mov.Query.es.Top = 1;
                            mov.Query.Where(
                                mov.Query.LocationID == header.FromLocationID &&
                                mov.Query.ItemID == item.ItemID
                                );
                            mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                            prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                        }
                        else
                            prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                        movement.ServiceUnitID = header.FromServiceUnitID;
                        movement.LocationID = header.FromLocationID;
                        movement.TransactionCode = header.TransactionCode;
                        movement.TransactionNo = header.TransactionNo;
                        movement.SequenceNo = item.SequenceNo;
                        movement.ItemID = item.ItemID;
                        movement.ExpiredDate = expiredDate;
                        movement.BatchNumber = batchNumber;
                        movement.InitialStock = prev;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = hist.QuantityOut;
                        movement.SRItemUnit = itemUnit;
                        movement.CostPrice = hist.CostPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = hist.PurchasePrice;
                        movement.LastPriceInBaseUnit = hist.LastPriceInBaseUnit;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail ed (fefo)
                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == header.FromLocationID && im.ItemID == item.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                                .OrderBy(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                        if (details == null)
                        {
                            details = itemBalanceDetailEds.AddNew();
                            details.LocationID = header.FromLocationID;
                            details.ItemID = item.ItemID;
                            details.ExpiredDate = movement.ExpiredDate;
                            details.BatchNumber = movement.BatchNumber;
                            details.Balance = hist.QuantityOut;
                            details.ST = string.Empty;
                            details.IsActive = true;
                            details.CreatedDateTime = Utils.NowAtSqlServer();
                            details.CreatedByUserID = userID;
                        }
                        else
                        {
                            if (details.Balance < 0)
                                details.Balance = hist.QuantityOut;
                            else
                                details.Balance += hist.QuantityOut;
                            details.IsActive = true;
                        }

                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;

                        #endregion

                        idx++;
                    }
                }
            }
        }

        public static void PrepareItemBalancesForAutoDistribution(ItemTransactionItemCollection coll, ItemTransaction header,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemMovementCollection itemMovementsFrom, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
            (
                itemBalance.Query.LocationID == header.ToLocationID,
                itemBalance.Query.ItemID.In(items)
            );
            itemBalance.LoadAll();

            decimal? costPrice = 0;

            foreach (var item in coll)
            {
                string itemUnit = string.Empty;

                var i = new Item();
                i.LoadByPrimaryKey(item.ItemID);

                switch (i.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        costPrice = med.CostPrice;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        costPrice = nmed.CostPrice;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        costPrice = kitc.CostPrice;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        break;
                }

                var balance = itemBalance.SingleOrDefault(ib => ib.ItemID == item.ItemID);
                if (balance != null)
                {
                    #region balance
                    balance.Balance += Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking -= Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    if (balance.Booking < 0)
                        balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }
                else
                {
                    #region balance
                    balance = itemBalance.AddNew();
                    balance.LocationID = header.ToLocationID;
                    balance.ItemID = item.ItemID;
                    balance.ReorderType = string.Empty;
                    balance.Minimum = 0;
                    balance.Maximum = 0;
                    balance.Balance = Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }

                //decimal qty = Math.Abs((item.Quantity * item.ConversionFactor) ?? 0);

                if (!isEnabledStockWithEdControl)
                {
                    itemBalanceDetailEds = null;

                    var history = new ItemTransactionItemHistoryCollection();
                    history.Query.Where(
                        history.Query.TransactionNo == header.TransactionNo &&
                        history.Query.ItemID == item.ItemID
                        );
                    history.LoadAll();

                    int idx = 0;

                    foreach (var hist in history)
                    {
                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                        decimal? prev = 0;
                        if (mvm == null)
                        {
                            var mov = new ItemMovement();
                            mov.Query.es.Top = 1;
                            mov.Query.Where(
                                mov.Query.LocationID == header.ToLocationID &&
                                mov.Query.ItemID == item.ItemID
                                );
                            mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                            prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                        }
                        else
                            prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                        movement.ServiceUnitID = header.ToServiceUnitID;
                        movement.LocationID = header.ToLocationID;
                        movement.TransactionCode = BusinessObject.Reference.TransactionCode.DistributionConfirm;
                        movement.TransactionNo = header.TransactionNo;
                        movement.SequenceNo = item.SequenceNo;
                        movement.ItemID = item.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.InitialStock = prev;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = hist.Balance;
                        movement.SRItemUnit = itemUnit;
                        // TODO: cek data costprice ambil dari mana?
                        //movement.CostPrice = hist.CostPrice;
                        movement.CostPrice = costPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = hist.Price;
                        movement.LastPriceInBaseUnit = hist.LastPriceInBaseUnit;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail (fifo)
                        var details = itemBalanceDetails.AddNew();
                        details.LocationID = header.ToLocationID;
                        details.ItemID = item.ItemID;
                        details.ReferenceNo = header.TransactionNo;
                        details.TransactionCode = BusinessObject.Reference.TransactionCode.DistributionConfirm;
                        details.Balance = hist.Balance;
                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                        details.Booking = 0;
                        details.Price = hist.Price;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        details.PurchaseReceiveNo = hist.ReferenceNo;
                        #endregion

                        idx++;
                    }
                }
                else
                {
                    itemBalanceDetails = null;

                    var mvmFrom = (itemMovementsFrom.Where(im => im.ItemID == item.ItemID)
                                                .OrderBy(im => im.MovementDate).OrderBy(im => im.LastUpdateDateTime));

                    int idx = 0;

                    foreach (var hist in mvmFrom)
                    {
                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                        decimal? prev = 0;
                        if (mvm == null)
                        {
                            var mov = new ItemMovement();
                            mov.Query.es.Top = 1;
                            mov.Query.Where(
                                mov.Query.LocationID == header.ToLocationID &&
                                mov.Query.ItemID == item.ItemID
                                );
                            mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                            prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                        }
                        else
                            prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                        movement.ServiceUnitID = header.ToServiceUnitID;
                        movement.LocationID = header.ToLocationID;
                        movement.TransactionCode = BusinessObject.Reference.TransactionCode.DistributionConfirm;
                        movement.TransactionNo = header.TransactionNo;
                        movement.SequenceNo = item.SequenceNo;
                        movement.ItemID = item.ItemID;
                        movement.ExpiredDate = hist.ExpiredDate;
                        movement.BatchNumber = hist.BatchNumber;
                        movement.InitialStock = prev;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = hist.QuantityOut;
                        movement.SRItemUnit = itemUnit;
                        movement.CostPrice = hist.CostPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = hist.PurchasePrice;
                        movement.LastPriceInBaseUnit = hist.LastPriceInBaseUnit;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail ed (fefo)
                        var details = (itemBalanceDetailEds.Where(im => im.LocationID == header.ToLocationID && im.ItemID == item.ItemID && im.ExpiredDate == hist.ExpiredDate && im.BatchNumber.ToLower() == hist.BatchNumber.ToLower())
                                                .OrderBy(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                        if (details == null)
                        {
                            details = itemBalanceDetailEds.AddNew();
                            details.LocationID = header.ToLocationID;
                            details.ItemID = item.ItemID;
                            details.ExpiredDate = hist.ExpiredDate;
                            details.BatchNumber = hist.BatchNumber;
                            details.Balance = hist.QuantityOut;
                            details.ST = string.Empty;
                            details.IsActive = true;
                            details.CreatedDateTime = Utils.NowAtSqlServer();
                            details.CreatedByUserID = userID;
                        }
                        else
                        {
                            if (details.Balance < 0)
                                details.Balance = hist.QuantityOut;
                            else
                                details.Balance += hist.QuantityOut;
                            details.IsActive = true;
                        }

                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        #endregion

                        idx++;
                    }
                }
            }
        }

        public static void PrepareItemBalancesForDestructionOfExpiredItems(ItemTransaction it, ItemTransactionItemCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                //,
                //itemBalanceDetails.Query.Balance > 0
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "x|-Item Balance Detail-";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail ed
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items), itemBalanceDetailEds.Query.IsActive == true
                );
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "x|-Item Balance Detail Exipred-";
                //    return;
                //}

                itemBalanceDetails = null;
            }

            foreach (ItemTransactionItem entity in coll)
            {
                decimal? resultQty = entity.Quantity * entity.ConversionFactor;
                decimal price = 0;
                decimal lastPrice = 0;
                decimal discPctg = 0;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        discPctg = med.PurchaseDiscount1 ?? 0;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        discPctg = nmed.PurchaseDiscount1 ?? 0;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        discPctg = kitc.PurchaseDiscount1 ?? 0;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;
                        break;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0 && discPctg < 100)
                {
                    itemNoStock = "Zero|" + item.ItemName;
                    return;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                if (balance.Balance < resultQty)
                {
                    itemNoStock = item.ItemName;
                    return;
                }

                balance.Balance -= resultQty;

                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                // balance detail (fifo) and movement

                if (!isEnabledStockWithEdControl)
                {
                    //db:20231219 - override jika tidak ada
                    //// cek balance detail
                    //var ibds = new ItemBalanceDetailCollection();
                    //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == entity.ItemID, ibds.Query.Balance > 0);
                    //ibds.LoadAll();

                    //if (ibds.Count == 0)
                    //{
                    //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                    //    return;
                    //}

                    try
                    {
                        // query
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                // mark if using average
                                //if (parCostType != "AVG")
                                //{
                                //    entity.Price = details.Price;
                                //    entity.CostPrice = details.Price;
                                //}

                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                        //return;
                                        ////throw;
                                        ///
                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = it.TransactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = it.TransactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else
                {
                    // query
                    try
                    {
                        var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {

                            #region balance detail (fefo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;

                                    var initialStock = movement.InitialStock - movement.QuantityOut;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = it.TransactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.Price;
                                            movement.PurchasePrice = entity.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                            return;
                                        }
                                    }
                                }
                                else
                                {
                                    #region balance detail (fefo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = it.TransactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = it.TransactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = entity.SRItemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = entity.Price;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fefo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateByUserID = userID;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            #endregion
                        }
                        catch (Exception)
                        {
                            itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                            return;
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForWorkOrderRealization(AssetWorkOrder it, IEnumerable<AssetWorkOrderItem> coll, string serviceUnitID, string locationID,
           string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
           ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
            {
                itemNoStock = "x|Item Balance";

                return;
            }


            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "x|Item Balance Detail";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items), itemBalanceDetailEds.Query.IsActive == true
                );
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "x|Item Balance Detail Expired";
                //    return;
                //}

                itemBalanceDetails = null;
            }

            if (items.Count() != coll.Count())
            {
                var collTemp = new AssetWorkOrderItemCollection();
                var query = new AssetWorkOrderItemQuery("a");
                query.Where(query.OrderNo == it.OrderNo);
                query.Select(
                    query.OrderNo,
                    query.ItemID,
                    @"<SUM(a.QuantityRealization * a.ConversionFactor) AS QuantityRealization>",
                    query.CostPrice,
                    query.Price
                    );
                query.GroupBy(
                    query.OrderNo,
                    query.ItemID,
                    query.CostPrice,
                    query.Price
                    );
                collTemp.Load(query);

                var collTemp2 = new AssetWorkOrderItemCollection();
                foreach (var temp in collTemp)
                {
                    decimal? resultQty = temp.QuantityRealization;
                    decimal lastPrice = 0;
                    decimal price = 0;

                    if (resultQty > 0)
                    {
                        var temp2 = collTemp2.AddNew();
                        temp2.ItemID = temp.ItemID;

                        var item = new Item();
                        item.LoadByPrimaryKey(temp.ItemID);
                        switch (item.SRItemType)
                        {
                            case Reference.ItemType.Medical:
                                var med = new ItemProductMedic();
                                med.LoadByPrimaryKey(item.ItemID);
                                temp2.CostPrice = med.CostPrice;
                                temp2.SRItemUnit = med.SRItemUnit;
                                lastPrice = med.LastPriceInBaseUnit ?? 0;
                                price = med.PriceInBaseUnit ?? 0;

                                if (!med.IsInventoryItem ?? false)
                                    continue;

                                break;
                            case Reference.ItemType.NonMedical:
                                var nmed = new ItemProductNonMedic();
                                nmed.LoadByPrimaryKey(item.ItemID);
                                temp2.CostPrice = nmed.CostPrice;
                                temp2.SRItemUnit = nmed.SRItemUnit;
                                lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                                price = nmed.PriceInBaseUnit ?? 0;

                                if (!nmed.IsInventoryItem ?? false)
                                    continue;
                                break;
                            case Reference.ItemType.Kitchen:
                                var kitc = new ItemKitchen();
                                kitc.LoadByPrimaryKey(item.ItemID);
                                temp2.CostPrice = kitc.CostPrice;
                                temp2.SRItemUnit = kitc.SRItemUnit;
                                lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                                price = kitc.PriceInBaseUnit ?? 0;

                                if (!kitc.IsInventoryItem ?? false)
                                    continue;
                                break;
                        }

                        #region balance
                        var balance = itemBalance.FindByPrimaryKey(locationID, temp.ItemID);

                        if (balance.Balance < resultQty)
                        {
                            itemNoStock = item.ItemName;
                            return;
                        }

                        balance.Balance -= resultQty;

                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                        balance.LastUpdateByUserID = userID;
                        #endregion

                        if (!isEnabledStockWithEdControl)
                        {
                            // balance detail (fifo) and movement

                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == temp.ItemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                // query
                                var details = (itemBalanceDetails.Where(b => b.ItemID == temp.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG")
                                    //    temp.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = temp.OrderNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = temp.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = temp2.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG")
                                        //{
                                        //    temp.CostPrice = details.Price;
                                        //}

                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = temp.OrderNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = temp.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = temp2.SRItemUnit;
                                            movement.CostPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                            movement.SalesPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == temp.ItemID && b.Balance > 0)
                                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                                //return;
                                                ////throw;
                                                ///
                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == temp.ItemID)
                                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                                    movement.TransactionNo = temp.OrderNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = temp.ItemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = temp2.SRItemUnit;
                                                    movement.CostPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                                    movement.SalesPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                                    movement.TransactionNo = temp.OrderNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = temp.ItemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = temp2.SRItemUnit;
                                                    movement.CostPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                                    movement.SalesPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = temp.ItemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = temp.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = temp.OrderNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = temp.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = temp2.SRItemUnit;
                                            movement.CostPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                            movement.SalesPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == temp.ItemID)
                                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = temp.OrderNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = temp.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = temp2.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = temp.OrderNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = temp.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = temp2.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.SalesPrice = temp2.CostPrice; // (parCostType == "AVG") ? temp2.CostPrice : details.Price;
                                    movement.PurchasePrice = temp2.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = temp.ItemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = temp2.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                        else
                        {
                            // balance detail (fefo) and movement

                            // query
                            try
                            {
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == temp.ItemID && b.Balance > 0)
                                                             .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = temp.OrderNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = temp.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = temp2.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice;
                                    movement.SalesPrice = temp2.CostPrice;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = temp.OrderNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = temp.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = temp2.SRItemUnit;
                                            movement.CostPrice = temp.CostPrice;
                                            movement.SalesPrice = temp.CostPrice;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == temp.ItemID && b.Balance > 0)
                                                                         .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == temp.ItemID)
                                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                                    movement.TransactionNo = temp.OrderNo;
                                                    movement.SequenceNo = "000";
                                                    movement.ItemID = temp.ItemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = temp2.SRItemUnit;
                                                    movement.CostPrice = temp.CostPrice;
                                                    movement.SalesPrice = temp.CostPrice;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                                    return;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = temp.OrderNo;
                                            movement.SequenceNo = "000";
                                            movement.ItemID = temp.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = temp2.SRItemUnit;
                                            movement.CostPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                            movement.SalesPrice = temp.CostPrice; // (parCostType == "AVG") ? temp.CostPrice : details.Price;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == temp.ItemID)
                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = temp.OrderNo;
                                    movement.SequenceNo = "000";
                                    movement.ItemID = temp.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = temp2.SRItemUnit;
                                    movement.CostPrice = temp2.CostPrice;
                                    movement.SalesPrice = temp2.CostPrice;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                    return;
                                }
                            }
                        }
                    }
                }
                foreach (var entity in coll)
                {
                    try
                    {
                        var temp2 = (collTemp2.Where(b => b.ItemID == entity.ItemID).Take(1).Single());
                        entity.CostPrice = temp2.CostPrice;
                    }
                    catch (Exception)
                    {
                        //throw;
                    }

                }
            }
            else
            {
                foreach (AssetWorkOrderItem entity in coll)
                {
                    decimal? resultQty = entity.QuantityRealization * entity.ConversionFactor;
                    decimal lastPrice = 0;
                    decimal price = 0;
                    if (resultQty > 0)
                    {
                        var item = new Item();
                        item.LoadByPrimaryKey(entity.ItemID);
                        switch (item.SRItemType)
                        {
                            case Reference.ItemType.Medical:
                                var med = new ItemProductMedic();
                                med.LoadByPrimaryKey(item.ItemID);
                                entity.CostPrice = med.CostPrice;
                                lastPrice = med.LastPriceInBaseUnit ?? 0;
                                price = med.PriceInBaseUnit ?? 0;

                                if (!med.IsInventoryItem ?? false)
                                    continue;

                                break;
                            case Reference.ItemType.NonMedical:
                                var nmed = new ItemProductNonMedic();
                                nmed.LoadByPrimaryKey(item.ItemID);
                                entity.CostPrice = nmed.CostPrice;
                                lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                                price = nmed.PriceInBaseUnit ?? 0;

                                if (!nmed.IsInventoryItem ?? false)
                                    continue;
                                break;
                            case Reference.ItemType.Kitchen:
                                var kitc = new ItemKitchen();
                                kitc.LoadByPrimaryKey(item.ItemID);
                                entity.CostPrice = kitc.CostPrice;
                                lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                                price = kitc.PriceInBaseUnit ?? 0;

                                if (!kitc.IsInventoryItem ?? false)
                                    continue;
                                break;
                        }

                        #region balance
                        var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                        if (balance.Balance < resultQty)
                        {
                            itemNoStock = item.ItemName;
                            return;
                        }

                        balance.Balance -= resultQty;

                        balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                        balance.LastUpdateByUserID = userID;
                        #endregion


                        if (!isEnabledStockWithEdControl)
                        {
                            // balance detail (fifo) and movement

                            //db:20231219 - override jika tidak ada
                            //// cek balance detail
                            //var ibds = new ItemBalanceDetailCollection();
                            //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == entity.ItemID, ibds.Query.Balance > 0);
                            //ibds.LoadAll();

                            //if (ibds.Count == 0)
                            //{
                            //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                            //    return;
                            //}

                            try
                            {
                                // query
                                var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.BalanceDate)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG")
                                    //    entity.CostPrice = details.Price;

                                    #region balance detail (fifo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = entity.OrderNo;
                                    movement.SequenceNo = entity.SeqNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        // mark if using average
                                        //if (parCostType != "AVG")
                                        //{
                                        //    entity.CostPrice = details.Price;
                                        //}

                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = entity.OrderNo;
                                            movement.SequenceNo = entity.SeqNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            var initialStock = movement.InitialStock - movement.QuantityOut;

                                            #region balance detail (fifo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                         .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                                //return;
                                                ////throw;
                                                ///
                                                try
                                                {
                                                    details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                         .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                                    movement.TransactionNo = entity.OrderNo;
                                                    movement.SequenceNo = entity.SeqNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.PurchasePrice = details.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                                    movement.TransactionNo = entity.OrderNo;
                                                    movement.SequenceNo = entity.SeqNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.str.ExpiredDate = string.Empty;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice; // parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                    movement.PurchasePrice = entity.Price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fifo)
                                                    details = itemBalanceDetails.AddNew();
                                                    details.LocationID = locationID;
                                                    details.ItemID = entity.ItemID;
                                                    details.ReferenceNo = string.Empty;
                                                    details.TransactionCode = string.Empty;
                                                    details.BalanceDate = Utils.NowAtSqlServer();
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.Booking = 0;
                                                    details.Price = entity.CostPrice;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    details.LastUpdateByUserID = userID;
                                                    details.PurchaseReceiveNo = string.Empty;
                                                    #endregion

                                                    qty = 0;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fifo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = entity.OrderNo;
                                            movement.SequenceNo = entity.SeqNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                 .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = entity.OrderNo;
                                    movement.SequenceNo = entity.SeqNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = entity.OrderNo;
                                    movement.SequenceNo = entity.SeqNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.PurchasePrice = entity.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var details = itemBalanceDetails.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = entity.ItemID;
                                    details.ReferenceNo = string.Empty;
                                    details.TransactionCode = string.Empty;
                                    details.BalanceDate = Utils.NowAtSqlServer();
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.Booking = 0;
                                    details.Price = entity.CostPrice;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    details.PurchaseReceiveNo = string.Empty;
                                    #endregion
                                }
                            }
                        }
                        else
                        {
                            // balance detail ed (fefo) and movement
                            try
                            {
                                // query
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                 .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                                if (details.Balance >= resultQty)
                                {
                                    #region balance detail (fefo)
                                    details.Balance -= resultQty;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    details.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = entity.OrderNo;
                                    movement.SequenceNo = entity.SeqNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.CostPrice;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }
                                else
                                {
                                    decimal? qty = resultQty; // 5
                                    int i = 0;
                                    while (qty > 0)
                                    {
                                        if (i == 0)
                                            qty = resultQty - details.Balance; // 5 - 2
                                        else
                                            qty -= details.Balance;

                                        if (qty > 0)
                                        {
                                            var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                    .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = entity.OrderNo;
                                            movement.SequenceNo = entity.SeqNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                            movement.QuantityOut = details.Balance;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.CostPrice;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;

                                            var initialStock = movement.InitialStock - movement.QuantityOut;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = 0;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            // re-query
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                         .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                            }
                                            catch (Exception)
                                            {
                                                try
                                                {
                                                    details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                    #region movement
                                                    movement = itemMovements.AddNew();
                                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                    movement.ServiceUnitID = serviceUnitID;
                                                    movement.LocationID = locationID;
                                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                                    movement.TransactionNo = entity.OrderNo;
                                                    movement.SequenceNo = entity.SeqNo;
                                                    movement.ItemID = entity.ItemID;
                                                    movement.ExpiredDate = details.ExpiredDate;
                                                    movement.BatchNumber = details.BatchNumber;
                                                    movement.InitialStock = initialStock;
                                                    movement.QuantityOut = qty;
                                                    movement.QuantityIn = 0;
                                                    movement.SRItemUnit = entity.SRItemUnit;
                                                    movement.CostPrice = entity.CostPrice;
                                                    movement.SalesPrice = entity.CostPrice;
                                                    movement.PurchasePrice = price;
                                                    movement.LastPriceInBaseUnit = lastPrice;
                                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    movement.LastUpdateByUserID = userID;
                                                    #endregion

                                                    #region balance detail (fefo)
                                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                                    details.LastUpdateByUserID = userID;
                                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                    #endregion

                                                    qty = 0;
                                                }
                                                catch (Exception)
                                                {
                                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                                    return;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            #region balance detail (fefo)
                                            var bal = details.Balance;
                                            details.Balance -= (details.Balance + qty);
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            #region movement
                                            var movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _assetWorkOrderRealizationCode;
                                            movement.TransactionNo = entity.OrderNo;
                                            movement.SequenceNo = entity.SeqNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                            movement.QuantityOut = bal + qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = entity.SRItemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = entity.CostPrice;
                                            movement.PurchasePrice = price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion
                                        }

                                        i++;
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                try
                                {
                                    var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                             .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer();
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _assetWorkOrderRealizationCode;
                                    movement.TransactionNo = entity.OrderNo;
                                    movement.SequenceNo = entity.SeqNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = balance.Balance + resultQty;
                                    movement.QuantityOut = resultQty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = entity.SRItemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = entity.CostPrice;
                                    movement.PurchasePrice = price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = movement.InitialStock - movement.QuantityOut;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion
                                }
                                catch (Exception)
                                {
                                    itemNoStock = item.ItemName + " [Item Balance Detail Expired]";
                                    return;
                                }
                            }
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForConsignmentTransfer(ItemTransactionItemCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements,
            ref ItemTransactionItemHistoryCollection itemHistory, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;
            }
            else
            {
                itemBalanceDetails = null;
                itemHistory = null;
            }

            foreach (var entity in coll)
            {
                decimal? resultQty = entity.Quantity * entity.ConversionFactor;
                string itemUnit = string.Empty;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                decimal price = 0;
                decimal lastPrice = 0;
                decimal discPctg = 0;
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        price = med.PriceInBaseUnit ?? 0;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;
                        discPctg = med.PurchaseDiscount1 ?? 0;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        price = nmed.PriceInBaseUnit ?? 0;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;
                        discPctg = nmed.PurchaseDiscount1 ?? 0;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        price = kitc.PriceInBaseUnit ?? 0;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;
                        discPctg = kitc.PurchaseDiscount1 ?? 0;
                        break;
                }

                if ((entity.CostPrice ?? 0) == 0 && price > 0 && discPctg < 100)
                {
                    itemNoStock = "Zero|" + item.ItemName;
                    return;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                if (balance.Balance < resultQty)
                {
                    itemNoStock = item.ItemName;
                    return;
                }

                balance.Balance -= resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                if (!isEnabledStockWithEdControl)
                {
                    //db:20231219 - override jika tidak ada
                    //// cek balance detail
                    //var ibds = new ItemBalanceDetailCollection();
                    //ibds.Query.Where(
                    //    ibds.Query.LocationID == locationID,
                    //    ibds.Query.ItemID == item.ItemID,
                    //    ibds.Query.Balance > 0
                    //    );
                    //ibds.LoadAll();

                    //if (ibds.Count == 0)
                    //{
                    //    itemNoStock = item.ItemName + " [Item Balance Detail]";
                    //    return;
                    //}

                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            #region history
                            var history = itemHistory.AddNew();
                            history.TransactionNo = entity.TransactionNo;
                            history.LocationID = details.LocationID;
                            history.ItemID = details.ItemID;
                            history.ReferenceNo = details.PurchaseReceiveNo ?? (string.IsNullOrEmpty(details.ReferenceNo) ? entity.TransactionNo : details.ReferenceNo);
                            history.BalanceDate = details.BalanceDate;
                            history.Balance = resultQty;
                            history.Price = details.Price;
                            history.CostPrice = entity.CostPrice;
                            history.LastPriceInBaseUnit = lastPrice;
                            history.LastUpdateDateTime = Utils.NowAtSqlServer();
                            history.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _consignmentTransferCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region history
                                    var history = itemHistory.AddNew();
                                    history.TransactionNo = entity.TransactionNo;
                                    history.LocationID = details.LocationID;
                                    history.ItemID = details.ItemID;
                                    history.ReferenceNo = details.PurchaseReceiveNo ?? (string.IsNullOrEmpty(details.ReferenceNo) ? entity.TransactionNo : details.ReferenceNo);
                                    history.BalanceDate = details.BalanceDate;
                                    history.Balance = details.Balance;
                                    history.Price = details.Price;
                                    history.CostPrice = entity.CostPrice;
                                    history.LastPriceInBaseUnit = lastPrice;
                                    history.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    history.LastUpdateByUserID = userID;
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _consignmentTransferCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                        //return;

                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _consignmentTransferCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitID;
                                            movement.LocationID = locationID;
                                            movement.TransactionCode = _consignmentTransferCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = entity.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationID;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }
                                }
                                else
                                {
                                    #region history
                                    var history = itemHistory.AddNew();
                                    history.TransactionNo = entity.TransactionNo;
                                    history.LocationID = details.LocationID;
                                    history.ItemID = details.ItemID;
                                    history.ReferenceNo = details.PurchaseReceiveNo ?? (string.IsNullOrEmpty(details.ReferenceNo) ? entity.TransactionNo : details.ReferenceNo);
                                    history.BalanceDate = details.BalanceDate;
                                    history.Balance = (details.Balance + qty);
                                    history.Price = details.Price;
                                    history.CostPrice = entity.CostPrice;
                                    history.LastPriceInBaseUnit = lastPrice;
                                    history.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    history.LastUpdateByUserID = userID;
                                    #endregion

                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitID;
                                    movement.LocationID = locationID;
                                    movement.TransactionCode = _consignmentTransferCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        #region history
                        var history = itemHistory.AddNew();
                        history.TransactionNo = entity.TransactionNo;
                        history.LocationID = locationID;
                        history.ItemID = entity.ItemID;
                        history.ReferenceNo = entity.TransactionNo;
                        history.BalanceDate = Utils.NowAtSqlServer();
                        history.Balance = resultQty;
                        history.Price = entity.Price;
                        history.CostPrice = entity.CostPrice;
                        history.LastPriceInBaseUnit = lastPrice;
                        history.LastUpdateDateTime = Utils.NowAtSqlServer();
                        history.LastUpdateByUserID = userID;
                        #endregion

                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _consignmentTransferCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitID;
                            movement.LocationID = locationID;
                            movement.TransactionCode = _consignmentTransferCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationID;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }

                }
                else
                {
                    #region movement
                    var movement = itemMovements.AddNew();
                    movement.MovementDate = Utils.NowAtSqlServer();
                    movement.ServiceUnitID = serviceUnitID;
                    movement.LocationID = locationID;
                    movement.TransactionCode = _consignmentTransferCode;
                    movement.TransactionNo = entity.TransactionNo;
                    movement.SequenceNo = entity.SequenceNo;
                    movement.ItemID = entity.ItemID;
                    movement.str.ExpiredDate = string.Empty;
                    movement.InitialStock = balance.Balance + resultQty;
                    movement.QuantityOut = resultQty;
                    movement.QuantityIn = 0;
                    movement.SRItemUnit = itemUnit;
                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                    movement.SalesPrice = 0;
                    movement.PurchasePrice = entity.Price;
                    movement.LastPriceInBaseUnit = lastPrice;
                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                    movement.LastUpdateByUserID = userID;
                    #endregion
                }
            }
        }

        public static void PrepareItemBalancesForAutoConsignmentTransfer(ItemTransactionItemCollection coll, ItemTransaction header,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
            (
                itemBalance.Query.LocationID == header.ToLocationID,
                itemBalance.Query.ItemID.In(items)
            );
            itemBalance.LoadAll();

            if (!isEnabledStockWithEdControl)
            {
                itemBalanceDetailEds = null;
            }
            else
            {
                itemBalanceDetailEds = new ItemBalanceDetailEdCollection();
                itemBalanceDetailEds.Query.Where(
                    itemBalanceDetailEds.Query.LocationID == header.ToLocationID,
                    itemBalanceDetailEds.Query.ItemID.In(coll.Select(l => l.ItemID))
                    );
                itemBalanceDetailEds.LoadAll();

                itemBalanceDetails = null;
            }

            decimal? costPrice = 0;

            foreach (var item in coll)
            {
                string itemUnit = string.Empty;

                var i = new Item();
                i.LoadByPrimaryKey(item.ItemID);

                switch (i.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        costPrice = med.CostPrice;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        costPrice = nmed.CostPrice;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        costPrice = kitc.CostPrice;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        break;
                }

                var balance = itemBalance.SingleOrDefault(ib => ib.ItemID == item.ItemID);
                if (balance != null)
                {
                    #region balance
                    balance.Balance += Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }
                else
                {
                    #region balance
                    balance = itemBalance.AddNew();
                    balance.LocationID = header.ToLocationID;
                    balance.ItemID = item.ItemID;
                    balance.ReorderType = string.Empty;
                    balance.Minimum = 0;
                    balance.Maximum = 0;
                    balance.Balance = Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }

                decimal qty = Math.Abs((item.Quantity * item.ConversionFactor) ?? 0);

                if (!isEnabledStockWithEdControl)
                {
                    var history = new ItemTransactionItemHistoryCollection();
                    history.Query.Where(
                        history.Query.TransactionNo == header.TransactionNo &&
                        history.Query.ItemID == item.ItemID
                        );
                    history.LoadAll();

                    int idx = 0;

                    foreach (var hist in history)
                    {
                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                        decimal? prev = 0;
                        if (mvm == null)
                        {
                            var mov = new ItemMovement();
                            mov.Query.es.Top = 1;
                            mov.Query.Where(
                                mov.Query.LocationID == header.ToLocationID &&
                                mov.Query.ItemID == item.ItemID
                                );
                            mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                            prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                        }
                        else
                            prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                        #region movement
                        var movement = itemMovements.AddNew();
                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                        movement.ServiceUnitID = header.ToServiceUnitID;
                        movement.LocationID = header.ToLocationID;
                        movement.TransactionCode = _consignmentTransferCode;
                        movement.TransactionNo = header.TransactionNo;
                        movement.SequenceNo = item.SequenceNo;
                        movement.ItemID = item.ItemID;
                        movement.str.ExpiredDate = string.Empty;
                        movement.InitialStock = prev;
                        movement.QuantityOut = 0;
                        movement.QuantityIn = hist.Balance;
                        movement.SRItemUnit = itemUnit;
                        // TODO: cek data costprice ambil dari mana?
                        //movement.CostPrice = hist.CostPrice;
                        movement.CostPrice = costPrice;
                        movement.SalesPrice = 0;
                        movement.PurchasePrice = hist.Price;
                        movement.LastPriceInBaseUnit = hist.LastPriceInBaseUnit;
                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                        movement.LastUpdateByUserID = userID;
                        #endregion

                        #region balance detail (fifo)
                        var details = itemBalanceDetails.AddNew();
                        details.LocationID = header.ToLocationID;
                        details.ItemID = item.ItemID;
                        details.ReferenceNo = header.TransactionNo;
                        details.TransactionCode = _consignmentTransferCode;
                        details.Balance = hist.Balance;
                        details.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                        details.Booking = 0;
                        details.Price = hist.Price;
                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                        details.LastUpdateByUserID = userID;
                        details.PurchaseReceiveNo = hist.ReferenceNo;
                        #endregion

                        idx++;
                    }
                }
                else
                {
                    int x = 0;
                    decimal initialStock = 0;
                    decimal qtyIn = 0;

                    var itiEds = new ItemTransactionItemEdCollection();
                    itiEds.Query.Where(itiEds.Query.TransactionNo == item.TransactionNo, itiEds.Query.SequenceNo == item.SequenceNo);
                    itiEds.Query.OrderBy(itiEds.Query.ExpiredDate.Ascending, itiEds.Query.LastUpdateDateTime.Ascending);
                    itiEds.LoadAll();

                    foreach (var itiEd in itiEds)
                    {
                        #region ItemMovement

                        var itemMovement = itemMovements.AddNew();
                        itemMovement.MovementDate = header.ApprovedDate.Value.AddMilliseconds(x * 100);
                        itemMovement.ServiceUnitID = header.ToServiceUnitID;
                        itemMovement.LocationID = header.ToLocationID;
                        itemMovement.TransactionCode = _consignmentTransferCode;
                        itemMovement.TransactionNo = header.TransactionNo;
                        itemMovement.SequenceNo = item.SequenceNo;
                        itemMovement.ItemID = item.ItemID;
                        itemMovement.ExpiredDate = itiEd.ExpiredDate;
                        itemMovement.BatchNumber = itiEd.BatchNumber;

                        if (x == 0)
                        {
                            itemMovement.InitialStock = balance.Balance - item.Quantity;

                            initialStock = itemMovement.InitialStock ?? 0;
                        }
                        else
                        {
                            itemMovement.InitialStock = initialStock + qtyIn;
                        }

                        itemMovement.QuantityIn = itiEd.Quantity * itiEd.ConversionFactor;
                        itemMovement.QuantityOut = 0;

                        qtyIn += (itemMovement.QuantityIn ?? 0);

                        itemMovement.SRItemUnit = itemUnit;
                        itemMovement.CostPrice = costPrice;
                        itemMovement.SalesPrice = 0;
                        itemMovement.PurchasePrice = (item.Price / item.ConversionFactor);
                        itemMovement.LastPriceInBaseUnit = (item.Price / item.ConversionFactor);
                        itemMovement.LastUpdateByUserID = userID;
                        itemMovement.LastUpdateDateTime = Utils.NowAtSqlServer();

                        #endregion

                        #region ItemBalanceDetailEd

                        ItemBalanceDetailEd itemBalanceDetailEd = null;
                        var isAvailable = false;
                        foreach (var findBalance in itemBalanceDetailEds.Where(findBalance => findBalance.ItemID.Equals(item.ItemID) &&
                                                                                findBalance.ExpiredDate.Equals(itiEd.ExpiredDate) &&
                                                                                  findBalance.BatchNumber.ToLower().Equals(itiEd.BatchNumber.ToLower())))
                        {
                            isAvailable = true;
                            itemBalanceDetailEd = findBalance;
                            break;
                        }
                        if (!isAvailable)
                        {
                            itemBalanceDetailEd = itemBalanceDetailEds.AddNew();
                            itemBalanceDetailEd.LocationID = header.ToLocationID;
                            itemBalanceDetailEd.ItemID = item.ItemID;
                            itemBalanceDetailEd.ExpiredDate = itiEd.ExpiredDate;
                            itemBalanceDetailEd.BatchNumber = itiEd.BatchNumber;
                            itemBalanceDetailEd.Balance = itiEd.Quantity * itiEd.ConversionFactor;
                            itemBalanceDetailEd.IsActive = true;
                            itemBalanceDetailEd.CreatedDateTime = Utils.NowAtSqlServer();
                            itemBalanceDetailEd.CreatedByUserID = userID;
                        }
                        else
                        {
                            itemBalanceDetailEd.Balance += Convert.ToDecimal(itiEd.Quantity * itiEd.ConversionFactor);
                        }
                        itemBalanceDetailEd.LastUpdateDateTime = Utils.NowAtSqlServer();
                        itemBalanceDetailEd.LastUpdateByUserID = userID;

                        #endregion

                        x += 1;

                    }
                }
            }
        }

        public static void PrepareItemBalancesForMCUCorrection(TransChargesCollection headers, string userID, bool isEnabledStockWithEdControl)
        {
            foreach (var header in headers)
            {
                var coll = new TransChargesItemCollection();
                coll.Query.Where(coll.Query.TransactionNo == header.TransactionNo);
                coll.LoadAll();

                var unit = new ServiceUnit();
                unit.LoadByPrimaryKey(header.ToServiceUnitID);

                var chargesBalances = new ItemBalanceCollection();
                var chargesDetailBalances = new ItemBalanceDetailCollection();
                var chargesDetailBalanceEds = new ItemBalanceDetailEdCollection();
                var chargesMovements = new ItemMovementCollection();

                PrepareItemBalancesForMCUCorrection(coll, header.ToServiceUnitID, unit.GetMainLocationId(unit.ServiceUnitID), userID, ref chargesBalances,
                    ref chargesDetailBalances, ref chargesMovements, ref chargesDetailBalanceEds, isEnabledStockWithEdControl);

                if (chargesBalances != null)
                    chargesBalances.Save();
                if (chargesDetailBalances != null)
                    chargesDetailBalances.Save();
                if (chargesDetailBalanceEds != null)
                    chargesDetailBalanceEds.Save();
                if (chargesMovements != null)
                    chargesMovements.Save();

                var cons = new TransChargesItemConsumptionCollection();
                cons.Query.Where(cons.Query.TransactionNo == header.TransactionNo);
                cons.LoadAll();

                var consumptionBalances = new ItemBalanceCollection();
                var consumptionDetailBalances = new ItemBalanceDetailCollection();
                var consumptionDetailBalanceEds = new ItemBalanceDetailEdCollection();
                var consumptionMovements = new ItemMovementCollection();

                PrepareItemBalancesForMCUCorrection(cons, header.ToServiceUnitID, unit.GetMainLocationId(unit.ServiceUnitID), userID, ref consumptionBalances,
                    ref consumptionDetailBalances, ref consumptionMovements, ref consumptionDetailBalanceEds, isEnabledStockWithEdControl);

                if (consumptionBalances != null)
                    consumptionBalances.Save();
                if (consumptionDetailBalances != null)
                    consumptionDetailBalances.Save();
                if (consumptionDetailBalanceEds != null)
                    consumptionDetailBalanceEds.Save();
                if (consumptionMovements != null)
                    consumptionMovements.Save();
            }
        }

        public static void PrepareItemBalancesForMCUCorrection(TransChargesItemCollection coll, string serviceUnitID, string locationID,
           string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
           ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where(
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Descending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail
                itemBalanceDetailEds.Query.Where(
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items)
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Descending);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //    return;
                itemBalanceDetails = null;
            }

            foreach (var entity in coll)
            {
                // kl detail package maka diskip karena nanti akan dihitung di function PrepareItemBalances-TransChargesItemConsumptions
                var resultQty = entity.StockQuantity;
                decimal purchase;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        purchase = med.PriceInBaseUnit ?? 0;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        purchase = nmed.PriceInBaseUnit ?? 0;
                        break;
                    default:
                        continue;
                }

                var tc = new TransCharges();
                tc.LoadByPrimaryKey(entity.TransactionNo);

                var query = new ItemMovementQuery();
                query.Where(
                    query.TransactionNo == tc.TransactionNo,
                    query.SequenceNo == entity.SequenceNo,
                    query.ItemID == entity.ItemID
                    );
                query.OrderBy(query.MovementDate.Ascending);

                DataTable tbl = query.LoadDataTable();

                var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);
                decimal blc = (balance.Balance ?? 0);//- Math.Abs(resultQty ?? 0);
                decimal qty = Math.Abs(resultQty ?? 0);
                decimal ctr = 0;

                if (!isEnabledStockWithEdControl)
                {
                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (qty > Math.Abs((decimal)row["QuantityOut"]))
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty -= (decimal)movement.QuantityIn;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail (fifo) and movement
                                #region balance detail (fifo)
                                var balanceDetail = itemBalanceDetails.AddNew();
                                balanceDetail.LocationID = locationID;
                                balanceDetail.ItemID = entity.ItemID;
                                balanceDetail.ReferenceNo = entity.TransactionNo;
                                balanceDetail.TransactionCode = _chargesCode;
                                balanceDetail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                balanceDetail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                balanceDetail.Booking = 0;
                                balanceDetail.Price = (decimal)row["CostPrice"];
                                balanceDetail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balanceDetail.LastUpdateByUserID = userID;
                                #endregion

                            }
                            else
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs(qty);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana?
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty = 0;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail (fifo) and movement
                                #region balance detail (fifo)
                                var balanceDetail = itemBalanceDetails.AddNew();
                                balanceDetail.LocationID = locationID;
                                balanceDetail.ItemID = entity.ItemID;
                                balanceDetail.ReferenceNo = entity.TransactionNo;
                                balanceDetail.TransactionCode = _chargesCode;
                                balanceDetail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                balanceDetail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                balanceDetail.Booking = 0;
                                balanceDetail.Price = (decimal)row["CostPrice"];
                                balanceDetail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balanceDetail.LastUpdateByUserID = userID;
                                #endregion
                            }

                        }

                        idx++;
                    }
                }
                else //
                {
                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        DateTime expiredDate;
                        string batchNumber;

                        try
                        {
                            expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                            batchNumber = Convert.ToString(row["BatchNumber"]);
                        }
                        catch (Exception)
                        {
                            var ibedq = new ItemBalanceDetailEdQuery();
                            ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == entity.ItemID, ibedq.IsActive == true);
                            ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                            ibedq.es.Top = 1;
                            var ibed = new ItemBalanceDetailEd();
                            if (ibed.Load(ibedq))
                            {
                                expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                batchNumber = ibed.BatchNumber;
                            }
                            else
                            {
                                expiredDate = Convert.ToDateTime("1/1/2999");
                                batchNumber = "-N/A-";
                            }
                        }

                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (qty > Math.Abs((decimal)row["QuantityOut"]))
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = expiredDate;
                                movement.BatchNumber = batchNumber;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty -= (decimal)movement.QuantityIn;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail ed (fefo) and movement
                                #region balance detail ed (fefo)
                                var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                            .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                if (details == null)
                                {
                                    details = itemBalanceDetailEds.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = entity.ItemID;
                                    details.ExpiredDate = movement.ExpiredDate;
                                    details.BatchNumber = movement.BatchNumber;
                                    details.Balance = movement.QuantityIn;
                                    details.ST = string.Empty;
                                    details.IsActive = true;
                                    details.CreatedDateTime = Utils.NowAtSqlServer();
                                    details.CreatedByUserID = userID;
                                }
                                else
                                {
                                    if (details.Balance < 0)
                                        details.Balance = movement.QuantityIn;
                                    else
                                        details.Balance += movement.QuantityIn;
                                    details.IsActive = true;
                                }

                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion
                            }
                            else
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = expiredDate;
                                movement.BatchNumber = batchNumber;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs(qty);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana?
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty = 0;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail ed (fefo) and movement
                                #region balance detail ed (fefo)
                                var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.ItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                            .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                if (details == null)
                                {
                                    details = itemBalanceDetailEds.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = entity.ItemID;
                                    details.ExpiredDate = movement.ExpiredDate;
                                    details.BatchNumber = movement.BatchNumber;
                                    details.Balance = movement.QuantityIn;
                                    details.ST = string.Empty;
                                    details.IsActive = true;
                                    details.CreatedDateTime = Utils.NowAtSqlServer();
                                    details.CreatedByUserID = userID;
                                }
                                else
                                {
                                    if (details.Balance < 0)
                                        details.Balance = movement.QuantityIn;
                                    else
                                        details.Balance += movement.QuantityIn;
                                    details.IsActive = true;
                                }

                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion
                            }
                        }

                        idx++;
                    }
                }
            }
        }

        public static void PrepareItemBalancesForMCUCorrection(TransChargesItemConsumptionCollection coll, string serviceUnitID, string locationID,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
            ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.DetailItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Descending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                // balance detail
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items)
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Descending);
                itemBalanceDetailEds.LoadAll();

                if (itemBalanceDetails.Count == 0)
                    return;
                itemBalanceDetails = null;
            }

            foreach (TransChargesItemConsumption entity in coll)
            {
                decimal? purchase, resultQty = entity.QtyRealization;

                var item = new Item();
                item.LoadByPrimaryKey(entity.DetailItemID);
                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = med.CostPrice;
                        entity.FifoPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        //if (!(med.IsActualDeduct ?? false))
                        //    resultQty = (-1) * (Math.Ceiling(Math.Abs(entity.QtyRealization ?? 0)));

                        purchase = med.PriceInBaseUnit;
                        break;

                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.AveragePrice = nmed.CostPrice;
                        entity.FifoPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        purchase = nmed.PriceInBaseUnit;
                        break;
                    default:
                        continue;
                }

                var tc = new TransCharges();
                tc.LoadByPrimaryKey(entity.TransactionNo);

                var query = new ItemMovementQuery();
                query.Where(
                    query.TransactionNo == tc.TransactionNo,
                    query.SequenceNo == entity.SequenceNo,
                    query.ItemID == entity.DetailItemID
                    );
                query.OrderBy(query.MovementDate.Descending);

                DataTable tbl = query.LoadDataTable();

                var balance = itemBalance.FindByPrimaryKey(locationID, entity.DetailItemID);
                decimal blc = (balance.Balance ?? 0);//- Math.Abs(resultQty ?? 0);
                decimal qty = Math.Abs(resultQty ?? 0);
                decimal ctr = 0;

                if (!isEnabledStockWithEdControl)
                {
                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (qty > Math.Abs((decimal)row["QuantityOut"]))
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana?
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.AveragePrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty -= (decimal)movement.QuantityIn;
                                //returnedQty = 0;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail (fifo) and movement
                                #region detail
                                var detail = itemBalanceDetails.AddNew();
                                detail.LocationID = locationID;
                                detail.ItemID = entity.DetailItemID;
                                detail.ReferenceNo = entity.TransactionNo;
                                detail.TransactionCode = _chargesCode;
                                detail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                detail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                detail.Booking = 0;
                                detail.Price = (decimal)row["CostPrice"];
                                detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                detail.LastUpdateByUserID = userID;
                                #endregion

                            }
                            else
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs(qty);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana?
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.AveragePrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty = 0;
                                //returnedQty = 0;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail (fifo) and movement
                                #region detail
                                var detail = itemBalanceDetails.AddNew();
                                detail.LocationID = locationID;
                                detail.ItemID = entity.DetailItemID;
                                detail.ReferenceNo = entity.TransactionNo;
                                detail.TransactionCode = _chargesCode;
                                detail.BalanceDate = Utils.NowAtSqlServer().AddSeconds(idx);//.AddMilliseconds(10 * idx); 
                                detail.Balance = Math.Abs(movement.QuantityIn ?? 0);
                                detail.Booking = 0;
                                detail.Price = (decimal)row["CostPrice"];
                                detail.LastUpdateDateTime = Utils.NowAtSqlServer();
                                detail.LastUpdateByUserID = userID;
                                #endregion
                            }
                        }

                        idx++;
                    }
                }
                else//
                {
                    int idx = 0;

                    foreach (DataRow row in tbl.Rows)
                    {
                        DateTime expiredDate;
                        string batchNumber;

                        try
                        {
                            expiredDate = Convert.ToDateTime(row["ExpiredDate"]);
                            batchNumber = Convert.ToString(row["BatchNumber"]);
                        }
                        catch (Exception)
                        {
                            var ibedq = new ItemBalanceDetailEdQuery();
                            ibedq.Where(ibedq.LocationID == locationID, ibedq.ItemID == entity.DetailItemID, ibedq.IsActive == true);
                            ibedq.OrderBy(ibedq.ExpiredDate.Descending);
                            ibedq.es.Top = 1;
                            var ibed = new ItemBalanceDetailEd();
                            if (ibed.Load(ibedq))
                            {
                                expiredDate = ibed.ExpiredDate ?? Convert.ToDateTime("1/1/2999");
                                batchNumber = ibed.BatchNumber;
                            }
                            else
                            {
                                expiredDate = Convert.ToDateTime("1/1/2999");
                                batchNumber = "-N/A-";
                            }
                        }

                        ctr += Math.Abs((decimal)row["QuantityOut"]);

                        if (qty > 0)
                        {
                            if (qty > Math.Abs((decimal)row["QuantityOut"]))
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.ExpiredDate = expiredDate;
                                movement.BatchNumber = batchNumber;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs((decimal)row["QuantityOut"]);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana?
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.AveragePrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty -= (decimal)movement.QuantityIn;
                                //returnedQty = 0;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail ed (fefo) and movement
                                #region balance detail ed (fefo)
                                var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.DetailItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                            .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                if (details == null)
                                {
                                    details = itemBalanceDetailEds.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = entity.DetailItemID;
                                    details.ExpiredDate = movement.ExpiredDate;
                                    details.BatchNumber = movement.BatchNumber;
                                    details.Balance = movement.QuantityIn;
                                    details.ST = string.Empty;
                                    details.IsActive = true;
                                    details.CreatedDateTime = Utils.NowAtSqlServer();
                                    details.CreatedByUserID = userID;
                                }
                                else
                                {
                                    if (details.Balance < 0)
                                        details.Balance = movement.QuantityIn;
                                    else
                                        details.Balance += movement.QuantityIn;
                                    details.IsActive = true;
                                }

                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                            }
                            else
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * idx);
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _chargesCode;
                                movement.TransactionNo = entity.TransactionNo;
                                movement.SequenceNo = entity.SequenceNo;
                                movement.ItemID = entity.DetailItemID;
                                movement.ExpiredDate = expiredDate;
                                movement.BatchNumber = batchNumber;
                                movement.InitialStock = blc;
                                movement.QuantityOut = 0;
                                movement.QuantityIn = Math.Abs(qty);
                                movement.SRItemUnit = entity.SRItemUnit;
                                // TODO: cek data costprice ambil dari mana?
                                //movement.CostPrice = (decimal)row["CostPrice"];
                                movement.CostPrice = entity.AveragePrice;
                                movement.SalesPrice = 0;
                                movement.PurchasePrice = (decimal)row["PurchasePrice"];
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                blc += (movement.QuantityIn ?? 0);
                                qty = 0;
                                //returnedQty = 0;

                                #region balance
                                balance.Balance = Math.Abs(movement.InitialStock ?? 0) + Math.Abs(movement.QuantityIn ?? 0);
                                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                                balance.LastUpdateByUserID = userID;
                                #endregion

                                // balance detail ed (fefo) and movement
                                #region balance detail ed (fefo)
                                var details = (itemBalanceDetailEds.Where(im => im.LocationID == locationID && im.ItemID == entity.DetailItemID && im.ExpiredDate == movement.ExpiredDate && im.BatchNumber.ToLower() == movement.BatchNumber.ToLower())
                                            .OrderByDescending(im => im.CreatedDateTime)).Take(1).SingleOrDefault();
                                if (details == null)
                                {
                                    details = itemBalanceDetailEds.AddNew();
                                    details.LocationID = locationID;
                                    details.ItemID = entity.DetailItemID;
                                    details.ExpiredDate = movement.ExpiredDate;
                                    details.BatchNumber = movement.BatchNumber;
                                    details.Balance = movement.QuantityIn;
                                    details.ST = string.Empty;
                                    details.IsActive = true;
                                    details.CreatedDateTime = Utils.NowAtSqlServer();
                                    details.CreatedByUserID = userID;
                                }
                                else
                                {
                                    if (details.Balance < 0)
                                        details.Balance = movement.QuantityIn;
                                    else
                                        details.Balance += movement.QuantityIn;
                                    details.IsActive = true;
                                }

                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion
                            }
                        }

                        idx++;
                    }
                }
            }
        }

        public static void PrepareItemBalancesForPurchaseOrderReceivedConsignment(ItemTransactionItemCollection coll, string transactionCode, string serviceUnitId, string locationId,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements,
            ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationId,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
                return;

            if (!isEnabledStockWithEdControl)
            {
                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //    return;

                itemBalanceDetailEds = null;
            }
            else
            {
                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //    return;
                itemBalanceDetails = null;
            }

            foreach (var entity in coll)
            {
                decimal? resultQty = entity.Quantity * entity.ConversionFactor;
                string itemUnit = string.Empty;

                var item = new Item();
                item.LoadByPrimaryKey(entity.ItemID);
                decimal lastPrice = 0;

                switch (item.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = med.CostPrice;

                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        lastPrice = med.LastPriceInBaseUnit ?? 0;

                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = nmed.CostPrice;

                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        lastPrice = nmed.LastPriceInBaseUnit ?? 0;

                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        entity.CostPrice = kitc.CostPrice;

                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        lastPrice = kitc.LastPriceInBaseUnit ?? 0;

                        break;
                }

                #region balance
                var balance = itemBalance.FindByPrimaryKey(locationId, entity.ItemID);

                if (balance.Balance < resultQty)
                {
                    itemNoStock = item.ItemName;
                    return;
                }

                balance.Balance -= resultQty;
                balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                balance.LastUpdateByUserID = userID;
                #endregion

                if (!isEnabledStockWithEdControl)
                {
                    //db:20231219 - override jika tidak ada
                    //// cek balance detail
                    //var ibds = new ItemBalanceDetailCollection();
                    //ibds.Query.Where(
                    //    ibds.Query.LocationID == locationId,
                    //    ibds.Query.ItemID == item.ItemID,
                    //    ibds.Query.Balance > 0
                    //    );
                    //ibds.LoadAll();

                    //if (ibds.Count == 0)
                    //{
                    //    itemNoStock = item.ItemName + " [Item Balance Detail]";
                    //    return;
                    //}

                    try
                    {
                        var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            #region balance detail (fifo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitId;
                            movement.LocationID = locationId;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            // mark if using average
                            //if (parCostType != "AVG")
                            //{
                            //    entity.Price = details.Price;
                            //    entity.CostPrice = details.Price;
                            //}

                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitId;
                                    movement.LocationID = locationId;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion

                                    var initialStock = movement.InitialStock - movement.QuantityOut;

                                    #region balance detail (fifo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                        //return;

                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitId;
                                            movement.LocationID = locationId;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = details.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitId;
                                            movement.LocationID = locationId;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.str.ExpiredDate = string.Empty;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = entity.Price;
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fifo)
                                            details = itemBalanceDetails.AddNew();
                                            details.LocationID = locationId;
                                            details.ItemID = entity.ItemID;
                                            details.ReferenceNo = string.Empty;
                                            details.TransactionCode = string.Empty;
                                            details.BalanceDate = Utils.NowAtSqlServer();
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.Booking = 0;
                                            details.Price = entity.CostPrice;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            details.LastUpdateByUserID = userID;
                                            details.PurchaseReceiveNo = string.Empty;
                                            #endregion

                                            qty = 0;
                                        }
                                    }

                                }
                                else
                                {
                                    #region balance detail (fifo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitId;
                                    movement.LocationID = locationId;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.str.ExpiredDate = string.Empty;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = details.Price;
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitId;
                            movement.LocationID = locationId;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = details.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion
                        }
                        catch (Exception)
                        {
                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitId;
                            movement.LocationID = locationId;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.str.ExpiredDate = string.Empty;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = entity.Price;
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fifo)
                            var details = itemBalanceDetails.AddNew();
                            details.LocationID = locationId;
                            details.ItemID = entity.ItemID;
                            details.ReferenceNo = string.Empty;
                            details.TransactionCode = string.Empty;
                            details.BalanceDate = Utils.NowAtSqlServer();
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.Booking = 0;
                            details.Price = entity.CostPrice;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            details.PurchaseReceiveNo = string.Empty;
                            #endregion
                        }
                    }
                }
                else //
                {
                    try
                    {
                        var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                        if (details.Balance >= resultQty)
                        {
                            #region balance detail ed (fefo)
                            details.Balance -= resultQty;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            details.LastUpdateByUserID = userID;
                            #endregion

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitId;
                            movement.LocationID = locationId;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = ((entity.Price ?? 0) / (entity.ConversionFactor ?? 1));
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion
                        }
                        else
                        {
                            decimal? qty = resultQty; // 5
                            int i = 0;
                            while (qty > 0)
                            {
                                if (i == 0)
                                    qty = resultQty - details.Balance; // 5 - 2
                                else
                                    qty -= details.Balance;

                                if (qty > 0)
                                {
                                    var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitId;
                                    movement.LocationID = locationId;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                    movement.QuantityOut = details.Balance;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = ((entity.Price ?? 0) / (entity.ConversionFactor ?? 1));
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;

                                    var initialStock = movement.InitialStock - movement.QuantityOut;
                                    #endregion

                                    #region balance detail (fefo)
                                    details.Balance = 0;
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    // re-query
                                    try
                                    {
                                        details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                    }
                                    catch (Exception)
                                    {
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                         .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                            #region movement
                                            movement = itemMovements.AddNew();
                                            movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                            movement.ServiceUnitID = serviceUnitId;
                                            movement.LocationID = locationId;
                                            movement.TransactionCode = transactionCode;
                                            movement.TransactionNo = entity.TransactionNo;
                                            movement.SequenceNo = entity.SequenceNo;
                                            movement.ItemID = entity.ItemID;
                                            movement.ExpiredDate = details.ExpiredDate;
                                            movement.BatchNumber = details.BatchNumber;
                                            movement.InitialStock = initialStock;
                                            movement.QuantityOut = qty;
                                            movement.QuantityIn = 0;
                                            movement.SRItemUnit = itemUnit;
                                            movement.CostPrice = entity.CostPrice;
                                            movement.SalesPrice = 0;
                                            movement.PurchasePrice = ((entity.Price ?? 0) / (entity.ConversionFactor ?? 1));
                                            movement.LastPriceInBaseUnit = lastPrice;
                                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            movement.LastUpdateByUserID = userID;
                                            #endregion

                                            #region balance detail (fefo)
                                            details.Balance = movement.InitialStock - movement.QuantityOut;
                                            details.LastUpdateByUserID = userID;
                                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                            #endregion

                                            qty = 0;
                                        }
                                        catch (Exception)
                                        {
                                            itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";
                                            return;
                                        }
                                    }

                                }
                                else
                                {
                                    #region balance detail ed (fefo)
                                    var bal = details.Balance;
                                    details.Balance -= (details.Balance + qty);
                                    details.LastUpdateByUserID = userID;
                                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    #endregion

                                    #region movement
                                    var movement = itemMovements.AddNew();
                                    movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                    movement.ServiceUnitID = serviceUnitId;
                                    movement.LocationID = locationId;
                                    movement.TransactionCode = transactionCode;
                                    movement.TransactionNo = entity.TransactionNo;
                                    movement.SequenceNo = entity.SequenceNo;
                                    movement.ItemID = entity.ItemID;
                                    movement.ExpiredDate = details.ExpiredDate;
                                    movement.BatchNumber = details.BatchNumber;
                                    movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                    movement.QuantityOut = bal + qty;
                                    movement.QuantityIn = 0;
                                    movement.SRItemUnit = itemUnit;
                                    movement.CostPrice = entity.CostPrice;
                                    movement.SalesPrice = 0;
                                    movement.PurchasePrice = ((entity.Price ?? 0) / (entity.ConversionFactor ?? 1));
                                    movement.LastPriceInBaseUnit = lastPrice;
                                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                    movement.LastUpdateByUserID = userID;
                                    #endregion
                                }

                                i++;
                            }
                        }
                    }
                    catch (Exception)
                    {
                        try
                        {
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                         .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                            #region movement
                            var movement = itemMovements.AddNew();
                            movement.MovementDate = Utils.NowAtSqlServer();
                            movement.ServiceUnitID = serviceUnitId;
                            movement.LocationID = locationId;
                            movement.TransactionCode = transactionCode;
                            movement.TransactionNo = entity.TransactionNo;
                            movement.SequenceNo = entity.SequenceNo;
                            movement.ItemID = entity.ItemID;
                            movement.ExpiredDate = details.ExpiredDate;
                            movement.BatchNumber = details.BatchNumber;
                            movement.InitialStock = balance.Balance + resultQty;
                            movement.QuantityOut = resultQty;
                            movement.QuantityIn = 0;
                            movement.SRItemUnit = itemUnit;
                            movement.CostPrice = entity.CostPrice;
                            movement.SalesPrice = 0;
                            movement.PurchasePrice = ((entity.Price ?? 0) / (entity.ConversionFactor ?? 1));
                            movement.LastPriceInBaseUnit = lastPrice;
                            movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                            movement.LastUpdateByUserID = userID;
                            #endregion

                            #region balance detail (fefo)
                            details.Balance = movement.InitialStock - movement.QuantityOut;
                            details.LastUpdateByUserID = userID;
                            details.LastUpdateDateTime = Utils.NowAtSqlServer();
                            #endregion
                        }
                        catch (Exception)
                        {
                            itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";
                            return;
                        }
                    }
                }
            }
        }

        public static void PrepareItemBalancesForPurchaseOrderReturnConsignment(ItemTransactionItemCollection coll, ItemTransaction header, string locationId,
            string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails, ref ItemMovementCollection itemMovements,
            ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl)
        {
            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
            (
                itemBalance.Query.LocationID == locationId,
                itemBalance.Query.ItemID.In(items)
            );
            itemBalance.LoadAll();

            if (!isEnabledStockWithEdControl)
                itemBalanceDetailEds = null;
            else
                itemBalanceDetails = null;

            decimal? costPrice = 0;

            foreach (var item in coll)
            {
                string itemUnit = string.Empty;

                var i = new Item();
                i.LoadByPrimaryKey(item.ItemID);

                switch (i.SRItemType)
                {
                    case Reference.ItemType.Medical:
                        var med = new ItemProductMedic();
                        med.LoadByPrimaryKey(item.ItemID);
                        costPrice = med.CostPrice;
                        if (!med.IsInventoryItem ?? false)
                            continue;

                        itemUnit = med.SRItemUnit;
                        break;
                    case Reference.ItemType.NonMedical:
                        var nmed = new ItemProductNonMedic();
                        nmed.LoadByPrimaryKey(item.ItemID);
                        costPrice = nmed.CostPrice;
                        if (!nmed.IsInventoryItem ?? false)
                            continue;

                        itemUnit = nmed.SRItemUnit;
                        break;
                    case Reference.ItemType.Kitchen:
                        var kitc = new ItemKitchen();
                        kitc.LoadByPrimaryKey(item.ItemID);
                        costPrice = kitc.CostPrice;
                        if (!kitc.IsInventoryItem ?? false)
                            continue;

                        itemUnit = kitc.SRItemUnit;
                        break;
                }

                var balance = itemBalance.SingleOrDefault(ib => ib.ItemID == item.ItemID);
                if (balance != null)
                {
                    #region balance
                    balance.Balance += Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }
                else
                {
                    #region balance
                    balance = itemBalance.AddNew();
                    balance.LocationID = locationId;
                    balance.ItemID = item.ItemID;
                    balance.ReorderType = string.Empty;
                    balance.Minimum = 0;
                    balance.Maximum = 0;
                    balance.Balance = Math.Abs((item.Quantity ?? 0) * (item.ConversionFactor ?? 0));
                    balance.Booking = 0;
                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion
                }

                var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                            .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                decimal? prev = 0;
                if (mvm == null)
                {
                    var mov = new ItemMovement();
                    mov.Query.es.Top = 1;
                    mov.Query.Where(
                        mov.Query.LocationID == locationId &&
                        mov.Query.ItemID == item.ItemID
                        );
                    mov.Query.OrderBy(mov.Query.MovementDate.Descending);
                    prev = mov.Query.Load() ? (mov.InitialStock + mov.QuantityIn) - mov.QuantityOut : 0;
                }
                else
                    prev = (mvm.InitialStock + mvm.QuantityIn) - mvm.QuantityOut;

                if (!isEnabledStockWithEdControl)
                {
                    #region movement
                    var movement = itemMovements.AddNew();
                    movement.MovementDate = Utils.NowAtSqlServer();
                    movement.ServiceUnitID = header.FromServiceUnitID;
                    movement.LocationID = locationId;
                    movement.TransactionCode = header.TransactionCode;
                    movement.TransactionNo = item.TransactionNo;
                    movement.SequenceNo = item.SequenceNo;
                    movement.ItemID = item.ItemID;
                    movement.str.ExpiredDate = string.Empty;
                    movement.InitialStock = prev;
                    movement.QuantityOut = 0;
                    movement.QuantityIn = (item.Quantity ?? 0) * (item.ConversionFactor ?? 0);
                    movement.SRItemUnit = itemUnit;
                    // TODO: cek data costprice ambil dari mana?
                    //movement.CostPrice = item.Price;
                    movement.CostPrice = costPrice;
                    movement.SalesPrice = 0;
                    movement.PurchasePrice = 0;
                    movement.LastPriceInBaseUnit = 0;
                    movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                    movement.LastUpdateByUserID = userID;
                    #endregion

                    #region balance detail (fifo)
                    var details = itemBalanceDetails.AddNew();
                    details.LocationID = locationId;
                    details.ItemID = item.ItemID;
                    details.ReferenceNo = item.TransactionNo;
                    details.TransactionCode = header.TransactionCode;
                    details.Balance = (item.Quantity ?? 0) * (item.ConversionFactor ?? 0);
                    details.BalanceDate = Utils.NowAtSqlServer();
                    details.Booking = 0;
                    details.Price = item.Price;
                    details.LastUpdateDateTime = Utils.NowAtSqlServer();
                    details.LastUpdateByUserID = userID;
                    details.PurchaseReceiveNo = string.Empty;
                    #endregion
                }
                else
                {
                    int x = 0;
                    decimal initialStock = 0;
                    decimal qtyOut = 0;

                    var itiEds = new ItemTransactionItemEdCollection();
                    itiEds.Query.Where(itiEds.Query.TransactionNo == item.TransactionNo, itiEds.Query.SequenceNo == item.SequenceNo);
                    itiEds.Query.OrderBy(itiEds.Query.ExpiredDate.Ascending, itiEds.Query.LastUpdateDateTime.Ascending);
                    itiEds.LoadAll();

                    foreach (var itiEd in itiEds)
                    {
                        #region ItemMovement

                        var itemMovement = itemMovements.AddNew();
                        itemMovement.MovementDate = header.ApprovedDate.Value.AddMilliseconds(x * 100);
                        itemMovement.ServiceUnitID = header.FromServiceUnitID;
                        itemMovement.LocationID = locationId;
                        itemMovement.TransactionCode = header.TransactionCode;
                        itemMovement.TransactionNo = header.TransactionNo;
                        itemMovement.SequenceNo = item.SequenceNo;
                        itemMovement.ItemID = item.ItemID;
                        itemMovement.ExpiredDate = itiEd.ExpiredDate;
                        itemMovement.BatchNumber = itiEd.BatchNumber;

                        if (x == 0)
                        {
                            itemMovement.InitialStock = prev;

                            initialStock = itemMovement.InitialStock ?? 0;
                        }
                        else
                        {
                            itemMovement.InitialStock = initialStock - qtyOut;
                        }

                        itemMovement.QuantityIn = 0;
                        itemMovement.QuantityOut = itiEd.Quantity * itiEd.ConversionFactor;

                        qtyOut += (itemMovement.QuantityOut ?? 0);


                        itemMovement.SRItemUnit = itemUnit;
                        itemMovement.CostPrice = costPrice;
                        itemMovement.SalesPrice = 0;
                        itemMovement.PurchasePrice = 0;
                        itemMovement.LastPriceInBaseUnit = 0;
                        itemMovement.LastUpdateByUserID = userID;
                        itemMovement.LastUpdateDateTime = Utils.NowAtSqlServer();

                        #endregion

                        #region ItemBalanceDetailEd

                        ItemBalanceDetailEd itemBalanceDetailEd = null;
                        var isAvailable = false;
                        foreach (var findBalance in itemBalanceDetailEds.Where(findBalance => findBalance.ItemID.Equals(item.ItemID) &&
                                                                                findBalance.ExpiredDate.Equals(itiEd.ExpiredDate) &&
                                                                                  findBalance.BatchNumber.ToLower().Equals(itiEd.BatchNumber.ToLower())))
                        {
                            isAvailable = true;
                            itemBalanceDetailEd = findBalance;
                            break;
                        }
                        if (!isAvailable)
                        {
                            itemBalanceDetailEd = itemBalanceDetailEds.AddNew();
                            itemBalanceDetailEd.LocationID = locationId;
                            itemBalanceDetailEd.ItemID = item.ItemID;
                            itemBalanceDetailEd.ExpiredDate = itiEd.ExpiredDate;
                            itemBalanceDetailEd.BatchNumber = itiEd.BatchNumber;
                            itemBalanceDetailEd.Balance = 0 - (itiEd.Quantity * itiEd.ConversionFactor);
                            itemBalanceDetailEd.IsActive = true;
                            itemBalanceDetailEd.CreatedDateTime = Utils.NowAtSqlServer();
                            itemBalanceDetailEd.CreatedByUserID = userID;
                        }
                        else
                        {
                            itemBalanceDetailEd.Balance -= Convert.ToDecimal(itiEd.Quantity * itiEd.ConversionFactor);
                        }
                        itemBalanceDetailEd.LastUpdateDateTime = Utils.NowAtSqlServer();
                        itemBalanceDetailEd.LastUpdateByUserID = userID;

                        #endregion

                        x += 1;

                    }
                }
            }
        }

        public static void PrepareItemBalancesForLaundryWashingProcess(LaunderedProcess it, IEnumerable<LaunderedProcessItemConsumption> coll, string serviceUnitID, string locationID,
           string userID, ref ItemBalanceCollection itemBalance, ref ItemBalanceDetailCollection itemBalanceDetails,
           ref ItemMovementCollection itemMovements, ref ItemBalanceDetailEdCollection itemBalanceDetailEds, bool isEnabledStockWithEdControl, out string itemNoStock)
        {
            string parCostType = AppParameter.GetParameterValue(AppParameter.ParameterItem.ItemProductCostPriceType);
            itemNoStock = string.Empty;

            var items = (coll.Select(i => i.ItemID)).Distinct();

            if (!items.Any())
                return;

            //balance
            itemBalance.Query.Where
                (
                    itemBalance.Query.LocationID == locationID,
                    itemBalance.Query.ItemID.In(items)
                );
            itemBalance.LoadAll();

            if (itemBalance.Count == 0)
            {
                itemNoStock = "x";

                return;
            }

            if (!isEnabledStockWithEdControl)
            {
                // balance detail
                itemBalanceDetails.Query.Where
                (
                    itemBalanceDetails.Query.LocationID == locationID,
                    itemBalanceDetails.Query.ItemID.In(items)
                );
                itemBalanceDetails.Query.OrderBy(itemBalanceDetails.Query.BalanceDate.Ascending);
                itemBalanceDetails.LoadAll();

                //db:20231219 - override jika tidak ada
                //if (itemBalanceDetails.Count == 0)
                //{
                //    itemNoStock = "x|Item Balance Detail";
                //    return;
                //}

                itemBalanceDetailEds = null;
            }
            else
            {
                itemBalanceDetailEds.Query.Where
                (
                    itemBalanceDetailEds.Query.LocationID == locationID,
                    itemBalanceDetailEds.Query.ItemID.In(items),
                    itemBalanceDetailEds.Query.IsActive == true
                );
                itemBalanceDetailEds.Query.OrderBy(itemBalanceDetailEds.Query.ExpiredDate.Ascending);
                itemBalanceDetailEds.LoadAll();

                //db:20240429 - override jika tidak ada
                //if (itemBalanceDetailEds.Count == 0)
                //{
                //    itemNoStock = "x|Item Balance Detail Expired";
                //    return;
                //}
                itemBalanceDetails = null;
            }

            foreach (LaunderedProcessItemConsumption entity in coll)
            {
                decimal? resultQty = entity.Qty;
                decimal lastPrice = 0;
                if (resultQty > 0)
                {
                    var item = new Item();
                    item.LoadByPrimaryKey(entity.ItemID);
                    switch (item.SRItemType)
                    {
                        case Reference.ItemType.Medical:
                            var med = new ItemProductMedic();
                            med.LoadByPrimaryKey(item.ItemID);
                            entity.CostPrice = med.CostPrice;
                            lastPrice = med.LastPriceInBaseUnit ?? 0;
                            if (!med.IsInventoryItem ?? false)
                                continue;

                            break;
                        case Reference.ItemType.NonMedical:
                            var nmed = new ItemProductNonMedic();
                            nmed.LoadByPrimaryKey(item.ItemID);
                            entity.CostPrice = nmed.CostPrice;
                            lastPrice = nmed.LastPriceInBaseUnit ?? 0;

                            if (!nmed.IsInventoryItem ?? false)
                                continue;
                            break;
                        case Reference.ItemType.Kitchen:
                            var kitc = new ItemKitchen();
                            kitc.LoadByPrimaryKey(item.ItemID);
                            entity.CostPrice = kitc.CostPrice;
                            lastPrice = kitc.LastPriceInBaseUnit ?? 0;

                            if (!kitc.IsInventoryItem ?? false)
                                continue;
                            break;
                    }

                    #region balance
                    var balance = itemBalance.FindByPrimaryKey(locationID, entity.ItemID);

                    if (balance.Balance < resultQty)
                    {
                        itemNoStock = item.ItemName;
                        return;
                    }

                    balance.Balance -= resultQty;

                    balance.LastUpdateDateTime = Utils.NowAtSqlServer();
                    balance.LastUpdateByUserID = userID;
                    #endregion

                    if (!isEnabledStockWithEdControl)
                    {
                        // balance detail (fifo) and movement
                        //db:20231219 - override jika tidak ada
                        //// cek balance detail
                        //var ibds = new ItemBalanceDetailCollection();
                        //ibds.Query.Where(ibds.Query.LocationID == locationID, ibds.Query.ItemID == entity.ItemID, ibds.Query.Balance > 0);
                        //ibds.LoadAll();

                        //if (ibds.Count == 0)
                        //{
                        //    itemNoStock = item.ItemName + " [Item Balance Detail]";

                        //    return;
                        //}

                        try
                        {
                            // query
                            var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                             .OrderBy(b => b.BalanceDate)).Take(1).Single();

                            if (details.Balance >= resultQty)
                            {
                                // mark if using average
                                //if (parCostType != "AVG")
                                //    entity.CostPrice = details.Price;

                                #region balance detail (fifo)
                                details.Balance -= resultQty;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _laundryWashingProcessCode;
                                movement.TransactionNo = entity.ProcessNo;
                                movement.SequenceNo = "000";
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.PurchasePrice = details.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }
                            else
                            {
                                decimal? qty = resultQty; // 5
                                int i = 0;
                                while (qty > 0)
                                {
                                    // mark if using average
                                    //if (parCostType != "AVG")
                                    //{
                                    //    entity.CostPrice = details.Price;
                                    //}

                                    if (i == 0)
                                        qty = resultQty - details.Balance; // 5 - 2
                                    else
                                        qty -= details.Balance;

                                    if (qty > 0)
                                    {
                                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _laundryWashingProcessCode;
                                        movement.TransactionNo = entity.ProcessNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = entity.ItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                        movement.QuantityOut = details.Balance;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                        movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                        movement.PurchasePrice = details.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion

                                        var initialStock = movement.InitialStock - movement.QuantityOut;

                                        #region balance detail (fifo)
                                        details.Balance = 0;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        // re-query
                                        try
                                        {
                                            details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                                     .OrderBy(b => b.BalanceDate)).Take(1).Single();
                                        }
                                        catch (Exception)
                                        {
                                            //itemNoStock = item.ItemName + " [Item Balance Detail]";
                                            //return;
                                            ////throw;
                                            ///
                                            try
                                            {
                                                details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                                     .OrderByDescending(b => b.BalanceDate)).Take(1).Single();
                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _laundryWashingProcessCode;
                                                movement.TransactionNo = entity.ProcessNo;
                                                movement.SequenceNo = "000";
                                                movement.ItemID = entity.ItemID;
                                                movement.str.ExpiredDate = string.Empty;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                movement.PurchasePrice = details.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fifo)
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                qty = 0;
                                            }
                                            catch (Exception)
                                            {
                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _laundryWashingProcessCode;
                                                movement.TransactionNo = entity.ProcessNo;
                                                movement.SequenceNo = "000";
                                                movement.ItemID = entity.ItemID;
                                                movement.str.ExpiredDate = string.Empty;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                                movement.PurchasePrice = entity.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fifo)
                                                details = itemBalanceDetails.AddNew();
                                                details.LocationID = locationID;
                                                details.ItemID = entity.ItemID;
                                                details.ReferenceNo = string.Empty;
                                                details.TransactionCode = string.Empty;
                                                details.BalanceDate = Utils.NowAtSqlServer();
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.Booking = 0;
                                                details.Price = entity.CostPrice;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                details.LastUpdateByUserID = userID;
                                                details.PurchaseReceiveNo = string.Empty;
                                                #endregion

                                                qty = 0;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        #region balance detail (fifo)
                                        var bal = details.Balance;
                                        details.Balance -= (details.Balance + qty);
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _laundryWashingProcessCode;
                                        movement.TransactionNo = entity.ProcessNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = entity.ItemID;
                                        movement.str.ExpiredDate = string.Empty;
                                        movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                        movement.QuantityOut = bal + qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                        movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                        movement.PurchasePrice = details.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion
                                    }

                                    i++;
                                }
                            }
                        }
                        catch (Exception)
                        {
                            try
                            {
                                var details = (itemBalanceDetails.Where(b => b.ItemID == entity.ItemID)
                                                             .OrderByDescending(b => b.BalanceDate)).Take(1).Single();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _laundryWashingProcessCode;
                                movement.TransactionNo = entity.ProcessNo;
                                movement.SequenceNo = "000";
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.PurchasePrice = details.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fifo)
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion
                            }
                            catch (Exception)
                            {
                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _laundryWashingProcessCode;
                                movement.TransactionNo = entity.ProcessNo;
                                movement.SequenceNo = "000";
                                movement.ItemID = entity.ItemID;
                                movement.str.ExpiredDate = string.Empty;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.SalesPrice = entity.CostPrice; // (parCostType == "AVG") ? entity.CostPrice : details.Price;
                                movement.PurchasePrice = entity.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fifo)
                                var details = itemBalanceDetails.AddNew();
                                details.LocationID = locationID;
                                details.ItemID = entity.ItemID;
                                details.ReferenceNo = string.Empty;
                                details.TransactionCode = string.Empty;
                                details.BalanceDate = Utils.NowAtSqlServer();
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.Booking = 0;
                                details.Price = entity.CostPrice;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                details.PurchaseReceiveNo = string.Empty;
                                #endregion
                            }
                        }
                    }
                    else //
                    {
                        // balance detail ed (fefo) and movement
                        try
                        {
                            // query
                            var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                             .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();

                            if (details.Balance >= resultQty)
                            {
                                #region balance detail (fefo)
                                details.Balance -= resultQty;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                details.LastUpdateByUserID = userID;
                                #endregion

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _laundryWashingProcessCode;
                                movement.TransactionNo = entity.ProcessNo;
                                movement.SequenceNo = "000";
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = entity.CostPrice;
                                movement.PurchasePrice = entity.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion
                            }
                            else
                            {
                                decimal? qty = resultQty; // 5
                                int i = 0;
                                while (qty > 0)
                                {
                                    if (i == 0)
                                        qty = resultQty - details.Balance; // 5 - 2
                                    else
                                        qty -= details.Balance;

                                    if (qty > 0)
                                    {
                                        var mvm = (itemMovements.Where(im => im.ItemID == item.ItemID)
                                                                .OrderByDescending(im => im.MovementDate)).Take(1).SingleOrDefault();

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _laundryWashingProcessCode;
                                        movement.TransactionNo = entity.ProcessNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = mvm == null ? (balance.Balance + resultQty) : (mvm.InitialStock - mvm.QuantityOut);
                                        movement.QuantityOut = details.Balance;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = entity.CostPrice;
                                        movement.PurchasePrice = entity.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;

                                        var initialStock = movement.InitialStock - movement.QuantityOut;
                                        #endregion

                                        #region balance detail (fefo)
                                        details.Balance = 0;
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        // re-query
                                        try
                                        {
                                            details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID && b.Balance > 0)
                                                             .OrderBy(b => b.ExpiredDate).ThenBy(b => b.CreatedDateTime)).Take(1).Single();
                                        }
                                        catch (Exception)
                                        {
                                            try
                                            {
                                                details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                                 .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                                #region movement
                                                movement = itemMovements.AddNew();
                                                movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                                movement.ServiceUnitID = serviceUnitID;
                                                movement.LocationID = locationID;
                                                movement.TransactionCode = _laundryWashingProcessCode;
                                                movement.TransactionNo = entity.ProcessNo;
                                                movement.SequenceNo = "000";
                                                movement.ItemID = entity.ItemID;
                                                movement.ExpiredDate = details.ExpiredDate;
                                                movement.BatchNumber = details.BatchNumber;
                                                movement.InitialStock = initialStock;
                                                movement.QuantityOut = qty;
                                                movement.QuantityIn = 0;
                                                movement.SRItemUnit = entity.SRItemUnit;
                                                movement.CostPrice = entity.CostPrice;
                                                movement.SalesPrice = entity.CostPrice;
                                                movement.PurchasePrice = entity.Price;
                                                movement.LastPriceInBaseUnit = lastPrice;
                                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                movement.LastUpdateByUserID = userID;
                                                #endregion

                                                #region balance detail (fefo)
                                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                                details.LastUpdateByUserID = userID;
                                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                                #endregion

                                                qty = 0;
                                            }
                                            catch (Exception)
                                            {
                                                itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";
                                                return;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        #region balance detail (fefo)
                                        var bal = details.Balance;
                                        details.Balance -= (details.Balance + qty);
                                        details.LastUpdateByUserID = userID;
                                        details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        #endregion

                                        #region movement
                                        var movement = itemMovements.AddNew();
                                        movement.MovementDate = Utils.NowAtSqlServer().AddMilliseconds(10 * i);
                                        movement.ServiceUnitID = serviceUnitID;
                                        movement.LocationID = locationID;
                                        movement.TransactionCode = _laundryWashingProcessCode;
                                        movement.TransactionNo = entity.ProcessNo;
                                        movement.SequenceNo = "000";
                                        movement.ItemID = entity.ItemID;
                                        movement.ExpiredDate = details.ExpiredDate;
                                        movement.BatchNumber = details.BatchNumber;
                                        movement.InitialStock = itemMovements[itemMovements.Count - 2].InitialStock - itemMovements[itemMovements.Count - 2].QuantityOut;
                                        movement.QuantityOut = bal + qty;
                                        movement.QuantityIn = 0;
                                        movement.SRItemUnit = entity.SRItemUnit;
                                        movement.CostPrice = entity.CostPrice;
                                        movement.SalesPrice = entity.CostPrice;
                                        movement.PurchasePrice = entity.Price;
                                        movement.LastPriceInBaseUnit = lastPrice;
                                        movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                        movement.LastUpdateByUserID = userID;
                                        #endregion
                                    }

                                    i++;
                                }
                            }
                        }
                        catch (Exception)
                        {
                            try
                            {
                                var details = (itemBalanceDetailEds.Where(b => b.ItemID == entity.ItemID)
                                                 .OrderByDescending(b => b.ExpiredDate).ThenByDescending(b => b.CreatedDateTime)).Take(1).Single();

                                #region movement
                                var movement = itemMovements.AddNew();
                                movement.MovementDate = Utils.NowAtSqlServer();
                                movement.ServiceUnitID = serviceUnitID;
                                movement.LocationID = locationID;
                                movement.TransactionCode = _laundryWashingProcessCode;
                                movement.TransactionNo = entity.ProcessNo;
                                movement.SequenceNo = "000";
                                movement.ItemID = entity.ItemID;
                                movement.ExpiredDate = details.ExpiredDate;
                                movement.BatchNumber = details.BatchNumber;
                                movement.InitialStock = balance.Balance + resultQty;
                                movement.QuantityOut = resultQty;
                                movement.QuantityIn = 0;
                                movement.SRItemUnit = entity.SRItemUnit;
                                movement.CostPrice = entity.CostPrice;
                                movement.SalesPrice = entity.CostPrice;
                                movement.PurchasePrice = entity.Price;
                                movement.LastPriceInBaseUnit = lastPrice;
                                movement.LastUpdateDateTime = Utils.NowAtSqlServer();
                                movement.LastUpdateByUserID = userID;
                                #endregion

                                #region balance detail (fefo)
                                details.Balance = movement.InitialStock - movement.QuantityOut;
                                details.LastUpdateByUserID = userID;
                                details.LastUpdateDateTime = Utils.NowAtSqlServer();
                                #endregion
                            }
                            catch (Exception)
                            {
                                itemNoStock = item.ItemName + " [Unmapping item: ItemBalanceDetailEd]";
                                return;
                            }
                        }

                    }
                }
            }
        }

        public static bool IsHasPendingBalance(string locationId)
        {
            var query = new ItemBalanceQuery();
            query.Where(query.LocationID == locationId, query.Booking > 0);
            DataTable dtb = query.LoadDataTable();

            return dtb.Rows.Count > 0;
        }
    }
}